<!doctype html><html lang=zh-cn dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>kubernetes垃圾回收器GarbageCollector 源码分析（三） &#183; 进击云原生</title>
<meta name=title content="kubernetes垃圾回收器GarbageCollector 源码分析（三） &#183; 进击云原生"><meta name=description content="进击云原生：深入探索容器技术、Kubernetes、Istio、DevOps 实践、Prometheus 监控、Envoy、Golang 开发以及云原生架构和微服务趋势的专业博客。"><meta name=keywords content="kubernetes,"><link rel=canonical href=https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/><link type=text/css rel=stylesheet href=/css/main.bundle.min.6a1934f2549fc14526ee16bc5d171958bd1a92bf5b90a39e40384dcf517f8ec1c46ca48a25a00b47ff5c55d3bc5fb768d894cfc3cf8baaf45abeb61062f6927c.css integrity="sha512-ahk08lSfwUUm7ha8XRcZWL0akr9bkKOeQDhNz1F/jsHEbKSKJaALR/9cVdO8X7do2JTPw8+LqvRavrYQYvaSfA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.d9be7b9a4d8135f07bbbd18681ad970838d3bc8e366bfadc94c08c8a1dc440d95af2bd614a24366316f31d41518822a52ce8f464ed829ae27497b2241ab2cae5.js integrity="sha512-2b57mk2BNfB7u9GGga2XCDjTvI42a/rclMCMih3EQNla8r1hSiQ2YxbzHUFRiCKlLOj0ZO2CmuJ0l7IkGrLK5Q==" data-copy=复制 data-copied=复制成功！></script><script src=/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/"><meta property="og:site_name" content="进击云原生"><meta property="og:title" content="kubernetes垃圾回收器GarbageCollector 源码分析（三）"><meta property="og:description" content="kubernetes版本：1.13.2
接前两节：
kubernetes垃圾回收器GarbageCollector Controller源码分析（一）
kubernetes垃圾回收器GarbageCollector Controller源码分析（二）"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-21T17:40:11+00:00"><meta property="article:modified_time" content="2019-10-21T17:40:11+00:00"><meta property="article:tag" content="Kubernetes"><meta name=twitter:card content="summary"><meta name=twitter:title content="kubernetes垃圾回收器GarbageCollector 源码分析（三）"><meta name=twitter:description content="kubernetes版本：1.13.2
接前两节：
kubernetes垃圾回收器GarbageCollector Controller源码分析（一）
kubernetes垃圾回收器GarbageCollector Controller源码分析（二）"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"kubernetes垃圾回收器GarbageCollector 源码分析（三）","headline":"kubernetes垃圾回收器GarbageCollector 源码分析（三）","abstract":"\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003ekubernetes版本：1.13.2\u003c\/strong\u003e\u003c\/p\u003e\u003c\/blockquote\u003e\n\u003cp\u003e接前两节：\u003cbr \/\u003e\n\n\u003ca href=\u0022https:\/\/kubeinfo.cn\/go\/?target=aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvMTAwMDgxOTQx\u0022 target=\u0022_blank\u0022 \u003ekubernetes垃圾回收器GarbageCollector Controller源码分析（一）\u003c\/a\u003e\u003cbr \/\u003e\n\n\u003ca href=\u0022https:\/\/kubeinfo.cn\/go\/?target=aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvMTAwNTQ5MjUx\u0022 target=\u0022_blank\u0022 \u003ekubernetes垃圾回收器GarbageCollector Controller源码分析（二）\u003c\/a\u003e\u003c\/p\u003e","inLanguage":"zh-cn","url":"https:\/\/kubeinfo.cn\/posts\/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89\/","author":{"@type":"Person","name":"小碗汤"},"copyrightYear":"2019","dateCreated":"2019-10-21T17:40:11\u002b00:00","datePublished":"2019-10-21T17:40:11\u002b00:00","dateModified":"2019-10-21T17:40:11\u002b00:00","keywords":["kubernetes"],"mainEntityOfPage":"true","wordCount":"8334"}]</script><meta name=author content="小碗汤"><link href=/index.xml rel=me><link href=https://images.kubeinfo.cn/uPic/tmpm1ykjt96.webp rel=me><link href=https://github.com/smallersoup rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script data-id=umami-script async src=https://analytics.umami.is/script.js data-website-id=f5c28d4b-4ab0-4edc-be58-1ecbe88bfbf5></script><script type=text/javascript>document.querySelector('script[data-id="umami-script"]').addEventListener("load",function(){const e=document.head.querySelector('meta[property = "og:type"]').getAttribute("content");let t=document.head.querySelector('meta[property = "og:title"]').getAttribute("content"),n=document.head.querySelector('meta[property = "og:url"]').getAttribute("content");umami.track(e+":"+t,{url:n})})</script><script>document.addEventListener("DOMContentLoaded",function(){var e=document.createElement("link");e.href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css",e.rel="stylesheet",document.head.appendChild(e)})</script><div id=fps style=z-index:999;position:fixed;bottom:3px;right:3px;color:#fff;font-size:10px></div><script defer type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/layer/3.5.1/layer.min.js></script><script defer type=text/javascript src=https://kubeinfo.cn/js/fps.js></script><script defer>window.addEventListener("scroll",function e(){window.scrollY>100&&(function(e,t,n,s){if(typeof e.webpushr!="undefined")return;e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var i=t.getElementsByTagName(n)[0],o=t.createElement(n);o.id=s,o.async=1,o.src="https://cdn.webpushr.com/app.min.js",i.parentNode.appendChild(o)}(window,document,"script","webpushr-jssdk"),webpushr("setup",{key:"BPaSgcviMxfkNlELfboefkjPEigiszIStgrZEfmp4nsCSXMzLpCphJai8hTOl1o0_yg8u6-SxNz98pdSGro05C4"}),window.removeEventListener("scroll",e))})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{const t="https://htr4n1.laf.run/baidu-seo?urls="+window.location.href;fetch(t).then(e=>e.json()).then(e=>{const t=JSON.parse(e.body);t.remain>0&&t.success===1?console.log("百度收录提交成功，当前api余剩次数："+t.remain):(t.remain===0?console.log("已达到今日百度提交上限。"):(console.log(t.remain),console.log("api提交失败")),t.not_same_site&&console.log("未收录的站点：",t.not_same_site.join(", ")))}).catch(e=>{console.error("请求失败，但这可能是因为达到提交上限:",e)})})</script><script defer>function loadScriptOnScroll(){var e,t,n,s=window.scrollY||window.pageYOffset;s>100&&(n=n||[],e=document.createElement("script"),e.src="https://hm.baidu.com/hm.js?efe96f04908ae320df234a4f5626879e",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t),window.removeEventListener("scroll",loadScriptOnScroll))}window.addEventListener("scroll",loadScriptOnScroll)</script><script defer>function loadAnalyticsScript(){var e=document.createElement("script");e.async=!0,e.src="https://ga.kubeinfo.cn/gtag/js?id=G-0VHVXWXJMQ",document.head.appendChild(e),window.dataLayer=window.dataLayer||[];function t(){dataLayer.push(arguments)}t("js",new Date),t("config","G-0VHVXWXJMQ"),window.removeEventListener("scroll",onScrollLoadAnalytics)}function onScrollLoadAnalytics(){window.scrollY>100&&loadAnalyticsScript()}window.addEventListener("scroll",onScrollLoadAnalytics)</script><script defer>function loadClarityScript(){(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","m535olg9md"),window.removeEventListener("scroll",onScrollLoadClarity)}function onScrollLoadClarity(){window.scrollY>100&&loadClarityScript()}window.addEventListener("scroll",onScrollLoadClarity)</script><div class=top-scroll-bar style=height:5px;background-color:blue;width:0;position:fixed;top:0;z-index:100></div><script type=text/javascript>$(document).ready(function(){$(window).scroll(function(){$(".top-scroll-bar").attr("style","width: "+$(this).scrollTop()/($(document).height()-$(this).height())*100+"%; display: block;")})})</script><script src=https://cdn.jsdelivr.net/gh/instantpage/instant.page@master/instantpage.js type=module></script><script type=text/javascript>var titleTime,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="老板别走吖 Σ(っ °Д °;)っ",clearTimeout(titleTime)):(document.title="老板您可算回来了 (｡•ˇ‸ˇ•｡)"+OriginTitile,titleTime=setTimeout(function(){document.title=OriginTitile},2e3))})</script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳过正文</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><img src=/img/logo.jpeg width=256 height=256 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=进击云原生></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900"><h6 style=font-size:1.5rem><span style=color:#abd123>>$</span>&nbsp;cd /home/<span class=logo_cursor></span></h6></a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href="https://cloud.umami.is/share/h5GReomkOf4fsBGd/kubeinfo.cn?theme=dark" target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span><p class="text-base font-medium" title>实时访客</p></a><div><div class="cursor-pointer flex items-center nested-menu"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg>
</span></span><a class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title>百宝箱
</a><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=https://upptime.kubeinfo.cn/ target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M228.3 469.1 47.6 300.4c-4.2-3.9-8.2-8.1-11.9-12.4h87c22.6.0 43-13.6 51.7-34.5l10.5-25.2 49.3 109.5c3.8 8.5 12.1 14 21.4 14.1s17.8-5 22-13.3L320 253.7l1.7 3.4c9.5 19 28.9 31 50.1 31H476.3c-3.7 4.3-7.7 8.5-11.9 12.4L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9s-20.2-3.9-27.7-10.9zM503.7 240h-132c-3 0-5.8-1.7-7.2-4.4l-23.2-46.3c-4.1-8.1-12.4-13.3-21.5-13.3s-17.4 5.1-21.5 13.3l-41.4 82.8-51-113.9c-3.9-8.7-12.7-14.3-22.2-14.1s-18.1 5.9-21.8 14.8l-31.8 76.3c-1.2 3-4.2 4.9-7.4 4.9H16c-2.6.0-5 .4-7.3 1.1-5.7-16-8.7-33-8.7-50.3v-5.8c0-69.9 50.5-129.5 119.4-141C165 36.5 211.4 51.4 244 84l12 12 12-12c32.6-32.6 79-47.5 124.6-39.9C461.5 55.6 512 115.2 512 185.1v5.8c0 16.9-2.8 33.5-8.3 49.1z"/></svg></span></span><p class="text-sm font-sm" title>服务监控</p></a><a href=/jstc/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M0 96C0 60.7 28.7 32 64 32H448c35.3.0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3.0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4S78.8 416 88 416h96 32H424c8.9.0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192c26.5.0 48-21.5 48-48s-21.5-48-48-48-48 21.5-48 48 21.5 48 48 48z"/></svg></span></span><p class="text-sm font-sm" title>趣味截图</p></a></div></div></div></div><a href=/index.xml class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></span><p class="text-base font-medium" title=rss></p></a><a href=https://github.com/smallersoup target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><p class="text-base font-medium" title=github></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400" style=margin-right:5px><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href="https://cloud.umami.is/share/h5GReomkOf4fsBGd/kubeinfo.cn?theme=dark" target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></div><p class="text-bg font-bg" title>实时访客</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg></span></span><p class="text-bg font-bg" title>百宝箱</p><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></a></li><li class=mt-1><a href=https://upptime.kubeinfo.cn/ target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M228.3 469.1 47.6 300.4c-4.2-3.9-8.2-8.1-11.9-12.4h87c22.6.0 43-13.6 51.7-34.5l10.5-25.2 49.3 109.5c3.8 8.5 12.1 14 21.4 14.1s17.8-5 22-13.3L320 253.7l1.7 3.4c9.5 19 28.9 31 50.1 31H476.3c-3.7 4.3-7.7 8.5-11.9 12.4L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9s-20.2-3.9-27.7-10.9zM503.7 240h-132c-3 0-5.8-1.7-7.2-4.4l-23.2-46.3c-4.1-8.1-12.4-13.3-21.5-13.3s-17.4 5.1-21.5 13.3l-41.4 82.8-51-113.9c-3.9-8.7-12.7-14.3-22.2-14.1s-18.1 5.9-21.8 14.8l-31.8 76.3c-1.2 3-4.2 4.9-7.4 4.9H16c-2.6.0-5 .4-7.3 1.1-5.7-16-8.7-33-8.7-50.3v-5.8c0-69.9 50.5-129.5 119.4-141C165 36.5 211.4 51.4 244 84l12 12 12-12c32.6-32.6 79-47.5 124.6-39.9C461.5 55.6 512 115.2 512 185.1v5.8c0 16.9-2.8 33.5-8.3 49.1z"/></svg></span></span><p class="text-sm font-small" title>服务监控</p></a></li><li class=mt-1><a href=/jstc/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M0 96C0 60.7 28.7 32 64 32H448c35.3.0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3.0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4S78.8 416 88 416h96 32H424c8.9.0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192c26.5.0 48-21.5 48-48s-21.5-48-48-48-48 21.5-48 48 21.5 48 48 48z"/></svg></span></span><p class="text-sm font-small" title>趣味截图</p></a></li><li class=mb-2></li><li class=mt-1><a href=/index.xml class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></div><p class="text-bg font-bg" title=rss></p></a></li><li class=mt-1><a href=https://github.com/smallersoup target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></div><p class="text-bg font-bg" title=github></p></a></li></ul></div></label></div></div><script>(function(){var e=$(".main-menu"),t=window.location.pathname;e.find('a[href="'+t+'"]').each(function(e,t){$(t).children("p").addClass("active")})})()</script></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><figure><img class="w-full rounded-lg single_hero_round nozoom" alt="kubernetes垃圾回收器GarbageCollector 源码分析（三）" width=1200 height=800 src=/img/ocean_hu_f78b3c25ca3bb793.jpg></figure><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>进击云原生</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/>kubernetes垃圾回收器GarbageCollector 源码分析（三）</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">kubernetes垃圾回收器GarbageCollector 源码分析（三）</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-21T17:40:11+00:00>2019年10月21日</time><span class="px-2 text-primary-500">&#183;</span><span>8334 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>17 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/smallersoup/blog/tree/main/content/zh-cn/posts/kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8GarbageCollector%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e4%b8%89.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title=编辑内容><span class="inline-block align-text-bottom"><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentcolor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg>
</span></span></a></span><span class="px-2 text-primary-500">&#183;</span>
<script type=text/javascript src=/js/zen-mode.min.2a0a1375509c03daf41c53a9831aa2d560895b7a2528c3eb3b56e7b11a135c7529e49727162a053b6193be8340270a8342f42c69f3d7e262ae54bc248eaac8f5.js integrity="sha512-KgoTdVCcA9r0HFOpgxqi1WCJW3olKMPrO1bnsRoTXHUp5JcnFioFO2GTvoNAJwqDQvQsafPX4mKuVLwkjqrI9Q=="></script><span class=mb-[2px]><span id=zen-mode-button class="text-lg hover:text-primary-500" title=启用极简模式 data-title-i18n-disable=启用极简模式 data-title-i18n-enable=关闭极简模式><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentcolor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt=小碗汤 src=/img/avatar_hu_2fef7e4e758589d5.jpeg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">小碗汤</div><div class="text-sm text-neutral-700 dark:text-neutral-400">云原生搬砖师</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=/index.xml target=_blank aria-label=Rss rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://images.kubeinfo.cn/uPic/tmpm1ykjt96.webp target=_blank aria-label=Wechat rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg width="800" height="800" viewBox="0 0 24 24" fill="none"><path d="M11.8088 7.05902C11.3508 7.06746 10.9637 7.45766 10.9718 7.90277 10.9802 8.36421 11.3599 8.7252 11.8309 8.7196 12.3031 8.71385 12.6613 8.3491 12.6568 7.87785 12.6529 7.41534 12.2749 7.05051 11.8088 7.05902zm-4.45801.85655C7.36789 7.47215 6.98366 7.07275 6.52729 7.05933 6.06002 7.04561 5.67572 7.40269 5.66207 7.8632 5.64827 8.32985 6.0052 8.70373 6.47584 8.71569 6.94241 8.72757 7.33354 8.36996 7.35079 7.91557zm8.54451.75542C14.0388 8.76798 12.4244 9.33078 11.1137 10.6023c-1.3243 1.2847-1.92882 2.8588-1.76358 4.8103C8.62446 15.3226 7.96351 15.2237 7.2988 15.1678 7.06924 15.1484 6.7968 15.1759 6.60235 15.2856 5.95689 15.6498 5.33812 16.061 4.60471 16.5195 4.73928 15.9108 4.82638 15.3778 4.98058 14.8652 5.09398 14.4884 5.04146 14.2788 4.69434 14.0333c-2.22866-1.5734-3.1681-3.9282-2.46505-6.35259.65044-2.24277 2.24776-3.60293 4.41815-4.31196C9.60982 2.4011 12.939 3.38815 14.7404 5.74012 15.391 6.58969 15.7899 7.54323 15.8953 8.67099z" fill="currentcolor"/><path d="M17.6884 12.3843C17.3253 12.3818 17.0167 12.6791 17.0019 13.046 16.9861 13.4383 17.2912 13.7605 17.6794 13.7615 18.055 13.7627 18.3517 13.4787 18.3655 13.105 18.38 12.7117 18.0749 12.387 17.6884 12.3843zm-4.3139 1.3819C13.7489 13.7666 14.057 13.4737 14.0711 13.1041 14.0861 12.7127 13.7713 12.3845 13.3795 12.3828 12.9915 12.381 12.6664 12.714 12.6799 13.0994 12.6927 13.4678 13.003 13.7658 13.3745 13.7662zm6.6919 6.479C19.4785 19.9835 18.9392 19.5907 18.3652 19.5308 17.7932 19.471 17.1919 19.801 16.5936 19.8622 14.771 20.0486 13.138 19.5407 11.7916 18.2956 9.23081 15.927 9.59671 12.2954 12.5594 10.3543c2.6331-1.72503 6.4948-1.14995 8.3513 1.2437C22.5307 13.6866 22.3403 16.4592 20.3626 18.2139 19.7903 18.7217 19.5843 19.1397 19.9515 19.809 20.0193 19.9326 20.027 20.0891 20.0664 20.2452z" fill="currentcolor"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/smallersoup target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#主要步骤>主要步骤</a></li><li><a href=#终结器>终结器</a></li><li><a href=#attempttodelete队列>attemptToDelete队列</a></li><li><a href=#attempttoorphan队列>attemptToOrphan队列</a></li><li><a href=#回到初衷>回到初衷</a><ul><li><a href=#原因定位>原因定位</a></li><li><a href=#解决方法>解决方法</a></li><li><a href=#思考反思>思考反思</a></li></ul></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#主要步骤>主要步骤</a></li><li><a href=#终结器>终结器</a></li><li><a href=#attempttodelete队列>attemptToDelete队列</a></li><li><a href=#attempttoorphan队列>attemptToOrphan队列</a></li><li><a href=#回到初衷>回到初衷</a><ul><li><a href=#原因定位>原因定位</a></li><li><a href=#解决方法>解决方法</a></li><li><a href=#思考反思>思考反思</a></li></ul></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div></details><script>(function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var s,o=t.scrollTop(),i=$(".anchor"),n="";if(i.each(function(e,t){t=$(t),t.offset().top-$(window).height()/3<=o&&(n=decodeURIComponent(t.attr("id")))}),s=e.find("a.active"),s.length==1&&s.eq(0).attr("href")=="#"+n)return!0;s.each(function(e,t){$(t).removeClass("active")}),e.find('a[href="#'+n+'"]').addClass("active"),e.find('a[href="#'+n+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").parents("ul").show()})}t.on("scroll",n),$(document).ready(function(){n()})}})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><blockquote><p><strong>kubernetes版本：1.13.2</strong></p></blockquote><p>接前两节：<br><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvMTAwMDgxOTQx" target=_blank>kubernetes垃圾回收器GarbageCollector Controller源码分析（一）</a><br><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvMTAwNTQ5MjUx" target=_blank>kubernetes垃圾回收器GarbageCollector Controller源码分析（二）</a></p><h2 class="relative group">主要步骤<div id=主要步骤 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%b8%bb%e8%a6%81%e6%ad%a5%e9%aa%a4 aria-label=锚点>#</a></span></h2><p>GarbageCollector Controller源码主要分为以下几部分：</p><ol><li><code>monitors</code>作为生产者将变化的资源放入<code>graphChanges</code>队列；同时<code>restMapper</code>定期检测集群内资源类型，刷新<code>monitors</code></li><li><code>runProcessGraphChanges</code>从<code>graphChanges</code>队列中取出变化的<code>item</code>，根据情况放入<code>attemptToDelete</code>队列；</li><li><code>runProcessGraphChanges</code>从<code>graphChanges</code>队列中取出变化的<code>item</code>，根据情况放入<code>attemptToOrphan</code>队列；</li><li><code>runAttemptToDeleteWorker</code>从<code>attemptToDelete</code>队列取出，尝试删除垃圾资源；</li><li><code>runAttemptToOrphanWorker</code>从<code>attemptToOrphan</code>队列取出，处理该孤立的资源；<br><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20190903103422219.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure><br>上一节分析了第2,3部分，本节分析第4、5部分。</li></ol><h2 class="relative group">终结器<div id=终结器 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%bb%88%e7%bb%93%e5%99%a8 aria-label=锚点>#</a></span></h2><p><strong>在阅读以下代码时，有必要先了解一下终结器。</strong></p><p>对象的终结器是在对象删除之前需要执行的逻辑，所有的对象在删除之前，它的终结器字段必须为空，终结器提供了一个通用的 API，它的功能不只是用于阻止级联删除，还能过通过它在对象删除之前加入钩子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ObjectMeta</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...</span>
</span></span><span class=line><span class=cl>	<span class=nx>Finalizers</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>终结器在对象被删之前运行，每当终结器成功运行之后，就会将它自己从 Finalizers 数组中删除，当最后一个终结器被删除之后，API Server 就会删除该对象。</p><p>在默认情况下，删除一个对象会删除它的全部依赖，但是我们在一些特定情况下我们只是想删除当前对象本身并不想造成复杂的级联删除，垃圾回收机制在这时引入了 OrphanFinalizer，它会在对象被删除之前向 Finalizers 数组添加或者删除 OrphanFinalizer。</p><p>该终结器会监听对象的更新事件并将它自己从它全部依赖对象的 OwnerReferences 数组中删除，与此同时会删除所有依赖对象中已经失效的 OwnerReferences 并将 OrphanFinalizer 从 Finalizers 数组中删除。</p><p>通过 OrphanFinalizer 我们能够在删除一个 Kubernetes 对象时保留它的全部依赖，为使用者提供一种更灵活的办法来保留和删除对象。</p><p><strong>同时，也希望可以看一下"垃圾回收"官网文档</strong>：<br><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2dhcmJhZ2UtY29sbGVjdGlvbi8%3d" target=_blank>垃圾收集</a></p><h2 class="relative group">attemptToDelete队列<div id=attempttodelete队列 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#attempttodelete%e9%98%9f%e5%88%97 aria-label=锚点>#</a></span></h2><p>来到代码$GOPATH\src\k8s.io\kubernetes\pkg\controller\garbagecollector\garbagecollector.go中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>gc</span> <span class=o>*</span><span class=nx>GarbageCollector</span><span class=p>)</span> <span class=nf>runAttemptToDeleteWorker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>attemptToDeleteWorker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>从attemptToDelete队列中取出资源，调用gc.attemptToDeleteItem(n)处理，期间如果出现error，则通过rateLimited重新加回attemptToDelete队列。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>gc</span> <span class=o>*</span><span class=nx>GarbageCollector</span><span class=p>)</span> <span class=nf>attemptToDeleteWorker</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//从队列里取出需要尝试删除的资源</span>
</span></span><span class=line><span class=cl>	<span class=nx>item</span><span class=p>,</span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nx>attemptToDelete</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>gc</span><span class=p>.</span><span class=nx>workerLock</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>gc</span><span class=p>.</span><span class=nx>workerLock</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>quit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>gc</span><span class=p>.</span><span class=nx>attemptToDelete</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>n</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>item</span><span class=p>.(</span><span class=o>*</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;expect *node, got %#v&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>attemptToDeleteItem</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>restMappingError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// There are at least two ways this can happen:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 1. The reference is to an object of a custom type that has not yet been</span>
</span></span><span class=line><span class=cl>			<span class=c1>//    recognized by gc.restMapper (this is a transient error).</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 2. The reference is to an invalid group/version. We don&#39;t currently</span>
</span></span><span class=line><span class=cl>			<span class=c1>//    have a way to distinguish this from a valid type we will recognize</span>
</span></span><span class=line><span class=cl>			<span class=c1>//    after the next discovery sync.</span>
</span></span><span class=line><span class=cl>			<span class=c1>// For now, record the error and retry.</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;error syncing item %s: %v&#34;</span><span class=p>,</span> <span class=nx>n</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error syncing item %s: %v&#34;</span><span class=p>,</span> <span class=nx>n</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// retry if garbage collection of an object failed.</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果对象的垃圾收集失败，则重试。</span>
</span></span><span class=line><span class=cl>		<span class=nx>gc</span><span class=p>.</span><span class=nx>attemptToDelete</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>!</span><span class=nx>n</span><span class=p>.</span><span class=nf>isObserved</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// requeue if item hasn&#39;t been observed via an informer event yet.</span>
</span></span><span class=line><span class=cl>		<span class=c1>// otherwise a virtual node for an item added AND removed during watch reestablishment can get stuck in the graph and never removed.</span>
</span></span><span class=line><span class=cl>		<span class=c1>// see https://issue.k8s.io/56121</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;item %s hasn&#39;t been observed via informer yet&#34;</span><span class=p>,</span> <span class=nx>n</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>gc</span><span class=p>.</span><span class=nx>attemptToDelete</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>关键方法attemptToDeleteItem：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>gc</span> <span class=o>*</span><span class=nx>GarbageCollector</span><span class=p>)</span> <span class=nf>attemptToDeleteItem</span><span class=p>(</span><span class=nx>item</span> <span class=o>*</span><span class=nx>node</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;processing item %s&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;being deleted&#34; is an one-way trip to the final deletion. We&#39;ll just wait for the final deletion, and then process the object&#39;s dependents.</span>
</span></span><span class=line><span class=cl>	<span class=c1>// item资源被标记为正在删除,即deletionTimestamp不为nil;且不是正在删除从资源(这个从上一节可以看出,只有item被foreground方式删除时,deletingDependents才会被设置为true)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// item在删除中,且为Orphan和Background方式删除则直接返回</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>item</span><span class=p>.</span><span class=nf>isBeingDeleted</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>item</span><span class=p>.</span><span class=nf>isDeletingDependents</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;processing item %s returned at once, because its DeletionTimestamp is non-nil&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// TODO: It&#39;s only necessary to talk to the API server if this is a</span>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;virtual&#34; node. The local graph could lag behind the real status, but in</span>
</span></span><span class=line><span class=cl>	<span class=c1>// practice, the difference is small.</span>
</span></span><span class=line><span class=cl>	<span class=c1>//根据item里的信息获取object对象体</span>
</span></span><span class=line><span class=cl>	<span class=nx>latest</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>getObject</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=c1>// the GraphBuilder can add &#34;virtual&#34; node for an owner that doesn&#39;t</span>
</span></span><span class=line><span class=cl>		<span class=c1>// exist yet, so we need to enqueue a virtual Delete event to remove</span>
</span></span><span class=line><span class=cl>		<span class=c1>// the virtual node from GraphBuilder.uidToNode.</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;item %v not found, generating a virtual delete event&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>gc</span><span class=p>.</span><span class=nx>dependencyGraphBuilder</span><span class=p>.</span><span class=nf>enqueueVirtualDeleteEvent</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// since we&#39;re manually inserting a delete event to remove this node,</span>
</span></span><span class=line><span class=cl>		<span class=c1>// we don&#39;t need to keep tracking it as a virtual node and requeueing in attemptToDelete</span>
</span></span><span class=line><span class=cl>		<span class=nx>item</span><span class=p>.</span><span class=nf>markObserved</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>//uid不匹配</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>latest</span><span class=p>.</span><span class=nf>GetUID</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>.</span><span class=nx>UID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;UID doesn&#39;t match, item %v not found, generating a virtual delete event&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>gc</span><span class=p>.</span><span class=nx>dependencyGraphBuilder</span><span class=p>.</span><span class=nf>enqueueVirtualDeleteEvent</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// since we&#39;re manually inserting a delete event to remove this node,</span>
</span></span><span class=line><span class=cl>		<span class=c1>// we don&#39;t need to keep tracking it as a virtual node and requeueing in attemptToDelete</span>
</span></span><span class=line><span class=cl>		<span class=c1>//因为我们手动插入删除事件以删除此节点，我们不需要将其作为虚拟节点跟踪并在attemptToDelete中重新排队</span>
</span></span><span class=line><span class=cl>		<span class=nx>item</span><span class=p>.</span><span class=nf>markObserved</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// TODO: attemptToOrphanWorker() routine is similar. Consider merging</span>
</span></span><span class=line><span class=cl>	<span class=c1>// attemptToOrphanWorker() into attemptToDeleteItem() as well.</span>
</span></span><span class=line><span class=cl>	<span class=c1>// item的从资源正在删除中,同时删除其从资源</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>item</span><span class=p>.</span><span class=nf>isDeletingDependents</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>processDeletingDependentsItem</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// compute if we should delete the item</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取该object里metadata.ownerReference</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 计算我们是否应删除该项目</span>
</span></span><span class=line><span class=cl>	<span class=nx>ownerReferences</span> <span class=o>:=</span> <span class=nx>latest</span><span class=p>.</span><span class=nf>GetOwnerReferences</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ownerReferences</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>//没有owner的不用处理</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;object %s&#39;s doesn&#39;t have an owner, continue on next item&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>//solid(owner存在,owner没被删或者终结器不为foregroundDeletion Finalizer); dangling(owner不存在)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// waitingForDependentsDeletion(owner存在,owner的deletionTimestamp为非nil，并且有foregroundDeletion Finalizer)owner列表</span>
</span></span><span class=line><span class=cl>	<span class=nx>solid</span><span class=p>,</span> <span class=nx>dangling</span><span class=p>,</span> <span class=nx>waitingForDependentsDeletion</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>classifyReferences</span><span class=p>(</span><span class=nx>item</span><span class=p>,</span> <span class=nx>ownerReferences</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;classify references of %s.\nsolid: %#v\ndangling: %#v\nwaitingForDependentsDeletion: %#v\n&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=nx>solid</span><span class=p>,</span> <span class=nx>dangling</span><span class=p>,</span> <span class=nx>waitingForDependentsDeletion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//item对象的owner存在,且不是正在删除</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nb>len</span><span class=p>(</span><span class=nx>solid</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;object %#v has at least one existing owner: %#v, will not garbage collect&#34;</span><span class=p>,</span> <span class=nx>solid</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>dangling</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>waitingForDependentsDeletion</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;remove dangling references %#v and waiting references %#v for object %s&#34;</span><span class=p>,</span> <span class=nx>dangling</span><span class=p>,</span> <span class=nx>waitingForDependentsDeletion</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// waitingForDependentsDeletion needs to be deleted from the</span>
</span></span><span class=line><span class=cl>		<span class=c1>// ownerReferences, otherwise the referenced objects will be stuck with</span>
</span></span><span class=line><span class=cl>		<span class=c1>// the FinalizerDeletingDependents and never get deleted.</span>
</span></span><span class=line><span class=cl>		<span class=c1>// waitingForDependentsDeletion需要从 ownerReferences中删除，否则引用的对象将被</span>
</span></span><span class=line><span class=cl>		<span class=c1>// FinalizerDeletingDependents所卡住，并且永远不会被删除。</span>
</span></span><span class=line><span class=cl>		<span class=c1>//需要移除的ownerUids</span>
</span></span><span class=line><span class=cl>		<span class=nx>ownerUIDs</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nf>ownerRefsToUIDs</span><span class=p>(</span><span class=nx>dangling</span><span class=p>),</span> <span class=nf>ownerRefsToUIDs</span><span class=p>(</span><span class=nx>waitingForDependentsDeletion</span><span class=p>)</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>//拼接patch请求参数</span>
</span></span><span class=line><span class=cl>		<span class=nx>patch</span> <span class=o>:=</span> <span class=nf>deleteOwnerRefStrategicMergePatch</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>ownerUIDs</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>//发送patch请求</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>patch</span><span class=p>(</span><span class=nx>item</span><span class=p>,</span> <span class=nx>patch</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>node</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>deleteOwnerRefJSONMergePatch</span><span class=p>(</span><span class=nx>n</span><span class=p>,</span> <span class=nx>ownerUIDs</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=c1>//item对象的owner正在被删除; 且item有从资源</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nb>len</span><span class=p>(</span><span class=nx>waitingForDependentsDeletion</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>item</span><span class=p>.</span><span class=nf>dependentsLength</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>deps</span> <span class=o>:=</span> <span class=nx>item</span><span class=p>.</span><span class=nf>getDependents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 遍历item从资源</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>dep</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>deps</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>dep</span><span class=p>.</span><span class=nf>isDeletingDependents</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// this circle detection has false positives, we need to</span>
</span></span><span class=line><span class=cl>				<span class=c1>// apply a more rigorous detection if this turns out to be a</span>
</span></span><span class=line><span class=cl>				<span class=c1>// problem.</span>
</span></span><span class=line><span class=cl>				<span class=c1>// there are multiple workers run attemptToDeleteItem in</span>
</span></span><span class=line><span class=cl>				<span class=c1>// parallel, the circle detection can fail in a race condition.</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;processing object %s, some of its owners and its dependent [%s] have FinalizerDeletingDependents, to prevent potential cycle, its ownerReferences are going to be modified to be non-blocking, then the object is going to be deleted with Foreground&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=nx>dep</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 生成一个补丁，该补丁会取消设置item所有ownerReferences的BlockOwnerDeletion字段,避免阻塞item的owner删除</span>
</span></span><span class=line><span class=cl>				<span class=nx>patch</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>item</span><span class=p>.</span><span class=nf>unblockOwnerReferencesStrategicMergePatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>//执行patch</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>patch</span><span class=p>(</span><span class=nx>item</span><span class=p>,</span> <span class=nx>patch</span><span class=p>,</span> <span class=nx>gc</span><span class=p>.</span><span class=nx>unblockOwnerReferencesJSONMergePatch</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>//item对象的至少一个owner具有foregroundDeletion Finalizer，并且该对象本身具有依赖项，因此它将在Foreground中删除</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;at least one owner of object %s has FinalizerDeletingDependents, and the object itself has dependents, so it is going to be deleted in Foreground&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// the deletion event will be observed by the graphBuilder, so the item</span>
</span></span><span class=line><span class=cl>		<span class=c1>// will be processed again in processDeletingDependentsItem. If it</span>
</span></span><span class=line><span class=cl>		<span class=c1>// doesn&#39;t have dependents, the function will remove the</span>
</span></span><span class=line><span class=cl>		<span class=c1>// FinalizerDeletingDependents from the item, resulting in the final</span>
</span></span><span class=line><span class=cl>		<span class=c1>// deletion of the item.</span>
</span></span><span class=line><span class=cl>		<span class=c1>// graphBuilder将观察删除事件，因此将在processDeletingDependentsItem中再次处理该项目。</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果没有依赖项，该函数将从项中删除foregroundDeletion Finalizer，最终删除item。</span>
</span></span><span class=line><span class=cl>		<span class=nx>policy</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>DeletePropagationForeground</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>deleteObject</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>policy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// item doesn&#39;t have any solid owner, so it needs to be garbage</span>
</span></span><span class=line><span class=cl>		<span class=c1>// collected. Also, none of item&#39;s owners is waiting for the deletion of</span>
</span></span><span class=line><span class=cl>		<span class=c1>// the dependents, so set propagationPolicy based on existing finalizers.</span>
</span></span><span class=line><span class=cl>		<span class=c1>// item没有任何实体所有者，因此需要收集垃圾 。此外，项目的所有者都没有等待删除</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 依赖项，因此请根据现有的终结器设置propagationPolicy。</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>policy</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>DeletionPropagation</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nf>hasOrphanFinalizer</span><span class=p>(</span><span class=nx>latest</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=c1>// if an existing orphan finalizer is already on the object, honor it.</span>
</span></span><span class=line><span class=cl>			<span class=c1>//如果现有的孤儿终结器已经在对象上，请尊重它。</span>
</span></span><span class=line><span class=cl>			<span class=nx>policy</span> <span class=p>=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>DeletePropagationOrphan</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nf>hasDeleteDependentsFinalizer</span><span class=p>(</span><span class=nx>latest</span><span class=p>):</span>
</span></span><span class=line><span class=cl>			<span class=c1>// if an existing foreground finalizer is already on the object, honor it.</span>
</span></span><span class=line><span class=cl>			<span class=c1>//如果现有的前景终结器已经在对象上，请尊重它。</span>
</span></span><span class=line><span class=cl>			<span class=nx>policy</span> <span class=p>=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>DeletePropagationForeground</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// otherwise, default to background.</span>
</span></span><span class=line><span class=cl>			<span class=c1>//否则，默认为背景。</span>
</span></span><span class=line><span class=cl>			<span class=nx>policy</span> <span class=p>=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>DeletePropagationBackground</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;delete object %s with propagation policy %s&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=nx>policy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>//删除孤儿对象</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>deleteObject</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>policy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>主要做以下事情：<br>1、item在删除中，且为Orphan和Background方式删除则直接返回；<br>2、item是foreground方式删除时，调用processDeletingDependentsItem去处理阻塞其删除的从资源，将其放到attemptToDelete队列；<br>3、获取item的owner对象集，调用classifyReferences将owner集合分为3类，分别为solid（owner存在或者终结器不为foregroundDeletion的owner集合）, dangling（已经不存在了的owner集群）, waitingForDependentsDeletion（owner的deletionTimestamp为非nil，并且为foregroundDeletion终结器的owner集合）<br>4、switch第一个case：solid集合不为空，即item存在没被删除的owner。当dangling和waitingForDependentsDeletion都为空，则直接返回；当dangling或waitingForDependentsDeletion不为空，合并两个集合uid，执行patch请求，将这些uid对应的ownerReferences从item中删除<br>5、switch第二个case：waitingForDependentsDeletion集合不为空，且item有从资源。即item的owner不存在，或正在被foregroundDeletion方式删除，如果item的从资源正在删除依赖项，则取消阻止item的owner删除，给item执行patch请求，最终采用foregroundDeletion方式删除item；<br>6、switch第三个case：以上条件不符合时，则直接根据item中的终结器删除item，默认为Background方式删除。</p><hr><p>往细了说，processDeletingDependentsItem方法获取item从资源中BlockOwnerDeletion为true的ownerReferences集合，如果为空，则移除item的foregroundDeletion终结器。否则遍历，将未开始删除的依赖项的从资源dep加入到尝试删除队列attemptToDelete。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>//等待其依赖项被删除的进程项</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>gc</span> <span class=o>*</span><span class=nx>GarbageCollector</span><span class=p>)</span> <span class=nf>processDeletingDependentsItem</span><span class=p>(</span><span class=nx>item</span> <span class=o>*</span><span class=nx>node</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//阻塞item资源删除的从资源列表</span>
</span></span><span class=line><span class=cl>	<span class=nx>blockingDependents</span> <span class=o>:=</span> <span class=nx>item</span><span class=p>.</span><span class=nf>blockingDependents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>//没有阻塞item资源删除的从资源,则移除item资源的foregroundDeletion终结器</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>blockingDependents</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;remove DeleteDependents finalizer for item %s&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>removeFinalizer</span><span class=p>(</span><span class=nx>item</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>FinalizerDeleteDependents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>//遍历阻塞item资源删除的从资源</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>dep</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>blockingDependents</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果dep的从资源没有开始删除,则将dep加入到尝试删除队列中</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>dep</span><span class=p>.</span><span class=nf>isDeletingDependents</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;adding %s to attemptToDelete, because its owner %s is deletingDependents&#34;</span><span class=p>,</span> <span class=nx>dep</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=c1>//将从资源加入删除队列</span>
</span></span><span class=line><span class=cl>			<span class=nx>gc</span><span class=p>.</span><span class=nx>attemptToDelete</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>dep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>gc.classifyReferences(item, ownerReferences)方法：遍历了item的owner列表，调用isDangling方法将已不存在的owner加入到isDangling列表；owner正在被删除,且owner有foregroundDeletion终结器的加入到waitingForDependentsDeletion列表；owner没开始删或者终结器不为foregroundDeletion的加入到solid列表。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 将latestReferences分为三类：</span>
</span></span><span class=line><span class=cl><span class=c1>// solid：所有者存在，且不是waitingForDependentsDeletion</span>
</span></span><span class=line><span class=cl><span class=c1>// dangling悬空：所有者不存在</span>
</span></span><span class=line><span class=cl><span class=c1>// waitingForDependentsDeletion: 所有者存在，其deletionTimestamp为非nil，并且有FinalizerDeletingDependents</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>gc</span> <span class=o>*</span><span class=nx>GarbageCollector</span><span class=p>)</span> <span class=nf>classifyReferences</span><span class=p>(</span><span class=nx>item</span> <span class=o>*</span><span class=nx>node</span><span class=p>,</span> <span class=nx>latestReferences</span> <span class=p>[]</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>OwnerReference</span><span class=p>)</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>solid</span><span class=p>,</span> <span class=nx>dangling</span><span class=p>,</span> <span class=nx>waitingForDependentsDeletion</span> <span class=p>[]</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>OwnerReference</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//遍历该node的owner</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>reference</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>latestReferences</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>//获取owner是否存在;isDangling为true表示不存在,发生err则最终将该item加入AddRateLimited attemptToDelete队列</span>
</span></span><span class=line><span class=cl>		<span class=nx>isDangling</span><span class=p>,</span> <span class=nx>owner</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>isDangling</span><span class=p>(</span><span class=nx>reference</span><span class=p>,</span> <span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>//将不存在的owner加入dangling切片</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>isDangling</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>dangling</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>dangling</span><span class=p>,</span> <span class=nx>reference</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>//owner存在,获取accessor</span>
</span></span><span class=line><span class=cl>		<span class=nx>ownerAccessor</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>meta</span><span class=p>.</span><span class=nf>Accessor</span><span class=p>(</span><span class=nx>owner</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>//owner正在被删除,且owner有foregroundDeletion Finalizer</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>ownerAccessor</span><span class=p>.</span><span class=nf>GetDeletionTimestamp</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nf>hasDeleteDependentsFinalizer</span><span class=p>(</span><span class=nx>ownerAccessor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>//owner将等待依赖删除;收集等待删除依赖的owner列表</span>
</span></span><span class=line><span class=cl>			<span class=nx>waitingForDependentsDeletion</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>waitingForDependentsDeletion</span><span class=p>,</span> <span class=nx>reference</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>//owner没被删或者终结器不为foregroundDeletion Finalizer</span>
</span></span><span class=line><span class=cl>			<span class=nx>solid</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>solid</span><span class=p>,</span> <span class=nx>reference</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>solid</span><span class=p>,</span> <span class=nx>dangling</span><span class=p>,</span> <span class=nx>waitingForDependentsDeletion</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>gc.isDangling(reference, item)方法：先从absentOwnerCache缓存中根据owner uid获取owner是否存在；如果缓存中没有，则根据ownerReferences中的参数，构建参数，调用apiserver接口获取owner对象是否能查到。查到如果uid不匹配，加入absentOwnerCache缓存，并返回false。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// isDangling检查引用是否指向不存在的对象。 如果isDangling在API服务器上查找引用的对象，它也返回其最新状态。</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>gc</span> <span class=o>*</span><span class=nx>GarbageCollector</span><span class=p>)</span> <span class=nf>isDangling</span><span class=p>(</span><span class=nx>reference</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>OwnerReference</span><span class=p>,</span> <span class=nx>item</span> <span class=o>*</span><span class=nx>node</span><span class=p>)</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>dangling</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>owner</span> <span class=o>*</span><span class=nx>unstructured</span><span class=p>.</span><span class=nx>Unstructured</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>gc</span><span class=p>.</span><span class=nx>absentOwnerCache</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>reference</span><span class=p>.</span><span class=nx>UID</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;according to the absentOwnerCache, object %s&#39;s owner %s/%s, %s does not exist&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>APIVersion</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// TODO: we need to verify the reference resource is supported by the</span>
</span></span><span class=line><span class=cl>	<span class=c1>// system. If it&#39;s not a valid resource, the garbage collector should i)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ignore the reference when decide if the object should be deleted, and</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ii) should update the object to remove such references. This is to</span>
</span></span><span class=line><span class=cl>	<span class=c1>// prevent objects having references to an old resource from being</span>
</span></span><span class=line><span class=cl>	<span class=c1>// deleted during a cluster upgrade.</span>
</span></span><span class=line><span class=cl>	<span class=nx>resource</span><span class=p>,</span> <span class=nx>namespaced</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>apiResource</span><span class=p>(</span><span class=nx>reference</span><span class=p>.</span><span class=nx>APIVersion</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>Kind</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// TODO: It&#39;s only necessary to talk to the API server if the owner node</span>
</span></span><span class=line><span class=cl>	<span class=c1>// is a &#34;virtual&#34; node. The local graph could lag behind the real</span>
</span></span><span class=line><span class=cl>	<span class=c1>// status, but in practice, the difference is small.</span>
</span></span><span class=line><span class=cl>	<span class=nx>owner</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>gc</span><span class=p>.</span><span class=nx>dynamicClient</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=nx>resource</span><span class=p>).</span><span class=nf>Namespace</span><span class=p>(</span><span class=nf>resourceDefaultNamespace</span><span class=p>(</span><span class=nx>namespaced</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>)).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>reference</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>GetOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=nx>gc</span><span class=p>.</span><span class=nx>absentOwnerCache</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>reference</span><span class=p>.</span><span class=nx>UID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;object %s&#39;s owner %s/%s, %s is not found&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>APIVersion</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>owner</span><span class=p>.</span><span class=nf>GetUID</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>UID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;object %s&#39;s owner %s/%s, %s is not found, UID mismatch&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>.</span><span class=nx>identity</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>APIVersion</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span> <span class=nx>reference</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>gc</span><span class=p>.</span><span class=nx>absentOwnerCache</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>reference</span><span class=p>.</span><span class=nx>UID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>owner</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">attemptToOrphan队列<div id=attempttoorphan队列 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#attempttoorphan%e9%98%9f%e5%88%97 aria-label=锚点>#</a></span></h2><p>来到代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>gc</span> <span class=o>*</span><span class=nx>GarbageCollector</span><span class=p>)</span> <span class=nf>runAttemptToOrphanWorker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>attemptToOrphanWorker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>死循环一直从attemptToOrphan队列中获取item资源，调用gc.orphanDependents(owner.identity, dependents)方法，从item从资源中删掉该item的ownerReferences，期间如果发生错误，则通过rateLimited重新加回attemptToOrphan队列。最后移除item中的orphan终结器。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// attemptToOrphanWorker将一个节点从attemptToOrphan中取出，然后根据GC维护的图找到它的依赖项，然后将其从其依赖项的</span>
</span></span><span class=line><span class=cl><span class=c1>// OwnerReferences中删除，最后更新item以删除孤儿终结器。如果这些步骤中的任何一个失败，则将节点添加回attemptToOrphan。</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>gc</span> <span class=o>*</span><span class=nx>GarbageCollector</span><span class=p>)</span> <span class=nf>attemptToOrphanWorker</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>item</span><span class=p>,</span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nx>attemptToOrphan</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>gc</span><span class=p>.</span><span class=nx>workerLock</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>gc</span><span class=p>.</span><span class=nx>workerLock</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>quit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>gc</span><span class=p>.</span><span class=nx>attemptToOrphan</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>owner</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>item</span><span class=p>.(</span><span class=o>*</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;expect *node, got %#v&#34;</span><span class=p>,</span> <span class=nx>item</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// we don&#39;t need to lock each element, because they never get updated</span>
</span></span><span class=line><span class=cl>	<span class=nx>owner</span><span class=p>.</span><span class=nx>dependentsLock</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>dependents</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>node</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>owner</span><span class=p>.</span><span class=nx>dependents</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>dependent</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>owner</span><span class=p>.</span><span class=nx>dependents</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>dependents</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>dependents</span><span class=p>,</span> <span class=nx>dependent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>owner</span><span class=p>.</span><span class=nx>dependentsLock</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 处理孤儿</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>orphanDependents</span><span class=p>(</span><span class=nx>owner</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=nx>dependents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;orphanDependents for %s failed with %v&#34;</span><span class=p>,</span> <span class=nx>owner</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>gc</span><span class=p>.</span><span class=nx>attemptToOrphan</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// update the owner, remove &#34;orphaningFinalizer&#34; from its finalizers list</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 移除item的orphan终结器</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>removeFinalizer</span><span class=p>(</span><span class=nx>owner</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>FinalizerOrphanDependents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;removeOrphanFinalizer for %s failed with %v&#34;</span><span class=p>,</span> <span class=nx>owner</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>gc</span><span class=p>.</span><span class=nx>attemptToOrphan</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>gc.orphanDependents(owner.identity, dependents)方法：遍历item的从资源，并发的执行patch请求，删除从资源中和item同uid的ownerReferences，将error加入到errCh channel中，最后给调用者返回error列表：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// dependents are copies of pointers to the owner&#39;s dependents, they don&#39;t need to be locked.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>gc</span> <span class=o>*</span><span class=nx>GarbageCollector</span><span class=p>)</span> <span class=nf>orphanDependents</span><span class=p>(</span><span class=nx>owner</span> <span class=nx>objectReference</span><span class=p>,</span> <span class=nx>dependents</span> <span class=p>[]</span><span class=o>*</span><span class=nx>node</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>errCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>error</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>dependents</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span> <span class=o>:=</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>dependents</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>dependents</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>dependent</span> <span class=o>*</span><span class=nx>node</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=c1>// the dependent.identity.UID is used as precondition</span>
</span></span><span class=line><span class=cl>			<span class=nx>patch</span> <span class=o>:=</span> <span class=nf>deleteOwnerRefStrategicMergePatch</span><span class=p>(</span><span class=nx>dependent</span><span class=p>.</span><span class=nx>identity</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>owner</span><span class=p>.</span><span class=nx>UID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>patch</span><span class=p>(</span><span class=nx>dependent</span><span class=p>,</span> <span class=nx>patch</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>node</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>gc</span><span class=p>.</span><span class=nf>deleteOwnerRefJSONMergePatch</span><span class=p>(</span><span class=nx>n</span><span class=p>,</span> <span class=nx>owner</span><span class=p>.</span><span class=nx>UID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=c1>// note that if the target ownerReference doesn&#39;t exist in the</span>
</span></span><span class=line><span class=cl>			<span class=c1>// dependent, strategic merge patch will NOT return an error.</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>errCh</span> <span class=o>&lt;-</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;orphaning %s failed, %v&#34;</span><span class=p>,</span> <span class=nx>dependent</span><span class=p>.</span><span class=nx>identity</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}(</span><span class=nx>dependents</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nb>close</span><span class=p>(</span><span class=nx>errCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>errorsSlice</span> <span class=p>[]</span><span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>errCh</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>errorsSlice</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>errorsSlice</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errorsSlice</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to orphan dependents of owner %s, got errors: %s&#34;</span><span class=p>,</span> <span class=nx>owner</span><span class=p>,</span> <span class=nx>utilerrors</span><span class=p>.</span><span class=nf>NewAggregate</span><span class=p>(</span><span class=nx>errorsSlice</span><span class=p>).</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;successfully updated all dependents of owner %s&#34;</span><span class=p>,</span> <span class=nx>owner</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>deleteOwnerRefStrategicMergePatch方法：拼接patch请求参数。该方法同样的，在处理attemptToDelete死循中，第一个switch case处被调用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>deleteOwnerRefStrategicMergePatch</span><span class=p>(</span><span class=nx>dependentUID</span> <span class=nx>types</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>ownerUIDs</span> <span class=o>...</span><span class=nx>types</span><span class=p>.</span><span class=nx>UID</span><span class=p>)</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>pieces</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>//拼接需要删除的uid</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ownerUID</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ownerUIDs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pieces</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>pieces</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`{&#34;$patch&#34;:&#34;delete&#34;,&#34;uid&#34;:&#34;%s&#34;}`</span><span class=p>,</span> <span class=nx>ownerUID</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>//拼接patch请求参数</span>
</span></span><span class=line><span class=cl>	<span class=nx>patch</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>`{&#34;metadata&#34;:{&#34;ownerReferences&#34;:[%s],&#34;uid&#34;:&#34;%s&#34;}}`</span><span class=p>,</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>pieces</span><span class=p>,</span> <span class=s>&#34;,&#34;</span><span class=p>),</span> <span class=nx>dependentUID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>patch</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">回到初衷<div id=回到初衷 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%9b%9e%e5%88%b0%e5%88%9d%e8%a1%b7 aria-label=锚点>#</a></span></h2><p>中间件redis容器化后，在测试环境上部署的redis集群，在kubernetes apiserver重启后，redis集群被异常删除（包括redis exporter statefulset、redis statefulset）。<br><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20191021154538243.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure></p><h3 class="relative group">原因定位<div id=原因定位 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8e%9f%e5%9b%a0%e5%ae%9a%e4%bd%8d aria-label=锚点>#</a></span></h3><p>在开发环境上经多次复现，apiserver重启后，通过查询redis operator日志，并没有发现主动去删除redis集群（redis statefulset）、监控实例（redis exporter）。进一步去查看kube-controller-manager的日志，将其日志级别设置&ndash;v=5，继续复现，最终在kube-controller-manager日志中发现如下日志：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20191021154548906.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure></p><p>可以看到，垃圾回收器garbage collector在处理redis exporter statefulset时，发现其加了ownerReferences，在exporter所在分区（monitoring）查询其owner——redisCluster对象redis-0826，而redisCluster对象redis-0826存在于kube-system分区，所以在monitoring分区查询到的是404 Not Found，garbage collector会将该owner不存在信息（uid）存入缓存absentOwnerCache。<br>因redis exporter statefulset的owner不存在，所以gc认为需要回收垃圾，故将其删除掉。同理，当处理redis statefulset时，从缓存中发现owner不存在，也会回收垃圾，将其删除掉。<br><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20191021154600217.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure></p><p>经过多次复现故障，发现重启kube-controller-manager时有概率复现。（Apiserver的重启时，kube-controller-manager在连接apiserver失败多次后，也会发生自重启），之所以是概率问题，这和garbage collector将资源对象加入attemptToDelete队列的顺序有关：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20191021154616873.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure></p><p>先同步monitoring分区的exporter statefulset，后同步kube-system分区的redis statefulset，就会出现该故障；反之就不会出现故障，这取决于garbage collector启动时全量获取集群内资源（listwatch）的顺序。<br>在apiserver和kube-controller-manager正常运行时不出现该故障，可以从garbage collector源码中看到以下代码逻辑：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20191021154641446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure><br><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20191021154650524.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure><br>Garbage collector中维护一个父子关系图表，controller-manager启动时该图里节点是不存在的，会走上图switch的第一个case，之后图形成之后，会走第二个case。第二个case里只有在owner发生变化时才会触发将资源对象加入attemptToDelete队列，所以在各个组件正常运行时没有出现该故障。</p><p>获取图表的接口地址，IP和端口都是controller-manager的，可以重定向到tmp.dot文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph?uid<span class=o>=</span>11211212edsaddkqedmk12
</span></span></code></pre></div><p>之后用可视化工具Graphviz软件，进入到bin目录下，执行以下命令生成svg文件，用浏览器打开，Graphviz和dot的使用可以自行谷歌。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>dot -Tsvg -o graph2.svg tmp.dot
</span></span></code></pre></div><p><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20191021154706864.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure><br><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20191021154726832.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure></p><h3 class="relative group">解决方法<div id=解决方法 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 aria-label=锚点>#</a></span></h3><p>在redis operator创建redis集群时，将exporter放到和redis同一分区。</p><h3 class="relative group">思考反思<div id=思考反思 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%80%9d%e8%80%83%e5%8f%8d%e6%80%9d aria-label=锚点>#</a></span></h3><p>1、出现该故障，主要是因进行了跨命名空间owner引用。在使用垃圾回收机制时，应该尽量参考kubernetes官方网站中的说明.<br>如下，官网中说明了owner引用在设计时就不允许跨namespace使用，这意味着：</p><p>1）命名空间范围的从属只能指定同一命名空间中的所有者，以及群集范围的所有者。</p><p>2）群集作用域的从属只能指定群集作用域的所有者，而不能指定命名空间作用域的所有者。<br><figure><img class="my-0 rounded-md" loading=lazy src="https://img-blog.csdnimg.cn/20191021154741284.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldA==,size_16,color_FFFFFF,t_70" alt=在这里插入图片描述></figure></p><h2 class="relative group">参考文档<div id=参考文档 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%82%e8%80%83%e6%96%87%e6%a1%a3 aria-label=锚点>#</a></span></h2><p>垃圾回收官方文档：</p><p><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2dhcmJhZ2UtY29sbGVjdGlvbi8%3d" target=_blank>https://kubernetes.io/docs/concepts/workloads/controllers/garbage-collection/</a></p><p>详解 Kubernetes 垃圾收集器的实现原理：</p><p><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9kcmF2ZW5lc3MubWUva3ViZXJuZXRlcy1nYXJiYWdlLWNvbGxlY3RvciM%3d" target=_blank>https://draveness.me/kubernetes-garbage-collector#</a></p><hr><p><strong>本公众号</strong>免费**提供csdn下载服务，海量IT学习资源，**如果你准备入IT坑，励志成为优秀的程序猿，那么这些资源很适合你，包括但不限于java、go、python、springcloud、elk、嵌入式 、大数据、面试资料、前端 等资源。同时我们组建了一个技术交流群，里面有很多大佬，会不定时分享技术文章，如果你想来一起学习提高，可以公众号后台回复【<strong>2</strong>】，免费邀请加技术交流群互相学习提高，会不定期分享编程IT相关资源。</p><hr><p>扫码关注，精彩内容第一时间推给你</p><p><figure><img class="my-0 rounded-md" loading=lazy src=https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLTYzZTRkMDc2OWM2MGUyODY alt=image></figure></p></div><div class="text-neutral-700 dark:text-neutral-300" style=text-align:center;font-size:16px;font-family:cursive>-------莫愁前路无知己
<span class="relative icon" style=display:inline-block><svg version="1.0" id="Layer_1" xmlns:xlink="http://www.w3.org/1999/xlink" width="800" height="800" viewBox="0 0 64 64" enable-background="new 0 0 64 64"><g><path fill="#394240" d="M35 4.145V3.002 3c0-1.656-1.343-3-3-3s-3 1.344-3 3v.002 1.143C12.734 5.658.0 19.338.0 36c0 0 0 1 1 1s1.867-1 1.867-1C4.68 34.15 7.204 33 10 33c4.1.0 7.618 2.469 9.162 6 0 0 .541 1 1.838 1s1.838-1 1.838-1c1.15-2.629 3.396-4.668 6.162-5.539V56c0 4.418 3.582 8 8 8s8-3.582 8-8c0-1.656-1.343-3-3-3s-3 1.344-3 3c0 1.104-.896 2-2 2s-2-.896-2-2V33.461c2.766.871 5.012 2.91 6.162 5.539.0.0.541 1 1.838 1s1.838-1 1.838-1c1.544-3.531 5.062-6 9.162-6 2.796.0 5.319 1.15 7.133 3 0 0 .867 1 1.867 1s1-1 1-1C64 19.338 51.266 5.658 35 4.145zM31 3c0-.553.447-1 1-1s1 .447 1 1v1.025C32.667 4.016 32.335 4 32 4s-.667.016-1 .025V3zM10 31c-3.047.0-5.816 1.145-7.928 3.018C3.006 19.729 13.94 8.17 27.947 6.277 22.911 14.678 20 24.492 20 35v1.387C17.853 33.145 14.181 31 10 31zM37 60c2.209.0 4-1.791 4-4 0-.553.447-1 1-1s1 .447 1 1c0 3.312-2.687 6-6 6s-6-2.688-6-6V33.055C31.329 33.023 31.662 33 32 33s.671.023 1 .055V56c0 2.209 1.791 4 4 4zM32 31c-4.181.0-7.853 2.145-10 5.387V35c0-10.662 3.113-20.588 8.449-28.959.5-.025 1.004-.039 1.511-.039h.08c.507.0 1.011.014 1.511.039C38.887 14.412 42 24.338 42 35v1.387C39.853 33.145 36.181 31 32 31zm22 0c-4.181.0-7.853 2.145-10 5.387V35c0-10.508-2.911-20.322-7.947-28.723C50.06 8.17 60.994 19.729 61.928 34.018 59.816 32.145 57.047 31 54 31z"/><path fill="#f9ebb2" d="M31 3c0-.553.447-1 1-1s1 .447 1 1v1.025C32.667 4.016 32.335 4 32 4s-.667.016-1 .025V3z"/><g><path fill="#45aab8" d="M2.072 34.018C4.184 32.145 6.953 31 10 31c4.181.0 7.853 2.145 10 5.387V35c0-10.508 2.911-20.322 7.947-28.723C13.94 8.17 3.006 19.729 2.072 34.018z"/><path fill="#45aab8" d="M36.053 6.277C41.089 14.678 44 24.492 44 35v1.387C46.147 33.145 49.819 31 54 31c3.047.0 5.816 1.145 7.928 3.018C60.994 19.729 50.06 8.17 36.053 6.277z"/></g><path fill="#b4ccb9" d="M32.04 6.002h-.08c-.507.0-1.011.014-1.511.039C25.113 14.412 22 24.338 22 35v1.387C24.147 33.145 27.819 31 32 31s7.853 2.145 10 5.387V35c0-10.662-3.113-20.588-8.449-28.959C33.051 6.016 32.547 6.002 32.04 6.002z"/><path fill="#f9ebb2" d="M37 60c2.209.0 4-1.791 4-4 0-.553.447-1 1-1s1 .447 1 1c0 3.312-2.687 6-6 6s-6-2.688-6-6V33.055C31.329 33.023 31.662 33 32 33s.671.023 1 .055V56c0 2.209 1.791 4 4 4z"/></g></svg>
</span>天下谁人不识君-------</div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/&amp;title=kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8GarbageCollector%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%89%ef%bc%89" title="分享到 LinkedIn" aria-label="分享到 LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/&amp;text=kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8GarbageCollector%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%89%ef%bc%89" title="分享到 Twitter" aria-label="分享到 Twitter"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/&amp;resubmit=true&amp;title=kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8GarbageCollector%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%89%ef%bc%89" title="提交到 Reddit" aria-label="提交到 Reddit"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://api.whatsapp.com/send?text=https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/&amp;resubmit=true&amp;title=kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8GarbageCollector%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%89%ef%bc%89" title="分享到 WhatsApp" aria-label="分享到 WhatsApp"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4.0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3.0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2.0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2.0-101.7 82.8-184.5 184.6-184.5 49.3.0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5.0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3.0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://t.me/share/url?url=https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/&amp;resubmit=true&amp;title=kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8GarbageCollector%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%89%ef%bc%89" title="分享到 Telegram" aria-label="分享到 Telegram"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://pinterest.com/pin/create/bookmarklet/?url=https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/&amp;description=kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8GarbageCollector%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%89%ef%bc%89" title="钉到 Pinterest" aria-label="钉到 Pinterest"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M496 256c0 137-111 248-248 248-25.6.0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8.0 128.7-68.8 128.7-154.3.0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1.0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6.0-54.7 41.4-107.6 112-107.6 60.9.0 103.6 41.5 103.6 100.9.0 67.1-33.9 113.6-78 113.6-24.3.0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6.0-19-10.2-34.9-31.4-34.9-24.9.0-44.9 25.7-44.9 60.2.0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9.0 361.1.0 256 0 119 111 8 248 8s248 111 248 248z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/&amp;quote=kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8GarbageCollector%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%89%ef%bc%89" title="分享到 Facebook" aria-label="分享到 Facebook"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://kubeinfo.cn/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/&amp;subject=kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8GarbageCollector%20%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%ef%bc%88%e4%b8%89%ef%bc%89" title=通过电子邮件发送 aria-label=通过电子邮件发送><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section><h2 class="mt-8 text-2xl font-extrabold mb-10">相关文章</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><a href=/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%8E%A7%E5%88%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%BA%8C/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%8E%A7%E5%88%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%BA%8C/>kubernetes垃圾回收器GarbageCollector控制器源码分析（二）</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-16T23:29:12+00:00>2019年10月16日</time><span class="px-2 text-primary-500">&#183;</span><span>5313 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>11 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/kubernetes%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/kubernetes%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/>kubernetes自定义资源对象高级功能</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-18T13:33:34+00:00>2019年10月18日</time><span class="px-2 text-primary-500">&#183;</span><span>5617 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>12 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8k8s%E5%BF%85%E5%AD%A6%E5%BF%85%E4%BC%9A%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8k8s%E5%BF%85%E5%AD%A6%E5%BF%85%E4%BC%9A%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/>史上最全k8s必学必会知识梳理</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-18T13:32:28+00:00>2019年10月18日</time><span class="px-2 text-primary-500">&#183;</span><span>10815 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>22 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/kubescheduler%E8%B0%83%E5%BA%A6%E6%89%A9%E5%B1%95/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/kubescheduler%E8%B0%83%E5%BA%A6%E6%89%A9%E5%B1%95/>kube-scheduler调度扩展</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-18T13:31:42+00:00>2019年10月18日</time><span class="px-2 text-primary-500">&#183;</span><span>2513 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>6 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/>开发一个operator扩展kubernetes的能力</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-18T13:31:08+00:00>2019年10月18日</time><span class="px-2 text-primary-500">&#183;</span><span>9096 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>19 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/kubernetespodexec%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/kubernetespodexec%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8/>kubernetes pod exec接口调用</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-18T13:30:04+00:00>2019年10月18日</time><span class="px-2 text-primary-500">&#183;</span><span>2208 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>5 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a></section></div><script>var oid="views_posts/kubernetes垃圾回收器GarbageCollector源码分析三.md",oid_likes="likes_posts/kubernetes垃圾回收器GarbageCollector源码分析三.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/github%E6%80%8E%E4%B9%88%E7%BB%91%E5%AE%9A%E8%87%AA%E5%B7%B1%E7%9A%84%E5%9F%9F%E5%90%8D%E4%BB%A5%E5%8F%8A%E6%80%8E%E4%B9%88%E6%94%AF%E6%8C%81https/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">github怎么绑定自己的域名？以及怎么支持https？</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2019-10-20T21:49:14+00:00>2019年10月20日</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">kubernetes垃圾回收器GarbageCollector源码分析</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2019-10-22T10:57:26+00:00>2019年10月22日</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script type=text/javascript>var lazyadsense=!1;window.addEventListener("scroll",function(){(0!=document.documentElement.scrollTop&&!1===lazyadsense||0!=document.body.scrollTop&&!1===lazyadsense)&&(!function(){var t,e=document.createElement("script");e.id="g_ads_js",e.type="text/javascript",e.async="async",e.src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3925981084585036",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}(),lazyadsense=!0)},!0)</script><script>(adsbygoogle=window.adsbygoogle||[]).onload=function(){[].forEach.call(document.getElementsByClassName("adsbygoogle"),function(){adsbygoogle.push({})})}</script><div style="min-height=250px"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-3925981084585036 data-ad-slot=4806125422 data-ad-format=auto data-full-width-responsive=true></ins></div><img style=margin-top:1.5em loading=lazy src=/img/wechat-official-account.jpg alt=公众号二维码><div style=margin-top:1.5em id=comment></div><script defer>const getStoredTheme=()=>(localStorage.getItem("appearance")||"dark")==="dark"?"https://cdn.jsdelivr.net/gh/yangchuansheng/comments@main/dark.css":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})},loadGiscusWhenNearViewport=()=>{const e=document.getElementById("comment"),t=new IntersectionObserver(n=>{n.forEach(n=>{if(n.isIntersecting){const o={src:"https://giscus.app/client.js","data-repo":"smallersoup/blog","data-repo-id":"R_kgDOO8mliQ","data-category":"Announcements","data-category-id":"DIC_kwDOO8mlic4Cr_a8","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"en","data-loading":"lazy",crossorigin:"anonymous",async:""},n=document.createElement("script");Object.entries(o).forEach(([e,t])=>n.setAttribute(e,t)),e.appendChild(n);const s=document.getElementById("appearance-switcher");s&&s.addEventListener("click",setGiscusTheme),t.unobserve(e)}})},{threshold:.1});t.observe(e)};document.addEventListener("DOMContentLoaded",loadGiscusWhenNearViewport)</script></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden" style=margin-inline:auto;text-align:center><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/tags/ title=Tags>标签</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/categories/ title=Categories>分类</a></li></ul></nav><div class="flex items-center justify-between"></div><script type=text/javascript src=/lib/zoom/zoom.min.min.9727c53d7324a2d82edc7b1192627812e49f1352d0d1f81ca140754cd7b8081a123c5f0924c0c5e2860baa5dd7df12c7283877bbba916620bb07c12401a7c281.js integrity="sha512-lyfFPXMkotgu3HsRkmJ4EuSfE1LQ0fgcoUB1TNe4CBoSPF8JJMDF4oYLql3X3xLHKDh3u7qRZiC7B8EkAafCgQ=="></script><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script><div class=busuanzi style=margin-inline:auto;text-align:center><div class=busuanzi__item><span class="busuanzi__item--label text-neutral-500 dark:text-neutral-400">总访客</span>
<span id=busuanzi_site_uv class="busuanzi__item--number text-neutral-500 dark:text-neutral-400"></span></div><div class=busuanzi__item><span class="busuanzi__item--label text-neutral-500 dark:text-neutral-400">总浏览量</span>
<span id=busuanzi_site_pv class="busuanzi__item--number text-neutral-500 dark:text-neutral-400"></span></div></div><p class="text-sm text-neutral-500 dark:text-neutral-400" style=margin-inline:auto;text-align:center>&copy; 2025 小碗汤<br>本站内容依据
<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh target=_blank>CC BY-SA 4.0</a>
许可证进行授权，转载请附上出处链接。</p><div class=github-badge><span class=badge-subject>构建工具</span><span class="badge-value bg-blue"><a style=color:#fff href=https://gohugo.io/ target=_blank>Hugo v0.144.0</a></span>
<span class=badge-subject>托管于</span><span class="badge-value bg-brightgreen"><a style=color:#fff href=https://github.com/smallersoup/blog target=_blank>Github</a></span>
<span class=badge-subject>图床</span><span class="badge-value bg-orange"><a style=color:#fff href=https://www.jsdelivr.com/ target=_blank>jsDelivr</a></span>
<span class=badge-subject>主题</span><span class="badge-value bg-blue"><a style=color:#fff href=https://github.com/nunocoracao/blowfish target=_blank>Blowfish</a></span></div><section class="text-sm text-neutral-500 dark:text-neutral-400"><span id=span_dt_dt></span><script defer language=javascript>var uptime_1="本站已经开心运行 ",uptime_2=" 天 ",uptime_3=" 小时 ",uptime_4=" 分 ",uptime_5=" 秒";function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("10/30/2020 21:30:15"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=24*60*60*1e3,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=(e_daysold-daysold)*24,hrsold=Math.floor(e_hrsold),e_minsold=(e_hrsold-hrsold)*60,minsold=Math.floor((e_hrsold-hrsold)*60),seconds=Math.floor((e_minsold-minsold)*60),span_dt_dt.innerHTML=uptime_1+daysold+uptime_2+hrsold+uptime_3+minsold+uptime_4+seconds+uptime_5}show_date_time()</script></section><style>.wxtip{background:rgba(0,0,0,.8);text-align:center;position:fixed;left:0;top:0;width:100%;height:100%;z-index:998;display:none}.wxtip-icon{width:52px;height:67px;background:url(img/weixin-tip.png)no-repeat;display:block;position:absolute;right:20px;top:20px}.wxtip-txt{margin-top:107px;color:#fff;font-size:16px;line-height:1.5}</style><div class=wxtip id=JweixinTip><span class=wxtip-icon></span><p class=wxtip-txt>点击屏幕右上角的 ···<br>在弹出的窗口中选择 <span style=color:red>在浏览器中打开</span></p><br><br><p><img loading=lazy style=width:85%;border-radius:10px;display:block;margin-left:auto;margin-right:auto src=/img/wechat-browser.jpg></p></div><script defer>is_weixn_qq()&&(document.getElementById("JweixinTip").style.display="block",document.getElementById("container").style.display="none",document.getElementById("top-grrk").style.display="none");function is_weixn_qq(){var e=navigator.userAgent,t=!!/MicroMessenger/i.test(e),n=!!/QQ\//i.test(e);return!!(t||n)}</script><script defer src=https://wvprxbiaqrgp.hzh.sealos.run/js></script><script>document.addEventListener("DOMContentLoaded",function(){const s=document.getElementById("busuanzi_site_uv"),o=document.getElementById("busuanzi_site_pv"),e=new MutationObserver(t=>{for(let n of t)if(n.type==="childList"){e.disconnect(),n.target.innerHTML=parseInt(n.target.innerHTML)+731632;break}}),t=new MutationObserver(e=>{for(let n of e)if(n.type==="childList"){t.disconnect(),n.target.innerHTML=parseInt(n.target.innerHTML)+1360325;break}}),n={childList:!0};e.observe(s,n),t.observe(o,n)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{var n=["Docker","Containerd","Podman","Kubernetes","KubeEdge","Prometheus","KubeSphere","FastGPT","Envoy","eBPF","KubeNative","Webassembly","WireGuard","Tailscale","Cloud Native"],t=0;document.body.addEventListener("click",function(e){var s,o,i,a,r,l=n[t];t=(t+1)%n.length,s=document.createElement("span"),s.textContent=l,s.style.cssText=`
            z-index: 9999;
            top: ${e.pageY-20}px;
            left: ${e.pageX}px;
            position: absolute;
            font-weight: bold;
            color: ${randomColor()};
            opacity: 1;
            transition: opacity 1.5s;
        `,document.body.appendChild(s),o=null,a=1500,i=e.pageY-20,r=i-160;function c(e){o===null&&(o=e);var t=(e-o)/a;t<1?(s.style.top=i-t*(i-r)+"px",requestAnimationFrame(c)):s.remove()}requestAnimationFrame(c)})});function randomColor(){var e=["#FFDA65","#00BFFF","#cb80ff","#acc2ef","#87CEEB","#FFB6C1"];return e[Math.floor(Math.random()*e.length)]}</script><script>document.addEventListener("DOMContentLoaded",function(){var e=function(e,t){e.forEach(function(e){if(e.isIntersecting){var n=e.target,s=n.getAttribute("data-bg");n.style.backgroundImage="url('"+s+"')",t.unobserve(e.target)}})},t=new IntersectionObserver(e),n=document.querySelectorAll(".thumbnail_card_related, .thumbnail_card");n.forEach(function(e){t.observe(e)})})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://kubeinfo.cn/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>