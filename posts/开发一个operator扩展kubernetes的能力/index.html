<!doctype html><html lang=zh-cn dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>开发一个operator扩展kubernetes的能力 &#183; 进击云原生</title>
<meta name=title content="开发一个operator扩展kubernetes的能力 &#183; 进击云原生"><meta name=description content="进击云原生：深入探索容器技术、Kubernetes、Istio、DevOps 实践、Prometheus 监控、Envoy、Golang 开发以及云原生架构和微服务趋势的专业博客。"><meta name=keywords content="kubernetes,"><link rel=canonical href=https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/><link type=text/css rel=stylesheet href=/css/main.bundle.min.6a1934f2549fc14526ee16bc5d171958bd1a92bf5b90a39e40384dcf517f8ec1c46ca48a25a00b47ff5c55d3bc5fb768d894cfc3cf8baaf45abeb61062f6927c.css integrity="sha512-ahk08lSfwUUm7ha8XRcZWL0akr9bkKOeQDhNz1F/jsHEbKSKJaALR/9cVdO8X7do2JTPw8+LqvRavrYQYvaSfA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.d9be7b9a4d8135f07bbbd18681ad970838d3bc8e366bfadc94c08c8a1dc440d95af2bd614a24366316f31d41518822a52ce8f464ed829ae27497b2241ab2cae5.js integrity="sha512-2b57mk2BNfB7u9GGga2XCDjTvI42a/rclMCMih3EQNla8r1hSiQ2YxbzHUFRiCKlLOj0ZO2CmuJ0l7IkGrLK5Q==" data-copy=复制 data-copied=复制成功！></script><script src=/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/"><meta property="og:site_name" content="进击云原生"><meta property="og:title" content="开发一个operator扩展kubernetes的能力"><meta property="og:description" content="正文 # Operator 是 CoreOS 推出的旨在简化复杂有状态应用管理，它是一个感知应用状态的控制器，通过扩展 Kubernetes API 来自动创建、管理和配置应用实例。 Operator 基于 CRD 扩展资源对象，并通过控制器来保证应用处于预期状态。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-18T13:31:08+00:00"><meta property="article:modified_time" content="2019-10-18T13:31:08+00:00"><meta property="article:tag" content="Kubernetes"><meta name=twitter:card content="summary"><meta name=twitter:title content="开发一个operator扩展kubernetes的能力"><meta name=twitter:description content="正文 # Operator 是 CoreOS 推出的旨在简化复杂有状态应用管理，它是一个感知应用状态的控制器，通过扩展 Kubernetes API 来自动创建、管理和配置应用实例。 Operator 基于 CRD 扩展资源对象，并通过控制器来保证应用处于预期状态。"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"开发一个operator扩展kubernetes的能力","headline":"开发一个operator扩展kubernetes的能力","abstract":"\u003ch2 class=\u0022relative group\u0022\u003e正文 \n    \u003cdiv id=\u0022正文\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\u0022\u003e\n        \u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022\n            style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#%e6%ad%a3%e6%96%87\u0022 aria-label=\u0022锚点\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e        \n    \n\u003c\/h2\u003e\n\u003cp\u003eOperator 是 CoreOS 推出的旨在简化复杂有状态应用管理，它是一个感知应用状态的控制器，通过扩展 Kubernetes API 来自动创建、管理和配置应用实例。 Operator 基于 CRD 扩展资源对象，并通过控制器来保证应用处于预期状态。\u003c\/p\u003e","inLanguage":"zh-cn","url":"https:\/\/kubeinfo.cn\/posts\/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B\/","author":{"@type":"Person","name":"小碗汤"},"copyrightYear":"2019","dateCreated":"2019-10-18T13:31:08\u002b00:00","datePublished":"2019-10-18T13:31:08\u002b00:00","dateModified":"2019-10-18T13:31:08\u002b00:00","keywords":["kubernetes"],"mainEntityOfPage":"true","wordCount":"9096"}]</script><meta name=author content="小碗汤"><link href=/index.xml rel=me><link href=https://images.kubeinfo.cn/uPic/tmpm1ykjt96.webp rel=me><link href=https://github.com/smallersoup rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script data-id=umami-script async src=https://analytics.umami.is/script.js data-website-id=f5c28d4b-4ab0-4edc-be58-1ecbe88bfbf5></script><script type=text/javascript>document.querySelector('script[data-id="umami-script"]').addEventListener("load",function(){const e=document.head.querySelector('meta[property = "og:type"]').getAttribute("content");let t=document.head.querySelector('meta[property = "og:title"]').getAttribute("content"),n=document.head.querySelector('meta[property = "og:url"]').getAttribute("content");umami.track(e+":"+t,{url:n})})</script><script>document.addEventListener("DOMContentLoaded",function(){var e=document.createElement("link");e.href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css",e.rel="stylesheet",document.head.appendChild(e)})</script><div id=fps style=z-index:999;position:fixed;bottom:3px;right:3px;color:#fff;font-size:10px></div><script defer type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/layer/3.5.1/layer.min.js></script><script defer type=text/javascript src=https://kubeinfo.cn/js/fps.js></script><script defer>window.addEventListener("scroll",function e(){window.scrollY>100&&(function(e,t,n,s){if(typeof e.webpushr!="undefined")return;e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var i=t.getElementsByTagName(n)[0],o=t.createElement(n);o.id=s,o.async=1,o.src="https://cdn.webpushr.com/app.min.js",i.parentNode.appendChild(o)}(window,document,"script","webpushr-jssdk"),webpushr("setup",{key:"BPaSgcviMxfkNlELfboefkjPEigiszIStgrZEfmp4nsCSXMzLpCphJai8hTOl1o0_yg8u6-SxNz98pdSGro05C4"}),window.removeEventListener("scroll",e))})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{const t="https://htr4n1.laf.run/baidu-seo?urls="+window.location.href;fetch(t).then(e=>e.json()).then(e=>{const t=JSON.parse(e.body);t.remain>0&&t.success===1?console.log("百度收录提交成功，当前api余剩次数："+t.remain):(t.remain===0?console.log("已达到今日百度提交上限。"):(console.log(t.remain),console.log("api提交失败")),t.not_same_site&&console.log("未收录的站点：",t.not_same_site.join(", ")))}).catch(e=>{console.error("请求失败，但这可能是因为达到提交上限:",e)})})</script><script defer>function loadScriptOnScroll(){var e,t,n,s=window.scrollY||window.pageYOffset;s>100&&(n=n||[],e=document.createElement("script"),e.src="https://hm.baidu.com/hm.js?efe96f04908ae320df234a4f5626879e",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t),window.removeEventListener("scroll",loadScriptOnScroll))}window.addEventListener("scroll",loadScriptOnScroll)</script><script defer>function loadAnalyticsScript(){var e=document.createElement("script");e.async=!0,e.src="https://ga.kubeinfo.cn/gtag/js?id=G-0VHVXWXJMQ",document.head.appendChild(e),window.dataLayer=window.dataLayer||[];function t(){dataLayer.push(arguments)}t("js",new Date),t("config","G-0VHVXWXJMQ"),window.removeEventListener("scroll",onScrollLoadAnalytics)}function onScrollLoadAnalytics(){window.scrollY>100&&loadAnalyticsScript()}window.addEventListener("scroll",onScrollLoadAnalytics)</script><script defer>function loadClarityScript(){(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","m535olg9md"),window.removeEventListener("scroll",onScrollLoadClarity)}function onScrollLoadClarity(){window.scrollY>100&&loadClarityScript()}window.addEventListener("scroll",onScrollLoadClarity)</script><div class=top-scroll-bar style=height:5px;background-color:blue;width:0;position:fixed;top:0;z-index:100></div><script type=text/javascript>$(document).ready(function(){$(window).scroll(function(){$(".top-scroll-bar").attr("style","width: "+$(this).scrollTop()/($(document).height()-$(this).height())*100+"%; display: block;")})})</script><script src=https://cdn.jsdelivr.net/gh/instantpage/instant.page@master/instantpage.js type=module></script><script type=text/javascript>var titleTime,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="老板别走吖 Σ(っ °Д °;)っ",clearTimeout(titleTime)):(document.title="老板您可算回来了 (｡•ˇ‸ˇ•｡)"+OriginTitile,titleTime=setTimeout(function(){document.title=OriginTitile},2e3))})</script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>跳过正文</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><img src=/img/logo.jpeg width=443 height=443 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=进击云原生></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900"><h6 style=font-size:1.5rem><span style=color:#abd123>>$</span>&nbsp;cd /home/<span class=logo_cursor></span></h6></a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href="https://cloud.umami.is/share/h5GReomkOf4fsBGd/kubeinfo.cn?theme=dark" target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span><p class="text-base font-medium" title>实时访客</p></a><div><div class="cursor-pointer flex items-center nested-menu"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg>
</span></span><a class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title>百宝箱
</a><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=https://upptime.kubeinfo.cn/ target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M228.3 469.1 47.6 300.4c-4.2-3.9-8.2-8.1-11.9-12.4h87c22.6.0 43-13.6 51.7-34.5l10.5-25.2 49.3 109.5c3.8 8.5 12.1 14 21.4 14.1s17.8-5 22-13.3L320 253.7l1.7 3.4c9.5 19 28.9 31 50.1 31H476.3c-3.7 4.3-7.7 8.5-11.9 12.4L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9s-20.2-3.9-27.7-10.9zM503.7 240h-132c-3 0-5.8-1.7-7.2-4.4l-23.2-46.3c-4.1-8.1-12.4-13.3-21.5-13.3s-17.4 5.1-21.5 13.3l-41.4 82.8-51-113.9c-3.9-8.7-12.7-14.3-22.2-14.1s-18.1 5.9-21.8 14.8l-31.8 76.3c-1.2 3-4.2 4.9-7.4 4.9H16c-2.6.0-5 .4-7.3 1.1-5.7-16-8.7-33-8.7-50.3v-5.8c0-69.9 50.5-129.5 119.4-141C165 36.5 211.4 51.4 244 84l12 12 12-12c32.6-32.6 79-47.5 124.6-39.9C461.5 55.6 512 115.2 512 185.1v5.8c0 16.9-2.8 33.5-8.3 49.1z"/></svg></span></span><p class="text-sm font-sm" title>服务监控</p></a><a href=/jstc/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M0 96C0 60.7 28.7 32 64 32H448c35.3.0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3.0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4S78.8 416 88 416h96 32H424c8.9.0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192c26.5.0 48-21.5 48-48s-21.5-48-48-48-48 21.5-48 48 21.5 48 48 48z"/></svg></span></span><p class="text-sm font-sm" title>趣味截图</p></a></div></div></div></div><a href=/index.xml class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></span><p class="text-base font-medium" title=rss></p></a><a href=https://github.com/smallersoup target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><p class="text-base font-medium" title=github></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400" style=margin-right:5px><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href="https://cloud.umami.is/share/h5GReomkOf4fsBGd/kubeinfo.cn?theme=dark" target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></div><p class="text-bg font-bg" title>实时访客</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg></span></span><p class="text-bg font-bg" title>百宝箱</p><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></a></li><li class=mt-1><a href=https://upptime.kubeinfo.cn/ target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M228.3 469.1 47.6 300.4c-4.2-3.9-8.2-8.1-11.9-12.4h87c22.6.0 43-13.6 51.7-34.5l10.5-25.2 49.3 109.5c3.8 8.5 12.1 14 21.4 14.1s17.8-5 22-13.3L320 253.7l1.7 3.4c9.5 19 28.9 31 50.1 31H476.3c-3.7 4.3-7.7 8.5-11.9 12.4L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9s-20.2-3.9-27.7-10.9zM503.7 240h-132c-3 0-5.8-1.7-7.2-4.4l-23.2-46.3c-4.1-8.1-12.4-13.3-21.5-13.3s-17.4 5.1-21.5 13.3l-41.4 82.8-51-113.9c-3.9-8.7-12.7-14.3-22.2-14.1s-18.1 5.9-21.8 14.8l-31.8 76.3c-1.2 3-4.2 4.9-7.4 4.9H16c-2.6.0-5 .4-7.3 1.1-5.7-16-8.7-33-8.7-50.3v-5.8c0-69.9 50.5-129.5 119.4-141C165 36.5 211.4 51.4 244 84l12 12 12-12c32.6-32.6 79-47.5 124.6-39.9C461.5 55.6 512 115.2 512 185.1v5.8c0 16.9-2.8 33.5-8.3 49.1z"/></svg></span></span><p class="text-sm font-small" title>服务监控</p></a></li><li class=mt-1><a href=/jstc/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M0 96C0 60.7 28.7 32 64 32H448c35.3.0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3.0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4S78.8 416 88 416h96 32H424c8.9.0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192c26.5.0 48-21.5 48-48s-21.5-48-48-48-48 21.5-48 48 21.5 48 48 48z"/></svg></span></span><p class="text-sm font-small" title>趣味截图</p></a></li><li class=mb-2></li><li class=mt-1><a href=/index.xml class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></div><p class="text-bg font-bg" title=rss></p></a></li><li class=mt-1><a href=https://github.com/smallersoup target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></div><p class="text-bg font-bg" title=github></p></a></li></ul></div></label></div></div><script>(function(){var e=$(".main-menu"),t=window.location.pathname;e.find('a[href="'+t+'"]').each(function(e,t){$(t).children("p").addClass("active")})})()</script></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><figure><img class="w-full rounded-lg single_hero_round nozoom" alt=开发一个operator扩展kubernetes的能力 width=1200 height=800 src=/img/ocean_hu_f78b3c25ca3bb793.jpg></figure><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>进击云原生</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/>开发一个operator扩展kubernetes的能力</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">开发一个operator扩展kubernetes的能力</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-18T13:31:08+00:00>2019年10月18日</time><span class="px-2 text-primary-500">&#183;</span><span>9096 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>19 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/smallersoup/blog/tree/main/content/zh-cn/posts/%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aaoperator%e6%89%a9%e5%b1%95kubernetes%e7%9a%84%e8%83%bd%e5%8a%9b.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title=编辑内容><span class="inline-block align-text-bottom"><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentcolor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg>
</span></span></a></span><span class="px-2 text-primary-500">&#183;</span>
<script type=text/javascript src=/js/zen-mode.min.2a0a1375509c03daf41c53a9831aa2d560895b7a2528c3eb3b56e7b11a135c7529e49727162a053b6193be8340270a8342f42c69f3d7e262ae54bc248eaac8f5.js integrity="sha512-KgoTdVCcA9r0HFOpgxqi1WCJW3olKMPrO1bnsRoTXHUp5JcnFioFO2GTvoNAJwqDQvQsafPX4mKuVLwkjqrI9Q=="></script><span class=mb-[2px]><span id=zen-mode-button class="text-lg hover:text-primary-500" title=启用极简模式 data-title-i18n-disable=启用极简模式 data-title-i18n-enable=关闭极简模式><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentcolor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt=小碗汤 src=/img/avatar_hu_2fef7e4e758589d5.jpeg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">小碗汤</div><div class="text-sm text-neutral-700 dark:text-neutral-400">云原生搬砖师</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=/index.xml target=_blank aria-label=Rss rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://images.kubeinfo.cn/uPic/tmpm1ykjt96.webp target=_blank aria-label=Wechat rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg width="800" height="800" viewBox="0 0 24 24" fill="none"><path d="M11.8088 7.05902C11.3508 7.06746 10.9637 7.45766 10.9718 7.90277 10.9802 8.36421 11.3599 8.7252 11.8309 8.7196 12.3031 8.71385 12.6613 8.3491 12.6568 7.87785 12.6529 7.41534 12.2749 7.05051 11.8088 7.05902zm-4.45801.85655C7.36789 7.47215 6.98366 7.07275 6.52729 7.05933 6.06002 7.04561 5.67572 7.40269 5.66207 7.8632 5.64827 8.32985 6.0052 8.70373 6.47584 8.71569 6.94241 8.72757 7.33354 8.36996 7.35079 7.91557zm8.54451.75542C14.0388 8.76798 12.4244 9.33078 11.1137 10.6023c-1.3243 1.2847-1.92882 2.8588-1.76358 4.8103C8.62446 15.3226 7.96351 15.2237 7.2988 15.1678 7.06924 15.1484 6.7968 15.1759 6.60235 15.2856 5.95689 15.6498 5.33812 16.061 4.60471 16.5195 4.73928 15.9108 4.82638 15.3778 4.98058 14.8652 5.09398 14.4884 5.04146 14.2788 4.69434 14.0333c-2.22866-1.5734-3.1681-3.9282-2.46505-6.35259.65044-2.24277 2.24776-3.60293 4.41815-4.31196C9.60982 2.4011 12.939 3.38815 14.7404 5.74012 15.391 6.58969 15.7899 7.54323 15.8953 8.67099z" fill="currentcolor"/><path d="M17.6884 12.3843C17.3253 12.3818 17.0167 12.6791 17.0019 13.046 16.9861 13.4383 17.2912 13.7605 17.6794 13.7615 18.055 13.7627 18.3517 13.4787 18.3655 13.105 18.38 12.7117 18.0749 12.387 17.6884 12.3843zm-4.3139 1.3819C13.7489 13.7666 14.057 13.4737 14.0711 13.1041 14.0861 12.7127 13.7713 12.3845 13.3795 12.3828 12.9915 12.381 12.6664 12.714 12.6799 13.0994 12.6927 13.4678 13.003 13.7658 13.3745 13.7662zm6.6919 6.479C19.4785 19.9835 18.9392 19.5907 18.3652 19.5308 17.7932 19.471 17.1919 19.801 16.5936 19.8622 14.771 20.0486 13.138 19.5407 11.7916 18.2956 9.23081 15.927 9.59671 12.2954 12.5594 10.3543c2.6331-1.72503 6.4948-1.14995 8.3513 1.2437C22.5307 13.6866 22.3403 16.4592 20.3626 18.2139 19.7903 18.7217 19.5843 19.1397 19.9515 19.809 20.0193 19.9326 20.027 20.0891 20.0664 20.2452z" fill="currentcolor"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/smallersoup target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#正文>正文</a></li><li><a href=#为什么使用crd>为什么使用crd</a></li><li><a href=#operator设计初衷>operator设计初衷</a></li><li><a href=#首先准备>首先准备</a></li><li><a href=#代码生成>代码生成</a></li><li><a href=#operator主流程代码开发>operator主流程代码开发</a></li><li><a href=#开发注意事项>开发注意事项</a></li><li><a href=#调试>调试</a></li><li><a href=#镜像制作>镜像制作</a><ul><li><ul><li><a href=#编译前提>编译前提</a></li><li><a href=#编译二进制>编译二进制</a></li><li><a href=#镜像制作-1>镜像制作</a></li></ul></li></ul></li><li><a href=#operator高可用>operator高可用</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#正文>正文</a></li><li><a href=#为什么使用crd>为什么使用crd</a></li><li><a href=#operator设计初衷>operator设计初衷</a></li><li><a href=#首先准备>首先准备</a></li><li><a href=#代码生成>代码生成</a></li><li><a href=#operator主流程代码开发>operator主流程代码开发</a></li><li><a href=#开发注意事项>开发注意事项</a></li><li><a href=#调试>调试</a></li><li><a href=#镜像制作>镜像制作</a><ul><li><ul><li><a href=#编译前提>编译前提</a></li><li><a href=#编译二进制>编译二进制</a></li><li><a href=#镜像制作-1>镜像制作</a></li></ul></li></ul></li><li><a href=#operator高可用>operator高可用</a></li></ul></nav></div></details><script>(function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var s,o=t.scrollTop(),i=$(".anchor"),n="";if(i.each(function(e,t){t=$(t),t.offset().top-$(window).height()/3<=o&&(n=decodeURIComponent(t.attr("id")))}),s=e.find("a.active"),s.length==1&&s.eq(0).attr("href")=="#"+n)return!0;s.each(function(e,t){$(t).removeClass("active")}),e.find('a[href="#'+n+'"]').addClass("active"),e.find('a[href="#'+n+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").parents("ul").show()})}t.on("scroll",n),$(document).ready(function(){n()})}})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h2 class="relative group">正文<div id=正文 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%ad%a3%e6%96%87 aria-label=锚点>#</a></span></h2><p>Operator 是 CoreOS 推出的旨在简化复杂有状态应用管理，它是一个感知应用状态的控制器，通过扩展 Kubernetes API 来自动创建、管理和配置应用实例。 Operator 基于 CRD 扩展资源对象，并通过控制器来保证应用处于预期状态。</p><ul><li>通过 Kubernetes API 观察集群的当前状态；</li><li>分析当前状态与期望状态的差别；</li><li>调用k8s API消除这些差别。</li></ul><h2 class="relative group">为什么使用crd<div id=为什么使用crd class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%bd%bf%e7%94%a8crd aria-label=锚点>#</a></span></h2><p>Kubernetes 目前已经成为了集群调度领域最炙手可热的开源项目之一 。其内置的 controller一般可以满足大多数使用场景，但对于很多定制化需求，其表达能力还是有限的。因此 Kubernetes 支持 Custom Resource Definition，也就是我们一直提到的 CRD。通过这一特性，用户可以自己定义资源类型，Kubernetes 会将其视为资源的一种，对其提供像内置资源对象一样的支持，这样的实现更加原生。CRD可以大大提高 Kubernetes 的扩展能力 ，以更原生的方式实现定制化要求。</p><h2 class="relative group">operator设计初衷<div id=operator设计初衷 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#operator%e8%ae%be%e8%ae%a1%e5%88%9d%e8%a1%b7 aria-label=锚点>#</a></span></h2><p>我们在管理应用时，会遇到无状态和有状态的应用。管理无状态的应用是相对来说比较简单的，但是有状态的应用则比较复杂。Operator 的设计旨在简化复杂有状态应用管理，其通过CRD扩展 Kubernetes API 来自动创建、管理和配置应用实例。其本质上是针对特定的场景去做有状态服务，或者说针对复杂应用场景去简化其运维管理的工具。</p><p>Operator以deployment的形式部署到K8S中。部署完这个Operator之后，想要部署一个集群，其实很方便。因为不需要再去管理这个集群的配置信息了，只需要创建一个CRD，指定创建多少个节点，需要什么版本，Operator会监听该资源对象，创建出符合配置要求的集群，从而大大简化运维的难度和成本。</p><p><strong>开发不同中间件operator流程大体相同，下面以redis operator进行说明：</strong></p><h2 class="relative group">首先准备<div id=首先准备 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%a6%96%e5%85%88%e5%87%86%e5%a4%87 aria-label=锚点>#</a></span></h2><ul><li>需要一个资源对象定义（CRD）yaml，operator代码中会根据该yaml去组装并创建CRD。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apiextensions.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CustomResourceDefinition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redisclusters.redis.middleware.hc.cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>redis.middleware.hc.cn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scope</span><span class=p>:</span><span class=w> </span><span class=l>Namespaced</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>names</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RedisCluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>singular</span><span class=p>:</span><span class=w> </span><span class=l>rediscluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>listKind</span><span class=p>:</span><span class=w> </span><span class=l>RedisClusterList</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>plural</span><span class=p>:</span><span class=w> </span><span class=l>redisclusters</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shortNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>rec</span><span class=w>
</span></span></span></code></pre></div><p>后面创建的该CRD类型的资源对象（CR），其kind为该yaml描述中spec.names.kind的值。CR相当于CRD的具体实现。（不同的operator，CRD、CR定义不同）；</p><ul><li>准备一个CR yaml文件，后面operator代码要根据该yaml结构在types.go中定义结构体。redis的CR yaml如下。operator最终会监听该CR，解析里面定义的节点数、版本号等参数，驱动做一些事情。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>redis.middleware.hc.cn/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RedisCluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example000-redis-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 代表redis集群的个数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 代表是否进入维修状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pause</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 是否删除crd以及redis集群</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>finalizers</span><span class=p>:</span><span class=w> </span><span class=l>foreground</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 镜像地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>library/redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 镜像版本，便于后续多版本特化支持</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>3.2.8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#redis集群升级策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>updateStrategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 升级类型为AutoReceive（自动分配,不用AssignStrategies）, AssignReceive（指定值分配，需要用AssignStrategies）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>AssignReceive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pipeline</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;100&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>assignStrategies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span>- <span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slots</span><span class=p>:</span><span class=w> </span><span class=m>2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fromReplicas</span><span class=p>:</span><span class=w> </span><span class=l>nodeId1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span>- <span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 从nodeId3,nodeId4一共分配1000个卡槽</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>slots</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 多个nodeId用逗号分隔</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fromReplicas</span><span class=p>:</span><span class=w> </span><span class=l>nodeId3,nodeId4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># redis 实例配置详情</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 标签管理：map[string][string]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 备注管理：map[string][string]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 环境变量管理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tony</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>aa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MAXMEMORY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>2gb    </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 亲和性管理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>affinity</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>HC_Status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>C</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>podAntiAffinity</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 资源管理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#cpu, memory, storage,ephemeral-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>4Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#statefulset更新模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>updateStrategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 支持挂载形式： hostPath(不需要persistentVolumeClaimName)，nfs(需要persistentVolumeClaimName)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>persistentVolumeClaimName</span><span class=p>:</span><span class=w> </span><span class=l>pvcName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 配置文件模板名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>configmap</span><span class=p>:</span><span class=w> </span><span class=l>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 监控镜像</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>monitorImage</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 初始化镜像</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initImage</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 中间件容器镜像</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>middlewareImage</span><span class=p>:</span><span class=w> </span><span class=l>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#当前statefulset replicas情况</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 集群阶段,None,Creating,Running,Failed,Scaling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># None 或 “”， 就是代表该CRD刚创建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Creating 代表等待redis资源对象创建完毕（operator 发现CRD创建，创建资源对象，更新状态）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Running 代表已进行初始化操作（在Creating之后，发现实例起来完毕，初始化操作）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Failed 代表着某异常故障</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># ---------------------</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Scaling 代表着实例不一致(用户修改实例，operator发现实例不一致，更新statefulset，更新状态)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Upgrading 代表着升级中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># ---------------------</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>phase</span><span class=p>:</span><span class=w> </span><span class=l>Creating</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 异常问题解释</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;异常问题&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis-cluster-0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instance</span><span class=p>:</span><span class=w> </span><span class=m>10.168.78.90</span><span class=p>:</span><span class=m>6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>masterNodeId</span><span class=p>:</span><span class=w> </span><span class=l>allkk111snknkcs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodeId</span><span class=p>:</span><span class=w> </span><span class=l>allkk111snknkcs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>domainName</span><span class=p>:</span><span class=w> </span><span class=l>redis-cluster-0.redis-cluster.kube-system.svc.cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>slots</span><span class=p>:</span><span class=w> </span><span class=m>1024-2048</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>docker-vm-3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostIP</span><span class=p>:</span><span class=w> </span><span class=m>192.168.26.122</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># true or flase </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>xxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>xxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=ld>2019-03-25T03:10:29Z</span><span class=w>
</span></span></span></code></pre></div><h2 class="relative group">代码生成<div id=代码生成 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90 aria-label=锚点>#</a></span></h2><p>主要生成符合k8s风格的代码：</p><ul><li>生成风格统一的DeepCopy（CustomResources必须实现runtime.Object接口——必须实现DeepCopy方法）；</li><li>clientset（自定义资源对象的客户端）；</li><li>listers（用来提供对于 GET/List 资源对象的请求提供只读缓存层）；</li><li>informers（List/Get 资源对象，还可以监听事件并触发回调函数。</li></ul><p>结构体定义到<code>$ProjectName/pkg/apis/{中间件名称}/{版本号}/types.go</code>里：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLTRjMjdhNjFkMjIxYjcxOWQucG5n?x-oss-process=image/format,png" alt=需要编写的一个go文件></figure></p><p>types.go中结构体定义根据上面准备的CR yaml定义。如下，其中需要注意的是，必须要给结构体加以下两个注解：</p><ul><li>// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object注解表示：为该类型生成 func (t* T) DeepCopy() *T方法。API类型都需要实现深拷贝；</li><li>// +genclient注解表示为当前类型生成客户端。<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLTc0NzczOGM4OGFjNjNjZTkucG5n?x-oss-process=image/format,png" alt=type.go中部分结构体定义></figure></li></ul><p>3、编写$ProjectName/pkg/apis/{中间件名称}/{版本号}/doc.go，其中定义全局tag：// +k8s:deepcopy-gen=package，表示为包中任何类型生成深拷贝方法。package指定版本。</p><p>4、编写$ProjectName/pkg/apis/{中间件名称}/{版本号}/register.go，通过scheme注册自定义CR类型，这样当和API Server通信的时候就能够处理该类型；（不同operator需要修改SchemeGroupVersion的Group和Version以及addKnownTypes中注册的结构体）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>v1alpha1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;harmonycloud.cn/middleware-operator-manager/pkg/apis/redis&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>v1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SchemeGroupVersion is group version used to register these objects</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>SchemeGroupVersion</span> <span class=p>=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersion</span> <span class=p>{</span><span class=nx>Group</span><span class=p>:</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>GroupName</span><span class=p>,</span> <span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1alpha1&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Kind takes an unqualified kind and returns back a Group qualified GroupKind</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Kind</span><span class=p>(</span><span class=nx>kind</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupKind</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>WithKind</span><span class=p>(</span><span class=nx>kind</span><span class=p>).</span><span class=nf>GroupKind</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Resource takes an unqualified resource and returns a Group qualified GroupResource</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Resource</span><span class=p>(</span><span class=nx>resource</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupResource</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>WithResource</span><span class=p>(</span><span class=nx>resource</span><span class=p>).</span><span class=nf>GroupResource</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>SchemeBuilder</span> <span class=p>=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>NewSchemeBuilder</span><span class=p>(</span><span class=nx>addKnownTypes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>AddToScheme</span>   <span class=p>=</span> <span class=nx>SchemeBuilder</span><span class=p>.</span><span class=nx>AddToScheme</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//注册CR对象</span>
</span></span><span class=line><span class=cl><span class=c1>// Adds the list of known types to Scheme.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>addKnownTypes</span><span class=p>(</span><span class=nx>scheme</span> <span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>scheme</span><span class=p>.</span><span class=nf>AddKnownTypes</span><span class=p>(</span><span class=nx>SchemeGroupVersion</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=o>&amp;</span><span class=nx>RedisCluster</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=o>&amp;</span><span class=nx>RedisClusterList</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>v1</span><span class=p>.</span><span class=nf>AddToGroupVersion</span><span class=p>(</span><span class=nx>scheme</span><span class=p>,</span> <span class=nx>SchemeGroupVersion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>5、编写$ProjectName/pkg/apis/{中间件名称}/register.go，其中定义了上一步用到的GroupName；</p><p>6、使用kubernetes提供的code-generator代码生成器工具，根据定义好的CR结构体对象生成风格统一的DeepCopy（CustomResources必须实现runtime.Object接口——必须实现DeepCopy方法）、clientset（自定义资源对象的客户端）、listers（用来提供对于 GET/List 资源对象的请求提供只读缓存层）、informers（List/Get 资源对象，还可以监听事件并触发回调函数）代码。</p><p>code-generator地址如下，下载后放到$GOPATH/src/k8s.io/目录下：</p><p><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9naXRodWIuY29tL2t1YmVybmV0ZXMvY29kZS1nZW5lcmF0b3I%3d" target=_blank>https://github.com/kubernetes/code-generator</a></p><p>然后执行以下命令，harmonycloud.cn/middleware-operator-manager/pkg/clients表示最终生成的clientset、informers、listers代码目录，最后的redis:v1alpha1需要改成{中间件名称}:{版本}</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./generate-groups.sh all <span class=s2>&#34;harmonycloud.cn/middleware-operator-manager/pkg/clients&#34;</span> <span class=s2>&#34;harmonycloud.cn/middleware-operator-manager/pkg/apis&#34;</span> <span class=s2>&#34;redis:v1alpha1&#34;</span>
</span></span></code></pre></div><p>执行后将生成以下代码：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLTkwYmIwMTg2NjMzMjRlYzEucG5n?x-oss-process=image/format,png" alt=生成的代码></figure></p><p><strong>生成代码时可能遇到的坑，请参考：</strong><br>k8s自定义资源类型代码自动生成：
<a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9jYmViNTEzMjUwZDA%3d" target=_blank>https://www.jianshu.com/p/cbeb513250d0</a></p><p><strong>参考：</strong></p><p><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9ibG9nLmdtZW0uY2MvZXh0ZW5kLWt1YmVybmV0ZXMtd2l0aC1jdXN0b20tcmVzb3VyY2Vz" target=_blank>通过自定义资源扩展Kubernetes</a></p><p><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9tZWRpdW0uY29tL0B0cnN0cmluZ2VyL2NyZWF0ZS1rdWJlcm5ldGVzLWNvbnRyb2xsZXJzLWZvci1jb3JlLWFuZC1jdXN0b20tcmVzb3VyY2VzLTYyZmMzNWFkNjRhMw%3d%3d" target=_blank>Extending Kubernetes: Create Controllers for Core and Custom Resources</a></p><h2 class="relative group">operator主流程代码开发<div id=operator主流程代码开发 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#operator%e4%b8%bb%e6%b5%81%e7%a8%8b%e4%bb%a3%e7%a0%81%e5%bc%80%e5%8f%91 aria-label=锚点>#</a></span></h2><p><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLTFlNjZjZDA4MTc0MWU5NjMucG5n?x-oss-process=image/format,png" alt=入口></figure><br>首先operator的入口为operator-manager.go里的main函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/pflag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;harmonycloud.cn/middleware-operator-manager/cmd/operator-manager/app&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;harmonycloud.cn/middleware-operator-manager/cmd/operator-manager/app/options&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apiserver/pkg/util/flag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apiserver/pkg/util/logs&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/kubernetes/pkg/version/verflag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//参数初始化配置</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>options</span><span class=p>.</span><span class=nf>NewOMServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nf>AddFlags</span><span class=p>(</span><span class=nx>pflag</span><span class=p>.</span><span class=nx>CommandLine</span><span class=p>,</span> <span class=nx>app</span><span class=p>.</span><span class=nf>KnownOperators</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>InitFlags</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//日志初始化</span>
</span></span><span class=line><span class=cl>	<span class=nx>logs</span><span class=p>.</span><span class=nf>InitLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>logs</span><span class=p>.</span><span class=nf>FlushLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>verflag</span><span class=p>.</span><span class=nf>PrintAndExitIfRequested</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>//进行operator初始化</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>app</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>s</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;%v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>main函数中首先进行对参数的初始化，其中主要包括：operator多实例时的选主配置；事件同步时间；集群创建、升级超时时间；是否启用leader功能；是否开启pprof分析功能等，代码在options.go中。</p><p>app.Run(s)根据参数配置进行operator初始化：</p><ul><li>首先根据参数配置，构建默认客户端（操作k8s已有资源对象）、leader选举客户端、操作扩展资源客户端等；</li><li>之后创建CRD资源对象定义，后续创建的CR对象都是该CRD的实例；</li><li>注册健康检查接口、根据启动参数配置决定是否开启pprof分析接口功能；</li><li>创建recorder，主要用于记录events（k8s资源），用于操作审计；</li><li>定义Run函数，进行启动operator，选举结果的leader执行该函数；</li><li>判断是否开启leader选举功能；</li><li>创建leader选举的资源锁，目前资源锁实现了configmaps和endpoints方式，具体代码在client-go下，默认使用endpoints方式；</li><li>启动leader选举机制，争抢到锁，选举为leader的实例执行OnStartedLeading，即上面定义的Run函数；失去锁的实例执行OnStoppedLeading函数。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Run runs the OMServer.  This should never exit.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>options</span><span class=p>.</span><span class=nx>OperatorManagerServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// To help debugging, immediately log version</span>
</span></span><span class=line><span class=cl>	<span class=nx>glog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Version: %+v&#34;</span><span class=p>,</span> <span class=nx>version</span><span class=p>.</span><span class=nf>Get</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//根据参数配置，构建默认客户端（操作k8s已有资源对象）、leader选举客户端、操作扩展资源客户端等</span>
</span></span><span class=line><span class=cl>	<span class=nx>kubeClient</span><span class=p>,</span> <span class=nx>leaderElectionClient</span><span class=p>,</span> <span class=nx>extensionCRClient</span><span class=p>,</span> <span class=nx>kubeconfig</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>createClients</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//根据提前准备好的CRD yaml文件，构建并创建CRD</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nf>CreateRedisClusterCRD</span><span class=p>(</span><span class=nx>extensionCRClient</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsAlreadyExists</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>glog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;redis cluster crd is already created.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprint</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//注册健康检查接口、根据启动参数配置决定是否开启pprof分析接口功能</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nf>startHTTP</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//创建recorder，主要用于记录events（k8s资源）</span>
</span></span><span class=line><span class=cl>	<span class=nx>recorder</span> <span class=o>:=</span> <span class=nf>createRecorder</span><span class=p>(</span><span class=nx>kubeClient</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//定义Run函数，进行启动operator，选举结果的leader执行该函数</span>
</span></span><span class=line><span class=cl>	<span class=nx>run</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>stop</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>operatorClientBuilder</span> <span class=o>:=</span> <span class=nx>operator</span><span class=p>.</span><span class=nx>SimpleOperatorClientBuilder</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ClientConfig</span><span class=p>:</span> <span class=nx>kubeconfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>rootClientBuilder</span> <span class=o>:=</span> <span class=nx>controller</span><span class=p>.</span><span class=nx>SimpleControllerClientBuilder</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ClientConfig</span><span class=p>:</span> <span class=nx>kubeconfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>CreateOperatorContext</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>kubeconfig</span><span class=p>,</span> <span class=nx>operatorClientBuilder</span><span class=p>,</span> <span class=nx>rootClientBuilder</span><span class=p>,</span> <span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>glog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error building controller context: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>InformerFactory</span> <span class=p>=</span> <span class=nx>informers</span><span class=p>.</span><span class=nf>NewSharedInformerFactory</span><span class=p>(</span><span class=nx>kubeClient</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>ResyncPeriod</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>StartOperators</span><span class=p>(</span><span class=nx>otx</span><span class=p>,</span> <span class=nf>NewOperatorInitializers</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>glog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error starting operators: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>RedisInformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>otx</span><span class=p>.</span><span class=nx>Stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>otx</span><span class=p>.</span><span class=nx>Stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>close</span><span class=p>(</span><span class=nx>otx</span><span class=p>.</span><span class=nx>InformersStarted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//判断是否开启leader选举功能</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>LeaderElect</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>run</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unreachable&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Hostname</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//创建leader选举的资源锁，目前资源锁实现了configmaps和endpoints方式，具体代码在client-go下，默认使用endpoints方式</span>
</span></span><span class=line><span class=cl>	<span class=nx>rl</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>resourcelock</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>ResourceLock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;kube-system&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;middleware-operator-manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>leaderElectionClient</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>resourcelock</span><span class=p>.</span><span class=nx>ResourceLockConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Identity</span><span class=p>:</span>      <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EventRecorder</span><span class=p>:</span> <span class=nx>recorder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>glog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error creating lock: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//启动leader选举机制，争抢到锁，选举为leader的实例执行OnStartedLeading，即上面定义的Run函数；失去锁的实例执行OnStoppedLeading函数</span>
</span></span><span class=line><span class=cl>	<span class=nx>leaderelection</span><span class=p>.</span><span class=nf>RunOrDie</span><span class=p>(</span><span class=nx>leaderelection</span><span class=p>.</span><span class=nx>LeaderElectionConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Lock</span><span class=p>:</span>          <span class=nx>rl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>LeaseDuration</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>LeaseDuration</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>RenewDeadline</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>RenewDeadline</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>RetryPeriod</span><span class=p>:</span>   <span class=nx>s</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>RetryPeriod</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Callbacks</span><span class=p>:</span> <span class=nx>leaderelection</span><span class=p>.</span><span class=nx>LeaderCallbacks</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>OnStartedLeading</span><span class=p>:</span> <span class=nx>run</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>OnStoppedLeading</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>glog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;leaderelection lost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unreachable&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>CreateRedisClusterCRD方法根据上面准备的CRD yaml文件构建并创建CRD，只有创建了该CRD，redisCluster资源对象才可以被创建。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>CreateRedisClusterCRD</span><span class=p>(</span><span class=nx>extensionCRClient</span> <span class=o>*</span><span class=nx>extensionsclient</span><span class=p>.</span><span class=nx>Clientset</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//TODO add CustomResourceValidation due to guarantee redis operator work normally,k8s1.12</span>
</span></span><span class=line><span class=cl>	<span class=nx>crd</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>v1beta1</span><span class=p>.</span><span class=nx>CustomResourceDefinition</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;redisclusters.&#34;</span> <span class=o>+</span> <span class=nx>v1alpha1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nx>Group</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Spec</span><span class=p>:</span> <span class=nx>v1beta1</span><span class=p>.</span><span class=nx>CustomResourceDefinitionSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Group</span><span class=p>:</span>   <span class=nx>v1alpha1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nx>Group</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Version</span><span class=p>:</span> <span class=nx>v1alpha1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nx>Version</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Scope</span><span class=p>:</span>   <span class=nx>v1beta1</span><span class=p>.</span><span class=nx>NamespaceScoped</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Names</span><span class=p>:</span> <span class=nx>v1beta1</span><span class=p>.</span><span class=nx>CustomResourceDefinitionNames</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Kind</span><span class=p>:</span>       <span class=s>&#34;RedisCluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>ListKind</span><span class=p>:</span>   <span class=s>&#34;RedisClusterList&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Plural</span><span class=p>:</span>     <span class=s>&#34;redisclusters&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Singular</span><span class=p>:</span>   <span class=s>&#34;rediscluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>ShortNames</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;rec&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>extensionCRClient</span><span class=p>.</span><span class=nf>ApiextensionsV1beta1</span><span class=p>().</span><span class=nf>CustomResourceDefinitions</span><span class=p>().</span><span class=nf>Create</span><span class=p>(</span><span class=nx>crd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>CR的apiVersion为CRD的spec.Group/spec.Version即生成代码时register.go中的GroupName和doc.go中的版本号：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>redis.middleware.hc.cn/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RedisCluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example000-redis-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span></code></pre></div><p>Run函数中主要创建context对象，context里包含启动参数options，kubeconfig配置、RedisInformerFactory（监听CR变化）、InformerFactory（监听statefulsetset变化）等，进行启动operator、启动informer。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>run</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>stop</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>operatorClientBuilder</span> <span class=o>:=</span> <span class=nx>operator</span><span class=p>.</span><span class=nx>SimpleOperatorClientBuilder</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ClientConfig</span><span class=p>:</span> <span class=nx>kubeconfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>rootClientBuilder</span> <span class=o>:=</span> <span class=nx>controller</span><span class=p>.</span><span class=nx>SimpleControllerClientBuilder</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ClientConfig</span><span class=p>:</span> <span class=nx>kubeconfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=c1>//创建context对象，context里包含启动参数options，kubeconfig配置、RedisInformerFactory（监听CR变化）、InformerFactory（监听statefulsetset变化）等</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>CreateOperatorContext</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>kubeconfig</span><span class=p>,</span> <span class=nx>operatorClientBuilder</span><span class=p>,</span> <span class=nx>rootClientBuilder</span><span class=p>,</span> <span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>glog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error building controller context: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    	<span class=c1>//创建InformerFactory</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>InformerFactory</span> <span class=p>=</span> <span class=nx>informers</span><span class=p>.</span><span class=nf>NewSharedInformerFactory</span><span class=p>(</span><span class=nx>kubeClient</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>ResyncPeriod</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    	<span class=c1>//启动operator，NewOperatorInitializers()中定义了启动哪些operator</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>StartOperators</span><span class=p>(</span><span class=nx>otx</span><span class=p>,</span> <span class=nf>NewOperatorInitializers</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>glog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error starting operators: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>//启动RedisInformerFactory</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>RedisInformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>otx</span><span class=p>.</span><span class=nx>Stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   		<span class=c1>//启动InformerFactory</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>otx</span><span class=p>.</span><span class=nx>Stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>close</span><span class=p>(</span><span class=nx>otx</span><span class=p>.</span><span class=nx>InformersStarted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>//阻塞</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></div><p>NewOperatorInitializers()中定义了启动哪些operator（新加operator直接在该方法中加）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewOperatorInitializers</span><span class=p>()</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>InitFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>controllers</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>InitFunc</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>controllers</span><span class=p>[</span><span class=s>&#34;rediscluster&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>startRedisClusterController</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>CreateOperatorContext函数里根据代码生成器生成的redis客户端versionedClient创建了RedisInformerFactory；（根据不同operator生成不同的客户端，这里需要修改client_builder.go中ClientOrDie的返回值类型），最终创建context对象。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>CreateOperatorContext</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>options</span><span class=p>.</span><span class=nx>OperatorManagerServer</span><span class=p>,</span> <span class=nx>kubeConfig</span> <span class=o>*</span><span class=nx>restclient</span><span class=p>.</span><span class=nx>Config</span><span class=p>,</span> <span class=nx>operatorClientBuilder</span> <span class=nx>operator</span><span class=p>.</span><span class=nx>OperatorClientBuilder</span><span class=p>,</span> <span class=nx>rootClientBuilder</span> <span class=nx>controller</span><span class=p>.</span><span class=nx>ControllerClientBuilder</span><span class=p>,</span> <span class=nx>stop</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>(</span><span class=nx>OperatorContext</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>versionedClient</span> <span class=o>:=</span> <span class=nx>operatorClientBuilder</span><span class=p>.</span><span class=nf>ClientOrDie</span><span class=p>(</span><span class=s>&#34;middleware-shared-informers&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sharedInformers</span> <span class=o>:=</span> <span class=nx>redisInformerFactory</span><span class=p>.</span><span class=nf>NewSharedInformerFactory</span><span class=p>(</span><span class=nx>versionedClient</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>ResyncPeriod</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*availableResources, err := GetAvailableResources(rootClientBuilder)
</span></span></span><span class=line><span class=cl><span class=cm>	if err != nil {
</span></span></span><span class=line><span class=cl><span class=cm>		return OperatorContext{}, err
</span></span></span><span class=line><span class=cl><span class=cm>	}*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>otx</span> <span class=o>:=</span> <span class=nx>OperatorContext</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>kubeConfig</span><span class=p>:</span>            <span class=nx>kubeConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>OperatorClientBuilder</span><span class=p>:</span> <span class=nx>operatorClientBuilder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>DefaultClientBuilder</span><span class=p>:</span>  <span class=nx>rootClientBuilder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>RedisInformerFactory</span><span class=p>:</span>  <span class=nx>sharedInformers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Options</span><span class=p>:</span>               <span class=o>*</span><span class=nx>s</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=c1>//AvailableResources: availableResources,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Stop</span><span class=p>:</span>             <span class=nx>stop</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>InformersStarted</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>otx</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>StartOperators函数启动所有NewOperatorInitializers中定义的operator，执行startRedisClusterController函数。（不同operator执行不同的启动函数）。</p><p>startRedisClusterController定义在extensions.go中，用于创建operator、启动worker协程从队列中取出（用于处理informer监听变化的资源对象）进行业务逻辑处理。（新增operator需要在extensions.go中增加对应的start函数）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>startRedisClusterController</span><span class=p>(</span><span class=nx>otx</span> <span class=nx>OperatorContext</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//创建redisOperator</span>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>redis</span><span class=p>.</span><span class=nf>NewRedisClusterOperator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>//注册RedisInformer回调函数</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>RedisInformerFactory</span><span class=p>.</span><span class=nf>Cr</span><span class=p>().</span><span class=nf>V1alpha1</span><span class=p>().</span><span class=nf>RedisClusters</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>         <span class=c1>//注册statefulsetInformer回调函数</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>.</span><span class=nf>Apps</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>StatefulSets</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=c1>//默认客户端，用于操作k8s自身资源对象</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>DefaultClientBuilder</span><span class=p>.</span><span class=nf>ClientOrDie</span><span class=p>(</span><span class=s>&#34;default-kube-client&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=c1>//代码生成器生成的客户端，用于操作CR</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>OperatorClientBuilder</span><span class=p>.</span><span class=nf>ClientOrDie</span><span class=p>(</span><span class=s>&#34;rediscluster-operator&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=c1>//kubeconfig配置</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>kubeConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>//启动参数配置</span>
</span></span><span class=line><span class=cl>		<span class=nx>otx</span><span class=p>.</span><span class=nx>Options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error creating rediscluster operator: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//启动ConcurrentRedisClusterSyncs个worker协程处理变化的资源对象</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>rco</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>otx</span><span class=p>.</span><span class=nx>Options</span><span class=p>.</span><span class=nx>ConcurrentRedisClusterSyncs</span><span class=p>),</span> <span class=nx>otx</span><span class=p>.</span><span class=nx>Stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>NewRedisClusterOperator方法如下，主要创建该operator的结构体，队列，redisInformer注册回调函数，statefulsetInformer回调函数的注册。（不同的operator，需要不同的Informer、处理业务逻辑的方法）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewRedisClusterOperator</span><span class=p>(</span><span class=nx>redisInformer</span> <span class=nx>custominfomer</span><span class=p>.</span><span class=nx>RedisClusterInformer</span><span class=p>,</span> <span class=nx>stsInformer</span> <span class=nx>appsinformers</span><span class=p>.</span><span class=nx>StatefulSetInformer</span><span class=p>,</span> <span class=nx>kubeClient</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>customCRDClient</span> <span class=nx>customclient</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>kubeConfig</span> <span class=o>*</span><span class=nx>rest</span><span class=p>.</span><span class=nx>Config</span><span class=p>,</span> <span class=nx>options</span> <span class=nx>options</span><span class=p>.</span><span class=nx>OperatorManagerServer</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>RedisClusterOperator</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//创建该operator的recorder，记录events</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventBroadcaster</span> <span class=o>:=</span> <span class=nx>record</span><span class=p>.</span><span class=nf>NewBroadcaster</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventBroadcaster</span><span class=p>.</span><span class=nf>StartLogging</span><span class=p>(</span><span class=nx>glog</span><span class=p>.</span><span class=nx>Infof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventBroadcaster</span><span class=p>.</span><span class=nf>StartRecordingToSink</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>v1core</span><span class=p>.</span><span class=nx>EventSinkImpl</span><span class=p>{</span><span class=nx>Interface</span><span class=p>:</span> <span class=nx>v1core</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>kubeClient</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>RESTClient</span><span class=p>()).</span><span class=nf>Events</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>)})</span>
</span></span><span class=line><span class=cl> <span class=c1>//创建该operator的结构体</span>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>RedisClusterOperator</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>options</span><span class=p>:</span>       <span class=o>&amp;</span><span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>kubeConfig</span><span class=p>:</span>    <span class=nx>kubeConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>defaultClient</span><span class=p>:</span> <span class=nx>kubeClient</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=c1>//extensionCRClient: extensionCRClient,</span>
</span></span><span class=line><span class=cl>		<span class=nx>customCRDClient</span><span class=p>:</span> <span class=nx>customCRDClient</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>eventRecorder</span><span class=p>:</span>   <span class=nx>eventBroadcaster</span><span class=p>.</span><span class=nf>NewRecorder</span><span class=p>(</span><span class=nx>scheme</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventSource</span><span class=p>{</span><span class=nx>Component</span><span class=p>:</span> <span class=s>&#34;operator-manager&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>queue</span><span class=p>:</span>           <span class=nx>workqueue</span><span class=p>.</span><span class=nf>NewNamedRateLimitingQueue</span><span class=p>(</span><span class=nx>workqueue</span><span class=p>.</span><span class=nf>DefaultControllerRateLimiter</span><span class=p>(),</span> <span class=s>&#34;rediscluster&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//redisInformer注册回调函数，当informer监听到redis CR资源变化时，调用对应AddFunc、UpdateFunc、DeleteFunc回调函数将CR资源放到queue中</span>
</span></span><span class=line><span class=cl>	<span class=nx>redisInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span><span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>rco</span><span class=p>.</span><span class=nx>addRedisCluster</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>updateRedisCluster</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=c1>// This will enter the sync loop and no-op, because the RedisCluster has been deleted from the store.</span>
</span></span><span class=line><span class=cl>		<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>deleteRedisCluster</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//定义最终处理业务逻辑的函数</span>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span><span class=p>.</span><span class=nx>syncHandler</span> <span class=p>=</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>syncRedisCluster</span>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span><span class=p>.</span><span class=nx>enqueueRedisCluster</span> <span class=p>=</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>enqueue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span><span class=p>.</span><span class=nx>redisClusterInformer</span> <span class=p>=</span> <span class=nx>redisInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//redisInformer是否已经开始同步事件变化</span>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span><span class=p>.</span><span class=nx>redisClusterListerSynced</span> <span class=p>=</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>redisClusterInformer</span><span class=p>.</span><span class=nx>HasSynced</span>
</span></span><span class=line><span class=cl>    <span class=c1>//lister提供操作informer中缓存的变化的资源接口</span>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span><span class=p>.</span><span class=nx>redisClusterLister</span> <span class=p>=</span> <span class=nx>redisInformer</span><span class=p>.</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=c1>//statefulsetInformer注册回调函数，当informer监听到statefulset资源变化时，调用对应AddFunc、UpdateFunc、DeleteFunc回调函数将redis实例的statefulset加入到queue中</span>
</span></span><span class=line><span class=cl>	<span class=nx>stsInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>AddFunc</span><span class=p>:</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>addStatefulSet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>old</span><span class=p>,</span> <span class=nx>cur</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>oldSts</span> <span class=o>:=</span> <span class=nx>old</span><span class=p>.(</span><span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>StatefulSet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>curSts</span> <span class=o>:=</span> <span class=nx>cur</span><span class=p>.(</span><span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>StatefulSet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>oldSts</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Replicas</span> <span class=o>!=</span> <span class=nx>curSts</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Replicas</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>glog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Observed updated replica count for StatefulSet: %v, %d-&gt;%d&#34;</span><span class=p>,</span> <span class=nx>curSts</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>oldSts</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>,</span> <span class=nx>curSts</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>rco</span><span class=p>.</span><span class=nf>updateStatefulSet</span><span class=p>(</span><span class=nx>oldSts</span><span class=p>,</span> <span class=nx>curSts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>deleteStatefulSet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span><span class=p>.</span><span class=nx>stsLister</span> <span class=p>=</span> <span class=nx>stsInformer</span><span class=p>.</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//statefulsetInformer是否已经开始同步事件变化</span>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span><span class=p>.</span><span class=nx>stsListerSynced</span> <span class=p>=</span> <span class=nx>stsInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nx>HasSynced</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>rco</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Run函数中等待redis CR资源、statefulset资源对象同步，然后启动指定个数worker，并永久阻塞，直到stopCh被close（不同operator需要修改rco.redisClusterListerSynced为对应的ListerSynced）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rco</span> <span class=o>*</span><span class=nx>RedisClusterOperator</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>workers</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleCrash</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>ShutDown</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>glog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Starting rediscluster operator&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>glog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Shutting down rediscluster operator&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//等待redis CR资源、statefulset资源对象同步。</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>controller</span><span class=p>.</span><span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=s>&#34;rediscluster&#34;</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>,</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>redisClusterListerSynced</span><span class=p>,</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>stsListerSynced</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//循环启动指定个数worker，并永久阻塞，直到stopCh被close</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>workers</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>rco</span><span class=p>.</span><span class=nx>worker</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>stopCh</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>worker方法死循环rco.processNextWorkItem()在队列Operator中定义的queue中取出变化的资源去处理（不同operator有不同的业务处理逻辑）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rco</span> <span class=o>*</span><span class=nx>RedisClusterOperator</span><span class=p>)</span> <span class=nf>worker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>rco</span><span class=p>.</span><span class=nf>processNextWorkItem</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>从informer监听到资源对象变化，回调函数将资源对象key（namespace/name）放到queue中，到worker取出queue中的key去做处理，处理完成后Done掉key流程图如下：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLWRkY2RkYzVkOGE4YzM5ODIucG5n?x-oss-process=image/format,png" alt=key处理流程></figure><br>回调函数将资源对象的key加入到queue中，worker从queue中取出key去处理业务，此时key会被放到processing集合中，表示该key正在被处理。worker处理key时如果遇到错误，该key会根据重试次数是否大于最大重试次数被加入到rateLimited（可以限制添加到queue中速度，最终还会被加入到queue）。worker处理key成功后，Forget(key)表示从rateLimited中清除，Done(key)表示key处理完毕，从processing集合中删除。该代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rco</span> <span class=o>*</span><span class=nx>RedisClusterOperator</span><span class=p>)</span> <span class=nf>processNextWorkItem</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span><span class=p>,</span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>quit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Done marks item as done processing, and if it has been marked as dirty again</span>
</span></span><span class=line><span class=cl>	<span class=c1>// while it was being processed, it will be re-added to the queue for</span>
</span></span><span class=line><span class=cl>	<span class=c1>// re-processing.</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>rco</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>rco</span><span class=p>.</span><span class=nf>syncHandler</span><span class=p>(</span><span class=nx>key</span><span class=p>.(</span><span class=kt>string</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>//加入到rateLimited中、forget(key)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rco</span><span class=p>.</span><span class=nf>handleErr</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//处理key，主业务逻辑</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>rco</span><span class=p>.</span><span class=nf>syncHandler</span><span class=p>(</span><span class=nx>key</span><span class=p>.(</span><span class=kt>string</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h2 class="relative group">开发注意事项<div id=开发注意事项 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%bc%80%e5%8f%91%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-label=锚点>#</a></span></h2><ul><li><p>开启worker时，调用cache.WaitForCacheSync等待缓存开始同步。<br><figure><img class="my-0 rounded-md" loading=lazy src=https://upload-images.jianshu.io/upload_images/9134763-06e2e4bc6b7135d0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240 alt="WaitForCacheSync等待同步
"></figure></p></li><li><p>不要改变原始对象（从lister中取出的对象），而要使用DeepCopy，因为缓存在informer之间共享。<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLTE5YzgxYzEwOGZhNGNjODAucG5n?x-oss-process=image/format,png" alt=deepcopy></figure></p></li><li><p>根据CRD构建Statefulset时，给Statefulset加OwnerReferences，这样在删除CRD的时候，可以设置是否级联删除statefulset。<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLTdjMDZiN2E5NDY5YTJiZTIucG5n?x-oss-process=image/format,png" alt=设置owner></figure></p></li></ul><p>参考：<br>k8s垃圾收集：
<a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzL2dhcmJhZ2UtY29sbGVjdGlvbi8%3d" target=_blank>https://kubernetes.io/zh/docs/concepts/workloads/controllers/garbage-collection/</a></p><p>Kubernetes之Garbage Collection：
<a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RrZmFqc2xkZnNkZnNkL2FydGljbGUvZGV0YWlscy84MTEzMDc4Ng%3d%3d" target=_blank>https://blog.csdn.net/dkfajsldfsdfsd/article/details/81130786</a></p><h2 class="relative group">调试<div id=调试 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%b0%83%e8%af%95 aria-label=锚点>#</a></span></h2><p>本地用IDE&ndash;goland调试代码时，配置如下：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLWJiYTg5ZWM1ZWNhODU3ZDcucG5n?x-oss-process=image/format,png" alt=1555136612836.png></figure></p><p>Run kind：选File；</p><p>Files：指定main函数所在文件的全路径；</p><p>Output directory：指定编译后输出的二进制文件位置。可输入。（默认输出exe格式windows可执行文件）</p><p>Run after build：勾选后，编译完成后运行。</p><p>Go tool arguments：填写-i（用于增量编译提速）。</p><p>Program arguments：用于指定程序启动参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>--kubeconfig<span class=o>=</span>D:<span class=se>\S</span>oftwareAndProgram<span class=se>\p</span>rogram<span class=se>\G</span>o<span class=se>\D</span>evelopment<span class=se>\s</span>rc<span class=se>\h</span>armonycloud.cn<span class=se>\m</span>iddleware-operator-manager<span class=se>\a</span>rtifacts<span class=se>\c</span>onfig60 --v<span class=o>=</span><span class=m>5</span>
</span></span></code></pre></div><p>&ndash;kubeconfig指定kubeconfig文件所在全路径（即k8s集群master节点的/root/.kube/config），其指定k8s集群apiserver地址已经访问时的证书信息。<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLWQ2NjAzNzAyMmYxOWQyZmIucG5n?x-oss-process=image/format,png" alt=kubeconfig文件></figure></p><p>&ndash;v指定glog日志级别，&ndash;v=5表示只输出info小于5和error、warn日志。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>glog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Adding RedisCluster %s&#34;</span><span class=p>,</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>glog</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;-----------redisCluster: %#v--&#34;</span><span class=p>,</span> <span class=nx>redisCluster</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>glog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span></code></pre></div><h2 class="relative group">镜像制作<div id=镜像制作 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%95%9c%e5%83%8f%e5%88%b6%e4%bd%9c aria-label=锚点>#</a></span></h2><h4 class="relative group">编译前提<div id=编译前提 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%bc%96%e8%af%91%e5%89%8d%e6%8f%90 aria-label=锚点>#</a></span></h4><p>提前安装好go语言开发环境，正确设置GOROOT和GOPATH环境变量，要求go1.8.3版本以上</p><h4 class="relative group">编译二进制<div id=编译二进制 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%bc%96%e8%af%91%e4%ba%8c%e8%bf%9b%e5%88%b6 aria-label=锚点>#</a></span></h4><p>将<code>middleware-operator-manager</code>放在<code>$GOPATH/src/harmonycloud.cn/</code>目录下，进入到 <code>$GOPATH/src/harmonycloud.cn/middleware-operator-manager/cmd/operator-manager</code>目录， 最终要生成linux的可执行文件：</p><ul><li>如果是在windows上编译：</li></ul><p>打开cmd窗口，进入以上目录后，执行以下命令：</p><pre><code>set GOOS=linux
go build -a -o operator-manager
</code></pre><ul><li>如果是在linux上编译：</li></ul><p>执行以下命令：</p><pre><code>go build -a -o operator-manager
</code></pre><p>等待编译完成，最终在当前目录下生成operator-manager可执行文件</p><h4 class="relative group">镜像制作<div id=镜像制作-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%95%9c%e5%83%8f%e5%88%b6%e4%bd%9c-1 aria-label=锚点>#</a></span></h4><p><code>$GOPATH/src/harmonycloud.cn/middleware-operator-manager/artifacts</code>目录下有Dockerfile文件，基础镜像为busybox</p><pre><code>FROM busybox

ADD operator-manager /usr/bin/ 
RUN chmod +x /usr/bin/operator-manager
</code></pre><p>同级目录下有operator-manager deployment描述文件operator-manager.yaml:</p><pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  generation: 2
  labels:
    app: operator-manager
  name: operator-manager
  namespace: kube-system
spec:
  replicas: 2
  selector:
    matchLabels:
      app: operator-manager
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: operator-manager
    spec:
      containers:
      - command:
        - operator-manager
        - --v=5
        - --leader-elect=true
        image: 192.168.26.46/k8s-deploy/operator-manager:v1
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 200m
            memory: 512Mi
        imagePullPolicy: Always
        name: operator-manager
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
</code></pre><p>同级目录下有build.sh脚本，指定了docker镜像仓库地址为192.168.26.46</p><pre><code>#!/bin/bash

docker build -f ./Dockerfile -t operator-manager:v1 .
docker tag operator-manager:v1 192.168.26.46/k8s-deploy/operator-manager:v1
docker push 192.168.26.46/k8s-deploy/operator-manager:v1
kubectl apply -f operator-manager.yaml
</code></pre><p>执行该脚本即可以将operator-manager二进制打成镜像并推送到192.168.26.46仓库的k8s-deploy项目下： 同时执行了</p><pre><code>kubectl apply -f operator-manager.yaml
</code></pre><p>命令创建了operator-manager的deployment对象，完成了部署。</p><h2 class="relative group">operator高可用<div id=operator高可用 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#operator%e9%ab%98%e5%8f%af%e7%94%a8 aria-label=锚点>#</a></span></h2><p>用k8s组件中leader选举机制实现redis operator组件的高可用，即正常情况下redis operator组件的多个副本只有一个是处于业务逻辑运行状态，其它副本则不断的尝试去获取锁，去竞争leader，直到自己成为leader。如果正在运行的leader因某种原因导致当前进程退出，或者锁丢失，则由其它副本去竞争新的leader，获取leader继而执行业务逻辑。</p><p>启动两个operator-manager实例：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLTc3YzYwMmFlZWE2MGIwNzIucG5n?x-oss-process=image/format,png" alt=启动了两个实例></figure></p><p>可以看到只有一个实例operator-manager-86d785b5fc-m5rgh在同步事件，处理业务：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLWJiZWE0M2IxZTVjNDE4M2UucG5n?x-oss-process=image/format,png" alt=master实例正在处理业务并renew锁></figure></p><p>operator-manager-86d785b5fc-sszj2实例一直在竞争尝试获取锁：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLWYxOTZlNjljZWI1NDQxYjcucG5n?x-oss-process=image/format,png" alt=slave实例正在尝试获取锁></figure></p><p>删除掉正在同步事件的实例operator-manager-86d785b5fc-m5rgh：<br><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLWMyNjY2OGFlMzBjY2Y1ZjgucG5n?x-oss-process=image/format,png" alt=删除掉master实例></figure></p><p>实例operator-manager-86d785b5fc-sszj2竞争获取到锁，开始处理业务逻辑：</p><p><figure><img class="my-0 rounded-md" loading=lazy src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy85MTM0NzYzLTg3NTg1NDVjZDMzZjA0NzcucG5n?x-oss-process=image/format,png" alt=slave实例获取到锁，开始处理业务并renew锁></figure><br>故可以通过反亲和性防止两个operator-manager实例调度到同一主机上，达到主备高可用。</p><p>最后附上源码地址：</p><p><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9naXRodWIuY29tL2xsODM3NDQ4NzkyL21pZGRsZXdhcmUtb3BlcmF0b3ItbWFuYWdlcg%3d%3d" target=_blank>https://github.com/ll837448792/middleware-operator-manager</a></p><p>参考：<br><a href="https://kubeinfo.cn/go/?target=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTk2MTU1OS9hcnRpY2xlL2RldGFpbHMvODE4NzcwNTY%3d" target=_blank>谈谈k8s的leader选举&ndash;分布式资源锁</a></p><hr></div><div class="text-neutral-700 dark:text-neutral-300" style=text-align:center;font-size:16px;font-family:cursive>-------莫愁前路无知己
<span class="relative icon" style=display:inline-block><svg version="1.0" id="Layer_1" xmlns:xlink="http://www.w3.org/1999/xlink" width="800" height="800" viewBox="0 0 64 64" enable-background="new 0 0 64 64"><g><path fill="#394240" d="M35 4.145V3.002 3c0-1.656-1.343-3-3-3s-3 1.344-3 3v.002 1.143C12.734 5.658.0 19.338.0 36c0 0 0 1 1 1s1.867-1 1.867-1C4.68 34.15 7.204 33 10 33c4.1.0 7.618 2.469 9.162 6 0 0 .541 1 1.838 1s1.838-1 1.838-1c1.15-2.629 3.396-4.668 6.162-5.539V56c0 4.418 3.582 8 8 8s8-3.582 8-8c0-1.656-1.343-3-3-3s-3 1.344-3 3c0 1.104-.896 2-2 2s-2-.896-2-2V33.461c2.766.871 5.012 2.91 6.162 5.539.0.0.541 1 1.838 1s1.838-1 1.838-1c1.544-3.531 5.062-6 9.162-6 2.796.0 5.319 1.15 7.133 3 0 0 .867 1 1.867 1s1-1 1-1C64 19.338 51.266 5.658 35 4.145zM31 3c0-.553.447-1 1-1s1 .447 1 1v1.025C32.667 4.016 32.335 4 32 4s-.667.016-1 .025V3zM10 31c-3.047.0-5.816 1.145-7.928 3.018C3.006 19.729 13.94 8.17 27.947 6.277 22.911 14.678 20 24.492 20 35v1.387C17.853 33.145 14.181 31 10 31zM37 60c2.209.0 4-1.791 4-4 0-.553.447-1 1-1s1 .447 1 1c0 3.312-2.687 6-6 6s-6-2.688-6-6V33.055C31.329 33.023 31.662 33 32 33s.671.023 1 .055V56c0 2.209 1.791 4 4 4zM32 31c-4.181.0-7.853 2.145-10 5.387V35c0-10.662 3.113-20.588 8.449-28.959.5-.025 1.004-.039 1.511-.039h.08c.507.0 1.011.014 1.511.039C38.887 14.412 42 24.338 42 35v1.387C39.853 33.145 36.181 31 32 31zm22 0c-4.181.0-7.853 2.145-10 5.387V35c0-10.508-2.911-20.322-7.947-28.723C50.06 8.17 60.994 19.729 61.928 34.018 59.816 32.145 57.047 31 54 31z"/><path fill="#f9ebb2" d="M31 3c0-.553.447-1 1-1s1 .447 1 1v1.025C32.667 4.016 32.335 4 32 4s-.667.016-1 .025V3z"/><g><path fill="#45aab8" d="M2.072 34.018C4.184 32.145 6.953 31 10 31c4.181.0 7.853 2.145 10 5.387V35c0-10.508 2.911-20.322 7.947-28.723C13.94 8.17 3.006 19.729 2.072 34.018z"/><path fill="#45aab8" d="M36.053 6.277C41.089 14.678 44 24.492 44 35v1.387C46.147 33.145 49.819 31 54 31c3.047.0 5.816 1.145 7.928 3.018C60.994 19.729 50.06 8.17 36.053 6.277z"/></g><path fill="#b4ccb9" d="M32.04 6.002h-.08c-.507.0-1.011.014-1.511.039C25.113 14.412 22 24.338 22 35v1.387C24.147 33.145 27.819 31 32 31s7.853 2.145 10 5.387V35c0-10.662-3.113-20.588-8.449-28.959C33.051 6.016 32.547 6.002 32.04 6.002z"/><path fill="#f9ebb2" d="M37 60c2.209.0 4-1.791 4-4 0-.553.447-1 1-1s1 .447 1 1c0 3.312-2.687 6-6 6s-6-2.688-6-6V33.055C31.329 33.023 31.662 33 32 33s.671.023 1 .055V56c0 2.209 1.791 4 4 4z"/></g></svg>
</span>天下谁人不识君-------</div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/&amp;title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aaoperator%e6%89%a9%e5%b1%95kubernetes%e7%9a%84%e8%83%bd%e5%8a%9b" title="分享到 LinkedIn" aria-label="分享到 LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/&amp;text=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aaoperator%e6%89%a9%e5%b1%95kubernetes%e7%9a%84%e8%83%bd%e5%8a%9b" title="分享到 Twitter" aria-label="分享到 Twitter"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/&amp;resubmit=true&amp;title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aaoperator%e6%89%a9%e5%b1%95kubernetes%e7%9a%84%e8%83%bd%e5%8a%9b" title="提交到 Reddit" aria-label="提交到 Reddit"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://api.whatsapp.com/send?text=https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/&amp;resubmit=true&amp;title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aaoperator%e6%89%a9%e5%b1%95kubernetes%e7%9a%84%e8%83%bd%e5%8a%9b" title="分享到 WhatsApp" aria-label="分享到 WhatsApp"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4.0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3.0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2.0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2.0-101.7 82.8-184.5 184.6-184.5 49.3.0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5.0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3.0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://t.me/share/url?url=https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/&amp;resubmit=true&amp;title=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aaoperator%e6%89%a9%e5%b1%95kubernetes%e7%9a%84%e8%83%bd%e5%8a%9b" title="分享到 Telegram" aria-label="分享到 Telegram"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://pinterest.com/pin/create/bookmarklet/?url=https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/&amp;description=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aaoperator%e6%89%a9%e5%b1%95kubernetes%e7%9a%84%e8%83%bd%e5%8a%9b" title="钉到 Pinterest" aria-label="钉到 Pinterest"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M496 256c0 137-111 248-248 248-25.6.0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8.0 128.7-68.8 128.7-154.3.0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1.0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6.0-54.7 41.4-107.6 112-107.6 60.9.0 103.6 41.5 103.6 100.9.0 67.1-33.9 113.6-78 113.6-24.3.0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6.0-19-10.2-34.9-31.4-34.9-24.9.0-44.9 25.7-44.9 60.2.0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9.0 361.1.0 256 0 119 111 8 248 8s248 111 248 248z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/&amp;quote=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aaoperator%e6%89%a9%e5%b1%95kubernetes%e7%9a%84%e8%83%bd%e5%8a%9b" title="分享到 Facebook" aria-label="分享到 Facebook"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://kubeinfo.cn/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/&amp;subject=%e5%bc%80%e5%8f%91%e4%b8%80%e4%b8%aaoperator%e6%89%a9%e5%b1%95kubernetes%e7%9a%84%e8%83%bd%e5%8a%9b" title=通过电子邮件发送 aria-label=通过电子邮件发送><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section><h2 class="mt-8 text-2xl font-extrabold mb-10">相关文章</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><a href=/posts/kubernetespodexec%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/kubernetespodexec%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8/>kubernetes pod exec接口调用</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-18T13:30:04+00:00>2019年10月18日</time><span class="px-2 text-primary-500">&#183;</span><span>2208 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>5 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/k8s%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/k8s%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90/>k8s自定义资源类型代码自动生成</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-18T13:29:09+00:00>2019年10月18日</time><span class="px-2 text-primary-500">&#183;</span><span>764 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>2 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/%E9%87%87%E5%9D%91%E6%8C%87%E5%8D%97k8s%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90coredns%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/%E9%87%87%E5%9D%91%E6%8C%87%E5%8D%97k8s%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90coredns%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B/>采坑指南——k8s域名解析coredns问题排查过程</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-17T14:40:05+00:00>2019年10月17日</time><span class="px-2 text-primary-500">&#183;</span><span>1652 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>4 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%8E%A7%E5%88%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%8E%A7%E5%88%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80/>kubernetes垃圾回收器GarbageCollector控制器源码分析（一）</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-16T23:14:24+00:00>2019年10月16日</time><span class="px-2 text-primary-500">&#183;</span><span>6943 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>14 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/kubeapiserver%E5%AE%A1%E8%AE%A1%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%92%8C%E9%87%87%E9%9B%86/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/kubeapiserver%E5%AE%A1%E8%AE%A1%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%92%8C%E9%87%87%E9%9B%86/>kube-apiserver审计日志记录和采集</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-18T13:03:22+00:00>2019年10月18日</time><span class="px-2 text-primary-500">&#183;</span><span>3125 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>7 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/k8s%E4%B8%AD%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8ingressnginx%E9%83%A8%E7%BD%B2/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" data-bg=/img/ocean_hu_b887df4ccdbed803.jpg></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/k8s%E4%B8%AD%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8ingressnginx%E9%83%A8%E7%BD%B2/>k8s中负载均衡器【ingress-nginx】部署</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-10-17T14:46:13+00:00>2019年10月17日</time><span class="px-2 text-primary-500">&#183;</span><span>1853 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>4 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/kubernetes/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/ingress-nginx/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Ingress-Nginx</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a></section></div><script>var oid="views_posts/开发一个operator扩展kubernetes的能力.md",oid_likes="likes_posts/开发一个operator扩展kubernetes的能力.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/%E8%BF%9E%E4%B8%8A%E5%85%AC%E5%8F%B8%E7%9A%84vpn%E5%90%8E%E7%94%B5%E8%84%91%E4%B8%8A%E4%B8%8D%E4%BA%86%E5%A4%96%E7%BD%91%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">连上公司的vpn后，电脑上不了外网解决办法</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2019-10-18T13:30:29+00:00>2019年10月18日</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/kubescheduler%E8%B0%83%E5%BA%A6%E6%89%A9%E5%B1%95/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">kube-scheduler调度扩展</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2019-10-18T13:31:42+00:00>2019年10月18日</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script type=text/javascript>var lazyadsense=!1;window.addEventListener("scroll",function(){(0!=document.documentElement.scrollTop&&!1===lazyadsense||0!=document.body.scrollTop&&!1===lazyadsense)&&(!function(){var t,e=document.createElement("script");e.id="g_ads_js",e.type="text/javascript",e.async="async",e.src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3925981084585036",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)}(),lazyadsense=!0)},!0)</script><script>(adsbygoogle=window.adsbygoogle||[]).onload=function(){[].forEach.call(document.getElementsByClassName("adsbygoogle"),function(){adsbygoogle.push({})})}</script><div style="min-height=250px"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-3925981084585036 data-ad-slot=4806125422 data-ad-format=auto data-full-width-responsive=true></ins></div><img style=margin-top:1.5em loading=lazy src=/img/wechat-official-account.jpg alt=公众号二维码><div id=comment></div><script>document.addEventListener("DOMContentLoaded",function(){var t="/js/iDisqus.min.js",e=new IntersectionObserver(function(n){if(n[0].isIntersecting){var s,o=document.createElement("link");o.rel="stylesheet",o.href="/css/iDisqus.min.css",document.head.appendChild(o),s=document.createElement("script"),s.src=t,s.onload=function(){var e=new iDisqus("comment",{forum:"fuckcloudnative",api:"https://disqus.kubeinfo.cn",site:"https://kubeinfo.cn",emojiPath:"https://images.kubeinfo.cn/emoji/",mode:2,timeout:15,init:!0})},document.body.appendChild(s),e.disconnect()}},{threshold:[.1]});e.observe(document.getElementById("comment"))})</script></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden" style=margin-inline:auto;text-align:center><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/tags/ title=Tags>标签</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/categories/ title=Categories>分类</a></li></ul></nav><div class="flex items-center justify-between"></div><script type=text/javascript src=/lib/zoom/zoom.min.min.9727c53d7324a2d82edc7b1192627812e49f1352d0d1f81ca140754cd7b8081a123c5f0924c0c5e2860baa5dd7df12c7283877bbba916620bb07c12401a7c281.js integrity="sha512-lyfFPXMkotgu3HsRkmJ4EuSfE1LQ0fgcoUB1TNe4CBoSPF8JJMDF4oYLql3X3xLHKDh3u7qRZiC7B8EkAafCgQ=="></script><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script><div class=busuanzi style=margin-inline:auto;text-align:center><div class=busuanzi__item><span class="busuanzi__item--label text-neutral-500 dark:text-neutral-400">总访客</span>
<span id=busuanzi_site_uv class="busuanzi__item--number text-neutral-500 dark:text-neutral-400"></span></div><div class=busuanzi__item><span class="busuanzi__item--label text-neutral-500 dark:text-neutral-400">总浏览量</span>
<span id=busuanzi_site_pv class="busuanzi__item--number text-neutral-500 dark:text-neutral-400"></span></div></div><p class="text-sm text-neutral-500 dark:text-neutral-400" style=margin-inline:auto;text-align:center>&copy; 2025 小碗汤<br>本站内容依据
<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh target=_blank>CC BY-SA 4.0</a>
许可证进行授权，转载请附上出处链接。</p><div class=github-badge><span class=badge-subject>构建工具</span><span class="badge-value bg-blue"><a style=color:#fff href=https://gohugo.io/ target=_blank>Hugo v0.144.0</a></span>
<span class=badge-subject>托管于</span><span class="badge-value bg-brightgreen"><a style=color:#fff href=https://github.com/smallersoup/blog target=_blank>Github</a></span>
<span class=badge-subject>图床</span><span class="badge-value bg-orange"><a style=color:#fff href=https://www.jsdelivr.com/ target=_blank>jsDelivr</a></span>
<span class=badge-subject>主题</span><span class="badge-value bg-blue"><a style=color:#fff href=https://github.com/nunocoracao/blowfish target=_blank>Blowfish</a></span></div><section class="text-sm text-neutral-500 dark:text-neutral-400"><span id=span_dt_dt></span><script defer language=javascript>var uptime_1="本站已经开心运行 ",uptime_2=" 天 ",uptime_3=" 小时 ",uptime_4=" 分 ",uptime_5=" 秒";function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("10/30/2020 21:30:15"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=24*60*60*1e3,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=(e_daysold-daysold)*24,hrsold=Math.floor(e_hrsold),e_minsold=(e_hrsold-hrsold)*60,minsold=Math.floor((e_hrsold-hrsold)*60),seconds=Math.floor((e_minsold-minsold)*60),span_dt_dt.innerHTML=uptime_1+daysold+uptime_2+hrsold+uptime_3+minsold+uptime_4+seconds+uptime_5}show_date_time()</script></section><style>.wxtip{background:rgba(0,0,0,.8);text-align:center;position:fixed;left:0;top:0;width:100%;height:100%;z-index:998;display:none}.wxtip-icon{width:52px;height:67px;background:url(img/weixin-tip.png)no-repeat;display:block;position:absolute;right:20px;top:20px}.wxtip-txt{margin-top:107px;color:#fff;font-size:16px;line-height:1.5}</style><div class=wxtip id=JweixinTip><span class=wxtip-icon></span><p class=wxtip-txt>点击屏幕右上角的 ···<br>在弹出的窗口中选择 <span style=color:red>在浏览器中打开</span></p><br><br><p><img loading=lazy style=width:85%;border-radius:10px;display:block;margin-left:auto;margin-right:auto src=/img/wechat-browser.jpg></p></div><script defer>is_weixn_qq()&&(document.getElementById("JweixinTip").style.display="block",document.getElementById("container").style.display="none",document.getElementById("top-grrk").style.display="none");function is_weixn_qq(){var e=navigator.userAgent,t=!!/MicroMessenger/i.test(e),n=!!/QQ\//i.test(e);return!!(t||n)}</script><script defer src=https://wvprxbiaqrgp.hzh.sealos.run/js></script><script>document.addEventListener("DOMContentLoaded",function(){const s=document.getElementById("busuanzi_site_uv"),o=document.getElementById("busuanzi_site_pv"),e=new MutationObserver(t=>{for(let n of t)if(n.type==="childList"){e.disconnect(),n.target.innerHTML=parseInt(n.target.innerHTML)+731632;break}}),t=new MutationObserver(e=>{for(let n of e)if(n.type==="childList"){t.disconnect(),n.target.innerHTML=parseInt(n.target.innerHTML)+1360325;break}}),n={childList:!0};e.observe(s,n),t.observe(o,n)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{var n=["Docker","Containerd","Podman","Kubernetes","KubeEdge","Prometheus","KubeSphere","FastGPT","Envoy","eBPF","KubeNative","Webassembly","WireGuard","Tailscale","Cloud Native"],t=0;document.body.addEventListener("click",function(e){var s,o,i,a,r,l=n[t];t=(t+1)%n.length,s=document.createElement("span"),s.textContent=l,s.style.cssText=`
            z-index: 9999;
            top: ${e.pageY-20}px;
            left: ${e.pageX}px;
            position: absolute;
            font-weight: bold;
            color: ${randomColor()};
            opacity: 1;
            transition: opacity 1.5s;
        `,document.body.appendChild(s),o=null,a=1500,i=e.pageY-20,r=i-160;function c(e){o===null&&(o=e);var t=(e-o)/a;t<1?(s.style.top=i-t*(i-r)+"px",requestAnimationFrame(c)):s.remove()}requestAnimationFrame(c)})});function randomColor(){var e=["#FFDA65","#00BFFF","#cb80ff","#acc2ef","#87CEEB","#FFB6C1"];return e[Math.floor(Math.random()*e.length)]}</script><script>document.addEventListener("DOMContentLoaded",function(){var e=function(e,t){e.forEach(function(e){if(e.isIntersecting){var n=e.target,s=n.getAttribute("data-bg");n.style.backgroundImage="url('"+s+"')",t.unobserve(e.target)}})},t=new IntersectionObserver(e),n=document.querySelectorAll(".thumbnail_card_related, .thumbnail_card");n.forEach(function(e){t.observe(e)})})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://kubeinfo.cn/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>