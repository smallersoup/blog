[{"content":"","date":"2025å¹´6æœˆ23æ—¥","externalUrl":null,"permalink":"/categories/grafana/","section":"Categories","summary":"","title":"Grafana","type":"categories"},{"content":"","date":"2025å¹´6æœˆ23æ—¥","externalUrl":null,"permalink":"/tags/grafana/","section":"Tags","summary":"","title":"Grafana","type":"tags"},{"content":"å‚è€ƒï¼š\nhttps://grafana.com/blog/2024/11/07/how-to-work-with-multiple-data-sources-in-grafana-dashboards-best-practices-to-get-started/\nå®‰è£… 10.2.2 ç‰ˆæœ¬çš„ Grafana ï¼ˆgrafana:10.2.2é•œåƒï¼‰æ˜¯æ”¯æŒæ··åˆæ•°æ®æºçš„ã€‚\nGrafana è¡¨æ ¼å¤§æ–‡æœ¬æ¢è¡Œï¼ˆtext wrapï¼‰ # å‚è€ƒï¼šhttps://community.grafana.com/t/wrapping-text-in-latest-grafana-10-table/110982\nä½¿ç”¨ Overrides ä¸­çš„ Cell value inspect åŠŸèƒ½ï¼Œé¼ æ ‡æ‚¬æµ®åœ¨å¤§å—æ–‡æœ¬ä¸Šæ—¶ï¼Œå³ä¾§ä¼šæ˜¾ç¤ºä¸€ä¸ªçœ¼ç›ğŸ‘çš„å›¾æ ‡ï¼Œç‚¹å‡»ä¼šä¼šå¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†æ¥é¢„è§ˆå¤§æ®µæ–‡æœ¬ã€‚\nCell value inspect\nEnable cell value inspection in a modal window\nä½ æåˆ°çš„â€œGrafana å…¬å¼€é¢æ¿â€ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯å°† Grafana çš„æŸä¸ª dashboardï¼ˆä»ªè¡¨ç›˜ï¼‰æˆ– panelï¼ˆå•ç‹¬é¢æ¿ï¼‰é€šè¿‡äº’è”ç½‘å…¬å¼€ç»™ä»»ä½•äººè®¿é—®ï¼Œè€Œæ— éœ€ç™»å½•æƒé™ã€‚\nGrafana å…¬å¼€é¢æ¿ # 1. åŒ¿åè®¿é—®ï¼ˆAnonymous Accessï¼‰ # Grafana æ”¯æŒåŒ¿åè®¿é—®ï¼Œå¯ä»¥å…è®¸æ‰€æœ‰ç”¨æˆ·æ— éœ€ç™»å½•å³å¯è®¿é—®ç‰¹å®šçœ‹æ¿ã€‚è¿™ç§æ–¹å¼é€šå¸¸åœ¨å†…ç½‘æˆ–è€…å¯¹å®‰å…¨è¦æ±‚ä¸é«˜çš„åœºæ™¯ä½¿ç”¨ã€‚\nè®¾ç½®æ–¹æ³•ï¼š\nç¼–è¾‘ grafana.ini é…ç½®æ–‡ä»¶ æ‰¾åˆ°å¹¶ä¿®æ”¹å¦‚ä¸‹å†…å®¹ï¼š [auth.anonymous] enabled = true org_role = Viewer é‡å¯ Grafana æœåŠ¡ è¿™æ ·æ‰€æœ‰äººæ‰“å¼€ Grafana åœ°å€éƒ½å¯ä»¥ä»¥ Viewerï¼ˆæµè§ˆè€…ï¼‰æƒé™è®¿é—®æ‰€æœ‰ dashboardã€‚\n2. é¢æ¿å¿«ç…§ï¼ˆDashboard/Panel Snapshotï¼‰ # å°†å•ä¸ªé¢æ¿æˆ–æ•´ä¸ª dashboard åˆ¶ä½œæˆ å¿«ç…§ï¼ˆSnapshotï¼‰ï¼Œä¼šç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„è®¿é—®é“¾æ¥ï¼Œæ•°æ®ä¼šâ€œé™æ€å¿«ç…§â€åœ¨æ­¤é“¾æ¥ä¸Šã€‚\nåœ¨ä»ªè¡¨ç›˜ä¸Šç‚¹â€œShareâ€â†’â€œSnapshotâ€â†’â€œPublish Snapshotâ€ å¤åˆ¶äº§ç”Ÿçš„å…¬å¼€ URLï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—® æ³¨æ„ï¼šå…¬å¼€å¿«ç…§çš„æ•°æ®ä¸ºä½ å¯¼å‡ºé‚£ä¸€åˆ»çš„å¿«ç…§ï¼Œä¸ä¼šè‡ªåŠ¨æ›´æ–° 3. å…±äº«é“¾æ¥ï¼ˆShare Linkï¼‰â€”â€”ï¼ˆç™»å½•æƒ…å†µä¸‹ä½¿ç”¨ï¼‰ # é€šè¿‡â€œShareâ€æŒ‰é’®å¤åˆ¶ dashboard æˆ–é¢æ¿çš„é“¾æ¥ï¼Œä½†å—æƒé™æ§åˆ¶ï¼Œå¤–éƒ¨ç”¨æˆ·æ— æ³•ç›´æ¥è®¿é—®ã€‚\n4. åå‘ä»£ç†å’Œè®¿é—®æ§åˆ¶ # ä½ ä¹Ÿå¯ä»¥é€šè¿‡ Nginxã€Apache ç­‰è®¾ç½®åå‘ä»£ç†ï¼Œä¸ºéƒ¨åˆ†é¢æ¿è®¾ç½®å¼€æ”¾çš„ URLï¼Œä½†æœ¬è´¨ä¸Šè¿˜æ˜¯ä¾èµ– Grafana åç«¯æƒé™é…ç½®ã€‚\n5. Embeddingï¼ˆåµŒå…¥å¤–éƒ¨é¡µé¢ï¼‰ # ç”¨ IFrame ç­‰æ–¹å¼å°†é¢æ¿åµŒå…¥è‡ªå·±çš„ç½‘é¡µï¼Œå‰æ Grafana è®¾ç½®æˆåŒ¿åå¯è®¿é—®ã€‚ å‚è€ƒ Share é¢æ¿â†’Embed æ³¨æ„äº‹é¡¹ # å®‰å…¨æ€§ï¼šå½»åº•çš„â€œå…¬å¼€â€æ„å‘³ç€æ‰€æœ‰æ•°æ®éƒ½å¯¹å¤–æš´éœ²ï¼Œæ…é‡å¯¹å¾…æ•æ„Ÿæˆ–ä¸ªäººæ•°æ®ã€‚ ä½¿ç”¨åœºæ™¯ï¼šå»ºè®®ä¸´æ—¶å±•ç¤ºã€æ¼”ç¤ºç­‰éé‡è¦åœºæ™¯ä½¿ç”¨å…¬å¼€é¢æ¿ã€‚ æ•°æ®åˆ·æ–°ï¼šPanel Snapshot æ˜¯é™æ€çš„ï¼Œä¸ä¼šå®æ—¶åˆ·æ–°ã€‚ æ€»ç»“ # è¦è®©â€œGrafana å…¬å¼€é¢æ¿â€ï¼Œæ¨èä½¿ç”¨åŒ¿åè®¿é—®æˆ–å¿«ç…§åˆ†äº«çš„æ–¹æ³•ã€‚ å¼ºçƒˆå»ºè®®æ ¹æ®ä¸šåŠ¡éœ€æ±‚æƒè¡¡æ•°æ®å®‰å…¨å’Œæ˜“ç”¨æ€§ã€‚ å¦‚éœ€å…·ä½“é…ç½®æ“ä½œæŒ‡å¯¼ï¼Œè¯·è¯´æ˜ä½ ç”¨çš„æ˜¯å“ªç§ Grafana éƒ¨ç½²æ–¹å¼ï¼ˆDockerã€æœ¬åœ°ã€äº‘ç­‰ï¼‰å’Œç‰ˆæœ¬ã€‚\nGrafana è¡¨æ ¼æ•°æ®å¯¼å‡º # åœ¨é¢æ¿çš„ Inspect ä¸­å¯¼å‡ºï¼Œæ”¯æŒå¤šæ•°æ®æºçš„æ•°æ®ç»„åˆå¯¼å‡ºã€‚\nApply panel transformations\nTable data is displayed with transformations defined in the panel Transform tab.\n","date":"2025å¹´6æœˆ23æ—¥","externalUrl":null,"permalink":"/posts/grafana-%E4%B8%80%E4%B8%AA%E9%9D%A2%E6%9D%BF%E9%85%8D%E7%BD%AE%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/","section":"Posts","summary":"\u003cp\u003eå‚è€ƒï¼š\u003cbr /\u003e\n\n\u003ca href=\"https://kubeinfo.cn/go/?target=aHR0cHM6Ly9ncmFmYW5hLmNvbS9ibG9nLzIwMjQvMTEvMDcvaG93LXRvLXdvcmstd2l0aC1tdWx0aXBsZS1kYXRhLXNvdXJjZXMtaW4tZ3JhZmFuYS1kYXNoYm9hcmRzLWJlc3QtcHJhY3RpY2VzLXRvLWdldC1zdGFydGVkLw%3d%3d\" target=\"_blank\" \u003ehttps://grafana.com/blog/2024/11/07/how-to-work-with-multiple-data-sources-in-grafana-dashboards-best-practices-to-get-started/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eå®‰è£… 10.2.2 ç‰ˆæœ¬çš„ Grafana ï¼ˆgrafana:10.2.2é•œåƒï¼‰æ˜¯æ”¯æŒæ··åˆæ•°æ®æºçš„ã€‚\u003c/p\u003e","title":"Grafana ä¸€ä¸ªé¢æ¿é…ç½®å¤šæ•°æ®æº","type":"posts"},{"content":"I am a Cloud Native engineer based in Beijing, China. With a passion for leveraging modern technologies, I specialize in designing, developing, and managing scalable, reliable, and efficient cloud-native applications. My expertise spans across cloud services, containerization, microservices architecture, and more.\nKubeSphere Console is the web-based UI for KubeSphere Cloud Native ","date":"15 September 2021","externalUrl":null,"permalink":"/en/","section":"Advance into Cloud Native","summary":"\u003cp\u003eI am a Cloud Native engineer based in Beijing, China. With a passion for leveraging modern technologies, I specialize in designing, developing, and managing scalable, reliable, and efficient cloud-native applications. My expertise spans across cloud services, containerization, microservices architecture, and more.\u003c/p\u003e","title":"Advance into Cloud Native","type":"page"},{"content":"","date":"15 September 2021","externalUrl":null,"permalink":"/en/categories/aigc/","section":"Categories","summary":"","title":"AIGC","type":"categories"},{"content":" Build an Image Search System in 5 Minutes # Vectors and Vector Databases # In mathematics, a vector is an object that can represent multiple dimensions or characteristics. In our daily life, it can also be used to describe multiple attributes of an object.\nFor example, to describe an apple, we need to focus on its features (like variety), origin, color, size, and sweetness. We can treat these attributes as multiple dimensions of the apple and then represent the apple with a vector.\nFor instance, if we define each element of the vector to represent:\nFeature (e.g., 1 for Fuji apple, 2 for Granny Smith) Origin (e.g., 1 for Luochuan, 2 for Yantai) Color (e.g., 1 for red, 2 for green) Size (based on actual weight, e.g., 150 means the apple weighs 150 grams, 200 means 200 grams) Sweetness (e.g., 1 for very sweet, 0.5 for average, 0 for not sweet) Then a Fuji apple from Yantai, red in color, weighing 150 grams, and with sweetness 0.8, can be represented by the vector [1, 2, 1, 150, 0.8]. This vector comprehensively describes all the attributes of the apple.\nThis is the concept of vectors. In artificial intelligence and machine learning, we can vectorize and store complex data types such as audio, images, and text. Traditional databases are primarily designed for handling structured data, but they are inefficient when processing complex data types.\nIn contrast, vector databases support multiple types of indexes and similarity computation methods, efficiently storing and querying large-scale vector data.\nApplications of Vector Databases # Imagine one day you eat a delicious dish at a restaurant but don\u0026rsquo;t know its name or how to make it. You could take a photo of the dish and use an image search feature to find similar dishes and their recipes online.\nConsider an online recipe platform that stores numerous dish images and corresponding recipes. Each dish image has its features extracted and stored as an embedding vector in a vector database.\nWhen the user uploads a photo of a dish for searching, the platform first extracts features from the photo to generate an embedding vector, then searches for the most similar dish images in the vector database.\nThe search results return similar dish images along with their recipes. Users can browse these recipes to find the dish they want to make.\nThis image search feature helps users find the recipes they like and discover new dishes they might enjoy. For the recipe platform, it\u0026rsquo;s an effective way to attract and retain users.\nAdditionally, image search technology has many practical applications in daily life, such as recommending similar products or assisting law enforcement in recognizing faces in surveillance videos to improve crime-solving efficiency.\nAll these applications require a high-performance vector database. In this article, we will build an image search system to experience the entire workflow firsthand.\nTencent Cloud Vector Database # The Tencent Cloud Vector Database offers powerful capabilities for storing, retrieving, and analyzing large amounts of multi-dimensional vector data, supporting up to 1 billion single-index vectors, millions of QPS, and millisecond-level query latency. Currently, it serves thousands of customers stably, and we can create a vector database instance within minutes.\nTesting Version: Single availability zone, single node.\nThe entire creation process takes about 1-2 minutes. Refresh the instance list to see the created instance.\nRetrieve the password for username root from the key management, which will be used later:\nEnable external access: You can use the system-assigned domain name and port to access the vector database externally:\nIt takes about 10 seconds to take effect. Note down the generated domain (HOST) and port (PORT).\nConfigure the whitelist: For testing purposes, the whitelist IP range can be set to 0.0.0.0/0, meaning open to all IPs.\nTest external connectivity with the following command:\ncurl -i -X POST \\ -H \u0026#39;Content-Type: application/json\u0026#39; \\ -H \u0026#39;Authorization: Bearer account=root\u0026amp;api_key=A5VOgsMpGWJhUI0WmUbY********************\u0026#39; \\ http://10.0.X.X:80/database/create \\ -d \u0026#39;{ \u0026#34;database\u0026#34;: \u0026#34;db-test\u0026#34; }\u0026#39; It returns the result as follows. If it fails to connect or times out, the whitelist configuration is incorrect.\n{\u0026#34;code\u0026#34;:0,\u0026#34;msg\u0026#34;:\u0026#34;operation success\u0026#34;,\u0026#34;affectedCount\u0026#34;:1} Image Search Example # We will use Towhee and Tencent Cloud Vector Database to build a reverse image search system.\nTowhee is an open-source framework for building powerful data pipelines. It can efficiently handle various data transformation tasks.\nThis system takes an image as input and retrieves the most similar images based on the content of the image. The basic idea is to use a pre-trained deep learning model to extract the features from each image and represent it as an embedding vector. Then, by storing and comparing these image embedding vectors, we can implement image retrieval.\nThe workflow is as follows:\nFirst, use Towhee to preprocess the input image and extract features to obtain the image embedding vector. Then, store this embedding vector into the vector database. When an image needs to be queried, preprocess and extract features from the query image to get the query image embedding vector. Perform similarity search in the vector database using this vector, and the vector database will return the top k similar vectors.\nCreate Project # We will explain the important code parts below. The final demo code, which is available at the end of the article, can be run locally. This is very friendly for beginners.\nCreate a new project directory: mkdir -p image-search cd image-search Create a new Python virtual environment (optional but recommended): $ python -V Python 3.9.0 $ python -m venv venv Creating a new Python virtual environment can effectively isolate project dependencies and simplify dependency management.\nActivate the virtual environment:\nLinux/macOS: source venv/bin/activate Windows: .\\venv\\Scripts\\activate Install the required Python packages: python -m pip install -q towhee opencv-python pillow tcvectordb This command will install the Towhee, OpenCV, Pillow, and tcvectordb libraries into the virtual environment venv.\nPrepare Data # Here, we use a subset of the ImageNet dataset (100 categories). Sample data can be obtained on GitHub.\ncurl -L https://github.com/towhee-io/examples/releases/download/data/reverse_image_search.zip -O unzip -q -o reverse_image_search.zip The ImageNet dataset is a large-scale visual dataset widely used in deep learning for image classification and object detection tasks. In this article, we use a subset of ImageNet, which provides a suitable scale and complexity for model training and validation.\nThe directory structure is as follows:\ntrain: Contains candidate images, with 100 different categories, each category containing 10 images. test: Contains query images, with the same 100 categories as the training set, but each category has only 1 image. reverse_image_search.csv: A CSV file containing the id, path, and labels of each training image. Candidate images are the images that can be retrieved, and query images are the images used for retrieval.\nConnect to Database and Create Collection # Connecting to Tencent Vector DB is straightforward. The official SDK supports multiple languages. In this article, we use the Python SDK: tcvectordb to operate the vector database.\nFirst, use the tcvectordb SDK to write the client code for connecting to the vector database:\nclass TcvdbClient(PyOperator): def __init__(self, host: str, port: str, username: str, key: str, dbName: str, collectionName: str, timeout: int = 20): # Initialize client \u0026#34;\u0026#34;\u0026#34; self.collectionName = collectionName self.db_name = dbName self._client = tcvectordb.VectorDBClient(url=\u0026#34;http://\u0026#34; + host + \u0026#34;:\u0026#34; + port, username=username, key=key, read_consistency=ReadConsistency.EVENTUAL_CONSISTENCY, timeout=timeout) Then, call TcvdbClient to create the client:\n# tcvdb parameters HOST = \u0026#39;lb-xxxx.clb.ap-beijing.tencentclb.com\u0026#39; PORT = \u0026#39;10000\u0026#39; DB_NAME = \u0026#39;image-search\u0026#39; COLLECTION_NAME = \u0026#39;reverse_image_search\u0026#39; PASSWORD = \u0026#39;xxxx\u0026#39; USERNAME = \u0026#39;root\u0026#39; # path to csv (column_1 indicates image path) OR a pattern of image paths INSERT_SRC = \u0026#39;reverse_image_search.csv\u0026#39; test_vdb = TcvdbClient(host=HOST, port=PORT, key=\u0026#39;6qlvBkF0xAgZoN7VJbcwLCqrxoSS4J63Q7mu4RgF\u0026#39;, username=\u0026#39;root\u0026#39;, collectionName=COLLECTION_NAME, dbName=DB_NAME) The HOST, PORT, USERNAME, and PASSWORD above are obtained after applying for the vector database.\nCreate DB and Collection in the vector database:\nclass TcvdbClient(PyOperator): def create_db_and_collection(self): database = self.db_name coll_embedding_name = self.collectionName coll_alias = self.collectionName + \u0026#34;-alias\u0026#34; # Create DB db = self._client.create_database(database) # Build Collection index = Index() index.add(VectorIndex(\u0026#39;vector\u0026#39;, 2048, IndexType.HNSW, MetricType.COSINE, HNSWParams(m=16, efconstruction=200))) index.add(FilterIndex(\u0026#39;id\u0026#39;, FieldType.String, IndexType.PRIMARY_KEY)) index.add(FilterIndex(\u0026#39;path\u0026#39;, FieldType.String, IndexType.FILTER)) # Create Collection db.create_collection( name=coll_embedding_name, shard=3, replicas=0, description=\u0026#39;image embedding collection\u0026#39;, index=index, embedding=None, timeout=20 ) test_vdb.create_db_and_collection() The above code creates a Collection with three indexes. In a vector database, Collection is the primary structure for storing and retrieving vectors. Creating index fields can be used as filtering in retrieval.\nvector: The index has 2048 vector dimensions. The more dimensions, the more information the vector can represent, but it also increases computational complexity and storage requirements. IndexType.HNSW: The type of index. This is an approximate nearest neighbor search algorithm to accelerate high-dimensional vector search. MetricType.COSINE: Cosine similarity, which measures the angle between two vectors and is commonly used to measure high-dimensional vector similarity. id: The primary key index, used to uniquely identify each vector. path: The filter index to accelerate queries based on the path field. After creation, you can conveniently view and manage the vector database data through the Database Management Console (DMC):\nDMC access link: https://dms.cloud.tencent.com/\nHere is the newly created DB and Collection:\nEmbedding: Image to Vector, Insert into Database # In machine learning, embedding is the process of converting raw input data such as text, images, and audio into a form more suitable for machine learning, i.e., converting complex data structures (like images or text) into fixed-length vectors.\nBelow, we use Towheeâ€™s pipeline to implement image feature extraction and vector storage:\nMODEL = \u0026#39;resnet50\u0026#39; DEVICE = None # if None, use default device (cuda is enabled if available) INSERT_SRC = \u0026#39;reverse_image_search.csv\u0026#39; # Embedding pipeline p_embed = ( pipe.input(\u0026#39;src\u0026#39;) .flat_map(\u0026#39;src\u0026#39;, \u0026#39;img_path\u0026#39;, load_image) .map(\u0026#39;img_path\u0026#39;, \u0026#39;img\u0026#39;, ops.image_decode()) .map(\u0026#39;img\u0026#39;, \u0026#39;vec\u0026#39;, ops.image_embedding.timm(model_name=MODEL, device=DEVICE)) ) # Display embedding result, no need for implementation p_display = p_embed.output(\u0026#39;img_path\u0026#39;, \u0026#39;img\u0026#39;, \u0026#39;vec\u0026#39;) DataCollection(p_display(\u0026#39;./test/goldfish/*.JPEG\u0026#39;)).show() # Insert pipeline p_insert = ( p_embed.map((\u0026#39;img_path\u0026#39;, \u0026#39;vec\u0026#39;), \u0026#39;mr\u0026#39;, ops.local.tcvdb_client( host=HOST, port=PORT, key=PASSWORD, username=USERNAME, collectionName=COLLECTION_NAME, dbName=DB_NAME )) .output(\u0026#39;mr\u0026#39;) ) # Insert data p_insert(INSERT_SRC) The Embedding Pipeline defines a pipeline p_embed that loads the images in reverse_image_search.csv, calls ops.image_embedding.timm(), and uses the resnet50 model to convert the image data into embedding vectors.\nTowhee provides a pre-trained ResNet50 model that can convert images into vectors. ResNet50 is a deep convolutional neural network that performs well in many image recognition tasks. This model learns important features of images and embeds these features into a high-dimensional vector referred to as an embedding vector.\nThe Display Pipeline defines a pipeline p_display used to display the results of p_embed.\nThe Insert Pipeline defines a pipeline p_insert to insert the embedding vectors into the vector database.\np_insert(INSERT_SRC) uses the p_insert pipeline to handle the image data in the reverse_image_search.csv file.\nUltimately, it calls ops.local.search_tcvdb_client to insert the generated vectors into the vector database:\ndef __call__(self, *data): path = \u0026#34;\u0026#34; vector = [] for item in data: if isinstance(item, np.ndarray): # Convert ndarray to list and float32 to float vector = list(map(float, item)) else: path = item # Generate a random UUID and convert to string document_list = [ Document( id=str(uuid.uuid4()), path=path, vector=vector), ] db = self._client.database(self.db_name) coll = db.collection(self.collectionName) coll.upsert(documents=document_list) You can use the fields with indexes created before to filter and accurately query the inserted data in DMC, for example, search: path=\u0026quot;./train/goldfish/n01443537_1903.JPEG\u0026quot;:\nSince vector data is generally large, it will not be returned by default. If you need to return the vector field, check retrieveVector.\nSearch Similar Images # Define a search pipeline p_search to search for images most similar to the input image in the vector database, then display the search results.\nThe pre-search pipeline p_search_pre uses the p_embed pipeline to generate the embedding vector vec for the query image.\n# Search pipeline p_search_pre = ( p_embed.map(\u0026#39;vec\u0026#39;, (\u0026#39;search_res\u0026#39;), ops.local.search_tcvdb_client( host=HOST, port=PORT, key=PASSWORD, username=USERNAME, collectionName=COLLECTION_NAME, dbName=DB_NAME)) .map(\u0026#39;search_res\u0026#39;, \u0026#39;pred\u0026#39;, lambda x: [str(Path(y[0]).resolve()) for y in x]) ) p_search = p_search_pre.output(\u0026#39;img_path\u0026#39;, \u0026#39;pred\u0026#39;) # Search for example query image(s) dc = p_search(\u0026#39;test/goldfish/*.JPEG\u0026#39;) DataCollection(dc).show() Then apply a lambda function to each element to convert each element to a file path and store the result in pred.\nCall the ops.local.search_tcvdb_client function to connect to the vector database and search for the vectors most similar to vec, storing the search results in search_res.\nclass SearchTcvdbClient(PyOperator): def __call__(self, query: \u0026#39;ndarray\u0026#39;): tcvdb_result = self.query_data( query, **self.kwargs ) result = [] for hit in tcvdb_result[0]: row = [] row.extend([hit[\u0026#34;path\u0026#34;], hit[\u0026#34;score\u0026#34;]]) result.append(row) return result def query_data(self, query: [], **kwargs): # Obtain Collection object db = self._client.database(self.db_name) coll = db.collection(self.collectionName) vector = query if isinstance(query, np.ndarray): # Convert ndarray to list and float32 to float vector = list(map(float, query)) # search provides the ability to search by vector # Batch similarity query, find multiple Top K similar results based on specified multiple vectors res = coll.search( vectors=[vector], # Specify search vector retrieve_vector=False, # Whether to return the vector field, False: do not return, True: return limit=10, # Specify the K value of Top K ) return res Output of the Search Pipeline p_search # img_path: Path of the query image. pred: List of paths of similar images found. We use the p_search pipeline to search for images similar to test/goldfish/*.JPEG. The results are displayed using Towhee\u0026rsquo;s DataCollection.\n+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | img_path | pred | +===================================+=========================================================================================================================================================================+ | test/goldfish/n01443537_3883.JPEG | [/root/image-search/reverse_image_search/train/goldfish/n01443537_1903.JPEG,/root/image-search/reverse_image_search/train/goldfish/n01443537_2819.JPEG,...] len=10 | +-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ The DataCollection.show() function omits some data when displaying large datasets to prevent overwhelming the screen.\nSimilarly, if you have the vector of an image, you can use DMC to query information about similar images by vector. The results are sorted by score in descending order, with a higher score indicating higher similarity.\nIntegrating Gradio # Feel that the code demonstration above is not friendly enough for non-technical users?\nWe can use Gradio to provide a web UI to showcase the queries and results more visually and interactively. In just a few seconds, we can present the workflow in a web UI form. This allows users to search by directly uploading images and displaying similar images in the interface.\nFor demonstration purposes, the following will search and display similar images by inputting image paths.\ndef search_and_show_images(file_path): # Use `file_path` for the search and return result paths results = p_search(file_path) # Retrieve data from \u0026#39;DataQueue\u0026#39; object data = results.get() # Get result list pred = data[1] return pred iface = gr.Interface( fn=search_and_show_images, inputs=gr.inputs.Textbox(default=\u0026#39;test/goldfish/*.JPEG\u0026#39;), outputs=gr.Gallery(label=\u0026#34;Result Images\u0026#34;).style(height=\u0026#39;auto\u0026#39;, columns=4), title=\u0026#39;Tencent Vector DB Example: Image Search\u0026#39;, ) iface.launch() The search_and_show_images function will return data like the following, which eventually displays the image paths in the web UI.\n[ \u0026#39;/root/image-search/reverse_image_search/train/cuirass/n03146219_11082.JPEG\u0026#39;, \u0026#39;/root/image-search/reverse_image_search/train/loudspeaker/n03691459_40992.JPEG\u0026#39; ] Launch the project. Open your browser to http://127.0.0.1:7860 to see the final result.\nInput: test/goldfish/*.JPEG returns results containing fish.\nInput: test/Afghan_hound/n02088094_4261.JPEG returns results containing dogs.\nSummary # For building systems like image search, text-to-video, and private domain chatbots, Tencent Cloud Vector Database demonstrates remarkable advantages due to its excellent stability, performance, ease of use, and convenient maintenance. Backed by a major company, Tencent Cloud Vector Database has become a leader in the AI field.\nDemo code available at: https://github.com/smallersoup/image-search\n","date":"15 September 2021","externalUrl":null,"permalink":"/en/posts/build-an-image-search-system-in-5-minutes/","section":"Posts","summary":"\u003ch1 class=\"relative group\"\u003eBuild an Image Search System in 5 Minutes \n    \u003cdiv id=\"build-an-image-search-system-in-5-minutes\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#build-an-image-search-system-in-5-minutes\" aria-label=\"Anchor\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h1\u003e\n\n\u003ch2 class=\"relative group\"\u003eVectors and Vector Databases \n    \u003cdiv id=\"vectors-and-vector-databases\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#vectors-and-vector-databases\" aria-label=\"Anchor\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eIn mathematics, a vector is an object that can represent multiple dimensions or characteristics. In our daily life, it can also be used to describe multiple attributes of an object.\u003c/p\u003e","title":"Build an Image Search System in 5 Minutes","type":"posts"},{"content":"","date":"15 September 2021","externalUrl":null,"permalink":"/en/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","date":"15 September 2021","externalUrl":null,"permalink":"/en/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":"","date":"15 September 2021","externalUrl":null,"permalink":"/en/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"","date":"15 September 2021","externalUrl":null,"permalink":"/en/tags/towhee/","section":"Tags","summary":"","title":"Towhee","type":"tags"},{"content":" æ‰‹æŠŠæ‰‹å¸¦ä½  5 åˆ†é’Ÿæ„å»ºä»¥å›¾æœå›¾ç³»ç»Ÿ # å‘é‡å’Œå‘é‡æ•°æ®åº“ # å‘é‡åœ¨æ•°å­¦ä¸­æ˜¯ä¸€ä¸ªå¯ä»¥è¡¨ç¤ºå¤šä¸ªç»´åº¦æˆ–ç‰¹æ€§çš„å¯¹è±¡ã€‚åœ¨æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æè¿°ä¸€ä¸ªç‰©ä½“çš„å¤šä¸ªå±æ€§ã€‚\næ¯”å¦‚ï¼Œæˆ‘ä»¬è¦æè¿°ä¸€ä¸ªè‹¹æœï¼Œéœ€è¦å…³æ³¨å®ƒçš„ç‰¹å¾ï¼ˆå¦‚å“ç§ï¼‰ã€äº§åœ°ã€é¢œè‰²ã€å¤§å°å’Œç”œåº¦ç­‰å±æ€§ã€‚æˆ‘ä»¬å¯ä»¥æŠŠè¿™äº›å±æ€§çœ‹ä½œæ˜¯è‹¹æœçš„å¤šä¸ªç»´åº¦ï¼Œç„¶åç”¨ä¸€ä¸ªå‘é‡æ¥è¡¨ç¤ºè¿™ä¸ªè‹¹æœã€‚\nä¾‹å¦‚ï¼Œè®¾å®šå‘é‡çš„æ¯ä¸€ä¸ªå…ƒç´ åˆ†åˆ«ä»£è¡¨ï¼š\nç‰¹å¾ï¼ˆå¦‚ï¼Œ1 ä»£è¡¨çº¢å¯Œå£«è‹¹æœï¼Œ2 ä»£è¡¨å›½å…‰è‹¹æœï¼‰ äº§åœ°ï¼ˆå¦‚ï¼Œ1 ä»£è¡¨æ´›å·ï¼Œ2 ä»£è¡¨çƒŸå°ï¼‰ é¢œè‰²ï¼ˆå¦‚ï¼Œ1 ä»£è¡¨çº¢è‰²ï¼Œ2 ä»£è¡¨ç»¿è‰²ï¼‰ å¤§å°ï¼ˆä»¥å®é™…é‡é‡ä¸ºå‡†ï¼Œå¦‚ï¼Œ150 ä»£è¡¨è‹¹æœé‡ 150 å…‹ï¼Œ200 ä»£è¡¨è‹¹æœé‡ 200 å…‹ï¼‰ ç”œåº¦ï¼ˆå¦‚ï¼Œ1 ä»£è¡¨éå¸¸ç”œï¼Œ0.5 ä»£è¡¨ä¸€èˆ¬ï¼Œ0 ä»£è¡¨ä¸ç”œï¼‰ é‚£ä¹ˆä¸€ä¸ªçº¢å¯Œå£«è‹¹æœï¼Œäº§åœ°åœ¨çƒŸå°ï¼Œé¢œè‰²ä¸ºçº¢è‰²ï¼Œé‡é‡ä¸º 150 å…‹ï¼Œç”œåº¦ä¸º 0.8 çš„å‘é‡å°±å¯ä»¥è¡¨ç¤ºä¸º [1, 2, 1, 150, 0.8]ã€‚é€šè¿‡è¿™ä¸ªå‘é‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥å…¨é¢åœ°æè¿°è¿™ä¸ªè‹¹æœçš„æ‰€æœ‰å±æ€§ã€‚\nè¿™å°±æ˜¯å‘é‡çš„æ¦‚å¿µã€‚åœ¨äººå·¥æ™ºèƒ½å’Œæœºå™¨å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†éŸ³é¢‘ã€å›¾åƒã€å¤æ‚çš„æ–‡æœ¬å‘é‡åŒ–åå­˜å‚¨ã€‚ä¼ ç»Ÿçš„æ•°æ®åº“ä¸»è¦æ˜¯ä¸ºå¤„ç†ç»“æ„åŒ–æ•°æ®è®¾è®¡çš„ï¼Œç„¶è€Œï¼Œå¯¹äºå¤æ‚çš„æ•°æ®ç±»å‹ï¼Œä¼ ç»Ÿçš„æ•°æ®åº“å¤„ç†èµ·æ¥æ•ˆç‡ä½ä¸‹ã€‚\nç›¸æ¯”ä¹‹ä¸‹ï¼Œå‘é‡æ•°æ®åº“æ”¯æŒå¤šç§ç´¢å¼•ç±»å‹å’Œç›¸ä¼¼æ€§è®¡ç®—æ–¹æ³•ï¼Œä¸”èƒ½å¤Ÿé«˜æ•ˆåœ°å­˜å‚¨å’ŒæŸ¥è¯¢å¤§è§„æ¨¡çš„å‘é‡æ•°æ®ã€‚\nå‘é‡æ•°æ®åº“çš„åº”ç”¨ # å‡è®¾æœ‰ä¸€å¤©ï¼Œä½ åœ¨ä¸€å®¶é¤å…åƒåˆ°äº†ä¸€é“éå¸¸ç¾å‘³çš„èœï¼Œä½†ä½ å¹¶ä¸çŸ¥é“å®ƒçš„åå­—æˆ–å¦‚ä½•åˆ¶ä½œã€‚ä½ å¯ä»¥æ‹ä¸‹è¿™é“èœçš„ç…§ç‰‡ï¼Œç„¶åé€šè¿‡ä»¥å›¾æœå›¾çš„åŠŸèƒ½ï¼Œåœ¨çº¿æœç´¢ç±»ä¼¼çš„èœå“å’Œå¯¹åº”çš„èœè°±ã€‚\nå‡è®¾ä¸€ä¸ªåœ¨çº¿èœè°±å¹³å°ï¼Œå­˜å‚¨äº†å¤§é‡çš„èœå“å›¾ç‰‡å’Œå¯¹åº”çš„èœè°±ã€‚æ¯ä¸€å¼ èœå“å›¾ç‰‡éƒ½ç»è¿‡ç‰¹å¾æå–ï¼Œç”Ÿæˆäº†ç›¸åº”çš„åµŒå…¥å‘é‡ï¼Œå¹¶å­˜å‚¨åœ¨å‘é‡æ•°æ®åº“ä¸­ã€‚\nå½“ç”¨æˆ·ä¸Šä¼ ä¸€å¼ èœå“ç…§ç‰‡è¿›è¡Œæœç´¢æ—¶ï¼Œå¹³å°ä¼šå…ˆå¯¹è¿™å¼ ç…§ç‰‡è¿›è¡ŒåŒæ ·çš„ç‰¹å¾æå–ï¼Œç”Ÿæˆä¸€ä¸ªåµŒå…¥å‘é‡ï¼Œç„¶ååœ¨å‘é‡æ•°æ®åº“ä¸­æœç´¢ä¸ä¹‹æœ€ç›¸ä¼¼çš„èœå“å›¾ç‰‡ã€‚\næœç´¢ç»“æœä¼šè¿”å›ä¸€ç³»åˆ—ç›¸ä¼¼çš„èœå“å›¾ç‰‡ä»¥åŠå®ƒä»¬å¯¹åº”çš„èœè°±ã€‚ç”¨æˆ·å¯ä»¥æµè§ˆè¿™äº›èœè°±ï¼Œæ‰¾åˆ°ä»–ä»¬æƒ³è¦çš„èœå“ï¼Œå­¦ä¹ å¦‚ä½•åˆ¶ä½œè¿™é“èœã€‚\nè¿™ç§ä»¥å›¾æœå›¾çš„åŠŸèƒ½ä¸ä»…å¯ä»¥å¸®åŠ©ç”¨æˆ·æ‰¾åˆ°ä»–ä»¬å–œæ¬¢çš„èœè°±ï¼Œè¿˜å¯ä»¥å¸®åŠ©ä»–ä»¬å‘ç°æ–°çš„ã€å¯èƒ½ä¼šå–œæ¬¢çš„èœå“ã€‚è¿™å¯¹äºèœè°±å¹³å°æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ç§å¸å¼•ç”¨æˆ·ã€å¢åŠ ç”¨æˆ·ç²˜æ€§çš„æœ‰æ•ˆæ–¹å¼ã€‚\næ­¤å¤–ï¼Œä»¥å›¾æœå›¾çš„æŠ€æœ¯åœ¨ç”Ÿæ´»ä¸­è¿˜æœ‰è®¸å¤šå®é™…åº”ç”¨æ¡ˆä¾‹ï¼Œå¦‚ï¼šè´­ç‰©æ¨èç±»ä¼¼å•†å“ã€å…¬å®‰å¯¹ç›‘æ§è§†é¢‘ä¸­çš„äººè„¸è¿›è¡Œè¯†åˆ«ï¼Œæé«˜ç ´æ¡ˆæ•ˆç‡ã€‚\nä»¥ä¸Šè¿™äº›éƒ½ç¦»ä¸å¼€ä¸€ä¸ªé«˜æ€§èƒ½çš„å‘é‡æ•°æ®åº“ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ­å»ºä¸€å¥—ä»¥å›¾æœå›¾çš„ç³»ç»Ÿï¼Œæ¥äº²è‡ªä½“éªŒæ•´ä¸ªå·¥ä½œæµç¨‹ã€‚\nè…¾è®¯äº‘å‘é‡æ•°æ®åº“ # è…¾è®¯äº‘å‘é‡æ•°æ®åº“æä¾›äº†å¼ºå¤§çš„å­˜å‚¨ã€æ£€ç´¢ã€åˆ†æå¤§é‡å¤šç»´å‘é‡æ•°æ®çš„èƒ½åŠ›ï¼Œå¯æ”¯æŒ 10 äº¿çº§å•ç´¢å¼•å‘é‡è§„æ¨¡ã€ç™¾ä¸‡çº§ QPS åŠæ¯«ç§’çº§æŸ¥è¯¢å»¶è¿Ÿã€‚ç›®å‰å·²ç¨³å®šæœåŠ¡ä¸Šåƒå®¶å®¢æˆ·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆ†é’Ÿå†…åˆ›å»ºä¸€ä¸ªå‘é‡æ•°æ®åº“å®ä¾‹ã€‚\næµ‹è¯•ç‰ˆï¼šå•å¯ç”¨åŒºã€å•èŠ‚ç‚¹ã€‚\næ•´ä¸ªåˆ›å»ºè¿‡ç¨‹å¤§æ¦‚éœ€è¦ 1-2 åˆ†é’Ÿï¼Œåˆ·æ–°å®ä¾‹åˆ—è¡¨ï¼Œå³å¯çœ‹åˆ°åˆ›å»ºå¥½çš„å®ä¾‹ã€‚\nåœ¨å¯†é’¥ç®¡ç†ä¸­è·å–ç”¨æˆ·å root çš„å¯†ç ï¼Œä¸‹é¢ä¼šç”¨åˆ°ï¼š\nå¼€å¯å¤–ç½‘è®¿é—®ï¼šå¯ä»¥ä½¿ç”¨ç³»ç»Ÿåˆ†é…çš„åŸŸåå’Œç«¯å£é€šè¿‡å¤–ç½‘è®¿é—®å‘é‡æ•°æ®åº“ï¼š\nç”Ÿæ•ˆæ—¶é—´å¤§æ¦‚åœ¨ 10s å†…ï¼Œè¯·è®°ä½è¿™é‡Œç”Ÿæˆçš„ åŸŸå(HOST) å’Œ ç«¯å£(PORT)\né…ç½®ç™½åå•ï¼šå¦‚æœå‡ºäºæµ‹è¯•ç›®çš„ï¼Œç™½åå• IP æ®µå¯ä»¥è®¾ç½®ä¸º 0.0.0.0/0 æ„å‘³ç€å¯¹æ‰€æœ‰ IP å¼€æ”¾ã€‚\né…ç½®ç™½åå•åï¼Œå¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æµ‹è¯•å¤–ç½‘è¿é€šæ€§ï¼š\ncurl -i -X POST \\ -H \u0026#39;Content-Type: application/json\u0026#39; \\ -H \u0026#39;Authorization: Bearer account=root\u0026amp;api_key=A5VOgsMpGWJhUI0WmUbY********************\u0026#39; \\ http://10.0.X.X:80/database/create \\ -d \u0026#39;{ \u0026#34;database\u0026#34;: \u0026#34;db-test\u0026#34; }\u0026#39; è¿”å›ç»“æœå¦‚ä¸‹ã€‚å¦‚æœè¿ä¸ä¸Šï¼Œæˆ–è€…è¶…æ—¶ï¼Œåˆ™æ˜¯ç™½åå•é…ç½®ä¸æ­£ç¡®ã€‚\n{\u0026#34;code\u0026#34;:0,\u0026#34;msg\u0026#34;:\u0026#34;operation success\u0026#34;,\u0026#34;affectedCount\u0026#34;:1} ä»¥å›¾æœå›¾æ¡ˆä¾‹ # ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ Towhee å’Œ è…¾è®¯äº‘å‘é‡æ•°æ®åº“æ„å»ºä¸€ä¸ªä»¥å›¾æœå›¾ï¼ˆReverse Image Searchï¼‰ç³»ç»Ÿã€‚\nTowhee æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºå¼ºå¤§çš„æ•°æ®æµæ°´çº¿çš„å¼€æºæ¡†æ¶ï¼Œå®ƒå¯ä»¥æœ‰æ•ˆåœ°å¤„ç†å„ç§æ•°æ®è½¬æ¢ä»»åŠ¡ã€‚\nè¯¥ç³»ç»Ÿä»¥å›¾ç‰‡ä½œä¸ºè¾“å…¥ï¼ŒåŸºäºå›¾ç‰‡çš„å†…å®¹æ£€ç´¢å‡ºæœ€ç›¸ä¼¼çš„å›¾ç‰‡ã€‚å…¶èƒŒåçš„åŸºæœ¬æ€æƒ³æ˜¯åˆ©ç”¨é¢„è®­ç»ƒçš„æ·±åº¦å­¦ä¹ æ¨¡å‹æå–å‡ºæ¯ä¸ªå›¾ç‰‡çš„ç‰¹å¾ï¼Œå¹¶å°†å…¶è¡¨ç¤ºä¸ºä¸€ä¸ªåµŒå…¥å‘é‡ï¼ˆEmbeddingï¼‰ã€‚ç„¶åï¼Œé€šè¿‡å­˜å‚¨å’Œæ¯”è¾ƒè¿™äº›å›¾ç‰‡åµŒå…¥å‘é‡ï¼Œå®ç°å›¾ç‰‡çš„æ£€ç´¢ã€‚\nå·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š\né¦–å…ˆï¼Œä½¿ç”¨ Towhee å¯¹è¾“å…¥å›¾ç‰‡è¿›è¡Œé¢„å¤„ç†å¹¶æå–ç‰¹å¾ï¼Œå¾—åˆ°å›¾ç‰‡çš„åµŒå…¥å‘é‡ã€‚ç„¶åï¼Œå°†è¿™ä¸ªåµŒå…¥å‘é‡å­˜å…¥å‘é‡æ•°æ®åº“ä¸­ã€‚å½“éœ€è¦æ£€ç´¢å›¾ç‰‡æ—¶ï¼ŒåŒæ ·å…ˆå¯¹æŸ¥è¯¢å›¾ç‰‡è¿›è¡Œé¢„å¤„ç†å’Œç‰¹å¾æå–ï¼Œå¾—åˆ°æŸ¥è¯¢å›¾ç‰‡çš„åµŒå…¥å‘é‡ã€‚åœ¨å‘é‡æ•°æ®åº“ä¸­å¯¹è¯¥å‘é‡è¿›è¡Œç›¸ä¼¼æ€§æ£€ç´¢ï¼Œå‘é‡æ•°æ®åº“ä¼šè¿”å›ä¸è¯¥å‘é‡ç›¸ä¼¼çš„ top k ä¸ªå‘é‡ã€‚\næ„å»ºé¡¹ç›® # ä¸‹é¢ä¼šå¯¹é‡è¦çš„ä»£ç éƒ¨åˆ†åšè¯¦è§£ï¼Œæœ€ç»ˆçš„ demo ä»£ç ï¼Œå¯ä»¥åœ¨æ–‡æœ«è·å–ï¼Œä»£ç æ‹‰åˆ°æœ¬åœ°å°±å¯ä»¥è¿è¡Œï¼Œå¯¹æ–°æ‰‹å¾ˆå‹å¥½\nåˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ç›®å½•ï¼š mkdir -p image-search cd image-search åˆ›å»ºä¸€ä¸ªæ–°çš„ Python è™šæ‹Ÿç¯å¢ƒï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰ï¼š $ python -V Python 3.9.0 $ python -m venv venv åˆ›å»ºä¸€ä¸ªæ–°çš„ Python è™šæ‹Ÿç¯å¢ƒèƒ½æœ‰æ•ˆåœ°éš”ç¦»é¡¹ç›®ä¾èµ–ï¼Œç®€åŒ–ä¾èµ–ç®¡ç†\næ¿€æ´»è¿™ä¸ªè™šæ‹Ÿç¯å¢ƒï¼š\nLinux/macOSï¼š source venv/bin/activate Windowsï¼š .\\venv\\Scripts\\activate å®‰è£…éœ€è¦çš„ Python åŒ…ï¼š python -m pip install -q towhee opencv-python pillow tcvectordb è¿™ä¸ªå‘½ä»¤ä¼šå°† Towheeï¼ŒOpenCVã€Pillowã€tcvectordb åº“å®‰è£…åˆ°ä¸Šé¢åˆ›å»ºçš„è™šæ‹Ÿç›®å½• venv ä¸­ã€‚\nå‡†å¤‡æ•°æ® # è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† ImageNet æ•°æ®é›†çš„ä¸€ä¸ªå­é›†ï¼ˆ100 ä¸ªç±»åˆ«ï¼‰ã€‚ç¤ºä¾‹æ•°æ®å¯åœ¨ Github ä¸Šè·å–ã€‚\ncurl -L https://github.com/towhee-io/examples/releases/download/data/reverse_image_search.zip -O unzip -q -o reverse_image_search.zip ImageNet æ•°æ®é›†æ˜¯æ·±åº¦å­¦ä¹ é¢†åŸŸä¸­å¹¿æ³›ä½¿ç”¨çš„å¤§è§„æ¨¡è§†è§‰æ•°æ®é›†ï¼Œç”¨äºå›¾ç‰‡åˆ†ç±»å’Œç‰©ä½“æ£€æµ‹ä»»åŠ¡ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæ‰€ä½¿ç”¨çš„æ•°æ®é›†æ˜¯ ImageNet çš„ä¸€ä¸ªå­é›†ï¼Œè¿™ä¸ªå­é›†ä¸ºæ¨¡å‹è®­ç»ƒå’ŒéªŒè¯æä¾›äº†é€‚å½“è§„æ¨¡å’Œå¤æ‚åº¦çš„æ•°æ®ã€‚\nç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\ntrainï¼šåŒ…å«å€™é€‰å›¾ç‰‡çš„ç›®å½•ï¼Œæœ‰ 100 ä¸ªä¸åŒçš„ç±»åˆ«ï¼Œæ¯ä¸ªç±»åˆ«åŒ…å« 10 å¼ å›¾ç‰‡ testï¼šåŒ…å«æŸ¥è¯¢å›¾ç‰‡çš„ç›®å½•ï¼Œä¸è®­ç»ƒé›†åŒæ ·çš„ 100 ä¸ªç±»åˆ«ï¼Œä½†æ¯ä¸ªç±»åˆ«åªæœ‰ 1 å¼ å›¾ç‰‡ reverse_image_search.csvï¼šä¸€ä¸ª csv æ–‡ä»¶ï¼ŒåŒ…å«æ¯ä¸ªè®­ç»ƒé›†å›¾ç‰‡çš„ idã€è·¯å¾„å’Œæ ‡ç­¾ å€™é€‰å›¾ç‰‡æ˜¯æŒ‡å¯èƒ½ä¼šè¢«æ£€ç´¢çš„å›¾ç‰‡ï¼ŒæŸ¥è¯¢å›¾ç‰‡æ˜¯æŒ‡ç”¨äºæ£€ç´¢çš„å›¾ç‰‡ã€‚\nè¿æ¥æ•°æ®åº“å¹¶æ–°å»º Collection # è¿æ¥ Tencent Vector DB å¾ˆç®€å•ï¼Œå®˜æ–¹æä¾›äº†å¤šç§è¯­è¨€çš„ SDKï¼Œæœ¬æ–‡ä½¿ç”¨ Python SDKï¼š tcvectordb æ“ä½œå‘é‡æ•°æ®åº“ã€‚\né¦–å…ˆåˆ©ç”¨ tcvectordb sdk ç¼–å†™è¿æ¥å‘é‡æ•°æ®åº“çš„å®¢æˆ·ç«¯ä»£ç ï¼š\nclass TcvdbClient(PyOperator): def __init__(self, host: str, port: str, username: str, key: str, dbName: str, collectionName: str, timeout: int = 20): \u0026#34;\u0026#34;\u0026#34; åˆå§‹åŒ–å®¢æˆ·ç«¯ \u0026#34;\u0026#34;\u0026#34; # åˆ›å»ºå®¢æˆ·ç«¯æ—¶å¯ä»¥æŒ‡å®š read_consistencyï¼Œåç»­è°ƒç”¨ sdk æ¥å£çš„ read_consistency å°†å»¶ç”¨è¯¥å€¼ self.collectionName = collectionName self.db_name = dbName self._client = tcvectordb.VectorDBClient(url=\u0026#34;http://\u0026#34; + host + \u0026#34;:\u0026#34; + port, username=username, key=key, read_consistency=ReadConsistency.EVENTUAL_CONSISTENCY, timeout=timeout) ç„¶åè°ƒç”¨ TcvdbClient æ„å»ºå®¢æˆ·ç«¯ ï¼š\n# tcvdb parameters HOST = \u0026#39;lb-xxxx.clb.ap-beijing.tencentclb.com\u0026#39; PORT = \u0026#39;10000\u0026#39; DB_NAME = \u0026#39;image-search\u0026#39; COLLECTION_NAME = \u0026#39;reverse_image_search\u0026#39; PASSWORD = \u0026#39;xxxx\u0026#39; USERNAME = \u0026#39;root\u0026#39; # path to csv (column_1 indicates image path) OR a pattern of image paths INSERT_SRC = \u0026#39;reverse_image_search.csv\u0026#39; test_vdb = TcvdbClient(host=HOST, port=PORT, key=\u0026#39;6qlvBkF0xAgZoN7VJbcwLCqrxoSS4J63Q7mu4RgF\u0026#39;, username=\u0026#39;root\u0026#39;, collectionName=COLLECTION_NAME, dbName=DB_NAME) ä¸Šé¢çš„ HOST å’Œ PORTã€USERNAME å’Œ PASSWORD æ˜¯ç”³è¯·å‘é‡æ•°æ®åº“åè·å–åˆ°çš„ã€‚\nåœ¨å‘é‡æ•°æ®åº“ä¸­åˆ›å»º DB å’Œ Collectionï¼š\nclass TcvdbClient(PyOperator): def create_db_and_collection(self): database = self.db_name coll_embedding_name = self.collectionName coll_alias = self.collectionName + \u0026#34;-alias\u0026#34; # åˆ›å»º DB db = self._client.create_database(database) # æ„å»º Collection index = Index() index.add(VectorIndex(\u0026#39;vector\u0026#39;, 2048, IndexType.HNSW, MetricType.COSINE, HNSWParams(m=16, efconstruction=200))) index.add(FilterIndex(\u0026#39;id\u0026#39;, FieldType.String, IndexType.PRIMARY_KEY)) index.add(FilterIndex(\u0026#39;path\u0026#39;, FieldType.String, IndexType.FILTER)) # åˆ›å»º Collection db.create_collection( name=coll_embedding_name, shard=3, replicas=0, description=\u0026#39;image embedding collection\u0026#39;, index=index, embedding=None, timeout=20 ) test_vdb.create_db_and_collection() ä¸Šé¢ä»£ç åˆ›å»ºä¸€ä¸ª Collectionï¼Œå¹¶åœ¨è¿™ä¸ª Collection ä¸­æ·»åŠ äº†ä¸‰ä¸ªç´¢å¼•ã€‚åœ¨å‘é‡æ•°æ®åº“ä¸­ï¼ŒCollection æ˜¯ç”¨æ¥å­˜å‚¨å’Œæ£€ç´¢å‘é‡çš„ä¸»è¦ç»“æ„ï¼Œåˆ›å»ºç´¢å¼•çš„å­—æ®µåœ¨æ£€ç´¢æ—¶å¯ä»¥ç”¨ä½œè¿‡æ»¤ï¼ˆfilterï¼‰ã€‚\nvectorï¼šç´¢å¼•æœ‰2048å‘é‡ç»´åº¦ã€‚ç»´åº¦è¶Šé«˜ï¼Œå‘é‡å¯ä»¥è¡¨è¾¾çš„ä¿¡æ¯è¶Šå¤šï¼Œä½†åŒæ—¶è®¡ç®—å¤æ‚åº¦ä¹Ÿè¶Šé«˜ï¼Œå­˜å‚¨éœ€æ±‚ä¹Ÿè¶Šå¤§ã€‚ IndexType.HNSWç´¢å¼•çš„ç±»å‹ã€‚è¿™æ˜¯ä¸€ç§è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ç®—æ³•ï¼Œç”¨æ¥åŠ é€Ÿé«˜ç»´å‘é‡çš„æœç´¢ã€‚ MetricType.COSINEæ˜¯ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œå®ƒå¯ä»¥è¡¡é‡ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è§’åº¦ï¼Œé€šå¸¸ç”¨äºè¡¡é‡é«˜ç»´å‘é‡çš„ç›¸ä¼¼æ€§ã€‚ idæ˜¯ä¸»é”®ç´¢å¼•ï¼Œç”¨æ¥å”¯ä¸€æ ‡è¯†æ¯ä¸ªå‘é‡ã€‚ pathæ˜¯è¿‡æ»¤ç´¢å¼•ï¼Œç”¨æ¥åŠ é€ŸåŸºäº path å­—æ®µçš„æŸ¥è¯¢ã€‚ æ–°å»ºä¹‹åï¼Œå¯ä»¥é€šè¿‡ DMCï¼ˆæ•°æ®åº“ç®¡ç†ï¼‰æ–¹ä¾¿çš„æŸ¥çœ‹ã€ç®¡ç†å‘é‡æ•°æ®åº“çš„æ•°æ®ï¼š\nDMC è®¿é—®å…¥å£ï¼šhttps://dms.cloud.tencent.com/\nä¸‹é¢æ˜¯åˆšåˆšåˆ›å»ºçš„ DB å’Œé›†åˆï¼š\nEmbeddingï¼šå›¾ç‰‡è½¬å‘é‡ã€å…¥åº“ # åœ¨æœºå™¨å­¦ä¹ é¢†åŸŸä¸­ï¼ŒæŠŠæ–‡æœ¬ã€å›¾ç‰‡ï¼ŒéŸ³é¢‘ç­‰å…¶ä»–ç±»å‹åŸå§‹è¾“å…¥æ•°æ®è½¬æ¢ä¸ºä¸€ç§æ›´é€‚åˆæœºå™¨å­¦ä¹ çš„å½¢å¼ï¼Œå³å°†å¤æ‚çš„æ•°æ®ç»“æ„ï¼ˆå¦‚å›¾ç‰‡ã€æ–‡æœ¬ç­‰ï¼‰è½¬æ¢ä¸ºå›ºå®šé•¿åº¦çš„å‘é‡çš„è¿‡ç¨‹æˆä¸º Embeddingã€‚\nä¸‹é¢åˆ©ç”¨ Towhee çš„ pipeline å®ç°å›¾ç‰‡çš„ç‰¹å¾æå–å’Œå‘é‡çš„å­˜å‚¨ï¼š\nMODEL = \u0026#39;resnet50\u0026#39; DEVICE = None # if None, use default device (cuda is enabled if available) INSERT_SRC = \u0026#39;reverse_image_search.csv\u0026#39; # Embedding pipeline p_embed = ( pipe.input(\u0026#39;src\u0026#39;) .flat_map(\u0026#39;src\u0026#39;, \u0026#39;img_path\u0026#39;, load_image) .map(\u0026#39;img_path\u0026#39;, \u0026#39;img\u0026#39;, ops.image_decode()) .map(\u0026#39;img\u0026#39;, \u0026#39;vec\u0026#39;, ops.image_embedding.timm(model_name=MODEL, device=DEVICE)) ) # Display embedding result, no need for implementation p_display = p_embed.output(\u0026#39;img_path\u0026#39;, \u0026#39;img\u0026#39;, \u0026#39;vec\u0026#39;) DataCollection(p_display(\u0026#39;./test/goldfish/*.JPEG\u0026#39;)).show() # Insert pipeline p_insert = ( p_embed.map((\u0026#39;img_path\u0026#39;, \u0026#39;vec\u0026#39;), \u0026#39;mr\u0026#39;, ops.local.tcvdb_client( host=HOST, port=PORT, key=PASSWORD, username=USERNAME, collectionName=COLLECTION_NAME, dbName=DB_NAME )) .output(\u0026#39;mr\u0026#39;) ) # Insert data p_insert(INSERT_SRC) Embedding Pipeline å®šä¹‰äº†ä¸€ä¸ª p_embed çš„ç®¡é“ï¼Œè¿™ä¸ªç®¡é“å°† reverse_image_search.csv ä¸­çš„å›¾ç‰‡åŠ è½½åï¼Œè°ƒç”¨ ops.image_embedding.timm()ï¼Œä½¿ç”¨ resnet50 æ¨¡å‹å°†å›¾ç‰‡æ•°æ®è½¬æ¢ä¸ºåµŒå…¥å‘é‡ã€‚\nTowhee æä¾›äº†é¢„è®­ç»ƒçš„ ResNet50 æ¨¡å‹ï¼Œå¯ä»¥å°†å›¾ç‰‡è½¬æ¢ä¸ºå‘é‡ã€‚ResNet50 æ˜¯ä¸€ç§æ·±åº¦å·ç§¯ç¥ç»ç½‘ç»œï¼Œå®ƒåœ¨è®¸å¤šå›¾åƒè¯†åˆ«ä»»åŠ¡ä¸­è¡¨ç°å‡ºè‰²ã€‚æ­¤æ¨¡å‹é€šè¿‡å­¦ä¹ å›¾ç‰‡çš„é‡è¦ç‰¹å¾ï¼Œå¹¶å°†è¿™äº›ç‰¹å¾åµŒå…¥åˆ°ä¸€ä¸ªé«˜ç»´å‘é‡ä¸­ï¼Œç§°ä¸ºåµŒå…¥å‘é‡ï¼ˆembedding vectorï¼‰ã€‚\nDisplay Pipeline ä»£ç å®šä¹‰äº† p_display çš„ç®¡é“ï¼Œè¿™ä¸ªç®¡é“ç”¨äºæ˜¾ç¤º p_embed çš„ç»“æœã€‚\nInsert Pipeline ä»£ç å®šä¹‰äº† p_insert çš„ç®¡é“ï¼Œè¿™ä¸ªç®¡é“ç”¨äºå°†åµŒå…¥å‘é‡æ’å…¥åˆ°å‘é‡æ•°æ®åº“ä¸­ã€‚\np_insert(INSERT_SRC) ä½¿ç”¨ p_insert ç®¡é“å¯¹ reverse_image_search.csv æ–‡ä»¶ä¸­çš„å›¾ç‰‡æ•°æ®è¿›è¡Œå¤„ç†ã€‚\næœ€ç»ˆä¼šå°†ç”Ÿæˆçš„å‘é‡è°ƒç”¨ ops.local.search_tcvdb_clientï¼Œæ’å…¥åˆ°å‘é‡æ•°æ®åº“ä¸­ï¼š\ndef __call__(self, *data): path = \u0026#34;\u0026#34; vector = [] for item in data: if isinstance(item, np.ndarray): # Convert ndarray to list and float32 to float vector = list(map(float, item)) else: path = item # Generate a random UUID and convert to string document_list = [ Document( id=str(uuid.uuid4()), path=path, vector=vector), ] db = self._client.database(self.db_name) coll = db.collection(self.collectionName) coll.upsert(documents=document_list) å¯ä»¥åœ¨ DMC ä¸­ï¼Œç”¨åˆšåˆšåˆ›å»ºäº†ç´¢å¼•çš„å­—æ®µè¿›è¡Œè¿‡æ»¤ï¼Œç²¾ç¡®æŸ¥è¯¢åˆ°å…¥åº“åçš„æ•°æ®ï¼Œä¾‹å¦‚æœç´¢ï¼špath=\u0026quot;./train/goldfish/n01443537_1903.JPEG\u0026quot; ï¼š\nç”±äºå‘é‡æ•°æ®ä¸€èˆ¬å¾ˆå¤§ï¼Œé»˜è®¤ä¸ä¼šè¿”å›ã€‚å¦‚æœè¦è¿”å›å‘é‡å­—æ®µéœ€è¦å‹¾é€‰retrieveVectorã€‚\næœç´¢ç›¸ä¼¼å›¾ # å®šä¹‰ä¸€ä¸ªæœç´¢ç®¡é“ p_searchï¼Œç”¨äºåœ¨å‘é‡æ•°æ®åº“ä¸­æœç´¢ä¸è¾“å…¥å›¾åƒæœ€ç›¸ä¼¼çš„å›¾åƒï¼Œç„¶åæ˜¾ç¤ºæœç´¢ç»“æœã€‚\né¢„æœç´¢ç®¡é“ p_search_pre ä½¿ç”¨ p_embed ç®¡é“ç”Ÿæˆ æŸ¥è¯¢å›¾ç‰‡ çš„åµŒå…¥å‘é‡ vecã€‚\n# Search pipeline p_search_pre = ( p_embed.map(\u0026#39;vec\u0026#39;, (\u0026#39;search_res\u0026#39;), ops.local.search_tcvdb_client( host=HOST, port=PORT, key=PASSWORD, username=USERNAME, collectionName=COLLECTION_NAME, dbName=DB_NAME)) .map(\u0026#39;search_res\u0026#39;, \u0026#39;pred\u0026#39;, lambda x: [str(Path(y[0]).resolve()) for y in x]) ) p_search = p_search_pre.output(\u0026#39;img_path\u0026#39;, \u0026#39;pred\u0026#39;) # Search for example query image(s) dc = p_search(\u0026#39;test/goldfish/*.JPEG\u0026#39;) DataCollection(dc).show() ç„¶åå¯¹æ¯ä¸ªå…ƒç´ åº”ç”¨ä¸€ä¸ª lambda å‡½æ•°ï¼Œå°†æ¯ä¸ªå…ƒç´ è½¬æ¢ä¸ºä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ pred ä¸­ã€‚\nè°ƒç”¨ ops.local.search_tcvdb_client å‡½æ•°è¿æ¥å‘é‡æ•°æ®åº“ï¼Œå¹¶æœç´¢ä¸ vec æœ€ç›¸ä¼¼çš„å‘é‡ï¼Œå°†æœç´¢ç»“æœå­˜å‚¨åœ¨ search_res ä¸­ã€‚\nclass SearchTcvdbClient(PyOperator): def __call__(self, query: \u0026#39;ndarray\u0026#39;): tcvdb_result = self.query_data( query, **self.kwargs ) result = [] for hit in tcvdb_result[0]: row = [] row.extend([hit[\u0026#34;path\u0026#34;], hit[\u0026#34;score\u0026#34;]]) result.append(row) return result def query_data(self, query: [], **kwargs): # è·å– Collection å¯¹è±¡ db = self._client.database(self.db_name) coll = db.collection(self.collectionName) vector = query if isinstance(query, np.ndarray): # Convert ndarray to list and float32 to float vector = list(map(float, query)) # search æä¾›æŒ‰ç…§ vector æœç´¢çš„èƒ½åŠ› # æ‰¹é‡ç›¸ä¼¼æ€§æŸ¥è¯¢ï¼Œæ ¹æ®æŒ‡å®šçš„å¤šä¸ªå‘é‡æŸ¥æ‰¾å¤šä¸ª Top K ä¸ªç›¸ä¼¼æ€§ç»“æœ res = coll.search( vectors=[vector], # æŒ‡å®šæ£€ç´¢å‘é‡ï¼Œ retrieve_vector=False, # æ˜¯å¦éœ€è¦è¿”å›å‘é‡å­—æ®µï¼ŒFalseï¼šä¸è¿”å›ï¼ŒTrueï¼šè¿”å› limit=10, # æŒ‡å®š Top K çš„ K å€¼ ) return res æœç´¢ç®¡é“ p_search çš„è¾“å‡ºæ˜¯ï¼š\nimg_pathï¼šæŸ¥è¯¢å›¾ç‰‡ çš„è·¯å¾„ã€‚ predï¼šæŸ¥è¯¢åˆ°çš„ç›¸ä¼¼å›¾ç‰‡è·¯å¾„åˆ—è¡¨ã€‚ ä½¿ç”¨ p_search ç®¡é“å¯¹å›¾ç‰‡ test/goldfish/*.JPEG çš„ç›¸ä¼¼å›¾è¿›è¡Œæœç´¢ã€‚ç”¨ Towhee çš„ DataCollection ç»„ä»¶æ˜¾ç¤ºæœç´¢ç»“æœã€‚\n+-----------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ | img_path | pred | +===================================+=============================================================================================================================================================================================================================================================================================================================+ | test/goldfish/n01443537_3883.JPEG | [/root/image-search/reverse_image_search/train/goldfish/n01443537_1903.JPEG,/root/image-search/reverse_image_search/train/goldfish/n01443537_2819.JPEG,/root/image-search/reverse_image_search/train/goldfish/n01443537_1415.JPEG,/root/image-search/reverse_image_search/train/goldfish/n01443537_7751.JPEG,...] len=10 | +-----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ DataCollection.show() å‡½æ•°åœ¨æ˜¾ç¤ºå¤§é‡æ•°æ®æ—¶ï¼Œä¸ºäº†é˜²æ­¢åœ¨å±å¹•ä¸Šæ˜¾ç¤ºè¿‡å¤šçš„æ•°æ®ï¼Œä¼šçœç•¥éƒ¨åˆ†æ•°æ®ã€‚\nåŒæ ·çš„ï¼Œå¦‚æœçŸ¥é“äº†ä¸€å¼ å›¾ç‰‡çš„å‘é‡ï¼Œå¯ä»¥åœ¨ DMC ä¸­ç”¨å‘é‡æ£€ç´¢ç›¸ä¼¼çš„å›¾ç‰‡ä¿¡æ¯ï¼ŒæŸ¥è¯¢åˆ°çš„ç»“æœé»˜è®¤æŒ‰ç…§ score ç”±é«˜åˆ°ä½æ’åºï¼Œè¶Šå¤§è¡¨ç¤ºç›¸ä¼¼åº¦è¶Šé«˜ã€‚\né›†æˆ Gradio # è§‰å¾—ä¸Šè¿°ç¤ºä¾‹ä¸­çš„ä»£ç æ¼”ç¤ºå¯¹äºéæŠ€æœ¯ç”¨æˆ·æ¥è¯´ä¸å¤Ÿå‹å¥½ï¼Ÿ\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Gradio æä¾›çš„ Web UIï¼Œä»¥æ›´ç›´è§‚ã€æ›´äº’åŠ¨çš„æ–¹å¼æ¥å±•ç¤ºä¸Šè¿°çš„æŸ¥è¯¢å’Œç»“æœã€‚å‡ ç§’é’Ÿå†…å°±å¯ä»¥å°†ä¸Šè¿°å·¥ä½œæµç¨‹ä»¥ Web UI çš„å½¢å¼å‘ˆç°å‡ºæ¥ã€‚è¿™æ ·ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥é€šè¿‡ä¸Šä¼ å›¾ç‰‡æ¥è¿›è¡Œæœç´¢ï¼Œåœ¨ç•Œé¢ä¸Šå±•ç¤ºå‡ºç›¸ä¼¼çš„å›¾ç‰‡ã€‚\nå‡ºäºæ¼”ç¤ºç›®çš„ï¼Œä¸‹é¢å°†é€šè¿‡è¾“å…¥å›¾ç‰‡è·¯å¾„ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºç›¸ä¼¼çš„å›¾ç‰‡ã€‚\ndef search_and_show_images(file_path): # ä½¿ç”¨ `file_path` è¿›è¡Œæœç´¢ï¼Œè¿”å›ç»“æœçš„è·¯å¾„ results = p_search(file_path) # ä» \u0026#39;DataQueue\u0026#39; å¯¹è±¡ä¸­è·å–æ•°æ® data = results.get() # è·å–ç»“æœåˆ—è¡¨ pred = data[1] return pred iface = gr.Interface( fn=search_and_show_images, # inputs=gr.inputs.File(type=\u0026#34;file\u0026#34;), inputs=gr.inputs.Textbox(default=\u0026#39;test/goldfish/*.JPEG\u0026#39;), outputs=gr.Gallery(label=\u0026#34;æœ€ç»ˆçš„ç»“æœå›¾ç‰‡\u0026#34;).style(height=\u0026#39;auto\u0026#39;, columns=4), --- title=\u0026#39;Tencent vector db æ¡ˆä¾‹: ä»¥å›¾æœå›¾\u0026#39;, ) iface.launch() search_and_show_images ä¼šè¿”å›ç±»ä¼¼ä¸‹é¢çš„æ•°æ®ï¼Œæœ€ç»ˆè¿™äº›å›¾ç‰‡è·¯å¾„ä¼šè¢«å±•ç¤ºåˆ° Web UI ä¸Šã€‚\n[ \u0026#39;/root/image-search/reverse_image_search/train/cuirass/n03146219_11082.JPEG\u0026#39;, \u0026#39;/root/image-search/reverse_image_search/train/loudspeaker/n03691459_40992.JPEG\u0026#39; ] å¯åŠ¨é¡¹ç›®ã€‚ç”¨æµè§ˆå™¨æ‰“å¼€ http://127.0.0.1:7860 å³å¯çœ‹åˆ°æˆæœã€‚\nè¾“å…¥ï¼štest/goldfish/*.JPEG è¿”å›çš„ç»“æœéƒ½åŒ…å«é±¼ã€‚\nè¾“å…¥ï¼štest/Afghan_hound/n02088094_4261.JPEG è¿”å›çš„ç»“æœéƒ½åŒ…å«ç‹—ã€‚\næ€»ç»“ # å¯¹äºæ„å»ºä»¥å›¾æœå›¾ã€æ–‡å­—æœè§†é¢‘ã€ç§åŸŸå¯¹è¯æœºå™¨äººç­‰ç³»ç»Ÿï¼Œè…¾è®¯äº‘å‘é‡æ•°æ®åº“ç”±äºå…¶å“è¶Šçš„ç¨³å®šæ€§ã€æ€§èƒ½ã€æ˜“ç”¨æ€§å’Œä¾¿æ·çš„è¿ç»´ï¼Œéƒ½å±•ç°å‡ºäº†æ˜¾è‘—ä¼˜åŠ¿ã€‚å¾—ç›Šäºå¤§å‚çš„èƒŒä¹¦ï¼Œè…¾è®¯äº‘å‘é‡æ•°æ®åº“åœ¨ AI é¢†åŸŸä¸­å·²ç»æˆä¸ºäº†é¢†å†›è€…ã€‚\næ¼”ç¤ºä»£ç åœ°å€ï¼šhttps://github.com/smallersoup/image-search\n","date":"2021å¹´9æœˆ15æ—¥","externalUrl":null,"permalink":"/posts/search-img-by-img/","section":"Posts","summary":"\u003ch1 class=\"relative group\"\u003eæ‰‹æŠŠæ‰‹å¸¦ä½  5 åˆ†é’Ÿæ„å»ºä»¥å›¾æœå›¾ç³»ç»Ÿ \n    \u003cdiv id=\"æ‰‹æŠŠæ‰‹å¸¦ä½ -5-åˆ†é’Ÿæ„å»ºä»¥å›¾æœå›¾ç³»ç»Ÿ\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%89%8b%e6%8a%8a%e6%89%8b%e5%b8%a6%e4%bd%a0-5-%e5%88%86%e9%92%9f%e6%9e%84%e5%bb%ba%e4%bb%a5%e5%9b%be%e6%90%9c%e5%9b%be%e7%b3%bb%e7%bb%9f\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h1\u003e\n\n\u003ch2 class=\"relative group\"\u003eå‘é‡å’Œå‘é‡æ•°æ®åº“ \n    \u003cdiv id=\"å‘é‡å’Œå‘é‡æ•°æ®åº“\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e5%90%91%e9%87%8f%e5%92%8c%e5%90%91%e9%87%8f%e6%95%b0%e6%8d%ae%e5%ba%93\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eå‘é‡åœ¨æ•°å­¦ä¸­æ˜¯ä¸€ä¸ªå¯ä»¥è¡¨ç¤ºå¤šä¸ªç»´åº¦æˆ–ç‰¹æ€§çš„å¯¹è±¡ã€‚åœ¨æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æè¿°ä¸€ä¸ªç‰©ä½“çš„å¤šä¸ªå±æ€§ã€‚\u003c/p\u003e","title":"æ‰‹æŠŠæ‰‹å¸¦ä½  5 åˆ†é’Ÿæ„å»ºä»¥å›¾æœå›¾ç³»ç»Ÿ...","type":"posts"},{"content":"","date":"2019å¹´11æœˆ21æ—¥","externalUrl":null,"permalink":"/tags/cka/","section":"Tags","summary":"","title":"CKA","type":"tags"},{"content":"","date":"2019å¹´11æœˆ21æ—¥","externalUrl":null,"permalink":"/tags/kubernetes/","section":"Tags","summary":"","title":"Kubernetes","type":"tags"},{"content":" æ˜¨æ—¥è€ƒé¢˜ # é€šè¿‡å•ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªdeploymentå¹¶æš´éœ²Serviceã€‚deploymentå’ŒServiceåç§°ä¸ºcka-1120ï¼Œä½¿ç”¨nginxé•œåƒï¼Œ deploymentæ‹¥æœ‰2ä¸ªpod\næ˜¨æ—¥ç­”æ¡ˆ # [root@liabio ~]# kubectl run cka-1120 --replicas 2 --expose=true --port=80 --image=nginx kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead. service/cka-1120 created deployment.apps/cka-1120 created [root@liabio ~]# kubectl get all | grep cka-1120 pod/cka-1120-554b9c4798-7jcrb 1/1 Running 0 118m pod/cka-1120-554b9c4798-fpjwj 1/1 Running 0 118m service/cka-1120 ClusterIP 10.108.140.25 \u0026lt;none\u0026gt; 80/TCP 118m deployment.apps/cka-1120 2/2 2 2 118m æ˜¨æ—¥è§£æ # å®˜ç½‘ä¸­æä¾›äº†è¯¦ç»†çš„kubectlä½¿ç”¨æ–¹æ³•ï¼Œä½äºREFERENCE\u0026ndash;\u0026raquo;kubectl CLI\u0026ndash;\u0026raquo;kubectl Commandsæ ‡ç­¾ä¸‹ã€‚\nå³ï¼š\nhttps://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#run\nkubectl runä¼šåˆ›å»ºdeploymentæˆ–è€…jobæ¥ç®¡ç†Podï¼Œå‘½ä»¤è¯­æ³•å¦‚ä¸‹ï¼š\nkubectl run NAME --image=image [--env=\u0026#34;key=value\u0026#34;] [--port=port] [--replicas=replicas] [--dry-run=bool] [--overrides=inline-json] [--command] -- [COMMAND] [args...] NAMEæŒ‡å®šdeploymentå’Œserviceçš„åç§°ï¼›\n\u0026ndash;replicasç¼©å†™-rï¼ŒæŒ‡å®šå®ä¾‹æ•°ï¼Œé»˜è®¤ä¸º1ï¼›\n\u0026ndash;exposeå¦‚æœä¸ºtrueï¼Œä¼šåˆ›å»ºæœ‰ClusterIPçš„serviceï¼Œé»˜è®¤ä¸ºfalseï¼›\n\u0026ndash;portè¡¨ç¤ºå®¹å™¨æš´éœ²çš„ç«¯å£ï¼Œå¦‚æœexposeä¸ºtrueï¼Œè¯¥ç«¯å£ä¹Ÿæ˜¯serviceçš„ç«¯å£ï¼›\n\u0026ndash;imageæŒ‡å®šå®¹å™¨ç”¨çš„é•œåƒï¼›\n\u0026ndash;dry-runä¸ºtrueæ—¶ï¼Œåªæ‰“å°å°†è¦å‘é€çš„å¯¹è±¡ï¼Œè€Œä¸çœŸæ­£å‘é€å®ƒï¼Œé»˜è®¤ä¸ºfalseã€‚\nåˆ›å»ºåä¸ºcka-1120-01ï¼Œå¸¦ç¯å¢ƒå˜é‡çš„deployment\nkubectl run cka-1120-01 --image=nginx --env=\u0026#34;DNS_DOMAIN=cluster.local\u0026#34; --env=\u0026#34;POD_NAMESPACE=default\u0026#34; åˆ›å»ºåä¸ºcka-1120-02ï¼Œå¸¦labelçš„deployment\nkubectl run cka-1120-02 --image=nginx --labels=\u0026#34;app=nginx,env=prod\u0026#34; è¿˜æœ‰ä¸€ä¸ª\u0026ndash;restartå‚æ•°ï¼Œé»˜è®¤ä¸ºAlwaysï¼Œå¦‚æœè®¾ç½®ä¸ºOnFailureï¼Œåˆ™jobä¼šè¢«åˆ›å»ºï¼›å¦‚æœè®¾ç½®ä¸ºNeverï¼Œåˆ™æ™®é€šPodä¼šè¢«åˆ›å»ºã€‚\n[root@liabio ~]# kubectl run cka-1120-03 --image=nginx --restart=OnFailure kubectl run --generator=job/v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead. job.batch/cka-1120-03 created [root@liabio ~]# [root@liabio ~]# kubectl run cka-1120-04 --image=nginx --restart=Never pod/cka-1120-04 created å‚æ•°\u0026ndash;scheduleæŒ‡å®šcronjobçš„å®šæ—¶è§„åˆ™ï¼Œå¦‚æœæŒ‡å®šè¯¥å‚æ•°ï¼Œåˆ™ä¼šåˆ›å»ºå‡ºcronjob\n[root@liabio ~]# kubectl run pi --schedule=\u0026#34;0/5 * * * ?\u0026#34; --image=perl --restart=OnFailure -- perl -Mbignum=bpi -wle \u0026#39;print bpi(2000)\u0026#39; cronjob.batch/pi created ç›®å‰ä¸æ”¯æŒç›´æ¥åˆ›å»ºStatefulsetã€Daemonsetç­‰èµ„æºå¯¹è±¡ã€‚\nkubectl runæ‰§è¡Œåï¼Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ\næœ‰å¿…è¦çœ‹çœ‹kubectlæºç ï¼Œå…¥å£å‡½æ•°åœ¨$GOPATH\\src\\k8s.io\\kubernetes\\cmd\\clicheck\\check_cli_conventions.goä¸­\nå…¶ä¸­cmd.NewKubectlCommandä¸ºæ„å»ºkubectlä»¥åŠå…¶å­å‘½ä»¤è¡Œå‚æ•°ã€‚æœ€ç»ˆçš„æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„ä»£ç éƒ½åœ¨pkg\\kubectlåŒ…ä¸‹é¢ã€‚\nä¸åŒçš„å­å‘½ä»¤ï¼šapplyã€runã€createå…¥å£å¯¹åº”çš„åœ¨pkg\\kubectl\\cmdä¸‹é¢ï¼š\næœ€é‡è¦çš„o.Run(f, cmd, args)ä¸­ä¼šå¯¹kubectl runä¼ å…¥çš„å‚æ•°è¿›è¡Œä¸€ç³»åˆ—æ ¡éªŒï¼Œå¡«å……é»˜è®¤å€¼ã€‚\nåœ¨360è¡Œè°ƒç”¨o.createGeneratedObjectæ ¹æ®ä¸åŒçš„generatorç”Ÿæˆdeploymentã€cronjobã€jobã€podç­‰èµ„æºå¯¹è±¡ï¼Œå¹¶å‘apiserverå‘é€åˆ›å»ºè¯·æ±‚ã€‚\nå¦‚æœè®¾ç½®äº†exposeä¸ºtrueï¼Œåœ¨372è¡Œï¼ŒåŒæ ·çš„è°ƒç”¨o.createGeneratedObjectç”Ÿæˆå¹¶åˆ›å»ºserviceã€‚\no.createGeneratedObjectæ–¹æ³•ç¬¬649è¡Œï¼Œæ ¹æ®ä¸åŒçš„generatorå®ç°ç”Ÿæˆä¸åŒçš„èµ„æºå¯¹è±¡ã€‚\nrunå‘½ä»¤å¯¹åº”çš„generatorå®ç°æœ‰ä»¥ä¸‹å‡ ç§ï¼Œä»£ç ä½äºpkg\\kubectl\\generate\\versioned\\generator.goä¸­çš„DefaultGeneratorså‡½æ•°ã€‚\ncase \u0026#34;run\u0026#34;: generator = map[string]generate.Generator{ RunV1GeneratorName: BasicReplicationController{}, RunPodV1GeneratorName: BasicPod{}, DeploymentV1Beta1GeneratorName: DeploymentV1Beta1{}, DeploymentAppsV1Beta1GeneratorName: DeploymentAppsV1Beta1{}, DeploymentAppsV1GeneratorName: DeploymentAppsV1{}, JobV1GeneratorName: JobV1{}, CronJobV2Alpha1GeneratorName: CronJobV2Alpha1{}, CronJobV1Beta1GeneratorName: CronJobV1Beta1{}, } o.createGeneratedObjectæ–¹æ³•ç¬¬689è¡Œå¯¹ç”Ÿæˆçš„èµ„æºå¯¹è±¡å‘APIServerå‘é€httpåˆ›å»ºè¯·æ±‚ã€‚\nå…·ä½“çš„kubectl runå‘½ä»¤çš„ä»£ç ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è¿›ä¸€æ­¥æ·±æŒ–ï¼Œæˆ‘ä¹Ÿä¼šåœ¨åç»­çš„æºç åˆ†æç³»åˆ—æ–‡ç« ä¸­è¿›è¡Œæ›´è¯¦ç»†çš„è§£æã€‚\nä»Šæ—¥è€ƒé¢˜ # é€šè¿‡å‘½ä»¤è¡Œï¼Œä½¿ç”¨nginxé•œåƒåˆ›å»ºä¸€ä¸ªpodå¹¶æ‰‹åŠ¨è°ƒåº¦åˆ°èŠ‚ç‚¹åä¸ºnode1121èŠ‚ç‚¹ä¸Šï¼ŒPodçš„åç§°ä¸ºcka-1121ï¼Œç­”é¢˜æœ€å¥½é™„ä¸Šï¼Œæ‰€ç”¨å‘½ä»¤ã€åˆ›å»ºPodæ‰€éœ€æœ€ç²¾ç®€çš„yamlï¼›å¦‚æœè¯„è®ºæœ‰é™åˆ¶ï¼Œè¯·æŠŠæ³¨æ„ç‚¹åˆ—å‡ºï¼Œä¸»è¦éœ€åˆ—å‡ºæ‰‹åŠ¨è°ƒåº¦æ€ä¹ˆåšï¼Ÿ\næ³¨æ„ï¼šæ‰‹åŠ¨è°ƒåº¦æ˜¯æŒ‡ä¸éœ€è¦ç»è¿‡kube-schedulerå»è°ƒåº¦ã€‚\n","date":"2019å¹´11æœˆ21æ—¥","externalUrl":null,"permalink":"/posts/%E5%A4%87%E6%88%98cka%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%E7%AC%AC4%E5%A4%A9%E7%86%9F%E7%BB%83%E6%8E%8C%E6%8F%A1kubectl%E5%91%BD%E4%BB%A4%E8%BF%9B%E8%A1%8C%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E6%93%8D%E4%BD%9C%E5%B9%B6%E4%BB%8E%E6%BA%90%E7%A0%81%E8%BF%9B%E8%A1%8C%E8%A7%A3%E6%9E%90/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ˜¨æ—¥è€ƒé¢˜ \n    \u003cdiv id=\"æ˜¨æ—¥è€ƒé¢˜\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%98%a8%e6%97%a5%e8%80%83%e9%a2%98\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eé€šè¿‡å•ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªdeploymentå¹¶æš´éœ²Serviceã€‚deploymentå’ŒServiceåç§°ä¸ºcka-1120ï¼Œä½¿ç”¨nginxé•œåƒï¼Œ deploymentæ‹¥æœ‰2ä¸ªpod\u003c/p\u003e","title":"å¤‡æˆ˜CKAæ¯æ—¥ä¸€é¢˜â€”â€”ç¬¬4å¤© | ç†Ÿç»ƒæŒæ¡kubectlå‘½ä»¤è¿›è¡Œåˆ›å»ºèµ„æºå¯¹è±¡æ“ä½œï¼Œå¹¶ä»æºç è¿›è¡Œè§£æ","type":"posts"},{"content":" æ˜¨æ—¥è€ƒé¢˜ # åœ¨Kubernetes PVC+PVä½“ç³»ä¸‹é€šè¿‡CSIå®ç°çš„volume pluginsåŠ¨æ€åˆ›å»ºpvåˆ°pvå¯è¢«podä½¿ç”¨æœ‰å“ªäº›ç»„ä»¶éœ€è¦å‚ä¸ï¼Ÿ\nA. PersistentVolumeController + CSI-Provisoner + CSI controller plugin B. AttachDetachController + CSI-Attacher + CSI controller plugin C. Kubelet + CSI node plugin æ˜¨æ—¥ç­”æ¡ˆ # ABC\næ˜¨æ—¥è§£æ # k8sä¸­ï¼Œåˆ©ç”¨PVC æè¿°Pod æ‰€å¸Œæœ›ä½¿ç”¨çš„æŒä¹…åŒ–å­˜å‚¨çš„å¤§å°ï¼Œå¯è¯»å†™æƒé™ç­‰ï¼Œä¸€èˆ¬ç”±å¼€å‘äººå‘˜å»åˆ›å»ºï¼›åˆ©ç”¨PVæè¿°å…·ä½“å­˜å‚¨ç±»å‹ï¼Œå­˜å‚¨åœ°å€ï¼ŒæŒ‚è½½ç›®å½•ç­‰ï¼Œä¸€èˆ¬ç”±è¿ç»´äººå‘˜å»æå‰åˆ›å»ºã€‚è€Œä¸æ˜¯ç›´æ¥åœ¨podé‡Œå†™ä¸Švolumeçš„ä¿¡æ¯ã€‚ä¸€æ¥å¯ä»¥ä½¿å¾—å¼€å‘è¿ç»´èŒè´£åˆ†æ˜ï¼ŒäºŒæ¥åˆ©ç”¨PVCã€PVæœºåˆ¶ï¼Œå¯ä»¥å¾ˆå¥½æ‰©å±•æ”¯æŒå¸‚é¢ä¸Šä¸åŒçš„å­˜å‚¨å®ç°ï¼Œå¦‚k8s v1.10ç‰ˆæœ¬å¯¹Local Persistent Volumeçš„æ”¯æŒã€‚\næˆ‘ä»¬è¯•ç€ç†ä¸€ä¸‹Podåˆ›å»ºåˆ°volumeå¯ç”¨çš„æ•´ä½“æµç¨‹ã€‚\nç”¨æˆ·æäº¤è¯·æ±‚åˆ›å»ºpodï¼ŒPersistentVolumeControllerå‘ç°è¿™ä¸ªpodå£°æ˜ä½¿ç”¨äº†PVCï¼Œé‚£å°±ä¼šå¸®å®ƒæ‰¾ä¸€ä¸ªPVé…å¯¹ã€‚\næ²¡æœ‰ç°æˆçš„PVï¼Œå°±å»æ‰¾å¯¹åº”çš„StorageClassï¼Œå¸®å®ƒæ–°åˆ›å»ºä¸€ä¸ªPVï¼Œç„¶åå’ŒPVCå®Œæˆç»‘å®šã€‚\næ–°åˆ›å»ºçš„PVï¼Œè¿˜åªæ˜¯ä¸€ä¸ªAPI å¯¹è±¡ï¼Œéœ€è¦ç»è¿‡â€œä¸¤é˜¶æ®µå¤„ç†â€ï¼Œæ‰èƒ½å˜æˆå®¿ä¸»æœºä¸Šçš„â€œæŒä¹…åŒ– Volumeâ€çœŸæ­£è¢«ä½¿ç”¨ï¼š\nç¬¬ä¸€é˜¶æ®µç”±è¿è¡Œåœ¨masterä¸Šçš„AttachDetachControllerè´Ÿè´£ï¼Œä¸ºè¿™ä¸ªPVå®Œæˆ Attach æ“ä½œï¼Œä¸ºå®¿ä¸»æœºæŒ‚è½½è¿œç¨‹ç£ç›˜ï¼›\nç¬¬äºŒé˜¶æ®µæ˜¯è¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Škubeletç»„ä»¶çš„å†…éƒ¨ï¼ŒæŠŠç¬¬ä¸€æ­¥attachçš„è¿œç¨‹ç£ç›˜ mount åˆ°å®¿ä¸»æœºç›®å½•ã€‚è¿™ä¸ªæ§åˆ¶å¾ªç¯å«VolumeManagerReconcilerï¼Œè¿è¡Œåœ¨ç‹¬ç«‹çš„Goroutineï¼Œä¸ä¼šé˜»å¡kubeletä¸»æ§åˆ¶å¾ªç¯ã€‚\nå®Œæˆè¿™ä¸¤æ­¥ï¼ŒPVå¯¹åº”çš„â€œæŒä¹…åŒ– Volumeâ€å°±å‡†å¤‡å¥½äº†ï¼ŒPODå¯ä»¥æ­£å¸¸å¯åŠ¨ï¼Œå°†â€œæŒä¹…åŒ– Volumeâ€æŒ‚è½½åœ¨å®¹å™¨å†…æŒ‡å®šçš„è·¯å¾„ã€‚\nk8sæ”¯æŒç¼–å†™è‡ªå·±çš„å­˜å‚¨æ’ä»¶FlexVolume ä¸ CSIã€‚ä¸ç®¡å“ªç§æ–¹å¼ï¼Œéƒ½éœ€è¦ç»è¿‡â€œä¸¤é˜¶æ®µå¤„ç†â€ï¼ŒFlexVolumeç›¸æ¯”CSIå±€é™æ€§å¤§ï¼Œä¸€èˆ¬æˆ‘ä»¬é‡‡ç”¨CSIæ–¹å¼å¯¹æ¥å­˜å‚¨ã€‚\nCSI æ’ä»¶ä½“ç³»çš„è®¾è®¡æ€æƒ³æŠŠè¿™ä¸ªProvisioné˜¶æ®µï¼ˆåŠ¨æ€åˆ›å»ºPVï¼‰ï¼Œä»¥åŠ Kubernetes é‡Œçš„ä¸€éƒ¨åˆ†å­˜å‚¨ç®¡ç†åŠŸèƒ½ï¼Œä»ä¸»å¹²ä»£ç é‡Œå‰¥ç¦»å‡ºæ¥ï¼Œåšæˆäº†å‡ ä¸ªå•ç‹¬çš„ç»„ä»¶ã€‚è¿™äº›ç»„ä»¶ä¼šé€šè¿‡ Watch API ç›‘å¬ Kubernetes é‡Œä¸å­˜å‚¨ç›¸å…³çš„äº‹ä»¶å˜åŒ–ï¼Œæ¯”å¦‚ PVC çš„åˆ›å»ºï¼Œæ¥æ‰§è¡Œå…·ä½“çš„å­˜å‚¨ç®¡ç†åŠ¨ä½œã€‚\nä¸Šå›¾ä¸­CSIè¿™å¥—å­˜å‚¨æ’ä»¶ä½“ç³»ä¸­ä¸‰ä¸ªç‹¬ç«‹çš„å¤–éƒ¨ç»„ä»¶ï¼ˆExternal Componentsï¼‰ï¼Œå³ï¼šDriver Registrarã€External Provisioner å’Œ External Attacherï¼Œå¯¹åº”çš„æ˜¯ä» Kubernetes é¡¹ç›®é‡Œé¢å‰¥ç¦»å‡ºæ¥çš„éƒ¨åˆ†å­˜å‚¨ç®¡ç†åŠŸèƒ½ã€‚\næˆ‘ä»¬éœ€è¦å®ç°Custom Componentsè¿™ä¸€ä¸ªäºŒè¿›åˆ¶ï¼Œä¼šä»¥gRpcæ–¹å¼æä¾›ä¸‰ä¸ªæœåŠ¡ï¼šCSI Identityã€CSI Controllerã€CSI Nodeã€‚\nDriver Registrar ç»„ä»¶ï¼Œè´Ÿè´£å°†æ’ä»¶æ³¨å†Œåˆ° kubelet é‡Œé¢ï¼›Driver Registrarè°ƒç”¨CSI Identity æœåŠ¡æ¥è·å–æ’ä»¶ä¿¡æ¯ï¼›\nExternal Provisioner ç»„ä»¶ç›‘å¬APIServer é‡Œçš„ PVC å¯¹è±¡ã€‚å½“ä¸€ä¸ª PVC è¢«åˆ›å»ºæ—¶ï¼Œå®ƒå°±ä¼šè°ƒç”¨ CSI Controller çš„ CreateVolume æ–¹æ³•ï¼Œåˆ›å»ºå¯¹åº” PVï¼›\nExternal Attacher ç»„ä»¶è´Ÿè´£Attaché˜¶æ®µã€‚Mounté˜¶æ®µç”±kubeleté‡Œçš„VolumeManagerReconcileræ§åˆ¶å¾ªç¯ç›´æ¥è°ƒç”¨CSI NodeæœåŠ¡å®Œæˆã€‚\nä¸¤é˜¶æ®µå®Œæˆåï¼Œkubeletå°†mountå‚æ•°ä¼ é€’ç»™dockerï¼Œåˆ›å»ºã€å¯åŠ¨å®¹å™¨ã€‚\næ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š\nè€ƒè¯•ä½“éªŒæ€»ç»“ # https://www.kubernetes.org.cn/5168.html\nhttps://blog.csdn.net/deerjoe/article/details/86300826\nä»Šæ—¥è€ƒé¢˜ # é€šè¿‡å•ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªdeploymentå¹¶æš´éœ²Serviceã€‚deploymentå’ŒServiceåç§°ä¸ºcka-1120ï¼Œä½¿ç”¨nginxé•œåƒï¼Œ deploymentæ‹¥æœ‰2ä¸ªpod\n","date":"2019å¹´11æœˆ21æ—¥","externalUrl":null,"permalink":"/posts/%E5%A4%87%E6%88%98cka%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%E7%AC%AC3%E5%A4%A9%E5%AF%B9%E6%8E%A5csi%E5%AD%98%E5%82%A8%E7%9F%A5%E8%AF%86/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ˜¨æ—¥è€ƒé¢˜ \n    \u003cdiv id=\"æ˜¨æ—¥è€ƒé¢˜\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%98%a8%e6%97%a5%e8%80%83%e9%a2%98\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eåœ¨Kubernetes PVC+PVä½“ç³»ä¸‹é€šè¿‡CSIå®ç°çš„volume pluginsåŠ¨æ€åˆ›å»ºpvåˆ°pvå¯è¢«podä½¿ç”¨æœ‰å“ªäº›ç»„ä»¶éœ€è¦å‚ä¸ï¼Ÿ\u003c/p\u003e","title":"å¤‡æˆ˜CKAæ¯æ—¥ä¸€é¢˜â€”â€”ç¬¬3å¤© | å¯¹æ¥CSIå­˜å‚¨çŸ¥è¯†","type":"posts"},{"content":" CKAæ¦‚è¿° # è®¤è¯Kubernetesç®¡ç†å‘˜ï¼ˆCKAï¼‰è®¡åˆ’ç”±LinuxåŸºé‡‘ä¼šå’Œäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰åˆ›å»ºï¼Œä½œä¸ºä»–ä»¬ä¸ºå¸®åŠ©å¼€å‘Kubernetesç”Ÿæ€ç³»ç»Ÿè€Œä¸æ–­åŠªåŠ›çš„ä¸€éƒ¨åˆ†ã€‚ä½œä¸ºé€Ÿåº¦æœ€å¿«çš„å¼€æºé¡¹ç›®ä¹‹ä¸€ï¼ŒKubernetesçš„ä½¿ç”¨æ­£åœ¨çˆ†ç‚¸å¼å¢é•¿ã€‚\næ¡ä»¶ # æ­¤è€ƒè¯•æ²¡æœ‰å¿…å¤‡æ¡ä»¶ã€‚\nè€ƒè¯ç›¸å…³ # è€ƒè¯•æ¨¡å¼ï¼šçº¿ä¸Š ã€è€ƒè¯•ä¸­å¿ƒ ï¼ˆæŸ¥çœ‹è€ƒè¯•ä¸­å¿ƒåœ°ç‚¹ï¼‰\nè€ƒè¯•æ—¶é—´ï¼š3å°æ—¶\nè®¤è¯æœ‰æ•ˆæœŸï¼š3å¹´\nè½¯ä»¶ç‰ˆæœ¬ï¼šKubernetes v1.15\né‡è€ƒæ”¿ç­–ï¼šå¯æ¥å—é‡è€ƒ\nç»éªŒæ°´å¹³ï¼šä¸­çº§\nè€ƒç”Ÿéœ€äºè´­ä¹°è€ƒè¯•åï¼Œ12ä¸ªæœˆå†…è¿›è¡Œè€ƒè¯•ã€‚é€šè¿‡è®¤è¯è€ƒè¯•çš„è€ƒç”Ÿå°†è·å¾—PDFè®¤è¯è¯ä¹¦ã€‚\nçº¿ä¸‹è€ƒè¯•ä¸­å¿ƒåœ°å€ # ä¸ºäº†ä½¿ä¸­å›½è€ƒç”Ÿä¾¿äºè¿›è¡ŒLFè®¤è¯è€ƒè¯•ï¼Œæˆ‘ä»¬ä¸PSIè€ƒè¯•ä¸­å¿ƒåˆä½œï¼Œäºä¸­å›½å„å¤§åŸå¸‚å¼€è®¾è€ƒè¯•åœ°ç‚¹ï¼Œå› æ­¤è€ƒç”Ÿåœ¨é¢„çº¦æ—¶é—´åˆ°PSIè€ƒè¯•ä¸­å¿ƒè¿›è¡Œè€ƒè¯•ã€‚ä»¥ä¸‹ä¸ºç°æ—¶å¼€è®¾çš„PSIè€ƒç‚¹ï¼š\nåŒ—äº¬è€ƒç‚¹ - 1 # åœ°å€ï¼šATA - åŒ—äº¬å¸‚æœé˜³åŒºä¸œä¸‰ç¯ä¸­è·¯39å·å»ºå¤–SOHO 2å·æ¥¼ä¸œé—¨1æ¥¼\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š18601068015 (Zhang lu)\nåŒ—äº¬è€ƒç‚¹ - 2 # åœ°å€ï¼šATAå›½é™…è®¤è¯ä¸­å¿ƒ - åŒ—äº¬å¸‚æµ·æ·€åŒºåŒ—æ¸…è·¯103å·ä¸­ç§‘äº§ä¸šå›­1Bæ¥¼\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š18810630020 (Liu xingyuan)\nä¸Šæµ·è€ƒç‚¹ # åœ°å€ï¼šATA - ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºåšäº‘è·¯36å·Eåº§\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š17621888482 (Lu yinmin)\nå—äº¬è€ƒç‚¹ # åœ°å€ï¼šå—äº¬å…‰å£°è¶…æ„ææ–™ç ”ç©¶é™¢ ä¹æ¥¼ æ±Ÿè‹çœå—äº¬å¸‚æ –éœåŒºä¹ä¹¡æ²³ä¸œè·¯ä¸çº¬åœ°è·¯äº¤å‰è·¯ä¸œï¼ˆå—äº¬å¤§å­¦ä»™æ—æ ¡åŒºå†…ï¼‰\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š15895833908 (Liu dandan)\næˆéƒ½è€ƒç‚¹ # åœ°å€ï¼šå››å·çœæˆéƒ½å¸‚æ­¦ä¾¯åŒºç§‘å›­ä¸‰è·¯4å·ç«ç‚¬æ—¶ä»£AåŒº5å±‚504\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š18980764881 (Liu xiujun)\nå¹¿å·è€ƒç‚¹ # å¹¿å·å¸‚å¤©æ²³åŒºä½“è‚²ä¸œè·¯108å·åˆ›å±•ä¸­å¿ƒè¥¿åº§1501å•å…ƒ\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š15989163312 (zhong zhiwen)\næµå—è€ƒç‚¹ # åœ°å€ï¼šæµå—å¸‚å¸‚ä¸­åŒºç»å››è·¯ä¸‡è¾¾å¹¿åœºBåº§905å®¤\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š13911251487 (li shuai)\næ²ˆé˜³è€ƒç‚¹ # åœ°å€ï¼šè¾½å®çœæ²ˆé˜³å¸‚å’Œå¹³åŒºé’å¹´å¤§è¡—286å·åæ¶¦å¤§å¦Aåº§2006å®¤\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š18642085483 (yu zhongbao)\næ·±åœ³è€ƒç‚¹ # åœ°å€ï¼šæ·±åœ³å¸‚ç¦ç”°åŒºå…«å¦äºŒè·¯616æ ‹4æ¥¼\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š17507581649 (chen junhui)\nè¥¿å®‰è€ƒç‚¹ # åœ°å€ï¼šé™•è¥¿çœè¥¿å®‰å¸‚æ–°åŸåŒºåŒ—å¤§è¡—55å·æ–°æ—¶ä»£å¹¿åœº10D\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š17719529253 (cui fenle)\nå¤§è¿è€ƒç‚¹ # åœ°å€ï¼šè¾½å®çœå¤§è¿å¸‚æ²™æ²³å£åŒºååŒ—è·¯311å·\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š18641107099 (Fu baohui)\nåˆè‚¥è€ƒç‚¹ # åœ°å€ï¼šåˆè‚¥å¸‚æ–°ç«™åŒºèŒæ•™åŸæ–‡å¿ è·¯ä¸å­¦æ—è·¯äº¤å‰å£å‘ä¸œ100ç±³\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š13955138415 (Jin bao)\né•¿æ²™è€ƒç‚¹ # åœ°å€ï¼šæ¹–å—çœé•¿æ²™å¸‚å²³éº“åŒºç‹å®¶æ¹¾ç«‹äº¤æ¡¥æ´‹æµ·å¡˜168å·3æ¥¼é•¿æ²™å²³éº“ä¸“ä¿®å­¦é™¢\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š18229631151 (Zhang yufeng)\né‡åº†è€ƒç‚¹ # åœ°å€ï¼šé‡åº†å¸‚ä¹é¾™å¡åŒºæ¸å·è·¯é•¿çŸ³æ‘24å·\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š13101380163 (Dai shuang)\næ­å·è€ƒç‚¹ # åœ°å€ï¼šæµ™æ±Ÿçœæ­å·å¸‚ä¸‹åŸåŒºç»å…´è·¯ç„¦å®¶é‡Œ1å¼„3å·æ–‡æºç”µå•†åˆ›æ„äº§ä¸šå›­\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š13675866166 (Su gutian)\nå¤©æ´¥è€ƒç‚¹ # åœ°å€ï¼šå¤©æ´¥å¸‚å—å¼€åŒºè¿æ°´é“1å·\nè€ƒåœºæŸ¥è¯¢ç”µè¯ï¼š13164040242 (Zhou yueyin)\né¢†åŸŸå’Œèƒ½åŠ› # CKAè®¤è¯é’ˆå¯¹è€ƒæ ¸æˆä¸ºå½“ä¸šç•Œçš„Kubernetesç®¡ç†å‘˜æ‰€éœ€çš„æŠ€èƒ½ã€‚\nè€ƒçº²å’Œæƒé‡ # CKAè®¤è¯è€ƒè¯•åŒ…æ‹¬è¿™äº›ä¸€èˆ¬é¢†åŸŸåŠå…¶åœ¨è€ƒè¯•ä¸­çš„æƒé‡ï¼š\nåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸç®¡ç† - 8ï¼…\tå®‰è£…ã€é…ç½®å’ŒéªŒè¯ - 12ï¼…\tæ ¸å¿ƒæ¦‚å¿µ - 19ï¼…\nç½‘ç»œ - 11ï¼…\tè°ƒåº¦ - 5ï¼…\tå®‰å…¨ - 12ï¼…\né›†ç¾¤ç»´æŠ¤ - 11ï¼…\tè®°å½•/ç›‘æ§ - 5ï¼…\tå­˜å‚¨ - 7ï¼…\næ•…éšœæ’é™¤ - 10ï¼…\nè¯¦ç»†å†…å®¹ï¼š # åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸç®¡ç† - 8ï¼…\nâ€¢ äº†è§£éƒ¨ç½²ä»¥åŠå¦‚ä½•æ‰§è¡Œæ»šåŠ¨æ›´æ–°å’Œå›æ»š\nâ€¢ äº†è§£é…ç½®åº”ç”¨ç¨‹åºçš„å„ç§æ–¹æ³•\nâ€¢ äº†è§£å¦‚ä½•æ‰©å±•åº”ç”¨ç¨‹åº\nâ€¢ äº†è§£åˆ›å»ºè‡ªæˆ‘ä¿®å¤åº”ç”¨ç¨‹åºæ‰€éœ€çš„åŸè¯­\nå®‰è£…ã€é…ç½®å’ŒéªŒè¯ - 12ï¼…\nâ€¢ è®¾è®¡Kubernetesé›†ç¾¤\nâ€¢ å®‰è£…Kubernetes Masterså’ŒNodes\nâ€¢ é…ç½®å®‰å…¨ç¾¤é›†é€šä¿¡\nâ€¢ é…ç½®é«˜å¯ç”¨æ€§Kubernetesé›†ç¾¤\nâ€¢ çŸ¥é“ä»å“ªé‡Œè·å–Kuberneteså‘å¸ƒäºŒè¿›åˆ¶æ–‡ä»¶\nâ€¢ é…ç½®åº•å±‚åŸºç¡€æ¶æ„ä»¥éƒ¨ç½²Kubernetesé›†ç¾¤\nâ€¢ é€‰æ‹©ç½‘ç»œè§£å†³æ–¹æ¡ˆ\nâ€¢ é€‰æ‹©æ‚¨çš„KubernetesåŸºç¡€æ¶æ„é…ç½®\nâ€¢ åœ¨ç¾¤é›†ä¸Šè¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•\nâ€¢ åˆ†æç«¯åˆ°ç«¯æµ‹è¯•ç»“æœ\nâ€¢ è¿è¡ŒèŠ‚ç‚¹ç«¯åˆ°ç«¯æµ‹è¯•\nâ€¢ å®‰è£…å¹¶ä½¿ç”¨kubeadmæ¥å®‰è£…ï¼Œé…ç½®å’Œç®¡ç†Kubernetesé›†ç¾¤\næ ¸å¿ƒæ¦‚å¿µ - 19ï¼…\nâ€¢ äº†è§£Kubernetes APIåŸè¯­\nâ€¢ äº†è§£Kubernetesé›†ç¾¤æ¶æ„\nâ€¢ äº†è§£æœåŠ¡å’Œå…¶ä»–ç½‘ç»œåŸè¯­\nç½‘ç»œ - 11ï¼…\nâ€¢ äº†è§£ç¾¤é›†èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œé…ç½®\nâ€¢ äº†è§£Podç½‘ç»œæ¦‚å¿µ\nâ€¢ äº†è§£æœåŠ¡ç½‘ç»œ\nâ€¢ éƒ¨ç½²å’Œé…ç½®ç½‘ç»œè´Ÿè½½å¹³è¡¡å™¨\nâ€¢ äº†è§£å¦‚ä½•ä½¿ç”¨Ingressè§„åˆ™\nâ€¢ äº†è§£å¦‚ä½•é…ç½®å’Œä½¿ç”¨ç¾¤é›†DNS\nâ€¢ äº†è§£CNI\nè°ƒåº¦ - 5ï¼…\nâ€¢ ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨æ¥å®‰æ’Pod\nâ€¢ äº†è§£DaemonSetsçš„ä½œç”¨\nâ€¢ äº†è§£èµ„æºé™åˆ¶å¦‚ä½•å½±å“Podè°ƒåº¦\nâ€¢ äº†è§£å¦‚ä½•è¿è¡Œå¤šä¸ªè°ƒåº¦ç¨‹åºä»¥åŠå¦‚ä½•é…ç½®Podä»¥ä½¿ç”¨å®ƒä»¬\nâ€¢ æ‰‹åŠ¨å®‰æ’æ²¡æœ‰è°ƒåº¦ç¨‹åºçš„å®¹å™¨\nâ€¢ æ˜¾ç¤ºè°ƒåº¦ç¨‹åºäº‹ä»¶\nå®‰å…¨ - 12ï¼…\nâ€¢ äº†è§£å¦‚ä½•é…ç½®èº«ä»½éªŒè¯å’Œæˆæƒ\nâ€¢ äº†è§£Kuberneteså®‰å…¨åŸè¯­\nâ€¢ äº†è§£å¦‚ä½•é…ç½®ç½‘ç»œç­–ç•¥\nâ€¢ ä¸ºç¾¤é›†ç»„ä»¶åˆ›å»ºå’Œç®¡ç†TLSè¯ä¹¦\nâ€¢ å®‰å…¨åœ°å¤„ç†å›¾åƒ\nâ€¢ å®šä¹‰å®‰å…¨ä¸Šä¸‹æ–‡\nâ€¢ å®‰å…¨æŒä¹…å¯†é’¥å€¼å­˜å‚¨\né›†ç¾¤ç»´æŠ¤ - 11ï¼…\nâ€¢ äº†è§£Kubernetesé›†ç¾¤å‡çº§è¿‡ç¨‹\nâ€¢ ä¿ƒè¿›æ“ä½œç³»ç»Ÿå‡çº§\nâ€¢ å®æ–½å¤‡ä»½å’Œè¿˜åŸæ–¹æ³•\nè®°å½•/ç›‘æ§ - 5ï¼…\nâ€¢ äº†è§£å¦‚ä½•ç›‘æ§æ‰€æœ‰ç¾¤é›†ç»„ä»¶\nâ€¢ äº†è§£å¦‚ä½•ç›‘æ§åº”ç”¨ç¨‹åº\nâ€¢ ç®¡ç†ç¾¤é›†ç»„ä»¶æ—¥å¿—\nâ€¢ ç®¡ç†åº”ç”¨ç¨‹åºæ—¥å¿—\nå­˜å‚¨ - 7ï¼…\nâ€¢ äº†è§£æŒä¹…å·å¹¶äº†è§£å¦‚ä½•åˆ›å»ºå®ƒä»¬\nâ€¢ äº†è§£å·çš„è®¿é—®æ¨¡å¼\nâ€¢ äº†è§£æŒä¹…æ€§å·å£°æ˜åŸè¯­\nâ€¢ äº†è§£Kuberneteså­˜å‚¨å¯¹è±¡\nâ€¢ äº†è§£å¦‚ä½•ä½¿ç”¨æŒä¹…å­˜å‚¨é…ç½®åº”ç”¨ç¨‹åº\nç–‘éš¾è§£ç­” - 10ï¼…\nâ€¢ è§£å†³åº”ç”¨ç¨‹åºæ•…éšœ\nâ€¢ æ’é™¤æ§åˆ¶å¹³é¢æ•…éšœ\nâ€¢ è§£å†³å·¥ä½œèŠ‚ç‚¹æ•…éšœ\nâ€¢ æ’é™¤ç½‘ç»œæ•…éšœ\n","date":"2019å¹´11æœˆ21æ—¥","externalUrl":null,"permalink":"/posts/cka%E6%A6%82%E8%BF%B0%E8%80%83%E8%AF%95%E5%BD%A2%E5%BC%8F%E8%80%83%E8%AF%95%E5%9C%B0%E5%9D%80%E8%80%83%E7%BA%B2%E5%8D%A0%E6%AF%94%E7%AD%89/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eCKAæ¦‚è¿° \n    \u003cdiv id=\"ckaæ¦‚è¿°\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#cka%e6%a6%82%e8%bf%b0\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eè®¤è¯Kubernetesç®¡ç†å‘˜ï¼ˆCKAï¼‰è®¡åˆ’ç”±LinuxåŸºé‡‘ä¼šå’Œäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼ˆCNCFï¼‰åˆ›å»ºï¼Œä½œä¸ºä»–ä»¬ä¸ºå¸®åŠ©å¼€å‘Kubernetesç”Ÿæ€ç³»ç»Ÿè€Œä¸æ–­åŠªåŠ›çš„ä¸€éƒ¨åˆ†ã€‚ä½œä¸ºé€Ÿåº¦æœ€å¿«çš„å¼€æºé¡¹ç›®ä¹‹ä¸€ï¼ŒKubernetesçš„ä½¿ç”¨æ­£åœ¨çˆ†ç‚¸å¼å¢é•¿ã€‚\u003c/p\u003e","title":"CKAæ¦‚è¿°ã€è€ƒè¯•å½¢å¼ã€è€ƒè¯•åœ°å€ã€è€ƒçº²å æ¯”ç­‰","type":"posts"},{"content":"æ¥ä¸Šä¸€ç¯‡ å¤‡æˆ˜CKAæ¯æ—¥ä¸€é¢˜â€”â€”ç¬¬1å¤©\næ˜¨æ—¥è€ƒé¢˜ # ä»¥ä¸‹ Daemonset yaml ä¸­ï¼Œå“ªäº›æ˜¯æ­£ç¡®çš„ï¼Ÿï¼ˆå¤šé€‰ï¼‰\nA. apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: default labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: containers: - name: fluentd-elasticsearch image: gcr.io/fluentd-elasticsearch/fluentd:v2.5.1 restartPolicy: Never B. apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: default labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: containers: - name: fluentd-elasticsearch image: gcr.io/fluentd-elasticsearch/fluentd:v2.5.1 restartPolicy: Onfailure C. apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: default labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: containers: - name: fluentd-elasticsearch image: gcr.io/fluentd-elasticsearch/fluentd:v2.5.1 restartPolicy: Always D. apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: default labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: containers: - name: fluentd-elasticsearch image: gcr.io/fluentd-elasticsearch/fluentd:v2.5.1 æ˜¨æ—¥ç­”æ¡ˆ # CD\næ˜¨æ—¥è§£æ # åœ¨è€ƒè¯•æ—¶ï¼Œåªèƒ½ç”¨è°·æ­Œæµè§ˆå™¨ï¼Œå¹¶æ‰“å¼€ä¸¤ä¸ªæ ‡ç­¾é¡µï¼Œä¸€ä¸ªæ˜¯è€ƒé¢˜çš„æ ‡ç­¾é¡µï¼Œå¦ä¸€ä¸ªæ˜¯kuberneteså®˜ç½‘æ ‡ç­¾é¡µã€‚https://kubernetes.io/\næŸ¥è¯¢daemonsetçš„è¯´æ˜æ–‡æ¡£ï¼Œè§ä»¥ä¸‹é“¾æ¥ï¼š\nhttps://kubernetes.io/docs/concepts/workloads/controllers/daemonset/\nA Pod Template in a DaemonSet must have a RestartPolicy equal to Always, or be unspecified, which defaults to Always.\nDaemonseté‡Œçš„pod Templateä¸‹å¿…é¡»æœ‰RestartPolicyï¼Œå¦‚æœæ²¡æŒ‡å®šï¼Œä¼šé»˜è®¤ä¸ºAlways\nrestartPolicy å­—æ®µï¼Œå¯é€‰å€¼ä¸º Alwaysã€OnFailure å’Œ Neverã€‚é»˜è®¤ä¸º Alwaysã€‚ ä¸€ä¸ªPodä¸­å¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼ŒrestartPolicyé€‚ç”¨äºPod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚restartPolicyä½œç”¨æ˜¯ï¼Œè®©kubeleté‡å¯å¤±è´¥çš„å®¹å™¨ã€‚\nå¦å¤–Deploymentã€Statefulsetçš„restartPolicyä¹Ÿå¿…é¡»ä¸ºAlwaysï¼Œä¿è¯podå¼‚å¸¸é€€å‡ºï¼Œæˆ–è€…å¥åº·æ£€æŸ¥livenessProbeå¤±è´¥åç”±kubeleté‡å¯å®¹å™¨ã€‚\nhttps://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/\nJobå’ŒCronJobæ˜¯è¿è¡Œä¸€æ¬¡çš„podï¼ŒrestartPolicyåªèƒ½ä¸ºOnFailureæˆ–Neverï¼Œç¡®ä¿å®¹å™¨æ‰§è¡Œå®Œæˆåä¸å†é‡å¯ã€‚\nhttps://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/\nä»Šæ—¥è€ƒé¢˜ # åœ¨Kubernetes PVC+PVä½“ç³»ä¸‹é€šè¿‡CSIå®ç°çš„volume pluginsåŠ¨æ€åˆ›å»ºpvåˆ°pvå¯è¢«podä½¿ç”¨æœ‰å“ªäº›ç»„ä»¶éœ€è¦å‚ä¸ï¼Ÿ\nA. PersistentVolumeController + CSI-Provisoner + CSI controller plugin B. AttachDetachController + CSI-Attacher + CSI controller plugin C. Kubelet + CSI node plugin ","date":"2019å¹´11æœˆ19æ—¥","externalUrl":null,"permalink":"/posts/%E5%A4%87%E6%88%98cka%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%E7%AC%AC2%E5%A4%A9daemonset%E5%AF%B9%E6%8E%A5%E5%AD%98%E5%82%A8csi%E7%9F%A5%E8%AF%86%E7%82%B9/","section":"Posts","summary":"\u003cp\u003e\u003cstrong\u003eæ¥ä¸Šä¸€ç¯‡\n\u003ca href=\"https://kubeinfo.cn/go/?target=aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvMTAzMTI2OTAz\" target=\"_blank\" \u003eå¤‡æˆ˜CKAæ¯æ—¥ä¸€é¢˜â€”â€”ç¬¬1å¤©\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ˜¨æ—¥è€ƒé¢˜ \n    \u003cdiv id=\"æ˜¨æ—¥è€ƒé¢˜\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%98%a8%e6%97%a5%e8%80%83%e9%a2%98\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä»¥ä¸‹ Daemonset yaml ä¸­ï¼Œå“ªäº›æ˜¯æ­£ç¡®çš„ï¼Ÿï¼ˆå¤šé€‰ï¼‰\u003c/p\u003e","title":"å¤‡æˆ˜CKAæ¯æ—¥ä¸€é¢˜â€”â€”ç¬¬2å¤© | Daemonsetã€å¯¹æ¥å­˜å‚¨CSIçŸ¥è¯†ç‚¹","type":"posts"},{"content":"è¿™ä¸¤å¹´ Kubernetes å·²ç»æˆä¸ºå®¹å™¨ç¼–æ’çš„äº‹å®æ ‡å‡†ï¼Œé¢„è®¡æœªæ¥ä¸¤å¹´å†…å°†å…¨é¢æ™®åŠï¼Œç°åœ¨ä¼ä¸šæ‹›è¿™å—äººæ‰éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šå¤§ï¼Œå·¥èµ„ä¹Ÿæ˜¯å¾ˆé«˜çš„ï¼Œæœªæ¥è¿™å—çš„å‘å±•ç©ºé—´ä¹Ÿå¾ˆå¤§ã€‚\næœ€è¿‘æ­£å‡†å¤‡å¤‡è€ƒCKAï¼ŒCKAæ˜¯ä»€ä¹ˆï¼Ÿæœ‰äº›äººå¯èƒ½è¿˜ä¸çŸ¥é“ï¼Œè¿™é‡Œç®€å•æ™®åŠä¸€ä¸‹ï¼š\nCKA è¯ä¹¦æ˜¯äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š CNCF ç»„ç»‡çš„ï¼Œè€ƒå¯Ÿçš„æ˜¯ä½ æ˜¯å¦å…·å¤‡è¶³å¤Ÿç®¡ç† Kubernetes é›†ç¾¤çš„å¿…å¤‡çŸ¥è¯†ã€‚è€ƒè¯•å½¢å¼æ˜¯ä¸Šæœºç›´æ¥åœ¨é›†ç¾¤ä¸Šæ“ä½œï¼Œé™æ—¶ 3 å°æ—¶ï¼Œéå¸¸è€ƒéªŒä¸ªäººçŸ¥è¯†çš„æ‰å®ç¨‹åº¦å’Œ Kubernetes å®è·µç»éªŒã€‚è€ƒä¸Š 75 åˆ†ï¼Œä½ å°±èƒ½æ‹¿åˆ°è¯ä¹¦ã€‚è€ƒè¯•æœŸé—´åªå¯æŸ¥é˜…K8Så®˜æ–¹æ‰‹å†Œã€‚è¯ä¹¦æœ‰æ•ˆæœŸä¸¤å¹´ï¼Œè€ƒè¯•è´¹ç”¨300ç¾å…ƒï¼ˆå›½å¤–è€ƒè¯•è´¹ç”¨å°±æ˜¯è´µï¼‰ï¼Œä¸€å¹´å†…å¯æœ‰ä¸€æ¬¡å…è´¹è¡¥è€ƒçš„æœºä¼šã€‚\nCKAè¯ä¹¦çš„å«é‡‘é‡å¦‚ä½•ï¼Ÿè€ƒä¸è€ƒè¿™ä¸ªè¯å®Œå…¨å–å†³äºä¸ªäººï¼Œå› ä¸ºæŒè¯å¹¶ä¸ç­‰äºä¸Šå²—ï¼Œå°¤å…¶æ˜¯ä¸Šå¿ƒä»ªå…¬å¸çš„å²—ã€‚è€ƒè¯å¯ä»¥å¸®ä½ è·å¾—åˆçº§èŒä½ï¼Œä½†é«˜çº§èŒä½éœ€è¦ä¸ªäººç»éªŒçš„å¤§é‡ç§¯ç´¯ã€‚è€Œç«™åœ¨é¢è¯•å®˜çš„è§’åº¦çœ‹ï¼Œæœ‰è¿™ä¸ªè¯è‡³å°‘å¯ä»¥ä¸ºä½ æä¸€ä¸ªé¢è¯•æœºä¼šï¼Œå°¤å…¶æ˜¯åº”å±Šç”Ÿå’Œæœ‰è½¬å²—æƒ³æ³•çš„ç¨‹åºå‘˜ã€‚è¿™äº›äººå¯èƒ½ç¼ºä¹è¶³å¤Ÿç»éªŒï¼Œä½† CKA è¯å¾ˆèƒ½ä½“ç°ä¸ªäººæŠ€æœ¯æ°´å¹³ï¼Œè¡Œä¸šè®¤å¯ç¨‹åº¦ä¹Ÿå¾ˆé«˜ã€‚\nè€ƒçº²å¦‚ä¸‹ # å¯è®¿é—®https://github.com/cncf/curriculumå…³æ³¨æœ€æ–°çš„è€ƒçº²å˜åŒ–ï¼\nä½œä¸ºåœ¨KubernetesæŠ€æœ¯ä¸Šæ‘¸çˆ¬æ»šæ‰“1å¹´å¤šçš„è€é¸Ÿï¼Œæœ€è¿‘æ­£å‡†å¤‡å¤‡è€ƒCKAï¼Œé‰´äºæ­¤ï¼Œæˆ‘å¸Œæœ›æƒ³è¯æ˜è‡ªå·±kuberneteså¼€å‘è¿ç»´èƒ½åŠ›çš„å°ä¼™ä¼´èƒ½ä¸€èµ·ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬ä¸€èµ·æ¯æ—¥ä¸€é¢˜ï¼Œåœ¨ç•™è¨€åŒºç­”é¢˜æ‰“å¡ã€‚\nä»Šæ—¥è€ƒé¢˜ # ä»¥ä¸‹ Daemonset yaml ä¸­ï¼Œå“ªäº›æ˜¯æ­£ç¡®çš„ï¼Ÿï¼ˆå¤šé€‰ï¼‰\nA. apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: default labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: containers: - name: fluentd-elasticsearch image: gcr.io/fluentd-elasticsearch/fluentd:v2.5.1 restartPolicy: Never B. apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: default labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: containers: - name: fluentd-elasticsearch image: gcr.io/fluentd-elasticsearch/fluentd:v2.5.1 restartPolicy: Onfailure C. apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: default labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: containers: - name: fluentd-elasticsearch image: gcr.io/fluentd-elasticsearch/fluentd:v2.5.1 restartPolicy: Always D. apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: default labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: containers: - name: fluentd-elasticsearch image: gcr.io/fluentd-elasticsearch/fluentd:v2.5.1 æ¯æ—¥è§£ç­” # æ¯æ—¥ç­”é¢˜æ‰“å¡ï¼Œç¬¬äºŒå¤©ä¼šè¾ƒè¯¦ç»†çš„åˆ†æè€ƒé¢˜ç­”æ¡ˆï¼Œå°½é‡åšåˆ°çŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚æœ€ç»ˆè¿˜æœ‰ç”µå­ä¹¦é€ç»™å¤§å®¶ï¼Œæ¬¢è¿å‚ä¸ï¼æˆ‘ä»¬ä¸€èµ·å¤‡è€ƒã€‚\n","date":"2019å¹´11æœˆ19æ—¥","externalUrl":null,"permalink":"/posts/%E5%A4%87%E6%88%98cka%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98%E7%AC%AC1%E5%A4%A9cka%E7%AE%80%E4%BB%8B%E8%80%83%E7%BA%B2daemonset%E7%9F%A5%E8%AF%86%E7%9F%A5%E8%AF%86%E7%82%B9%E5%88%9D%E6%8E%A2/","section":"Posts","summary":"\u003cp\u003eè¿™ä¸¤å¹´ Kubernetes å·²ç»æˆä¸ºå®¹å™¨ç¼–æ’çš„äº‹å®æ ‡å‡†ï¼Œé¢„è®¡æœªæ¥ä¸¤å¹´å†…å°†å…¨é¢æ™®åŠï¼Œç°åœ¨ä¼ä¸šæ‹›è¿™å—äººæ‰éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šå¤§ï¼Œå·¥èµ„ä¹Ÿæ˜¯å¾ˆé«˜çš„ï¼Œæœªæ¥è¿™å—çš„å‘å±•ç©ºé—´ä¹Ÿå¾ˆå¤§ã€‚\u003c/p\u003e","title":"å¤‡æˆ˜CKAæ¯æ—¥ä¸€é¢˜â€”â€”ç¬¬1å¤© | CKAç®€ä»‹ã€è€ƒçº²ã€DaemonsetçŸ¥è¯†çŸ¥è¯†ç‚¹åˆæ¢","type":"posts"},{"content":"","date":"2019å¹´11æœˆ3æ—¥","externalUrl":null,"permalink":"/tags/blog/","section":"Tags","summary":"","title":"Blog","type":"tags"},{"content":"","date":"2019å¹´11æœˆ3æ—¥","externalUrl":null,"permalink":"/tags/mysql/","section":"Tags","summary":"","title":"Mysql","type":"tags"},{"content":" 1ã€èƒŒæ™¯ # å‰ä¸¤å¤©åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šæ­å»ºäº†è‡ªå·±çš„åšå®¢ï¼Œä¸€åˆ‡éƒ½å¾ˆé¡ºåˆ©ï¼Œä»Šå¤©åœ¨ç‚¹å‡»å½’æ¡£æŒ‰é’®æ—¶ï¼Œå‘ç°æ˜¯æŠ¥404ã€‚äºæ˜¯æˆ‘æŠŠsoloä»£ç åœ¨æœ¬åœ°è¿è¡Œèµ·æ¥ï¼Œç”¨æœ¬åœ°çš„mysqlæ•°æ®åº“ï¼Œçœ‹æ˜¯å¦æœ‰åŒæ ·çš„é—®é¢˜ï¼Œç»“æœæ˜¯å¯ä»¥æ­£å¸¸è®¿é—®çš„ã€‚é‚£å°±çœ‹çœ‹æœåŠ¡å™¨ä¸Šçš„soloæ—¥å¿—å‘—ï¼Œç»“æœå‘ç°äº†ä»¥ä¸‹æŠ¥é”™ï¼š\nCaused by: org.b3log.latke.repository.RepositoryException: java.sql.SQLSyntaxErrorException: Expression #20 of SELECT list is not in GROUP BY clause and contains nonaggregated column \u0026#39;solo.aa.oId\u0026#39; which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by åŸæ¥ï¼Œè¿™ä¸ªé—®é¢˜å‡ºç°åœ¨MySQL5.7åç‰ˆæœ¬ä¸Šï¼Œé»˜è®¤çš„sql_modeå€¼æ˜¯è¿™æ ·çš„ï¼š\nONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION é‚£ä¹ˆsql_mode æœ‰å“ªäº›é…ç½®ï¼Ÿéƒ½ä»£è¡¨ä»€ä¹ˆæ„æ€ï¼Ÿ\n2ã€sql_mode é…ç½®è§£æ # ONLY_FULL_GROUP_BY\nå¯¹äºGROUP BYèšåˆæ“ä½œï¼Œå¦‚æœåœ¨SELECTä¸­çš„åˆ—ï¼Œæ²¡æœ‰åœ¨GROUP BYä¸­å‡ºç°ï¼Œé‚£ä¹ˆè¿™ä¸ªSQLæ˜¯ä¸åˆæ³•çš„ï¼Œå› ä¸ºåˆ—ä¸åœ¨GROUP BYä»å¥ä¸­ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯SELECTåé¢æ¥çš„åˆ—å¿…é¡»è¢«GROUP BYåé¢æ¥çš„åˆ—æ‰€åŒ…å«ã€‚å¦‚ï¼š\nselect a,b from table group by a,b,c; (æ­£ç¡®) select a,b,c from table group by a,b; (é”™è¯¯) è¿™ä¸ªé…ç½®ä¼šä½¿å¾—GROUP BYè¯­å¥ç¯å¢ƒå˜å¾—ååˆ†ç‹­çª„ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ä¸åŠ è¿™ä¸ªé…ç½®\nNO_AUTO_VALUE_ON_ZERO è¯¥å€¼å½±å“è‡ªå¢é•¿åˆ—çš„æ’å…¥ã€‚é»˜è®¤è®¾ç½®ä¸‹ï¼Œæ’å…¥0æˆ–NULLä»£è¡¨ç”Ÿæˆä¸‹ä¸€ä¸ªè‡ªå¢é•¿å€¼ã€‚ï¼ˆä¸ä¿¡çš„å¯ä»¥è¯•è¯•ï¼Œé»˜è®¤çš„sql_modeä½ åœ¨è‡ªå¢ä¸»é”®åˆ—è®¾ç½®ä¸º0ï¼Œè¯¥å­—æ®µä¼šè‡ªåŠ¨å˜ä¸ºæœ€æ–°çš„è‡ªå¢å€¼ï¼Œæ•ˆæœå’Œnullä¸€æ ·ï¼‰ï¼Œå¦‚æœç”¨æˆ·å¸Œæœ›æ’å…¥çš„å€¼ä¸º0ï¼ˆä¸æ”¹å˜ï¼‰ï¼Œè¯¥åˆ—åˆæ˜¯è‡ªå¢é•¿çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªé€‰é¡¹å°±æœ‰ç”¨äº†ã€‚\nSTRICT_TRANS_TABLES åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œå¦‚æœä¸€ä¸ªå€¼ä¸èƒ½æ’å…¥åˆ°ä¸€ä¸ªäº‹åŠ¡è¡¨ä¸­ï¼Œåˆ™ä¸­æ–­å½“å‰çš„æ“ä½œï¼Œå¯¹éäº‹åŠ¡è¡¨ä¸åšé™åˆ¶ã€‚ï¼ˆInnoDBé»˜è®¤äº‹åŠ¡è¡¨ï¼ŒMyISAMé»˜è®¤éäº‹åŠ¡è¡¨ï¼›MySQLäº‹åŠ¡è¡¨æ”¯æŒå°†æ‰¹å¤„ç†å½“åšä¸€ä¸ªå®Œæ•´çš„ä»»åŠ¡ç»Ÿä¸€æäº¤æˆ–å›æ»šï¼Œå³å¯¹åŒ…å«åœ¨äº‹åŠ¡ä¸­çš„å¤šæ¡è¯­å¥è¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚éäº‹åŠ¡è¡¨åˆ™ä¸æ”¯æŒæ­¤ç§æ“ä½œï¼Œæ‰¹å¤„ç†ä¸­çš„è¯­å¥å¦‚æœé‡åˆ°é”™è¯¯ï¼Œåœ¨é”™è¯¯å‰çš„è¯­å¥æ‰§è¡ŒæˆåŠŸï¼Œä¹‹åçš„åˆ™ä¸æ‰§è¡Œï¼›MySQLäº‹åŠ¡è¡¨æœ‰è¡¨é”ä¸è¡Œé”éäº‹åŠ¡è¡¨åˆ™åªæœ‰è¡¨é”ï¼‰\nNO_ZERO_IN_DATE åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œä¸å…è®¸æ—¥æœŸå’Œæœˆä»½ä¸ºé›¶\nNO_ZERO_DATE è®¾ç½®è¯¥å€¼ï¼Œmysqlæ•°æ®åº“ä¸å…è®¸æ’å…¥é›¶æ—¥æœŸï¼Œæ’å…¥é›¶æ—¥æœŸä¼šæŠ›å‡ºé”™è¯¯è€Œä¸æ˜¯è­¦å‘Šã€‚\nERROR_FOR_DIVISION_BY_ZERO åœ¨INSERTæˆ–UPDATEè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ•°æ®è¢«é›¶é™¤ï¼Œåˆ™äº§ç”Ÿé”™è¯¯è€Œéè­¦å‘Šã€‚å¦‚ æœæœªç»™å‡ºè¯¥æ¨¡å¼ï¼Œé‚£ä¹ˆæ•°æ®è¢«é›¶é™¤æ—¶MySQLè¿”å›NULL\nNO_AUTO_CREATE_USER ç¦æ­¢GRANTåˆ›å»ºå¯†ç ä¸ºç©ºçš„ç”¨æˆ·\nNO_ENGINE_SUBSTITUTION å¦‚æœéœ€è¦çš„å­˜å‚¨å¼•æ“è¢«ç¦ç”¨æˆ–æœªç¼–è¯‘ï¼Œé‚£ä¹ˆæŠ›å‡ºé”™è¯¯ã€‚ä¸è®¾ç½®æ­¤å€¼æ—¶ï¼Œç”¨é»˜è®¤çš„å­˜å‚¨å¼•æ“æ›¿ä»£ï¼Œå¹¶æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸\nPIPES_AS_CONCAT å°†â€||â€è§†ä¸ºå­—ç¬¦ä¸²çš„è¿æ¥æ“ä½œç¬¦è€Œéæˆ–è¿ç®—ç¬¦ï¼Œè¿™å’ŒOracleæ•°æ®åº“æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå’Œå­—ç¬¦ä¸²çš„æ‹¼æ¥å‡½æ•°Concatç›¸ç±»ä¼¼\nANSI_QUOTES å¯ç”¨ANSI_QUOTESåï¼Œä¸èƒ½ç”¨åŒå¼•å·æ¥å¼•ç”¨å­—ç¬¦ä¸²ï¼Œå› ä¸ºå®ƒè¢«è§£é‡Šä¸ºè¯†åˆ«ç¬¦\n3ã€æµ‹è¯• # æœ¬åœ°èµ·ä¸€ä¸ªæ•°æ®åº“ï¼Œå…ˆæŸ¥çœ‹sql_modeæ¨¡å¼ï¼š\nmysql\u0026gt; select @@global.sql_mode; +--------------------------------------------+ | @@global.sql_mode | +--------------------------------------------+ | STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION | +--------------------------------------------+ 1 row in set (0.00 sec) mysql\u0026gt; select @@session.sql_mode; +--------------------------------------------+ | @@session.sql_mode | +--------------------------------------------+ | STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION | +--------------------------------------------+ 1 row in set (0.00 sec) åˆ›å»ºä¸€ä¸ªæµ‹è¯•çš„è¡¨ï¼š\nmysql\u0026gt; CREATE TABLE IF NOT EXISTS `demo`( -\u0026gt; `id` INT UNSIGNED AUTO_INCREMENT, -\u0026gt; `rank` VARCHAR(100) NOT NULL, -\u0026gt; `name` VARCHAR(40) NOT NULL, -\u0026gt; `gender` TINYINT NOT NULL, -\u0026gt; PRIMARY KEY ( `id` ) -\u0026gt; )ENGINE=InnoDB DEFAULT CHARSET=utf8; Query OK, 0 rows affected (0.02 sec) mysql\u0026gt; mysql\u0026gt; show tables; +----------------+ | Tables_in_test | +----------------+ | demo | +----------------+ 1 row in set (0.00 sec) mysql\u0026gt; desc demo; +--------+------------------+------+-----+---------+------------ | Field | Type | Null | Key | Default | Extra +--------+------------------+------+-----+---------+------------ | id | int(10) unsigned | NO | PRI | NULL | auto_increm | rank | varchar(100) | NO | | NULL | | name | varchar(40) | NO | | NULL | | gender | tinyint(4) | NO | | NULL | +--------+------------------+------+-----+---------+------------ 4 rows in set (0.01 sec) æ’å…¥æµ‹è¯•æ•°æ®ï¼š\nmysql\u0026gt; insert into demo values(1, \u0026#39;A\u0026#39;, \u0026#39;coderaction1\u0026#39;, \u0026#39;20\u0026#39;); Query OK, 1 row affected (0.01 sec) mysql\u0026gt; insert into demo values(2, \u0026#39;B\u0026#39;, \u0026#39;coderaction2\u0026#39;, \u0026#39;21\u0026#39;); Query OK, 1 row affected (0.00 sec) mysql\u0026gt; insert into demo values(3, \u0026#39;A\u0026#39;, \u0026#39;coderaction3\u0026#39;, \u0026#39;22\u0026#39;); Query OK, 1 row affected (0.00 sec) mysql\u0026gt; insert into demo values(4, \u0026#39;C\u0026#39;, \u0026#39;coderaction4\u0026#39;, \u0026#39;23\u0026#39;); Query OK, 1 row affected (0.00 sec) mysql\u0026gt; insert into demo values(5, \u0026#39;A\u0026#39;, \u0026#39;coderaction5\u0026#39;, \u0026#39;21\u0026#39;); Query OK, 1 row affected (0.00 sec) mysql\u0026gt; insert into demo values(6, \u0026#39;C\u0026#39;, \u0026#39;coderaction6\u0026#39;, \u0026#39;28\u0026#39;); Query OK, 1 row affected (0.01 sec) mysql\u0026gt; mysql\u0026gt; select * from demo; +----+------+--------------+--------+ | id | rank | name | gender | +----+------+--------------+--------+ | 1 | A | coderaction1 | 20 | | 2 | B | coderaction2 | 21 | | 3 | A | coderaction3 | 22 | | 4 | C | coderaction4 | 23 | | 5 | A | coderaction5 | 21 | | 6 | C | coderaction6 | 28 | +----+------+--------------+--------+ 6 rows in set (0.00 sec) åˆ†åˆ«æ‰§è¡Œä»¥ä¸‹sqlå‘½ä»¤ï¼š\nmysql\u0026gt; select count(id) from demo order by rank; +-----------+ | count(id) | +-----------+ | 6 | +-----------+ 1 row in set (0.01 sec) mysql\u0026gt; select count(id) from demo group by rank; +-----------+ | count(id) | +-----------+ | 3 | | 1 | | 2 | +-----------+ 3 rows in set (0.00 sec) mysql\u0026gt; select count(rank),id from demo group by rank; +-------------+----+ | count(rank) | id | +-------------+----+ | 3 | 1 | | 1 | 2 | | 2 | 4 | +-------------+----+ 3 rows in set (0.00 sec) mysql\u0026gt; select count(rank),id from demo group by id; +-------------+----+ | count(rank) | id | +-------------+----+ | 1 | 1 | | 1 | 2 | | 1 | 3 | | 1 | 4 | | 1 | 5 | | 1 | 6 | +-------------+----+ 6 rows in set (0.00 sec) mysql\u0026gt; å¯ä»¥çœ‹åˆ°ä¸Šé¢å››ä¸ªsqléƒ½æ‰§è¡ŒæˆåŠŸã€‚\nä¿®æ”¹sql_modeï¼Œä¸´æ—¶ä¿®æ”¹sql_modeæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯è®¾ç½®å½“å‰ä¼šè¯è¿æ¥çš„sessionçº§åˆ«çš„sql_modeï¼Œå¦ä¸€ä¸ªæ˜¯globalçº§åˆ«çš„sql_modeã€‚\nsessionçº§åˆ« # å…ˆæ¥çœ‹çœ‹sessionçº§åˆ«çš„sql_modeï¼Œè®¾ç½®æ–¹å¼æœ‰ä¸¤ç§ï¼š\nmysql\u0026gt; set session sql_mode=\u0026#39;ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\u0026#39;; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; set @@session.sql_mode=\u0026#39;ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\u0026#39;; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; select @@session.sql_mode; +-------------------------------------------------------------------------------------------------------------------------------------------+ | @@session.sql_mode | +-------------------------------------------------------------------------------------------------------------------------------------------+ | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | +-------------------------------------------------------------------------------------------------------------------------------------------+ 1 row in set (0.00 sec) è®¾ç½®sessionçº§åˆ«sql_modeï¼Œå½“å‰sessionçº§åˆ«æŸ¥è¯¢åˆ°æ–°çš„ï¼Œä¸‹æ¬¡é‡è¿åå¤±æ•ˆã€‚\nglobalçº§åˆ« # å†çœ‹çœ‹globalçº§åˆ«çš„sql_modeï¼Œè®¾ç½®æ–¹å¼æœ‰ä¸¤ç§ï¼š\nmysql\u0026gt; set @@global.sql_mode=\u0026#39;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\u0026#39;; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; set global sql_mode=\u0026#39;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\u0026#39;; Query OK, 0 rows affected (0.00 sec) mysql\u0026gt; select @@global.sql_mode; +------------------------------------------------------------------------------------------------------------------------+ | @@global.sql_mode | +------------------------------------------------------------------------------------------------------------------------+ | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | +------------------------------------------------------------------------------------------------------------------------+ 1 row in set (0.00 sec) è®¾ç½®globalçº§åˆ«sql_modeï¼Œå½“å‰sessionçº§åˆ«æŸ¥è¯¢åˆ°è¿˜æ˜¯æ—§çš„ï¼Œæ‰€ä»¥æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œè¿˜æ˜¯æŒ‰ç…§æ—§é…ç½®ã€‚ä¸‹æ¬¡é‡è¿ååˆ©ç”¨æ–°é…ç½®ã€‚\nå½“æˆ‘ä»¬è®¾ç½®å®Œä¸Šé¢sessionçº§åˆ«çš„sql_modeï¼Œåœ¨å…¶ä¸­åŠ ONLY_FULL_GROUP_BYåï¼Œæ‰§è¡Œæµ‹è¯•sqlè¯­å¥æŠ¥é”™ï¼š\nmysql\u0026gt; select count(rank),id from demo group by rank; ERROR 1055 (42000): Expression #2 of SELECT list is not in GROUP BY clause and contains nonaggregated column \u0026#39;test.demo.id\u0026#39; which is not functionally dependen t on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by mysql\u0026gt; select count(rank),id from demo group by id; +-------------+----+ | count(rank) | id | +-------------+----+ | 1 | 1 | | 1 | 2 | | 1 | 3 | | 1 | 4 | | 1 | 5 | | 1 | 6 | +-------------+----+ 6 rows in set (0.00 sec) è¿™ä¹ŸéªŒè¯äº†ï¼šSELECTåé¢æ¥çš„åˆ—å¿…é¡»è¢«GROUP BYåé¢æ¥çš„åˆ—æ‰€åŒ…å«ã€‚\næ³¨æ„ï¼šé€šè¿‡sessionå’Œglobalè®¾ç½®ä¸´æ—¶ç”Ÿæ•ˆçš„ï¼Œå³å½“mysqlé‡å¯åï¼Œéƒ½ä¼šå¤±æ•ˆã€‚éœ€è¦åœ¨mysqlå¯åŠ¨é…ç½®æ–‡ä»¶ä¸­é»˜è®¤è®¾ç½®ã€‚\n4ã€è§£å†³åŠæ³• # é™¤äº†ä¸Šé¢æµ‹è¯•æ—¶ç”¨åˆ°çš„ä¸´æ—¶è§£å†³çš„ä¸¤ç§æ–¹æ³•ã€‚è¦æƒ³mysqlé‡å¯åä¾ç„¶ç”Ÿæ•ˆï¼Œéœ€è¦åœ¨mysqlçš„é…ç½®æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯my.cnfä¸­çš„[mysqld]ä¸‹é¢åŠ sql_modeé…ç½®ã€‚å› ä¸ºæˆ‘ä½¿ç”¨çš„æ˜¯k8séƒ¨ç½²çš„mysqlï¼Œé•œåƒå®‰è£…å’Œåœ¨å®¿ä¸»æœºä¸Šé€šè¿‡è½¯ä»¶åŒ…å®‰è£…æœ‰ä¸€å®šå·®åˆ«ã€‚ä½†æœ€ç»ˆè¿˜æ˜¯æ›´æ”¹çš„my.cnfã€‚\nkubectl exec -ti mysql-75797cf796-84rdl bash root@mysql-75797cf796-84rdl:/# root@mysql-75797cf796-84rdl:/# cat /etc/mysql/my.cnf # Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved. # ..... !includedir /etc/mysql/conf.d/ !includedir /etc/mysql/mysql.conf.d/ å¯ä»¥çœ‹åˆ°è¿™é‡ŒåŒ…å«äº†ä¸¤ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ï¼Œmysql.conf.dä¸‹ï¼Œå‘ç°æœ‰æˆ‘ä»¬éœ€è¦æ›´æ”¹çš„æ–‡ä»¶\ncat /etc/mysql/mysql.conf.d/mysqld.cnf æŸ¥çœ‹å¹¶å°†è¯¥æ–‡ä»¶ç”¨kubectl cpå‘½ä»¤æ‹·è´åˆ°å®¿ä¸»æœºä¸Šï¼Œä¿®æ”¹åæœ€ç»ˆè¦æŒ‚è½½è¿›å…¥podé‡Œã€‚\nkubectl cp default/mysql-75797cf796-84rdl:/etc/mysql/mysql.conf.d/mysqld.cnf /data/blog-solo/mysql-config/mysqld.cnf ä¿®æ”¹åæ–‡ä»¶å¦‚ä¸‹ï¼Œä¸»è¦å…³æ³¨sql_mode\nroot@mysql-75797cf796-84rdl:/# cd /etc/mysql/mysql.conf.d/ root@mysql-75797cf796-84rdl:/etc/mysql/mysql.conf.d# ls -l total 4 -rw-r--r-- 1 root root 1671 Oct 26 11:40 mysqld.cnf root@mysql-75797cf796-84rdl:/etc/mysql/mysql.conf.d# cat mysqld.cnf # Copyright (c) 2014, 2016, Oracle and/or its affiliates. All rights reserved. # ... [mysqld] pid-file\t= /var/run/mysqld/mysqld.pid socket\t= /var/run/mysqld/mysqld.sock datadir\t= /var/lib/mysql sql_mode = STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION #log-error\t= /var/log/mysql/error.log # By default we only accept connections from localhost #bind-address\t= 127.0.0.1 # Disabling symbolic-links is recommended to prevent assorted security risks symbolic-links=0 root@mysql-75797cf796-84rdl:/etc/mysql/mysql.conf.d# æœ€åä¿®æ”¹mysql-deploymentï¼š\napiVersion: extensions/v1beta1 kind: Deployment metadata: name: mysql spec: replicas: 1 template: metadata: labels: name: mysql spec: containers: - name: mysql image: mysql:5.7.28 imagePullPolicy: IfNotPresent ports: - containerPort: 3306 env: - name: MYSQL_ROOT_PASSWORD value: \u0026#34;password\u0026#34; volumeMounts: - name: mysql-config mountPath: /etc/mysql/mysql.conf.d - name: mysql-data mountPath: /var/lib/mysql volumes: - name: mysql-config hostPath: path: /data/blog-solo/mysql-config/ - name: mysql-data hostPath: path: /data/blog-solo/mysql-data/ æ³¨æ„è¦æŠŠé…ç½®æ–‡ä»¶å’Œæ•°æ®éƒ½æŒ‚è½½åˆ°å®¿ä¸»æœºä¸Šï¼Œå¦åˆ™podé‡å¯åå°±ä¼šä¸¢å¤±é…ç½®å’Œæ•°æ®ã€‚\n4ã€å‚è€ƒ # docker ä¸‹ä¿®æ”¹ mysql sql_modeå’Œé…ç½®æ–‡ä»¶\nè®°ä¸€æ¬¡Group by æŸ¥è¯¢æ—¶çš„ONLY_FULL_GROUP_BYé”™è¯¯ä»¥åŠåç»­\n","date":"2019å¹´11æœˆ3æ—¥","externalUrl":null,"permalink":"/posts/%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2%E6%97%B6%E8%A2%ABmysql%E7%9A%84sqlmode%E4%B8%ADonlyfullgroupby%E5%9D%91%E5%80%92%E4%BA%86/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003e1ã€èƒŒæ™¯ \n    \u003cdiv id=\"1èƒŒæ™¯\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#1%e8%83%8c%e6%99%af\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eå‰ä¸¤å¤©åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šæ­å»ºäº†è‡ªå·±çš„åšå®¢ï¼Œä¸€åˆ‡éƒ½å¾ˆé¡ºåˆ©ï¼Œä»Šå¤©åœ¨ç‚¹å‡»å½’æ¡£æŒ‰é’®æ—¶ï¼Œå‘ç°æ˜¯æŠ¥404ã€‚äºæ˜¯æˆ‘æŠŠsoloä»£ç åœ¨æœ¬åœ°è¿è¡Œèµ·æ¥ï¼Œç”¨æœ¬åœ°çš„mysqlæ•°æ®åº“ï¼Œçœ‹æ˜¯å¦æœ‰åŒæ ·çš„é—®é¢˜ï¼Œç»“æœæ˜¯å¯ä»¥æ­£å¸¸è®¿é—®çš„ã€‚é‚£å°±çœ‹çœ‹æœåŠ¡å™¨ä¸Šçš„soloæ—¥å¿—å‘—ï¼Œç»“æœå‘ç°äº†ä»¥ä¸‹æŠ¥é”™ï¼š\u003c/p\u003e","title":"æ­å»ºåšå®¢æ—¶ï¼Œè¢«mysqlçš„sql_modeä¸­ONLY_FULL_GROUP_BYå‘å€’äº†","type":"posts"},{"content":" kubernetesåƒåœ¾å›æ”¶å™¨GarbageCollector æºç åˆ†æ # kubernetesç‰ˆæœ¬ï¼š1.13.2\nèƒŒæ™¯ # ç”±äºoperatoråˆ›å»ºçš„redisé›†ç¾¤ï¼Œåœ¨kubernetes apiserveré‡å¯åï¼Œredisé›†ç¾¤è¢«å¼‚å¸¸åˆ é™¤ï¼ˆåŒ…æ‹¬redis exporter statefulsetã€redis statefulsetï¼‰ã€‚åˆ é™¤åoperatorå°†å…¶é‡å»ºï¼Œé‡æ–°ç»„å»ºé›†ç¾¤ï¼Œå®ä¾‹IPå‘ç”Ÿå˜æ›´ï¼ˆä¸­é—´ä»¶å®¹å™¨åŒ–ï¼Œæˆ‘ä»¬å¼€å‘äº†å›ºå®šIPï¼Œå½“statefulsetåˆ é™¤åï¼ŒIPä¼šè¢«å›æ”¶ï¼‰ï¼Œå¯¼è‡´åˆ›å»ºé›†ç¾¤å¤±è´¥ï¼Œæœ€ç»ˆé›†ç¾¤ä¸å¯ç”¨ã€‚\nç»å¤šæ¬¡å¤ç°ï¼Œapiserveré‡å¯åï¼Œé€šè¿‡æŸ¥è¯¢redis operatoræ—¥å¿—ï¼Œå¹¶æ²¡æœ‰å‘ç°ä¸»åŠ¨å»åˆ é™¤redisé›†ç¾¤ï¼ˆredis statefulsetï¼‰ã€ç›‘æ§å®ä¾‹ï¼ˆredis exporterï¼‰ã€‚è¿›ä¸€æ­¥å»æŸ¥çœ‹kube-controller-managerçš„æ—¥å¿—ï¼Œå°†å…¶æ—¥å¿—çº§åˆ«è®¾ç½®\u0026ndash;v=5ï¼Œç»§ç»­å¤ç°ï¼Œæœ€ç»ˆåœ¨kube-controller-manageræ—¥å¿—ä¸­å‘ç°å¦‚ä¸‹æ—¥å¿—ï¼š\nå¯ä»¥çœ‹åˆ°æ˜¯garbage collectorè§¦å‘åˆ é™¤æ“ä½œçš„ã€‚è¿™ä¸ªé—®é¢˜åœ¨apiserveræ­£å¸¸çš„æ—¶å€™æ˜¯ä¸å­˜åœ¨ï¼Œè¦æƒ³å¼„å…¶ç©¶ç«Ÿï¼Œå°±å¾—çœ‹çœ‹kube-controller-managerå†…ç½®ç»„ä»¶garbage collectorè¿™ä¸ªæ§åˆ¶å™¨çš„é€»è¾‘ã€‚\næ­£æ–‡ # gcæ•´ä½“æ¶æ„ # GarbageCollector Controlleræºç ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š\nmonitorsä½œä¸ºç”Ÿäº§è€…å°†å˜åŒ–çš„èµ„æºæ”¾å…¥graphChangesé˜Ÿåˆ—ï¼›åŒæ—¶restMapperå®šæœŸæ£€æµ‹é›†ç¾¤å†…èµ„æºç±»å‹ï¼Œåˆ·æ–°monitors runProcessGraphChangesä»graphChangesé˜Ÿåˆ—ä¸­å–å‡ºå˜åŒ–çš„itemï¼Œæ ¹æ®æƒ…å†µæ”¾å…¥attemptToDeleteé˜Ÿåˆ—ï¼› runProcessGraphChangesä»graphChangesé˜Ÿåˆ—ä¸­å–å‡ºå˜åŒ–çš„itemï¼Œæ ¹æ®æƒ…å†µæ”¾å…¥attemptToOrphané˜Ÿåˆ—ï¼› runAttemptToDeleteWorkerä»attemptToDeleteé˜Ÿåˆ—å–å‡ºï¼Œå°è¯•åˆ é™¤åƒåœ¾èµ„æºï¼› runAttemptToOrphanWorkerä»attemptToOrphané˜Ÿåˆ—å–å‡ºï¼Œå¤„ç†è¯¥å­¤ç«‹çš„èµ„æºï¼› æƒ³è¦å¯ç”¨GCï¼Œéœ€è¦åœ¨kube-apiserverå’Œkube-controller-managerçš„å¯åŠ¨å‚æ•°ä¸­éƒ½è®¾ç½®--enable-garbage-collectorä¸ºtrue,1.13.2ç‰ˆæœ¬ä¸­é»˜è®¤å¼€å¯GCã€‚\néœ€è¦æ³¨æ„ï¼šä¸¤ç»„ä»¶è¯¥å‚æ•°å¿…é¡»ä¿æŒåŒæ­¥ã€‚\ngcå¯åŠ¨ # kube-controller-managerå¯åŠ¨å…¥å£ï¼Œapp.NewControllerManagerCommand()ä¸­åŠ è½½controller manageré»˜è®¤å¯åŠ¨å‚æ•°ï¼Œåˆ›å»º* cobra.Commandå¯¹è±¡ï¼š\nfunc main() { rand.Seed(time.Now().UnixNano()) //åŠ è½½controller manageré»˜è®¤å¯åŠ¨å‚æ•°ï¼Œåˆ›å»º* cobra.Commandå¯¹è±¡ command := app.NewControllerManagerCommand() //......çœç•¥....... //æ‰§è¡Œcobra.commandï¼Œå¹¶å¯åŠ¨controller-manager if err := command.Execute(); err != nil { fmt.Fprintf(os.Stderr, \u0026#34;%v\\n\u0026#34;, err) os.Exit(1) } } ä»¥ä¸‹ä»£ç å¤„å»å¯åŠ¨kube-controller-managerï¼š\nNewDefaultComponentConfig(ports.InsecureKubeControllerManagerPort)åŠ è½½å„ä¸ªæ§åˆ¶å™¨çš„é…ç½®ï¼š\n//NewKubeControllerManagerOptionsä½¿ç”¨é»˜è®¤é…ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„KubeControllerManagerOptions func NewKubeControllerManagerOptions() (*KubeControllerManagerOptions, error) { //åŠ è½½å„ä¸ªæ§åˆ¶å™¨çš„é»˜è®¤é…ç½® componentConfig, err := NewDefaultComponentConfig(ports.InsecureKubeControllerManagerPort) if err != nil { return nil, err } s := KubeControllerManagerOptions{ Generic: cmoptions.NewGenericControllerManagerConfigurationOptions(componentConfig.Generic), //.....çœç•¥ GarbageCollectorController: \u0026amp;GarbageCollectorControllerOptions{ ConcurrentGCSyncs: componentConfig.GarbageCollectorController.ConcurrentGCSyncs, EnableGarbageCollector: componentConfig.GarbageCollectorController.EnableGarbageCollector, }, //.....çœç•¥ } //gcå¿½ç•¥çš„èµ„æºå¯¹è±¡åˆ—è¡¨ gcIgnoredResources := make([]kubectrlmgrconfig.GroupResource, 0, len(garbagecollector.DefaultIgnoredResources())) for r := range garbagecollector.DefaultIgnoredResources() { gcIgnoredResources = append(gcIgnoredResources, kubectrlmgrconfig.GroupResource{Group: r.Group, Resource: r.Resource}) } s.GarbageCollectorController.GCIgnoredResources = gcIgnoredResources return \u0026amp;s, nil } // NewDefaultComponentConfigè¿”å›kube-controllerç®¡ç†å™¨é…ç½®å¯¹è±¡ func NewDefaultComponentConfig(insecurePort int32) (kubectrlmgrconfig.KubeControllerManagerConfiguration, error) { scheme := runtime.NewScheme() if err := kubectrlmgrschemev1alpha1.AddToScheme(scheme); err != nil { return kubectrlmgrconfig.KubeControllerManagerConfiguration{}, err } if err := kubectrlmgrconfig.AddToScheme(scheme); err != nil { return kubectrlmgrconfig.KubeControllerManagerConfiguration{}, err } versioned := kubectrlmgrconfigv1alpha1.KubeControllerManagerConfiguration{} //åŠ è½½é»˜è®¤å‚æ•° scheme.Default(\u0026amp;versioned) internal := kubectrlmgrconfig.KubeControllerManagerConfiguration{} if err := scheme.Convert(\u0026amp;versioned, \u0026amp;internal, nil); err != nil { return internal, err } internal.Generic.Port = insecurePort return internal, nil } // æ ¹æ®Objectï¼Œè·å–æä¾›çš„é»˜è®¤å‚æ•° func (s *Scheme) Default(src Object) { if fn, ok := s.defaulterFuncs[reflect.TypeOf(src)]; ok { fn(src) } } s.defaulterFuncsç±»å‹ä¸ºmap[reflect.Type]func(interface{})ï¼Œç”¨äºæ ¹æ®æŒ‡é’ˆç±»å‹è·å–é»˜è®¤å€¼å‡½æ•°ã€‚è¯¥mapä¸­çš„æ•°æ®ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ\nä»£ç ä½äºsrc\\k8s.io\\kubernetes\\pkg\\controller\\apis\\config\\v1alpha1\\zz_generated.defaults.go\nå¯ä»¥çœ‹åˆ°é»˜è®¤å‚æ•°ä¸­garbage collectorä¸­é»˜è®¤å¼€å¯gcï¼ˆEnableGarbageCollectorï¼‰ï¼Œå¹¶å‘æ•°ä¸º20ï¼ˆConcurrentGCSyncsï¼‰\nfunc SetDefaults_GarbageCollectorControllerConfiguration(obj *kubectrlmgrconfigv1alpha1.GarbageCollectorControllerConfiguration) { if obj.EnableGarbageCollector == nil { obj.EnableGarbageCollector = utilpointer.BoolPtr(true) } if obj.ConcurrentGCSyncs == 0 { obj.ConcurrentGCSyncs = 20 } } å›åˆ°Runå‡½æ•°ï¼Œé‡Œé¢è°ƒç”¨äº†NewControllerInitializerså¯åŠ¨æ‰€æœ‰æ§åˆ¶å™¨ï¼š\né‡ç‚¹æ¥åˆ°å¯åŠ¨garbage collectorçš„startGarbageCollectorControllerå‡½æ•°ï¼š\nfunc startGarbageCollectorController(ctx ControllerContext) (http.Handler, bool, error) { //k8s 1.13.2ä¸­é»˜è®¤ä¸ºtrue,å¯åœ¨kube-apiserverå’Œkube-controller-managerçš„å¯åŠ¨å‚æ•°ä¸­åŠ --enable-garbage-conllector=falseè®¾ç½® //éœ€ä¿è¯è¿™ä¸¤ä¸ªç»„ä»¶ä¸­å‚æ•°å€¼ä¸€è‡´ if !ctx.ComponentConfig.GarbageCollectorController.EnableGarbageCollector { return nil, false, nil } //k8så„ç§åŸç”Ÿèµ„æºå¯¹è±¡å®¢æˆ·ç«¯é›†åˆ(é»˜è®¤å¯åŠ¨å‚æ•°ä¸­ç”¨SimpleControllerClientBuilderæ„å»º) gcClientset := ctx.ClientBuilder.ClientOrDie(\u0026#34;generic-garbage-collector\u0026#34;) discoveryClient := cacheddiscovery.NewMemCacheClient(gcClientset.Discovery()) //ç”Ÿæˆrest config config := ctx.ClientBuilder.ConfigOrDie(\u0026#34;generic-garbage-collector\u0026#34;) dynamicClient, err := dynamic.NewForConfig(config) if err != nil { return nil, true, err } // Get an initial set of deletable resources to prime the garbage collector. //è·å–ä¸€ç»„åˆå§‹å¯åˆ é™¤èµ„æºä»¥å¡«å……åƒåœ¾æ”¶é›†å™¨ã€‚ deletableResources := garbagecollector.GetDeletableResources(discoveryClient) ignoredResources := make(map[schema.GroupResource]struct{}) //å¿½ç•¥gcçš„èµ„æºç±»å‹ for _, r := range ctx.ComponentConfig.GarbageCollectorController.GCIgnoredResources { ignoredResources[schema.GroupResource{Group: r.Group, Resource: r.Resource}] = struct{}{} } garbageCollector, err := garbagecollector.NewGarbageCollector( dynamicClient, ctx.RESTMapper, deletableResources, ignoredResources, ctx.InformerFactory, ctx.InformersStarted, ) if err != nil { return nil, true, fmt.Errorf(\u0026#34;Failed to start the generic garbage collector: %v\u0026#34;, err) } // Start the garbage collector. //å¯åŠ¨å‚æ•°ä¸­é»˜è®¤æ˜¯20ä¸ªåç¨‹ workers := int(ctx.ComponentConfig.GarbageCollectorController.ConcurrentGCSyncs) //å¯åŠ¨monitorså’ŒdeleteWorkersã€orphanWorkers go garbageCollector.Run(workers, ctx.Stop) // Periodically refresh the RESTMapper with new discovery information and sync // the garbage collector. //ä½¿ç”¨æ–°çš„å‘ç°ä¿¡æ¯å®šæœŸåˆ·æ–°RESTMapperå¹¶åŒæ­¥åƒåœ¾æ”¶é›†å™¨ã€‚ go garbageCollector.Sync(gcClientset.Discovery(), 30*time.Second, ctx.Stop) //gcæä¾›debug dot grapä¾èµ–å…³ç³»å›¾æ¥å£ return garbagecollector.NewDebugHandler(garbageCollector), true, nil } è¯¥å‡½æ•°ä¸»è¦ä½œç”¨æœ‰ï¼š\n1ã€deletableResources := garbagecollector.GetDeletableResources(discoveryClient)è·å–é›†ç¾¤å†…æ‰€æœ‰å¯åˆ é™¤çš„èµ„æºå¯¹è±¡ï¼›æ’é™¤æ‰å¿½ç•¥çš„èµ„æºå¯¹è±¡ã€‚\n2ã€æ„å»ºgarbageCollectorç»“æ„ä½“å¯¹è±¡ï¼›\n3ã€garbageCollector.Run(workers, ctx.Stop)å¯åŠ¨ä¸€ä¸ªmonitorsç”¨æ¥ç›‘å¬èµ„æºå¯¹è±¡çš„å˜åŒ–ï¼ˆå¯¹åº”çš„ç”±runProcessGraphChangesæ­»å¾ªç¯å¤„ç†ï¼‰ï¼Œå’Œé»˜è®¤20ä¸ªdeleteWorkersåç¨‹å¤„ç†å¯åˆ é™¤çš„èµ„æºå¯¹è±¡ã€20ä¸ªorphanWorkersåç¨‹å¤„ç†å­¤å„¿å¯¹è±¡ã€‚\n4ã€garbageCollector.Sync(gcClientset.Discovery(), 30*time.Second, ctx.Stop) å®šæ—¶å»è·å–ä¸€ä¸ªé›†ç¾¤å†…æ˜¯å¦æœ‰æ–°ç±»å‹çš„èµ„æºå¯¹è±¡çš„åŠ å…¥ï¼Œå¹¶é‡æ–°åˆ·æ–°monitorsï¼Œä»¥ç›‘å¬æ–°ç±»å‹çš„èµ„æºå¯¹è±¡ã€‚\n5ã€garbagecollector.NewDebugHandler(garbageCollector)æ³¨å†Œdebugæ¥å£ï¼Œç”¨æ¥æä¾›è·å–dotæµç¨‹å›¾æ¥å£ï¼š\ncurl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph?uid=11211212edsaddkqedmk12 ä½¿ç”¨graphvizæä¾›çš„dot.exeå¯ä»¥ç”Ÿæˆsvgæ ¼å¼çš„å›¾ï¼Œå¯ç”¨googleæµè§ˆå™¨æŸ¥çœ‹å¦‚ä¸‹ï¼š\n// curl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph?uid=11211212edsaddkqedmk12 func (h *debugHTTPHandler) ServeHTTP(w http.ResponseWriter, req *http.Request) { if req.URL.Path != \u0026#34;/graph\u0026#34; { http.Error(w, \u0026#34;\u0026#34;, http.StatusNotFound) return } var graph graph.Directed if uidStrings := req.URL.Query()[\u0026#34;uid\u0026#34;]; len(uidStrings) \u0026gt; 0 { uids := []types.UID{} for _, uidString := range uidStrings { uids = append(uids, types.UID(uidString)) } graph = h.controller.dependencyGraphBuilder.uidToNode.ToGonumGraphForObj(uids...) } else { graph = h.controller.dependencyGraphBuilder.uidToNode.ToGonumGraph() } //ç”Ÿæˆdotæµç¨‹å›¾æ•°æ®,ç”¨graphvizå·¥å…·ä¸­çš„dot.exeå·¥å…·è½¬æ¢ä¸ºsvgå›¾(ç”¨googleæµè§ˆå™¨æ‰“å¼€)æˆ–è€…pngå›¾ //APIå‚è€ƒ:https://godoc.org/gonum.org/v1/gonum/graph //graphvizä¸‹è½½åœ°å€:https://graphviz.gitlab.io/_pages/Download/Download_windows.html //dot.exe test.dot -T svg -o test.svg data, err := dot.Marshal(graph, \u0026#34;full\u0026#34;, \u0026#34;\u0026#34;, \u0026#34; \u0026#34;, false) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } w.Write(data) w.WriteHeader(http.StatusOK) } GarbageCollectoré€šè¿‡restMapperå®šæœŸé‡ç½®å¯åˆ é™¤çš„èµ„æºç±»å‹ï¼Œæ›´æ–°GraphBuilderä¸­çš„monitorsï¼Œmonitorså°†åˆ›å»ºæ‰€æœ‰èµ„æºç±»å‹çš„å˜æ›´é€šçŸ¥å›è°ƒå‡½æ•°ï¼Œå°†å˜åŒ–çš„èµ„æºå¯¹è±¡åŠ å…¥åˆ°GraphBuilderçš„graphChangesé˜Ÿåˆ—ï¼ŒGraphBuilderçš„runProcessGraphChanges()ä¼šä¸€ç›´ä»é˜Ÿåˆ—ä¸­è·å–å˜åŒ–ï¼Œæ„å»ºä¸€ä¸ªç¼“å­˜å¯¹è±¡ä¹‹é—´ä¾èµ–å…³ç³»çš„å›¾å½¢ï¼Œä»¥åŠè§¦å‘dependencyGraphBuilderå°†å¯èƒ½è¢«åƒåœ¾æ”¶é›†çš„å¯¹è±¡æ’é˜Ÿåˆ°attemptToDeleteé˜Ÿåˆ—ï¼Œå¹¶å°†å…¶ä¾èµ–é¡¹éœ€è¦å­¤ç«‹çš„å¯¹è±¡æ’é˜Ÿåˆ°attemptToOrphané˜Ÿåˆ—ã€‚GarbageCollectorå…·æœ‰ä½¿ç”¨è¿™ä¸¤ä¸ªé˜Ÿåˆ—çš„å·¥ä½œäººå‘˜runAttemptToDeleteWorkerå’ŒrunAttemptToOrphanWorkeræ­»å¾ªç¯ï¼Œåˆ†åˆ«ä»attemptToDeleteé˜Ÿåˆ—å’ŒattemptToOrphané˜Ÿåˆ—å–å‡ºï¼Œå‘APIæœåŠ¡å™¨å‘é€è¯·æ±‚ä»¥ç›¸åº”åœ°åˆ é™¤æ›´æ–°å¯¹è±¡ã€‚\n// GarbageCollectorè¿è¡Œåå°„å™¨æ¥ç›‘è§†æ‰˜ç®¡APIå¯¹è±¡çš„æ›´æ”¹ï¼Œå°†ç»“æœæ±‡æ€»åˆ°å•çº¿ç¨‹dependencyGraphBuilderï¼Œ // æ„å»ºä¸€ä¸ªç¼“å­˜å¯¹è±¡ä¹‹é—´ä¾èµ–å…³ç³»çš„å›¾å½¢ã€‚ç”±å›¾å˜åŒ–è§¦å‘ï¼ŒdependencyGraphBuilderå°†å¯èƒ½è¢«åƒåœ¾æ”¶é›†çš„å¯¹è±¡ // æ’é˜Ÿåˆ°`attemptToDelete`é˜Ÿåˆ—ï¼Œå¹¶å°†å…¶ä¾èµ–é¡¹éœ€è¦å­¤ç«‹çš„å¯¹è±¡æ’é˜Ÿåˆ°`attemptToOrphan`é˜Ÿåˆ—ã€‚ // GarbageCollectorå…·æœ‰ä½¿ç”¨è¿™ä¸¤ä¸ªé˜Ÿåˆ—çš„å·¥ä½œäººå‘˜ï¼Œå‘APIæœåŠ¡å™¨å‘é€è¯·æ±‚ä»¥ç›¸åº”åœ°åˆ é™¤æ›´æ–°å¯¹è±¡ã€‚ // è¯·æ³¨æ„ï¼Œè®©dependencyGraphBuilderé€šçŸ¥åƒåœ¾æ”¶é›†å™¨ç¡®ä¿åƒåœ¾æ”¶é›†å™¨ä½¿ç”¨è‡³å°‘ä¸å‘é€é€šçŸ¥ä¸€æ ·æœ€æ–°çš„å›¾å½¢è¿›è¡Œæ“ä½œã€‚ type GarbageCollector struct { // resettableRESTMapperæ˜¯ä¸€ä¸ªRESTMapperï¼Œå®ƒèƒ½å¤Ÿåœ¨discoveryèµ„æºç±»å‹æ—¶é‡ç½®è‡ªå·± restMapper resettableRESTMapper // dynamicClientæä¾›æ“ä½œé›†ç¾¤å†…æ‰€æœ‰èµ„æºå¯¹è±¡çš„æ¥å£æ–¹æ³•,åŒ…æ‹¬k8så†…ç½®ã€CRDç”Ÿæˆçš„è‡ªå®šä¹‰èµ„æº dynamicClient dynamic.Interface //åƒåœ¾æ”¶é›†å™¨å°è¯•åœ¨æ—¶é—´æˆç†Ÿæ—¶åˆ é™¤attemptToDeleteé˜Ÿåˆ—ä¸­çš„item attemptToDelete workqueue.RateLimitingInterface //åƒåœ¾æ”¶é›†å™¨å°è¯•å­¤ç«‹attemptToOrphané˜Ÿåˆ—ä¸­itemçš„ä¾èµ–é¡¹ï¼Œç„¶ååˆ é™¤item attemptToOrphan workqueue.RateLimitingInterface dependencyGraphBuilder *GraphBuilder // æœ‰ownerçš„èµ„æºå¯¹è±¡,æ‰ä¼šç»™absentOwnerCacheå¡«å……ä¸å­˜åœ¨çš„Ownerä¿¡æ¯ absentOwnerCache *UIDCache sharedInformers informers.SharedInformerFactory workerLock sync.RWMutex } // GraphBuilderï¼šåŸºäºinformersæä¾›çš„äº‹ä»¶ï¼ŒGraphBuilderæ›´æ–° // uidToNodeï¼Œä¸€ä¸ªç¼“å­˜æˆ‘ä»¬æ‰€çŸ¥çš„ä¾èµ–å…³ç³»çš„å›¾ï¼Œå¹¶å°† // é¡¹æ”¾å…¥attemptToDeleteå’ŒattemptToOrphané˜Ÿåˆ— type GraphBuilder struct { restMapper meta.RESTMapper //æ¯ä¸ªç›‘è§†å™¨åˆ—è¡¨/ç›‘è§†èµ„æºï¼Œç»“æœæ±‡é›†åˆ°dependencyGraphBuilder monitors monitors monitorLock sync.RWMutex // informersStarted is closed after after all of the controllers have been initialized and are running. // After that it is safe to start them here, before that it is not. // informersStartedåœ¨æ‰€æœ‰æ§åˆ¶å™¨åˆå§‹åŒ–å¹¶è¿è¡Œåå…³é—­ã€‚ä¹‹ååœ¨è¿™é‡Œå¯åŠ¨å®ƒä»¬æ˜¯å®‰å…¨çš„ï¼Œåœ¨æ­¤ä¹‹å‰å®ƒä¸æ˜¯ã€‚ informersStarted \u0026lt;-chan struct{} // stopCh drives shutdown. When a receive from it unblocks, monitors will shut down. // This channel is also protected by monitorLock. // stopChé©±åŠ¨å™¨å…³é—­å½“æ¥è‡ªå®ƒçš„æ¥æ”¶è§£é™¤é˜»å¡æ—¶ï¼Œç›‘è§†å™¨å°†å…³é—­ã€‚ æ­¤channelä¹Ÿå—monitorLockä¿æŠ¤ã€‚ stopCh \u0026lt;-chan struct{} // running tracks whether Run() has been called. // it is protected by monitorLock. //è¿è¡Œè½¨é“æ˜¯å¦å·²è°ƒç”¨Run()å®ƒå—monitorLockä¿æŠ¤ã€‚ running bool dynamicClient dynamic.Interface // monitors are the producer of the graphChanges queue, graphBuilder alters // the in-memory graph according to the changes. // monitoræ˜¯graphChangesé˜Ÿåˆ—çš„ç”Ÿæˆè€…ï¼ŒgraphBuilderæ ¹æ®æ›´æ”¹æ”¹å˜äº†å†…å­˜ä¸­çš„å›¾å½¢ã€‚ graphChanges workqueue.RateLimitingInterface // uidToNode doesn\u0026#39;t require a lock to protect, because only the // single-threaded GraphBuilder.processGraphChanges() reads/writes it. //uidToNodeä¸éœ€è¦é”ä¿æŠ¤ï¼Œå› ä¸ºåªæœ‰å•çº¿ç¨‹GraphBuilder.processGraphChanges()è¯»å†™å®ƒã€‚ uidToNode *concurrentUIDToNode // GraphBuilder is the producer of attemptToDelete and attemptToOrphan, GC is the consumer. // GraphBuilderæ˜¯attemptToDeleteå’ŒattemptToOrphançš„ç”Ÿäº§è€…ï¼ŒGCæ˜¯æ¶ˆè´¹è€…ã€‚ attemptToDelete workqueue.RateLimitingInterface attemptToOrphan workqueue.RateLimitingInterface // GraphBuilder and GC share the absentOwnerCache. Objects that are known to // be non-existent are added to the cached. // GraphBuilderå’ŒGCå…±äº«absentOwnerCacheã€‚å·²çŸ¥ä¸å­˜åœ¨çš„å¯¹è±¡å°†æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚ absentOwnerCache *UIDCache //æ‰€æœ‰k8sèµ„æºå¯¹è±¡é›†çš„informer sharedInformers informers.SharedInformerFactory //ç›‘è§†å™¨å¿½ç•¥çš„èµ„æºå¯¹è±¡é›† ignoredResources map[schema.GroupResource]struct{} } åˆ›å»ºNewGarbageCollectorç»“æ„ä½“ï¼š\nfunc NewGarbageCollector( dynamicClient dynamic.Interface, mapper resettableRESTMapper, deletableResources map[schema.GroupVersionResource]struct{}, ignoredResources map[schema.GroupResource]struct{}, sharedInformers informers.SharedInformerFactory, informersStarted \u0026lt;-chan struct{}, ) (*GarbageCollector, error) { attemptToDelete := workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \u0026#34;garbage_collector_attempt_to_delete\u0026#34;) attemptToOrphan := workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \u0026#34;garbage_collector_attempt_to_orphan\u0026#34;) absentOwnerCache := NewUIDCache(500) gc := \u0026amp;GarbageCollector{ dynamicClient: dynamicClient, restMapper: mapper, attemptToDelete: attemptToDelete, attemptToOrphan: attemptToOrphan, absentOwnerCache: absentOwnerCache, } gb := \u0026amp;GraphBuilder{ dynamicClient: dynamicClient, informersStarted: informersStarted, restMapper: mapper, graphChanges: workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \u0026#34;garbage_collector_graph_changes\u0026#34;), uidToNode: \u0026amp;concurrentUIDToNode{ uidToNode: make(map[types.UID]*node), }, attemptToDelete: attemptToDelete, attemptToOrphan: attemptToOrphan, absentOwnerCache: absentOwnerCache, sharedInformers: sharedInformers, ignoredResources: ignoredResources, } //åˆå§‹åŒ–å„ä¸ªèµ„æºå¯¹è±¡çš„monitorsï¼Œå¯åŠ¨å„èµ„æºå¯¹è±¡çš„ç›‘å¬å™¨ï¼Œå˜åŒ–æ—¶è§¦å‘å›è°ƒï¼Œå°†å…¶åŠ å…¥graphChanges é˜Ÿåˆ— if err := gb.syncMonitors(deletableResources); err != nil { utilruntime.HandleError(fmt.Errorf(\u0026#34;failed to sync all monitors: %v\u0026#34;, err)) } gc.dependencyGraphBuilder = gb return gc, nil } ä¸»è¦åŠŸèƒ½ï¼š\n1ã€æ„å»ºGarbageCollectorç»“æ„ä½“ï¼›\n2ã€æ„å»ºä¾èµ–ç»“æ„å›¾ç»´æŠ¤ç»“æ„ä½“GraphBuilderï¼Œå’ŒGarbageCollectorå…±ç”¨attemptToDeleteå’ŒattemptToOrphané˜Ÿåˆ—ï¼ŒGraphBuilderä½œä¸ºç”Ÿäº§ç€å°†é€‚å½“èµ„æºæ”¾åˆ°attemptToDeleteæˆ–è€…attemptToOrphané˜Ÿåˆ—ï¼Œä¾›GarbageCollectorä¸­çš„workerè¿›è¡Œæ¶ˆè´¹ï¼›\n3ã€åˆå§‹åŒ–å„ä¸ªèµ„æºå¯¹è±¡çš„monitorsï¼Œå¯åŠ¨å„èµ„æºå¯¹è±¡çš„ç›‘å¬å™¨ï¼Œå˜åŒ–æ—¶è§¦å‘å›è°ƒï¼Œå°†å…¶åŠ å…¥graphChanges é˜Ÿåˆ—ã€‚\ngb.syncMonitors(deletableResources)æ–¹æ³•ä¸­æœ€ä¸»è¦çš„æ˜¯c, s, err := gb.controllerFor(resource, kind)\nfunc (gb *GraphBuilder) controllerFor(resource schema.GroupVersionResource, kind schema.GroupVersionKind) (cache.Controller, cache.Store, error) { handlers := cache.ResourceEventHandlerFuncs{ // add the event to the dependencyGraphBuilder\u0026#39;s graphChanges. // å°†äº‹ä»¶æ·»åŠ åˆ°dependencyGraphBuilderçš„graphChangesä¸­ã€‚ AddFunc: func(obj interface{}) { event := \u0026amp;event{ eventType: addEvent, obj: obj, gvk: kind, } gb.graphChanges.Add(event) }, UpdateFunc: func(oldObj, newObj interface{}) { // TODO: check if there are differences in the ownerRefs, // finalizers, and DeletionTimestamp; if not, ignore the update. //TODOï¼šæ£€æŸ¥ownerRefsï¼Œ finalizerså’ŒDeletionTimestampæ˜¯å¦å­˜åœ¨å·®å¼‚;å¦‚æœæ²¡æœ‰ï¼Œè¯·å¿½ç•¥æ›´æ–°ã€‚ event := \u0026amp;event{ eventType: updateEvent, obj: newObj, oldObj: oldObj, gvk: kind, } gb.graphChanges.Add(event) }, DeleteFunc: func(obj interface{}) { // delta fifo may wrap the object in a cache.DeletedFinalStateUnknown, unwrap it // delta fifoå¯ä»¥å°†å¯¹è±¡åŒ…è£…åœ¨cache.DeletedFinalStateUnknownä¸­ï¼Œè§£åŒ…å®ƒ if deletedFinalStateUnknown, ok := obj.(cache.DeletedFinalStateUnknown); ok { obj = deletedFinalStateUnknown.Obj } event := \u0026amp;event{ eventType: deleteEvent, obj: obj, gvk: kind, } gb.graphChanges.Add(event) }, } shared, err := gb.sharedInformers.ForResource(resource) if err == nil { klog.V(4).Infof(\u0026#34;using a shared informer for resource %q, kind %q\u0026#34;, resource.String(), kind.String()) // need to clone because it\u0026#39;s from a shared cache shared.Informer().AddEventHandlerWithResyncPeriod(handlers, ResourceResyncTime) return shared.Informer().GetController(), shared.Informer().GetStore(), nil } else { //è·å–èµ„æºå¯¹è±¡æ—¶å‡ºé”™ä¼šåˆ°è¿™é‡Œ,æ¯”å¦‚ék8så†…ç½®RedisClusterã€clusterbasesã€clustersã€esclustersã€volumeprovidersã€stsmastersã€appappsã€mysqlclustersã€brokerclustersã€clustertemplates; //å†…ç½®çš„networkPoliciesã€apiservicesã€customresourcedefinitions klog.V(4).Infof(\u0026#34;unable to use a shared informer for resource %q, kind %q: %v\u0026#34;, resource.String(), kind.String(), err) } // TODO: consider store in one storage. // TODO: è€ƒè™‘å­˜å‚¨åœ¨ä¸€ä¸ªå­˜å‚¨ä¸­ã€‚ klog.V(5).Infof(\u0026#34;create storage for resource %s\u0026#34;, resource) //ä¸Šé¢å¤±è´¥çš„èµ„æºå¯¹è±¡çš„storeå’Œcontroller store, monitor := cache.NewInformer( listWatcher(gb.dynamicClient, resource), nil, ResourceResyncTime, // don\u0026#39;t need to clone because it\u0026#39;s not from shared cache //ä¸éœ€è¦å…‹éš†ï¼Œå› ä¸ºå®ƒä¸æ˜¯æ¥è‡ªå…±äº«ç¼“å­˜ handlers, ) return monitor, store, nil } è¯¥æ–¹æ³•ä¸»è¦åŠŸèƒ½æ˜¯ï¼š\n1ã€å°†æ–°å¢ã€æ›´æ”¹ã€åˆ é™¤çš„èµ„æºå¯¹è±¡æ„å»ºä¸ºeventç»“æ„ä½“ï¼Œæ”¾å…¥GraphBuilderçš„graphChangesé˜Ÿåˆ—é‡Œï¼Œæœ€ç»ˆè¢«runProcessGraphChangesè¿™ä¸ªworkeræ¶ˆè´¹ï¼›\n2ã€æ„å»ºå¤§å¤šæ•°å†…ç½®èµ„æºçš„SharedInformerFactoryï¼Œæ„å»ºå¤±è´¥çš„ç”¨cache.NewInformeræ„å»ºï¼ˆé€šè¿‡CRDå®šä¹‰çš„å¯¹è±¡ä»¥åŠéƒ¨åˆ†k8så†…ç½®å¯¹è±¡ï¼‰\nä»£ç ç»§ç»­å›åˆ°k8s.io\\kubernetes\\cmd\\kube-controller-manager\\app\\core.goä¸­çš„startGarbageCollectorControllerä¸­ï¼Œçœ‹ garbageCollector.Run(workers, ctx.Stop)æ–¹æ³•ï¼š\nfunc (gc *GarbageCollector) Run(workers int, stopCh \u0026lt;-chan struct{}) { defer utilruntime.HandleCrash() defer gc.attemptToDelete.ShutDown() defer gc.attemptToOrphan.ShutDown() defer gc.dependencyGraphBuilder.graphChanges.ShutDown() klog.Infof(\u0026#34;Starting garbage collector controller\u0026#34;) defer klog.Infof(\u0026#34;Shutting down garbage collector controller\u0026#34;) //åç¨‹è¿è¡Œç”Ÿäº§è€…monitors go gc.dependencyGraphBuilder.Run(stopCh) //ç­‰å¾…dependencyGraphBuilderç¼“å­˜å¼€å§‹åŒæ­¥ if !controller.WaitForCacheSync(\u0026#34;garbage collector\u0026#34;, stopCh, gc.dependencyGraphBuilder.IsSynced) { return } //åƒåœ¾æ”¶é›†å™¨ï¼šæ‰€æœ‰èµ„æºç›‘è§†å™¨éƒ½å·²åŒæ­¥ã€‚ç»§ç»­æ”¶é›†åƒåœ¾ klog.Infof(\u0026#34;Garbage collector: all resource monitors have synced. Proceeding to collect garbage\u0026#34;) // gc workers //åç¨‹è¿è¡Œæ¶ˆè´¹è€…DeleteWorkerså’ŒOrphanWorkers for i := 0; i \u0026lt; workers; i++ { //é»˜è®¤å‚æ•°ä¸º20ä¸ªå¹¶å‘åç¨‹å°è¯•delete worker go wait.Until(gc.runAttemptToDeleteWorker, 1*time.Second, stopCh) //é»˜è®¤å‚æ•°ä¸º20ä¸ªå¹¶å‘åç¨‹å°è¯•orphan worker go wait.Until(gc.runAttemptToOrphanWorker, 1*time.Second, stopCh) } \u0026lt;-stopCh } gc.dependencyGraphBuilder.Run(stopCh)ä¸»è¦åŠŸèƒ½ï¼š\n1ã€gb.startMonitors()å¯åŠ¨ç›‘å¬èµ„æºå˜åŒ–çš„informerï¼›\n2ã€wait.Until(gb.runProcessGraphChanges, 1*time.Second, stopCh)å¼€å¯ä»é˜Ÿåˆ—GraphBuilder.graphChangesä¸­æ¶ˆè´¹çš„worker\nå¯åŠ¨20ä¸ªrunAttemptToDeleteWorkerå’Œ20ä¸ªrunAttemptToOrphanWorker\nrunProcessGraphChangeså¤„ç†ä¸»æµç¨‹ # æ¥åˆ°æºç k8s.io\\kubernetes\\pkg\\controller\\garbagecollector\\graph_builder.goä¸­ï¼ŒrunProcessGraphChangesä¸­ä¸€ç›´æ­»å¾ªç¯å¤„ç†å˜åŒ–çš„èµ„æºå¯¹è±¡ï¼š\nfunc (gb *GraphBuilder) runProcessGraphChanges() { for gb.processGraphChanges() { } } ä¸€ä¸ªåç¨‹ä¸€ç›´å¾ªç¯ä»graphChangesé˜Ÿåˆ—ä¸­è·å–å˜åŒ–çš„èµ„æºå¯¹è±¡ï¼Œæ›´æ–°å›¾å½¢ï¼Œå¡«å……dirty_queueã€‚(graphChangesé˜Ÿåˆ—é‡Œæ•°æ®æ¥æºäºå„ä¸ªèµ„æºçš„monitorsç›‘å¬èµ„æºå˜åŒ–å›è°ƒaddFuncã€updateFuncã€deleteFunc)\n// Dequeueing an event from graphChanges, updating graph, populating dirty_queue. //ä»graphChangesä¸­è·å–äº‹ä»¶ï¼Œæ›´æ–°å›¾å½¢ï¼Œå¡«å……dirty_queueã€‚(graphChangesé˜Ÿåˆ—é‡Œæ•°æ®æ¥æºäºå„ä¸ªèµ„æºçš„monitorsç›‘å¬èµ„æºå˜åŒ–å›è°ƒaddFuncã€updateFuncã€deleteFunc) func (gb *GraphBuilder) processGraphChanges() bool { item, quit := gb.graphChanges.Get() if quit { return false } defer gb.graphChanges.Done(item) event, ok := item.(*event) if !ok { utilruntime.HandleError(fmt.Errorf(\u0026#34;expect a *event, got %v\u0026#34;, item)) return true } obj := event.obj //è·å–è¯¥å˜åŒ–èµ„æºobjçš„accessor accessor, err := meta.Accessor(obj) if err != nil { utilruntime.HandleError(fmt.Errorf(\u0026#34;cannot access obj: %v\u0026#34;, err)) return true } klog.V(5).Infof(\u0026#34;GraphBuilder process object: %s/%s, namespace %s, name %s, uid %s, event type %v\u0026#34;, event.gvk.GroupVersion().String(), event.gvk.Kind, accessor.GetNamespace(), accessor.GetName(), string(accessor.GetUID()), event.eventType) // Check if the node already exists // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨ //æ ¹æ®è¯¥å˜åŒ–èµ„æºobjçš„UID //uidToNodeç»´æŠ¤ç€èµ„æºå¯¹è±¡ä¾èµ–å…³ç³»å›¾è¡¨ç»“æ„ existingNode, found := gb.uidToNode.Read(accessor.GetUID()) if found { // this marks the node as having been observed via an informer event // 1. this depends on graphChanges only containing add/update events from the actual informer // 2. this allows things tracking virtual nodes\u0026#39; existence to stop polling and rely on informer events //è¿™æ ‡å¿—ç€èŠ‚ç‚¹å·²ç»é€šè¿‡informeräº‹ä»¶ // 1.è¿›è¡Œäº†è§‚å¯Ÿã€‚è¿™å–å†³äºä»…åŒ…å«æ¥è‡ªå®é™…informerçš„æ·»åŠ /æ›´æ–°äº‹ä»¶çš„graphChange // 2.è¿™å…è®¸è·Ÿè¸ªè™šæ‹ŸèŠ‚ç‚¹çš„å­˜åœ¨ä»¥åœæ­¢è½®è¯¢å’Œä¾èµ–informeräº‹ä»¶ existingNode.markObserved() } switch { //gcç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼ŒuidToNodeå°šä¸”æ²¡æœ‰åˆå§‹åŒ–èµ„æºå¯¹è±¡ä¾èµ–å…³ç³»å›¾è¡¨ç»“æ„ï¼Œæ‰€ä»¥foundä¸ºfalseï¼Œä¼šæ–°å¢èŠ‚ç‚¹ case (event.eventType == addEvent || event.eventType == updateEvent) \u0026amp;\u0026amp; !found: newNode := \u0026amp;node{ identity: objectReference{ OwnerReference: metav1.OwnerReference{ APIVersion: event.gvk.GroupVersion().String(), Kind: event.gvk.Kind, UID: accessor.GetUID(), Name: accessor.GetName(), }, Namespace: accessor.GetNamespace(), }, dependents: make(map[*node]struct{}), owners: accessor.GetOwnerReferences(), deletingDependents: beingDeleted(accessor) \u0026amp;\u0026amp; hasDeleteDependentsFinalizer(accessor), beingDeleted: beingDeleted(accessor), } gb.insertNode(newNode) // the underlying delta_fifo may combine a creation and a deletion into // one event, so we need to further process the event. //åº•å±‚delta_fifoå¯ä»¥å°†åˆ›å»ºå’Œåˆ é™¤ç»„åˆæˆä¸€ä¸ªäº‹ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥å¤„ç†äº‹ä»¶ã€‚ gb.processTransitions(event.oldObj, accessor, newNode) //uidToNodeå·²ç»åˆå§‹åŒ–èµ„æºå¯¹è±¡ä¾èµ–å…³ç³»å›¾è¡¨ç»“æ„ï¼Œæ‰€ä»¥foundä¸ºtrue case (event.eventType == addEvent || event.eventType == updateEvent) \u0026amp;\u0026amp; found: // handle changes in ownerReferences //å¤„ç†ownerReferencesä¸­çš„æ›´æ”¹ added, removed, changed := referencesDiffs(existingNode.owners, accessor.GetOwnerReferences()) if len(added) != 0 || len(removed) != 0 || len(changed) != 0 { // check if the changed dependency graph unblock owners that are // waiting for the deletion of their dependents. //æ£€æŸ¥æ›´æ”¹çš„ä¾èµ–å…³ç³»å›¾æ˜¯å¦å–æ¶ˆé˜»æ­¢ç­‰å¾…åˆ é™¤å…¶ä¾èµ–é¡¹çš„æ‰€æœ‰è€…ã€‚ gb.addUnblockedOwnersToDeleteQueue(removed, changed) // update the node itself //æ›´æ–°nodeçš„owner existingNode.owners = accessor.GetOwnerReferences() // Add the node to its new owners\u0026#39; dependent lists. //ç»™æ–°owneræ·»åŠ ä¾èµ–èµ„æºåˆ—è¡¨ gb.addDependentToOwners(existingNode, added) // remove the node from the dependent list of node that are no longer in // the node\u0026#39;s owners list. //ä»ä¸å†å±äºè¯¥èµ„æºowneråˆ—è¡¨ä¸­åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚ gb.removeDependentFromOwners(existingNode, removed) } // è¯¥å¯¹è±¡æ­£åœ¨è¢«åˆ é™¤ä¸­ if beingDeleted(accessor) { existingNode.markBeingDeleted() } gb.processTransitions(event.oldObj, accessor, existingNode) //å¤„ç†èµ„æºå¯¹è±¡è¢«åˆ é™¤çš„åœºæ™¯ï¼Œæ¶‰åŠåƒåœ¾ã€‚æ¯”å¦‚ï¼Œownerè¢«åˆ é™¤ï¼Œå…¶ä¾èµ–èµ„æºï¼ˆä»èµ„æºï¼‰ä¹Ÿéœ€è¦è¢«åˆ é™¤æ‰ï¼Œé™¤éè®¾ç½®äº†Orphan case event.eventType == deleteEvent: if !found { klog.V(5).Infof(\u0026#34;%v doesn\u0026#39;t exist in the graph, this shouldn\u0026#39;t happen\u0026#34;, accessor.GetUID()) return true } // ä»å›¾æ ‡ä¸­ç§»é™¤itemèµ„æºï¼ŒåŒæ—¶éå†ownersï¼Œç§»é™¤ownerä¸‹çš„itemèµ„æº gb.removeNode(existingNode) existingNode.dependentsLock.RLock() defer existingNode.dependentsLock.RUnlock() //å¦‚æœè¯¥èµ„æºçš„ä»èµ„æºæ•°å¤§äº0,åˆ™å°†è¯¥èµ„æºè¢«åˆ é™¤ä¿¡æ¯åŠ å…¥absentOwnerCacheç¼“å­˜ if len(existingNode.dependents) \u0026gt; 0 { gb.absentOwnerCache.Add(accessor.GetUID()) } //éå†è¯¥èµ„æºçš„ä»èµ„æºåŠ åˆ°åˆ é™¤é˜Ÿåˆ—é‡Œ for dep := range existingNode.dependents { gb.attemptToDelete.Add(dep) } for _, owner := range existingNode.owners { ownerNode, found := gb.uidToNode.Read(owner.UID) //owneræ²¡å‘ç° æˆ–è€… ownerçš„ä»èµ„æºä¸æ˜¯æ­£åœ¨è¢«åˆ é™¤(åªæœ‰è¯¥èµ„æºå¯¹è±¡çš„ç»ˆç»“å™¨ä¸ºforegroundDeletion Finalizeræ—¶deletingDependentsè¢«è®¾ä¸ºtrue,å› ä¸ºåå°åˆ é™¤ownerç›´æ¥è¢«åˆ é™¤,ä¸ä¼šè¢«å…¶ä»èµ„æºblock,æ•…è¿™é‡Œéƒ½ä¸éœ€è¦å»å°è¯•åˆ é™¤owneräº†) if !found || !ownerNode.isDeletingDependents() { continue } // è¿™æ˜¯è®©attempToDeleteItemæ£€æŸ¥æ˜¯å¦åˆ é™¤äº†ownerçš„ä¾èµ–é¡¹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åˆ é™¤æ‰€æœ‰è€…ã€‚ gb.attemptToDelete.Add(ownerNode) } } return true } è¯¥æ–¹æ³•åŠŸèƒ½ä¸»è¦å°†å¯¹è±¡ã€ownerã€ä»èµ„æºåŠ å…¥åˆ°attemptToDeleteæˆ–attemptToOrphanã€‚\n1ã€ å‡ºé˜Ÿ # ä»graphChangesé˜Ÿåˆ—å–å‡ºèµ„æºå¯¹è±¡ï¼Œä»GraphBuilder.uidToNodeä¸­è¯»å–è¯¥èµ„æºèŠ‚ç‚¹ï¼ˆuidToNodeç»´æŠ¤ç€èµ„æºå¯¹è±¡ä¾èµ–å…³ç³»å›¾è¡¨ç»“æ„ï¼‰ï¼Œfoundä¸ºtrueæ—¶è¡¨ç¤ºå›¾è¡¨å­˜åœ¨è¯¥èµ„æºèŠ‚ç‚¹ï¼›\n2ã€switchçš„ç¬¬ä¸€ä¸ªcase # å¦‚æœè¯¥èµ„æºæ˜¯æ–°å¢æˆ–è€…æ›´æ–°è§¦å‘ï¼Œä¸”è¯¥èµ„æºå¯¹è±¡ä¸å­˜åœ¨äºå›¾è¡¨ä¸­ï¼Œgb.uidToNode.Write(n)ä¼šå°†å…¶å†™å…¥å›¾æ ‡ï¼›\ngb.insertNode(newNode)ä¸­çš„gb.addDependentToOwners(n, n.owners)æ–¹æ³•åˆ™ä¼šéå†è¯¥èµ„æºçš„ownerï¼Œå¦‚æœå…¶ownerä¸å­˜åœ¨äºå›¾æ ‡ä¸­ï¼Œåˆ™æ–°å¢ownerçš„è™šæ‹ŸèŠ‚ç‚¹åˆ°å›¾æ ‡ä¸­ï¼Œå¹¶å°†è¯¥èµ„æºå’Œowneräº§ç”Ÿå…³è”ã€‚å¦‚æœownerä¸å­˜åœ¨æ—¶ï¼Œåˆ™å°è¯•å°†owneråŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ä¸­å»ï¼›\n// addDependentToOwnerså°†næ·»åŠ åˆ°æ‰€æœ‰è€…çš„ä»å±åˆ—è¡¨ä¸­ã€‚å¦‚æœæ‰€æœ‰è€…ä¸å­˜åœ¨äºgb.uidToNodeä¸­ï¼Œåˆ™å°†åˆ›å»º\u0026#34;è™šæ‹Ÿ\u0026#34;èŠ‚ç‚¹ä»¥è¡¨ç¤º // æ‰€æœ‰è€…ã€‚ \u0026#34;è™šæ‹Ÿ\u0026#34;èŠ‚ç‚¹å°†å…¥é˜Ÿåˆ°attemptToDeleteï¼Œå› æ­¤ // attemptToDeleteItem()å°†æ ¹æ®APIæœåŠ¡å™¨éªŒè¯æ‰€æœ‰è€…æ˜¯å¦å­˜åœ¨ã€‚ func (gb *GraphBuilder) addDependentToOwners(n *node, owners []metav1.OwnerReference) { //éå†owner for _, owner := range owners { //è·å–owner nodeå¦‚æœä¸å­˜åœ¨äºå›¾ä¸­,åˆ™åŠ è™šæ‹ŸownerèŠ‚ç‚¹ ownerNode, ok := gb.uidToNode.Read(owner.UID) if !ok { // Create a \u0026#34;virtual\u0026#34; node in the graph for the owner if it doesn\u0026#39;t // exist in the graph yet. //å¦‚æœå›¾å½¢ä¸­å°šæœªå­˜åœ¨ï¼Œåˆ™åœ¨å›¾è¡¨ä¸­ä¸ºæ‰€æœ‰è€…åˆ›å»ºâ€œè™šæ‹Ÿâ€èŠ‚ç‚¹ã€‚ ownerNode = \u0026amp;node{ identity: objectReference{ OwnerReference: owner, Namespace: n.identity.Namespace, }, dependents: make(map[*node]struct{}), virtual: true, } klog.V(5).Infof(\u0026#34;add virtual node.identity: %s\\n\\n\u0026#34;, ownerNode.identity) gb.uidToNode.Write(ownerNode) } //ç»™owneråŠ è¯¥èµ„æºä½œä¸ºä¾èµ– ownerNode.addDependent(n) //ownerä¸å­˜åœ¨äºå›¾ä¸­æ—¶ï¼Œæ‰å¾€åˆ é™¤é˜Ÿåˆ—æ·»åŠ  if !ok { // Enqueue the virtual node into attemptToDelete. // The garbage processor will enqueue a virtual delete // event to delete it from the graph if API server confirms this // owner doesn\u0026#39;t exist. //å°†è™šæ‹ŸèŠ‚ç‚¹æ’å…¥attemptToDeleteã€‚ // å¦‚æœAPIæœåŠ¡å™¨ç¡®è®¤ownerä¸å­˜åœ¨ï¼Œåƒåœ¾å¤„ç†å™¨å°†æ’é˜Ÿè™šæ‹Ÿåˆ é™¤äº‹ä»¶ä»¥å°†å…¶ä»å›¾ä¸­åˆ é™¤ã€‚ gb.attemptToDelete.Add(ownerNode) } } } gb.processTransitionsæ–¹æ³•ï¼š\næ–°itemæ­£åœ¨è¢«åˆ ,æ—§itemæ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºOrphan FinalizeråŠ å…¥åˆ°attemptToOrphané˜Ÿåˆ—ï¼›\næ–°itemæ­£åœ¨è¢«åˆ ,æ—§itemæ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºforegroundDeletion Finalizerï¼Œåˆ™åŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ã€‚\nfunc (gb *GraphBuilder) processTransitions(oldObj interface{}, newAccessor metav1.Object, n *node) { //æ–°çš„æ­£åœ¨è¢«åˆ ,æ—§çš„æ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºOrphan Finalizer if startsWaitingForDependentsOrphaned(oldObj, newAccessor) { klog.V(5).Infof(\u0026#34;add %s to the attemptToOrphan\u0026#34;, n.identity) //åŠ å…¥åˆ°Orphané˜Ÿåˆ— gb.attemptToOrphan.Add(n) return } //æ–°çš„æ­£åœ¨è¢«åˆ ,æ—§çš„æ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºforegroundDeletion Finalizer if startsWaitingForDependentsDeleted(oldObj, newAccessor) { klog.V(2).Infof(\u0026#34;add %s to the attemptToDelete, because it\u0026#39;s waiting for its dependents to be deleted\u0026#34;, n.identity) // if the n is added as a \u0026#34;virtual\u0026#34; node, its deletingDependents field is not properly set, so always set it here. n.markDeletingDependents() for dep := range n.dependents { gb.attemptToDelete.Add(dep) } gb.attemptToDelete.Add(n) } } 3ã€switchçš„ç¬¬äºŒä¸ªcase # å¦‚æœè¯¥èµ„æºæ˜¯æ–°å¢æˆ–è€…æ›´æ–°è§¦å‘ï¼Œä¸”è¯¥èµ„æºå¯¹è±¡å­˜åœ¨äºå›¾è¡¨ä¸­ã€‚å¯¹æ¯”owneReferencesæ˜¯å¦æœ‰å˜æ›´ï¼ŒreferencesDiffsæ–¹æ³•é‡Œä¼šæ ¹æ®uidå¯¹æ¯”ï¼Œaddedè¡¨ç¤ºæ–°owneré‡Œæœ‰,æ—§owneré‡Œæ²¡æœ‰çš„, removedè¡¨ç¤ºæ—§owneré‡Œæœ‰,æ–°owneré‡Œæ²¡æœ‰çš„, changedè¡¨ç¤ºç›¸åŒuidçš„ownerä¸deepEqualçš„ã€‚\nfunc referencesDiffs(old []metav1.OwnerReference, new []metav1.OwnerReference) (added []metav1.OwnerReference, removed []metav1.OwnerReference, changed []ownerRefPair) { //keyä¸ºuid, valueä¸ºOwnerReference oldUIDToRef := make(map[string]metav1.OwnerReference) for _, value := range old { oldUIDToRef[string(value.UID)] = value } oldUIDSet := sets.StringKeySet(oldUIDToRef) //keyä¸ºuid, valueä¸ºOwnerReference newUIDToRef := make(map[string]metav1.OwnerReference) for _, value := range new { newUIDToRef[string(value.UID)] = value } newUIDSet := sets.StringKeySet(newUIDToRef) //æ–°çš„é‡Œæœ‰,æ—§çš„é‡Œæ²¡æœ‰çš„ä¸ºæ–°å¢(æ ¹æ®uidåˆ¤æ–­) addedUID := newUIDSet.Difference(oldUIDSet) //æ—§çš„é‡Œæœ‰,æ–°çš„é‡Œæ²¡æœ‰çš„ä¸ºåˆ é™¤(æ ¹æ®uidåˆ¤æ–­) removedUID := oldUIDSet.Difference(newUIDSet) //å–äº¤é›†, æ—§çš„å’Œæ–°çš„é‡Œéƒ½æœ‰çš„owner(æ ¹æ®uidåˆ¤æ–­) intersection := oldUIDSet.Intersection(newUIDSet) for uid := range addedUID { added = append(added, newUIDToRef[uid]) } for uid := range removedUID { removed = append(removed, oldUIDToRef[uid]) } //æ ¹æ®uidåˆ¤æ–­,ä¸¤ä¸ªuidç›¸ç­‰çš„OwnerReferenceæ˜¯å¦deepEqual,ä¸ç­‰åˆ™åŠ åˆ°changed for uid := range intersection { if !reflect.DeepEqual(oldUIDToRef[uid], newUIDToRef[uid]) { changed = append(changed, ownerRefPair{oldRef: oldUIDToRef[uid], newRef: newUIDToRef[uid]}) } } return added, removed, changed } æ•´ä½“æ¥è¯´ï¼Œownerå‘ç”Ÿå˜åŒ–ï¼ŒaddUnblockedOwnersToDeleteQueueæ–¹æ³•ä¼šåˆ¤æ–­ï¼šå¦‚æœé˜»å¡ownerReferenceæŒ‡å‘æŸä¸ªå¯¹è±¡è¢«åˆ é™¤ï¼Œæˆ–è€…è®¾ç½®ä¸ºBlockOwnerDeletion=falseï¼Œåˆ™å°†è¯¥å¯¹è±¡æ·»åŠ åˆ°attemptToDeleteé˜Ÿåˆ—ï¼›\n// if an blocking ownerReference points to an object gets removed, or gets set to // \u0026#34;BlockOwnerDeletion=false\u0026#34;, add the object to the attemptToDelete queue. //å¦‚æœé˜»å¡ownerReferenceæŒ‡å‘æŸä¸ªå¯¹è±¡è¢«åˆ é™¤ï¼Œæˆ–è€…è®¾ç½®ä¸º // \u0026#34;BlockOwnerDeletion = false\u0026#34;ï¼Œåˆ™å°†è¯¥å¯¹è±¡æ·»åŠ åˆ°attemptToDeleteé˜Ÿåˆ—ã€‚ func (gb *GraphBuilder) addUnblockedOwnersToDeleteQueue(removed []metav1.OwnerReference, changed []ownerRefPair) { for _, ref := range removed { //è¢«ç§»é™¤çš„OwnersReferences,BlockOwnerDeletionä¸ºtrue if ref.BlockOwnerDeletion != nil \u0026amp;\u0026amp; *ref.BlockOwnerDeletion { //ä¾èµ–å›¾è¡¨ä¸­å‘ç°,åˆ™åŠ å…¥åˆ é™¤é˜Ÿåˆ— node, found := gb.uidToNode.Read(ref.UID) if !found { klog.V(5).Infof(\u0026#34;cannot find %s in uidToNode\u0026#34;, ref.UID) continue } //åŠ å…¥å°è¯•åˆ é™¤é˜Ÿåˆ—åˆ é™¤è¿™ä¸ªowner gb.attemptToDelete.Add(node) } } // Ownerså­˜åœ¨ä¸”å‘ç”Ÿå˜åŒ–,æ—§çš„BlockOwnerDeletionä¸ºtrue, æ–°çš„BlockOwnerDeletionä¸ºç©ºæˆ–è€…BlockOwnerDeletionä¸ºfalseåˆ™åˆ é™¤owner(çˆ¶èŠ‚ç‚¹) for _, c := range changed { wasBlocked := c.oldRef.BlockOwnerDeletion != nil \u0026amp;\u0026amp; *c.oldRef.BlockOwnerDeletion isUnblocked := c.newRef.BlockOwnerDeletion == nil || (c.newRef.BlockOwnerDeletion != nil \u0026amp;\u0026amp; !*c.newRef.BlockOwnerDeletion) if wasBlocked \u0026amp;\u0026amp; isUnblocked { node, found := gb.uidToNode.Read(c.newRef.UID) if !found { klog.V(5).Infof(\u0026#34;cannot find %s in uidToNode\u0026#34;, c.newRef.UID) continue } gb.attemptToDelete.Add(node) } } } æ›´æ–°nodeçš„ownerï¼›\nåœ¨ä¾èµ–å›¾è¡¨ä¸­ç»™æ–°owneræ·»åŠ è¯¥nodeï¼›\nåœ¨ä¾èµ–å›¾è¡¨ä¸­,è¢«åˆ é™¤çš„owneråˆ—è¡¨ä¸‹åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚\ngb.processTransitionsæ–¹æ³•ï¼š\næ–°itemæ­£åœ¨è¢«åˆ ,æ—§itemæ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºOrphan FinalizeråŠ å…¥åˆ°attemptToOrphané˜Ÿåˆ—ï¼›\næ–°itemæ­£åœ¨è¢«åˆ ,æ—§itemæ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºforegroundDeletion Finalizerï¼Œåˆ™åŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ã€‚\n4ã€switchçš„ç¬¬ä¸‰ä¸ªcase # å¦‚æœè¯¥èµ„æºæ˜¯åˆ é™¤æ—¶è§¦å‘ï¼Œä»å›¾è¡¨ä¸­ç§»é™¤itemèµ„æºï¼ŒåŒæ—¶éå†ownersï¼Œç§»é™¤ownerä¸‹çš„itemèµ„æºï¼›\nå¦‚æœè¯¥èµ„æºçš„ä»èµ„æºæ•°å¤§äº0,åˆ™å°†è¯¥èµ„æºè¢«åˆ é™¤ä¿¡æ¯ï¼ˆuidï¼‰åŠ å…¥absentOwnerCacheç¼“å­˜ï¼Œè¿™æ ·å¤„ç†è¯¥èµ„æºçš„ä»èµ„æºæ—¶ï¼Œå°±çŸ¥é“ownerä¸å­˜åœ¨äº†ã€‚\néå†è¯¥èµ„æºçš„ä»èµ„æºåŠ åˆ°åˆ é™¤é˜Ÿåˆ—é‡Œï¼›\nå¦‚æœä»å›¾è¡¨ä¸­å‘ç° owneræˆ–è€… ownerçš„ä»èµ„æºæ­£åœ¨è¢«åˆ é™¤ï¼Œåˆ™å°è¯•å°†owneråŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ä¸­ï¼Œå»å°è¯•åˆ é™¤ownerã€‚\næ•´ç†æµç¨‹ # å½“controllermanageré‡å¯æ—¶ï¼Œä¼šå…¨é‡listwatchä¸€éæ‰€æœ‰å¯¹è±¡ï¼Œgc collectorç»´æŠ¤çš„uidToNodeå›¾è¡¨é‡Œå„ä¸ªèµ„æºå¯¹è±¡nodeæ˜¯ä¸å­˜åœ¨çš„ï¼Œæ­¤æ—¶ä¼šèµ°ç¬¬ä¸€ä¸ªswitch caseï¼Œæ„å»ºå®Œæ•´å…³ç³»å›¾è¡¨ï¼Œå¦‚æœownerä¸å­˜åœ¨åˆ™å…ˆæ„å»ºè™šæ‹ŸownerèŠ‚ç‚¹ï¼ŒåŒæ—¶åŠ å…¥attemptToDeleteé˜Ÿåˆ—ï¼Œå°è¯•å»åˆ é™¤è¿™ä¸ªownerï¼Œå…¶å®å³ä½¿åŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ï¼Œä¹Ÿä¸ä¸€å®šä¼šè¢«åˆ é™¤ï¼Œè¿˜ä¼šè¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­ï¼Œè¿™ä¸ªä¸‹ä¸€èŠ‚å†åˆ†æï¼›å°†æ­£åœ¨åˆ é™¤çš„èµ„æºï¼ŒåŒæ—¶Finalizerä¸ºOrphançš„åŠ å…¥åˆ°attemptToOrphané˜Ÿåˆ—ï¼›ä¸ºforegroundçš„èµ„æºä»¥åŠå…¶ä»èµ„æºåŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ï¼Œå¹¶å°†deletingDependentsè®¾ç½®ä¸ºtrueï¼› æ·»åŠ æˆ–è€…æ›´æ–°äº‹ä»¶æ—¶ï¼Œä¸”å›¾è¡¨ä¸­å­˜åœ¨itemèµ„æºå¯¹è±¡æ—¶ï¼Œä¼šèµ°ç¬¬äºŒä¸ªswitch caseï¼Œå¯¹itemçš„ownerå˜åŒ–è¿›è¡Œåˆ¤æ–­ï¼Œå¹¶ç»´æŠ¤æ›´æ–°å›¾è¡¨ï¼›åŒç†å°†æ­£åœ¨åˆ é™¤çš„èµ„æºï¼ŒåŒæ—¶Finalizerä¸ºOrphançš„åŠ å…¥åˆ°attemptToOrphané˜Ÿåˆ—ï¼›Finalizerä¸ºforegroundçš„èµ„æºä»¥åŠå…¶ä»èµ„æºåŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ï¼Œå¹¶å°†deletingDependentsè®¾ç½®ä¸ºtrueï¼› å¦‚æœæ˜¯åˆ é™¤äº‹ä»¶ï¼Œåˆ™ä¼šæ›´æ–°å›¾è¡¨ï¼Œå¹¶å¤„ç†å’Œå…¶ç›¸å…³çš„ä»èµ„æºå’Œå…¶owneråŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ã€‚ ç»ˆç»“å™¨ # åœ¨é˜…è¯»ä»¥ä¸‹ä»£ç æ—¶ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹ç»ˆç»“å™¨ã€‚\nå¯¹è±¡çš„ç»ˆç»“å™¨æ˜¯åœ¨å¯¹è±¡åˆ é™¤ä¹‹å‰éœ€è¦æ‰§è¡Œçš„é€»è¾‘ï¼Œæ‰€æœ‰çš„å¯¹è±¡åœ¨åˆ é™¤ä¹‹å‰ï¼Œå®ƒçš„ç»ˆç»“å™¨å­—æ®µå¿…é¡»ä¸ºç©ºï¼Œç»ˆç»“å™¨æä¾›äº†ä¸€ä¸ªé€šç”¨çš„ APIï¼Œå®ƒçš„åŠŸèƒ½ä¸åªæ˜¯ç”¨äºé˜»æ­¢çº§è”åˆ é™¤ï¼Œè¿˜èƒ½è¿‡é€šè¿‡å®ƒåœ¨å¯¹è±¡åˆ é™¤ä¹‹å‰åŠ å…¥é’©å­ï¼š\ntype ObjectMeta struct { // ... Finalizers []string } ç»ˆç»“å™¨åœ¨å¯¹è±¡è¢«åˆ ä¹‹å‰è¿è¡Œï¼Œæ¯å½“ç»ˆç»“å™¨æˆåŠŸè¿è¡Œä¹‹åï¼Œå°±ä¼šå°†å®ƒè‡ªå·±ä» Finalizers æ•°ç»„ä¸­åˆ é™¤ï¼Œå½“æœ€åä¸€ä¸ªç»ˆç»“å™¨è¢«åˆ é™¤ä¹‹åï¼ŒAPI Server å°±ä¼šåˆ é™¤è¯¥å¯¹è±¡ã€‚\nåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ é™¤ä¸€ä¸ªå¯¹è±¡ä¼šåˆ é™¤å®ƒçš„å…¨éƒ¨ä¾èµ–ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹æˆ‘ä»¬åªæ˜¯æƒ³åˆ é™¤å½“å‰å¯¹è±¡æœ¬èº«å¹¶ä¸æƒ³é€ æˆå¤æ‚çš„çº§è”åˆ é™¤ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶åœ¨è¿™æ—¶å¼•å…¥äº† OrphanFinalizerï¼Œå®ƒä¼šåœ¨å¯¹è±¡è¢«åˆ é™¤ä¹‹å‰å‘ Finalizers æ•°ç»„æ·»åŠ æˆ–è€…åˆ é™¤ OrphanFinalizerã€‚\nè¯¥ç»ˆç»“å™¨ä¼šç›‘å¬å¯¹è±¡çš„æ›´æ–°äº‹ä»¶å¹¶å°†å®ƒè‡ªå·±ä»å®ƒå…¨éƒ¨ä¾èµ–å¯¹è±¡çš„ OwnerReferences æ•°ç»„ä¸­åˆ é™¤ï¼Œä¸æ­¤åŒæ—¶ä¼šåˆ é™¤æ‰€æœ‰ä¾èµ–å¯¹è±¡ä¸­å·²ç»å¤±æ•ˆçš„ OwnerReferences å¹¶å°† OrphanFinalizer ä» Finalizers æ•°ç»„ä¸­åˆ é™¤ã€‚\né€šè¿‡ OrphanFinalizer æˆ‘ä»¬èƒ½å¤Ÿåœ¨åˆ é™¤ä¸€ä¸ª Kubernetes å¯¹è±¡æ—¶ä¿ç•™å®ƒçš„å…¨éƒ¨ä¾èµ–ï¼Œä¸ºä½¿ç”¨è€…æä¾›ä¸€ç§æ›´çµæ´»çš„åŠæ³•æ¥ä¿ç•™å’Œåˆ é™¤å¯¹è±¡ã€‚\nåŒæ—¶ï¼Œä¹Ÿå¸Œæœ›å¯ä»¥çœ‹ä¸€ä¸‹\u0026quot;åƒåœ¾å›æ”¶\u0026quot;å®˜ç½‘æ–‡æ¡£ï¼š\nåƒåœ¾æ”¶é›†\nattemptToDeleteé˜Ÿåˆ— # æ¥åˆ°ä»£ç $GOPATH\\src\\k8s.io\\kubernetes\\pkg\\controller\\garbagecollector\\garbagecollector.goä¸­ï¼š\nfunc (gc *GarbageCollector) runAttemptToDeleteWorker() { for gc.attemptToDeleteWorker() { } } ä»attemptToDeleteé˜Ÿåˆ—ä¸­å–å‡ºèµ„æºï¼Œè°ƒç”¨gc.attemptToDeleteItem(n)å¤„ç†ï¼ŒæœŸé—´å¦‚æœå‡ºç°errorï¼Œåˆ™é€šè¿‡rateLimitedé‡æ–°åŠ å›attemptToDeleteé˜Ÿåˆ—ã€‚\nfunc (gc *GarbageCollector) attemptToDeleteWorker() bool { //ä»é˜Ÿåˆ—é‡Œå–å‡ºéœ€è¦å°è¯•åˆ é™¤çš„èµ„æº item, quit := gc.attemptToDelete.Get() gc.workerLock.RLock() defer gc.workerLock.RUnlock() if quit { return false } defer gc.attemptToDelete.Done(item) n, ok := item.(*node) if !ok { utilruntime.HandleError(fmt.Errorf(\u0026#34;expect *node, got %#v\u0026#34;, item)) return true } err := gc.attemptToDeleteItem(n) if err != nil { if _, ok := err.(*restMappingError); ok { // There are at least two ways this can happen: // 1. The reference is to an object of a custom type that has not yet been // recognized by gc.restMapper (this is a transient error). // 2. The reference is to an invalid group/version. We don\u0026#39;t currently // have a way to distinguish this from a valid type we will recognize // after the next discovery sync. // For now, record the error and retry. klog.V(5).Infof(\u0026#34;error syncing item %s: %v\u0026#34;, n, err) } else { utilruntime.HandleError(fmt.Errorf(\u0026#34;error syncing item %s: %v\u0026#34;, n, err)) } // retry if garbage collection of an object failed. // å¦‚æœå¯¹è±¡çš„åƒåœ¾æ”¶é›†å¤±è´¥ï¼Œåˆ™é‡è¯•ã€‚ gc.attemptToDelete.AddRateLimited(item) } else if !n.isObserved() { // requeue if item hasn\u0026#39;t been observed via an informer event yet. // otherwise a virtual node for an item added AND removed during watch reestablishment can get stuck in the graph and never removed. // see https://issue.k8s.io/56121 klog.V(5).Infof(\u0026#34;item %s hasn\u0026#39;t been observed via informer yet\u0026#34;, n.identity) gc.attemptToDelete.AddRateLimited(item) } return true } å…³é”®æ–¹æ³•attemptToDeleteItemï¼š\nfunc (gc *GarbageCollector) attemptToDeleteItem(item *node) error { klog.V(2).Infof(\u0026#34;processing item %s\u0026#34;, item.identity) // \u0026#34;being deleted\u0026#34; is an one-way trip to the final deletion. We\u0026#39;ll just wait for the final deletion, and then process the object\u0026#39;s dependents. // itemèµ„æºè¢«æ ‡è®°ä¸ºæ­£åœ¨åˆ é™¤,å³deletionTimestampä¸ä¸ºnil;ä¸”ä¸æ˜¯æ­£åœ¨åˆ é™¤ä»èµ„æº(è¿™ä¸ªä»ä¸Šä¸€èŠ‚å¯ä»¥çœ‹å‡º,åªæœ‰itemè¢«foregroundæ–¹å¼åˆ é™¤æ—¶,deletingDependentsæ‰ä¼šè¢«è®¾ç½®ä¸ºtrue) // itemåœ¨åˆ é™¤ä¸­,ä¸”ä¸ºOrphanå’ŒBackgroundæ–¹å¼åˆ é™¤åˆ™ç›´æ¥è¿”å› if item.isBeingDeleted() \u0026amp;\u0026amp; !item.isDeletingDependents() { klog.V(5).Infof(\u0026#34;processing item %s returned at once, because its DeletionTimestamp is non-nil\u0026#34;, item.identity) return nil } // TODO: It\u0026#39;s only necessary to talk to the API server if this is a // \u0026#34;virtual\u0026#34; node. The local graph could lag behind the real status, but in // practice, the difference is small. //æ ¹æ®itemé‡Œçš„ä¿¡æ¯è·å–objectå¯¹è±¡ä½“ latest, err := gc.getObject(item.identity) switch { case errors.IsNotFound(err): // the GraphBuilder can add \u0026#34;virtual\u0026#34; node for an owner that doesn\u0026#39;t // exist yet, so we need to enqueue a virtual Delete event to remove // the virtual node from GraphBuilder.uidToNode. klog.V(5).Infof(\u0026#34;item %v not found, generating a virtual delete event\u0026#34;, item.identity) gc.dependencyGraphBuilder.enqueueVirtualDeleteEvent(item.identity) // since we\u0026#39;re manually inserting a delete event to remove this node, // we don\u0026#39;t need to keep tracking it as a virtual node and requeueing in attemptToDelete item.markObserved() return nil case err != nil: return err } //uidä¸åŒ¹é… if latest.GetUID() != item.identity.UID { klog.V(5).Infof(\u0026#34;UID doesn\u0026#39;t match, item %v not found, generating a virtual delete event\u0026#34;, item.identity) gc.dependencyGraphBuilder.enqueueVirtualDeleteEvent(item.identity) // since we\u0026#39;re manually inserting a delete event to remove this node, // we don\u0026#39;t need to keep tracking it as a virtual node and requeueing in attemptToDelete //å› ä¸ºæˆ‘ä»¬æ‰‹åŠ¨æ’å…¥åˆ é™¤äº‹ä»¶ä»¥åˆ é™¤æ­¤èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä¸éœ€è¦å°†å…¶ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹è·Ÿè¸ªå¹¶åœ¨attemptToDeleteä¸­é‡æ–°æ’é˜Ÿ item.markObserved() return nil } // TODO: attemptToOrphanWorker() routine is similar. Consider merging // attemptToOrphanWorker() into attemptToDeleteItem() as well. // itemçš„ä»èµ„æºæ­£åœ¨åˆ é™¤ä¸­,åŒæ—¶åˆ é™¤å…¶ä»èµ„æº if item.isDeletingDependents() { return gc.processDeletingDependentsItem(item) } // compute if we should delete the item // è·å–è¯¥objecté‡Œmetadata.ownerReference // è®¡ç®—æˆ‘ä»¬æ˜¯å¦åº”åˆ é™¤è¯¥é¡¹ç›® ownerReferences := latest.GetOwnerReferences() if len(ownerReferences) == 0 { //æ²¡æœ‰ownerçš„ä¸ç”¨å¤„ç† klog.V(2).Infof(\u0026#34;object %s\u0026#39;s doesn\u0026#39;t have an owner, continue on next item\u0026#34;, item.identity) return nil } //solid(ownerå­˜åœ¨,owneræ²¡è¢«åˆ æˆ–è€…ç»ˆç»“å™¨ä¸ä¸ºforegroundDeletion Finalizer); dangling(ownerä¸å­˜åœ¨) // waitingForDependentsDeletion(ownerå­˜åœ¨,ownerçš„deletionTimestampä¸ºénilï¼Œå¹¶ä¸”æœ‰foregroundDeletion Finalizer)owneråˆ—è¡¨ solid, dangling, waitingForDependentsDeletion, err := gc.classifyReferences(item, ownerReferences) if err != nil { return err } klog.V(5).Infof(\u0026#34;classify references of %s.\\nsolid: %#v\\ndangling: %#v\\nwaitingForDependentsDeletion: %#v\\n\u0026#34;, item.identity, solid, dangling, waitingForDependentsDeletion) switch { //itemå¯¹è±¡çš„ownerå­˜åœ¨,ä¸”ä¸æ˜¯æ­£åœ¨åˆ é™¤ case len(solid) != 0: klog.V(2).Infof(\u0026#34;object %#v has at least one existing owner: %#v, will not garbage collect\u0026#34;, solid, item.identity) if len(dangling) == 0 \u0026amp;\u0026amp; len(waitingForDependentsDeletion) == 0 { return nil } klog.V(2).Infof(\u0026#34;remove dangling references %#v and waiting references %#v for object %s\u0026#34;, dangling, waitingForDependentsDeletion, item.identity) // waitingForDependentsDeletion needs to be deleted from the // ownerReferences, otherwise the referenced objects will be stuck with // the FinalizerDeletingDependents and never get deleted. // waitingForDependentsDeletionéœ€è¦ä» ownerReferencesä¸­åˆ é™¤ï¼Œå¦åˆ™å¼•ç”¨çš„å¯¹è±¡å°†è¢« // FinalizerDeletingDependentsæ‰€å¡ä½ï¼Œå¹¶ä¸”æ°¸è¿œä¸ä¼šè¢«åˆ é™¤ã€‚ //éœ€è¦ç§»é™¤çš„ownerUids ownerUIDs := append(ownerRefsToUIDs(dangling), ownerRefsToUIDs(waitingForDependentsDeletion)...) //æ‹¼æ¥patchè¯·æ±‚å‚æ•° patch := deleteOwnerRefStrategicMergePatch(item.identity.UID, ownerUIDs...) //å‘é€patchè¯·æ±‚ _, err = gc.patch(item, patch, func(n *node) ([]byte, error) { return gc.deleteOwnerRefJSONMergePatch(n, ownerUIDs...) }) return err //itemå¯¹è±¡çš„owneræ­£åœ¨è¢«åˆ é™¤; ä¸”itemæœ‰ä»èµ„æº case len(waitingForDependentsDeletion) != 0 \u0026amp;\u0026amp; item.dependentsLength() != 0: deps := item.getDependents() // éå†itemä»èµ„æº for _, dep := range deps { if dep.isDeletingDependents() { // this circle detection has false positives, we need to // apply a more rigorous detection if this turns out to be a // problem. // there are multiple workers run attemptToDeleteItem in // parallel, the circle detection can fail in a race condition. klog.V(2).Infof(\u0026#34;processing object %s, some of its owners and its dependent [%s] have FinalizerDeletingDependents, to prevent potential cycle, its ownerReferences are going to be modified to be non-blocking, then the object is going to be deleted with Foreground\u0026#34;, item.identity, dep.identity) // ç”Ÿæˆä¸€ä¸ªè¡¥ä¸ï¼Œè¯¥è¡¥ä¸ä¼šå–æ¶ˆè®¾ç½®itemæ‰€æœ‰ownerReferencesçš„BlockOwnerDeletionå­—æ®µ,é¿å…é˜»å¡itemçš„owneråˆ é™¤ patch, err := item.unblockOwnerReferencesStrategicMergePatch() if err != nil { return err } //æ‰§è¡Œpatch if _, err := gc.patch(item, patch, gc.unblockOwnerReferencesJSONMergePatch); err != nil { return err } break } } //itemå¯¹è±¡çš„è‡³å°‘ä¸€ä¸ªownerå…·æœ‰foregroundDeletion Finalizerï¼Œå¹¶ä¸”è¯¥å¯¹è±¡æœ¬èº«å…·æœ‰ä¾èµ–é¡¹ï¼Œå› æ­¤å®ƒå°†åœ¨Foregroundä¸­åˆ é™¤ klog.V(2).Infof(\u0026#34;at least one owner of object %s has FinalizerDeletingDependents, and the object itself has dependents, so it is going to be deleted in Foreground\u0026#34;, item.identity) // the deletion event will be observed by the graphBuilder, so the item // will be processed again in processDeletingDependentsItem. If it // doesn\u0026#39;t have dependents, the function will remove the // FinalizerDeletingDependents from the item, resulting in the final // deletion of the item. // graphBuilderå°†è§‚å¯Ÿåˆ é™¤äº‹ä»¶ï¼Œå› æ­¤å°†åœ¨processDeletingDependentsItemä¸­å†æ¬¡å¤„ç†è¯¥é¡¹ç›®ã€‚ // å¦‚æœæ²¡æœ‰ä¾èµ–é¡¹ï¼Œè¯¥å‡½æ•°å°†ä»é¡¹ä¸­åˆ é™¤foregroundDeletion Finalizerï¼Œæœ€ç»ˆåˆ é™¤itemã€‚ policy := metav1.DeletePropagationForeground return gc.deleteObject(item.identity, \u0026amp;policy) default: // item doesn\u0026#39;t have any solid owner, so it needs to be garbage // collected. Also, none of item\u0026#39;s owners is waiting for the deletion of // the dependents, so set propagationPolicy based on existing finalizers. // itemæ²¡æœ‰ä»»ä½•å®ä½“æ‰€æœ‰è€…ï¼Œå› æ­¤éœ€è¦æ”¶é›†åƒåœ¾ ã€‚æ­¤å¤–ï¼Œé¡¹ç›®çš„æ‰€æœ‰è€…éƒ½æ²¡æœ‰ç­‰å¾…åˆ é™¤ // ä¾èµ–é¡¹ï¼Œå› æ­¤è¯·æ ¹æ®ç°æœ‰çš„ç»ˆç»“å™¨è®¾ç½®propagationPolicyã€‚ var policy metav1.DeletionPropagation switch { case hasOrphanFinalizer(latest): // if an existing orphan finalizer is already on the object, honor it. //å¦‚æœç°æœ‰çš„å­¤å„¿ç»ˆç»“å™¨å·²ç»åœ¨å¯¹è±¡ä¸Šï¼Œè¯·å°Šé‡å®ƒã€‚ policy = metav1.DeletePropagationOrphan case hasDeleteDependentsFinalizer(latest): // if an existing foreground finalizer is already on the object, honor it. //å¦‚æœç°æœ‰çš„å‰æ™¯ç»ˆç»“å™¨å·²ç»åœ¨å¯¹è±¡ä¸Šï¼Œè¯·å°Šé‡å®ƒã€‚ policy = metav1.DeletePropagationForeground default: // otherwise, default to background. //å¦åˆ™ï¼Œé»˜è®¤ä¸ºèƒŒæ™¯ã€‚ policy = metav1.DeletePropagationBackground } klog.V(2).Infof(\u0026#34;delete object %s with propagation policy %s\u0026#34;, item.identity, policy) //åˆ é™¤å­¤å„¿å¯¹è±¡ return gc.deleteObject(item.identity, \u0026amp;policy) } } ä¸»è¦åšä»¥ä¸‹äº‹æƒ…ï¼š\n1ã€itemåœ¨åˆ é™¤ä¸­ï¼Œä¸”ä¸ºOrphanå’ŒBackgroundæ–¹å¼åˆ é™¤åˆ™ç›´æ¥è¿”å›ï¼›\n2ã€itemæ˜¯foregroundæ–¹å¼åˆ é™¤æ—¶ï¼Œè°ƒç”¨processDeletingDependentsItemå»å¤„ç†é˜»å¡å…¶åˆ é™¤çš„ä»èµ„æºï¼Œå°†å…¶æ”¾åˆ°attemptToDeleteé˜Ÿåˆ—ï¼›\n3ã€è·å–itemçš„ownerå¯¹è±¡é›†ï¼Œè°ƒç”¨classifyReferenceså°†owneré›†åˆåˆ†ä¸º3ç±»ï¼Œåˆ†åˆ«ä¸ºsolidï¼ˆownerå­˜åœ¨æˆ–è€…ç»ˆç»“å™¨ä¸ä¸ºforegroundDeletionçš„owneré›†åˆï¼‰, danglingï¼ˆå·²ç»ä¸å­˜åœ¨äº†çš„owneré›†ç¾¤ï¼‰, waitingForDependentsDeletionï¼ˆownerçš„deletionTimestampä¸ºénilï¼Œå¹¶ä¸”ä¸ºforegroundDeletionç»ˆç»“å™¨çš„owneré›†åˆï¼‰\n4ã€switchç¬¬ä¸€ä¸ªcaseï¼šsolidé›†åˆä¸ä¸ºç©ºï¼Œå³itemå­˜åœ¨æ²¡è¢«åˆ é™¤çš„ownerã€‚å½“danglingå’ŒwaitingForDependentsDeletionéƒ½ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼›å½“danglingæˆ–waitingForDependentsDeletionä¸ä¸ºç©ºï¼Œåˆå¹¶ä¸¤ä¸ªé›†åˆuidï¼Œæ‰§è¡Œpatchè¯·æ±‚ï¼Œå°†è¿™äº›uidå¯¹åº”çš„ownerReferencesä»itemä¸­åˆ é™¤\n5ã€switchç¬¬äºŒä¸ªcaseï¼šwaitingForDependentsDeletioné›†åˆä¸ä¸ºç©ºï¼Œä¸”itemæœ‰ä»èµ„æºã€‚å³itemçš„ownerä¸å­˜åœ¨ï¼Œæˆ–æ­£åœ¨è¢«foregroundDeletionæ–¹å¼åˆ é™¤ï¼Œå¦‚æœitemçš„ä»èµ„æºæ­£åœ¨åˆ é™¤ä¾èµ–é¡¹ï¼Œåˆ™å–æ¶ˆé˜»æ­¢itemçš„owneråˆ é™¤ï¼Œç»™itemæ‰§è¡Œpatchè¯·æ±‚ï¼Œæœ€ç»ˆé‡‡ç”¨foregroundDeletionæ–¹å¼åˆ é™¤itemï¼›\n6ã€switchç¬¬ä¸‰ä¸ªcaseï¼šä»¥ä¸Šæ¡ä»¶ä¸ç¬¦åˆæ—¶ï¼Œåˆ™ç›´æ¥æ ¹æ®itemä¸­çš„ç»ˆç»“å™¨åˆ é™¤itemï¼Œé»˜è®¤ä¸ºBackgroundæ–¹å¼åˆ é™¤ã€‚\nå¾€ç»†äº†è¯´ï¼ŒprocessDeletingDependentsItemæ–¹æ³•è·å–itemä»èµ„æºä¸­BlockOwnerDeletionä¸ºtrueçš„ownerReferencesé›†åˆï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ç§»é™¤itemçš„foregroundDeletionç»ˆç»“å™¨ã€‚å¦åˆ™éå†ï¼Œå°†æœªå¼€å§‹åˆ é™¤çš„ä¾èµ–é¡¹çš„ä»èµ„æºdepåŠ å…¥åˆ°å°è¯•åˆ é™¤é˜Ÿåˆ—attemptToDeleteã€‚\n//ç­‰å¾…å…¶ä¾èµ–é¡¹è¢«åˆ é™¤çš„è¿›ç¨‹é¡¹ func (gc *GarbageCollector) processDeletingDependentsItem(item *node) error { //é˜»å¡itemèµ„æºåˆ é™¤çš„ä»èµ„æºåˆ—è¡¨ blockingDependents := item.blockingDependents() //æ²¡æœ‰é˜»å¡itemèµ„æºåˆ é™¤çš„ä»èµ„æº,åˆ™ç§»é™¤itemèµ„æºçš„foregroundDeletionç»ˆç»“å™¨ if len(blockingDependents) == 0 { klog.V(2).Infof(\u0026#34;remove DeleteDependents finalizer for item %s\u0026#34;, item.identity) return gc.removeFinalizer(item, metav1.FinalizerDeleteDependents) } //éå†é˜»å¡itemèµ„æºåˆ é™¤çš„ä»èµ„æº for _, dep := range blockingDependents { // å¦‚æœdepçš„ä»èµ„æºæ²¡æœ‰å¼€å§‹åˆ é™¤,åˆ™å°†depåŠ å…¥åˆ°å°è¯•åˆ é™¤é˜Ÿåˆ—ä¸­ if !dep.isDeletingDependents() { klog.V(2).Infof(\u0026#34;adding %s to attemptToDelete, because its owner %s is deletingDependents\u0026#34;, dep.identity, item.identity) //å°†ä»èµ„æºåŠ å…¥åˆ é™¤é˜Ÿåˆ— gc.attemptToDelete.Add(dep) } } return nil } gc.classifyReferences(item, ownerReferences)æ–¹æ³•ï¼šéå†äº†itemçš„owneråˆ—è¡¨ï¼Œè°ƒç”¨isDanglingæ–¹æ³•å°†å·²ä¸å­˜åœ¨çš„owneråŠ å…¥åˆ°isDanglingåˆ—è¡¨ï¼›owneræ­£åœ¨è¢«åˆ é™¤,ä¸”owneræœ‰foregroundDeletionç»ˆç»“å™¨çš„åŠ å…¥åˆ°waitingForDependentsDeletionåˆ—è¡¨ï¼›owneræ²¡å¼€å§‹åˆ æˆ–è€…ç»ˆç»“å™¨ä¸ä¸ºforegroundDeletionçš„åŠ å…¥åˆ°solidåˆ—è¡¨ã€‚\n// å°†latestReferencesåˆ†ä¸ºä¸‰ç±»ï¼š // solidï¼šæ‰€æœ‰è€…å­˜åœ¨ï¼Œä¸”ä¸æ˜¯waitingForDependentsDeletion // danglingæ‚¬ç©ºï¼šæ‰€æœ‰è€…ä¸å­˜åœ¨ // waitingForDependentsDeletion: æ‰€æœ‰è€…å­˜åœ¨ï¼Œå…¶deletionTimestampä¸ºénilï¼Œå¹¶ä¸”æœ‰FinalizerDeletingDependents func (gc *GarbageCollector) classifyReferences(item *node, latestReferences []metav1.OwnerReference) ( solid, dangling, waitingForDependentsDeletion []metav1.OwnerReference, err error) { //éå†è¯¥nodeçš„owner for _, reference := range latestReferences { //è·å–owneræ˜¯å¦å­˜åœ¨;isDanglingä¸ºtrueè¡¨ç¤ºä¸å­˜åœ¨,å‘ç”Ÿerråˆ™æœ€ç»ˆå°†è¯¥itemåŠ å…¥AddRateLimited attemptToDeleteé˜Ÿåˆ— isDangling, owner, err := gc.isDangling(reference, item) if err != nil { return nil, nil, nil, err } //å°†ä¸å­˜åœ¨çš„owneråŠ å…¥danglingåˆ‡ç‰‡ if isDangling { dangling = append(dangling, reference) continue } //ownerå­˜åœ¨,è·å–accessor ownerAccessor, err := meta.Accessor(owner) if err != nil { return nil, nil, nil, err } //owneræ­£åœ¨è¢«åˆ é™¤,ä¸”owneræœ‰foregroundDeletion Finalizer if ownerAccessor.GetDeletionTimestamp() != nil \u0026amp;\u0026amp; hasDeleteDependentsFinalizer(ownerAccessor) { //ownerå°†ç­‰å¾…ä¾èµ–åˆ é™¤;æ”¶é›†ç­‰å¾…åˆ é™¤ä¾èµ–çš„owneråˆ—è¡¨ waitingForDependentsDeletion = append(waitingForDependentsDeletion, reference) } else { //owneræ²¡è¢«åˆ æˆ–è€…ç»ˆç»“å™¨ä¸ä¸ºforegroundDeletion Finalizer solid = append(solid, reference) } } return solid, dangling, waitingForDependentsDeletion, nil } gc.isDangling(reference, item)æ–¹æ³•ï¼šå…ˆä»absentOwnerCacheç¼“å­˜ä¸­æ ¹æ®owner uidè·å–owneræ˜¯å¦å­˜åœ¨ï¼›å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™æ ¹æ®ownerReferencesä¸­çš„å‚æ•°ï¼Œæ„å»ºå‚æ•°ï¼Œè°ƒç”¨apiserveræ¥å£è·å–ownerå¯¹è±¡æ˜¯å¦èƒ½æŸ¥åˆ°ã€‚æŸ¥åˆ°å¦‚æœuidä¸åŒ¹é…ï¼ŒåŠ å…¥absentOwnerCacheç¼“å­˜ï¼Œå¹¶è¿”å›falseã€‚\n// isDanglingæ£€æŸ¥å¼•ç”¨æ˜¯å¦æŒ‡å‘ä¸å­˜åœ¨çš„å¯¹è±¡ã€‚ å¦‚æœisDanglingåœ¨APIæœåŠ¡å™¨ä¸ŠæŸ¥æ‰¾å¼•ç”¨çš„å¯¹è±¡ï¼Œå®ƒä¹Ÿè¿”å›å…¶æœ€æ–°çŠ¶æ€ã€‚ func (gc *GarbageCollector) isDangling(reference metav1.OwnerReference, item *node) ( dangling bool, owner *unstructured.Unstructured, err error) { if gc.absentOwnerCache.Has(reference.UID) { klog.V(5).Infof(\u0026#34;according to the absentOwnerCache, object %s\u0026#39;s owner %s/%s, %s does not exist\u0026#34;, item.identity.UID, reference.APIVersion, reference.Kind, reference.Name) return true, nil, nil } // TODO: we need to verify the reference resource is supported by the // system. If it\u0026#39;s not a valid resource, the garbage collector should i) // ignore the reference when decide if the object should be deleted, and // ii) should update the object to remove such references. This is to // prevent objects having references to an old resource from being // deleted during a cluster upgrade. resource, namespaced, err := gc.apiResource(reference.APIVersion, reference.Kind) if err != nil { return false, nil, err } // TODO: It\u0026#39;s only necessary to talk to the API server if the owner node // is a \u0026#34;virtual\u0026#34; node. The local graph could lag behind the real // status, but in practice, the difference is small. owner, err = gc.dynamicClient.Resource(resource).Namespace(resourceDefaultNamespace(namespaced, item.identity.Namespace)).Get(reference.Name, metav1.GetOptions{}) switch { case errors.IsNotFound(err): gc.absentOwnerCache.Add(reference.UID) klog.V(5).Infof(\u0026#34;object %s\u0026#39;s owner %s/%s, %s is not found\u0026#34;, item.identity.UID, reference.APIVersion, reference.Kind, reference.Name) return true, nil, nil case err != nil: return false, nil, err } if owner.GetUID() != reference.UID { klog.V(5).Infof(\u0026#34;object %s\u0026#39;s owner %s/%s, %s is not found, UID mismatch\u0026#34;, item.identity.UID, reference.APIVersion, reference.Kind, reference.Name) gc.absentOwnerCache.Add(reference.UID) return true, nil, nil } return false, owner, nil } attemptToOrphané˜Ÿåˆ— # æ¥åˆ°ä»£ç ï¼š\nfunc (gc *GarbageCollector) runAttemptToOrphanWorker() { for gc.attemptToOrphanWorker() { } } æ­»å¾ªç¯ä¸€ç›´ä»attemptToOrphané˜Ÿåˆ—ä¸­è·å–itemèµ„æºï¼Œè°ƒç”¨gc.orphanDependents(owner.identity, dependents)æ–¹æ³•ï¼Œä»itemä»èµ„æºä¸­åˆ æ‰è¯¥itemçš„ownerReferencesï¼ŒæœŸé—´å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåˆ™é€šè¿‡rateLimitedé‡æ–°åŠ å›attemptToOrphané˜Ÿåˆ—ã€‚æœ€åç§»é™¤itemä¸­çš„orphanç»ˆç»“å™¨ã€‚\n// attemptToOrphanWorkerå°†ä¸€ä¸ªèŠ‚ç‚¹ä»attemptToOrphanä¸­å–å‡ºï¼Œç„¶åæ ¹æ®GCç»´æŠ¤çš„å›¾æ‰¾åˆ°å®ƒçš„ä¾èµ–é¡¹ï¼Œç„¶åå°†å…¶ä»å…¶ä¾èµ–é¡¹çš„ // OwnerReferencesä¸­åˆ é™¤ï¼Œæœ€åæ›´æ–°itemä»¥åˆ é™¤å­¤å„¿ç»ˆç»“å™¨ã€‚å¦‚æœè¿™äº›æ­¥éª¤ä¸­çš„ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œåˆ™å°†èŠ‚ç‚¹æ·»åŠ å›attemptToOrphanã€‚ func (gc *GarbageCollector) attemptToOrphanWorker() bool { item, quit := gc.attemptToOrphan.Get() gc.workerLock.RLock() defer gc.workerLock.RUnlock() if quit { return false } defer gc.attemptToOrphan.Done(item) owner, ok := item.(*node) if !ok { utilruntime.HandleError(fmt.Errorf(\u0026#34;expect *node, got %#v\u0026#34;, item)) return true } // we don\u0026#39;t need to lock each element, because they never get updated owner.dependentsLock.RLock() dependents := make([]*node, 0, len(owner.dependents)) for dependent := range owner.dependents { dependents = append(dependents, dependent) } owner.dependentsLock.RUnlock() // å¤„ç†å­¤å„¿ err := gc.orphanDependents(owner.identity, dependents) if err != nil { utilruntime.HandleError(fmt.Errorf(\u0026#34;orphanDependents for %s failed with %v\u0026#34;, owner.identity, err)) gc.attemptToOrphan.AddRateLimited(item) return true } // update the owner, remove \u0026#34;orphaningFinalizer\u0026#34; from its finalizers list // ç§»é™¤itemçš„orphanç»ˆç»“å™¨ err = gc.removeFinalizer(owner, metav1.FinalizerOrphanDependents) if err != nil { utilruntime.HandleError(fmt.Errorf(\u0026#34;removeOrphanFinalizer for %s failed with %v\u0026#34;, owner.identity, err)) gc.attemptToOrphan.AddRateLimited(item) } return true } gc.orphanDependents(owner.identity, dependents)æ–¹æ³•ï¼šéå†itemçš„ä»èµ„æºï¼Œå¹¶å‘çš„æ‰§è¡Œpatchè¯·æ±‚ï¼Œåˆ é™¤ä»èµ„æºä¸­å’ŒitemåŒuidçš„ownerReferencesï¼Œå°†erroråŠ å…¥åˆ°errCh channelä¸­ï¼Œæœ€åç»™è°ƒç”¨è€…è¿”å›erroråˆ—è¡¨ï¼š\n// dependents are copies of pointers to the owner\u0026#39;s dependents, they don\u0026#39;t need to be locked. func (gc *GarbageCollector) orphanDependents(owner objectReference, dependents []*node) error { errCh := make(chan error, len(dependents)) wg := sync.WaitGroup{} wg.Add(len(dependents)) for i := range dependents { go func(dependent *node) { defer wg.Done() // the dependent.identity.UID is used as precondition patch := deleteOwnerRefStrategicMergePatch(dependent.identity.UID, owner.UID) _, err := gc.patch(dependent, patch, func(n *node) ([]byte, error) { return gc.deleteOwnerRefJSONMergePatch(n, owner.UID) }) // note that if the target ownerReference doesn\u0026#39;t exist in the // dependent, strategic merge patch will NOT return an error. if err != nil \u0026amp;\u0026amp; !errors.IsNotFound(err) { errCh \u0026lt;- fmt.Errorf(\u0026#34;orphaning %s failed, %v\u0026#34;, dependent.identity, err) } }(dependents[i]) } wg.Wait() close(errCh) var errorsSlice []error for e := range errCh { errorsSlice = append(errorsSlice, e) } if len(errorsSlice) != 0 { return fmt.Errorf(\u0026#34;failed to orphan dependents of owner %s, got errors: %s\u0026#34;, owner, utilerrors.NewAggregate(errorsSlice).Error()) } klog.V(5).Infof(\u0026#34;successfully updated all dependents of owner %s\u0026#34;, owner) return nil } deleteOwnerRefStrategicMergePatchæ–¹æ³•ï¼šæ‹¼æ¥patchè¯·æ±‚å‚æ•°ã€‚è¯¥æ–¹æ³•åŒæ ·çš„ï¼Œåœ¨å¤„ç†attemptToDeleteæ­»å¾ªä¸­ï¼Œç¬¬ä¸€ä¸ªswitch caseå¤„è¢«è°ƒç”¨ã€‚\nfunc deleteOwnerRefStrategicMergePatch(dependentUID types.UID, ownerUIDs ...types.UID) []byte { var pieces []string //æ‹¼æ¥éœ€è¦åˆ é™¤çš„uid for _, ownerUID := range ownerUIDs { pieces = append(pieces, fmt.Sprintf(`{\u0026#34;$patch\u0026#34;:\u0026#34;delete\u0026#34;,\u0026#34;uid\u0026#34;:\u0026#34;%s\u0026#34;}`, ownerUID)) } //æ‹¼æ¥patchè¯·æ±‚å‚æ•° patch := fmt.Sprintf(`{\u0026#34;metadata\u0026#34;:{\u0026#34;ownerReferences\u0026#34;:[%s],\u0026#34;uid\u0026#34;:\u0026#34;%s\u0026#34;}}`, strings.Join(pieces, \u0026#34;,\u0026#34;), dependentUID) return []byte(patch) } å›åˆ°åˆè¡· # ä¸­é—´ä»¶rediså®¹å™¨åŒ–åï¼Œåœ¨æµ‹è¯•ç¯å¢ƒä¸Šéƒ¨ç½²çš„redisé›†ç¾¤ï¼Œåœ¨kubernetes apiserveré‡å¯åï¼Œredisé›†ç¾¤è¢«å¼‚å¸¸åˆ é™¤ï¼ˆåŒ…æ‹¬redis exporter statefulsetã€redis statefulsetï¼‰ã€‚\nåŸå› å®šä½ # åœ¨å¼€å‘ç¯å¢ƒä¸Šç»å¤šæ¬¡å¤ç°ï¼Œapiserveré‡å¯åï¼Œé€šè¿‡æŸ¥è¯¢redis operatoræ—¥å¿—ï¼Œå¹¶æ²¡æœ‰å‘ç°ä¸»åŠ¨å»åˆ é™¤redisé›†ç¾¤ï¼ˆredis statefulsetï¼‰ã€ç›‘æ§å®ä¾‹ï¼ˆredis exporterï¼‰ã€‚è¿›ä¸€æ­¥å»æŸ¥çœ‹kube-controller-managerçš„æ—¥å¿—ï¼Œå°†å…¶æ—¥å¿—çº§åˆ«è®¾ç½®\u0026ndash;v=5ï¼Œç»§ç»­å¤ç°ï¼Œæœ€ç»ˆåœ¨kube-controller-manageræ—¥å¿—ä¸­å‘ç°å¦‚ä¸‹æ—¥å¿—ï¼š\nå¯ä»¥çœ‹åˆ°ï¼Œåƒåœ¾å›æ”¶å™¨garbage collectoråœ¨å¤„ç†redis exporter statefulsetæ—¶ï¼Œå‘ç°å…¶åŠ äº†ownerReferencesï¼Œåœ¨exporteræ‰€åœ¨åˆ†åŒºï¼ˆmonitoringï¼‰æŸ¥è¯¢å…¶ownerâ€”â€”redisClusterå¯¹è±¡redis-0826ï¼Œè€ŒredisClusterå¯¹è±¡redis-0826å­˜åœ¨äºkube-systemåˆ†åŒºï¼Œæ‰€ä»¥åœ¨monitoringåˆ†åŒºæŸ¥è¯¢åˆ°çš„æ˜¯404 Not Foundï¼Œgarbage collectorä¼šå°†è¯¥ownerä¸å­˜åœ¨ä¿¡æ¯ï¼ˆuidï¼‰å­˜å…¥ç¼“å­˜absentOwnerCacheã€‚\nå› redis exporter statefulsetçš„ownerä¸å­˜åœ¨ï¼Œæ‰€ä»¥gcè®¤ä¸ºéœ€è¦å›æ”¶åƒåœ¾ï¼Œæ•…å°†å…¶åˆ é™¤æ‰ã€‚åŒç†ï¼Œå½“å¤„ç†redis statefulsetæ—¶ï¼Œä»ç¼“å­˜ä¸­å‘ç°ownerä¸å­˜åœ¨ï¼Œä¹Ÿä¼šå›æ”¶åƒåœ¾ï¼Œå°†å…¶åˆ é™¤æ‰ã€‚\nç»è¿‡å¤šæ¬¡å¤ç°æ•…éšœï¼Œå‘ç°é‡å¯kube-controller-manageræ—¶æœ‰æ¦‚ç‡å¤ç°ã€‚ï¼ˆApiserverçš„é‡å¯æ—¶ï¼Œkube-controller-manageråœ¨è¿æ¥apiserverå¤±è´¥å¤šæ¬¡åï¼Œä¹Ÿä¼šå‘ç”Ÿè‡ªé‡å¯ï¼‰ï¼Œä¹‹æ‰€ä»¥æ˜¯æ¦‚ç‡é—®é¢˜ï¼Œè¿™å’Œgarbage collectorå°†èµ„æºå¯¹è±¡åŠ å…¥attemptToDeleteé˜Ÿåˆ—çš„é¡ºåºæœ‰å…³ï¼š\nå…ˆåŒæ­¥monitoringåˆ†åŒºçš„exporter statefulsetï¼ŒååŒæ­¥kube-systemåˆ†åŒºçš„redis statefulsetï¼Œå°±ä¼šå‡ºç°è¯¥æ•…éšœï¼›åä¹‹å°±ä¸ä¼šå‡ºç°æ•…éšœï¼Œè¿™å–å†³äºgarbage collectorå¯åŠ¨æ—¶å…¨é‡è·å–é›†ç¾¤å†…èµ„æºï¼ˆlistwatchï¼‰çš„é¡ºåºã€‚\nåœ¨apiserverå’Œkube-controller-manageræ­£å¸¸è¿è¡Œæ—¶ä¸å‡ºç°è¯¥æ•…éšœï¼Œå¯ä»¥ä»garbage collectoræºç ä¸­çœ‹åˆ°ä»¥ä¸‹ä»£ç é€»è¾‘ï¼š\nGarbage collectorä¸­ç»´æŠ¤ä¸€ä¸ªçˆ¶å­å…³ç³»å›¾è¡¨ï¼Œcontroller-managerå¯åŠ¨æ—¶è¯¥å›¾é‡ŒèŠ‚ç‚¹æ˜¯ä¸å­˜åœ¨çš„ï¼Œä¼šèµ°ä¸Šå›¾switchçš„ç¬¬ä¸€ä¸ªcaseï¼Œä¹‹åå›¾å½¢æˆä¹‹åï¼Œä¼šèµ°ç¬¬äºŒä¸ªcaseã€‚ç¬¬äºŒä¸ªcaseé‡Œåªæœ‰åœ¨ownerå‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šè§¦å‘å°†èµ„æºå¯¹è±¡åŠ å…¥attemptToDeleteé˜Ÿåˆ—ï¼Œæ‰€ä»¥åœ¨å„ä¸ªç»„ä»¶æ­£å¸¸è¿è¡Œæ—¶æ²¡æœ‰å‡ºç°è¯¥æ•…éšœã€‚\nè·å–å›¾è¡¨çš„æ¥å£åœ°å€ï¼ŒIPå’Œç«¯å£éƒ½æ˜¯controller-managerçš„ï¼Œå¯ä»¥é‡å®šå‘åˆ°tmp.dotæ–‡ä»¶\ncurl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph curl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph?uid=11211212edsaddkqedmk12 ä¹‹åç”¨å¯è§†åŒ–å·¥å…·Graphvizè½¯ä»¶ï¼Œè¿›å…¥åˆ°binç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆsvgæ–‡ä»¶ï¼Œç”¨æµè§ˆå™¨æ‰“å¼€ï¼ŒGraphvizå’Œdotçš„ä½¿ç”¨å¯ä»¥è‡ªè¡Œè°·æ­Œã€‚\ndot -Tsvg -o graph2.svg tmp.dot è§£å†³æ–¹æ³• # åœ¨redis operatoråˆ›å»ºredisé›†ç¾¤æ—¶ï¼Œå°†exporteræ”¾åˆ°å’ŒredisåŒä¸€åˆ†åŒºã€‚\næ€è€ƒåæ€ # 1ã€å‡ºç°è¯¥æ•…éšœï¼Œä¸»è¦æ˜¯å› è¿›è¡Œäº†è·¨å‘½åç©ºé—´ownerå¼•ç”¨ã€‚åœ¨ä½¿ç”¨åƒåœ¾å›æ”¶æœºåˆ¶æ—¶ï¼Œåº”è¯¥å°½é‡å‚è€ƒkuberneteså®˜æ–¹ç½‘ç«™ä¸­çš„è¯´æ˜.\nå¦‚ä¸‹ï¼Œå®˜ç½‘ä¸­è¯´æ˜äº†ownerå¼•ç”¨åœ¨è®¾è®¡æ—¶å°±ä¸å…è®¸è·¨namespaceä½¿ç”¨ï¼Œè¿™æ„å‘³ç€ï¼š\n1ï¼‰å‘½åç©ºé—´èŒƒå›´çš„ä»å±åªèƒ½æŒ‡å®šåŒä¸€å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰è€…ï¼Œä»¥åŠç¾¤é›†èŒƒå›´çš„æ‰€æœ‰è€…ã€‚\n2ï¼‰ç¾¤é›†ä½œç”¨åŸŸçš„ä»å±åªèƒ½æŒ‡å®šç¾¤é›†ä½œç”¨åŸŸçš„æ‰€æœ‰è€…ï¼Œè€Œä¸èƒ½æŒ‡å®šå‘½åç©ºé—´ä½œç”¨åŸŸçš„æ‰€æœ‰è€…ã€‚\nå‚è€ƒæ–‡æ¡£ # è¯¦è§£ Kubernetes åƒåœ¾æ”¶é›†å™¨çš„å®ç°åŸç†ï¼š\nhttps://draveness.me/kubernetes-garbage-collector#\nk8så®˜æ–¹æ–‡æ¡£garbage-collectionè‹±æ–‡ç‰ˆï¼š\nhttps://kubernetes.io/docs/concepts/workloads/controllers/garbage-collection/\nä¾èµ–å›¾æ ‡ç”Ÿæˆåº“gonum Apiæ–‡æ¡£ï¼š\nhttps://godoc.org/gonum.org/v1/gonum/graph\ngraphvizä¸‹è½½ï¼š\nhttps://graphviz.gitlab.io/_pages/Download/Download_windows.html\n","date":"2019å¹´10æœˆ22æ—¥","externalUrl":null,"permalink":"/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","section":"Posts","summary":"\u003ch1 class=\"relative group\"\u003ekubernetesåƒåœ¾å›æ”¶å™¨GarbageCollector æºç åˆ†æ \n    \u003cdiv id=\"kubernetesåƒåœ¾å›æ”¶å™¨garbagecollector-æºç åˆ†æ\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#kubernetes%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6%e5%99%a8garbagecollector-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003ekubernetesç‰ˆæœ¬ï¼š1.13.2\u003c/strong\u003e\u003c/p\u003e","title":"kubernetesåƒåœ¾å›æ”¶å™¨GarbageCollectoræºç åˆ†æ","type":"posts"},{"content":" kubernetesç‰ˆæœ¬ï¼š1.13.2\næ¥å‰ä¸¤èŠ‚ï¼š\nkubernetesåƒåœ¾å›æ”¶å™¨GarbageCollector Controlleræºç åˆ†æï¼ˆä¸€ï¼‰\nkubernetesåƒåœ¾å›æ”¶å™¨GarbageCollector Controlleræºç åˆ†æï¼ˆäºŒï¼‰\nä¸»è¦æ­¥éª¤ # GarbageCollector Controlleræºç ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š\nmonitorsä½œä¸ºç”Ÿäº§è€…å°†å˜åŒ–çš„èµ„æºæ”¾å…¥graphChangesé˜Ÿåˆ—ï¼›åŒæ—¶restMapperå®šæœŸæ£€æµ‹é›†ç¾¤å†…èµ„æºç±»å‹ï¼Œåˆ·æ–°monitors runProcessGraphChangesä»graphChangesé˜Ÿåˆ—ä¸­å–å‡ºå˜åŒ–çš„itemï¼Œæ ¹æ®æƒ…å†µæ”¾å…¥attemptToDeleteé˜Ÿåˆ—ï¼› runProcessGraphChangesä»graphChangesé˜Ÿåˆ—ä¸­å–å‡ºå˜åŒ–çš„itemï¼Œæ ¹æ®æƒ…å†µæ”¾å…¥attemptToOrphané˜Ÿåˆ—ï¼› runAttemptToDeleteWorkerä»attemptToDeleteé˜Ÿåˆ—å–å‡ºï¼Œå°è¯•åˆ é™¤åƒåœ¾èµ„æºï¼› runAttemptToOrphanWorkerä»attemptToOrphané˜Ÿåˆ—å–å‡ºï¼Œå¤„ç†è¯¥å­¤ç«‹çš„èµ„æºï¼›\nä¸Šä¸€èŠ‚åˆ†æäº†ç¬¬2,3éƒ¨åˆ†ï¼Œæœ¬èŠ‚åˆ†æç¬¬4ã€5éƒ¨åˆ†ã€‚ ç»ˆç»“å™¨ # åœ¨é˜…è¯»ä»¥ä¸‹ä»£ç æ—¶ï¼Œæœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹ç»ˆç»“å™¨ã€‚\nå¯¹è±¡çš„ç»ˆç»“å™¨æ˜¯åœ¨å¯¹è±¡åˆ é™¤ä¹‹å‰éœ€è¦æ‰§è¡Œçš„é€»è¾‘ï¼Œæ‰€æœ‰çš„å¯¹è±¡åœ¨åˆ é™¤ä¹‹å‰ï¼Œå®ƒçš„ç»ˆç»“å™¨å­—æ®µå¿…é¡»ä¸ºç©ºï¼Œç»ˆç»“å™¨æä¾›äº†ä¸€ä¸ªé€šç”¨çš„ APIï¼Œå®ƒçš„åŠŸèƒ½ä¸åªæ˜¯ç”¨äºé˜»æ­¢çº§è”åˆ é™¤ï¼Œè¿˜èƒ½è¿‡é€šè¿‡å®ƒåœ¨å¯¹è±¡åˆ é™¤ä¹‹å‰åŠ å…¥é’©å­ï¼š\ntype ObjectMeta struct { // ... Finalizers []string } ç»ˆç»“å™¨åœ¨å¯¹è±¡è¢«åˆ ä¹‹å‰è¿è¡Œï¼Œæ¯å½“ç»ˆç»“å™¨æˆåŠŸè¿è¡Œä¹‹åï¼Œå°±ä¼šå°†å®ƒè‡ªå·±ä» Finalizers æ•°ç»„ä¸­åˆ é™¤ï¼Œå½“æœ€åä¸€ä¸ªç»ˆç»“å™¨è¢«åˆ é™¤ä¹‹åï¼ŒAPI Server å°±ä¼šåˆ é™¤è¯¥å¯¹è±¡ã€‚\nåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ é™¤ä¸€ä¸ªå¯¹è±¡ä¼šåˆ é™¤å®ƒçš„å…¨éƒ¨ä¾èµ–ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹æˆ‘ä»¬åªæ˜¯æƒ³åˆ é™¤å½“å‰å¯¹è±¡æœ¬èº«å¹¶ä¸æƒ³é€ æˆå¤æ‚çš„çº§è”åˆ é™¤ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶åœ¨è¿™æ—¶å¼•å…¥äº† OrphanFinalizerï¼Œå®ƒä¼šåœ¨å¯¹è±¡è¢«åˆ é™¤ä¹‹å‰å‘ Finalizers æ•°ç»„æ·»åŠ æˆ–è€…åˆ é™¤ OrphanFinalizerã€‚\nè¯¥ç»ˆç»“å™¨ä¼šç›‘å¬å¯¹è±¡çš„æ›´æ–°äº‹ä»¶å¹¶å°†å®ƒè‡ªå·±ä»å®ƒå…¨éƒ¨ä¾èµ–å¯¹è±¡çš„ OwnerReferences æ•°ç»„ä¸­åˆ é™¤ï¼Œä¸æ­¤åŒæ—¶ä¼šåˆ é™¤æ‰€æœ‰ä¾èµ–å¯¹è±¡ä¸­å·²ç»å¤±æ•ˆçš„ OwnerReferences å¹¶å°† OrphanFinalizer ä» Finalizers æ•°ç»„ä¸­åˆ é™¤ã€‚\né€šè¿‡ OrphanFinalizer æˆ‘ä»¬èƒ½å¤Ÿåœ¨åˆ é™¤ä¸€ä¸ª Kubernetes å¯¹è±¡æ—¶ä¿ç•™å®ƒçš„å…¨éƒ¨ä¾èµ–ï¼Œä¸ºä½¿ç”¨è€…æä¾›ä¸€ç§æ›´çµæ´»çš„åŠæ³•æ¥ä¿ç•™å’Œåˆ é™¤å¯¹è±¡ã€‚\nåŒæ—¶ï¼Œä¹Ÿå¸Œæœ›å¯ä»¥çœ‹ä¸€ä¸‹\u0026quot;åƒåœ¾å›æ”¶\u0026quot;å®˜ç½‘æ–‡æ¡£ï¼š\nåƒåœ¾æ”¶é›†\nattemptToDeleteé˜Ÿåˆ— # æ¥åˆ°ä»£ç $GOPATH\\src\\k8s.io\\kubernetes\\pkg\\controller\\garbagecollector\\garbagecollector.goä¸­ï¼š\nfunc (gc *GarbageCollector) runAttemptToDeleteWorker() { for gc.attemptToDeleteWorker() { } } ä»attemptToDeleteé˜Ÿåˆ—ä¸­å–å‡ºèµ„æºï¼Œè°ƒç”¨gc.attemptToDeleteItem(n)å¤„ç†ï¼ŒæœŸé—´å¦‚æœå‡ºç°errorï¼Œåˆ™é€šè¿‡rateLimitedé‡æ–°åŠ å›attemptToDeleteé˜Ÿåˆ—ã€‚\nfunc (gc *GarbageCollector) attemptToDeleteWorker() bool { //ä»é˜Ÿåˆ—é‡Œå–å‡ºéœ€è¦å°è¯•åˆ é™¤çš„èµ„æº item, quit := gc.attemptToDelete.Get() gc.workerLock.RLock() defer gc.workerLock.RUnlock() if quit { return false } defer gc.attemptToDelete.Done(item) n, ok := item.(*node) if !ok { utilruntime.HandleError(fmt.Errorf(\u0026#34;expect *node, got %#v\u0026#34;, item)) return true } err := gc.attemptToDeleteItem(n) if err != nil { if _, ok := err.(*restMappingError); ok { // There are at least two ways this can happen: // 1. The reference is to an object of a custom type that has not yet been // recognized by gc.restMapper (this is a transient error). // 2. The reference is to an invalid group/version. We don\u0026#39;t currently // have a way to distinguish this from a valid type we will recognize // after the next discovery sync. // For now, record the error and retry. klog.V(5).Infof(\u0026#34;error syncing item %s: %v\u0026#34;, n, err) } else { utilruntime.HandleError(fmt.Errorf(\u0026#34;error syncing item %s: %v\u0026#34;, n, err)) } // retry if garbage collection of an object failed. // å¦‚æœå¯¹è±¡çš„åƒåœ¾æ”¶é›†å¤±è´¥ï¼Œåˆ™é‡è¯•ã€‚ gc.attemptToDelete.AddRateLimited(item) } else if !n.isObserved() { // requeue if item hasn\u0026#39;t been observed via an informer event yet. // otherwise a virtual node for an item added AND removed during watch reestablishment can get stuck in the graph and never removed. // see https://issue.k8s.io/56121 klog.V(5).Infof(\u0026#34;item %s hasn\u0026#39;t been observed via informer yet\u0026#34;, n.identity) gc.attemptToDelete.AddRateLimited(item) } return true } å…³é”®æ–¹æ³•attemptToDeleteItemï¼š\nfunc (gc *GarbageCollector) attemptToDeleteItem(item *node) error { klog.V(2).Infof(\u0026#34;processing item %s\u0026#34;, item.identity) // \u0026#34;being deleted\u0026#34; is an one-way trip to the final deletion. We\u0026#39;ll just wait for the final deletion, and then process the object\u0026#39;s dependents. // itemèµ„æºè¢«æ ‡è®°ä¸ºæ­£åœ¨åˆ é™¤,å³deletionTimestampä¸ä¸ºnil;ä¸”ä¸æ˜¯æ­£åœ¨åˆ é™¤ä»èµ„æº(è¿™ä¸ªä»ä¸Šä¸€èŠ‚å¯ä»¥çœ‹å‡º,åªæœ‰itemè¢«foregroundæ–¹å¼åˆ é™¤æ—¶,deletingDependentsæ‰ä¼šè¢«è®¾ç½®ä¸ºtrue) // itemåœ¨åˆ é™¤ä¸­,ä¸”ä¸ºOrphanå’ŒBackgroundæ–¹å¼åˆ é™¤åˆ™ç›´æ¥è¿”å› if item.isBeingDeleted() \u0026amp;\u0026amp; !item.isDeletingDependents() { klog.V(5).Infof(\u0026#34;processing item %s returned at once, because its DeletionTimestamp is non-nil\u0026#34;, item.identity) return nil } // TODO: It\u0026#39;s only necessary to talk to the API server if this is a // \u0026#34;virtual\u0026#34; node. The local graph could lag behind the real status, but in // practice, the difference is small. //æ ¹æ®itemé‡Œçš„ä¿¡æ¯è·å–objectå¯¹è±¡ä½“ latest, err := gc.getObject(item.identity) switch { case errors.IsNotFound(err): // the GraphBuilder can add \u0026#34;virtual\u0026#34; node for an owner that doesn\u0026#39;t // exist yet, so we need to enqueue a virtual Delete event to remove // the virtual node from GraphBuilder.uidToNode. klog.V(5).Infof(\u0026#34;item %v not found, generating a virtual delete event\u0026#34;, item.identity) gc.dependencyGraphBuilder.enqueueVirtualDeleteEvent(item.identity) // since we\u0026#39;re manually inserting a delete event to remove this node, // we don\u0026#39;t need to keep tracking it as a virtual node and requeueing in attemptToDelete item.markObserved() return nil case err != nil: return err } //uidä¸åŒ¹é… if latest.GetUID() != item.identity.UID { klog.V(5).Infof(\u0026#34;UID doesn\u0026#39;t match, item %v not found, generating a virtual delete event\u0026#34;, item.identity) gc.dependencyGraphBuilder.enqueueVirtualDeleteEvent(item.identity) // since we\u0026#39;re manually inserting a delete event to remove this node, // we don\u0026#39;t need to keep tracking it as a virtual node and requeueing in attemptToDelete //å› ä¸ºæˆ‘ä»¬æ‰‹åŠ¨æ’å…¥åˆ é™¤äº‹ä»¶ä»¥åˆ é™¤æ­¤èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä¸éœ€è¦å°†å…¶ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹è·Ÿè¸ªå¹¶åœ¨attemptToDeleteä¸­é‡æ–°æ’é˜Ÿ item.markObserved() return nil } // TODO: attemptToOrphanWorker() routine is similar. Consider merging // attemptToOrphanWorker() into attemptToDeleteItem() as well. // itemçš„ä»èµ„æºæ­£åœ¨åˆ é™¤ä¸­,åŒæ—¶åˆ é™¤å…¶ä»èµ„æº if item.isDeletingDependents() { return gc.processDeletingDependentsItem(item) } // compute if we should delete the item // è·å–è¯¥objecté‡Œmetadata.ownerReference // è®¡ç®—æˆ‘ä»¬æ˜¯å¦åº”åˆ é™¤è¯¥é¡¹ç›® ownerReferences := latest.GetOwnerReferences() if len(ownerReferences) == 0 { //æ²¡æœ‰ownerçš„ä¸ç”¨å¤„ç† klog.V(2).Infof(\u0026#34;object %s\u0026#39;s doesn\u0026#39;t have an owner, continue on next item\u0026#34;, item.identity) return nil } //solid(ownerå­˜åœ¨,owneræ²¡è¢«åˆ æˆ–è€…ç»ˆç»“å™¨ä¸ä¸ºforegroundDeletion Finalizer); dangling(ownerä¸å­˜åœ¨) // waitingForDependentsDeletion(ownerå­˜åœ¨,ownerçš„deletionTimestampä¸ºénilï¼Œå¹¶ä¸”æœ‰foregroundDeletion Finalizer)owneråˆ—è¡¨ solid, dangling, waitingForDependentsDeletion, err := gc.classifyReferences(item, ownerReferences) if err != nil { return err } klog.V(5).Infof(\u0026#34;classify references of %s.\\nsolid: %#v\\ndangling: %#v\\nwaitingForDependentsDeletion: %#v\\n\u0026#34;, item.identity, solid, dangling, waitingForDependentsDeletion) switch { //itemå¯¹è±¡çš„ownerå­˜åœ¨,ä¸”ä¸æ˜¯æ­£åœ¨åˆ é™¤ case len(solid) != 0: klog.V(2).Infof(\u0026#34;object %#v has at least one existing owner: %#v, will not garbage collect\u0026#34;, solid, item.identity) if len(dangling) == 0 \u0026amp;\u0026amp; len(waitingForDependentsDeletion) == 0 { return nil } klog.V(2).Infof(\u0026#34;remove dangling references %#v and waiting references %#v for object %s\u0026#34;, dangling, waitingForDependentsDeletion, item.identity) // waitingForDependentsDeletion needs to be deleted from the // ownerReferences, otherwise the referenced objects will be stuck with // the FinalizerDeletingDependents and never get deleted. // waitingForDependentsDeletionéœ€è¦ä» ownerReferencesä¸­åˆ é™¤ï¼Œå¦åˆ™å¼•ç”¨çš„å¯¹è±¡å°†è¢« // FinalizerDeletingDependentsæ‰€å¡ä½ï¼Œå¹¶ä¸”æ°¸è¿œä¸ä¼šè¢«åˆ é™¤ã€‚ //éœ€è¦ç§»é™¤çš„ownerUids ownerUIDs := append(ownerRefsToUIDs(dangling), ownerRefsToUIDs(waitingForDependentsDeletion)...) //æ‹¼æ¥patchè¯·æ±‚å‚æ•° patch := deleteOwnerRefStrategicMergePatch(item.identity.UID, ownerUIDs...) //å‘é€patchè¯·æ±‚ _, err = gc.patch(item, patch, func(n *node) ([]byte, error) { return gc.deleteOwnerRefJSONMergePatch(n, ownerUIDs...) }) return err //itemå¯¹è±¡çš„owneræ­£åœ¨è¢«åˆ é™¤; ä¸”itemæœ‰ä»èµ„æº case len(waitingForDependentsDeletion) != 0 \u0026amp;\u0026amp; item.dependentsLength() != 0: deps := item.getDependents() // éå†itemä»èµ„æº for _, dep := range deps { if dep.isDeletingDependents() { // this circle detection has false positives, we need to // apply a more rigorous detection if this turns out to be a // problem. // there are multiple workers run attemptToDeleteItem in // parallel, the circle detection can fail in a race condition. klog.V(2).Infof(\u0026#34;processing object %s, some of its owners and its dependent [%s] have FinalizerDeletingDependents, to prevent potential cycle, its ownerReferences are going to be modified to be non-blocking, then the object is going to be deleted with Foreground\u0026#34;, item.identity, dep.identity) // ç”Ÿæˆä¸€ä¸ªè¡¥ä¸ï¼Œè¯¥è¡¥ä¸ä¼šå–æ¶ˆè®¾ç½®itemæ‰€æœ‰ownerReferencesçš„BlockOwnerDeletionå­—æ®µ,é¿å…é˜»å¡itemçš„owneråˆ é™¤ patch, err := item.unblockOwnerReferencesStrategicMergePatch() if err != nil { return err } //æ‰§è¡Œpatch if _, err := gc.patch(item, patch, gc.unblockOwnerReferencesJSONMergePatch); err != nil { return err } break } } //itemå¯¹è±¡çš„è‡³å°‘ä¸€ä¸ªownerå…·æœ‰foregroundDeletion Finalizerï¼Œå¹¶ä¸”è¯¥å¯¹è±¡æœ¬èº«å…·æœ‰ä¾èµ–é¡¹ï¼Œå› æ­¤å®ƒå°†åœ¨Foregroundä¸­åˆ é™¤ klog.V(2).Infof(\u0026#34;at least one owner of object %s has FinalizerDeletingDependents, and the object itself has dependents, so it is going to be deleted in Foreground\u0026#34;, item.identity) // the deletion event will be observed by the graphBuilder, so the item // will be processed again in processDeletingDependentsItem. If it // doesn\u0026#39;t have dependents, the function will remove the // FinalizerDeletingDependents from the item, resulting in the final // deletion of the item. // graphBuilderå°†è§‚å¯Ÿåˆ é™¤äº‹ä»¶ï¼Œå› æ­¤å°†åœ¨processDeletingDependentsItemä¸­å†æ¬¡å¤„ç†è¯¥é¡¹ç›®ã€‚ // å¦‚æœæ²¡æœ‰ä¾èµ–é¡¹ï¼Œè¯¥å‡½æ•°å°†ä»é¡¹ä¸­åˆ é™¤foregroundDeletion Finalizerï¼Œæœ€ç»ˆåˆ é™¤itemã€‚ policy := metav1.DeletePropagationForeground return gc.deleteObject(item.identity, \u0026amp;policy) default: // item doesn\u0026#39;t have any solid owner, so it needs to be garbage // collected. Also, none of item\u0026#39;s owners is waiting for the deletion of // the dependents, so set propagationPolicy based on existing finalizers. // itemæ²¡æœ‰ä»»ä½•å®ä½“æ‰€æœ‰è€…ï¼Œå› æ­¤éœ€è¦æ”¶é›†åƒåœ¾ ã€‚æ­¤å¤–ï¼Œé¡¹ç›®çš„æ‰€æœ‰è€…éƒ½æ²¡æœ‰ç­‰å¾…åˆ é™¤ // ä¾èµ–é¡¹ï¼Œå› æ­¤è¯·æ ¹æ®ç°æœ‰çš„ç»ˆç»“å™¨è®¾ç½®propagationPolicyã€‚ var policy metav1.DeletionPropagation switch { case hasOrphanFinalizer(latest): // if an existing orphan finalizer is already on the object, honor it. //å¦‚æœç°æœ‰çš„å­¤å„¿ç»ˆç»“å™¨å·²ç»åœ¨å¯¹è±¡ä¸Šï¼Œè¯·å°Šé‡å®ƒã€‚ policy = metav1.DeletePropagationOrphan case hasDeleteDependentsFinalizer(latest): // if an existing foreground finalizer is already on the object, honor it. //å¦‚æœç°æœ‰çš„å‰æ™¯ç»ˆç»“å™¨å·²ç»åœ¨å¯¹è±¡ä¸Šï¼Œè¯·å°Šé‡å®ƒã€‚ policy = metav1.DeletePropagationForeground default: // otherwise, default to background. //å¦åˆ™ï¼Œé»˜è®¤ä¸ºèƒŒæ™¯ã€‚ policy = metav1.DeletePropagationBackground } klog.V(2).Infof(\u0026#34;delete object %s with propagation policy %s\u0026#34;, item.identity, policy) //åˆ é™¤å­¤å„¿å¯¹è±¡ return gc.deleteObject(item.identity, \u0026amp;policy) } } ä¸»è¦åšä»¥ä¸‹äº‹æƒ…ï¼š\n1ã€itemåœ¨åˆ é™¤ä¸­ï¼Œä¸”ä¸ºOrphanå’ŒBackgroundæ–¹å¼åˆ é™¤åˆ™ç›´æ¥è¿”å›ï¼›\n2ã€itemæ˜¯foregroundæ–¹å¼åˆ é™¤æ—¶ï¼Œè°ƒç”¨processDeletingDependentsItemå»å¤„ç†é˜»å¡å…¶åˆ é™¤çš„ä»èµ„æºï¼Œå°†å…¶æ”¾åˆ°attemptToDeleteé˜Ÿåˆ—ï¼›\n3ã€è·å–itemçš„ownerå¯¹è±¡é›†ï¼Œè°ƒç”¨classifyReferenceså°†owneré›†åˆåˆ†ä¸º3ç±»ï¼Œåˆ†åˆ«ä¸ºsolidï¼ˆownerå­˜åœ¨æˆ–è€…ç»ˆç»“å™¨ä¸ä¸ºforegroundDeletionçš„owneré›†åˆï¼‰, danglingï¼ˆå·²ç»ä¸å­˜åœ¨äº†çš„owneré›†ç¾¤ï¼‰, waitingForDependentsDeletionï¼ˆownerçš„deletionTimestampä¸ºénilï¼Œå¹¶ä¸”ä¸ºforegroundDeletionç»ˆç»“å™¨çš„owneré›†åˆï¼‰\n4ã€switchç¬¬ä¸€ä¸ªcaseï¼šsolidé›†åˆä¸ä¸ºç©ºï¼Œå³itemå­˜åœ¨æ²¡è¢«åˆ é™¤çš„ownerã€‚å½“danglingå’ŒwaitingForDependentsDeletionéƒ½ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼›å½“danglingæˆ–waitingForDependentsDeletionä¸ä¸ºç©ºï¼Œåˆå¹¶ä¸¤ä¸ªé›†åˆuidï¼Œæ‰§è¡Œpatchè¯·æ±‚ï¼Œå°†è¿™äº›uidå¯¹åº”çš„ownerReferencesä»itemä¸­åˆ é™¤\n5ã€switchç¬¬äºŒä¸ªcaseï¼šwaitingForDependentsDeletioné›†åˆä¸ä¸ºç©ºï¼Œä¸”itemæœ‰ä»èµ„æºã€‚å³itemçš„ownerä¸å­˜åœ¨ï¼Œæˆ–æ­£åœ¨è¢«foregroundDeletionæ–¹å¼åˆ é™¤ï¼Œå¦‚æœitemçš„ä»èµ„æºæ­£åœ¨åˆ é™¤ä¾èµ–é¡¹ï¼Œåˆ™å–æ¶ˆé˜»æ­¢itemçš„owneråˆ é™¤ï¼Œç»™itemæ‰§è¡Œpatchè¯·æ±‚ï¼Œæœ€ç»ˆé‡‡ç”¨foregroundDeletionæ–¹å¼åˆ é™¤itemï¼›\n6ã€switchç¬¬ä¸‰ä¸ªcaseï¼šä»¥ä¸Šæ¡ä»¶ä¸ç¬¦åˆæ—¶ï¼Œåˆ™ç›´æ¥æ ¹æ®itemä¸­çš„ç»ˆç»“å™¨åˆ é™¤itemï¼Œé»˜è®¤ä¸ºBackgroundæ–¹å¼åˆ é™¤ã€‚\nå¾€ç»†äº†è¯´ï¼ŒprocessDeletingDependentsItemæ–¹æ³•è·å–itemä»èµ„æºä¸­BlockOwnerDeletionä¸ºtrueçš„ownerReferencesé›†åˆï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ç§»é™¤itemçš„foregroundDeletionç»ˆç»“å™¨ã€‚å¦åˆ™éå†ï¼Œå°†æœªå¼€å§‹åˆ é™¤çš„ä¾èµ–é¡¹çš„ä»èµ„æºdepåŠ å…¥åˆ°å°è¯•åˆ é™¤é˜Ÿåˆ—attemptToDeleteã€‚\n//ç­‰å¾…å…¶ä¾èµ–é¡¹è¢«åˆ é™¤çš„è¿›ç¨‹é¡¹ func (gc *GarbageCollector) processDeletingDependentsItem(item *node) error { //é˜»å¡itemèµ„æºåˆ é™¤çš„ä»èµ„æºåˆ—è¡¨ blockingDependents := item.blockingDependents() //æ²¡æœ‰é˜»å¡itemèµ„æºåˆ é™¤çš„ä»èµ„æº,åˆ™ç§»é™¤itemèµ„æºçš„foregroundDeletionç»ˆç»“å™¨ if len(blockingDependents) == 0 { klog.V(2).Infof(\u0026#34;remove DeleteDependents finalizer for item %s\u0026#34;, item.identity) return gc.removeFinalizer(item, metav1.FinalizerDeleteDependents) } //éå†é˜»å¡itemèµ„æºåˆ é™¤çš„ä»èµ„æº for _, dep := range blockingDependents { // å¦‚æœdepçš„ä»èµ„æºæ²¡æœ‰å¼€å§‹åˆ é™¤,åˆ™å°†depåŠ å…¥åˆ°å°è¯•åˆ é™¤é˜Ÿåˆ—ä¸­ if !dep.isDeletingDependents() { klog.V(2).Infof(\u0026#34;adding %s to attemptToDelete, because its owner %s is deletingDependents\u0026#34;, dep.identity, item.identity) //å°†ä»èµ„æºåŠ å…¥åˆ é™¤é˜Ÿåˆ— gc.attemptToDelete.Add(dep) } } return nil } gc.classifyReferences(item, ownerReferences)æ–¹æ³•ï¼šéå†äº†itemçš„owneråˆ—è¡¨ï¼Œè°ƒç”¨isDanglingæ–¹æ³•å°†å·²ä¸å­˜åœ¨çš„owneråŠ å…¥åˆ°isDanglingåˆ—è¡¨ï¼›owneræ­£åœ¨è¢«åˆ é™¤,ä¸”owneræœ‰foregroundDeletionç»ˆç»“å™¨çš„åŠ å…¥åˆ°waitingForDependentsDeletionåˆ—è¡¨ï¼›owneræ²¡å¼€å§‹åˆ æˆ–è€…ç»ˆç»“å™¨ä¸ä¸ºforegroundDeletionçš„åŠ å…¥åˆ°solidåˆ—è¡¨ã€‚\n// å°†latestReferencesåˆ†ä¸ºä¸‰ç±»ï¼š // solidï¼šæ‰€æœ‰è€…å­˜åœ¨ï¼Œä¸”ä¸æ˜¯waitingForDependentsDeletion // danglingæ‚¬ç©ºï¼šæ‰€æœ‰è€…ä¸å­˜åœ¨ // waitingForDependentsDeletion: æ‰€æœ‰è€…å­˜åœ¨ï¼Œå…¶deletionTimestampä¸ºénilï¼Œå¹¶ä¸”æœ‰FinalizerDeletingDependents func (gc *GarbageCollector) classifyReferences(item *node, latestReferences []metav1.OwnerReference) ( solid, dangling, waitingForDependentsDeletion []metav1.OwnerReference, err error) { //éå†è¯¥nodeçš„owner for _, reference := range latestReferences { //è·å–owneræ˜¯å¦å­˜åœ¨;isDanglingä¸ºtrueè¡¨ç¤ºä¸å­˜åœ¨,å‘ç”Ÿerråˆ™æœ€ç»ˆå°†è¯¥itemåŠ å…¥AddRateLimited attemptToDeleteé˜Ÿåˆ— isDangling, owner, err := gc.isDangling(reference, item) if err != nil { return nil, nil, nil, err } //å°†ä¸å­˜åœ¨çš„owneråŠ å…¥danglingåˆ‡ç‰‡ if isDangling { dangling = append(dangling, reference) continue } //ownerå­˜åœ¨,è·å–accessor ownerAccessor, err := meta.Accessor(owner) if err != nil { return nil, nil, nil, err } //owneræ­£åœ¨è¢«åˆ é™¤,ä¸”owneræœ‰foregroundDeletion Finalizer if ownerAccessor.GetDeletionTimestamp() != nil \u0026amp;\u0026amp; hasDeleteDependentsFinalizer(ownerAccessor) { //ownerå°†ç­‰å¾…ä¾èµ–åˆ é™¤;æ”¶é›†ç­‰å¾…åˆ é™¤ä¾èµ–çš„owneråˆ—è¡¨ waitingForDependentsDeletion = append(waitingForDependentsDeletion, reference) } else { //owneræ²¡è¢«åˆ æˆ–è€…ç»ˆç»“å™¨ä¸ä¸ºforegroundDeletion Finalizer solid = append(solid, reference) } } return solid, dangling, waitingForDependentsDeletion, nil } gc.isDangling(reference, item)æ–¹æ³•ï¼šå…ˆä»absentOwnerCacheç¼“å­˜ä¸­æ ¹æ®owner uidè·å–owneræ˜¯å¦å­˜åœ¨ï¼›å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ™æ ¹æ®ownerReferencesä¸­çš„å‚æ•°ï¼Œæ„å»ºå‚æ•°ï¼Œè°ƒç”¨apiserveræ¥å£è·å–ownerå¯¹è±¡æ˜¯å¦èƒ½æŸ¥åˆ°ã€‚æŸ¥åˆ°å¦‚æœuidä¸åŒ¹é…ï¼ŒåŠ å…¥absentOwnerCacheç¼“å­˜ï¼Œå¹¶è¿”å›falseã€‚\n// isDanglingæ£€æŸ¥å¼•ç”¨æ˜¯å¦æŒ‡å‘ä¸å­˜åœ¨çš„å¯¹è±¡ã€‚ å¦‚æœisDanglingåœ¨APIæœåŠ¡å™¨ä¸ŠæŸ¥æ‰¾å¼•ç”¨çš„å¯¹è±¡ï¼Œå®ƒä¹Ÿè¿”å›å…¶æœ€æ–°çŠ¶æ€ã€‚ func (gc *GarbageCollector) isDangling(reference metav1.OwnerReference, item *node) ( dangling bool, owner *unstructured.Unstructured, err error) { if gc.absentOwnerCache.Has(reference.UID) { klog.V(5).Infof(\u0026#34;according to the absentOwnerCache, object %s\u0026#39;s owner %s/%s, %s does not exist\u0026#34;, item.identity.UID, reference.APIVersion, reference.Kind, reference.Name) return true, nil, nil } // TODO: we need to verify the reference resource is supported by the // system. If it\u0026#39;s not a valid resource, the garbage collector should i) // ignore the reference when decide if the object should be deleted, and // ii) should update the object to remove such references. This is to // prevent objects having references to an old resource from being // deleted during a cluster upgrade. resource, namespaced, err := gc.apiResource(reference.APIVersion, reference.Kind) if err != nil { return false, nil, err } // TODO: It\u0026#39;s only necessary to talk to the API server if the owner node // is a \u0026#34;virtual\u0026#34; node. The local graph could lag behind the real // status, but in practice, the difference is small. owner, err = gc.dynamicClient.Resource(resource).Namespace(resourceDefaultNamespace(namespaced, item.identity.Namespace)).Get(reference.Name, metav1.GetOptions{}) switch { case errors.IsNotFound(err): gc.absentOwnerCache.Add(reference.UID) klog.V(5).Infof(\u0026#34;object %s\u0026#39;s owner %s/%s, %s is not found\u0026#34;, item.identity.UID, reference.APIVersion, reference.Kind, reference.Name) return true, nil, nil case err != nil: return false, nil, err } if owner.GetUID() != reference.UID { klog.V(5).Infof(\u0026#34;object %s\u0026#39;s owner %s/%s, %s is not found, UID mismatch\u0026#34;, item.identity.UID, reference.APIVersion, reference.Kind, reference.Name) gc.absentOwnerCache.Add(reference.UID) return true, nil, nil } return false, owner, nil } attemptToOrphané˜Ÿåˆ— # æ¥åˆ°ä»£ç ï¼š\nfunc (gc *GarbageCollector) runAttemptToOrphanWorker() { for gc.attemptToOrphanWorker() { } } æ­»å¾ªç¯ä¸€ç›´ä»attemptToOrphané˜Ÿåˆ—ä¸­è·å–itemèµ„æºï¼Œè°ƒç”¨gc.orphanDependents(owner.identity, dependents)æ–¹æ³•ï¼Œä»itemä»èµ„æºä¸­åˆ æ‰è¯¥itemçš„ownerReferencesï¼ŒæœŸé—´å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåˆ™é€šè¿‡rateLimitedé‡æ–°åŠ å›attemptToOrphané˜Ÿåˆ—ã€‚æœ€åç§»é™¤itemä¸­çš„orphanç»ˆç»“å™¨ã€‚\n// attemptToOrphanWorkerå°†ä¸€ä¸ªèŠ‚ç‚¹ä»attemptToOrphanä¸­å–å‡ºï¼Œç„¶åæ ¹æ®GCç»´æŠ¤çš„å›¾æ‰¾åˆ°å®ƒçš„ä¾èµ–é¡¹ï¼Œç„¶åå°†å…¶ä»å…¶ä¾èµ–é¡¹çš„ // OwnerReferencesä¸­åˆ é™¤ï¼Œæœ€åæ›´æ–°itemä»¥åˆ é™¤å­¤å„¿ç»ˆç»“å™¨ã€‚å¦‚æœè¿™äº›æ­¥éª¤ä¸­çš„ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œåˆ™å°†èŠ‚ç‚¹æ·»åŠ å›attemptToOrphanã€‚ func (gc *GarbageCollector) attemptToOrphanWorker() bool { item, quit := gc.attemptToOrphan.Get() gc.workerLock.RLock() defer gc.workerLock.RUnlock() if quit { return false } defer gc.attemptToOrphan.Done(item) owner, ok := item.(*node) if !ok { utilruntime.HandleError(fmt.Errorf(\u0026#34;expect *node, got %#v\u0026#34;, item)) return true } // we don\u0026#39;t need to lock each element, because they never get updated owner.dependentsLock.RLock() dependents := make([]*node, 0, len(owner.dependents)) for dependent := range owner.dependents { dependents = append(dependents, dependent) } owner.dependentsLock.RUnlock() // å¤„ç†å­¤å„¿ err := gc.orphanDependents(owner.identity, dependents) if err != nil { utilruntime.HandleError(fmt.Errorf(\u0026#34;orphanDependents for %s failed with %v\u0026#34;, owner.identity, err)) gc.attemptToOrphan.AddRateLimited(item) return true } // update the owner, remove \u0026#34;orphaningFinalizer\u0026#34; from its finalizers list // ç§»é™¤itemçš„orphanç»ˆç»“å™¨ err = gc.removeFinalizer(owner, metav1.FinalizerOrphanDependents) if err != nil { utilruntime.HandleError(fmt.Errorf(\u0026#34;removeOrphanFinalizer for %s failed with %v\u0026#34;, owner.identity, err)) gc.attemptToOrphan.AddRateLimited(item) } return true } gc.orphanDependents(owner.identity, dependents)æ–¹æ³•ï¼šéå†itemçš„ä»èµ„æºï¼Œå¹¶å‘çš„æ‰§è¡Œpatchè¯·æ±‚ï¼Œåˆ é™¤ä»èµ„æºä¸­å’ŒitemåŒuidçš„ownerReferencesï¼Œå°†erroråŠ å…¥åˆ°errCh channelä¸­ï¼Œæœ€åç»™è°ƒç”¨è€…è¿”å›erroråˆ—è¡¨ï¼š\n// dependents are copies of pointers to the owner\u0026#39;s dependents, they don\u0026#39;t need to be locked. func (gc *GarbageCollector) orphanDependents(owner objectReference, dependents []*node) error { errCh := make(chan error, len(dependents)) wg := sync.WaitGroup{} wg.Add(len(dependents)) for i := range dependents { go func(dependent *node) { defer wg.Done() // the dependent.identity.UID is used as precondition patch := deleteOwnerRefStrategicMergePatch(dependent.identity.UID, owner.UID) _, err := gc.patch(dependent, patch, func(n *node) ([]byte, error) { return gc.deleteOwnerRefJSONMergePatch(n, owner.UID) }) // note that if the target ownerReference doesn\u0026#39;t exist in the // dependent, strategic merge patch will NOT return an error. if err != nil \u0026amp;\u0026amp; !errors.IsNotFound(err) { errCh \u0026lt;- fmt.Errorf(\u0026#34;orphaning %s failed, %v\u0026#34;, dependent.identity, err) } }(dependents[i]) } wg.Wait() close(errCh) var errorsSlice []error for e := range errCh { errorsSlice = append(errorsSlice, e) } if len(errorsSlice) != 0 { return fmt.Errorf(\u0026#34;failed to orphan dependents of owner %s, got errors: %s\u0026#34;, owner, utilerrors.NewAggregate(errorsSlice).Error()) } klog.V(5).Infof(\u0026#34;successfully updated all dependents of owner %s\u0026#34;, owner) return nil } deleteOwnerRefStrategicMergePatchæ–¹æ³•ï¼šæ‹¼æ¥patchè¯·æ±‚å‚æ•°ã€‚è¯¥æ–¹æ³•åŒæ ·çš„ï¼Œåœ¨å¤„ç†attemptToDeleteæ­»å¾ªä¸­ï¼Œç¬¬ä¸€ä¸ªswitch caseå¤„è¢«è°ƒç”¨ã€‚\nfunc deleteOwnerRefStrategicMergePatch(dependentUID types.UID, ownerUIDs ...types.UID) []byte { var pieces []string //æ‹¼æ¥éœ€è¦åˆ é™¤çš„uid for _, ownerUID := range ownerUIDs { pieces = append(pieces, fmt.Sprintf(`{\u0026#34;$patch\u0026#34;:\u0026#34;delete\u0026#34;,\u0026#34;uid\u0026#34;:\u0026#34;%s\u0026#34;}`, ownerUID)) } //æ‹¼æ¥patchè¯·æ±‚å‚æ•° patch := fmt.Sprintf(`{\u0026#34;metadata\u0026#34;:{\u0026#34;ownerReferences\u0026#34;:[%s],\u0026#34;uid\u0026#34;:\u0026#34;%s\u0026#34;}}`, strings.Join(pieces, \u0026#34;,\u0026#34;), dependentUID) return []byte(patch) } å›åˆ°åˆè¡· # ä¸­é—´ä»¶rediså®¹å™¨åŒ–åï¼Œåœ¨æµ‹è¯•ç¯å¢ƒä¸Šéƒ¨ç½²çš„redisé›†ç¾¤ï¼Œåœ¨kubernetes apiserveré‡å¯åï¼Œredisé›†ç¾¤è¢«å¼‚å¸¸åˆ é™¤ï¼ˆåŒ…æ‹¬redis exporter statefulsetã€redis statefulsetï¼‰ã€‚\nåŸå› å®šä½ # åœ¨å¼€å‘ç¯å¢ƒä¸Šç»å¤šæ¬¡å¤ç°ï¼Œapiserveré‡å¯åï¼Œé€šè¿‡æŸ¥è¯¢redis operatoræ—¥å¿—ï¼Œå¹¶æ²¡æœ‰å‘ç°ä¸»åŠ¨å»åˆ é™¤redisé›†ç¾¤ï¼ˆredis statefulsetï¼‰ã€ç›‘æ§å®ä¾‹ï¼ˆredis exporterï¼‰ã€‚è¿›ä¸€æ­¥å»æŸ¥çœ‹kube-controller-managerçš„æ—¥å¿—ï¼Œå°†å…¶æ—¥å¿—çº§åˆ«è®¾ç½®\u0026ndash;v=5ï¼Œç»§ç»­å¤ç°ï¼Œæœ€ç»ˆåœ¨kube-controller-manageræ—¥å¿—ä¸­å‘ç°å¦‚ä¸‹æ—¥å¿—ï¼š\nå¯ä»¥çœ‹åˆ°ï¼Œåƒåœ¾å›æ”¶å™¨garbage collectoråœ¨å¤„ç†redis exporter statefulsetæ—¶ï¼Œå‘ç°å…¶åŠ äº†ownerReferencesï¼Œåœ¨exporteræ‰€åœ¨åˆ†åŒºï¼ˆmonitoringï¼‰æŸ¥è¯¢å…¶ownerâ€”â€”redisClusterå¯¹è±¡redis-0826ï¼Œè€ŒredisClusterå¯¹è±¡redis-0826å­˜åœ¨äºkube-systemåˆ†åŒºï¼Œæ‰€ä»¥åœ¨monitoringåˆ†åŒºæŸ¥è¯¢åˆ°çš„æ˜¯404 Not Foundï¼Œgarbage collectorä¼šå°†è¯¥ownerä¸å­˜åœ¨ä¿¡æ¯ï¼ˆuidï¼‰å­˜å…¥ç¼“å­˜absentOwnerCacheã€‚\nå› redis exporter statefulsetçš„ownerä¸å­˜åœ¨ï¼Œæ‰€ä»¥gcè®¤ä¸ºéœ€è¦å›æ”¶åƒåœ¾ï¼Œæ•…å°†å…¶åˆ é™¤æ‰ã€‚åŒç†ï¼Œå½“å¤„ç†redis statefulsetæ—¶ï¼Œä»ç¼“å­˜ä¸­å‘ç°ownerä¸å­˜åœ¨ï¼Œä¹Ÿä¼šå›æ”¶åƒåœ¾ï¼Œå°†å…¶åˆ é™¤æ‰ã€‚\nç»è¿‡å¤šæ¬¡å¤ç°æ•…éšœï¼Œå‘ç°é‡å¯kube-controller-manageræ—¶æœ‰æ¦‚ç‡å¤ç°ã€‚ï¼ˆApiserverçš„é‡å¯æ—¶ï¼Œkube-controller-manageråœ¨è¿æ¥apiserverå¤±è´¥å¤šæ¬¡åï¼Œä¹Ÿä¼šå‘ç”Ÿè‡ªé‡å¯ï¼‰ï¼Œä¹‹æ‰€ä»¥æ˜¯æ¦‚ç‡é—®é¢˜ï¼Œè¿™å’Œgarbage collectorå°†èµ„æºå¯¹è±¡åŠ å…¥attemptToDeleteé˜Ÿåˆ—çš„é¡ºåºæœ‰å…³ï¼š\nå…ˆåŒæ­¥monitoringåˆ†åŒºçš„exporter statefulsetï¼ŒååŒæ­¥kube-systemåˆ†åŒºçš„redis statefulsetï¼Œå°±ä¼šå‡ºç°è¯¥æ•…éšœï¼›åä¹‹å°±ä¸ä¼šå‡ºç°æ•…éšœï¼Œè¿™å–å†³äºgarbage collectorå¯åŠ¨æ—¶å…¨é‡è·å–é›†ç¾¤å†…èµ„æºï¼ˆlistwatchï¼‰çš„é¡ºåºã€‚\nåœ¨apiserverå’Œkube-controller-manageræ­£å¸¸è¿è¡Œæ—¶ä¸å‡ºç°è¯¥æ•…éšœï¼Œå¯ä»¥ä»garbage collectoræºç ä¸­çœ‹åˆ°ä»¥ä¸‹ä»£ç é€»è¾‘ï¼š\nGarbage collectorä¸­ç»´æŠ¤ä¸€ä¸ªçˆ¶å­å…³ç³»å›¾è¡¨ï¼Œcontroller-managerå¯åŠ¨æ—¶è¯¥å›¾é‡ŒèŠ‚ç‚¹æ˜¯ä¸å­˜åœ¨çš„ï¼Œä¼šèµ°ä¸Šå›¾switchçš„ç¬¬ä¸€ä¸ªcaseï¼Œä¹‹åå›¾å½¢æˆä¹‹åï¼Œä¼šèµ°ç¬¬äºŒä¸ªcaseã€‚ç¬¬äºŒä¸ªcaseé‡Œåªæœ‰åœ¨ownerå‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šè§¦å‘å°†èµ„æºå¯¹è±¡åŠ å…¥attemptToDeleteé˜Ÿåˆ—ï¼Œæ‰€ä»¥åœ¨å„ä¸ªç»„ä»¶æ­£å¸¸è¿è¡Œæ—¶æ²¡æœ‰å‡ºç°è¯¥æ•…éšœã€‚\nè·å–å›¾è¡¨çš„æ¥å£åœ°å€ï¼ŒIPå’Œç«¯å£éƒ½æ˜¯controller-managerçš„ï¼Œå¯ä»¥é‡å®šå‘åˆ°tmp.dotæ–‡ä»¶\ncurl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph curl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph?uid=11211212edsaddkqedmk12 ä¹‹åç”¨å¯è§†åŒ–å·¥å…·Graphvizè½¯ä»¶ï¼Œè¿›å…¥åˆ°binç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆsvgæ–‡ä»¶ï¼Œç”¨æµè§ˆå™¨æ‰“å¼€ï¼ŒGraphvizå’Œdotçš„ä½¿ç”¨å¯ä»¥è‡ªè¡Œè°·æ­Œã€‚\ndot -Tsvg -o graph2.svg tmp.dot è§£å†³æ–¹æ³• # åœ¨redis operatoråˆ›å»ºredisé›†ç¾¤æ—¶ï¼Œå°†exporteræ”¾åˆ°å’ŒredisåŒä¸€åˆ†åŒºã€‚\næ€è€ƒåæ€ # 1ã€å‡ºç°è¯¥æ•…éšœï¼Œä¸»è¦æ˜¯å› è¿›è¡Œäº†è·¨å‘½åç©ºé—´ownerå¼•ç”¨ã€‚åœ¨ä½¿ç”¨åƒåœ¾å›æ”¶æœºåˆ¶æ—¶ï¼Œåº”è¯¥å°½é‡å‚è€ƒkuberneteså®˜æ–¹ç½‘ç«™ä¸­çš„è¯´æ˜.\nå¦‚ä¸‹ï¼Œå®˜ç½‘ä¸­è¯´æ˜äº†ownerå¼•ç”¨åœ¨è®¾è®¡æ—¶å°±ä¸å…è®¸è·¨namespaceä½¿ç”¨ï¼Œè¿™æ„å‘³ç€ï¼š\n1ï¼‰å‘½åç©ºé—´èŒƒå›´çš„ä»å±åªèƒ½æŒ‡å®šåŒä¸€å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰è€…ï¼Œä»¥åŠç¾¤é›†èŒƒå›´çš„æ‰€æœ‰è€…ã€‚\n2ï¼‰ç¾¤é›†ä½œç”¨åŸŸçš„ä»å±åªèƒ½æŒ‡å®šç¾¤é›†ä½œç”¨åŸŸçš„æ‰€æœ‰è€…ï¼Œè€Œä¸èƒ½æŒ‡å®šå‘½åç©ºé—´ä½œç”¨åŸŸçš„æ‰€æœ‰è€…ã€‚\nå‚è€ƒæ–‡æ¡£ # åƒåœ¾å›æ”¶å®˜æ–¹æ–‡æ¡£ï¼š\nhttps://kubernetes.io/docs/concepts/workloads/controllers/garbage-collection/\nè¯¦è§£ Kubernetes åƒåœ¾æ”¶é›†å™¨çš„å®ç°åŸç†ï¼š\nhttps://draveness.me/kubernetes-garbage-collector#\næœ¬å…¬ä¼—å·å…è´¹**æä¾›csdnä¸‹è½½æœåŠ¡ï¼Œæµ·é‡ITå­¦ä¹ èµ„æºï¼Œ**å¦‚æœä½ å‡†å¤‡å…¥ITå‘ï¼ŒåŠ±å¿—æˆä¸ºä¼˜ç§€çš„ç¨‹åºçŒ¿ï¼Œé‚£ä¹ˆè¿™äº›èµ„æºå¾ˆé€‚åˆä½ ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºjavaã€goã€pythonã€springcloudã€elkã€åµŒå…¥å¼ ã€å¤§æ•°æ®ã€é¢è¯•èµ„æ–™ã€å‰ç«¯ ç­‰èµ„æºã€‚åŒæ—¶æˆ‘ä»¬ç»„å»ºäº†ä¸€ä¸ªæŠ€æœ¯äº¤æµç¾¤ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¤§ä½¬ï¼Œä¼šä¸å®šæ—¶åˆ†äº«æŠ€æœ¯æ–‡ç« ï¼Œå¦‚æœä½ æƒ³æ¥ä¸€èµ·å­¦ä¹ æé«˜ï¼Œå¯ä»¥å…¬ä¼—å·åå°å›å¤ã€2ã€‘ï¼Œå…è´¹é‚€è¯·åŠ æŠ€æœ¯äº¤æµç¾¤äº’ç›¸å­¦ä¹ æé«˜ï¼Œä¼šä¸å®šæœŸåˆ†äº«ç¼–ç¨‹ITç›¸å…³èµ„æºã€‚\næ‰«ç å…³æ³¨ï¼Œç²¾å½©å†…å®¹ç¬¬ä¸€æ—¶é—´æ¨ç»™ä½ \n","date":"2019å¹´10æœˆ21æ—¥","externalUrl":null,"permalink":"/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89/","section":"Posts","summary":"\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003ekubernetesç‰ˆæœ¬ï¼š1.13.2\u003c/strong\u003e\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eæ¥å‰ä¸¤èŠ‚ï¼š\u003cbr /\u003e\n\n\u003ca href=\"https://kubeinfo.cn/go/?target=aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvMTAwMDgxOTQx\" target=\"_blank\" \u003ekubernetesåƒåœ¾å›æ”¶å™¨GarbageCollector Controlleræºç åˆ†æï¼ˆä¸€ï¼‰\u003c/a\u003e\u003cbr /\u003e\n\n\u003ca href=\"https://kubeinfo.cn/go/?target=aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvMTAwNTQ5MjUx\" target=\"_blank\" \u003ekubernetesåƒåœ¾å›æ”¶å™¨GarbageCollector Controlleræºç åˆ†æï¼ˆäºŒï¼‰\u003c/a\u003e\u003c/p\u003e","title":"kubernetesåƒåœ¾å›æ”¶å™¨GarbageCollector æºç åˆ†æï¼ˆä¸‰ï¼‰","type":"posts"},{"content":" ä½œè€…ï¼šä¸¥æ™Ÿå˜‰\né“¾æ¥ï¼šhttps://www.zhihu.com/question/31377141/answer/103056861\n1. å‘ä½ çš„ Github Pages ä»“åº“æ·»åŠ ä¸€ä¸ªCNAME(ä¸€å®šè¦å¤§å†™)æ–‡ä»¶\nå…¶ä¸­åªèƒ½åŒ…å«ä¸€ä¸ªé¡¶çº§åŸŸåï¼Œåƒè¿™æ ·ï¼š\nexample.com å¦‚æœä½ æ˜¯ç”¨ hexo æ¡†æ¶æ­å»ºåšå®¢å¹¶éƒ¨ç½²åˆ° Github Pages ä¸Šï¼Œæ¯æ¬¡\n\u0026gt; hexo g \u0026gt; hexo d åä¼šæŠŠä½ çš„åšå®¢æ‰€åœ¨ç›®å½•ä¸‹ public æ–‡ä»¶å¤¹é‡Œçš„ä¸œè¥¿éƒ½æ¨åˆ° Github Pages ä»“åº“ä¸Šï¼Œå¹¶ä¸”æŠŠ CNAME æ–‡ä»¶è¦†ç›–æ‰ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜å¯ä»¥ç›´æ¥æŠŠ CNAME æ–‡ä»¶æ·»åŠ åˆ° source æ–‡ä»¶å¤¹é‡Œï¼Œè¿™æ ·æ¯æ¬¡æ¨çš„æ—¶å€™å°±ä¸ç”¨æ‹…å¿ƒä»“åº“é‡Œçš„ CNAME æ–‡ä»¶è¢«è¦†ç›–æ‰äº†ã€‚\n2. å‘ä½ çš„ DNS é…ç½®ä¸­æ·»åŠ  3 æ¡è®°å½•\n@ A 192.30.252.153 @ A 192.30.252.154 www CNAME username.github.io. ç”¨ä½ è‡ªå·±çš„ Github ç”¨æˆ·åæ›¿æ¢ username\né…ç½® DNS æ¨èä½¿ç”¨ DNSPOD çš„æœåŠ¡ï¼Œä½¿ç”¨å›½å¤–çš„ DNS è§£ææœåŠ¡å¯èƒ½æœ‰è¢«å¢™çš„é£é™©ã€‚\nè‡³äºå¦‚ä½•ä½¿ç”¨ DNSPOD è§£æåŸŸåï¼Œå‚è€ƒ\nhttp://jingyan.baidu.com/article/546ae1857c4ee81149f28cbe.htmlâ€‹jingyan.baidu.com\n3. ç­‰å¾…ä½ çš„ DNS é…ç½®ç”Ÿæ•ˆ\nå¯¹DNSçš„é…ç½®ä¸æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼Œè¿‡10åˆ†é’Ÿå†å»è®¿é—®ä½ çš„åŸŸåçœ‹çœ‹æœ‰æ²¡æœ‰é…ç½®æˆåŠŸ : )D\n4. å¯ç”¨ HTTPS\nè‡ª 2018 å¹´ 5 æœˆ 1 æ—¥ï¼ŒGithub æ”¯æŒè‡ªå®šä¹‰åŸŸåçš„ HTTPS è¯·æ±‚äº†ã€‚\nè¯¦æƒ…è§ï¼š\nhttps://blog.github.com/2018-05-01-github-pages-custom-domains-https/â€‹blog.github.com\né…ç½®ä¹Ÿç›¸å½“ç®€å•ï¼Œåªéœ€è¦æ›´æ–° DNS é…ç½®é‡Œçš„ A è®°å½•ï¼Œå°†å…¶æŒ‡å‘ä»¥ä¸‹4ä¸ª IP åœ°å€ä¸­çš„è‡³å°‘ä¸€ä¸ªã€‚\n185.199.108.153 185.199.109.153 185.199.110.153 185.199.111.153 HTTPS è®©ä½ çš„ç½‘ç«™å’Œç½‘ç«™è®¿å®¢æ›´å®‰å…¨ï¼Œå¹¶ä¸” Github æä¾›çš„è¿™äº› IP åœ°å€è‡ªåŠ¨å°†ä½ çš„ç«™ç‚¹åŠ å…¥äº† CDNï¼Œæé«˜äº†è®¿é—®é€Ÿåº¦ã€‚\nä½ è¿˜å¯ä»¥åœ¨ GiHub Pages ä»“åº“çš„è®¾ç½®é‡Œå‹¾é€‰ \u0026lsquo;Enforce HTTPS\u0026rsquo;ï¼Œè¿™æ ·æ‰€æœ‰è®¿é—®ä½ ç«™ç‚¹çš„è¯·æ±‚éƒ½ä¼šèµ° HTTPSã€‚\nä¸å¾—ä¸è¯´ï¼ŒGitHub æ˜¯çœŸçš„è‰¯å¿ƒã€‚\n","date":"2019å¹´10æœˆ20æ—¥","externalUrl":null,"permalink":"/posts/github%E6%80%8E%E4%B9%88%E7%BB%91%E5%AE%9A%E8%87%AA%E5%B7%B1%E7%9A%84%E5%9F%9F%E5%90%8D%E4%BB%A5%E5%8F%8A%E6%80%8E%E4%B9%88%E6%94%AF%E6%8C%81https/","section":"Posts","summary":"\u003cblockquote\u003e\n\u003cp\u003eä½œè€…ï¼šä¸¥æ™Ÿå˜‰\u003cbr /\u003e\né“¾æ¥ï¼šhttps://www.zhihu.com/question/31377141/answer/103056861\u003c/p\u003e","title":"githubæ€ä¹ˆç»‘å®šè‡ªå·±çš„åŸŸåï¼Ÿä»¥åŠæ€ä¹ˆæ”¯æŒhttpsï¼Ÿ","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/nginx/","section":"Tags","summary":"","title":"Nginx","type":"tags"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/openresty/","section":"Tags","summary":"","title":"Openresty","type":"tags"},{"content":" æ­£æ–‡ # æŠ¥é”™ï¼š # nginx: [error] CreateFile() \u0026ldquo;./logs/nginx.pid\u0026rdquo; failed (2: The system cannot find the file specified)\nåšä¸»åœ¨æ‰§è¡Œäº†nginx -s stopåï¼Œå†æ¬¡å¯åŠ¨nginxæ—¶æŠ¥é”™ï¼š\nè¿™ä¸ªå‘ä¸»è¦åŸå› å°±æ˜¯æ²¡æœ‰nginx.pidè¿™ä¸ªæ–‡ä»¶ï¼Œ./logs/ä¸‹æ‰¾ä¸åˆ°nginx.pidæ–‡ä»¶ï¼Œçœ‹äº†ç¡®å®æ‰¾ä¸åˆ°ã€‚\nçœ‹äº†ç½‘ä¸Šå¾ˆå¤šæ–¹æ¡ˆæ˜¯ éœ€è¦å»ºç«‹nginx.pidæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¦æŒ‡å®šnginx.confè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶ååšä¸»å¾ˆå‚»çš„è¿™æ ·æ‰§è¡Œäº†ä¸€æŠŠï¼š\nnginx -c conf/nginx.conf è¿˜æ˜¯ç›´æ¥è¯´æ­£è§£å§ ï¼šå¼€å¯ä½ çš„cmdï¼ˆå‘½ä»¤åˆ—ï¼‰ ç„¶åä½ éœ€è¦ä»¥ä½ nginx.exeæ‰€åœ¨è·¯å¾„çš„ç»å¯¹è·¯å¾„ï¼Œæ¯”å¦‚åšä¸»çš„è·¯å¾„åœ¨ D:\\Program Files\\openresty-1.13.6.2-win64\né‚£ä¹ˆå‘½ä»¤åˆ—å°±éœ€è¦è¿™æ ·å†™\n\u0026ldquo;d:\\Program Files\\openresty-1.13.6.2-win64\\nginx.exe\u0026rdquo; -c \u0026ldquo;d:\\Program Files\\openresty-1.13.6.2-win64\\conf\\nginx.conf\u0026rdquo;\nç”Ÿæˆäº†nginx.pidæ–‡ä»¶ï¼š\né‡Œé¢åªæœ‰ä¸€ä¸ªPIDå·ï¼š\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E5%AD%A6%E4%B9%A0openresty%E6%97%B6nginx%E7%9A%84%E4%B8%80%E4%B8%AA%E5%9D%91/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\n\u003ch4 class=\"relative group\"\u003eæŠ¥é”™ï¼š \n    \u003cdiv id=\"æŠ¥é”™\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%8a%a5%e9%94%99\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h4\u003e\n\u003cp\u003enginx: [error] CreateFile() \u0026ldquo;./logs/nginx.pid\u0026rdquo; failed (2: The system cannot find the file specified)\u003c/p\u003e","title":"å­¦ä¹ openrestyæ—¶ï¼Œnginxçš„ä¸€ä¸ªå‘","type":"posts"},{"content":" æ­£æ–‡ # mysqlæ•°æ®å¯¼å‡ºä¸ºexcelæ–‡ä»¶ï¼Œgolangå®ç°ï¼š\né¦–å…ˆä¸‹è½½ä¾èµ–åˆ°çš„ä¸‰æ–¹åº“ï¼š\nSimple install the package to your $GOPATH with the go tool from shell:\n$ go get -u github.com/go-sql-driver/mysql **å…·ä½“è¯´æ˜è¯·çœ‹ï¼š** [åº“åœ°å€](https://github.com/go-sql-driver/mysql) [wikiè¯´æ˜](https://github.com/go-sql-driver/mysql/wiki/Examples) ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼Œç”¨åˆ°äº†goçš„flagåŒ…çš„èƒ½åŠ›ï¼Œä¼ å…¥å‘½ä»¤è¡Œå‚æ•°ã€‚å…·ä½“çœ‹helpInfoï¼š\nUsage of mysqldataexport: -port int the port for mysql,default:32085 -addr string the address for mysql,default:10.146.145.67 -user string the username for login mysql,default:dbuser -pwd string the password for login mysql by the username,default:Admin@123 -db string the port for me to listen on,default:auditlogdb -tables string the tables will export data, multi tables separator by comma, default:op_log,sc_log,sys_log ä»£ç ï¼š\npackage main // ä»Mysqlä¸­å¯¼å‡ºæ•°æ®åˆ°CSVæ–‡ä»¶ã€‚ import ( \u0026#34;database/sql\u0026#34; \u0026#34;encoding/csv\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; _ \u0026#34;github.com/go-sql-driver/mysql\u0026#34; \u0026#34;flag\u0026#34; \u0026#34;strings\u0026#34; ) var ( tables = make([]string, 0) dataSourceName = \u0026#34;\u0026#34; ) const ( driverNameMysql = \u0026#34;mysql\u0026#34; helpInfo = `Usage of mysqldataexport: -port int the port for mysql,default:32085 -addr string the address for mysql,default:10.146.145.67 -user string the username for login mysql,default:dbuser -pwd string the password for login mysql by the username,default:Admin@123 -db string the port for me to listen on,default:auditlogdb -tables string the tables will export data, multi tables separator by comma, default:op_log,sc_log,sys_log ` ) func init() { port := flag.Int(\u0026#34;port\u0026#34;, 32085, \u0026#34;the port for mysql,default:32085\u0026#34;) addr := flag.String(\u0026#34;addr\u0026#34;, \u0026#34;10.146.145.67\u0026#34;, \u0026#34;the address for mysql,default:10.146.145.67\u0026#34;) user := flag.String(\u0026#34;user\u0026#34;, \u0026#34;dbuser\u0026#34;, \u0026#34;the username for login mysql,default:dbuser\u0026#34;) pwd := flag.String(\u0026#34;pwd\u0026#34;, \u0026#34;Admin@123\u0026#34;, \u0026#34;the password for login mysql by the username,default:Admin@123\u0026#34;) db := flag.String(\u0026#34;db\u0026#34;, \u0026#34;auditlogdb\u0026#34;, \u0026#34;the port for me to listen on,default:auditlogdb\u0026#34;) tabs := flag.String(\u0026#34;tables\u0026#34;, \u0026#34;op_log,sc_log,sys_log\u0026#34;, \u0026#34;the tables will export data, multi tables separator by comma, default:op_log,sc_log,sys_log\u0026#34;) flag.Usage = usage flag.Parse() tables = append(tables, strings.Split(*tabs, \u0026#34;,\u0026#34;)...) dataSourceName = fmt.Sprintf(\u0026#34;%s:%s@tcp(%s:%d)/%s?charset=utf8\u0026#34;, *user, *pwd, *addr, *port, *db) } func main() { count := len(tables) ch := make(chan bool, count) db, err := sql.Open(driverNameMysql, dataSourceName) defer db.Close() if err != nil { panic(err.Error()) } // Open doesn\u0026#39;t open a connection. Validate DSN data: err = db.Ping() if err != nil { panic(err.Error()) } for _, table := range tables { go querySQL(db, table, ch) } for i := 0; i \u0026lt; count; i++ { \u0026lt;-ch } fmt.Println(\u0026#34;Done!\u0026#34;) } func querySQL(db *sql.DB, table string, ch chan bool) { fmt.Println(\u0026#34;å¼€å§‹å¤„ç†ï¼š\u0026#34;, table) rows, err := db.Query(fmt.Sprintf(\u0026#34;SELECT * from %s\u0026#34;, table)) if err != nil { panic(err) } columns, err := rows.Columns() if err != nil { panic(err.Error()) } //valuesï¼šä¸€è¡Œçš„æ‰€æœ‰å€¼,æŠŠæ¯ä¸€è¡Œçš„å„ä¸ªå­—æ®µæ”¾åˆ°valuesä¸­ï¼Œvaluesé•¿åº¦==åˆ—æ•° values := make([]sql.RawBytes, len(columns)) // print(len(values)) scanArgs := make([]interface{}, len(values)) for i := range values { scanArgs[i] = \u0026amp;values[i] } //å­˜æ‰€æœ‰è¡Œçš„å†…å®¹totalValues totalValues := make([][]string, 0) for rows.Next() { //å­˜æ¯ä¸€è¡Œçš„å†…å®¹ var s []string //æŠŠæ¯è¡Œçš„å†…å®¹æ·»åŠ åˆ°scanArgsï¼Œä¹Ÿæ·»åŠ åˆ°äº†values err = rows.Scan(scanArgs...) if err != nil { panic(err.Error()) } for _, v := range values { s = append(s, string(v)) // print(len(s)) } totalValues = append(totalValues, s) } if err = rows.Err(); err != nil { panic(err.Error()) } writeToCSV(table+\u0026#34;.csv\u0026#34;, columns, totalValues) ch \u0026lt;- true } //writeToCSV func writeToCSV(file string, columns []string, totalValues [][]string) { f, err := os.Create(file) // fmt.Println(columns) defer f.Close() if err != nil { panic(err) } //f.WriteString(\u0026#34;\\xEF\\xBB\\xBF\u0026#34;) w := csv.NewWriter(f) for i, row := range totalValues { //ç¬¬ä¸€æ¬¡å†™åˆ—å+ç¬¬ä¸€è¡Œæ•°æ® if i == 0 { w.Write(columns) w.Write(row) } else { w.Write(row) } } w.Flush() fmt.Println(\u0026#34;å¤„ç†å®Œæ¯•ï¼š\u0026#34;, file) } func usage() { fmt.Fprint(os.Stderr, helpInfo) flag.PrintDefaults() } æ“ä½œç¤ºä¾‹ï¼š\nç¼–è¯‘ä»£ç ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼š\ngo build mysqldataexport.go æ•°æ®åº“ä¸­æœ‰test2åº“ä¸‹çš„testè¡¨ï¼š\nå¯¼å‡ºå…¶ä¸­çš„æ•°æ®ï¼š\n.\\mysqldataexport.exe -port=3306 -addr=\u0026#34;localhost\u0026#34; -user=\u0026#34;root\u0026#34; -pwd=\u0026#34;mysql\u0026#34; -db=\u0026#34;test2\u0026#34; -tables=\u0026#34;test\u0026#34; å¯¼å‡ºç»“æœå¦‚ä¸‹ï¼š\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/mysql%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BAgolang%E5%AE%9E%E7%8E%B0/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003emysqlæ•°æ®å¯¼å‡ºä¸ºexcelæ–‡ä»¶ï¼Œgolangå®ç°ï¼š\u003c/p\u003e","title":"mysqlæ•°æ®å¯¼å‡ºgolangå®ç°","type":"posts"},{"content":"kubernetesè‡ªå®šä¹‰èµ„æºå¯¹è±¡å†æå¤§ç¨‹åº¦æé«˜äº†API Serverçš„å¯æ‰©å±•æ€§ï¼Œè®©ä¼ä¸šèƒ½å¤Ÿæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€šè¿‡CRDç¼–å†™controlleræˆ–è€…operatoræ¥å®ç°ç”Ÿäº§ä¸­å„ç§ç‰¹æ®Šåœºæ™¯ã€‚éšç€k8sçš„ç‰ˆæœ¬å‡çº§ï¼ŒCRDçš„åŠŸèƒ½ä¹Ÿè¶Šæ¥è¶Šå®Œå–„ï¼Œä¸‹é¢å¯¹å…¶ä¸­å‡ ç‚¹è¿›è¡Œè¯´æ˜ã€‚\nä»¥ä¸‹éªŒè¯kubernetesç‰ˆæœ¬ä¸º1.13.2ï¼Œdockerç‰ˆæœ¬ï¼š18.09.5\nValidationï¼ˆéªŒè¯ï¼‰ # åœ¨é¡¹ç›®ä¸­ç”¨è‡ªå®šä¹‰èµ„æºå¯¹è±¡æ—¶ï¼Œå¦‚æœåˆ›å»ºè‡ªå®šä¹‰èµ„æºæ—¶æŸäº›å­—æ®µä¸ç¬¦åˆè¦æ±‚ï¼Œä¼šå¯¼è‡´ç›‘å¬è¯¥èµ„æºå¯¹è±¡çš„controlleræˆ–è€…operatorå‡ºç°å¼‚å¸¸ï¼Œè§£æç»“æ„ä½“æŠ¥é”™ï¼Œæ‰€ä»¥Validationè¿™ä¸ªåŠŸèƒ½éå¸¸å®ç”¨ï¼Œåœ¨åˆ›å»ºæ—¶å°±è¿›è¡Œæ ¡éªŒï¼Œå‡å°‘åé¢çš„æ’é”™å’Œå¼‚å¸¸å¤„ç†çš„éº»çƒ¦ã€‚\nå¯ä»¥é€šè¿‡ OpenAPI v3 schemaéªŒè¯è‡ªå®šä¹‰å¯¹è±¡æ˜¯å¦ç¬¦åˆæ ‡å‡† ã€‚æ­¤å¤–ï¼Œä»¥ä¸‹é™åˆ¶é€‚ç”¨äº schemaï¼š\nå­—æ®µdefaultã€nullableã€discriminatorã€readOnlyã€writeOnlyã€xmlã€ deprecated å’Œ $ref ä¸èƒ½è®¾ç½®ã€‚ è¯¥å­—æ®µ uniqueItems ä¸èƒ½è®¾ç½®ä¸º trueã€‚ è¯¥å­—æ®µ additionalProperties ä¸èƒ½è®¾ç½®ä¸º falseã€‚ å¯ä»¥ä½¿ç”¨ kube-apiserverCustomResourceValidation ä¸Šçš„åŠŸèƒ½é—¨ï¼ˆfeature gateï¼‰ç¦ç”¨æ­¤åŠŸèƒ½ï¼š\n--feature-gates=CustomResourceValidation=false ä»ä»¥ä¸‹ç‰¹æ€§é—¨å‚æ•°è¯´æ˜åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°ValidationåŠŸèƒ½åœ¨k8s 1.8ç‰ˆæœ¬å°±å·²ç»æœ‰äº†ï¼Œä½†æ˜¯CustomResourceValidationç‰¹æ€§é—¨æ˜¯é»˜è®¤falseï¼Œ1.9Betaä¹‹åç‰ˆæœ¬é»˜è®¤ä¸ºtrue\nhttps://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/\nä»¥ä¸‹ç¤ºä¾‹å°†å¤§æ¦‚å¯¹è¯¥åŠŸèƒ½è¿›è¡Œåº”ç”¨å’Œè¯´æ˜ï¼Œåœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼ŒCustomResourceDefinition å¯¹è‡ªå®šä¹‰å¯¹è±¡åº”ç”¨ä»¥ä¸‹éªŒè¯ï¼š\nspec.replicas ä¸ºå¿…å¡«é¡¹ï¼Œç±»å‹ä¸ºintegerï¼Œå€¼ä¸ºå¤§äºç­‰äº0å°äº50çš„å¶æ•°ï¼ˆ2çš„å€æ•°ï¼‰ï¼› spec.repository ä¸ºå¿…å¡«é¡¹ï¼› spec.versionä¸ºå¿…å¡«é¡¹ï¼› spec.pauseä¸ºbooleanç±»å‹ï¼› spec.updateStrategyä¸ºobjectç±»å‹ï¼Œè¯¥objectä¸­æœ‰typeã€pipelineã€assignStrategieså±æ€§ï¼› spec.updateStrategy.typeä¸ºstringç±»å‹ï¼Œè€Œä¸”åªèƒ½ä¸º\u0026quot;AssignReceive\u0026quot;, \u0026ldquo;AutoReceive\u0026quot;ä¸¤ä¸ªæšä¸¾å€¼ï¼› spec.updateStrategy.pipelineä¸ºstringç±»å‹ï¼Œè€Œä¸”ä¸ºæ­£æ•´æ•°çš„å­—ç¬¦ä¸²ï¼Œç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼^([1-9][0-9]*){1,3}$; spec.updateStrategy.assignStrategiesä¸ºarrayç±»å‹ï¼Œå…¶å…ƒç´ ä¸ºobjectç±»å‹ï¼ˆåŒ…å«slotså’ŒfromReplicaså±æ€§ï¼‰ï¼› spec.updateStrategy.assignStrategies.slotsä¸º1-16384çš„æ­£æ•´æ•°ï¼› spec.updateStrategy.assignStrategies.fromReplicasä¸ºå­—ç¬¦ä¸²ï¼Œç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼^[a-z0-9,]{3,}$ï¼Œå³è‡³å°‘åŒ¹é…3ä½a-zæˆ–è€…0-9æˆ–è€…é€—å·çš„å­—ç¬¦ä¸²ï¼› spec.podä¸ºarrayç±»å‹ï¼Œå…¶å…ƒç´ ä¸ºobjectç±»å‹ï¼ˆåŒ…å«configmapã€monitorImageã€initImageã€middlewareImageå­—æ®µï¼‰ï¼› spec.pod.configmapã€spec.pod.monitorImageã€spec.pod.initImage ã€spec.pod.middlewareImageä¸ºstringç±»å‹ï¼›ä¸”ç”¨requiredæŒ‡å®šconfigmapã€initImageã€middlewareImageå­—æ®µä¸ºå¿…å¡«é¡¹ã€‚ å°†ä»¥ä¸‹å†…å®¹ä¿å­˜åˆ° redis-cluster-crd.yamlï¼š\napiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: redisclusters.redis.middleware.hc.cn spec: group: redis.middleware.hc.cn versions: - name: v1alpha1 # Each version can be enabled/disabled by Served flag. served: true # One and only one version must be marked as the storage version. storage: true scope: Namespaced names: kind: RedisCluster singular: rediscluster listKind: RedisClusterList plural: redisclusters shortNames: - rec # æ‰§è¡Œkubectl get allæ—¶ä¼šæŸ¥åˆ°podã€serviceã€è¯¥crdç­‰å±äºall categoriesçš„èµ„æºå¯¹è±¡ categories: - all validation: # openAPIV3Schema é€‚ç”¨äºéªŒè¯è‡ªå®šä¹‰å¯¹è±¡çš„ schemaã€‚ openAPIV3Schema: properties: spec: required: [\u0026#34;replicas\u0026#34;, \u0026#34;repository\u0026#34;, \u0026#34;version\u0026#34;] properties: pause: type: boolean replicas: type: integer minimum: 0 maximum: 50 # å¶æ•° multipleOf: 2 updateStrategy: type: object properties: type: type: string # æšä¸¾ enum: [\u0026#34;AssignReceive\u0026#34;, \u0026#34;AutoReceive\u0026#34;] pipeline: type: string pattern: \u0026#39;^([1-9][0-9]*){1,3}$\u0026#39; assignStrategies: type: array items: type: object properties: slots: type: integer minimum: 1 maximum: 16384 fromReplicas: type: string # è‡³å°‘åŒ¹é…3ä½,a-zæˆ–è€…0-9æˆ–è€…, pattern: \u0026#39;^[a-z0-9,]{3,}$\u0026#39; pod: type: array items: type: object required: [\u0026#34;configmap\u0026#34;, \u0026#34;middlewareImage\u0026#34;, \u0026#34;initImage\u0026#34;] properties: configmap: type: string monitorImage: type: string initImage: type: string middlewareImage: type: string åˆ›å»ºå®ƒï¼š\nkubectl create -f redis-cluster-crd.yaml é»˜è®¤ä¸åŠ validationæ—¶ï¼Œåœ¨åˆ›å»ºè‡ªå®šä¹‰èµ„æºå¯¹è±¡æ—¶ï¼Œä¸ä¼šæ ¡éªŒï¼Œæœ‰äº›å­—æ®µæ²¡æœ‰äº†ï¼ˆå¦‚spec.replicasï¼‰éƒ½å¯ä»¥æ­£å¸¸è¢«åˆ›å»ºï¼Œä¸ºäº†å‡å°‘æ’é”™çš„éš¾åº¦å’Œoperatorã€controllerçš„éº»çƒ¦çš„æ£€éªŒï¼Œæ‰€ä»¥åœ¨åˆ›å»ºè‡ªå®šä¹‰èµ„æºå®šä¹‰æ—¶ï¼Œå°±æŠŠvalidationåŠ ä¸Šã€‚ä»¥ä¸Šçš„æ£€éªŒåº”è¯¥è¦†ç›–åˆ°äº†å¸¸è§çš„æ£€éªŒåœºæ™¯ï¼Œå…¶ä»–åœºæ™¯å¯ä»¥è‡ªå·±æ‘¸ç´¢ã€‚å…·ä½“è¿˜å¯ä»¥å‚è€ƒkubernetesæºç ï¼Œ1.13.2ç‰ˆæœ¬kubernetesæºç ä½äºtypes.goç¬¬327è¡ŒCustomResourceValidationç»“æ„ä½“ï¼š\n$GOPATH/src/k8s.io/kubernetes/staging/src/k8s.io/apiextensions-apiserver/pkg/apis/apiextensions/types.go å°†ä»¥ä¸‹YAMLä¿å­˜åˆ°redis-cluster-cr.yamlï¼š\napiVersion: redis.middleware.hc.cn/v1alpha1 kind: RedisCluster metadata: name: example000-redis-cluster namespace: kube-system spec: # ä»£è¡¨redisé›†ç¾¤çš„ä¸ªæ•° replicas: 3 # ä»£è¡¨æ˜¯å¦è¿›å…¥ç»´ä¿®çŠ¶æ€ pause: true repository: library/redis # é•œåƒç‰ˆæœ¬ï¼Œä¾¿äºåç»­å¤šç‰ˆæœ¬ç‰¹åŒ–æ”¯æŒ version: 3.2.6 #redisé›†ç¾¤å‡çº§ç­–ç•¥ updateStrategy: # å‡çº§ç±»å‹ä¸ºAutoReceiveï¼ˆè‡ªåŠ¨åˆ†é…,ä¸ç”¨AssignStrategiesï¼‰, AssignReceiveï¼ˆæŒ‡å®šå€¼åˆ†é…ï¼Œéœ€è¦ç”¨AssignStrategiesï¼‰ type: AssignReceive1 pipeline: \u0026#34;100a\u0026#34; assignStrategies: - slots: 0 fromReplicas: nodeId1 - # ä»nodeId3,nodeId4ä¸€å…±åˆ†é…1000ä¸ªå¡æ§½ slots: 1000 # å¤šä¸ªnodeIdç”¨é€—å·åˆ†éš” fromReplicas: nodeId3,nodeId4 # redis å®ä¾‹é…ç½®è¯¦æƒ… pod: # é…ç½®æ–‡ä»¶æ¨¡æ¿å - configmap: example000-redis-cluster-config # ç›‘æ§é•œåƒ monitorImage: redis-exporter:v1 # åˆå§‹åŒ–é•œåƒ #initImage: redis-init:v1 # ä¸­é—´ä»¶å®¹å™¨é•œåƒ middlewareImage: redis-trib:3.2.6 å¹¶åˆ›å»ºå®ƒï¼š\nkubectl create -f redis-cluster-cr.yaml ä¼šå‘ç°æŠ¥ä»¥ä¸‹é”™è¯¯ï¼š\n# kubectl apply -f redis-cluster-cr.yaml The RedisCluster \u0026#34;example000-redis-cluster\u0026#34; is invalid: []: Invalid value: map[string]interface {}{\u0026#34;apiVersion\u0026#34;:\u0026#34;redis.middleware.hc.cn/v1alpha1\u0026#34;, \u0026#34;kind\u0026#34;:\u0026#34;RedisCluster\u0026#34;, \u0026#34;metadata\u0026#34;:map[string]interface {}{\u0026#34;namespace\u0026#34;:\u0026#34;kube-system\u0026#34;, \u0026#34;uid\u0026#34;:\u0026#34;b0946031-766b-11e9-b457-000c295db389\u0026#34;, \u0026#34;resourceVersion\u0026#34;:\u0026#34;44231\u0026#34;, \u0026#34;generation\u0026#34;:19, \u0026#34;creationTimestamp\u0026#34;:\u0026#34;2019-05-14T17:14:10Z\u0026#34;, \u0026#34;annotations\u0026#34;:map[string]interface {}{\u0026#34;kubectl.kubernetes.io/last-applied-configuration\u0026#34;:\u0026#34;{\\\u0026#34;apiVersion\\\u0026#34;:\\\u0026#34;redis.middleware.hc.cn/v1alpha1\\\u0026#34;,\\\u0026#34;kind\\\u0026#34;:\\\u0026#34;RedisCluster\\\u0026#34;,\\\u0026#34;metadata\\\u0026#34;:{\\\u0026#34;annotations\\\u0026#34;:{},\\\u0026#34;name\\\u0026#34;:\\\u0026#34;example000-redis-cluster\\\u0026#34;,\\\u0026#34;namespace\\\u0026#34;:\\\u0026#34;kube-system\\\u0026#34;},\\\u0026#34;spec\\\u0026#34;:{\\\u0026#34;pause\\\u0026#34;:true,\\\u0026#34;pod\\\u0026#34;:[{\\\u0026#34;configmap\\\u0026#34;:\\\u0026#34;example000-redis-cluster-config\\\u0026#34;,\\\u0026#34;middlewareImage\\\u0026#34;:\\\u0026#34;redis-trib:3.2.6\\\u0026#34;,\\\u0026#34;monitorImage\\\u0026#34;:\\\u0026#34;redis-exporter:v1\\\u0026#34;}],\\\u0026#34;replicas\\\u0026#34;:3,\\\u0026#34;repository\\\u0026#34;:\\\u0026#34;library/redis\\\u0026#34;,\\\u0026#34;updateStrategy\\\u0026#34;:{\\\u0026#34;assignStrategies\\\u0026#34;:[{\\\u0026#34;fromReplicas\\\u0026#34;:\\\u0026#34;nodeId1\\\u0026#34;,\\\u0026#34;slots\\\u0026#34;:0},{\\\u0026#34;fromReplicas\\\u0026#34;:\\\u0026#34;nodeId3,nodeId4\\\u0026#34;,\\\u0026#34;slots\\\u0026#34;:1000}],\\\u0026#34;pipeline\\\u0026#34;:\\\u0026#34;100a\\\u0026#34;,\\\u0026#34;type\\\u0026#34;:\\\u0026#34;AssignReceive1\\\u0026#34;},\\\u0026#34;version\\\u0026#34;:\\\u0026#34;3.2.6\\\u0026#34;}}\\n\u0026#34;}, \u0026#34;name\u0026#34;:\u0026#34;example000-redis-cluster\u0026#34;}, \u0026#34;spec\u0026#34;:map[string]interface {}{\u0026#34;version\u0026#34;:\u0026#34;3.2.6\u0026#34;, \u0026#34;pause\u0026#34;:true, \u0026#34;pod\u0026#34;:[]interface {}{map[string]interface {}{\u0026#34;middlewareImage\u0026#34;:\u0026#34;redis-trib:3.2.6\u0026#34;, \u0026#34;monitorImage\u0026#34;:\u0026#34;redis-exporter:v1\u0026#34;, \u0026#34;configmap\u0026#34;:\u0026#34;example000-redis-cluster-config\u0026#34;}}, \u0026#34;replicas\u0026#34;:3, \u0026#34;repository\u0026#34;:\u0026#34;library/redis\u0026#34;, \u0026#34;updateStrategy\u0026#34;:map[string]interface {}{\u0026#34;assignStrategies\u0026#34;:[]interface {}{map[string]interface {}{\u0026#34;fromReplicas\u0026#34;:\u0026#34;nodeId1\u0026#34;, \u0026#34;slots\u0026#34;:0}, map[string]interface {}{\u0026#34;fromReplicas\u0026#34;:\u0026#34;nodeId3,nodeId4\u0026#34;, \u0026#34;slots\u0026#34;:1000}}, \u0026#34;pipeline\u0026#34;:\u0026#34;100a\u0026#34;, \u0026#34;type\u0026#34;:\u0026#34;AssignReceive1\u0026#34;}}}: validation failure list: spec.updateStrategy.assignStrategies.fromReplicas in body should match \u0026#39;^[a-z0-9,]{3,}$\u0026#39; spec.updateStrategy.assignStrategies.slots in body should be greater than or equal to 1 spec.updateStrategy.pipeline in body should match \u0026#39;^([1-9][0-9]*){1,3}$\u0026#39; spec.updateStrategy.type in body should be one of [AssignReceive AutoReceive] spec.pod.initImage in body is required spec.replicas in body should be a multiple of 2 å¦‚æœæ‰€æœ‰å­—æ®µéƒ½ç¬¦åˆæ ¡éªŒé€»è¾‘ï¼Œæ‰å¯ä»¥åˆ›å»ºå¯¹è±¡ã€‚\nå°†ä»¥ä¸‹ YAML ä¿å­˜åˆ° redis-cluster-cr.yamlï¼š\napiVersion: redis.middleware.hc.cn/v1alpha1 kind: RedisCluster metadata: name: example000-redis-cluster namespace: kube-system spec: # ä»£è¡¨redisé›†ç¾¤çš„ä¸ªæ•° replicas: 6 # ä»£è¡¨æ˜¯å¦è¿›å…¥ç»´ä¿®çŠ¶æ€ pause: true repository: library/redis # é•œåƒç‰ˆæœ¬ï¼Œä¾¿äºåç»­å¤šç‰ˆæœ¬ç‰¹åŒ–æ”¯æŒ version: 3.2.6 #redisé›†ç¾¤å‡çº§ç­–ç•¥ updateStrategy: # å‡çº§ç±»å‹ä¸ºAutoReceiveï¼ˆè‡ªåŠ¨åˆ†é…,ä¸ç”¨AssignStrategiesï¼‰, AssignReceiveï¼ˆæŒ‡å®šå€¼åˆ†é…ï¼Œéœ€è¦ç”¨AssignStrategiesï¼‰ type: AssignReceive pipeline: \u0026#34;100\u0026#34; assignStrategies: - slots: 1 fromReplicas: all - # ä»nodeId3,nodeId4ä¸€å…±åˆ†é…1000ä¸ªå¡æ§½ slots: 1000 # å¤šä¸ªnodeIdç”¨é€—å·åˆ†éš” fromReplicas: node1,node2 # redis å®ä¾‹é…ç½®è¯¦æƒ… pod: # é…ç½®æ–‡ä»¶æ¨¡æ¿å - configmap: example000-redis-cluster-config # ç›‘æ§é•œåƒ monitorImage: redis-exporter:v1 # åˆå§‹åŒ–é•œåƒ initImage: redis-init:v1 # ä¸­é—´ä»¶å®¹å™¨é•œåƒ middlewareImage: redis-trib:3.2.6 å¹¶åˆ›å»ºå®ƒï¼Œå‘ç°æ‰å¯ä»¥åˆ›å»ºï¼š\n# kubectl apply -f redis-cluster-cr.yaml rediscluster.redis.middleware.hc.cn/example000-redis-cluster configured Categoryï¼ˆåˆ†ç±»ï¼‰ # ç±»åˆ«æ˜¯è‡ªå®šä¹‰èµ„æºæ‰€å±çš„åˆ†ç»„èµ„æºçš„åˆ—è¡¨ï¼ˆä¾‹å¦‚ allï¼‰ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ kubectl get \u0026lt;category-name\u0026gt; åˆ—å‡ºå±äºè¯¥ç±»åˆ«çš„èµ„æºã€‚æ­¤åŠŸèƒ½å¯ç”¨äº v1.10 åŠä»¥ä¸Šk8sç‰ˆæœ¬è‡ªå®šä¹‰èµ„æºã€‚\nä»¥ä¸‹ç¤ºä¾‹æ·»åŠ  all CustomResourceDefinition ä¸­çš„ç±»åˆ«åˆ—è¡¨ï¼Œå¹¶è¯´æ˜å¦‚ä½•ä½¿ç”¨ kubectl get all è¾“å‡ºè‡ªå®šä¹‰èµ„æº ã€‚\nå°†ä»¥ä¸‹ å†…å®¹ä¿å­˜åˆ° redis-cluster-crd.yamlä¸­æ‰§è¡Œkubectl apply -f redis-cluster-crd.yamlï¼š\napiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: redisclusters.redis.middleware.hc.cn spec: group: redis.middleware.hc.cn versions: - name: v1alpha1 # Each version can be enabled/disabled by Served flag. served: true # One and only one version must be marked as the storage version. storage: true scope: Namespaced names: kind: RedisCluster singular: rediscluster listKind: RedisClusterList plural: redisclusters shortNames: - rec # æ‰§è¡Œkubectl get allæ—¶ä¼šæŸ¥åˆ°podã€serviceã€è¯¥crdç­‰å±äºall categoriesçš„èµ„æºå¯¹è±¡ categories: - all å°†ä»¥ä¸‹å†…å®¹ä¿å­˜åˆ°redis-cluster-cr.yamlä¸­æ‰§è¡Œkubectl apply -f redis-cluster-cr.yamlï¼š\napiVersion: redis.middleware.hc.cn/v1alpha1 kind: RedisCluster metadata: name: example000-redis-cluster namespace: kube-system spec: # ä»£è¡¨redisé›†ç¾¤çš„ä¸ªæ•° replicas: 6 # ä»£è¡¨æ˜¯å¦è¿›å…¥ç»´ä¿®çŠ¶æ€ pause: true repository: library/redis # é•œåƒç‰ˆæœ¬ï¼Œä¾¿äºåç»­å¤šç‰ˆæœ¬ç‰¹åŒ–æ”¯æŒ version: 3.2.6 #redisé›†ç¾¤å‡çº§ç­–ç•¥ updateStrategy: # å‡çº§ç±»å‹ä¸ºAutoReceiveï¼ˆè‡ªåŠ¨åˆ†é…,ä¸ç”¨AssignStrategiesï¼‰, AssignReceiveï¼ˆæŒ‡å®šå€¼åˆ†é…ï¼Œéœ€è¦ç”¨AssignStrategiesï¼‰ type: AssignReceive pipeline: \u0026#34;100\u0026#34; assignStrategies: - slots: 2000 fromReplicas: nodeId1 - # ä»nodeId3,nodeId4ä¸€å…±åˆ†é…1000ä¸ªå¡æ§½ slots: 1000 # å¤šä¸ªnodeIdç”¨é€—å·åˆ†éš” fromReplicas: nodeId3,nodeId4 # redis å®ä¾‹é…ç½®è¯¦æƒ… pod: # é…ç½®æ–‡ä»¶æ¨¡æ¿å - configmap: example000-redis-cluster-config # ç›‘æ§é•œåƒ monitorImage: redis-exporter:v1 # åˆå§‹åŒ–é•œåƒ initImage: redis-init:v1 # ä¸­é—´ä»¶å®¹å™¨é•œåƒ middlewareImage: redis-trib:3.2.6 æ‰§è¡Œkubectl get allæ—¶ä¼šæŸ¥åˆ°podã€serviceã€è¯¥crdç­‰å±äºall categoriesçš„èµ„æºå¯¹è±¡ã€‚ï¼ˆè¿™ä¸ªå¯èƒ½å¾—ç­‰å‡ åˆ†é’Ÿæ‰èƒ½ç”Ÿæ•ˆï¼‰\nå­èµ„æº # statuså­èµ„æº # å¯ç”¨çŠ¶æ€å­èµ„æºåï¼Œå°†å…¬å¼€è‡ªå®šä¹‰èµ„æºçš„å­èµ„æº /statusã€‚\nçŠ¶æ€å’Œè§„èŒƒèŠ‚åˆ†åˆ«ç”±è‡ªå®šä¹‰èµ„æºå†…çš„ .status å’Œ .spec JSONPath è¡¨ç¤ºã€‚ PUT /status å¯¹å­èµ„æºçš„è¯·æ±‚é‡‡ç”¨è‡ªå®šä¹‰èµ„æºå¯¹è±¡ï¼Œå¹¶å¿½ç•¥é™¤çŠ¶æ€èŠ‚ä¹‹å¤–çš„ä»»ä½•æ›´æ”¹ã€‚ PUT /status å¯¹å­èµ„æºçš„è¯·æ±‚ä»…éªŒè¯è‡ªå®šä¹‰èµ„æºçš„çŠ¶æ€èŠ‚ã€‚ PUT/ POST/ PATCH è¯·æ±‚è‡ªå®šä¹‰èµ„æºå¿½ç•¥æ›´æ”¹çŠ¶æ€èŠ‚ã€‚ å¯¹ spec èŠ‚çš„ä»»ä½•æ›´æ”¹éƒ½ä¼šå¢åŠ  .metadata.generation çš„å€¼ã€‚ åœ¨code-generatorç”Ÿæˆä»£ç æ—¶ä¼šç”Ÿæˆï¼Œå¦‚ä¸‹æ–¹æ³•ï¼š\n// RedisClusterInterface has methods to work with RedisCluster resources. type RedisClusterInterface interface { Create(*v1alpha1.RedisCluster) (*v1alpha1.RedisCluster, error) Update(*v1alpha1.RedisCluster) (*v1alpha1.RedisCluster, error) UpdateStatus(*v1alpha1.RedisCluster) (*v1alpha1.RedisCluster, error) ...... } scaleå­èµ„æº # å¯ç”¨ scale å­èµ„æºåï¼Œå°†å…¬å¼€è‡ªå®šä¹‰èµ„æºçš„å­èµ„æº /scaleã€‚è¯¥ autoscaling/v1.Scale å¯¹è±¡ä½œä¸ºæœ‰æ•ˆè´Ÿè½½å‘é€ /scaleã€‚\nè¦å¯ç”¨ scale å­èµ„æºï¼ŒCustomResourceDefinition ä¸­éœ€è¦å®šä¹‰ä»¥ä¸‹å€¼ã€‚\nSpecReplicasPath åœ¨ä¸ä¹‹å¯¹åº”çš„è‡ªå®šä¹‰èµ„æºä¸­å®šä¹‰ JSONPath Scale.Spec.Replicasã€‚è¿™æ˜¯ä¸€ä¸ªå¿…éœ€çš„å€¼ã€‚.spec åªå…è®¸ä½¿ç”¨å¸¦ç‚¹ç¬¦å·çš„ JSONPaths ã€‚å¦‚æœ SpecReplicasPath è‡ªå®šä¹‰èµ„æºä¸­æ²¡æœ‰å€¼ï¼Œåˆ™ /scale å­èµ„æºå°†åœ¨GETä¸Šè¿”å›é”™è¯¯ã€‚\nStatusReplicasPath åœ¨ä¸ä¹‹å¯¹åº”çš„è‡ªå®šä¹‰èµ„æºä¸­å®šä¹‰ JSONPath Scale.Status.Replicasã€‚è¿™æ˜¯ä¸€ä¸ªå¿…éœ€çš„å€¼ã€‚.stutus åªå…è®¸ä½¿ç”¨å¸¦ç‚¹ç¬¦å·çš„ JSONPaths ã€‚å¦‚æœ StatusReplicasPath è‡ªå®šä¹‰èµ„æºä¸­æ²¡æœ‰å€¼ï¼Œåˆ™å­èµ„æº /scale ä¸­çš„çŠ¶æ€å‰¯æœ¬å€¼å°†é»˜è®¤ä¸º 0ã€‚\nLabelSelectorPathåœ¨ä¸ä¹‹å¯¹åº”çš„è‡ªå®šä¹‰èµ„æºä¸­å®šä¹‰ JSONPath Scale.Status.Selectorã€‚è¿™æ˜¯ä¸€ä¸ªå¯é€‰å€¼ã€‚å¿…é¡»å°†å…¶è®¾ç½®ä¸ºä¸ HPA ä¸€èµ·ä½¿ç”¨ã€‚.status åªå…è®¸ä½¿ç”¨å¸¦ç‚¹ç¬¦å·çš„ JSONPaths ã€‚å¦‚æœ LabelSelectorPath è‡ªå®šä¹‰èµ„æºä¸­æ²¡æœ‰å€¼ï¼Œåˆ™å­èµ„æº /scale ä¸­çš„çŠ¶æ€é€‰æ‹©å™¨å€¼å°†é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ã€‚\nåœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå¯ç”¨äº†status å’Œ scale å­èµ„æºã€‚\nå°†ä»¥ä¸‹å†…å®¹ä¿å­˜åˆ°redis-cluster-crd.yamlå¹¶åˆ›å»º kubectl apply -f redis-cluster-crd.yamlï¼š\napiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: redisclusters.redis.middleware.hc.cn spec: group: redis.middleware.hc.cn versions: - name: v1alpha1 # Each version can be enabled/disabled by Served flag. served: true # One and only one version must be marked as the storage version. storage: true scope: Namespaced names: kind: RedisCluster singular: rediscluster listKind: RedisClusterList plural: redisclusters shortNames: - rec # æ‰§è¡Œkubectl get allæ—¶ä¼šæŸ¥åˆ°podã€serviceã€è¯¥crdç­‰å±äºall categoriesçš„èµ„æºå¯¹è±¡ categories: - all subresources: # status enables the status subresource. status: {} scale: # specReplicasPath defines the JSONPath inside of a custom resource that corresponds to Scale.Spec.Replicas. specReplicasPath: .spec.replicas # statusReplicasPath defines the JSONPath inside of a custom resource that corresponds to Scale.Status.Replicas. statusReplicasPath: .status.replicas # labelSelectorPath defines the JSONPath inside of a custom resource that corresponds to Scale.Status.Selector. labelSelectorPath: .status.labelSelector åˆ›å»º CustomResourceDefinition å¯¹è±¡åï¼Œæ‚¨å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰å¯¹è±¡ã€‚\nå¦‚æœæ‚¨å°†ä»¥ä¸‹ YAML ä¿å­˜åˆ° redis-cluster-cr.yamlï¼š\napiVersion: redis.middleware.hc.cn/v1alpha1 kind: RedisCluster metadata: name: example000-redis-cluster namespace: kube-system spec: # ä»£è¡¨redisé›†ç¾¤çš„ä¸ªæ•° replicas: 6 # ä»£è¡¨æ˜¯å¦è¿›å…¥ç»´ä¿®çŠ¶æ€ pause: true repository: library/redis # é•œåƒç‰ˆæœ¬ï¼Œä¾¿äºåç»­å¤šç‰ˆæœ¬ç‰¹åŒ–æ”¯æŒ version: 3.2.6 #redisé›†ç¾¤å‡çº§ç­–ç•¥ updateStrategy: # å‡çº§ç±»å‹ä¸ºAutoReceiveï¼ˆè‡ªåŠ¨åˆ†é…,ä¸ç”¨AssignStrategiesï¼‰, AssignReceiveï¼ˆæŒ‡å®šå€¼åˆ†é…ï¼Œéœ€è¦ç”¨AssignStrategiesï¼‰ type: AssignReceive pipeline: \u0026#34;100\u0026#34; assignStrategies: - slots: 2000 fromReplicas: nodeId1 - # ä»nodeId3,nodeId4ä¸€å…±åˆ†é…1000ä¸ªå¡æ§½ slots: 1000 # å¤šä¸ªnodeIdç”¨é€—å·åˆ†éš” fromReplicas: nodeId3,nodeId4 # redis å®ä¾‹é…ç½®è¯¦æƒ… pod: # é…ç½®æ–‡ä»¶æ¨¡æ¿å - configmap: example000-redis-cluster-config # ç›‘æ§é•œåƒ monitorImage: redis-exporter:v1 # åˆå§‹åŒ–é•œåƒ initImage: redis-init:v1 # ä¸­é—´ä»¶å®¹å™¨é•œåƒ middlewareImage: redis-trib:3.2.6 å¹¶åˆ›å»ºå®ƒï¼š\nkubectl create -f redis-cluster-cr.yaml ç„¶ååœ¨ä»¥ä¸‹ä½ç½®åˆ›å»ºæ–°çš„å‘½åç©ºé—´ RESTful API ç«¯ç‚¹ï¼š\n/apis/redis.middleware.hc.cn/v1alpha1/namespaces/kube-system/redisclusters/example000-redis-cluster/status å’Œ\n/apis/redis.middleware.hc.cn/v1alpha1/namespaces/kube-system/redisclusters/example000-redis-cluster/scale å¯ä»¥ä½¿ç”¨è¯¥ kubectl scale å‘½ä»¤ç¼©æ”¾è‡ªå®šä¹‰èµ„æºã€‚ä¾‹å¦‚ï¼Œä»¥ä¸Šåˆ›å»ºçš„è‡ªå®šä¹‰èµ„æºçš„çš„ .spec.replicas è®¾ç½®ä¸º 10ï¼š\n# kubectl get rec --all-namespaces NAMESPACE NAME DESIRED PAUSE AGE kube-system example000-redis-cluster 6 true 10h # kubectl scale --replicas=10 rec/example000-redis-cluster -nkube-system rediscluster.redis.middleware.hc.cn/example000-redis-cluster scaled # kubectl get rec --all-namespaces NAMESPACE NAME DESIRED PAUSE AGE kube-system example000-redis-cluster 10 true 10h # kubectl get rec example000-redis-cluster -n kube-system -o jsonpath=\u0026#39;{.spec.replicas}\u0026#39; 10 æ‰“å°å…¶ä»–åˆ— # ä» Kubernetes 1.11 å¼€å§‹ï¼Œkubectl ä½¿ç”¨æœåŠ¡å™¨ç«¯æ‰“å°ã€‚æœåŠ¡å™¨å†³å®š kubectl get å‘½ä»¤æ˜¾ç¤ºå“ªäº›åˆ—ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ CustomResourceDefinition è‡ªå®šä¹‰è¿™äº›åˆ—ã€‚ä¸‹é¢çš„ç¤ºä¾‹å°†è¾“å‡º Specã€Replicas å’Œ Age åˆ—ã€‚\nå°† CustomResourceDefinitionä¿å­˜åˆ° redis-cluster-crd.yamlã€‚\napiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: redisclusters.redis.middleware.hc.cn spec: group: redis.middleware.hc.cn versions: - name: v1alpha1 # Each version can be enabled/disabled by Served flag. served: true # One and only one version must be marked as the storage version. storage: true scope: Namespaced names: kind: RedisCluster singular: rediscluster listKind: RedisClusterList plural: redisclusters shortNames: - rec # æ‰§è¡Œkubectl get allæ—¶ä¼šæŸ¥åˆ°podã€serviceã€è¯¥crdç­‰å±äºall categoriesçš„èµ„æºå¯¹è±¡ categories: - all additionalPrinterColumns: - name: DESIRED type: integer description: The number of statefulset managed by the this redisCluster JSONPath: .spec.replicas # boolean,date,integer,number,string - name: PAUSE type: boolean description: Whether this redisCluster\u0026#39;s grandson (pod) will not be managed by statefulset JSONPath: .spec.pause åˆ›å»º CustomResourceDefinitionï¼š\nkubectl create -f redis-cluster-crd.yaml ä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ redis-cluster-cr.yaml å®ä¾‹ã€‚\nè°ƒç”¨æœåŠ¡å™¨ç«¯æ‰“å°ï¼š\nkubectl get rec --all-namespaces è¯·æ³¨æ„ NAMEã€NAMESPACE, DESIREDã€PAUSE å’Œ AGE åœ¨è¾“å‡ºåˆ—ï¼Œå¹¶ä¸”éƒ½è¢«è½¬æˆäº†å¤§å†™å­—æ¯ï¼š\n[root@master-192 redis-container]# kubectl get rec --all-namespaces NAMESPACE NAME DESIRED PAUSE AGE kube-system example000-redis-cluster 6 true 10h NAMEå’ŒNAMESPACE åˆ—æ˜¯éšå«çš„ï¼Œä¸éœ€è¦åœ¨ CustomResourceDefinition ä¸­å®šä¹‰ã€‚\noperatorä¸­åº”ç”¨è¯¥ç‰¹æ€§ # åœ¨golangç¼–å†™çš„operatorä»£ç ä¸­åˆ›å»ºè¯¥ç»“æ„ä½“ï¼š\n//åˆ›å»ºCRD func CreateRedisClusterCRD(extensionCRClient *extensionsclient.Clientset) error { //add CustomResourceValidation due to guarantee redis operator work normally labelSelectorPath := \u0026#34;.status.labelSelector\u0026#34; replicasMinimum := float64(0) replicasMaximum := float64(50) replicasMultipleOf := float64(2) slotsMinimum := float64(1) slotsMaximum := float64(16384) assignStr := \u0026#34;AssignReceive\u0026#34; autoStr := \u0026#34;AutoReceive\u0026#34; assignJson, _ := json.Marshal(assignStr) autoJson, _ := json.Marshal(autoStr) crd := \u0026amp;v1beta1.CustomResourceDefinition{ ObjectMeta: metav1.ObjectMeta{ Name: \u0026#34;redisclusters.\u0026#34; + v1alpha1.SchemeGroupVersion.Group, }, Spec: v1beta1.CustomResourceDefinitionSpec{ Group: v1alpha1.SchemeGroupVersion.Group, Versions: []v1beta1.CustomResourceDefinitionVersion { { // Served is a flag enabling/disabling this version from being served via REST APIs Served: true, Name: v1alpha1.SchemeGroupVersion.Version, // Storage flags the version as storage version. There must be exactly one flagged as storage version Storage: true, }, }, Scope: v1beta1.NamespaceScoped, Names: v1beta1.CustomResourceDefinitionNames{ Kind: \u0026#34;RedisCluster\u0026#34;, ListKind: \u0026#34;RedisClusterList\u0026#34;, Plural: \u0026#34;redisclusters\u0026#34;, Singular: \u0026#34;rediscluster\u0026#34;, ShortNames: []string{\u0026#34;rec\u0026#34;}, Categories: []string{\u0026#34;all\u0026#34;}, }, Subresources: \u0026amp;v1beta1.CustomResourceSubresources { Status: \u0026amp;v1beta1.CustomResourceSubresourceStatus {}, Scale: \u0026amp;v1beta1.CustomResourceSubresourceScale { SpecReplicasPath: \u0026#34;.spec.replicas\u0026#34;, StatusReplicasPath: \u0026#34;.status.replicas\u0026#34;, LabelSelectorPath: \u0026amp;labelSelectorPath, }, }, AdditionalPrinterColumns: []v1beta1.CustomResourceColumnDefinition{ { Name: \u0026#34;DESIRED\u0026#34;, Type: \u0026#34;integer\u0026#34;, Description: \u0026#34;The number of statefulset managed by the this redisCluster\u0026#34;, JSONPath: \u0026#34;.spec.replicas\u0026#34;, }, { Name: \u0026#34;PAUSE\u0026#34;, Type: \u0026#34;boolean\u0026#34;, Description: \u0026#34;Whether this redisCluster\u0026#39;s grandson (pod) will not be managed by statefulset\u0026#34;, JSONPath: \u0026#34;.spec.pause\u0026#34;, }, { Name: \u0026#34;AGE\u0026#34;, Type: \u0026#34;date\u0026#34;, JSONPath: \u0026#34;.metadata.creationTimestamp\u0026#34;, }, }, Validation: \u0026amp;v1beta1.CustomResourceValidation { OpenAPIV3Schema: \u0026amp;v1beta1.JSONSchemaProps { Properties: map[string]v1beta1.JSONSchemaProps { \u0026#34;spec\u0026#34;: { Required: []string{\u0026#34;replicas\u0026#34;, \u0026#34;repository\u0026#34;, \u0026#34;version\u0026#34;}, Properties: map[string]v1beta1.JSONSchemaProps{ \u0026#34;pause\u0026#34;: { Type: \u0026#34;boolean\u0026#34;, }, \u0026#34;replicas\u0026#34;: { Type: \u0026#34;integer\u0026#34;, Minimum: \u0026amp;replicasMinimum, Maximum: \u0026amp;replicasMaximum, MultipleOf: \u0026amp;replicasMultipleOf, }, \u0026#34;updateStrategy\u0026#34;: { Type: \u0026#34;object\u0026#34;, Properties: map[string]v1beta1.JSONSchemaProps{ \u0026#34;type\u0026#34;: { Type: \u0026#34;string\u0026#34;, Enum: []v1beta1.JSON { { //è¿™é‡Œå¿…é¡»æ˜¯JSONæ ¼å¼çš„å­—ç¬¦ä¸² Raw: assignJson, }, { Raw: autoJson, }, }, }, \u0026#34;pipeline\u0026#34;: { Type: \u0026#34;string\u0026#34;, Pattern: `^([1-9][0-9]*){1,3}$`, }, \u0026#34;assignStrategies\u0026#34;: { Type: \u0026#34;array\u0026#34;, Items: \u0026amp;v1beta1.JSONSchemaPropsOrArray{ Schema: \u0026amp;v1beta1.JSONSchemaProps{ Type: \u0026#34;object\u0026#34;, Properties: map[string]v1beta1.JSONSchemaProps{ \u0026#34;slots\u0026#34;: { Type: \u0026#34;integer\u0026#34;, Minimum: \u0026amp;slotsMinimum, Maximum: \u0026amp;slotsMaximum, }, \u0026#34;fromReplicas\u0026#34;: { Type: \u0026#34;string\u0026#34;, Pattern: `^[a-z0-9,]{3,}$`, }, }, }, }, }, }, }, }, }, \u0026#34;pod\u0026#34;: { Type: \u0026#34;array\u0026#34;, Items: \u0026amp;v1beta1.JSONSchemaPropsOrArray { Schema: \u0026amp;v1beta1.JSONSchemaProps { Type: \u0026#34;object\u0026#34;, Required: []string{\u0026#34;replicas\u0026#34;, \u0026#34;repository\u0026#34;, \u0026#34;version\u0026#34;}, Properties: map[string]v1beta1.JSONSchemaProps{ \u0026#34;configmap\u0026#34;: { Type: \u0026#34;string\u0026#34;, }, \u0026#34;monitorImage\u0026#34;: { Type: \u0026#34;string\u0026#34;, }, \u0026#34;initImage\u0026#34;: { Type: \u0026#34;string\u0026#34;, }, \u0026#34;middlewareImage\u0026#34;: { Type: \u0026#34;string\u0026#34;, }, }, }, }, }, }, }, }, }, } _, err := extensionCRClient.ApiextensionsV1beta1().CustomResourceDefinitions().Create(crd) return err } å‚è€ƒ # å®˜æ–¹Extend the Kubernetes API with CustomResourceDefinitionsï¼š\nhttps://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/\nfeature-gateså‚æ•°è¯´æ˜ï¼š\nhttps://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/\nCustomResourceDefinitionä¸­æ–‡æ–‡æ¡£ï¼š\nhttps://kubernetes.feisky.xyz/cha-jian-kuo-zhan/api/customresourcedefinition\nswaggerå’ŒopenAPI: æ•°æ®ç±»å‹ï¼š\nhttps://www.breakyizhan.com/swagger/2969.html\næ­£åˆ™è¡¨è¾¾å¼ï¼š\nhttps://www.cnblogs.com/afarmer/archive/2011/08/29/2158860.html\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/kubernetes%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/","section":"Posts","summary":"\u003cp\u003ekubernetesè‡ªå®šä¹‰èµ„æºå¯¹è±¡å†æå¤§ç¨‹åº¦æé«˜äº†API Serverçš„å¯æ‰©å±•æ€§ï¼Œè®©ä¼ä¸šèƒ½å¤Ÿæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€šè¿‡CRDç¼–å†™controlleræˆ–è€…operatoræ¥å®ç°ç”Ÿäº§ä¸­å„ç§ç‰¹æ®Šåœºæ™¯ã€‚éšç€k8sçš„ç‰ˆæœ¬å‡çº§ï¼ŒCRDçš„åŠŸèƒ½ä¹Ÿè¶Šæ¥è¶Šå®Œå–„ï¼Œä¸‹é¢å¯¹å…¶ä¸­å‡ ç‚¹è¿›è¡Œè¯´æ˜ã€‚\u003c/p\u003e","title":"kubernetesè‡ªå®šä¹‰èµ„æºå¯¹è±¡é«˜çº§åŠŸèƒ½","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/shell/","section":"Tags","summary":"","title":"Shell","type":"tags"},{"content":"redisåœ¨å®¹å™¨åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°çºµå‘æ‰©podå®ä¾‹cpuã€å†…å­˜ä»¥åŠrediså®ä¾‹çš„maxmemoryå€¼ï¼Œstatefulsetç®¡ç†çš„podéœ€è¦é‡å¯ã€‚æ‰€ä»¥æŠŠredisé›†ç¾¤çš„çŠ¶æ€æ£€æŸ¥æ”¾åˆ°äº†å¥åº·æ£€æŸ¥ä¸­ï¼Œä¾èµ–statefulsetçš„åŸç”Ÿèƒ½åŠ›ï¼ˆpodå®ä¾‹readyåæ‰é‡å¯ä¸‹ä¸€ä¸ªï¼Œreadyåendpoints controllerå°†podä¿¡æ¯æ›´æ–°åˆ°endpointsèµ„æºå¯¹è±¡ä¸­ï¼‰,è€Œæ²¡æœ‰åœ¨redis operatorä¸­å†™é€»è¾‘å»åˆ¤æ–­ã€‚\néœ€è¦ç”¨redis-cli -h {rediså®ä¾‹IP} pingæŸ¥çœ‹redisæ˜¯å¦æ­£å¸¸ï¼ŒåŒæ—¶ç”¨redis-cli -c -h {rediså®ä¾‹IP} -a {rediså¯†ç } cluster infoè¾“å‡ºçš„ä¿¡æ¯è§£æcluster_stateçš„å€¼æ˜¯å¦ä¸ºokï¼Œä»¥åŠcluster_known_nodesçš„å€¼æ˜¯å¦ä¸º1ï¼Œåˆ¤æ–­redisé›†ç¾¤æ˜¯å¦æ­£å¸¸ï¼›\nå¦‚æœredisé›†ç¾¤åˆšåˆ›å»ºï¼Œcluster_known_nodesä¸º1ï¼Œcluster_stateä¸ºfail;\nå¦‚æœredisé›†ç¾¤ä¸ºçºµå‘æ‰©å®¹(æ‰©CPUã€å†…å­˜)å‡çº§é‡å¯ï¼Œcluster_known_nodesä¸ä¸º1ï¼Œcluster_stateä¸ºokæ—¶æ‰è®¤ä¸ºé›†ç¾¤æ­£å¸¸ï¼Œæ‰èƒ½é‡å¯ä¸‹ä¸€ä¸ªpodã€‚\nå› ä¸ºæ¶‰åŠåˆ°å­—ç¬¦ä¸²ç›¸ç­‰åˆ¤æ–­ï¼Œæ‰€ä»¥ç”¨ä»¥ä¸‹è¿™æ ·åˆ¤æ–­ï¼š\nif [ \u0026#34;$cluster_known_nodes\u0026#34;x = \u0026#34;1\u0026#34;x ]; then ..... fi ä½†æ˜¯åˆ¤æ–­ä¸€ç›´æœ‰é—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼Œåœ¨$aåé¢åŠ ä¸ªxï¼Œä¼šå˜ä¸ºåœ¨å¼€å¤´è¦†ç›–å¼çš„åŠ aï¼Œç»“æœå°±æ˜¯åˆ¤æ–­ç»“æœä¸ç›¸ç­‰ã€‚\næŠŠredis-cli -c -h {rediså®ä¾‹IP} -a {rediså¯†ç } cluster infoæ‰§è¡Œçš„ç»“æœé‡å®šå‘åˆ°æ–‡ä»¶é‡Œã€‚\nvi 1.txtæŸ¥çœ‹æ–‡ä»¶ï¼Œåœ¨vié‡Œç”¨set ffå‘½ä»¤æŸ¥çœ‹æ–‡ä»¶æ ¼å¼ä¸ºunixï¼Œä½†æ˜¯æ–‡ä»¶æ¯ä¸€è¡Œåé¢éƒ½æœ‰ä¸€ä¸ª^Mçš„ç‰¹æ®Šå­—ç¬¦ï¼Œè¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨äº†ã€‚\næœ€ä¸»è¦æ˜¯é€šè¿‡catéƒ½çœ‹ä¸å‡ºæ¥ç‰¹æ®Šå­—ç¬¦çš„å­˜åœ¨ã€‚\næ‰‹åŠ¨æŠŠ^Mç‰¹æ®Šå­—ç¬¦åˆ æ‰å°±å¥½äº†ã€‚\nç½‘ä¸Šè¯´^Mæ˜¯windowsæ ¼å¼æ–‡æœ¬æ–‡ä»¶çš„æ¢è¡Œç¬¦\\r\\nï¼Œå¯ä»¥ç”¨dos2unixå‘½ä»¤è½¬ä¸ºunixæ ¼å¼ã€‚ä½†æ˜¯æ‰§è¡Œcluster infoå‘½ä»¤å…¨ç¨‹åœ¨linuxä¸­æ“ä½œï¼Œè€Œä¸”é‡å®šå‘åˆ°æ–‡ä»¶ä¸­set ffå‘½ä»¤çœ‹åˆ°ä¹Ÿæ˜¯unixæ ¼å¼ã€‚è¿™ç‚¹è¿˜æ˜¯å¾ˆè´¹è§£ã€‚\nå…ˆç”¨sedå‘½ä»¤å°†^Mæ¢æ‰ï¼Œè¯•äº†sed \u0026rsquo;s/^M//g\u0026rsquo;æ²¡æœ‰ç”¨ï¼Œæ‰€ä»¥é€‰æ‹©ç”¨sed \u0026rsquo;s?\\r??g\u0026rsquo;æ›¿æ¢ï¼Œæœ€ç»ˆè„šæœ¬å¦‚ä¸‹ã€‚\nifè¯­å¥çš„[[]]éœ€è¦ç”¨bashæ‰§è¡Œï¼Œç”¨shæ‰§è¡Œä¼šæŠ¥é”™[[: not found\n#!/bin/bash #éœ€è¦ç”¨redis-cli -h {rediså®ä¾‹IP} pingæŸ¥çœ‹redisæ˜¯å¦æ­£å¸¸ #ç”¨redis-cli -c -h {rediså®ä¾‹IP} -a {rediså¯†ç } cluster infoè¾“å‡º #çš„ä¿¡æ¯è§£æcluster_stateçš„å€¼æ˜¯å¦ä¸ºokï¼Œä»¥åŠcluster_known_nodesçš„å€¼æ˜¯ #å¦ä¸º1ï¼Œåˆ¤æ–­redisé›†ç¾¤æ˜¯å¦æ­£å¸¸ï¼›å¦‚æœredisé›†ç¾¤åˆšåˆ›å»ºï¼Œcluster_known_nodes #ä¸º1ï¼Œcluster_stateä¸ºfail;å¦‚æœredisé›†ç¾¤ä¸ºçºµå‘æ‰©å®¹(æ‰©CPUã€å†…å­˜)å‡çº§é‡å¯ #cluster_known_nodesä¸ä¸º1ï¼Œcluster_stateä¸ºokæ—¶æ‰è®¤ä¸ºé›†ç¾¤æ­£å¸¸ï¼Œæ‰èƒ½é‡å¯ #ä¸‹ä¸€ä¸ªpodï¼Œæ”¹å¥åº·æ£€æŸ¥è„šæœ¬æ—¨åœ¨ç»´æŠ¤å‡çº§æ—¶redisé›†ç¾¤çŠ¶æ€ï¼Œä¸åœ¨operatorä¸­ç»´æŠ¤ # åˆ©ç”¨å¥½statefulsetä¸€ä¸ªå®ä¾‹readyåé‡å¯ä¸‹ä¸€ä¸ªpodçš„ç‰¹æ€§ pingres=$(redis-cli -h $(hostname) ping) # cluster_state:ok # cluster_slots_assigned:16384 # cluster_slots_ok:16384 # cluster_slots_pfail:0 # cluster_slots_fail:0 # cluster_known_nodes:6 # cluster_size:3 # cluster_current_epoch:15 # cluster_my_epoch:12 # cluster_stats_messages_sent:270782059 # cluster_stats_messages_received:270732696 pingres=$(echo \u0026#34;${pingres}\u0026#34; | sed \u0026#39;s?\\r??g\u0026#39;) if [[ \u0026#34;$pingres\u0026#34;x = \u0026#34;PONG\u0026#34;x ]]; then clusterinfo=$(redis-cli -c -h ${PODIP} cluster info) # redis-cli -c -h ${PODIP} cluster info output info include ^M(win \\n\\r) char lead to error, so use sed \u0026#39;s?\\r??g\u0026#39; clusterknownnodes=$(echo \u0026#34;${clusterinfo}\u0026#34; | grep cluster_known_nodes | sed \u0026#39;s?\\r??g\u0026#39; | awk -F \u0026#39;:\u0026#39; \u0026#39;{print $2}\u0026#39;) clusterstate=$(echo \u0026#34;${clusterinfo}\u0026#34; | grep cluster_state | sed \u0026#39;s?\\r??g\u0026#39; | awk -F \u0026#39;:\u0026#39; \u0026#39;{print $2}\u0026#39;) echo \u0026#34;clusterknownnodes: ${clusterknownnodes} --- clusterstate: ${clusterstate}\u0026#34; # [[ need run this script use /bin/bash instead of /bin/sh # ifè¯­å¥çš„[[]]éœ€è¦ç”¨bashæ‰§è¡Œï¼Œç”¨shæ‰§è¡Œä¼šæŠ¥é”™[[: not found if [[ \u0026#34;${clusterknownnodes}\u0026#34;x = \u0026#34;1\u0026#34;x \u0026amp;\u0026amp; \u0026#34;${clusterstate}\u0026#34;x = \u0026#34;ok\u0026#34;x ]]; then echo \u0026#34;--1--\u0026#34; exit 0 elif [[ \u0026#34;${clusterknownnodes}\u0026#34;x != \u0026#34;1\u0026#34;x \u0026amp;\u0026amp; \u0026#34;${clusterstate}\u0026#34;x = \u0026#34;ok\u0026#34;x ]]; then echo \u0026#34;--2--\u0026#34; exit 0 # create redis cluster elif [[ \u0026#34;${clusterknownnodes}\u0026#34;x = \u0026#34;1\u0026#34;x \u0026amp;\u0026amp; \u0026#34;${clusterstate}\u0026#34;x != \u0026#34;ok\u0026#34;x ]]; then echo \u0026#34;--3--\u0026#34; exit 0 elif [[ \u0026#34;${clusterknownnodes}\u0026#34;x != \u0026#34;1\u0026#34;x \u0026amp;\u0026amp; \u0026#34;${clusterstate}\u0026#34;x != \u0026#34;ok\u0026#34;x ]]; then echo \u0026#34;--4--\u0026#34; exit 1 else echo \u0026#34;--5--\u0026#34; exit 1 fi else exit 1 fi ä¸€èˆ¬è¿™ç§æ€ªå¼‚çš„é—®é¢˜éƒ½æ˜¯è„šæœ¬é‡Œæœ‰ç‰¹æ®Šå­—ç¬¦é€ æˆçš„ï¼Œå¯ä»¥åœ¨è„šæœ¬ä¸­set listæ˜¾ç¤ºç‰¹æ®Šå­—ç¬¦ã€‚å½“ç„¶windowsä¸Šç¼–è¾‘è¿‡çš„è„šæœ¬åœ¨linuxä¸Šè¿è¡Œä¸€èˆ¬dos2unix test.shè¿™æ ·è½¬æ¢ä¸€ä¸‹æœ€å¥½ï¼Œå…çš„é‡åˆ°éº»çƒ¦ã€‚\nå‚è€ƒï¼š # shellä¸­æ‹¬å·çš„ç‰¹æ®Šç”¨æ³• linux ifå¤šæ¡ä»¶åˆ¤æ–­\nhttps://www.cnblogs.com/jjzd/p/6397495.html\nè¿è¡Œshellè„šæœ¬æ—¶æŠ¥é”™\u0026quot;[[ : not found\u0026quot;è§£å†³æ–¹æ³•\nhttps://www.cnblogs.com/han-1034683568/p/7211392.html\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E4%B8%80%E6%AC%A1%E5%86%99shell%E8%84%9A%E6%9C%AC%E7%9A%84%E7%BB%8F%E5%8E%86%E8%AE%B0%E5%BD%95%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E6%83%B9%E7%9A%84%E7%A5%B8/","section":"Posts","summary":"\u003cp\u003eredisåœ¨å®¹å™¨åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæ¶‰åŠåˆ°çºµå‘æ‰©podå®ä¾‹cpuã€å†…å­˜ä»¥åŠrediså®ä¾‹çš„maxmemoryå€¼ï¼Œstatefulsetç®¡ç†çš„podéœ€è¦é‡å¯ã€‚æ‰€ä»¥æŠŠredisé›†ç¾¤çš„çŠ¶æ€æ£€æŸ¥æ”¾åˆ°äº†å¥åº·æ£€æŸ¥ä¸­ï¼Œä¾èµ–statefulsetçš„åŸç”Ÿèƒ½åŠ›ï¼ˆpodå®ä¾‹readyåæ‰é‡å¯ä¸‹ä¸€ä¸ªï¼Œreadyåendpoints controllerå°†podä¿¡æ¯æ›´æ–°åˆ°endpointsèµ„æºå¯¹è±¡ä¸­ï¼‰,è€Œæ²¡æœ‰åœ¨redis operatorä¸­å†™é€»è¾‘å»åˆ¤æ–­ã€‚\u003c/p\u003e","title":"ä¸€æ¬¡å†™shellè„šæœ¬çš„ç»å†è®°å½•â€”â€”ç‰¹æ®Šå­—ç¬¦æƒ¹çš„ç¥¸","type":"posts"},{"content":" æ­£æ–‡ # kube-apiserver\nå¯¹å¤–æš´éœ²äº†Kubernetes APIã€‚å®ƒæ˜¯çš„ Kubernetes æ ¸å¿ƒæ§åˆ¶å±‚ã€‚å®ƒè¢«è®¾è®¡ä¸ºæ°´å¹³æ‰©å±•ï¼Œå³é€šè¿‡éƒ¨ç½²æ›´å¤šå®ä¾‹æ¥æ¨ªå‘æ‰©å±•ã€‚API Server è´Ÿè´£å’Œ etcd äº¤äº’ï¼ˆå…¶ä»–ç»„ä»¶ä¸ä¼šç›´æ¥æ“ä½œ etcdï¼Œåªæœ‰ API Server è¿™ä¹ˆåšï¼‰ï¼Œæ˜¯æ•´ä¸ª kubernetes é›†ç¾¤çš„æ•°æ®ä¸­å¿ƒï¼Œæ‰€æœ‰çš„äº¤äº’éƒ½æ˜¯ä»¥ API Server ä¸ºæ ¸å¿ƒçš„ã€‚API Server æä¾›äº†ä»¥ä¸‹çš„åŠŸèƒ½ï¼š\næ•´ä¸ªé›†ç¾¤ç®¡ç†çš„ API æ¥å£ï¼šæ‰€æœ‰å¯¹é›†ç¾¤è¿›è¡Œçš„æŸ¥è¯¢å’Œç®¡ç†éƒ½è¦é€šè¿‡ API æ¥è¿›è¡Œã€‚\né›†ç¾¤å†…éƒ¨å„ä¸ªæ¨¡å—ä¹‹é—´é€šä¿¡çš„æ¢çº½ï¼šæ‰€æœ‰æ¨¡å—ä¹‹é—´å¹¶ä¸ä¼šäº’ç›¸è°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡å’Œ API Server æ‰“äº¤é“æ¥å®Œæˆå„è‡ªçš„å·¥ä½œã€‚\né›†ç¾¤å®‰å…¨æ§åˆ¶ï¼šAPI Server æä¾›çš„éªŒè¯å’Œæˆæƒä¿è¯äº†æ•´ä¸ªé›†ç¾¤çš„å®‰å…¨ã€‚\nkube-controller-managerå’Œkube-schedulerçš„é«˜å¯ç”¨é€‰ä¸»æœºåˆ¶\nhttps://blog.csdn.net/weixin_39961559/article/details/81877056\nåœ¨k8sçš„ç»„ä»¶ä¸­ï¼Œå…¶ä¸­æœ‰kube-schedulerå’Œkube-controller-managerä¸¤ä¸ªç»„ä»¶æ˜¯æœ‰leaderé€‰ä¸¾çš„ï¼Œè¿™ä¸ªé€‰ä¸¾æœºåˆ¶æ˜¯k8så¯¹äºè¿™ä¸¤ä¸ªç»„ä»¶çš„é«˜å¯ç”¨ä¿éšœã€‚éœ€è¦\u0026ndash;leader-elect=trueå¯åŠ¨å‚æ•°ã€‚å³æ­£å¸¸æƒ…å†µä¸‹kube-scheduleræˆ–kube-manager-controllerç»„ä»¶çš„å¤šä¸ªå‰¯æœ¬åªæœ‰ä¸€ä¸ªæ˜¯å¤„äºä¸šåŠ¡é€»è¾‘è¿è¡ŒçŠ¶æ€ï¼Œå…¶å®ƒå‰¯æœ¬åˆ™ä¸æ–­çš„å°è¯•å»è·å–é”ï¼Œå»ç«äº‰leaderï¼Œç›´åˆ°è‡ªå·±æˆä¸ºleaderã€‚å¦‚æœæ­£åœ¨è¿è¡Œçš„leaderå› æŸç§åŸå› å¯¼è‡´å½“å‰è¿›ç¨‹é€€å‡ºï¼Œæˆ–è€…é”ä¸¢å¤±ï¼Œåˆ™ç”±å…¶å®ƒå‰¯æœ¬å»ç«äº‰æ–°çš„leaderï¼Œè·å–leaderç»§è€Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚\nåœ¨K8sä¸­ï¼Œ é€šè¿‡åˆ›å»ºèµ„æºå¯¹è±¡ï¼ˆå½“å‰çš„å®ç°ä¸­å®ç°äº† ConfigMap å’Œ Endpoint ä¸¤ç§ç±»å‹çš„èµ„æºï¼‰æ¥ç»´æŠ¤é”çš„çŠ¶æ€ã€‚è¿™ä¸¤ç§èµ„æºå¯¹è±¡å­˜åœ¨etcdé‡Œï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ç”¨etcdæ¥å®ç°çš„ã€‚\nåˆ†å¸ƒå¼é”ä¸€èˆ¬å®ç°åŸç†å°±æ˜¯å¤§å®¶å…ˆå»æŠ¢é”ï¼ŒæŠ¢åˆ°çš„æˆä¸º leader ï¼Œç„¶å leader ä¼šå®šæœŸæ›´æ–°é”çš„çŠ¶æ€ï¼Œå£°æ˜è‡ªå·±çš„æ´»åŠ¨çŠ¶æ€ï¼Œä¸è®©å…¶ä»–äººæŠŠé”æŠ¢èµ°ã€‚K8s çš„èµ„æºé”ä¹Ÿç±»ä¼¼ï¼ŒæŠ¢åˆ°é”çš„èŠ‚ç‚¹ä¼šå°†è‡ªå·±çš„æ ‡è®°ã€‚è®¾ä¸ºé”çš„æŒæœ‰è€…ï¼Œå…¶ä»–äººåˆ™éœ€è¦é€šè¿‡å¯¹æ¯”é”çš„æ›´æ–°æ—¶é—´å’ŒæŒæœ‰è€…æ¥åˆ¤æ–­è‡ªå·±æ˜¯å¦èƒ½æˆä¸ºæ–°çš„ leader ï¼Œè€Œ leader åˆ™å¯ä»¥é€šè¿‡æ›´æ–°RenewTimeæ¥ç¡®ä¿æŒç»­ä¿æœ‰è¯¥é”ã€‚\nä¸»è¦è°ƒç”¨client-goåŒ…ä¸­çš„ï¼š\nk8s.io/client-go/tools/leaderelection\næ€»å…±æœ‰7ä¸ªleaderé€‰ä¸¾å‚æ•°ï¼š\nlock-object-namespaceå’Œlock-object-nameæ˜¯é”å¯¹è±¡çš„å‘½åç©ºé—´å’Œåç§°ã€‚\nleader-electè¡¨ç¤ºè¯¥ç»„ä»¶è¿è¡Œæ—¶æ˜¯å¦éœ€è¦leaderé€‰ä¸¾(å¦‚æœé›†ç¾¤ä¸­è¿è¡Œå¤šå‰¯æœ¬ï¼Œéœ€è¦è®¾ç½®è¯¥é€‰é¡¹ä¸ºtrueï¼Œå¦åˆ™æ¯ä¸ªå‰¯æœ¬éƒ½å°†å‚ä¸å®é™…å·¥ä½œ)ã€‚\nleader-elect-lease-durationä¸ºèµ„æºé”ç§Ÿçº¦è§‚å¯Ÿæ—¶é—´ï¼Œå¦‚æœå…¶å®ƒç«äº‰è€…åœ¨è¯¥æ—¶é—´é—´éš”è¿‡åå‘ç°leaderæ²¡æ›´æ–°è·å–é”æ—¶é—´ï¼Œåˆ™å…¶å®ƒå‰¯æœ¬å¯ä»¥è®¤ä¸ºleaderå·²ç»æŒ‚æ‰ä¸å‚ä¸å·¥ä½œäº†ï¼Œå°†é‡æ–°é€‰ä¸¾leaderã€‚\nleader-elect-renew-deadline leaderåœ¨è¯¥æ—¶é—´å†…æ²¡æœ‰æ›´æ–°åˆ™å¤±å»leaderèº«ä»½ã€‚\nleader-elect-retry-periodä¸ºå…¶å®ƒå‰¯æœ¬è·å–é”çš„æ—¶é—´é—´éš”(ç«äº‰leader)å’Œleaderæ›´æ–°é—´éš”ã€‚\nleader-elect-resource-lockæ˜¯k8såˆ†å¸ƒå¼èµ„æºé”çš„èµ„æºå¯¹è±¡ï¼Œç›®å‰åªæ”¯æŒendpointså’Œconfigmapsã€‚\netcd\nEtcdä½¿ç”¨çš„æ˜¯raftä¸€è‡´æ€§ç®—æ³•æ¥å®ç°çš„ï¼Œæ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼çš„ä¸€è‡´æ€§KVå­˜å‚¨ï¼Œä¸»è¦ç”¨äºå…±äº«é…ç½®å’ŒæœåŠ¡å‘ç°ã€‚ç”¨äº Kubernetes çš„åç«¯å­˜å‚¨ã€‚æ‰€æœ‰é›†ç¾¤æ•°æ®éƒ½å­˜å‚¨åœ¨æ­¤å¤„ï¼ŒETCDåœ¨k8sæŠ€æœ¯æ ˆçš„åœ°ä½ï¼Œå°±ä»¿ä½›æ•°æ®åº“ï¼ˆMysqlã€Postgresqlæˆ–oracleç­‰ï¼‰åœ¨Webåº”ç”¨ä¸­çš„åœ°ä½ï¼Œå®ƒå­˜å‚¨äº†k8sé›†ç¾¤ä¸­æ‰€æœ‰çš„å…ƒæ•°æ®ï¼ˆä»¥key-valueçš„æ–¹å¼ï¼‰ã€‚æ•´ä¸ªkubernetesç³»ç»Ÿéœ€è¦ç”¨åˆ°etcdç”¨æ¥ååŒå’Œå­˜å‚¨é…ç½®çš„æœ‰ï¼š\nç½‘ç»œæ’ä»¶flannelã€calicoç­‰ç½‘ç»œæ’ä»¶ä¹Ÿéœ€è¦ç”¨åˆ°etcdå­˜å‚¨ç½‘ç»œçš„é…ç½®ä¿¡æ¯\nkubernetesæœ¬èº«ï¼ŒåŒ…æ‹¬å„ç§å¯¹è±¡çš„çŠ¶æ€å’Œå…ƒä¿¡æ¯é…ç½®\n**æ³¨æ„ï¼š**flannelæ“ä½œetcdä½¿ç”¨çš„æ˜¯v2çš„APIï¼Œè€Œkubernetesæ“ä½œetcdä½¿ç”¨çš„v3çš„APIï¼Œæ‰€ä»¥åœ¨ä¸‹é¢æˆ‘ä»¬æ‰§è¡Œetcdctlçš„æ—¶å€™éœ€è¦è®¾ç½®ETCDCTL_APIç¯å¢ƒå˜é‡ï¼Œè¯¥å˜é‡é»˜è®¤å€¼ä¸º2ã€‚\nK8sä¸­æ‰€æœ‰å…ƒæ•°æ®çš„å¢åˆ æ”¹æŸ¥éƒ½æ˜¯ç”±kube-apiserveræ¥æ‰§è¡Œçš„ã€‚ETCDä¸­keyå€¼é€šè¿‡è§‚å¯Ÿå¯ä»¥ç®€å•å¾—å‡ºä¸‹é¢å‡ ä¸ªè§„å¾‹ï¼š\nk8sä¸»è¦æŠŠè‡ªå·±çš„æ•°æ®æ³¨å†Œåœ¨/registry/å‰ç¼€ä¸‹é¢ï¼ˆåœ¨ETCD-v3ç‰ˆæœ¬åæ²¡æœ‰äº†ç›®å½•çš„æ¦‚å¿µï¼Œåªèƒ½ä¸€åˆ‡çš†å‰ç¼€äº†ï¼‰ã€‚é€šè¿‡è§‚å¯Ÿk8sä¸­deploymentã€namespaceã€podç­‰åœ¨ETCDä¸­çš„è¡¨ç¤ºï¼Œå¯ä»¥çŸ¥é“è¿™éƒ¨åˆ†èµ„æºçš„keyçš„æ ¼å¼ä¸º/registry/{k8så¯¹è±¡}/{å‘½åç©ºé—´}/{å…·ä½“å®ä¾‹å}ã€‚\nkube-controller-manager\nkube-controller-managerè¿è¡Œæ§åˆ¶å™¨ï¼Œå®ƒä»¬æ˜¯å¤„ç†é›†ç¾¤ä¸­å¸¸è§„ä»»åŠ¡çš„åå°çº¿ç¨‹ã€‚é€»è¾‘ä¸Šï¼Œæ¯ä¸ªæ§åˆ¶å™¨æ˜¯ä¸€ä¸ªå•ç‹¬çš„åç¨‹ã€‚ç”¨äºç›‘è§† apiserver æš´éœ²çš„é›†ç¾¤çŠ¶æ€ï¼Œå¹¶ä¸”ä¸æ–­åœ°å°è¯•æŠŠå½“å‰çŠ¶æ€å‘é›†ç¾¤çš„ç›®æ ‡çŠ¶æ€è¿ç§»ã€‚ä¸ºäº†é¿å…é¢‘ç¹æŸ¥è¯¢ apiserverï¼Œapiserver æä¾›äº† watch æ¥å£ç”¨äºç›‘è§†èµ„æºçš„å¢åŠ åˆ é™¤å’Œæ›´æ–°ï¼Œclient-go å¯¹æ­¤ä½œäº†æŠ½è±¡ï¼Œå°è£…ä¸€å±‚ informer æ¥è¡¨ç¤ºæœ¬åœ° apiserver çŠ¶æ€çš„ cache ã€‚\nå‚è€ƒ:\nhttps://blog.csdn.net/huwh_/article/details/75675761\nè¿™äº›æ§åˆ¶å™¨åŒ…æ‹¬:\nèŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆnode-controllerï¼‰: kubeletåœ¨å¯åŠ¨æ—¶ä¼šé€šè¿‡API Serveræ³¨å†Œè‡ªèº«çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¹¶å®šæ—¶å‘API Serveræ±‡æŠ¥çŠ¶æ€ä¿¡æ¯ï¼ŒAPI Serveræ¥æ”¶åˆ°ä¿¡æ¯åå°†ä¿¡æ¯æ›´æ–°åˆ°etcdä¸­ã€‚Node Controlleré€šè¿‡API Serverå®æ—¶è·å–Nodeçš„ç›¸å…³ä¿¡æ¯ï¼Œå®ç°ç®¡ç†å’Œç›‘æ§é›†ç¾¤ä¸­çš„å„ä¸ªNodeèŠ‚ç‚¹çš„ç›¸å…³æ§åˆ¶åŠŸèƒ½ã€‚\nå‰¯æœ¬æ§åˆ¶å™¨ï¼ˆReplication Controllerï¼‰: è´Ÿè´£ç»´æŠ¤ç³»ç»Ÿä¸­æ¯ä¸ªå‰¯æœ¬æ§åˆ¶å™¨å¯¹è±¡æ­£ç¡®æ•°é‡çš„ Podã€‚å‰¯æœ¬æ§åˆ¶å™¨çš„ä½œç”¨å³ä¿è¯é›†ç¾¤ä¸­ä¸€ä¸ªRCæ‰€å…³è”çš„Podå‰¯æœ¬æ•°å§‹ç»ˆä¿æŒé¢„è®¾å€¼ã€‚åªæœ‰å½“Podçš„é‡å¯ç­–ç•¥æ˜¯Alwaysçš„æ—¶å€™ï¼ˆRestartPolicy=Alwaysï¼‰ï¼Œå‰¯æœ¬æ§åˆ¶å™¨æ‰ä¼šç®¡ç†è¯¥Podçš„æ“ä½œï¼ˆåˆ›å»ºã€é”€æ¯ã€é‡å¯ç­‰ï¼‰ã€‚\n**æœåŠ¡å¸æˆ·å’Œä»¤ç‰Œæ§åˆ¶å™¨ï¼ˆServiceAccount Controller ï¼‰: **ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œã€‚\n**èµ„æºé…é¢ç®¡ç†æ§åˆ¶å™¨ResourceQuota Controllerï¼š**èµ„æºé…é¢ç®¡ç†ç¡®ä¿æŒ‡å®šçš„èµ„æºå¯¹è±¡åœ¨ä»»ä½•æ—¶å€™éƒ½ä¸ä¼šè¶…é‡å ç”¨ç³»ç»Ÿç‰©ç†èµ„æºã€‚æ”¯æŒä¸‰ä¸ªå±‚æ¬¡çš„èµ„æºé…ç½®ç®¡ç†ï¼š\nå®¹å™¨çº§åˆ«ï¼šå¯¹CPUå’ŒMemoryè¿›è¡Œé™åˆ¶;\nPodçº§åˆ«ï¼šå¯¹ä¸€ä¸ªPodå†…æ‰€æœ‰å®¹å™¨çš„å¯ç”¨èµ„æºè¿›è¡Œé™åˆ¶;\nNamespaceçº§åˆ«ï¼šåŒ…æ‹¬Podæ•°é‡ã€Replication Controlleræ•°é‡ã€Serviceæ•°é‡ã€ResourceQuotaæ•°é‡ã€Secretæ•°é‡ã€å¯æŒæœ‰çš„PVï¼ˆPersistent Volumeï¼‰æ•°é‡\nNamespace Controllerï¼šç”¨æˆ·é€šè¿‡API Serverå¯ä»¥åˆ›å»ºæ–°çš„Namespaceå¹¶ä¿å­˜åœ¨etcdä¸­ï¼ŒNamespaceControllerå®šæ—¶é€šè¿‡API Serverè¯»å–è¿™äº›Namespaceä¿¡æ¯ã€‚å¦‚æœNamespaceè¢«APIæ ‡è®°ä¸ºä¼˜é›…åˆ é™¤ï¼ˆå³è®¾ç½®åˆ é™¤æœŸé™ï¼ŒDeletionTimestampï¼‰,åˆ™å°†è¯¥NamespaceçŠ¶æ€è®¾ç½®ä¸ºâ€œTerminatingâ€,å¹¶ä¿å­˜åˆ°etcdä¸­ã€‚åŒæ—¶Namespace Controlleråˆ é™¤è¯¥Namespaceä¸‹çš„ServiceAccountã€RCã€Podç­‰èµ„æºå¯¹è±¡ã€‚\nService Controllerï¼šå±äºkubernetesé›†ç¾¤ä¸å¤–éƒ¨çš„äº‘å¹³å°ä¹‹é—´çš„ä¸€ä¸ªæ¥å£æ§åˆ¶å™¨ã€‚Service Controllerç›‘å¬Serviceå˜åŒ–ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªLoadBalancerç±»å‹çš„Serviceï¼Œåˆ™ç¡®ä¿å¤–éƒ¨çš„äº‘å¹³å°ä¸Šå¯¹è¯¥Serviceå¯¹åº”çš„LoadBalancerå®ä¾‹è¢«ç›¸åº”åœ°åˆ›å»ºã€åˆ é™¤åŠæ›´æ–°è·¯ç”±è½¬å‘è¡¨ã€‚\ndeployment controllerï¼šç”¨æ¥æ›¿ä»£ä»¥å‰çš„ReplicationControlleræ¥æ–¹ä¾¿çš„ç®¡ç†åº”ç”¨ã€‚åªéœ€è¦åœ¨ Deployment ä¸­æè¿°æ‚¨æƒ³è¦çš„ç›®æ ‡çŠ¶æ€æ˜¯ä»€ä¹ˆï¼ŒDeployment controller å°±ä¼šå¸®æ‚¨å°† Pod å’ŒReplicaSet çš„å®é™…çŠ¶æ€æ”¹å˜åˆ°æ‚¨çš„ç›®æ ‡çŠ¶æ€ã€‚æ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ªå…¨æ–°çš„ Deployment æ¥åˆ›å»º ReplicaSet æˆ–è€…åˆ é™¤å·²æœ‰çš„ Deployment å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„æ¥æ›¿æ¢ã€‚\nå®šä¹‰Deploymentæ¥åˆ›å»ºPodå’ŒReplicaSet\næ»šåŠ¨å‡çº§å’Œå›æ»šåº”ç”¨\næ‰©å®¹å’Œç¼©å®¹\næš‚åœå’Œè¿è¡ŒDeployment\nstatefulset controllerï¼šStatefulSetæ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ï¼ˆå¯¹åº”Deploymentså’ŒReplicaSetsæ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œå…¶åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š\nç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³Podé‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäºPVCæ¥å®ç°;\nç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼Œå³Podé‡æ–°è°ƒåº¦åå…¶PodNameå’ŒHostNameä¸å˜ï¼ŒåŸºäºHeadless Serviceï¼ˆå³æ²¡æœ‰Cluster IPçš„Serviceï¼‰æ¥å®ç°ã€‚StatefulSetä¸­æ¯ä¸ªPodçš„DNSæ ¼å¼ä¸ºï¼š\nstatefulSetPodName-{0..N-1}.serviceName.namespace.svc.cluster.local æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼Œå³Podæ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡ä¾æ¬¡è¿›è¡Œï¼ˆå³ä»0åˆ°N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ªPodè¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„Podå¿…é¡»éƒ½æ˜¯Runningå’ŒReadyçŠ¶æ€ï¼‰ï¼ŒåŸºäºinit containersæ¥å®ç°ï¼›\næœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼ˆå³ä»N-1åˆ°0ï¼‰\ndaemonset controllerï¼šDaemonSetç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–è€…ä¸€äº›ï¼‰Node ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å‰¯æœ¬ã€‚å½“æœ‰ Node åŠ å…¥é›†ç¾¤æ—¶ï¼Œä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ª Pod ã€‚å½“æœ‰ Node ä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº› Pod ä¹Ÿä¼šè¢«å›æ”¶ã€‚åˆ é™¤ DaemonSet å°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ Podã€‚\nHorizontal Pod Autoscalingï¼šä»…é€‚ç”¨äºDeploymentå’ŒReplicaSetï¼Œåœ¨V1ç‰ˆæœ¬ä¸­ä»…æ”¯æŒæ ¹æ®Podçš„CPUåˆ©ç”¨ç‡æ‰©æ‰€å®¹ï¼Œåœ¨v1alphaç‰ˆæœ¬ä¸­ï¼Œæ”¯æŒæ ¹æ®å†…å­˜å’Œç”¨æˆ·è‡ªå®šä¹‰çš„metricæ‰©ç¼©å®¹ã€‚\npersistentvolume-binderï¼šå®šæœŸåŒæ­¥ç£ç›˜å·æŒ‚è½½ä¿¡æ¯ï¼Œè´Ÿè´£pvå’Œpvcçš„ç»‘å®šã€‚\nEndpoints controllerï¼šè¡¨ç¤ºäº†ä¸€ä¸ªServiceå¯¹åº”çš„æ‰€æœ‰Podå‰¯æœ¬çš„è®¿é—®åœ°å€ï¼Œè€ŒEndpointsControllerè´Ÿè´£ç”Ÿæˆå’Œç»´æŠ¤æ‰€æœ‰Endpointså¯¹è±¡çš„æ§åˆ¶å™¨ã€‚å®ƒè´Ÿè´£ç›‘å¬Serviceå’Œå¯¹åº”çš„Podå‰¯æœ¬çš„å˜åŒ–ã€‚\nå¦‚æœç›‘æµ‹åˆ°Serviceè¢«åˆ é™¤ï¼Œåˆ™åˆ é™¤å’Œè¯¥ServiceåŒåçš„Endpointså¯¹è±¡ï¼›\nå¦‚æœç›‘æµ‹åˆ°æ–°çš„Serviceè¢«åˆ›å»ºæˆ–ä¿®æ”¹ï¼Œåˆ™æ ¹æ®è¯¥Serviceä¿¡æ¯è·å¾—ç›¸å…³çš„Podåˆ—è¡¨ï¼Œç„¶ååˆ›å»ºæˆ–æ›´æ–°Serviceå¯¹åº”çš„Endpointså¯¹è±¡;\nå¦‚æœç›‘æµ‹åˆ°Podçš„äº‹ä»¶ï¼Œåˆ™æ›´æ–°å®ƒå¯¹åº”çš„Serviceçš„Endpointså¯¹è±¡ã€‚\nkube-proxyè¿›ç¨‹è·å–æ¯ä¸ªServiceçš„Endpointsï¼Œå®ç°Serviceçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚\nä»¥ä¸Šåªæ˜¯éƒ¨åˆ†æ§åˆ¶å™¨ï¼Œéƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åç¨‹ï¼Œè¢«controller-managerè¿™ä¸ªè¿›ç¨‹æ‰€ç®¡ç†ã€‚\nStatefulsetå’ŒDeploymentçš„åŒºåˆ«\nDeploymentç”¨äºéƒ¨ç½²æ— çŠ¶æ€æœåŠ¡ï¼ŒStatefulSetç”¨æ¥éƒ¨ç½²æœ‰çŠ¶æ€æœåŠ¡ã€‚\nå¦‚æœéƒ¨ç½²çš„åº”ç”¨æ»¡è¶³ä»¥ä¸‹ä¸€ä¸ªæˆ–å¤šä¸ªéƒ¨ç½²éœ€æ±‚ï¼Œåˆ™å»ºè®®ä½¿ç”¨StatefulSetã€‚\nç¨³å®šçš„ã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†;\nç¨³å®šçš„ã€æŒä¹…çš„å­˜å‚¨;\næœ‰åºçš„ã€ä¼˜é›…çš„éƒ¨ç½²å’Œä¼¸ç¼©;\næœ‰åºçš„ã€ä¼˜é›…çš„åˆ é™¤å’Œåœæ­¢;\næœ‰åºçš„ã€è‡ªåŠ¨çš„æ»šåŠ¨æ›´æ–°;\nå®ç°å›ºå®šçš„Pod IPæ–¹æ¡ˆ, å¯ä»¥ä¼˜å…ˆè€ƒè™‘åŸºäºStatefulSet\n**ç¨³å®šçš„ï¼š**ä¸»è¦æ˜¯é’ˆå¯¹Podå‘ç”Ÿre-scheduleåä»ç„¶è¦ä¿æŒä¹‹å‰çš„ç½‘ç»œæ ‡è¯†å’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚è¿™é‡Œæ‰€è¯´çš„ç½‘ç»œæ ‡è¯†åŒ…æ‹¬hostnameã€é›†ç¾¤å†…DNSä¸­è¯¥Podå¯¹åº”çš„A Recordï¼Œå¹¶ä¸èƒ½ä¿è¯Pod re-scheduleä¹‹åIPä¸å˜ã€‚è¦æƒ³ä¿æŒPod IPä¸å˜ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ç¨³å®šçš„Pod hostnameå®šåˆ¶IPAMè·å–å›ºå®šçš„Pod IPã€‚å€ŸåŠ©StatefulSetçš„ç¨³å®šçš„å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç‰¹æ€§ï¼Œæˆ‘ä»¬èƒ½æ¯”è¾ƒè½»æ¾çš„å®ç°Podçš„å›ºå®šIPéœ€æ±‚ï¼Œç„¶åå¦‚æœä½¿ç”¨Deploymentï¼Œé‚£ä¹ˆå°†ä¼šå¤æ‚çš„å¤šï¼Œä½ éœ€è¦è€ƒè™‘æ»šåŠ¨æ›´æ–°çš„è¿‡ç¨‹ä¸­çš„å‚æ•°æ§åˆ¶(maxSurgeã€maxUnavailable)ã€æ¯ä¸ªåº”ç”¨çš„IPæ± é¢„ç•™é€ æˆçš„IPæµªè´¹ç­‰ç­‰é—®é¢˜ã€‚\n**å­˜å‚¨ï¼š**StatefulSetå¯¹åº”Podçš„å­˜å‚¨æœ€å¥½é€šè¿‡StorageClassæ¥åŠ¨æ€åˆ›å»ºï¼šæ¯ä¸ªPodéƒ½ä¼šæ ¹æ®StatefulSetä¸­å®šä¹‰çš„VolumeClaimTemplateæ¥åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„PVCï¼Œç„¶åPVSé€šè¿‡StorageClassè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„PVï¼Œå¹¶æŒ‚è½½ç»™Podã€‚æ‰€ä»¥è¿™ç§æ–¹å¼ï¼Œéœ€è¦äº‹å…ˆåˆ›å»ºå¥½å¯¹åº”çš„StorageClassã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡é¢„å…ˆç”±ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºå¥½å¯¹åº”çš„PVï¼Œåªè¦èƒ½ä¿è¯è‡ªåŠ¨åˆ›å»ºçš„PVCèƒ½å’Œè¿™äº›PVåŒ¹é…ä¸Šã€‚\nä¸ºäº†æ•°æ®å®‰å…¨ï¼Œå½“åˆ é™¤StatefulSetä¸­Podsæˆ–è€…å¯¹StatefulSetè¿›è¡Œç¼©å®¹æ—¶ï¼ŒKuberneteså¹¶ä¸ä¼šè‡ªåŠ¨åˆ é™¤StatefulSetå¯¹åº”çš„PVï¼Œè€Œä¸”è¿™äº›PVé»˜è®¤ä¹Ÿä¸èƒ½è¢«å…¶ä»–PVC Boundã€‚å½“ä½ ç¡®è®¤æ•°æ®æ— ç”¨ä¹‹åå†æ‰‹åŠ¨å»åˆ é™¤PVçš„æ—¶å€™ï¼Œæ•°æ®æ˜¯å¦åˆ é™¤å–å†³äºPVçš„ReclaimPolicyé…ç½®ã€‚Reclaim Policyæ”¯æŒä»¥ä¸‹ä¸‰ç§ï¼š\nRetainï¼Œæ„å‘³ç€éœ€è¦ä½ æ‰‹åŠ¨æ¸…ç†ï¼›\nRecycleï¼Œç­‰åŒäºrm -rf /thevolume/*\nDeleteï¼Œé»˜è®¤å€¼ï¼Œä¾èµ–äºåç«¯çš„å­˜å‚¨ç³»ç»Ÿè‡ªå·±å®ç°ã€‚\néƒ¨ç½²å’Œä¼¸ç¼©æ—¶ä¸Deploymentçš„åŒºåˆ«\nå½“éƒ¨ç½²æœ‰Nä¸ªå‰¯æœ¬çš„StatefulSetåº”ç”¨æ—¶ï¼Œä¸¥æ ¼æŒ‰ç…§indexä»0åˆ°N-1çš„é€’å¢é¡ºåºåˆ›å»ºï¼Œä¸‹ä¸€ä¸ªPodåˆ›å»ºå¿…é¡»æ˜¯å‰ä¸€ä¸ªPod Readyä¸ºå‰æã€‚\nå½“åˆ é™¤æœ‰Nä¸ªå‰¯æœ¬çš„StatefulSetåº”ç”¨æ—¶ï¼Œä¸¥æ ¼æŒ‰ç…§indexä»N-1åˆ°0çš„é€’å‡é¡ºåºåˆ é™¤ï¼Œä¸‹ä¸€ä¸ªPodåˆ é™¤å¿…é¡»æ˜¯å‰ä¸€ä¸ªPod shutdownå¹¶å®Œå…¨åˆ é™¤ä¸ºå‰æã€‚\nå½“æ‰©å®¹StatefulSetåº”ç”¨æ—¶ï¼Œæ¯æ–°å¢ä¸€ä¸ªPodå¿…é¡»æ˜¯å‰ä¸€ä¸ªPod Readyä¸ºå‰æã€‚\nå½“ç¼©å®¹StatefulSetåº”ç”¨æ—¶ï¼Œæ²¡åˆ é™¤ä¸€ä¸ªPodå¿…é¡»æ˜¯å‰ä¸€ä¸ªPod shutdownå¹¶æˆåŠŸåˆ é™¤ä¸ºå‰æã€‚\nkube-scheduler\nkube-schedulerç›‘è§†æ²¡æœ‰åˆ†é…èŠ‚ç‚¹çš„æ–°åˆ›å»ºçš„ Podï¼Œé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ä¾›ä»–ä»¬è¿è¡Œã€‚è°ƒåº¦èŠ‚ç‚¹åˆ†é…ä¸»è¦å¯ä»¥åˆ†ä¸ºé¢„é€‰ï¼ˆPredicatesï¼‰ä¸ä¼˜é€‰ï¼ˆPrioritiesï¼‰ä¸¤ä¸ªç¯èŠ‚ï¼š\né¢„é€‰\næ ¹æ®é…ç½®çš„PredicatesPoliciesï¼ˆé»˜è®¤ä¸ºDefaultProviderä¸­å®šä¹‰çš„default predicates policiesé›†åˆï¼‰è¿‡æ»¤æ‰é‚£äº›ä¸æ»¡è¶³è¿™äº›Policies çš„ Nodeï¼Œé¢„é€‰çš„è¾“å‡ºä½œä¸ºä¼˜é€‰çš„è¾“å…¥ï¼›\nä¼˜é€‰\næ ¹æ®é…ç½®çš„PrioritiesPoliciesï¼ˆé»˜è®¤ä¸ºDefaultProviderä¸­å®šä¹‰çš„default priorities policiesé›†åˆï¼‰ç»™é¢„é€‰åçš„ Node è¿›è¡Œæ‰“åˆ†æ’åï¼Œå¾—åˆ†æœ€é«˜çš„ Node å³ä½œä¸ºæœ€é€‚åˆçš„ Node ï¼Œè¯¥ Pod å°±ç»‘å®šï¼ˆBindï¼‰åˆ°è¿™ä¸ª Node ã€‚\n**æ³¨ï¼š**å¦‚æœç»è¿‡ä¼˜é€‰å°† Node æ‰“åˆ†æ’ååï¼Œæœ‰å¤šä¸ª Node å¹¶åˆ—å¾—åˆ†æœ€é«˜ï¼Œé‚£ä¹ˆkube-schedulerå°†éšæœºä»ä¸­é€‰æ‹©ä¸€ä¸ª Node ä½œä¸ºç›®æ ‡ Node ã€‚\né¢„é€‰é˜¶æ®µç®—æ³•\nNoDiskConflictï¼šè¯„ä¼°æ˜¯å¦å­˜åœ¨volumeå†²çªã€‚å¦‚æœè¯¥ volume å·²ç» mount è¿‡äº†ï¼Œk8så¯èƒ½ä¼šä¸å…è®¸é‡å¤mount(å–å†³äºvolumeç±»å‹)ï¼›\nNoVolumeZoneConflictï¼šè¯„ä¼°è¯¥èŠ‚ç‚¹ä¸Šæ˜¯å¦å­˜åœ¨ Pod è¯·æ±‚çš„ volumeï¼›\nPodFitsResourcesï¼šæ£€æŸ¥èŠ‚ç‚¹å‰©ä½™èµ„æº(CPUã€å†…å­˜)æ˜¯å¦èƒ½æ»¡è¶³ Pod çš„éœ€æ±‚ã€‚å‰©ä½™èµ„æº=æ€»å®¹é‡-æ‰€æœ‰ Pod è¯·æ±‚çš„èµ„æºï¼›\nMatchNodeSelectorï¼šåˆ¤æ–­æ˜¯å¦æ»¡è¶³ Pod è®¾ç½®çš„ NodeSelectorï¼›\nCheckNodeMemoryPressureï¼šæ£€æŸ¥ Pod æ˜¯å¦å¯ä»¥è°ƒåº¦åˆ°å­˜åœ¨å†…å­˜å‹åŠ›çš„èŠ‚ç‚¹ï¼›\nCheckNodeDiskPressureï¼šæ£€æŸ¥ Pod æ˜¯å¦å¯ä»¥è°ƒåº¦åˆ°å­˜åœ¨ç¡¬ç›˜å‹åŠ›çš„èŠ‚ç‚¹ï¼›\nä¼˜é€‰é˜¶æ®µç®—æ³•\nä¾æ¬¡è®¡ç®—è¯¥ Pod è¿è¡Œåœ¨æ¯ä¸€ä¸ª Node ä¸Šçš„å¾—åˆ†ã€‚ä¸»è¦ç®—æ³•æœ‰ï¼š\nLeastRequestedPriorityï¼šæœ€ä½è¯·æ±‚ä¼˜å…ˆçº§ï¼Œå³ Node ä½¿ç”¨ç‡è¶Šä½ï¼Œå¾—åˆ†è¶Šé«˜ï¼›\nBalancedResourceAllocationï¼šèµ„æºå¹³è¡¡åˆ†é…ï¼Œå³CPU/å†…å­˜é…æ¯”åˆé€‚çš„ Node å¾—åˆ†æ›´é«˜ï¼›\nSelectorSpreadPriorityï¼šå°½é‡å°†åŒä¸€ RC/Replica çš„å¤šä¸ª Pod åˆ†é…åˆ°ä¸åŒçš„ Node ä¸Šï¼›\nCalculateAntiAffinityPriorityï¼šå°½é‡å°†åŒä¸€ Service ä¸‹çš„å¤šä¸ªç›¸åŒ Label çš„ Pod åˆ†é…åˆ°ä¸åŒçš„ Nodeï¼›\nImageLocalityPriorityï¼šImageæœ¬åœ°ä¼˜å…ˆï¼ŒNode ä¸Šå¦‚æœå·²ç»å­˜åœ¨ Pod éœ€è¦çš„é•œåƒï¼Œå¹¶ä¸”é•œåƒè¶Šå¤§ï¼Œå¾—åˆ†è¶Šé«˜ï¼Œä»è€Œå‡å°‘ Pod æ‹‰å–é•œåƒçš„å¼€é”€(æ—¶é—´)ï¼›\nNodeAffinityPriorityï¼šæ ¹æ®äº²å’Œæ€§æ ‡ç­¾è¿›è¡Œé€‰æ‹©ï¼›\né»˜è®¤çš„é¢„é€‰ã€ä¼˜é€‰è°ƒåº¦ç®—æ³•è¿œä¸æ­¢ä»¥ä¸Šè¿™äº›ã€‚å¯ä»¥é€šè¿‡kube-schedulerçš„å¯åŠ¨å‚æ•°ä¸­åŠ policy-config-fileæ–‡ä»¶ã€configmapsï¼ˆè¿‡æ—¶ï¼‰ã€æˆ–è€…\u0026ndash;configæŒ‡å®šè°ƒåº¦å™¨ç”¨å“ªäº›é¢„é€‰ã€ä¼˜é€‰ç®—æ³•ã€‚\nè°ƒåº¦ç®—æ³•çš„æ‰©å±•\nå¦‚æœkube-scheduleræä¾›çš„è°ƒåº¦ç®—æ³•ä¸æ»¡è¶³è°ƒåº¦è¦æ±‚ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å¼€å‘æ‰©å±•è°ƒåº¦å™¨ï¼Œåœ¨kube-schedulerå¯åŠ¨å‚æ•°çš„policy-configä¸­æŒ‡å®šæ‰©å±•è°ƒåº¦å™¨çš„åœ°å€ï¼ŒåŒ…æ‹¬ï¼ˆé¢„é€‰æ¥å£ã€ä¼˜é€‰æ¥å£ã€ä¼˜å…ˆçº§æŠ¢å ï¼Œpodå’Œnodeç»‘å®šçš„Bindæ¥å£ï¼‰ã€‚\næ‰©å±•è°ƒåº¦å™¨ç¤ºä¾‹ä»£ç ï¼š\nhttps://github.com/smallersoup/k8s-scheduler-extender-example\nç”±äºé»˜è®¤è°ƒåº¦å™¨kube-scheduleréœ€è¦è°ƒç”¨æ‰©å±•è°ƒåº¦ç¨‹åºkube-scheduler-extenderï¼Œæ•…éœ€è¦åœ¨kube-schedulerçš„å¯åŠ¨å‚æ•°é‡Œé…ç½®æ‰©å±•è°ƒåº¦å™¨çš„åœ°å€ã€‚éœ€è¦åœ¨masterèŠ‚ç‚¹ä¸»æœºçš„/etc/kubernetesç›®å½•ä¸‹çš„scheduler.yamlä¸­é…ç½®å¦‚ä¸‹å†…å®¹ï¼šï¼ˆstatic podæ–¹å¼éƒ¨ç½²çš„kube-schedulerä¸èƒ½ç”¨configmapsçš„æ–¹å¼æŒ‚è½½é…ç½®æ–‡ä»¶ï¼‰\napiVersion: kubescheduler.config.k8s.io/v1alpha1 kind: KubeSchedulerConfiguration algorithmSource: policy: file: path: /etc/kubernetes/scheduler-policy.json clientConnection: kubeconfig: /etc/kubernetes/scheduler.conf leaderElection: leaderElect: true ä¸»è¦é…ç½®æ˜¯å¦å¯ç”¨é€‰ä¸¾æœºåˆ¶ï¼Œä»¥åŠä¸API Serveräº¤äº’æ—¶è®¤è¯ç”¨çš„scheduler.confæ–‡ä»¶åœ°å€ï¼Œè°ƒåº¦ç­–ç•¥é€‰æ‹©ç”¨çš„scheduler-policy.jsonï¼š\n{ \u0026#34;kind\u0026#34;: \u0026#34;Policy\u0026#34;, \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;predicates\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;NoVolumeZoneConflict\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;MatchInterPodAffinity\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;NoDiskConflict\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;GeneralPredicates\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;PodToleratesNodeTaints\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;CheckVolumeBinding\u0026#34; } ], \u0026#34;priorities\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;SelectorSpreadPriority\u0026#34;, \u0026#34;weight\u0026#34;: 1 }, { \u0026#34;name\u0026#34;: \u0026#34;InterPodAffinityPriority\u0026#34;, \u0026#34;weight\u0026#34;: 1 }, { \u0026#34;name\u0026#34;: \u0026#34;LeastRequestedPriority\u0026#34;, \u0026#34;weight\u0026#34;: 1 }, { \u0026#34;name\u0026#34;: \u0026#34;NodeAffinityPriority\u0026#34;, \u0026#34;weight\u0026#34;: 1 }, { \u0026#34;name\u0026#34;: \u0026#34;BalancedResourceAllocation\u0026#34;, \u0026#34;weight\u0026#34;: 1 }, { \u0026#34;name\u0026#34;: \u0026#34;NodePreferAvoidPodsPriority\u0026#34;, \u0026#34;weight\u0026#34;: 10000 }, { \u0026#34;name\u0026#34;: \u0026#34;TaintTolerationPriority\u0026#34;, \u0026#34;weight\u0026#34;: 1 } ], \u0026#34;extenders\u0026#34;: [ { \u0026#34;urlPrefix\u0026#34;: \u0026#34;http://kube-scheduler-extender:80/scheduler\u0026#34;, \u0026#34;filterVerb\u0026#34;: \u0026#34;predicates/middleware_predicate\u0026#34;, \u0026#34;prioritizeVerb\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;preemptVerb\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;bindVerb\u0026#34;: \u0026#34;bind\u0026#34;, \u0026#34;weight\u0026#34;: 1, \u0026#34;enableHttps\u0026#34;: false, \u0026#34;nodeCacheCapable\u0026#34;: false } ], \u0026#34;hardPodAffinitySymmetricWeight\u0026#34;: 10, \u0026#34;alwaysCheckAllPredicates\u0026#34;: false } é‡Œé¢æŒ‡å®šäº†é»˜è®¤è°ƒåº¦å™¨ç”¨åˆ°çš„é¢„é€‰ã€ä¼˜é€‰ç®—æ³•ï¼Œä»¥åŠè°ƒç”¨æ‰©å±•è°ƒåº¦å™¨çš„serviceåœ°å€ï¼Œé¢„é€‰å’ŒBindæ¥å£URIã€‚\nåœ¨/etc/kubernetes/manifestsç›®å½•ä¸‹çš„kube-scheduler.yamlä¸­å¯åŠ¨å‚æ•°ä¸­åŠ \u0026ndash;config=/etc/kubernetes/scheduler.yamlï¼Œè¯¥æ–‡ä»¶é€šè¿‡hostPathçš„æ–¹å¼æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚\nDNS\nkube-dnsè¿™ä¸ªæ’ä»¶æ˜¯å®˜æ–¹æ¨èå®‰è£…çš„ã€‚é€šè¿‡å°† Service æ³¨å†Œåˆ° DNS ä¸­ï¼Œk8s å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›ä¸€ç§ç®€å•çš„æœåŠ¡æ³¨å†Œå‘ç°ä¸è´Ÿè½½å‡è¡¡æ–¹å¼ã€‚\nkube-dnså†…éƒ¨é€šè¿‡ç›‘å¬serviceså’Œendpointsçš„å˜æ›´äº‹ä»¶å°†åŸŸåå’ŒIPå¯¹åº”ä¿¡æ¯åŒæ­¥åˆ°æœ¬åœ°ç¼“å­˜ã€‚æ¯”å¦‚æœåŠ¡ a è®¿é—®æœåŠ¡ bï¼Œdnsè§£æä¾èµ–aå®¹å™¨å†… /etc/resolv.conf æ–‡ä»¶çš„é…ç½®\ncat/etc/resolv.conf nameserver 10.233.0.3 search default.svc.cluster.local svc.cluster.localcluster.local è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œé…ç½®çš„ DNS Serverï¼Œä¸€èˆ¬å°±æ˜¯ K8S ä¸­ï¼Œkubedns çš„ Service çš„ ClusterIPï¼Œè¿™ä¸ªIPæ˜¯è™šæ‹ŸIPï¼Œæ— æ³•pingã€‚\n[root@node4 user1]#kubectl get svc -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 10.233.0.3 53/UDP,53/TCP 270d kubernetes-dashboard ClusterIP 10.233.22.223 443/TCP 124d æ‰€æœ‰åŸŸåçš„è§£æï¼Œå…¶å®éƒ½è¦ç»è¿‡ kubedns çš„è™šæ‹ŸIP 10.233.0.3 ï¼Œè´Ÿè½½åˆ°æŸä¸€ä¸ªkube-dns podä¸Šå»è§£æã€‚å¦‚æœä¸èƒ½è§£æï¼Œåˆ™ä¼šå»kube-dns podæ‰€åœ¨çš„ä¸»æœºä¸Šçš„dnsæœåŠ¡ï¼ˆ/etc/resolv.confï¼‰åšè§£æã€‚Kubernetes å¯åŠ¨çš„å®¹å™¨è‡ªåŠ¨å°† DNS æœåŠ¡å™¨åŒ…å«åœ¨å®¹å™¨å†…çš„/etc/resolv.conf ä¸­ã€‚\nåŸŸåæ ¼å¼å¦‚ä¸‹ï¼š\nstatefulsetä¸€èˆ¬ä½¿ç”¨Headless Serviceï¼Œå¦‚statefulsetåä¸ºtestï¼Œåˆ›å»º2ä¸ªpodï¼Œåˆ™åŸŸåä¸ºtest-0.test.kube-system.svc.cluster.localå’Œtest-1.test.kube-system.svc.cluster.local\nèŠ‚ç‚¹ç»„ä»¶\nèŠ‚ç‚¹ç»„ä»¶åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œç»´æŠ¤è¿è¡Œçš„ Pod å¹¶æä¾›Kubernetes è¿è¡Œæ—¶ç¯å¢ƒã€‚kubeletä¸€èˆ¬ä½œä¸ºäºŒè¿›åˆ¶è¿è¡Œåˆ°æ¯ä¸ªk8sèŠ‚ç‚¹ï¼›kube-proxyä½œä¸ºdaemonset podè¿è¡Œåˆ°æ¯ä¸ªk8sèŠ‚ç‚¹ã€‚\nkubelet\nåœ¨kubernetesé›†ç¾¤ä¸­ï¼Œæ¯ä¸ªNodeèŠ‚ç‚¹éƒ½ä¼šå¯åŠ¨kubeletè¿›ç¨‹ï¼Œç”¨æ¥å¤„ç†MasterèŠ‚ç‚¹ä¸‹å‘åˆ°æœ¬èŠ‚ç‚¹çš„ä»»åŠ¡ï¼Œç®¡ç†Podå’Œå…¶ä¸­çš„å®¹å™¨ã€‚kubeletä¼šåœ¨API Serverä¸Šæ³¨å†ŒèŠ‚ç‚¹ä¿¡æ¯ï¼Œå®šæœŸå‘Masteræ±‡æŠ¥èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶é€šè¿‡cAdvisorç›‘æ§å®¹å™¨å’ŒèŠ‚ç‚¹èµ„æºã€‚\npodè¢«è°ƒåº¦åˆ°kubeletæ‰€åœ¨èŠ‚ç‚¹æ—¶ï¼Œè°ƒç”¨CNIï¼ˆDocker è¿è¡Œæˆ–é€šè¿‡ rkt)è¿è¡Œ Pod çš„å®¹å™¨;\nå‘¨æœŸæ€§çš„å¯¹å®¹å™¨ç”Ÿå‘½å‘¨æœŸè¿›è¡Œæ¢æµ‹ã€‚ï¼ˆå¥åº·æ£€æŸ¥readness-éš”ç¦»ã€liveness-é‡å¯ï¼‰;\næ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ï¼Œå°†èŠ‚ç‚¹çš„çŠ¶æ€æŠ¥å‘Šç»™kube-apiserver;\nå®¹å™¨ç›‘æ§æ‰€åœ¨èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¹¶å®šæ—¶å‘ kube-apiserveræŠ¥å‘Šã€‚çŸ¥é“æ•´ä¸ªé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„èµ„æºæƒ…å†µï¼Œå¯¹äº pod çš„è°ƒåº¦å’Œæ­£å¸¸è¿è¡Œè‡³å…³é‡è¦ã€‚kubelet ä½¿ç”¨cAdvisorè¿›è¡Œèµ„æºä½¿ç”¨ç‡çš„ç›‘æ§ã€‚\nkube-proxy\nhttps://blog.csdn.net/qq_21816375/article/details/86310844\nserviceæ˜¯ä¸€ç»„podçš„æœåŠ¡æŠ½è±¡ï¼Œç›¸å½“äºä¸€ç»„podçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œè´Ÿè´£å°†è¯·æ±‚åˆ†å‘ç»™å¯¹åº”çš„podã€‚serviceä¼šæä¾›ä¸€ä¸ªclusterIPã€‚kube-proxyçš„ä½œç”¨ä¸»è¦æ˜¯è´Ÿè´£serviceçš„å®ç°ï¼Œå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å®ç°äº†å†…éƒ¨è¯·æ±‚åˆ°serviceå’Œå¤–éƒ¨çš„ä»node portå‘serviceçš„è®¿é—®ï¼Œè½¬å‘åˆ°åç«¯æŸä¸ªpodã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨æœ‰podAï¼ŒpodBï¼ŒpodCå’ŒserviceABã€‚serviceABæ˜¯podAï¼ŒpodBçš„æœåŠ¡æŠ½è±¡(service)ã€‚é‚£ä¹ˆkube-proxyçš„ä½œç”¨å°±æ˜¯å¯ä»¥å°†æŸä¸€ä¸ªå‘å¾€ï¼ˆå¦‚podCå‘èµ·çš„è¯·æ±‚ï¼‰å‘serviceABçš„è¯·æ±‚ï¼Œè¿›è¡Œè½¬å‘åˆ°serviceæ‰€ä»£è¡¨çš„ä¸€ä¸ªå…·ä½“pod(podAæˆ–è€…podB)ä¸Šã€‚è¯·æ±‚çš„åˆ†é…æ–¹æ³•ä¸€èˆ¬åˆ†é…æ˜¯é‡‡ç”¨è½®è¯¢æ–¹æ³•è¿›è¡Œåˆ†é…ã€‚\nkube-proxyæä¾›äº†ä¸‰ç§è´Ÿè½½å‡è¡¡å™¨ï¼ˆLBï¼‰æ¨¡å¼: ä¸€ç§æ˜¯åŸºäºç”¨æˆ·æ€çš„æ¨¡å¼userspace, ä¸€ç§æ˜¯iptablesæ¨¡å¼ï¼Œä¸€ç§æ˜¯ipvsæ¨¡å¼ã€‚\nuserspaceï¼šæ˜¯ä»¥socketçš„æ–¹å¼å®ç°ä»£ç†çš„ï¼Œuserspaceè¿™ç§æ¨¡å¼æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œserviceçš„è¯·æ±‚ä¼šå…ˆä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸iptablesï¼Œç„¶åå†å›åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç”±kube-proxyå®Œæˆåç«¯Endpointsçš„é€‰æ‹©å’Œä»£ç†å·¥ä½œï¼Œè¿™æ ·æµé‡ä»ç”¨æˆ·ç©ºé—´è¿›å‡ºå†…æ ¸å¸¦æ¥çš„æ€§èƒ½æŸè€—æ˜¯ä¸å¯æ¥å—çš„ï¼›\niptables modeï¼šå› ä¸ºä½¿ç”¨iptable NATæ¥å®Œæˆè½¬å‘ï¼Œä¹Ÿå­˜åœ¨ä¸å¯å¿½è§†çš„æ€§èƒ½æŸè€—ã€‚å¦å¤–ï¼Œå¦‚æœé›†ç¾¤ä¸­å­˜åœ¨ä¸Šä¸‡çš„Service/Endpointï¼Œé‚£ä¹ˆNodeä¸Šçš„iptables ruleså°†ä¼šéå¸¸åºå¤§ï¼Œæ€§èƒ½è¿˜ä¼šå†æ‰“æŠ˜æ‰£ï¼›\nIPVS æ¨¡å¼ï¼šå·¥ä½œåŸç†å…¶å®è·Ÿ iptables æ¨¡å¼ç±»ä¼¼ï¼Œå½“æˆ‘ä»¬åˆ›å»ºäº†å‰é¢çš„Service ä¹‹åï¼Œkube-proxyé¦–å…ˆä¼šåœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼ˆkube-ipvs0ï¼‰å¹¶ä¸ºä»–åˆ†é…service VIPä½œä¸ºIPåœ°å€ï¼Œkube-proxyä¼šé€šè¿‡linuxçš„IPVSæ¨¡å—ä¸ºè¿™ä¸ªIPè®¾ç½®ä¸‰ä¸ªè™šæ‹Ÿä¸»æœºï¼ˆåç«¯çš„ä¸‰ä¸ªPOD IPï¼‰ï¼Œä½¿ç”¨è½®è¯¢ä½œä¸ºLBç­–ç•¥ï¼ˆipvsadmå‘½ä»¤æŸ¥çœ‹ï¼‰ï¼ŒIPVSæ¨¡å—ä¼šè´Ÿè´£è¯·æ±‚çš„è½¬å‘ã€‚\nä»¥ä¸‹æˆªå›¾æ¥è‡ªäºæå®¢æ—¶é—´å¼ ç£Šçš„è¯¾ç¨‹æè¿°ï¼š\niptablesæ¨¡å¼å’Œipvsæ¨¡å¼çš„å¯¹æ¯”\næœåŠ¡æš´éœ²æ–¹å¼\nhttp://dockone.io/article/4884\nNodePort\nNodePortæœåŠ¡æ˜¯å¼•å¯¼å¤–éƒ¨æµé‡åˆ°ä½ çš„æœåŠ¡çš„æœ€åŸå§‹æ–¹å¼ã€‚å¯ä»¥é€šè¿‡è®¿é—®é›†ç¾¤å†…çš„æ¯ä¸ªNodeIP:NodePortçš„æ–¹å¼ï¼Œè®¿é—®åˆ°å¯¹åº”Serviceåç«¯çš„Endpointã€‚åœ¨æ‰€æœ‰èŠ‚ç‚¹ï¼ˆè™šæ‹Ÿæœºï¼‰ä¸Šå¼€æ”¾ä¸€ä¸ªç‰¹å®šç«¯å£ï¼Œä»»ä½•å‘é€åˆ°è¯¥ç«¯å£çš„æµé‡éƒ½è¢«è½¬å‘åˆ°å¯¹åº”æœåŠ¡ã€‚\nNodePort æœåŠ¡çš„ YAML æ–‡ä»¶ç±»ä¼¼å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Service metadata: name: my-nodeport-service selector: app: my-app spec: type: NodePort ports: - name: http port: 80 targetPort: 80 nodePort: 30036 protocol: TCP NodePort æœåŠ¡ä¸»è¦æœ‰ä¸¤ç‚¹åŒºåˆ«äºæ™®é€šçš„â€œClusterIPâ€æœåŠ¡ã€‚ç¬¬ä¸€ï¼Œå®ƒçš„ç±»å‹æ˜¯â€œNodePortâ€ã€‚æœ‰ä¸€ä¸ªé¢å¤–çš„ç«¯å£ï¼Œç§°ä¸º nodePortï¼Œå®ƒæŒ‡å®šèŠ‚ç‚¹ä¸Šå¼€æ”¾çš„ç«¯å£å€¼ã€‚å¦‚æœä½ ä¸æŒ‡å®šè¿™ä¸ªç«¯å£ï¼Œç³»ç»Ÿå°†é€‰æ‹©ä¸€ä¸ªéšæœºç«¯å£ã€‚\nä½•æ—¶ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Ÿ\nè¿™ç§æ–¹æ³•æœ‰è®¸å¤šç¼ºç‚¹ï¼š\næ¯ä¸ªç«¯å£åªèƒ½æ˜¯ä¸€ç§æœåŠ¡\nç«¯å£èŒƒå›´åªèƒ½æ˜¯ 30000-32767\nå¦‚æœèŠ‚ç‚¹/VM çš„ IP åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œä½ éœ€è¦èƒ½å¤„ç†è¿™ç§æƒ…å†µã€‚\nåŸºäºä»¥ä¸ŠåŸå› ï¼Œæˆ‘ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šç”¨è¿™ç§æ–¹å¼æš´éœ²æœåŠ¡ã€‚å¦‚æœä½ è¿è¡Œçš„æœåŠ¡ä¸è¦æ±‚ä¸€ç›´å¯ç”¨ï¼Œæˆ–è€…å¯¹æˆæœ¬æ¯”è¾ƒæ•æ„Ÿï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚è¿™æ ·çš„åº”ç”¨çš„æœ€ä½³ä¾‹å­æ˜¯ demo åº”ç”¨ï¼Œæˆ–è€…æŸäº›ä¸´æ—¶åº”ç”¨ã€‚\nhostNetwork # è¿™ç§æ–¹å¼åœ¨åˆ›å»ºpodæ—¶çš„yamlä¸­spec.hostNetwork: trueæŒ‡å®šèµ°ä¸»æœºç½‘ç»œï¼Œè¿™ç§æ–¹å¼podä½¿ç”¨çš„ç«¯å£å¿…é¡»æ˜¯å®¿ä¸»æœºä¸Šæ²¡æœ‰è¢«å ç”¨çš„ç«¯å£ã€‚å¤–éƒ¨å¯ä»¥ç›´æ¥é€šè¿‡podæ‰€åœ¨å®¿ä¸»æœºIP:Podç«¯å£è®¿é—®ã€‚\nLoadBalancer\nè¿™ä¹Ÿæ˜¯ç”¨æ¥å¯¹é›†ç¾¤å¤–æš´éœ²æœåŠ¡çš„ï¼Œä¸åŒçš„æ˜¯è¿™éœ€è¦äº‘æœåŠ¡å•†çš„æ”¯æŒï¼Œæ¯”å¦‚äºšé©¬é€Šç­‰ã€‚è¿™ä¸ªæ–¹å¼çš„æœ€å¤§ç¼ºç‚¹æ˜¯æ¯ä¸€ä¸ªç”¨ LoadBalancer æš´éœ²çš„æœåŠ¡éƒ½ä¼šæœ‰å®ƒè‡ªå·±çš„ IP åœ°å€ï¼Œæ¯ä¸ªç”¨åˆ°çš„ LoadBalancer éƒ½éœ€è¦ä»˜è´¹ï¼Œè¿™æ˜¯éå¸¸æ˜‚è´µçš„ã€‚\nIngress\ningressé…ç½®ä¸€ç§è·¯ç”±è½¬å‘è§„åˆ™ï¼Œingress controllerä¼šæ ¹æ®ingressä¸­çš„è§„åˆ™ï¼Œç”Ÿæˆè·¯ç”±è½¬å‘é…ç½®ã€‚å¦‚nginx-ingress-controllerï¼Œæ§åˆ¶å¾ªç¯ä¼šæ£€æµ‹ingresså¯¹è±¡çš„æ·»åŠ ï¼Œé€šè¿‡å…¶è§„åˆ™å’Œserviceã€podä¿¡æ¯ç”Ÿæˆnginxçš„é…ç½®ï¼Œé€šè¿‡nginxå®ç°å¯¹å¤–æœåŠ¡å’Œè´Ÿè½½å‡è¡¡ã€‚\npodåˆ›å»ºæµç¨‹\n1ã€å®¢æˆ·ç«¯æäº¤åˆ›å»ºè¯·æ±‚ï¼Œé€šè¿‡API Serverçš„Restful APIï¼Œæˆ–è€…ç”¨kubectlå‘½ä»¤è¡Œå·¥å…·ã€‚æ”¯æŒçš„æ•°æ®ç±»å‹åŒ…æ‹¬JSONå’ŒYAMLã€‚\n2ã€API Serverå¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå­˜å‚¨Podæ•°æ®åˆ°etcdã€‚\n3ã€kube-scheduleré€šè¿‡API ServeræŸ¥çœ‹æœªç»‘å®šçš„Podã€‚å°è¯•ä¸ºPodåˆ†é…ä¸»æœºã€‚\n4ã€kube-scheduleré€šè¿‡é¢„é€‰ç®—æ³•è¿‡æ»¤æ‰ä¸ç¬¦åˆè¦æ±‚çš„ä¸»æœºã€‚æ¯”å¦‚PodæŒ‡å®šäº†æ‰€éœ€è¦çš„èµ„æºé‡ï¼Œé‚£ä¹ˆå¯ç”¨èµ„æºæ¯”Podéœ€è¦çš„èµ„æºé‡å°‘çš„ä¸»æœºä¼šè¢«è¿‡æ»¤æ‰ï¼Œç«¯å£è¢«å ç”¨çš„ä¹Ÿè¢«è¿‡æ»¤æ‰ï¼›\n5ã€kube-scheduleré€šè¿‡ä¼˜é€‰ç®—æ³•ç»™ä¸»æœºæ‰“åˆ†ï¼Œå¯¹é¢„é€‰ç­›é€‰å‡ºçš„ç¬¦åˆè¦æ±‚çš„ä¸»æœºè¿›è¡Œæ‰“åˆ†ï¼Œåœ¨ä¸»æœºæ‰“åˆ†é˜¶æ®µï¼Œè°ƒåº¦å™¨ä¼šè€ƒè™‘ä¸€äº›æ•´ä½“ä¼˜åŒ–ç­–ç•¥ï¼Œæ¯”å¦‚æŠŠä¸€ä¸ªdeploymentç±»å‹çš„podåˆ†å¸ƒåˆ°ä¸åŒçš„ä¸»æœºä¸Šï¼Œä½¿å¾—èµ„æºå‡è¡¡ï¼›æˆ–è€…å°†ä¸¤ä¸ªäº²å’Œçš„æœåŠ¡åˆ†é…åˆ°åŒä¸€ä¸ªä¸»æœºä¸Šã€‚\n6ã€é€‰æ‹©ä¸»æœºï¼šé€‰æ‹©æ‰“åˆ†æœ€é«˜çš„ä¸»æœºï¼Œè¿›è¡Œbindingï¼ˆè°ƒç”¨apiserverå°†podå’Œnodeç»‘å®šï¼‰æ“ä½œï¼Œç»“æœå­˜å‚¨åˆ°etcdä¸­ã€‚\n7ã€kubeletç›‘å¬Api Serverï¼Œæ ¹æ®è°ƒåº¦ç»“æœæ‰§è¡ŒPodåˆ›å»ºæ“ä½œï¼šç»‘å®šæˆåŠŸåï¼Œschedulerä¼šè°ƒç”¨API Serverçš„APIåœ¨etcdä¸­åˆ›å»ºä¸€ä¸ªbound podå¯¹è±¡ï¼Œæè¿°åœ¨ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šç»‘å®šè¿è¡Œçš„æ‰€æœ‰podä¿¡æ¯ã€‚è¿è¡Œåœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šçš„kubeletä¹Ÿä¼šå®šæœŸä¸etcdåŒæ­¥bound podä¿¡æ¯ï¼Œä¸€æ—¦å‘ç°åº”è¯¥åœ¨è¯¥å·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œçš„bound podå¯¹è±¡æ²¡æœ‰æ›´æ–°ï¼Œåˆ™è°ƒç”¨Docker APIåˆ›å»ºå¹¶å¯åŠ¨podå†…çš„å®¹å™¨ã€‚\n8ã€kubeletè°ƒç”¨CNIï¼ˆDocker è¿è¡Œæˆ–é€šè¿‡ rkt)è¿è¡Œ Pod çš„å®¹å™¨ã€‚å¹¶å‘¨æœŸæ€§çš„å¯¹å®¹å™¨ç”Ÿå‘½å‘¨æœŸè¿›è¡Œæ¢æµ‹ã€‚ï¼ˆå¥åº·æ£€æŸ¥readness-éš”ç¦»ã€liveness-é‡å¯ï¼‰\nå„ç»„ä»¶åŸºæœ¬éƒ½æ˜¯é€šè¿‡API Serveræä¾›çš„list-watch APIè¿›è¡Œç›‘å¬èµ„æºå¯¹è±¡å˜åŒ–ï¼Œè¿›è¡Œè‡ªå·±çš„æ§åˆ¶å¾ªç¯ï¼Œè¿™äº›æ ¸å¿ƒåŠŸèƒ½éƒ½è¢«å°è£…åˆ°äº†client-goåŒ…ä¸­ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œé€šè¿‡CRDç¼–å†™controllerã€operatorè¿›è¡Œè‡ªå·±çš„æ§åˆ¶å¾ªç¯é€»è¾‘ã€è¿ç»´è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå¾ˆè½»æ¾çš„æ‰©å±•k8sèƒ½åŠ›ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8k8s%E5%BF%85%E5%AD%A6%E5%BF%85%E4%BC%9A%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003ekube-apiserver\u003c/strong\u003e\u003c/p\u003e","title":"å²ä¸Šæœ€å…¨k8så¿…å­¦å¿…ä¼šçŸ¥è¯†æ¢³ç†","type":"posts"},{"content":" æ­£æ–‡ # Kubernetes è‡ªå¸¦äº†ä¸€ä¸ªé»˜è®¤è°ƒåº¦å™¨kube-schedulerï¼Œå…¶å†…ç½®äº†å¾ˆå¤šèŠ‚ç‚¹é¢„é€‰å’Œä¼˜é€‰çš„è°ƒåº¦ç®—æ³•ï¼Œä¸€èˆ¬è°ƒåº¦åœºæ™¯ä¸‹å¯ä»¥æ»¡è¶³è¦æ±‚ã€‚ä½†æ˜¯åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸‹ï¼Œé»˜è®¤è°ƒåº¦å™¨ä¸èƒ½æ»¡è¶³æˆ‘ä»¬å¤æ‚çš„è°ƒåº¦éœ€æ±‚ã€‚æˆ‘ä»¬å°±éœ€è¦å¯¹è°ƒåº¦å™¨è¿›è¡Œæ‰©å±•ï¼Œä»¥è¾¾åˆ°è°ƒåº¦é€‚åˆä¸šåŠ¡åœºæ™¯çš„ç›®çš„ã€‚\nèƒŒæ™¯ # ä¸­é—´ä»¶rediså®¹å™¨åŒ–åï¼Œéœ€è¦ä¸¤ä¸»ä¸èƒ½åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä¸€å¯¹ä¸»ä»ä¸èƒ½åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šï¼›elasticsearchå®¹å™¨åŒ–åï¼Œä¸¤ä¸ªdataå®ä¾‹ä¸èƒ½åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šã€‚åœ¨è¿™ç±»åœºæ™¯ä¸‹ï¼Œé»˜è®¤è°ƒåº¦å™¨å†…ç½®çš„é¢„é€‰ã€ä¼˜é€‰ç®—æ³•ä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸‰ç§é€‰æ‹©ï¼š\nå°†æ–°çš„è°ƒåº¦ç®—æ³•æ·»åŠ åˆ°é»˜è®¤è°ƒåº¦ç¨‹åºä¸­ï¼Œå¹¶é‡æ–°ç¼–è¯‘é•œåƒï¼Œæœ€ç»ˆè¯¥é•œåƒè¿è¡Œçš„å®ä¾‹ä½œä¸ºkubernetesé›†ç¾¤è°ƒåº¦å™¨ï¼›\nå‚è€ƒkube-schedulerå®ç°æ»¡è¶³è‡ªå·±ä¸šåŠ¡åœºæ™¯çš„è°ƒåº¦ç¨‹åºï¼Œå¹¶ç¼–è¯‘é•œåƒï¼Œå°†è¯¥ç¨‹åºä½œä¸ºç‹¬ç«‹çš„è°ƒåº¦å™¨è¿è¡Œåˆ°kubernetesé›†ç¾¤å†…ï¼Œéœ€è¦ç”¨è¯¥è°ƒåº¦å™¨è°ƒåº¦çš„podå®ä¾‹ï¼Œåœ¨spec.schedulerNameé‡ŒæŒ‡å®šè¯¥è°ƒåº¦å™¨ï¼›\nå®ç°â€œè°ƒåº¦æ‰©å±•ç¨‹åºâ€œï¼šé»˜è®¤è°ƒåº¦å™¨kube-scheduleråœ¨è¿›è¡Œé¢„é€‰æ—¶ä¼šè°ƒç”¨è¯¥æ‰©å±•ç¨‹åºè¿›è¡Œè¿‡æ»¤èŠ‚ç‚¹ï¼›åœ¨ä¼˜é€‰æ—¶ä¼šè°ƒç”¨è¯¥æ‰©å±•ç¨‹åºè¿›è¡Œç»™èŠ‚ç‚¹æ‰“åˆ†ï¼Œæˆ–è€…åœ¨bindæ“ä½œæ—¶ï¼Œè°ƒç”¨è¯¥æ‰©å±•å™¨è¿›è¡Œbindæ“ä½œã€‚\nå¯¹ä¸Šè¿°ä¸‰ç§æ–¹å¼è¿›è¡Œè¯„ä¼°ï¼š\nç¬¬ä¸€ç§ï¼šå°†è‡ªå·±çš„è°ƒåº¦ç®—æ³•æ·»åŠ åˆ°é»˜è®¤è°ƒåº¦å™¨kube-schedulerä¸­ï¼Œå¯¹åŸç”Ÿä»£ç ä¾µå…¥æ€§è¾ƒé«˜ï¼Œè€Œä¸”éšç€kubernetesç‰ˆæœ¬å‡çº§ï¼Œç»´æŠ¤æˆæœ¬ä¹Ÿè¾ƒé«˜ï¼›\nç¬¬äºŒç§ï¼šé»˜è®¤è°ƒåº¦å™¨é‡Œå†…ç½®äº†å¾ˆå¤šä¼˜ç§€è°ƒåº¦ç®—æ³•ï¼Œå¦‚ï¼šæ£€æŸ¥èŠ‚ç‚¹èµ„æºæ˜¯å¦å……è¶³ï¼›ç«¯å£æ˜¯å¦å ç”¨ï¼›volumeæ˜¯å¦è¢«å…¶ä»–podæŒ‚è½½ï¼›äº²å’Œæ€§ï¼›å‡è¡¡èŠ‚ç‚¹èµ„æºåˆ©ç”¨ç­‰ï¼Œå¦‚æœå®Œå…¨ä½¿ç”¨è‡ªå·±å¼€å‘çš„è°ƒåº¦å™¨ç¨‹åºï¼Œå¯èƒ½åœ¨è¾¾åˆ°äº†å®é™…åœºæ™¯è°ƒåº¦éœ€æ±‚åŒæ—¶ï¼Œå¤±å»æ›´ä½³çš„è°ƒåº¦æ–¹æ¡ˆï¼Œé™¤éé›†æˆé»˜è®¤è°ƒåº¦å™¨ä¸­çš„ç®—æ³•åˆ°è‡ªå·±ç‹¬ç«‹è°ƒåº¦ç¨‹åºä¸­ï¼Œä½†è¿™æ— ç–‘æ˜¯ä¸ç°å®çš„ï¼›\nç¬¬ä¸‰ç§ï¼šé€šè¿‡å¯åŠ¨å‚æ•°çš„policyé…ç½®ï¼Œé€‰ç”¨æŸäº›é»˜è®¤è°ƒåº¦å™¨ä¸­çš„é¢„é€‰ã€ä¼˜é€‰è°ƒåº¦ç®—æ³•çš„åŒæ—¶ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨å¤–éƒ¨æ‰©å±•è°ƒåº¦ç¨‹åºçš„ç®—æ³•ï¼Œè®¡ç®—å¾—åˆ°æœ€ä¼˜çš„è°ƒåº¦èŠ‚ç‚¹ï¼Œæ— éœ€ä¿®æ”¹kube-schedulerä»£ç ï¼Œåªéœ€è¦åœ¨å¯åŠ¨å‚æ•°ä¸­å¢åŠ é…ç½®æ–‡ä»¶å³å¯å°†é»˜è®¤è°ƒåº¦ç¨‹åºå’Œæ‰©å±•è°ƒåº¦ç¨‹åºç›¸äº’å…³è”ã€‚\nå¯ä»¥å‚è€ƒï¼š\nhttps://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md\næ•…é‡‡ç”¨ç¬¬ä¸‰ç§ï¼šå®ç°æ‰©å±•è°ƒåº¦ç¨‹åºçš„æ–¹æ¡ˆã€‚\næ•´ä½“æ¶æ„ # kube-scheduleråœ¨è°ƒåº¦podå®ä¾‹æ—¶ï¼Œé¦–å…ˆè·å–åˆ°Node1ã€Node2ã€Node3ä¸‰ä¸ªèŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿›è¡Œé»˜è®¤çš„é¢„é€‰é˜¶æ®µï¼Œç­›é€‰æ»¡è¶³è¦æ±‚çš„èŠ‚ç‚¹ï¼Œå…¶æ¬¡å†è°ƒç”¨æ‰©å±•ç¨‹åºä¸­çš„é¢„é€‰ç®—æ³•ï¼Œé€‰å‡ºå‰©ä¸‹çš„èŠ‚ç‚¹ï¼Œå‡è®¾é¢„é€‰é˜¶æ®µNode3ä¸Šèµ„æºä¸è¶³è¢«è¿‡æ»¤æ‰ï¼Œé¢„é€‰ç»“æŸååªå‰©Node1å’ŒNode2ï¼›Node1å’ŒNode2è¿›å…¥kube-scheduleré»˜è®¤çš„ä¼˜é€‰é˜¶æ®µè¿›è¡ŒèŠ‚ç‚¹æ‰“åˆ†ï¼Œå…¶æ¬¡å†è°ƒç”¨æ‰©å±•è°ƒåº¦ç¨‹åºä¸­çš„ä¼˜é€‰ç®—æ³•è¿›è¡Œæ‰“åˆ†ï¼Œkube-schedulerä¼šå°†æ‰€æœ‰ç®—æ³•çš„æ‰“åˆ†ç»“æœè¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œè·å¾—åˆ†æ•°æœ€é«˜çš„èŠ‚ç‚¹ä½œä¸ºpodæœ€ç»ˆbindèŠ‚ç‚¹ï¼Œç„¶åkube-schedulerè°ƒç”¨apiserverè¿›è¡Œbindæ“ä½œã€‚\nå®ç°æ­¥éª¤ # å®ç°æ‰©å±•è°ƒåº¦ç¨‹åºä»£ç  # ç¼–å†™æ‰©å±•è°ƒåº¦å™¨ç¨‹åºä»£ç ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡è°ƒåº¦åœºæ™¯ç¼–å†™é¢„é€‰é€»è¾‘ã€ä¼˜é€‰é€»è¾‘ï¼š\nå®ç°é¢„é€‰æ¥å£ï¼Œå…¥å‚ä¸ºschedulerapi.ExtenderArgsï¼Œå‡ºå‚ä¸ºschedulerapi.ExtenderFilterResultï¼š\nå®ç°ä¼˜é€‰æ¥å£ï¼Œå…¥å‚ä¸ºschedulerapi.ExtenderArgsï¼Œå‡ºå‚ä¸ºschedulerapi.HostPriorityListï¼š\næš´éœ²httpæ¥å£ï¼š\nå‚è€ƒï¼š\nhttps://github.com/smallersoup/k8s-scheduler-extender-example\né»˜è®¤è°ƒåº¦å™¨éƒ¨ç½² # ç”±äºkubernetesé›†ç¾¤å†…å·²ç»æœ‰äº†ä¸€ä¸ªåä¸ºdefault-schedulerçš„é»˜è®¤è°ƒåº¦å™¨ï¼Œä¸ºäº†ä¸å½±å“é›†ç¾¤æ­£å¸¸è°ƒåº¦åŠŸèƒ½ï¼Œä¸‹é¢ä¼šåˆ›å»ºä¸€ä¸ªåä¸ºmy-kube-schedulerçš„è°ƒåº¦å™¨ï¼Œè¿™ä¸ªè°ƒåº¦å™¨å’Œdefault-scheduleré™¤äº†å¯åŠ¨å‚æ•°ä¸ä¸€æ ·å¤–ï¼Œé•œåƒæ— å·®åˆ«ã€‚\n1ã€åˆ›å»ºä¸€ä¸ªåä¸ºmy-scheduler-configçš„configmapsï¼Œdataä¸‹çš„config.yamlæ–‡ä»¶æŒ‡å®šäº†è°ƒåº¦å™¨çš„ä¸€äº›å‚æ•°ï¼ŒåŒ…æ‹¬leaderé€‰ä¸¾ï¼Œè°ƒåº¦ç®—æ³•ç­–ç•¥çš„é€‰æ‹©ï¼ˆæŒ‡å®šå¦ä¸€ä¸ªconfigmapsï¼‰ï¼Œä»¥åŠæŒ‡å®šè°ƒåº¦å™¨çš„åç§°ä¸ºmy-kube-schedulerã€‚\nç›¸åº”çš„åˆ›å»ºä¸€ä¸ªmy-scheduler-policyçš„configmapsï¼Œé‡Œé¢æŒ‡å®šäº†é€‰æ‹©å“ªäº›é¢„é€‰ã€ä¼˜é€‰ç­–ç•¥ï¼Œä»¥åŠå¤–éƒ¨æ‰©å±•è°ƒåº¦ç¨‹åºçš„urlPrefixã€æ‰©å±•é¢„é€‰URIã€æ‰©å±•ä¼˜é€‰URIã€æ‰©å±•podä¼˜å…ˆçº§æŠ¢å URIã€æ‰©å±•bind URIã€æ‰©å±•ä¼˜é€‰ç®—æ³•çš„æƒé‡ç­‰ã€‚\nä»¥ä¿è¯my-kube-schedulerå’Œæ‰©å±•è°ƒåº¦ç¨‹åºçš„é€šä¿¡ã€‚\napiVersion: v1 kind: ConfigMap metadata: name: my-scheduler-config namespace: kube-system data: config.yaml: | apiVersion: kubescheduler.config.k8s.io/v1alpha1 kind: KubeSchedulerConfiguration schedulerName: my-kube-scheduler algorithmSource: policy: configMap: namespace: kube-system name: my-scheduler-policy leaderElection: leaderElect: false lockObjectName: my-kube-scheduler lockObjectNamespace: kube-system --- apiVersion: v1 kind: ConfigMap metadata: name: my-scheduler-policy namespace: kube-system data: policy.cfg : | { \u0026#34;kind\u0026#34; : \u0026#34;Policy\u0026#34;, \u0026#34;apiVersion\u0026#34; : \u0026#34;v1\u0026#34;, \u0026#34;predicates\u0026#34; : [ {\u0026#34;name\u0026#34; : \u0026#34;PodFitsHostPorts\u0026#34;}, {\u0026#34;name\u0026#34; : \u0026#34;PodFitsResources\u0026#34;}, {\u0026#34;name\u0026#34; : \u0026#34;NoDiskConflict\u0026#34;}, {\u0026#34;name\u0026#34; : \u0026#34;MatchNodeSelector\u0026#34;}, {\u0026#34;name\u0026#34; : \u0026#34;HostName\u0026#34;} ], \u0026#34;priorities\u0026#34; : [ {\u0026#34;name\u0026#34; : \u0026#34;LeastRequestedPriority\u0026#34;, \u0026#34;weight\u0026#34; : 1}, {\u0026#34;name\u0026#34; : \u0026#34;BalancedResourceAllocation\u0026#34;, \u0026#34;weight\u0026#34; : 1}, {\u0026#34;name\u0026#34; : \u0026#34;ServiceSpreadingPriority\u0026#34;, \u0026#34;weight\u0026#34; : 1}, {\u0026#34;name\u0026#34; : \u0026#34;EqualPriority\u0026#34;, \u0026#34;weight\u0026#34; : 1} ], \u0026#34;extenders\u0026#34; : [{ \u0026#34;urlPrefix\u0026#34;: \u0026#34;http://10.168.107.12:80/scheduler\u0026#34;, \u0026#34;filterVerb\u0026#34;: \u0026#34;predicates/always_true\u0026#34;, \u0026#34;prioritizeVerb\u0026#34;: \u0026#34;priorities/zero_score\u0026#34;, \u0026#34;preemptVerb\u0026#34;: \u0026#34;preemption\u0026#34;, \u0026#34;bindVerb\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;weight\u0026#34;: 1, \u0026#34;enableHttps\u0026#34;: false, \u0026#34;nodeCacheCapable\u0026#34;: false }], \u0026#34;hardPodAffinitySymmetricWeight\u0026#34; : 10 } 2ã€åœ¨my-kube-scheduler yamlæ–‡ä»¶ä¸­å°†configmapsï¼šmy-scheduler-configä»¥æ–‡ä»¶çš„å½¢å¼æŒ‚è½½åˆ°å®¹å™¨å†…/my-schedulerç›®å½•ä¸‹ï¼Œå¹¶åœ¨å¯åŠ¨å‚æ•°ä¸­æŒ‡å®š\u0026ndash;config=/my-scheduler/config.yamlï¼Œä½¿ç”¨å’Œé»˜è®¤è°ƒåº¦å™¨ä¸€æ ·çš„é•œåƒã€‚\nå¢åŠ æŒ‚è½½ï¼š\næ‰©å±•è°ƒåº¦å™¨é•œåƒåˆ¶ä½œå’Œéƒ¨ç½² # 1ã€ç¼–è¯‘æ‰©å±•è°ƒåº¦ç¨‹åºmy-scheduler-extenderé•œåƒï¼Œä»¥ä¸‹ä¸ºDockerfileï¼š\næ¨é€my-scheduler-extenderé•œåƒåˆ°harborï¼š\n2ã€åˆ›å»ºå¤–éƒ¨æ‰©å±•ç¨‹åºmy-scheduler-extenderçš„deploymentï¼Œå¦‚ä¸‹ä¸ºyamlæè¿°ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: my-scheduler-extender namespace: kube-system labels: app: my-scheduler-extender spec: replicas: 1 selector: matchLabels: app: my-scheduler-extender template: metadata: labels: app: my-scheduler-extender spec: containers: - name: my-scheduler-extender image: 192.168.26.46/k8s-deploy/my-scheduler-extender:v1.0 imagePullPolicy: Always livenessProbe: httpGet: path: /version port: 80 readinessProbe: httpGet: path: /version port: 80 ports: - containerPort: 80 éªŒè¯ # æŸ¥çœ‹my-kube-scheduler podæ—¥å¿—ï¼ŒåŠ è½½åˆ°äº†policyé‡Œçš„extenderä¿¡æ¯ï¼Œè·å–åˆ°äº†æ‰©å±•è°ƒåº¦å™¨çš„æ¥å£åœ°å€ï¼š\nåˆ›å»ºä¸€ä¸ªnginxçš„podï¼ŒæŒ‡å®šschedulerNameä¸ºmy-kube-schedulerï¼š\næŸ¥çœ‹æ‰©å±•è°ƒåº¦å™¨podæ—¥å¿—ï¼Œå‘ç°é»˜è®¤è°ƒåº¦å™¨ä¼šè°ƒç”¨extenderæ‰©å±•è°ƒåº¦å™¨ï¼Œå¦‚ä¸‹ä¸ºextenderæ—¥å¿—æ‰“å°çš„å…¥å‚ã€å‡ºå‚ï¼š\nä»è€Œå¯ä»¥é€šè¿‡ç¼–å†™æ‰©å±•è°ƒåº¦ç¨‹åºï¼Œå¯¹é»˜è®¤è°ƒåº¦å™¨çš„é¢„é€‰å’Œä¼˜é€‰ç®—æ³•è¿›è¡Œæ‰©å±•ã€‚\nå‚è€ƒ\nhttps://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md\nhttps://github.com/smallersoup/k8s-scheduler-extender-example\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/kubescheduler%E8%B0%83%E5%BA%A6%E6%89%A9%E5%B1%95/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eKubernetes è‡ªå¸¦äº†ä¸€ä¸ªé»˜è®¤è°ƒåº¦å™¨kube-schedulerï¼Œå…¶å†…ç½®äº†å¾ˆå¤šèŠ‚ç‚¹é¢„é€‰å’Œä¼˜é€‰çš„è°ƒåº¦ç®—æ³•ï¼Œä¸€èˆ¬è°ƒåº¦åœºæ™¯ä¸‹å¯ä»¥æ»¡è¶³è¦æ±‚ã€‚ä½†æ˜¯åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸‹ï¼Œé»˜è®¤è°ƒåº¦å™¨ä¸èƒ½æ»¡è¶³æˆ‘ä»¬å¤æ‚çš„è°ƒåº¦éœ€æ±‚ã€‚æˆ‘ä»¬å°±éœ€è¦å¯¹è°ƒåº¦å™¨è¿›è¡Œæ‰©å±•ï¼Œä»¥è¾¾åˆ°è°ƒåº¦é€‚åˆä¸šåŠ¡åœºæ™¯çš„ç›®çš„ã€‚\u003c/p\u003e","title":"kube-schedulerè°ƒåº¦æ‰©å±•","type":"posts"},{"content":" æ­£æ–‡ # Operator æ˜¯ CoreOS æ¨å‡ºçš„æ—¨åœ¨ç®€åŒ–å¤æ‚æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ„ŸçŸ¥åº”ç”¨çŠ¶æ€çš„æ§åˆ¶å™¨ï¼Œé€šè¿‡æ‰©å±• Kubernetes API æ¥è‡ªåŠ¨åˆ›å»ºã€ç®¡ç†å’Œé…ç½®åº”ç”¨å®ä¾‹ã€‚ Operator åŸºäº CRD æ‰©å±•èµ„æºå¯¹è±¡ï¼Œå¹¶é€šè¿‡æ§åˆ¶å™¨æ¥ä¿è¯åº”ç”¨å¤„äºé¢„æœŸçŠ¶æ€ã€‚\né€šè¿‡ Kubernetes API è§‚å¯Ÿé›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼› åˆ†æå½“å‰çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€çš„å·®åˆ«ï¼› è°ƒç”¨k8s APIæ¶ˆé™¤è¿™äº›å·®åˆ«ã€‚ ä¸ºä»€ä¹ˆä½¿ç”¨crd # Kubernetes ç›®å‰å·²ç»æˆä¸ºäº†é›†ç¾¤è°ƒåº¦é¢†åŸŸæœ€ç‚™æ‰‹å¯çƒ­çš„å¼€æºé¡¹ç›®ä¹‹ä¸€ ã€‚å…¶å†…ç½®çš„ controllerä¸€èˆ¬å¯ä»¥æ»¡è¶³å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯ï¼Œä½†å¯¹äºå¾ˆå¤šå®šåˆ¶åŒ–éœ€æ±‚ï¼Œå…¶è¡¨è¾¾èƒ½åŠ›è¿˜æ˜¯æœ‰é™çš„ã€‚å› æ­¤ Kubernetes æ”¯æŒ Custom Resource Definitionï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸€ç›´æåˆ°çš„ CRDã€‚é€šè¿‡è¿™ä¸€ç‰¹æ€§ï¼Œç”¨æˆ·å¯ä»¥è‡ªå·±å®šä¹‰èµ„æºç±»å‹ï¼ŒKubernetes ä¼šå°†å…¶è§†ä¸ºèµ„æºçš„ä¸€ç§ï¼Œå¯¹å…¶æä¾›åƒå†…ç½®èµ„æºå¯¹è±¡ä¸€æ ·çš„æ”¯æŒï¼Œè¿™æ ·çš„å®ç°æ›´åŠ åŸç”Ÿã€‚CRDå¯ä»¥å¤§å¤§æé«˜ Kubernetes çš„æ‰©å±•èƒ½åŠ› ï¼Œä»¥æ›´åŸç”Ÿçš„æ–¹å¼å®ç°å®šåˆ¶åŒ–è¦æ±‚ã€‚\noperatorè®¾è®¡åˆè¡· # æˆ‘ä»¬åœ¨ç®¡ç†åº”ç”¨æ—¶ï¼Œä¼šé‡åˆ°æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€çš„åº”ç”¨ã€‚ç®¡ç†æ— çŠ¶æ€çš„åº”ç”¨æ˜¯ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯æœ‰çŠ¶æ€çš„åº”ç”¨åˆ™æ¯”è¾ƒå¤æ‚ã€‚Operator çš„è®¾è®¡æ—¨åœ¨ç®€åŒ–å¤æ‚æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†ï¼Œå…¶é€šè¿‡CRDæ‰©å±• Kubernetes API æ¥è‡ªåŠ¨åˆ›å»ºã€ç®¡ç†å’Œé…ç½®åº”ç”¨å®ä¾‹ã€‚å…¶æœ¬è´¨ä¸Šæ˜¯é’ˆå¯¹ç‰¹å®šçš„åœºæ™¯å»åšæœ‰çŠ¶æ€æœåŠ¡ï¼Œæˆ–è€…è¯´é’ˆå¯¹å¤æ‚åº”ç”¨åœºæ™¯å»ç®€åŒ–å…¶è¿ç»´ç®¡ç†çš„å·¥å…·ã€‚\nOperatorä»¥deploymentçš„å½¢å¼éƒ¨ç½²åˆ°K8Sä¸­ã€‚éƒ¨ç½²å®Œè¿™ä¸ªOperatorä¹‹åï¼Œæƒ³è¦éƒ¨ç½²ä¸€ä¸ªé›†ç¾¤ï¼Œå…¶å®å¾ˆæ–¹ä¾¿ã€‚å› ä¸ºä¸éœ€è¦å†å»ç®¡ç†è¿™ä¸ªé›†ç¾¤çš„é…ç½®ä¿¡æ¯äº†ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ªCRDï¼ŒæŒ‡å®šåˆ›å»ºå¤šå°‘ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦ä»€ä¹ˆç‰ˆæœ¬ï¼ŒOperatorä¼šç›‘å¬è¯¥èµ„æºå¯¹è±¡ï¼Œåˆ›å»ºå‡ºç¬¦åˆé…ç½®è¦æ±‚çš„é›†ç¾¤ï¼Œä»è€Œå¤§å¤§ç®€åŒ–è¿ç»´çš„éš¾åº¦å’Œæˆæœ¬ã€‚\nå¼€å‘ä¸åŒä¸­é—´ä»¶operatoræµç¨‹å¤§ä½“ç›¸åŒï¼Œä¸‹é¢ä»¥redis operatorè¿›è¡Œè¯´æ˜ï¼š\né¦–å…ˆå‡†å¤‡ # éœ€è¦ä¸€ä¸ªèµ„æºå¯¹è±¡å®šä¹‰ï¼ˆCRDï¼‰yamlï¼Œoperatorä»£ç ä¸­ä¼šæ ¹æ®è¯¥yamlå»ç»„è£…å¹¶åˆ›å»ºCRDã€‚ apiVersion: apiextensions.k8s.io/v1beta1 kind: CustomResourceDefinition metadata: name: redisclusters.redis.middleware.hc.cn spec: group: redis.middleware.hc.cn version: v1alpha1 scope: Namespaced names: kind: RedisCluster singular: rediscluster listKind: RedisClusterList plural: redisclusters shortNames: - rec åé¢åˆ›å»ºçš„è¯¥CRDç±»å‹çš„èµ„æºå¯¹è±¡ï¼ˆCRï¼‰ï¼Œå…¶kindä¸ºè¯¥yamlæè¿°ä¸­spec.names.kindçš„å€¼ã€‚CRç›¸å½“äºCRDçš„å…·ä½“å®ç°ã€‚ï¼ˆä¸åŒçš„operatorï¼ŒCRDã€CRå®šä¹‰ä¸åŒï¼‰ï¼›\nå‡†å¤‡ä¸€ä¸ªCR yamlæ–‡ä»¶ï¼Œåé¢operatorä»£ç è¦æ ¹æ®è¯¥yamlç»“æ„åœ¨types.goä¸­å®šä¹‰ç»“æ„ä½“ã€‚redisçš„CR yamlå¦‚ä¸‹ã€‚operatoræœ€ç»ˆä¼šç›‘å¬è¯¥CRï¼Œè§£æé‡Œé¢å®šä¹‰çš„èŠ‚ç‚¹æ•°ã€ç‰ˆæœ¬å·ç­‰å‚æ•°ï¼Œé©±åŠ¨åšä¸€äº›äº‹æƒ…ã€‚ apiVersion: redis.middleware.hc.cn/v1alpha1 kind: RedisCluster metadata: name: example000-redis-cluster namespace: kube-system spec: # ä»£è¡¨redisé›†ç¾¤çš„ä¸ªæ•° replicas: 7 # ä»£è¡¨æ˜¯å¦è¿›å…¥ç»´ä¿®çŠ¶æ€ pause: true # æ˜¯å¦åˆ é™¤crdä»¥åŠredisé›†ç¾¤ finalizers: foreground # é•œåƒåœ°å€ repository: library/redis # é•œåƒç‰ˆæœ¬ï¼Œä¾¿äºåç»­å¤šç‰ˆæœ¬ç‰¹åŒ–æ”¯æŒ version: 3.2.8 #redisé›†ç¾¤å‡çº§ç­–ç•¥ updateStrategy: # å‡çº§ç±»å‹ä¸ºAutoReceiveï¼ˆè‡ªåŠ¨åˆ†é…,ä¸ç”¨AssignStrategiesï¼‰, AssignReceiveï¼ˆæŒ‡å®šå€¼åˆ†é…ï¼Œéœ€è¦ç”¨AssignStrategiesï¼‰ type: AssignReceive pipeline: \u0026#34;100\u0026#34; assignStrategies: - slots: 2000 fromReplicas: nodeId1 - # ä»nodeId3,nodeId4ä¸€å…±åˆ†é…1000ä¸ªå¡æ§½ slots: 1000 # å¤šä¸ªnodeIdç”¨é€—å·åˆ†éš” fromReplicas: nodeId3,nodeId4 # redis å®ä¾‹é…ç½®è¯¦æƒ… pod: # æ ‡ç­¾ç®¡ç†ï¼šmap[string][string] - labels: key: value # å¤‡æ³¨ç®¡ç†ï¼šmap[string][string] annotations: key: value # ç¯å¢ƒå˜é‡ç®¡ç† env: - name: tony value: aa - name: MAXMEMORY value: 2gb # äº²å’Œæ€§ç®¡ç† affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: HC_Status operator: In values: - C podAntiAffinity: {} # èµ„æºç®¡ç† resources: limits: #cpu, memory, storage,ephemeral-storage cpu: \u0026#34;2\u0026#34; memory: 4Gi requests: cpu: \u0026#34;1\u0026#34; memory: 2Gi #statefulsetæ›´æ–°æ¨¡å¼ updateStrategy: type: RollingUpdate # æ”¯æŒæŒ‚è½½å½¢å¼ï¼š hostPath(ä¸éœ€è¦persistentVolumeClaimName)ï¼Œnfs(éœ€è¦persistentVolumeClaimName) volumes: type: nfs persistentVolumeClaimName: pvcName # é…ç½®æ–‡ä»¶æ¨¡æ¿å configmap: name # ç›‘æ§é•œåƒ monitorImage: string # åˆå§‹åŒ–é•œåƒ initImage: string # ä¸­é—´ä»¶å®¹å™¨é•œåƒ middlewareImage: string status: #å½“å‰statefulset replicasæƒ…å†µ replicas: 6 # é›†ç¾¤é˜¶æ®µ,None,Creating,Running,Failed,Scaling # None æˆ– â€œâ€ï¼Œ å°±æ˜¯ä»£è¡¨è¯¥CRDåˆšåˆ›å»º # Creating ä»£è¡¨ç­‰å¾…redisèµ„æºå¯¹è±¡åˆ›å»ºå®Œæ¯•ï¼ˆoperator å‘ç°CRDåˆ›å»ºï¼Œåˆ›å»ºèµ„æºå¯¹è±¡ï¼Œæ›´æ–°çŠ¶æ€ï¼‰ # Running ä»£è¡¨å·²è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼ˆåœ¨Creatingä¹‹åï¼Œå‘ç°å®ä¾‹èµ·æ¥å®Œæ¯•ï¼Œåˆå§‹åŒ–æ“ä½œï¼‰ # Failed ä»£è¡¨ç€æŸå¼‚å¸¸æ•…éšœ # --------------------- # Scaling ä»£è¡¨ç€å®ä¾‹ä¸ä¸€è‡´(ç”¨æˆ·ä¿®æ”¹å®ä¾‹ï¼Œoperatorå‘ç°å®ä¾‹ä¸ä¸€è‡´ï¼Œæ›´æ–°statefulsetï¼Œæ›´æ–°çŠ¶æ€) # Upgrading ä»£è¡¨ç€å‡çº§ä¸­ # --------------------- phase: Creating # å¼‚å¸¸é—®é¢˜è§£é‡Š reason: \u0026#34;å¼‚å¸¸é—®é¢˜\u0026#34; conditions: - name: redis-cluster-0 instance: 10.168.78.90:6379 type: master masterNodeId: allkk111snknkcs nodeId: allkk111snknkcs domainName: redis-cluster-0.redis-cluster.kube-system.svc.cluster.local slots: 1024-2048 hostname: docker-vm-3 hostIP: 192.168.26.122 # true or flase status: \u0026#34;True\u0026#34; reason: xxxx message: xxxx lastTransitionTime: 2019-03-25T03:10:29Z ä»£ç ç”Ÿæˆ # ä¸»è¦ç”Ÿæˆç¬¦åˆk8sé£æ ¼çš„ä»£ç ï¼š\nç”Ÿæˆé£æ ¼ç»Ÿä¸€çš„DeepCopyï¼ˆCustomResourceså¿…é¡»å®ç°runtime.Objectæ¥å£â€”â€”å¿…é¡»å®ç°DeepCopyæ–¹æ³•ï¼‰ï¼› clientsetï¼ˆè‡ªå®šä¹‰èµ„æºå¯¹è±¡çš„å®¢æˆ·ç«¯ï¼‰ï¼› listersï¼ˆç”¨æ¥æä¾›å¯¹äº GET/List èµ„æºå¯¹è±¡çš„è¯·æ±‚æä¾›åªè¯»ç¼“å­˜å±‚ï¼‰ï¼› informersï¼ˆList/Get èµ„æºå¯¹è±¡ï¼Œè¿˜å¯ä»¥ç›‘å¬äº‹ä»¶å¹¶è§¦å‘å›è°ƒå‡½æ•°ã€‚ ç»“æ„ä½“å®šä¹‰åˆ°$ProjectName/pkg/apis/{ä¸­é—´ä»¶åç§°}/{ç‰ˆæœ¬å·}/types.goé‡Œï¼š\ntypes.goä¸­ç»“æ„ä½“å®šä¹‰æ ¹æ®ä¸Šé¢å‡†å¤‡çš„CR yamlå®šä¹‰ã€‚å¦‚ä¸‹ï¼Œå…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¿…é¡»è¦ç»™ç»“æ„ä½“åŠ ä»¥ä¸‹ä¸¤ä¸ªæ³¨è§£ï¼š\n// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Objectæ³¨è§£è¡¨ç¤ºï¼šä¸ºè¯¥ç±»å‹ç”Ÿæˆ func (t* T) DeepCopy() *Tæ–¹æ³•ã€‚APIç±»å‹éƒ½éœ€è¦å®ç°æ·±æ‹·è´ï¼› // +genclientæ³¨è§£è¡¨ç¤ºä¸ºå½“å‰ç±»å‹ç”Ÿæˆå®¢æˆ·ç«¯ã€‚\n3ã€ç¼–å†™$ProjectName/pkg/apis/{ä¸­é—´ä»¶åç§°}/{ç‰ˆæœ¬å·}/doc.goï¼Œå…¶ä¸­å®šä¹‰å…¨å±€tagï¼š// +k8s:deepcopy-gen=packageï¼Œè¡¨ç¤ºä¸ºåŒ…ä¸­ä»»ä½•ç±»å‹ç”Ÿæˆæ·±æ‹·è´æ–¹æ³•ã€‚packageæŒ‡å®šç‰ˆæœ¬ã€‚\n4ã€ç¼–å†™$ProjectName/pkg/apis/{ä¸­é—´ä»¶åç§°}/{ç‰ˆæœ¬å·}/register.goï¼Œé€šè¿‡schemeæ³¨å†Œè‡ªå®šä¹‰CRç±»å‹ï¼Œè¿™æ ·å½“å’ŒAPI Serveré€šä¿¡çš„æ—¶å€™å°±èƒ½å¤Ÿå¤„ç†è¯¥ç±»å‹ï¼›ï¼ˆä¸åŒoperatoréœ€è¦ä¿®æ”¹SchemeGroupVersionçš„Groupå’ŒVersionä»¥åŠaddKnownTypesä¸­æ³¨å†Œçš„ç»“æ„ä½“ï¼‰\npackage v1alpha1 import ( \u0026#34;harmonycloud.cn/middleware-operator-manager/pkg/apis/redis\u0026#34; v1 \u0026#34;k8s.io/apimachinery/pkg/apis/meta/v1\u0026#34; \u0026#34;k8s.io/apimachinery/pkg/runtime\u0026#34; \u0026#34;k8s.io/apimachinery/pkg/runtime/schema\u0026#34; ) // SchemeGroupVersion is group version used to register these objects var SchemeGroupVersion = schema.GroupVersion {Group: redis.GroupName, Version: \u0026#34;v1alpha1\u0026#34;} // Kind takes an unqualified kind and returns back a Group qualified GroupKind func Kind(kind string) schema.GroupKind { return SchemeGroupVersion.WithKind(kind).GroupKind() } // Resource takes an unqualified resource and returns a Group qualified GroupResource func Resource(resource string) schema.GroupResource { return SchemeGroupVersion.WithResource(resource).GroupResource() } var ( SchemeBuilder = runtime.NewSchemeBuilder(addKnownTypes) AddToScheme = SchemeBuilder.AddToScheme ) //æ³¨å†ŒCRå¯¹è±¡ // Adds the list of known types to Scheme. func addKnownTypes(scheme *runtime.Scheme) error { scheme.AddKnownTypes(SchemeGroupVersion, \u0026amp;RedisCluster{}, \u0026amp;RedisClusterList{}, ) v1.AddToGroupVersion(scheme, SchemeGroupVersion) return nil } 5ã€ç¼–å†™$ProjectName/pkg/apis/{ä¸­é—´ä»¶åç§°}/register.goï¼Œå…¶ä¸­å®šä¹‰äº†ä¸Šä¸€æ­¥ç”¨åˆ°çš„GroupNameï¼›\n6ã€ä½¿ç”¨kubernetesæä¾›çš„code-generatorä»£ç ç”Ÿæˆå™¨å·¥å…·ï¼Œæ ¹æ®å®šä¹‰å¥½çš„CRç»“æ„ä½“å¯¹è±¡ç”Ÿæˆé£æ ¼ç»Ÿä¸€çš„DeepCopyï¼ˆCustomResourceså¿…é¡»å®ç°runtime.Objectæ¥å£â€”â€”å¿…é¡»å®ç°DeepCopyæ–¹æ³•ï¼‰ã€clientsetï¼ˆè‡ªå®šä¹‰èµ„æºå¯¹è±¡çš„å®¢æˆ·ç«¯ï¼‰ã€listersï¼ˆç”¨æ¥æä¾›å¯¹äº GET/List èµ„æºå¯¹è±¡çš„è¯·æ±‚æä¾›åªè¯»ç¼“å­˜å±‚ï¼‰ã€informersï¼ˆList/Get èµ„æºå¯¹è±¡ï¼Œè¿˜å¯ä»¥ç›‘å¬äº‹ä»¶å¹¶è§¦å‘å›è°ƒå‡½æ•°ï¼‰ä»£ç ã€‚\ncode-generatoråœ°å€å¦‚ä¸‹ï¼Œä¸‹è½½åæ”¾åˆ°$GOPATH/src/k8s.io/ç›®å½•ä¸‹ï¼š\nhttps://github.com/kubernetes/code-generator\nç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œharmonycloud.cn/middleware-operator-manager/pkg/clientsè¡¨ç¤ºæœ€ç»ˆç”Ÿæˆçš„clientsetã€informersã€listersä»£ç ç›®å½•ï¼Œæœ€åçš„redis:v1alpha1éœ€è¦æ”¹æˆ{ä¸­é—´ä»¶åç§°}:{ç‰ˆæœ¬}\n./generate-groups.sh all \u0026#34;harmonycloud.cn/middleware-operator-manager/pkg/clients\u0026#34; \u0026#34;harmonycloud.cn/middleware-operator-manager/pkg/apis\u0026#34; \u0026#34;redis:v1alpha1\u0026#34; æ‰§è¡Œåå°†ç”Ÿæˆä»¥ä¸‹ä»£ç ï¼š\nç”Ÿæˆä»£ç æ—¶å¯èƒ½é‡åˆ°çš„å‘ï¼Œè¯·å‚è€ƒï¼š\nk8sè‡ªå®šä¹‰èµ„æºç±»å‹ä»£ç è‡ªåŠ¨ç”Ÿæˆï¼š https://www.jianshu.com/p/cbeb513250d0\nå‚è€ƒï¼š\né€šè¿‡è‡ªå®šä¹‰èµ„æºæ‰©å±•Kubernetes\nExtending Kubernetes: Create Controllers for Core and Custom Resources\noperatorä¸»æµç¨‹ä»£ç å¼€å‘ # é¦–å…ˆoperatorçš„å…¥å£ä¸ºoperator-manager.goé‡Œçš„mainå‡½æ•°ã€‚\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/spf13/pflag\u0026#34; \u0026#34;harmonycloud.cn/middleware-operator-manager/cmd/operator-manager/app\u0026#34; \u0026#34;harmonycloud.cn/middleware-operator-manager/cmd/operator-manager/app/options\u0026#34; \u0026#34;k8s.io/apiserver/pkg/util/flag\u0026#34; \u0026#34;k8s.io/apiserver/pkg/util/logs\u0026#34; \u0026#34;k8s.io/kubernetes/pkg/version/verflag\u0026#34; \u0026#34;os\u0026#34; ) func main() { //å‚æ•°åˆå§‹åŒ–é…ç½® s := options.NewOMServer() s.AddFlags(pflag.CommandLine, app.KnownOperators()) flag.InitFlags() //æ—¥å¿—åˆå§‹åŒ– logs.InitLogs() defer logs.FlushLogs() verflag.PrintAndExitIfRequested() //è¿›è¡Œoperatoråˆå§‹åŒ– if err := app.Run(s); err != nil { fmt.Fprintf(os.Stderr, \u0026#34;%v\\n\u0026#34;, err) os.Exit(1) } } mainå‡½æ•°ä¸­é¦–å…ˆè¿›è¡Œå¯¹å‚æ•°çš„åˆå§‹åŒ–ï¼Œå…¶ä¸­ä¸»è¦åŒ…æ‹¬ï¼šoperatorå¤šå®ä¾‹æ—¶çš„é€‰ä¸»é…ç½®ï¼›äº‹ä»¶åŒæ­¥æ—¶é—´ï¼›é›†ç¾¤åˆ›å»ºã€å‡çº§è¶…æ—¶æ—¶é—´ï¼›æ˜¯å¦å¯ç”¨leaderåŠŸèƒ½ï¼›æ˜¯å¦å¼€å¯pprofåˆ†æåŠŸèƒ½ç­‰ï¼Œä»£ç åœ¨options.goä¸­ã€‚\napp.Run(s)æ ¹æ®å‚æ•°é…ç½®è¿›è¡Œoperatoråˆå§‹åŒ–ï¼š\né¦–å…ˆæ ¹æ®å‚æ•°é…ç½®ï¼Œæ„å»ºé»˜è®¤å®¢æˆ·ç«¯ï¼ˆæ“ä½œk8så·²æœ‰èµ„æºå¯¹è±¡ï¼‰ã€leaderé€‰ä¸¾å®¢æˆ·ç«¯ã€æ“ä½œæ‰©å±•èµ„æºå®¢æˆ·ç«¯ç­‰ï¼› ä¹‹ååˆ›å»ºCRDèµ„æºå¯¹è±¡å®šä¹‰ï¼Œåç»­åˆ›å»ºçš„CRå¯¹è±¡éƒ½æ˜¯è¯¥CRDçš„å®ä¾‹ï¼› æ³¨å†Œå¥åº·æ£€æŸ¥æ¥å£ã€æ ¹æ®å¯åŠ¨å‚æ•°é…ç½®å†³å®šæ˜¯å¦å¼€å¯pprofåˆ†ææ¥å£åŠŸèƒ½ï¼› åˆ›å»ºrecorderï¼Œä¸»è¦ç”¨äºè®°å½•eventsï¼ˆk8sèµ„æºï¼‰ï¼Œç”¨äºæ“ä½œå®¡è®¡ï¼› å®šä¹‰Runå‡½æ•°ï¼Œè¿›è¡Œå¯åŠ¨operatorï¼Œé€‰ä¸¾ç»“æœçš„leaderæ‰§è¡Œè¯¥å‡½æ•°ï¼› åˆ¤æ–­æ˜¯å¦å¼€å¯leaderé€‰ä¸¾åŠŸèƒ½ï¼› åˆ›å»ºleaderé€‰ä¸¾çš„èµ„æºé”ï¼Œç›®å‰èµ„æºé”å®ç°äº†configmapså’Œendpointsæ–¹å¼ï¼Œå…·ä½“ä»£ç åœ¨client-goä¸‹ï¼Œé»˜è®¤ä½¿ç”¨endpointsæ–¹å¼ï¼› å¯åŠ¨leaderé€‰ä¸¾æœºåˆ¶ï¼Œäº‰æŠ¢åˆ°é”ï¼Œé€‰ä¸¾ä¸ºleaderçš„å®ä¾‹æ‰§è¡ŒOnStartedLeadingï¼Œå³ä¸Šé¢å®šä¹‰çš„Runå‡½æ•°ï¼›å¤±å»é”çš„å®ä¾‹æ‰§è¡ŒOnStoppedLeadingå‡½æ•°ã€‚ // Run runs the OMServer. This should never exit. func Run(s *options.OperatorManagerServer) error { // To help debugging, immediately log version glog.Infof(\u0026#34;Version: %+v\u0026#34;, version.Get()) //æ ¹æ®å‚æ•°é…ç½®ï¼Œæ„å»ºé»˜è®¤å®¢æˆ·ç«¯ï¼ˆæ“ä½œk8så·²æœ‰èµ„æºå¯¹è±¡ï¼‰ã€leaderé€‰ä¸¾å®¢æˆ·ç«¯ã€æ“ä½œæ‰©å±•èµ„æºå®¢æˆ·ç«¯ç­‰ kubeClient, leaderElectionClient, extensionCRClient, kubeconfig, err := createClients(s) if err != nil { return err } //æ ¹æ®æå‰å‡†å¤‡å¥½çš„CRD yamlæ–‡ä»¶ï¼Œæ„å»ºå¹¶åˆ›å»ºCRD err = CreateRedisClusterCRD(extensionCRClient) if err != nil { if errors.IsAlreadyExists(err) { glog.Infof(\u0026#34;redis cluster crd is already created.\u0026#34;) } else { fmt.Fprint(os.Stderr, err) return err } } //æ³¨å†Œå¥åº·æ£€æŸ¥æ¥å£ã€æ ¹æ®å¯åŠ¨å‚æ•°é…ç½®å†³å®šæ˜¯å¦å¼€å¯pprofåˆ†ææ¥å£åŠŸèƒ½ go startHTTP(s) //åˆ›å»ºrecorderï¼Œä¸»è¦ç”¨äºè®°å½•eventsï¼ˆk8sèµ„æºï¼‰ recorder := createRecorder(kubeClient) //å®šä¹‰Runå‡½æ•°ï¼Œè¿›è¡Œå¯åŠ¨operatorï¼Œé€‰ä¸¾ç»“æœçš„leaderæ‰§è¡Œè¯¥å‡½æ•° run := func(stop \u0026lt;-chan struct{}) { operatorClientBuilder := operator.SimpleOperatorClientBuilder{ ClientConfig: kubeconfig, } rootClientBuilder := controller.SimpleControllerClientBuilder{ ClientConfig: kubeconfig, } otx, err := CreateOperatorContext(s, kubeconfig, operatorClientBuilder, rootClientBuilder, stop) if err != nil { glog.Fatalf(\u0026#34;error building controller context: %v\u0026#34;, err) } otx.InformerFactory = informers.NewSharedInformerFactory(kubeClient, time.Duration(s.ResyncPeriod)*time.Second) if err := StartOperators(otx, NewOperatorInitializers()); err != nil { glog.Fatalf(\u0026#34;error starting operators: %v\u0026#34;, err) } otx.RedisInformerFactory.Start(otx.Stop) otx.InformerFactory.Start(otx.Stop) close(otx.InformersStarted) select {} } //åˆ¤æ–­æ˜¯å¦å¼€å¯leaderé€‰ä¸¾åŠŸèƒ½ if !s.LeaderElection.LeaderElect { run(nil) panic(\u0026#34;unreachable\u0026#34;) } id, err := os.Hostname() if err != nil { return err } //åˆ›å»ºleaderé€‰ä¸¾çš„èµ„æºé”ï¼Œç›®å‰èµ„æºé”å®ç°äº†configmapså’Œendpointsæ–¹å¼ï¼Œå…·ä½“ä»£ç åœ¨client-goä¸‹ï¼Œé»˜è®¤ä½¿ç”¨endpointsæ–¹å¼ rl, err := resourcelock.New(s.LeaderElection.ResourceLock, \u0026#34;kube-system\u0026#34;, \u0026#34;middleware-operator-manager\u0026#34;, leaderElectionClient.CoreV1(), resourcelock.ResourceLockConfig{ Identity: id, EventRecorder: recorder, }) if err != nil { glog.Fatalf(\u0026#34;error creating lock: %v\u0026#34;, err) } //å¯åŠ¨leaderé€‰ä¸¾æœºåˆ¶ï¼Œäº‰æŠ¢åˆ°é”ï¼Œé€‰ä¸¾ä¸ºleaderçš„å®ä¾‹æ‰§è¡ŒOnStartedLeadingï¼Œå³ä¸Šé¢å®šä¹‰çš„Runå‡½æ•°ï¼›å¤±å»é”çš„å®ä¾‹æ‰§è¡ŒOnStoppedLeadingå‡½æ•° leaderelection.RunOrDie(leaderelection.LeaderElectionConfig{ Lock: rl, LeaseDuration: s.LeaderElection.LeaseDuration.Duration, RenewDeadline: s.LeaderElection.RenewDeadline.Duration, RetryPeriod: s.LeaderElection.RetryPeriod.Duration, Callbacks: leaderelection.LeaderCallbacks{ OnStartedLeading: run, OnStoppedLeading: func() { glog.Fatalf(\u0026#34;leaderelection lost\u0026#34;) }, }, }) panic(\u0026#34;unreachable\u0026#34;) } CreateRedisClusterCRDæ–¹æ³•æ ¹æ®ä¸Šé¢å‡†å¤‡çš„CRD yamlæ–‡ä»¶æ„å»ºå¹¶åˆ›å»ºCRDï¼Œåªæœ‰åˆ›å»ºäº†è¯¥CRDï¼ŒredisClusterèµ„æºå¯¹è±¡æ‰å¯ä»¥è¢«åˆ›å»ºã€‚\nfunc CreateRedisClusterCRD(extensionCRClient *extensionsclient.Clientset) error { //TODO add CustomResourceValidation due to guarantee redis operator work normally,k8s1.12 crd := \u0026amp;v1beta1.CustomResourceDefinition{ ObjectMeta: metav1.ObjectMeta{ Name: \u0026#34;redisclusters.\u0026#34; + v1alpha1.SchemeGroupVersion.Group, }, Spec: v1beta1.CustomResourceDefinitionSpec{ Group: v1alpha1.SchemeGroupVersion.Group, Version: v1alpha1.SchemeGroupVersion.Version, Scope: v1beta1.NamespaceScoped, Names: v1beta1.CustomResourceDefinitionNames{ Kind: \u0026#34;RedisCluster\u0026#34;, ListKind: \u0026#34;RedisClusterList\u0026#34;, Plural: \u0026#34;redisclusters\u0026#34;, Singular: \u0026#34;rediscluster\u0026#34;, ShortNames: []string{\u0026#34;rec\u0026#34;}, }, }, } _, err := extensionCRClient.ApiextensionsV1beta1().CustomResourceDefinitions().Create(crd) return err } CRçš„apiVersionä¸ºCRDçš„spec.Group/spec.Versionå³ç”Ÿæˆä»£ç æ—¶register.goä¸­çš„GroupNameå’Œdoc.goä¸­çš„ç‰ˆæœ¬å·ï¼š\napiVersion: redis.middleware.hc.cn/v1alpha1 kind: RedisCluster metadata: name: example000-redis-cluster namespace: kube-system Runå‡½æ•°ä¸­ä¸»è¦åˆ›å»ºcontextå¯¹è±¡ï¼Œcontexté‡ŒåŒ…å«å¯åŠ¨å‚æ•°optionsï¼Œkubeconfigé…ç½®ã€RedisInformerFactoryï¼ˆç›‘å¬CRå˜åŒ–ï¼‰ã€InformerFactoryï¼ˆç›‘å¬statefulsetsetå˜åŒ–ï¼‰ç­‰ï¼Œè¿›è¡Œå¯åŠ¨operatorã€å¯åŠ¨informerã€‚\nrun := func(stop \u0026lt;-chan struct{}) { operatorClientBuilder := operator.SimpleOperatorClientBuilder{ ClientConfig: kubeconfig, } rootClientBuilder := controller.SimpleControllerClientBuilder{ ClientConfig: kubeconfig, } //åˆ›å»ºcontextå¯¹è±¡ï¼Œcontexté‡ŒåŒ…å«å¯åŠ¨å‚æ•°optionsï¼Œkubeconfigé…ç½®ã€RedisInformerFactoryï¼ˆç›‘å¬CRå˜åŒ–ï¼‰ã€InformerFactoryï¼ˆç›‘å¬statefulsetsetå˜åŒ–ï¼‰ç­‰ otx, err := CreateOperatorContext(s, kubeconfig, operatorClientBuilder, rootClientBuilder, stop) if err != nil { glog.Fatalf(\u0026#34;error building controller context: %v\u0026#34;, err) } //åˆ›å»ºInformerFactory otx.InformerFactory = informers.NewSharedInformerFactory(kubeClient, time.Duration(s.ResyncPeriod)*time.Second) //å¯åŠ¨operatorï¼ŒNewOperatorInitializers()ä¸­å®šä¹‰äº†å¯åŠ¨å“ªäº›operator if err := StartOperators(otx, NewOperatorInitializers()); err != nil { glog.Fatalf(\u0026#34;error starting operators: %v\u0026#34;, err) } //å¯åŠ¨RedisInformerFactory otx.RedisInformerFactory.Start(otx.Stop) //å¯åŠ¨InformerFactory otx.InformerFactory.Start(otx.Stop) close(otx.InformersStarted) //é˜»å¡ select {} } NewOperatorInitializers()ä¸­å®šä¹‰äº†å¯åŠ¨å“ªäº›operatorï¼ˆæ–°åŠ operatorç›´æ¥åœ¨è¯¥æ–¹æ³•ä¸­åŠ ï¼‰ï¼š\nfunc NewOperatorInitializers() map[string]InitFunc { controllers := map[string]InitFunc{} controllers[\u0026#34;rediscluster\u0026#34;] = startRedisClusterController return controllers } CreateOperatorContextå‡½æ•°é‡Œæ ¹æ®ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆçš„rediså®¢æˆ·ç«¯versionedClientåˆ›å»ºäº†RedisInformerFactoryï¼›ï¼ˆæ ¹æ®ä¸åŒoperatorç”Ÿæˆä¸åŒçš„å®¢æˆ·ç«¯ï¼Œè¿™é‡Œéœ€è¦ä¿®æ”¹client_builder.goä¸­ClientOrDieçš„è¿”å›å€¼ç±»å‹ï¼‰ï¼Œæœ€ç»ˆåˆ›å»ºcontextå¯¹è±¡ã€‚\nfunc CreateOperatorContext(s *options.OperatorManagerServer, kubeConfig *restclient.Config, operatorClientBuilder operator.OperatorClientBuilder, rootClientBuilder controller.ControllerClientBuilder, stop \u0026lt;-chan struct{}) (OperatorContext, error) { versionedClient := operatorClientBuilder.ClientOrDie(\u0026#34;middleware-shared-informers\u0026#34;) sharedInformers := redisInformerFactory.NewSharedInformerFactory(versionedClient, time.Duration(s.ResyncPeriod)*time.Second) /*availableResources, err := GetAvailableResources(rootClientBuilder) if err != nil { return OperatorContext{}, err }*/ otx := OperatorContext{ kubeConfig: kubeConfig, OperatorClientBuilder: operatorClientBuilder, DefaultClientBuilder: rootClientBuilder, RedisInformerFactory: sharedInformers, Options: *s, //AvailableResources: availableResources, Stop: stop, InformersStarted: make(chan struct{}), } return otx, nil } StartOperatorså‡½æ•°å¯åŠ¨æ‰€æœ‰NewOperatorInitializersä¸­å®šä¹‰çš„operatorï¼Œæ‰§è¡ŒstartRedisClusterControllerå‡½æ•°ã€‚ï¼ˆä¸åŒoperatoræ‰§è¡Œä¸åŒçš„å¯åŠ¨å‡½æ•°ï¼‰ã€‚\nstartRedisClusterControllerå®šä¹‰åœ¨extensions.goä¸­ï¼Œç”¨äºåˆ›å»ºoperatorã€å¯åŠ¨workeråç¨‹ä»é˜Ÿåˆ—ä¸­å–å‡ºï¼ˆç”¨äºå¤„ç†informerç›‘å¬å˜åŒ–çš„èµ„æºå¯¹è±¡ï¼‰è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚ï¼ˆæ–°å¢operatoréœ€è¦åœ¨extensions.goä¸­å¢åŠ å¯¹åº”çš„startå‡½æ•°ï¼‰\nfunc startRedisClusterController(otx OperatorContext) (bool, error) { //åˆ›å»ºredisOperator rco, err := redis.NewRedisClusterOperator( //æ³¨å†ŒRedisInformerå›è°ƒå‡½æ•° otx.RedisInformerFactory.Cr().V1alpha1().RedisClusters(), //æ³¨å†ŒstatefulsetInformerå›è°ƒå‡½æ•° otx.InformerFactory.Apps().V1().StatefulSets(), //é»˜è®¤å®¢æˆ·ç«¯ï¼Œç”¨äºæ“ä½œk8sè‡ªèº«èµ„æºå¯¹è±¡ otx.DefaultClientBuilder.ClientOrDie(\u0026#34;default-kube-client\u0026#34;), //ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆçš„å®¢æˆ·ç«¯ï¼Œç”¨äºæ“ä½œCR otx.OperatorClientBuilder.ClientOrDie(\u0026#34;rediscluster-operator\u0026#34;), //kubeconfigé…ç½® otx.kubeConfig, //å¯åŠ¨å‚æ•°é…ç½® otx.Options, ) if err != nil { return true, fmt.Errorf(\u0026#34;error creating rediscluster operator: %v\u0026#34;, err) } //å¯åŠ¨ConcurrentRedisClusterSyncsä¸ªworkeråç¨‹å¤„ç†å˜åŒ–çš„èµ„æºå¯¹è±¡ go rco.Run(int(otx.Options.ConcurrentRedisClusterSyncs), otx.Stop) return true, nil } NewRedisClusterOperatoræ–¹æ³•å¦‚ä¸‹ï¼Œä¸»è¦åˆ›å»ºè¯¥operatorçš„ç»“æ„ä½“ï¼Œé˜Ÿåˆ—ï¼ŒredisInformeræ³¨å†Œå›è°ƒå‡½æ•°ï¼ŒstatefulsetInformerå›è°ƒå‡½æ•°çš„æ³¨å†Œã€‚ï¼ˆä¸åŒçš„operatorï¼Œéœ€è¦ä¸åŒçš„Informerã€å¤„ç†ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•ï¼‰\nfunc NewRedisClusterOperator(redisInformer custominfomer.RedisClusterInformer, stsInformer appsinformers.StatefulSetInformer, kubeClient clientset.Interface, customCRDClient customclient.Interface, kubeConfig *rest.Config, options options.OperatorManagerServer) (*RedisClusterOperator, error) { //åˆ›å»ºè¯¥operatorçš„recorderï¼Œè®°å½•events eventBroadcaster := record.NewBroadcaster() eventBroadcaster.StartLogging(glog.Infof) eventBroadcaster.StartRecordingToSink(\u0026amp;v1core.EventSinkImpl{Interface: v1core.New(kubeClient.CoreV1().RESTClient()).Events(\u0026#34;\u0026#34;)}) //åˆ›å»ºè¯¥operatorçš„ç»“æ„ä½“ rco := \u0026amp;RedisClusterOperator{ options: \u0026amp;options, kubeConfig: kubeConfig, defaultClient: kubeClient, //extensionCRClient: extensionCRClient, customCRDClient: customCRDClient, eventRecorder: eventBroadcaster.NewRecorder(scheme.Scheme, v1.EventSource{Component: \u0026#34;operator-manager\u0026#34;}), queue: workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \u0026#34;rediscluster\u0026#34;), } //redisInformeræ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå½“informerç›‘å¬åˆ°redis CRèµ„æºå˜åŒ–æ—¶ï¼Œè°ƒç”¨å¯¹åº”AddFuncã€UpdateFuncã€DeleteFuncå›è°ƒå‡½æ•°å°†CRèµ„æºæ”¾åˆ°queueä¸­ redisInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{ AddFunc: rco.addRedisCluster, UpdateFunc: rco.updateRedisCluster, // This will enter the sync loop and no-op, because the RedisCluster has been deleted from the store. DeleteFunc: rco.deleteRedisCluster, }) //å®šä¹‰æœ€ç»ˆå¤„ç†ä¸šåŠ¡é€»è¾‘çš„å‡½æ•° rco.syncHandler = rco.syncRedisCluster rco.enqueueRedisCluster = rco.enqueue rco.redisClusterInformer = redisInformer.Informer() //redisInformeræ˜¯å¦å·²ç»å¼€å§‹åŒæ­¥äº‹ä»¶å˜åŒ– rco.redisClusterListerSynced = rco.redisClusterInformer.HasSynced //listeræä¾›æ“ä½œinformerä¸­ç¼“å­˜çš„å˜åŒ–çš„èµ„æºæ¥å£ rco.redisClusterLister = redisInformer.Lister() //statefulsetInformeræ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå½“informerç›‘å¬åˆ°statefulsetèµ„æºå˜åŒ–æ—¶ï¼Œè°ƒç”¨å¯¹åº”AddFuncã€UpdateFuncã€DeleteFuncå›è°ƒå‡½æ•°å°†rediså®ä¾‹çš„statefulsetåŠ å…¥åˆ°queueä¸­ stsInformer.Informer().AddEventHandler( cache.ResourceEventHandlerFuncs{ AddFunc: rco.addStatefulSet, UpdateFunc: func(old, cur interface{}) { oldSts := old.(*appsv1.StatefulSet) curSts := cur.(*appsv1.StatefulSet) if oldSts.Status.Replicas != curSts.Status.Replicas { glog.V(4).Infof(\u0026#34;Observed updated replica count for StatefulSet: %v, %d-\u0026gt;%d\u0026#34;, curSts.Name, oldSts.Status.Replicas, curSts.Status.Replicas) } rco.updateStatefulSet(oldSts, curSts) }, DeleteFunc: rco.deleteStatefulSet, }, ) rco.stsLister = stsInformer.Lister() //statefulsetInformeræ˜¯å¦å·²ç»å¼€å§‹åŒæ­¥äº‹ä»¶å˜åŒ– rco.stsListerSynced = stsInformer.Informer().HasSynced return rco, nil } Runå‡½æ•°ä¸­ç­‰å¾…redis CRèµ„æºã€statefulsetèµ„æºå¯¹è±¡åŒæ­¥ï¼Œç„¶åå¯åŠ¨æŒ‡å®šä¸ªæ•°workerï¼Œå¹¶æ°¸ä¹…é˜»å¡ï¼Œç›´åˆ°stopChè¢«closeï¼ˆä¸åŒoperatoréœ€è¦ä¿®æ”¹rco.redisClusterListerSyncedä¸ºå¯¹åº”çš„ListerSyncedï¼‰\nfunc (rco *RedisClusterOperator) Run(workers int, stopCh \u0026lt;-chan struct{}) { defer utilruntime.HandleCrash() defer rco.queue.ShutDown() glog.Infof(\u0026#34;Starting rediscluster operator\u0026#34;) defer glog.Infof(\u0026#34;Shutting down rediscluster operator\u0026#34;) //ç­‰å¾…redis CRèµ„æºã€statefulsetèµ„æºå¯¹è±¡åŒæ­¥ã€‚ if !controller.WaitForCacheSync(\u0026#34;rediscluster\u0026#34;, stopCh, rco.redisClusterListerSynced, rco.stsListerSynced) { return } //å¾ªç¯å¯åŠ¨æŒ‡å®šä¸ªæ•°workerï¼Œå¹¶æ°¸ä¹…é˜»å¡ï¼Œç›´åˆ°stopChè¢«close for i := 0; i \u0026lt; workers; i++ { go wait.Until(rco.worker, time.Second, stopCh) } \u0026lt;-stopCh } workeræ–¹æ³•æ­»å¾ªç¯rco.processNextWorkItem()åœ¨é˜Ÿåˆ—Operatorä¸­å®šä¹‰çš„queueä¸­å–å‡ºå˜åŒ–çš„èµ„æºå»å¤„ç†ï¼ˆä¸åŒoperatoræœ‰ä¸åŒçš„ä¸šåŠ¡å¤„ç†é€»è¾‘ï¼‰\nfunc (rco *RedisClusterOperator) worker() { for rco.processNextWorkItem() { } } ä»informerç›‘å¬åˆ°èµ„æºå¯¹è±¡å˜åŒ–ï¼Œå›è°ƒå‡½æ•°å°†èµ„æºå¯¹è±¡keyï¼ˆnamespace/nameï¼‰æ”¾åˆ°queueä¸­ï¼Œåˆ°workerå–å‡ºqueueä¸­çš„keyå»åšå¤„ç†ï¼Œå¤„ç†å®ŒæˆåDoneæ‰keyæµç¨‹å›¾å¦‚ä¸‹ï¼š\nå›è°ƒå‡½æ•°å°†èµ„æºå¯¹è±¡çš„keyåŠ å…¥åˆ°queueä¸­ï¼Œworkerä»queueä¸­å–å‡ºkeyå»å¤„ç†ä¸šåŠ¡ï¼Œæ­¤æ—¶keyä¼šè¢«æ”¾åˆ°processingé›†åˆä¸­ï¼Œè¡¨ç¤ºè¯¥keyæ­£åœ¨è¢«å¤„ç†ã€‚workerå¤„ç†keyæ—¶å¦‚æœé‡åˆ°é”™è¯¯ï¼Œè¯¥keyä¼šæ ¹æ®é‡è¯•æ¬¡æ•°æ˜¯å¦å¤§äºæœ€å¤§é‡è¯•æ¬¡æ•°è¢«åŠ å…¥åˆ°rateLimitedï¼ˆå¯ä»¥é™åˆ¶æ·»åŠ åˆ°queueä¸­é€Ÿåº¦ï¼Œæœ€ç»ˆè¿˜ä¼šè¢«åŠ å…¥åˆ°queueï¼‰ã€‚workerå¤„ç†keyæˆåŠŸåï¼ŒForget(key)è¡¨ç¤ºä»rateLimitedä¸­æ¸…é™¤ï¼ŒDone(key)è¡¨ç¤ºkeyå¤„ç†å®Œæ¯•ï¼Œä»processingé›†åˆä¸­åˆ é™¤ã€‚è¯¥ä»£ç å¦‚ä¸‹ï¼š\nfunc (rco *RedisClusterOperator) processNextWorkItem() bool { key, quit := rco.queue.Get() if quit { return false } // Done marks item as done processing, and if it has been marked as dirty again // while it was being processed, it will be re-added to the queue for // re-processing. defer rco.queue.Done(key) err := rco.syncHandler(key.(string)) //åŠ å…¥åˆ°rateLimitedä¸­ã€forget(key) rco.handleErr(err, key) //å¤„ç†keyï¼Œä¸»ä¸šåŠ¡é€»è¾‘ go rco.syncHandler(key.(string)) return true } å¼€å‘æ³¨æ„äº‹é¡¹ # å¼€å¯workeræ—¶ï¼Œè°ƒç”¨cache.WaitForCacheSyncç­‰å¾…ç¼“å­˜å¼€å§‹åŒæ­¥ã€‚\nä¸è¦æ”¹å˜åŸå§‹å¯¹è±¡ï¼ˆä»listerä¸­å–å‡ºçš„å¯¹è±¡ï¼‰ï¼Œè€Œè¦ä½¿ç”¨DeepCopyï¼Œå› ä¸ºç¼“å­˜åœ¨informerä¹‹é—´å…±äº«ã€‚\næ ¹æ®CRDæ„å»ºStatefulsetæ—¶ï¼Œç»™StatefulsetåŠ OwnerReferencesï¼Œè¿™æ ·åœ¨åˆ é™¤CRDçš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®æ˜¯å¦çº§è”åˆ é™¤statefulsetã€‚\nå‚è€ƒï¼š\nk8såƒåœ¾æ”¶é›†ï¼š https://kubernetes.io/zh/docs/concepts/workloads/controllers/garbage-collection/\nKubernetesä¹‹Garbage Collectionï¼š https://blog.csdn.net/dkfajsldfsdfsd/article/details/81130786\nè°ƒè¯• # æœ¬åœ°ç”¨IDE\u0026ndash;golandè°ƒè¯•ä»£ç æ—¶ï¼Œé…ç½®å¦‚ä¸‹ï¼š\nRun kindï¼šé€‰Fileï¼›\nFilesï¼šæŒ‡å®šmainå‡½æ•°æ‰€åœ¨æ–‡ä»¶çš„å…¨è·¯å¾„ï¼›\nOutput directoryï¼šæŒ‡å®šç¼–è¯‘åè¾“å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä½ç½®ã€‚å¯è¾“å…¥ã€‚ï¼ˆé»˜è®¤è¾“å‡ºexeæ ¼å¼windowså¯æ‰§è¡Œæ–‡ä»¶ï¼‰\nRun after buildï¼šå‹¾é€‰åï¼Œç¼–è¯‘å®Œæˆåè¿è¡Œã€‚\nGo tool argumentsï¼šå¡«å†™-iï¼ˆç”¨äºå¢é‡ç¼–è¯‘æé€Ÿï¼‰ã€‚\nProgram argumentsï¼šç”¨äºæŒ‡å®šç¨‹åºå¯åŠ¨å‚æ•°ï¼š\n--kubeconfig=D:\\SoftwareAndProgram\\program\\Go\\Development\\src\\harmonycloud.cn\\middleware-operator-manager\\artifacts\\config60 --v=5 \u0026ndash;kubeconfigæŒ‡å®škubeconfigæ–‡ä»¶æ‰€åœ¨å…¨è·¯å¾„ï¼ˆå³k8sé›†ç¾¤masterèŠ‚ç‚¹çš„/root/.kube/configï¼‰ï¼Œå…¶æŒ‡å®šk8sé›†ç¾¤apiserveråœ°å€å·²ç»è®¿é—®æ—¶çš„è¯ä¹¦ä¿¡æ¯ã€‚\n\u0026ndash;væŒ‡å®šglogæ—¥å¿—çº§åˆ«ï¼Œ\u0026ndash;v=5è¡¨ç¤ºåªè¾“å‡ºinfoå°äº5å’Œerrorã€warnæ—¥å¿—ã€‚\nglog.V(4).Infof(\u0026#34;Adding RedisCluster %s\u0026#34;, rc.Name) glog.Warningf(\u0026#34;-----------redisCluster: %#v--\u0026#34;, redisCluster) glog.Errorf(err.Error()) é•œåƒåˆ¶ä½œ # ç¼–è¯‘å‰æ # æå‰å®‰è£…å¥½goè¯­è¨€å¼€å‘ç¯å¢ƒï¼Œæ­£ç¡®è®¾ç½®GOROOTå’ŒGOPATHç¯å¢ƒå˜é‡ï¼Œè¦æ±‚go1.8.3ç‰ˆæœ¬ä»¥ä¸Š\nç¼–è¯‘äºŒè¿›åˆ¶ # å°†middleware-operator-manageræ”¾åœ¨$GOPATH/src/harmonycloud.cn/ç›®å½•ä¸‹ï¼Œè¿›å…¥åˆ° $GOPATH/src/harmonycloud.cn/middleware-operator-manager/cmd/operator-managerç›®å½•ï¼Œ æœ€ç»ˆè¦ç”Ÿæˆlinuxçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š\nå¦‚æœæ˜¯åœ¨windowsä¸Šç¼–è¯‘ï¼š æ‰“å¼€cmdçª—å£ï¼Œè¿›å…¥ä»¥ä¸Šç›®å½•åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nset GOOS=linux go build -a -o operator-manager å¦‚æœæ˜¯åœ¨linuxä¸Šç¼–è¯‘ï¼š æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\ngo build -a -o operator-manager ç­‰å¾…ç¼–è¯‘å®Œæˆï¼Œæœ€ç»ˆåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆoperator-managerå¯æ‰§è¡Œæ–‡ä»¶\né•œåƒåˆ¶ä½œ # $GOPATH/src/harmonycloud.cn/middleware-operator-manager/artifactsç›®å½•ä¸‹æœ‰Dockerfileæ–‡ä»¶ï¼ŒåŸºç¡€é•œåƒä¸ºbusybox\nFROM busybox ADD operator-manager /usr/bin/ RUN chmod +x /usr/bin/operator-manager åŒçº§ç›®å½•ä¸‹æœ‰operator-manager deploymentæè¿°æ–‡ä»¶operator-manager.yaml:\napiVersion: extensions/v1beta1 kind: Deployment metadata: generation: 2 labels: app: operator-manager name: operator-manager namespace: kube-system spec: replicas: 2 selector: matchLabels: app: operator-manager strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 1 type: RollingUpdate template: metadata: creationTimestamp: null labels: app: operator-manager spec: containers: - command: - operator-manager - --v=5 - --leader-elect=true image: 192.168.26.46/k8s-deploy/operator-manager:v1 resources: limits: cpu: 500m memory: 512Mi requests: cpu: 200m memory: 512Mi imagePullPolicy: Always name: operator-manager terminationMessagePath: /dev/termination-log terminationMessagePolicy: File dnsPolicy: ClusterFirst restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 åŒçº§ç›®å½•ä¸‹æœ‰build.shè„šæœ¬ï¼ŒæŒ‡å®šäº†dockeré•œåƒä»“åº“åœ°å€ä¸º192.168.26.46\n#!/bin/bash docker build -f ./Dockerfile -t operator-manager:v1 . docker tag operator-manager:v1 192.168.26.46/k8s-deploy/operator-manager:v1 docker push 192.168.26.46/k8s-deploy/operator-manager:v1 kubectl apply -f operator-manager.yaml æ‰§è¡Œè¯¥è„šæœ¬å³å¯ä»¥å°†operator-manageräºŒè¿›åˆ¶æ‰“æˆé•œåƒå¹¶æ¨é€åˆ°192.168.26.46ä»“åº“çš„k8s-deployé¡¹ç›®ä¸‹ï¼š åŒæ—¶æ‰§è¡Œäº†\nkubectl apply -f operator-manager.yaml å‘½ä»¤åˆ›å»ºäº†operator-managerçš„deploymentå¯¹è±¡ï¼Œå®Œæˆäº†éƒ¨ç½²ã€‚\noperatoré«˜å¯ç”¨ # ç”¨k8sç»„ä»¶ä¸­leaderé€‰ä¸¾æœºåˆ¶å®ç°redis operatorç»„ä»¶çš„é«˜å¯ç”¨ï¼Œå³æ­£å¸¸æƒ…å†µä¸‹redis operatorç»„ä»¶çš„å¤šä¸ªå‰¯æœ¬åªæœ‰ä¸€ä¸ªæ˜¯å¤„äºä¸šåŠ¡é€»è¾‘è¿è¡ŒçŠ¶æ€ï¼Œå…¶å®ƒå‰¯æœ¬åˆ™ä¸æ–­çš„å°è¯•å»è·å–é”ï¼Œå»ç«äº‰leaderï¼Œç›´åˆ°è‡ªå·±æˆä¸ºleaderã€‚å¦‚æœæ­£åœ¨è¿è¡Œçš„leaderå› æŸç§åŸå› å¯¼è‡´å½“å‰è¿›ç¨‹é€€å‡ºï¼Œæˆ–è€…é”ä¸¢å¤±ï¼Œåˆ™ç”±å…¶å®ƒå‰¯æœ¬å»ç«äº‰æ–°çš„leaderï¼Œè·å–leaderç»§è€Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚\nå¯åŠ¨ä¸¤ä¸ªoperator-managerå®ä¾‹ï¼š\nå¯ä»¥çœ‹åˆ°åªæœ‰ä¸€ä¸ªå®ä¾‹operator-manager-86d785b5fc-m5rghåœ¨åŒæ­¥äº‹ä»¶ï¼Œå¤„ç†ä¸šåŠ¡ï¼š\noperator-manager-86d785b5fc-sszj2å®ä¾‹ä¸€ç›´åœ¨ç«äº‰å°è¯•è·å–é”ï¼š\nåˆ é™¤æ‰æ­£åœ¨åŒæ­¥äº‹ä»¶çš„å®ä¾‹operator-manager-86d785b5fc-m5rghï¼š\nå®ä¾‹operator-manager-86d785b5fc-sszj2ç«äº‰è·å–åˆ°é”ï¼Œå¼€å§‹å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼š\næ•…å¯ä»¥é€šè¿‡åäº²å’Œæ€§é˜²æ­¢ä¸¤ä¸ªoperator-managerå®ä¾‹è°ƒåº¦åˆ°åŒä¸€ä¸»æœºä¸Šï¼Œè¾¾åˆ°ä¸»å¤‡é«˜å¯ç”¨ã€‚\næœ€åé™„ä¸Šæºç åœ°å€ï¼š\nhttps://github.com/smallersoup/middleware-operator-manager\nå‚è€ƒï¼š\nè°ˆè°ˆk8sçš„leaderé€‰ä¸¾\u0026ndash;åˆ†å¸ƒå¼èµ„æºé”\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAoperator%E6%89%A9%E5%B1%95kubernetes%E7%9A%84%E8%83%BD%E5%8A%9B/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eOperator æ˜¯ CoreOS æ¨å‡ºçš„æ—¨åœ¨ç®€åŒ–å¤æ‚æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ„ŸçŸ¥åº”ç”¨çŠ¶æ€çš„æ§åˆ¶å™¨ï¼Œé€šè¿‡æ‰©å±• Kubernetes API æ¥è‡ªåŠ¨åˆ›å»ºã€ç®¡ç†å’Œé…ç½®åº”ç”¨å®ä¾‹ã€‚ Operator åŸºäº CRD æ‰©å±•èµ„æºå¯¹è±¡ï¼Œå¹¶é€šè¿‡æ§åˆ¶å™¨æ¥ä¿è¯åº”ç”¨å¤„äºé¢„æœŸçŠ¶æ€ã€‚\u003c/p\u003e","title":"å¼€å‘ä¸€ä¸ªoperatoræ‰©å±•kubernetesçš„èƒ½åŠ›","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/windows/","section":"Tags","summary":"","title":"Windows","type":"tags"},{"content":" æ­£æ–‡ # æœ€è¿‘å·¥ä½œéœ€è¦è¿æ¥å…¬å¸çš„vpnã€‚è¿æ¥å‰ç”µè„‘å¯ä»¥ä¸Šå¤–ç½‘ï¼Œå¾®ä¿¡ã€ç½‘é¡µéƒ½å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯è¿æ¥ä¸Švpnåï¼Œåªèƒ½è®¿é—®å…¬å¸ç½‘ç»œäº†ï¼Œè¿™å°±æœ‰ç‚¹è™äº†ã€‚æ¶ˆæ¯æ”¶ä¸åˆ°å¾ˆä¸æ–¹ä¾¿ï¼Œä¹ŸæŸ¥ä¸äº†èµ„æ–™ã€‚ä»¥ä¸‹æ¥è¯´é“è¯´é“æ€ä¹ˆè§£å†³ï¼Œå› ä¸ºç½‘ä¸ŠæŸ¥åˆ°çš„ä¸€äº›èµ„æ–™ï¼Œåªæœ‰æ–‡å­—ï¼Œæ— å›¾å¯¼è‡´ç†è§£çš„è´¹åŠ²å„¿ï¼Œæ‰€ä»¥ä¸‹æ–‡æœ‰å¾ˆå¤šå›¾ï¼Œä¹Ÿå¯¹æ¯”äº†vpnå„ç§é…ç½®çš„å›¾ï¼Œå¯èƒ½ä¼šæœ‰ç‚¹å•°å—¦ï¼Œè¿˜æœ›æµ·æ¶µï¼\nç”µè„‘æ“ä½œç³»ç»Ÿï¼šwin10\næœªè¿æ¥vpnä¹‹å‰ # æœªè¿æ¥vpnä¹‹å‰cmdé‡Œæ‰§è¡Œroute printç»“æœå¦‚ä¸‹ï¼š\næ­¤æ—¶ç½‘é¡µå¯ä»¥æ­£å¸¸è®¿é—®ï¼š\næ¥çœ‹çœ‹vpnæ˜¯è¿™è¿æ¥å’Œé…ç½®çš„ï¼ŒæœåŠ¡å™¨åœ°å€ä¸º115.236.33.122ï¼Œåç§°éšä¾¿èµ·äº†ä¸ªWLAN1ï¼š\nä¸å‹¾é€‰â€œåœ¨è¿œç¨‹ç½‘å…³ä½¿ç”¨é»˜è®¤ç½‘å…³â€ # WLAN1çš„å±æ€§\u0026ndash;\u0026raquo;IPV4\u0026ndash;\u0026raquo;é«˜çº§\u0026ndash;\u0026raquo;åœ¨è¿œç¨‹ç½‘å…³ä½¿ç”¨é»˜è®¤ç½‘å…³ï¼Œä¸å‹¾é€‰çš„æƒ…å†µä¸‹ï¼Œå»è¿æ¥è¯¥vpnï¼š\nvpnè¿æ¥åï¼š\nxshellè¿æ¥ä¸ä¸Šå…¬å¸çš„IPï¼š\næ­¤æ—¶çš„cmdé‡Œæ‰§è¡Œroute printçœ‹åˆ°å¦‚ä¸‹ï¼Œå¤šäº†ä¸€è¡Œè·¯ç”±é¡¹ï¼š\næ­¤æ—¶ç½‘é¡µå¯ä»¥æ­£å¸¸è®¿é—®ï¼Œæ— çº¿ç½‘è¿æ¥å¤„ä¹Ÿæ²¡æœ‰é»„è‰²æ„Ÿå¹å·ï¼š\nå¯ä»¥å‘ç°ä¸å‹¾é€‰â€œåœ¨è¿œç¨‹ç½‘å…³ä½¿ç”¨é»˜è®¤ç½‘å…³â€çš„æƒ…å†µä¸‹ï¼Œæ— æ³•è¿æ¥å…¬å¸ç½‘ç»œï¼Œæ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚\nå‹¾é€‰ä¸Šâ€œåœ¨è¿œç¨‹ç½‘å…³ä½¿ç”¨é»˜è®¤ç½‘å…³â€ # å…ˆæ–­å¼€vpnï¼Œç„¶åä¿®æ”¹ï¼š\nWLAN1çš„å±æ€§\u0026ndash;\u0026raquo;IPV4\u0026ndash;\u0026raquo;é«˜çº§\u0026ndash;\u0026raquo;åœ¨è¿œç¨‹ç½‘å…³ä½¿ç”¨é»˜è®¤ç½‘å…³ï¼Œå‹¾é€‰ä¸Šåï¼š\nå†è¿æ¥vpnåï¼Œxshellå¯ä»¥è¿æ¥å…¬å¸çš„IPäº†ã€‚åŒæ—¶æ— çº¿ç½‘ä¸Šæœ‰äº†é»„è‰²æ„Ÿå¹å·ï¼Œè¯´æ˜æ­¤æ—¶å¤–ç½‘æ˜¯ä¸Šä¸äº†çš„ï¼Œç™¾åº¦æ— æ³•è®¿é—®ï¼š\næ­¤æ—¶çš„è·¯ç”±è¡¨å¤šäº†ä¸¤æ¡è·¯ç”±é¡¹ï¼š\nè§£å†³é—®é¢˜ # é‚£æ€ä¹ˆæ—¢èƒ½è¿æ¥å…¬å¸ç½‘ï¼Œåˆèƒ½ä¸Šå¤–ç½‘ï¼Œè¿æ¥ç™¾åº¦æŸ¥èµ„æ–™å‘¢ï¼Ÿ\né¦–å…ˆéœ€è¦æŠŠWLAN1çš„å±æ€§\u0026ndash;\u0026raquo;IPV4\u0026ndash;\u0026raquo;é«˜çº§\u0026ndash;\u0026raquo;åœ¨è¿œç¨‹ç½‘å…³ä½¿ç”¨é»˜è®¤ç½‘å…³çš„å‹¾å»æ‰ï¼š\nç„¶åè¿æ¥vpnï¼Œè¿ä¸Šåï¼Œæ— çº¿ç½‘ä¸Šæ²¡æœ‰é»„è‰²æ„Ÿå¹å·ï¼Œæ­¤æ—¶å¯ä»¥ä¸Šå¤–ç½‘ï¼Œä½†è¿æ¥ä¸ä¸Šå…¬å¸çš„ç½‘ï¼Œæ¥ä¸‹æ¥è§£å†³è¯¥é—®é¢˜ã€‚\nåœ¨cmdé‡Œæ‰§è¡Œipconfig/allå‘½ä»¤ï¼Œç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°WLAN1çš„ipåœ°å€ä¸º172.20.1.85ï¼Œå­ç½‘æ©ç ä¸ºï¼š255.255.255.255ï¼›æ— çº¿å±€åŸŸç½‘çš„ipåœ°å€ä¸º192.168.68.131ï¼Œå­ç½‘æ©ç ä¸ºï¼š255.255.255.0ï¼Œç½‘å…³ä¸º192.168.68.1\nå†æ‰§è¡Œroute printå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š\næˆ‘ä»¬è¦è®¿é—®å…¬å¸ç½‘ç»œï¼Œéœ€è¦åŠ å…¬å¸çš„ç½‘æ®µåˆ°è·¯ç”±è¡¨ï¼Œæ¯”å¦‚æˆ‘è¦è¿æ¥10.10.103.151 IPï¼Œå­ç½‘æ©ç 255.255.0.0ï¼Œé‚£ä¹ˆå°±éœ€è¦åŠ å¦‚ä¸‹çš„è·¯ç”±ï¼Œå…¶ä¸­çš„172.20.1.85ä¸ºä¸Šé¢æŸ¥åˆ°çš„WLAN1çš„IPï¼Œä¸‹ä¸€è·³55å†™ä¸å†™æ²¡å…³ç³»ï¼š\nroute add -p 10.10.0.0 mask 255.255.0.0 172.20.1.85 metric 55 æ­¤æ—¶çš„route printç»“æœå¦‚ä¸‹ï¼š\nç„¶åå†çœ‹çœ‹å…¬å¸ç½‘ç»œæ˜¯å¦å¯ä»¥è¿æ¥ä¸Šï¼ŒxshellæˆåŠŸè¿æ¥å…¬å¸çš„æœåŠ¡å™¨ï¼š\næ­¤æ—¶å¤–ç½‘ä¹Ÿå¯ä»¥æ­£å¸¸è®¿é—®ï¼ŒæŸ¥èµ„æ–™ï¼ŒèŠå¤©ä¹Ÿæ–¹ä¾¿äº†ã€‚ä¸‹ä¸€æ¬¡è¿æ¥vpnå¯èƒ½å¾—ä¿®æ”¹è·¯ç”±é‡Œçš„WLAN1çš„IPï¼Œæ¯”å¦‚ä¸‹ä¸€æ¬¡è¿æ¥vpnåWLAN1çš„IPä¸º172.20.1.86ï¼Œåˆ™ä¿®æ”¹å‘½ä»¤å¦‚ä¸‹ï¼š\nroute change -p 10.10.0.0 mask 255.255.0.0 172.20.1.86 ","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E8%BF%9E%E4%B8%8A%E5%85%AC%E5%8F%B8%E7%9A%84vpn%E5%90%8E%E7%94%B5%E8%84%91%E4%B8%8A%E4%B8%8D%E4%BA%86%E5%A4%96%E7%BD%91%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eæœ€è¿‘å·¥ä½œéœ€è¦è¿æ¥å…¬å¸çš„vpnã€‚è¿æ¥å‰ç”µè„‘å¯ä»¥ä¸Šå¤–ç½‘ï¼Œå¾®ä¿¡ã€ç½‘é¡µéƒ½å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯è¿æ¥ä¸Švpnåï¼Œåªèƒ½è®¿é—®å…¬å¸ç½‘ç»œäº†ï¼Œè¿™å°±æœ‰ç‚¹è™äº†ã€‚æ¶ˆæ¯æ”¶ä¸åˆ°å¾ˆä¸æ–¹ä¾¿ï¼Œä¹ŸæŸ¥ä¸äº†èµ„æ–™ã€‚ä»¥ä¸‹æ¥è¯´é“è¯´é“æ€ä¹ˆè§£å†³ï¼Œå› ä¸ºç½‘ä¸ŠæŸ¥åˆ°çš„ä¸€äº›èµ„æ–™ï¼Œåªæœ‰æ–‡å­—ï¼Œæ— å›¾å¯¼è‡´ç†è§£çš„è´¹åŠ²å„¿ï¼Œæ‰€ä»¥ä¸‹æ–‡æœ‰å¾ˆå¤šå›¾ï¼Œä¹Ÿå¯¹æ¯”äº†vpnå„ç§é…ç½®çš„å›¾ï¼Œå¯èƒ½ä¼šæœ‰ç‚¹å•°å—¦ï¼Œè¿˜æœ›æµ·æ¶µï¼\u003c/p\u003e","title":"è¿ä¸Šå…¬å¸çš„vpnåï¼Œç”µè„‘ä¸Šä¸äº†å¤–ç½‘è§£å†³åŠæ³•","type":"posts"},{"content":" æ­£æ–‡ # ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸Šç”±äºç½‘ç»œå®‰å…¨ç­–ç•¥ï¼Œå¤§å¤šæ•°ç«¯å£æ˜¯ä¸èƒ½ä¸ºé›†ç¾¤å¤–éƒ¨è®¿é—®çš„ã€‚å¤šä¸ªé›†ç¾¤ä¹‹é—´ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡k8sçš„ApiServerç»„ä»¶æä¾›çš„æ¥å£é€šä¿¡ï¼Œå¦‚https://192.168.1.101:6443ã€‚æ‰€ä»¥åœ¨åšäº‘å¹³å°æ—¶ï¼Œé›†ç¾¤ç®¡ç†å¹³å°ï¼ˆé›…ç§°ï¼šè§‚äº‘å°ï¼‰éœ€è¦æ“ä½œå…¶ä»–é›†ç¾¤çš„èµ„æºå¯¹è±¡æ—¶ï¼Œå¿…ç„¶ä¹Ÿå¾—é€šè¿‡ApiServerã€‚\nk8sè´Ÿè½½å‡è¡¡å™¨ç»„ä»¶ingress-nginx-controllerä¸­é›†æˆçš„nginxï¼Œå½“é›†ç¾¤ingressã€tcp configmapsã€udp configmapsç­‰èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œingress-nginx-controllerä¼šæ ¹æ®è¿™äº›èµ„æºæœ€æ–°é…ç½®ï¼Œå¹¶æ ¹æ®æå‰è®¾å®šå¥½çš„nginx.tmplæ¨¡æ¿ï¼ˆnginxé…ç½®æ–‡ä»¶nginx.confç”±è¯¥æ¨¡æ¿ç”Ÿæˆï¼‰ç”Ÿæˆæœ€æ–°çš„nginx.confé…ç½®ï¼Œå¹¶è‡ªåŠ¨è¿›è¡Œnginx -s reloadæ“ä½œã€‚\næœ€è¿‘åšçš„ä¸€ä¸ªéœ€æ±‚ï¼Œéƒ¨åˆ†è´Ÿè½½å‡è¡¡å™¨å¯ä»¥åœ¨é¡µé¢ä¸Šç”±è¿ç»´äººå‘˜è‡ªåŠ¨é…ç½®ï¼Œé€šè¿‡nginxçš„serverã€mapé…ç½®ã€‚æ ¹æ®è¯·æ±‚å¤´çš„ä¸åŒå°†æµé‡åˆ†é…åˆ°ä¸åŒçš„æœåŠ¡ã€‚å¯ä»¥å‚è€ƒ nginx mapé…ç½®æ ¹æ®è¯·æ±‚å¤´ä¸åŒåˆ†é…æµé‡åˆ°ä¸åŒåç«¯æœåŠ¡\né…ç½®åéœ€è¦åœ¨è§‚äº‘å°ä¸Šæ‰‹åŠ¨reloadè´Ÿè½½å‡è¡¡å™¨ï¼Œä»¥ä½¿é…ç½®ç”Ÿæ•ˆã€‚è¿™å°±æ¶‰åŠåˆ°ä»è§‚äº‘å°å»æ“ä½œå¤šé›†ç¾¤çš„è´Ÿè½½å‡è¡¡å™¨ã€‚\né€šè¿‡ä¿®æ”¹ingress-nginx-controlleræºç æä¾›æ¥å£reloadæ–¹æ¡ˆï¼Œç”±äºç½‘ç»œè§„åˆ™é™åˆ¶è‚¯å®šè¡Œä¸é€šï¼›\nåªæœ‰6443ç«¯å£å¯ä»¥èµ°ã€‚èƒ½ä¸èƒ½åƒæ“ä½œé›†ç¾¤å†…èµ„æºä¸€æ ·å»æ“ä½œå…¶ä»–é›†ç¾¤èµ„æºï¼Ÿ\n1ã€kubectlå‘½ä»¤å…¶å®å¯¹åº”çš„å°±æ˜¯è°ƒç”¨apiserverå»æ“ä½œèµ„æºï¼Œåœ¨é›†ç¾¤å†…æˆ‘ä»¬éƒ½çŸ¥é“å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\nkubectl exec -ti ingress-nginx-abab121 -nkube-system -- nginx -s reload é‚£ä¹ˆä»Aé›†ç¾¤å»æ“ä½œBé›†ç¾¤ï¼Œå‡è®¾Bçš„ApiServeråœ°å€ä¸ºï¼šhttps://192.168.1.101:6443ï¼ŒBearer tokenä¸º212k1jj1jak12k1kjaeebaï¼Œåˆ™å‘½ä»¤å¦‚ä¸‹ï¼š\nkubectl exec -ti ingress-nginx-abab121 -nkube-system --server=https://192.168.1.101:6443 --token=212k1jj1jak12k1kjaeeba --insecure-skip-tls-verify=true -- nginx -s reload é€šè¿‡æŸ¥çœ‹kubeletçš„æºä»£ç ï¼Œå¯ä»¥å‘ç°$GOPATH\\src\\k8s.io\\kubernetes\\pkg\\kubelet\\server\\server.goçš„InstallDebuggingHandlersæ–¹æ³•ä¸­æ³¨å†Œäº†execã€attachã€portForwardç­‰æ¥å£ï¼ŒåŒæ—¶kubeletçš„å†…éƒ¨æ¥å£é€šè¿‡api serverå¯¹å¤–æä¾›æœåŠ¡ï¼Œæ‰€ä»¥å¯¹API serverçš„è¿™äº›æ¥å£è°ƒç”¨ï¼Œå¯ä»¥ç›´æ¥è®¿é—®åˆ°kubeletï¼Œå³client \u0026ndash;\u0026raquo; API server \u0026ndash;\u0026gt; kubelet\n2ã€å¯ä»¥ç”¨curlå‘½ä»¤è°ƒç”¨å¦‚ä¸‹ï¼š\ncurl -k \\ -H \u0026#34;Connection: Upgrade\u0026#34; \\ -H \u0026#34;Authorization: Bearer 212k1jj1jak12k1kjaeeba\u0026#34; \\ -H \u0026#34;Upgrade: websocket\u0026#34; \\ -H \u0026#34;Sec-Websocket-Key: x3JJHMbDL1EzLkh9GBhXDw==\u0026#34; \\ -H \u0026#34;Sec-Websocket-Version: 13\u0026#34; \\ \u0026#34;https://192.168.26.19:6443/api/v1/namespaces/liano/pods/nginx/exec?command=ls\u0026amp;stdin=true\u0026amp;stout=true\u0026amp;tty=true\u0026#34; 3ã€kuberneteså¼€æºç¤¾åŒºç»´æŠ¤äº†å„ç§è¯­è¨€ç‰ˆæœ¬ä¸k8s apiserveräº¤äº’çš„clientåº“ï¼Œæ¯”å¦‚javaåº“åœ°å€å¦‚ä¸‹ï¼š\nhttps://github.com/kubernetes-client/java\nå…¶ä¸­æä¾›äº†è°ƒç”¨podçš„execæ¥å£ä»£ç ç¤ºä¾‹ï¼š\nhttps://github.com/kubernetes-client/java/blob/master/examples/src/main/java/io/kubernetes/client/examples/ExecExample.java\néœ€è¦å…ˆä¾èµ–ï¼š\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.kubernetes\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;client-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.0.0\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;compile\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; ç„¶åæ ¹æ®apiserveråœ°å€å’ŒBearer tokenæ„å»ºclientï¼Œåˆ°è®¿é—®pod execæ¥å£è¿›è¡Œnginx -s reloadä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š\npackage com.liano.api.test; import com.alibaba.fastjson.JSONObject; import com.google.common.base.Preconditions; import io.kubernetes.client.ApiClient; import io.kubernetes.client.ApiException; import io.kubernetes.client.Configuration; import io.kubernetes.client.Exec; import io.kubernetes.client.util.ClientBuilder; import io.kubernetes.client.util.credentials.AccessTokenAuthentication; import java.io.BufferedReader; import java.io.IOException; import java.io.InputStream; import java.io.InputStreamReader; import java.io.Reader; /** * @program: k8s-mars * @description: ExecKubelet * @author: liano * @create: 2019-03-06 15:10 **/ public class ExecKubeletDemo { public static void main(String[] args) throws IOException, ApiException, InterruptedException { new ExecKubeletDemo().execNginxReload(); } private void execNginxReload() throws InterruptedException, ApiException, IOException { //apiServeråœ°å€å’ŒBbearer tokenæ–¹å¼è®¤è¯ ApiClient client = new ClientBuilder().setBasePath(\u0026#34;https://10.10.101.60:6443\u0026#34;).setVerifyingSsl(false) .setAuthentication(new AccessTokenAuthentication(\u0026#34;33095a7b86a7a3462ea45a1410624b\u0026#34;)).build(); // client.setDebugging(true); Configuration.setDefaultApiClient(client); JSONObject res = process(\u0026#34;nginx-97ccd777-xk9pw\u0026#34;, \u0026#34;kube-system\u0026#34;); System.out.println(JSONObject.toJSONString(res)); } private JSONObject process(String podName, String namespace) throws IOException, ApiException, InterruptedException { Exec exec = new Exec(); // final Process proc = exec.exec(\u0026#34;default\u0026#34;, \u0026#34;nginx-4217019353-k5sn9\u0026#34;, new String[] // {\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;echo foo\u0026#34;}, true, tty); String[] commands = new String[]{\u0026#34;nginx\u0026#34;, \u0026#34;-s\u0026#34;, \u0026#34;reload\u0026#34;}; final Process proc = exec.exec(namespace, podName, commands, true, true); JSONObject res = new JSONObject(); Thread out = new Thread( new Runnable() { public void run() { String copy = copy(proc.getInputStream()); res.put(\u0026#34;data\u0026#34;, copy); } }); out.start(); proc.waitFor(); out.join(); proc.destroy(); if (proc.exitValue() != 0) { res.put(\u0026#34;success\u0026#34;, false); } else { res.put(\u0026#34;success\u0026#34;, true); } return res; } private String copy(InputStream from) { Preconditions.checkNotNull(from); BufferedReader in = null; Reader reader = null; StringBuilder sb = new StringBuilder(); try { reader = new InputStreamReader(from); in = new BufferedReader(reader); String line; while ((line = in.readLine()) != null) { sb.append(line); } } catch (Exception e) { System.out.println(e); } finally { try { if (from != null) { from.close(); } if (reader != null) { reader.close(); } if (in != null) { in.close(); } } catch (Exception e) { System.out.println(e); } } return sb.toString(); } } ä»io.kubernetes.client.Execæºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œéœ€æ±‚é€šè¿‡ HTTP/1.1 åè®®çš„101çŠ¶æ€ç è¿›è¡Œæ¡æ‰‹è¿›ä¸€æ­¥å»ºç«‹websocketã€‚websocketæ˜¯ä¸€ç§åœ¨å•ä¸ªTCPè¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®ï¼Œ æ˜¯ç‹¬ç«‹çš„ã€åˆ›å»ºåœ¨ TCP ä¸Šçš„åè®®ã€‚ä¸ºäº†åˆ›å»ºWebsocketè¿æ¥ï¼Œéœ€è¦é€šè¿‡å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œä¹‹åæœåŠ¡å™¨è¿›è¡Œå›åº”ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸ç§°ä¸ºâ€œæ¡æ‰‹â€ï¼ˆhandshakingï¼‰ã€‚\nä¸€ä¸ªå…¸å‹çš„Websocketæ¡æ‰‹è¯·æ±‚å¦‚ä¸‹ï¼š\nGET / HTTP/1.1 Upgrade: websocket Connection: Upgrade Host: example.com Origin: http://example.com Sec-WebSocket-Key: sN9cRrP/n9NdMgdcy2VJFQ== Sec-WebSocket-Version: 13 æœåŠ¡å™¨å›åº”\nHTTP/1.1 101 Switching Protocols Upgrade: websocket Connection: Upgrade Sec-WebSocket-Accept: fFBooB7FAkLlXgRSz0BT3v4hq5s= Sec-WebSocket-Location: ws://example.com/ å­—æ®µè¯´æ˜\nConnectionå¿…é¡»è®¾ç½®Upgradeï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å¸Œæœ›è¿æ¥å‡çº§ã€‚ Upgradeå­—æ®µå¿…é¡»è®¾ç½®Websocketï¼Œè¡¨ç¤ºå¸Œæœ›å‡çº§åˆ°Websocketåè®®ã€‚ Sec-WebSocket-Keyæ˜¯éšæœºçš„å­—ç¬¦ä¸²ï¼ŒæœåŠ¡å™¨ç«¯ä¼šç”¨è¿™äº›æ•°æ®æ¥æ„é€ å‡ºä¸€ä¸ªSHA-1çš„ä¿¡æ¯æ‘˜è¦ã€‚æŠŠâ€œSec-WebSocket-Keyâ€åŠ ä¸Šä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ä¸²â€œ258EAFA5-E914-47DA-95CA-C5AB0DC85B11â€ï¼Œç„¶åè®¡ç®—SHA-1æ‘˜è¦ï¼Œä¹‹åè¿›è¡ŒBASE-64ç¼–ç ï¼Œå°†ç»“æœåšä¸ºâ€œSec-WebSocket-Acceptâ€å¤´çš„å€¼ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¦‚æ­¤æ“ä½œï¼Œå¯ä»¥å°½é‡é¿å…æ™®é€šHTTPè¯·æ±‚è¢«è¯¯è®¤ä¸ºWebsocketåè®®ã€‚ Sec-WebSocket-Version è¡¨ç¤ºæ”¯æŒçš„Websocketç‰ˆæœ¬ã€‚RFC6455è¦æ±‚ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯13ï¼Œä¹‹å‰è‰æ¡ˆçš„ç‰ˆæœ¬å‡åº”å½“å¼ƒç”¨ã€‚ Originå­—æ®µæ˜¯å¯é€‰çš„ï¼Œé€šå¸¸ç”¨æ¥è¡¨ç¤ºåœ¨æµè§ˆå™¨ä¸­å‘èµ·æ­¤Websocketè¿æ¥æ‰€åœ¨çš„é¡µé¢ï¼Œç±»ä¼¼äºRefererã€‚ä½†æ˜¯ï¼Œä¸Refererä¸åŒçš„æ˜¯ï¼ŒOriginåªåŒ…å«äº†åè®®å’Œä¸»æœºåç§°ã€‚ å…¶ä»–ä¸€äº›å®šä¹‰åœ¨HTTPåè®®ä¸­çš„å­—æ®µï¼Œå¦‚Cookieç­‰ï¼Œä¹Ÿå¯ä»¥åœ¨Websocketä¸­ä½¿ç”¨ã€‚ ","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/kubernetespodexec%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸Šç”±äºç½‘ç»œå®‰å…¨ç­–ç•¥ï¼Œå¤§å¤šæ•°ç«¯å£æ˜¯ä¸èƒ½ä¸ºé›†ç¾¤å¤–éƒ¨è®¿é—®çš„ã€‚å¤šä¸ªé›†ç¾¤ä¹‹é—´ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡k8sçš„ApiServerç»„ä»¶æä¾›çš„æ¥å£é€šä¿¡ï¼Œå¦‚https://192.168.1.101:6443ã€‚æ‰€ä»¥åœ¨åšäº‘å¹³å°æ—¶ï¼Œé›†ç¾¤ç®¡ç†å¹³å°ï¼ˆé›…ç§°ï¼šè§‚äº‘å°ï¼‰éœ€è¦æ“ä½œå…¶ä»–é›†ç¾¤çš„èµ„æºå¯¹è±¡æ—¶ï¼Œå¿…ç„¶ä¹Ÿå¾—é€šè¿‡ApiServerã€‚\u003c/p\u003e","title":"kubernetes pod execæ¥å£è°ƒç”¨","type":"posts"},{"content":" æ­£æ–‡ # ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆä»£ç ï¼š\n./generate-groups.sh all \u0026#34;github.com/openshift-evangelist/crd-code-generation/pkg/client\u0026#34; \u0026#34;github.com/openshift-evangelist/crd-code-generation/pkg/apis\u0026#34; \u0026#34;ingressgroup:v1\u0026#34; ç¬¬ä¸€ä¸ªæŠ¥é”™ # ç”Ÿæˆä»£ç æŠ¥é”™ï¼š\nGenerating deepcopy funcs F0910 19:18:35.552948 12153 main.go:82] Error: Failed making a parser: unable to add directory \u0026#34;github.com/openshift-evangelist/crd-code-generation/pkg/client\u0026#34;: unable to import \u0026#34;github.com/asdfsx/getkubeconfig/pkg/apis/example/v1\u0026#34;: cannot find package \u0026#34;github.com/openshift-evangelist/crd-code-generation/pkg/client\u0026#34; in any of: D:/Program Files/Go/go103/src/github.com/openshift-evangelist/crd-code-generation/pkg/client (from $GOROOT) D:/SoftwareAndProgram/program/Go/Development/src/github.com/openshift-evangelist/crd-code-generation/pkg/client (from $GOPATH) è¿™ä¸ªé—®é¢˜å¯ä»¥å‚è€ƒ issue\nå¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ç« ï¼š\nhttps://medium.com/@trstringer/create-kubernetes-controllers-for-core-and-custom-resources-62fc35ad64a3\nç”±äºè¯¥é“¾æ¥å›½å†…è®¿é—®æ¯”è¾ƒå›°éš¾ï¼Œæ•…è½¬è½½åˆ°äº†è¿™é‡Œï¼š\nhttps://www.jianshu.com/p/dcfe6eac4152\nç¬¬äºŒä¸ªæŠ¥é”™ï¼š # Generating deepcopy funcs F1104 02:57:44.419529 35 main.go:82] Error: Failed executing generator: some packages had errors: type \u0026#34;k8s.io/apimachinery/pkg/runtime.Object\u0026#34; in k8s:deepcopy-gen:interfaces tag of type k8s.io/apimachinery/pkg/runtime.Object is not an interface, but: \u0026#34;\u0026#34; goroutine 1 [running]: è¿™ä¸ªæŠ¥é”™æ˜¯å› ä¸ºk8s.io/apimachineryè¿™ä¸ªåŒ…ç›®å½•ç»“æ„ä¸å¯¹ï¼Œæ”¾åˆ°vendorç›®å½•ä¸‹æ‰¾ä¸åˆ°ï¼Œå¿…é¡»æ”¾åˆ°$GOPATHä¸‹çš„src/k8s.io/apimachineryï¼Œå…·ä½“å‚è€ƒ issue\næˆ‘è§£å†³äº†è¿™ä¸ªé—®é¢˜ ã€‚è¿™ä¸èµ·ä½œç”¨ï¼Œé™¤ék8s.io/apimachineryåœ¨GOPATHä¸­ï¼Œå¦‚æœå®ƒåªæ˜¯åœ¨vendorç›®å½•ä¸‹ï¼Œé‚£ä¹ˆdeepcopyæ— æ³•æ‰¾åˆ°å®ƒã€‚è‡³å°‘ï¼Œè¿™éœ€è¦åœ¨æŸå¤„è®°å½•ã€‚å¦‚æœåœ¨vendorç›®å½•ä¸‹ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼Œé‚£å°†ä¼šå¾ˆæ£’ã€‚\nç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\n$GOPATH/src\n$GOPATH/src/github.com/\nç¬¬ä¸‰ä¸ªæŠ¥é”™ # Generating deepcopy funcs F0221 09:54:08.335328 26316 main.go:82] Error: Failed executing generator: som e packages had errors: errors in package \u0026#34;github.com/openshift-evangelist/crd-code-generation/pkg/apis/ ingressgroup/v1\u0026#34;: unable to format file \u0026#34;D:\\\\SoftwareAndProgram\\\\program\\\\Go\\\\Development\\\\src\\\\gi thub.com\\\\openshift-evangelist\\\\crd-code-generation\\\\pkg\\\\apis\\\\ingressgroup\\\\v1 \\\\zz_generated.deepcopy.go\u0026#34; (The filename, directory name, or volume label synta x is incorrect.). windowsä¸Šæ‰§è¡ŒæŠ¥è¿™ä¸ªé”™ï¼Œéœ€è¦åœ¨linuxä¸Šæ‰§è¡Œgenerate-groups.sh è„šæœ¬ã€‚\næœ€ç»ˆç”Ÿæˆå¦‚ä¸‹ï¼š # [root@master-192 code-generator]# dos2unix generate-groups.sh dos2unix: converting file generate-groups.sh to Unix format ... [root@master-192 code-generator]# ./generate-groups.sh all \u0026#34;github.com/openshift-evangelist/crd-code-generation/pkg/client\u0026#34; \u0026#34;github.com/openshift-evangelist/crd-code-generation/pkg/apis\u0026#34; \u0026#34;ingressgroup:v1\u0026#34; Generating deepcopy funcs Generating clientset for ingressgroup:v1 at github.com/openshift-evangelist/crd-code-generation/pkg/client/clientset Generating listers for ingressgroup:v1 at github.com/openshift-evangelist/crd-code-generation/pkg/client/listers Generating informers for ingressgroup:v1 at github.com/openshift-evangelist/crd-code-generation/pkg/client/informers æœ€ç»ˆç”Ÿæˆç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\n[root@master-192 crd-code-generation]# pwd /root/Work/programmer/go/gopath/src/github.com/openshift-evangelist/crd-code-generation [root@master-192 crd-code-generation]# tree . â””â”€â”€ pkg â”œâ”€â”€ apis â”‚ â””â”€â”€ ingressgroup â”‚ â”œâ”€â”€ register.go â”‚ â””â”€â”€ v1 â”‚ â”œâ”€â”€ doc.go â”‚ â”œâ”€â”€ register.go â”‚ â”œâ”€â”€ types.go â”‚ â””â”€â”€ zz_generated.deepcopy.go â””â”€â”€ client â”œâ”€â”€ clientset â”‚ â””â”€â”€ versioned â”‚ â”œâ”€â”€ clientset.go â”‚ â”œâ”€â”€ doc.go â”‚ â”œâ”€â”€ fake â”‚ â”‚ â”œâ”€â”€ clientset_generated.go â”‚ â”‚ â”œâ”€â”€ doc.go â”‚ â”‚ â””â”€â”€ register.go â”‚ â”œâ”€â”€ scheme â”‚ â”‚ â”œâ”€â”€ doc.go â”‚ â”‚ â””â”€â”€ register.go â”‚ â””â”€â”€ typed â”‚ â””â”€â”€ ingressgroup â”‚ â””â”€â”€ v1 â”‚ â”œâ”€â”€ doc.go â”‚ â”œâ”€â”€ fake â”‚ â”‚ â”œâ”€â”€ doc.go â”‚ â”‚ â”œâ”€â”€ fake_ingressgroup_client.go â”‚ â”‚ â””â”€â”€ fake_ingressgroup.go â”‚ â”œâ”€â”€ generated_expansion.go â”‚ â”œâ”€â”€ ingressgroup_client.go â”‚ â””â”€â”€ ingressgroup.go â”œâ”€â”€ informers â”‚ â””â”€â”€ externalversions â”‚ â”œâ”€â”€ factory.go â”‚ â”œâ”€â”€ generic.go â”‚ â”œâ”€â”€ ingressgroup â”‚ â”‚ â”œâ”€â”€ interface.go â”‚ â”‚ â””â”€â”€ v1 â”‚ â”‚ â”œâ”€â”€ ingressgroup.go â”‚ â”‚ â””â”€â”€ interface.go â”‚ â””â”€â”€ internalinterfaces â”‚ â””â”€â”€ factory_interfaces.go â””â”€â”€ listers â””â”€â”€ ingressgroup â””â”€â”€ v1 â”œâ”€â”€ expansion_generated.go â””â”€â”€ ingressgroup.go ","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/k8s%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆä»£ç ï¼š\u003c/p\u003e","title":"k8sè‡ªå®šä¹‰èµ„æºç±»å‹ä»£ç è‡ªåŠ¨ç”Ÿæˆ","type":"posts"},{"content":" æ­£æ–‡ # æœ€è¿‘åœ¨åšä¸€ä¸ªéœ€æ±‚å¼€å‘ï¼šæ ¹æ®è¯·æ±‚åçš„ä¸åŒï¼Œnginxå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡ï¼›éœ€è¦ä¿®æ”¹kubernetesçš„ingress-nginx-controllerçš„æºç ï¼Œè°ƒè¯•çš„æ—¶å€™é‡åˆ°äº†æŒºå¤šé—®é¢˜ï¼Œå†™å‡ºæ¥ï¼Œæœ‰éœ€è¦çš„è€é“å¯ä»¥å‚è€ƒã€‚å…·ä½“æ–¹æ¡ˆå°±ä¸è¯´äº†ï¼Œåªè¯´ä¸€ä¸‹nginxé…ç½®è¿™ä¸€å—ã€‚\né¦–å…ˆè´´å‡ºç»„ä»¶ç‰ˆæœ¬ï¼š\ningress-nginx-controllerçš„ç‰ˆæœ¬ä¸º0.9-beta.18ï¼Œå¯ä»¥åœ¨githubä¸Šæ‰¾åˆ°å¼€æºçš„é¡¹ç›®æºç ï¼š\nnginx mapé…ç½®æ ¹æ®è¯·æ±‚å¤´ä¸åŒåˆ†é…æµé‡åˆ°ä¸åŒåç«¯æœåŠ¡\nnginxç‰ˆæœ¬ä¸ºï¼šnginx version: nginx/1.13.7\nmapé…ç½®çš„ä¸€ä¸ªæŠ¥é”™ï¼š # nginx.confæ–‡ä»¶éƒ¨åˆ†å¦‚ä¸‹ï¼š\nhttp { include /etc/nginx/conf.d/server-map.d/*-map.conf; include /etc/nginx/conf.d/*-upstream.conf; include /etc/nginx/conf.d/server-map.d/*-server.conf; .... map_hash_bucket_size 64; .... } åœ¨/etc/nginx/conf.d/server-map.d/ç›®å½•ä¸‹çš„flow-ppp-map.confï¼š\nmap $http_x_group_env $svc_upstream { default zxl-test-splitflow-old-version; ~*old zxl-test-splitflow-old-version; ~*new zxl-test-splitflow-new-version; } flow-ppp-server.conf\nserver { listen 8998; server_name aa.hc.harmonycloud.cn; location /testdemo/test { proxy_pass http://$svc_upstream; } } ingressgroup-upstream.conf\nupstream zxl-test-splitflow-old-version { server 10.168.173.29:8080 max_fails=0 fail_timeout=0; } upstream zxl-test-splitflow-new-version { server 10.168.177.171:8080 max_fails=0 fail_timeout=0; } å½“nginx -tc /etc/nginx/nginx.confæµ‹è¯•é…ç½®æ­£ç¡®ä¸å¦æ—¶æŠ¥é”™å¦‚ä¸‹ï¼š\nError: exit status 1 nginx: [emerg] \u0026#34;map_hash_bucket_size\u0026#34; directive is duplicate in /etc/nginx/nginx.conf:60 nginx: configuration file c test failed è§£å†³ï¼š # è¿™æ˜¯å› ä¸ºé¦–æ¬¡è°ƒç”¨mapæ—¶ä¼šéšå¼è®¾ç½®map_hash_bucket_sizeï¼Œå³åœ¨nginxä¸­mapåå†™map_hash_bucket_sizeç›¸å½“äºè®¾ç½®äº†ä¸¤æ¬¡map_hash_bucket_sizeï¼Œå¦‚ï¼š\nhttp { ... map $status $_status { default 42; } map_hash_bucket_size 64; ... } å› æ­¤å¯ä»¥åœ¨mapä¹‹å‰è®¾ç½®å®ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚\nhttp { map_hash_bucket_size 64; ... map $status $_status { default 42; } ... } æ‰€ä»¥include mapé…ç½®ä¹Ÿåº”è¯¥æ”¾åˆ°è®¾ç½®map_hash_bucket_sizeä¹‹åï¼š\nhttp { ... map_hash_bucket_size 64; ... include /etc/nginx/conf.d/server-map.d/*-map.conf; include /etc/nginx/conf.d/*-upstream.conf; include /etc/nginx/conf.d/server-map.d/*-server.conf; } mapé…ç½®è¯´æ˜ï¼š # é€šè¿‡ä¸Šé¢çš„includeä¸‰ä¸ªé…ç½®æ–‡ä»¶ï¼Œæœ€ç»ˆå¯¹nginxç”Ÿæ•ˆçš„é…ç½®åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š\nhttp { ... map_hash_bucket_size 64; ... map $http_x_group_env $svc_upstream { default zxl-test-splitflow-old-version; ~*old zxl-test-splitflow-old-version; ~*new zxl-test-splitflow-new-version; } upstream zxl-test-splitflow-old-version { server 10.168.173.29:8080 max_fails=0 fail_timeout=0; } upstream zxl-test-splitflow-new-version { server 10.168.177.171:8080 max_fails=0 fail_timeout=0; } server { listen 8998; server_name aa.hc.harmonycloud.cn; location /testdemo/test { proxy_pass http://$svc_upstream; } } } å½“åœ¨ç”µè„‘ä¸Šhostsæ–‡ä»¶é‡Œé…ç½®äº†aa.hc.harmonycloud.cnåŸŸåè§£æåï¼Œè®¿é—®http://aa.hc.harmonycloud.cn:8998/testdemo/testæ—¶(å³serverçš„server_nameå’Œlistenã€locationçš„é…ç½®)ï¼Œnginxå°†ä¼šæŠŠè¯·æ±‚è½¬å‘åˆ°http://$svc_upstreamï¼Œè¿™ä¸ª$svc_upstreamå…·ä½“æ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯é€šè¿‡mapé…ç½®æ¥èµ‹å€¼çš„ã€‚è¿™é‡Œmapé…ç½®å¦‚ä¸‹ï¼š\nmap $http_x_group_env $svc_upstream { default zxl-test-splitflow-old-version; ~*old zxl-test-splitflow-old-version; ~*new zxl-test-splitflow-new-version; } å…¶ä¸­$http_x_group_envå¯ä»¥æ˜¯nginxå†…ç½®å˜é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯è‡ªå®šä¹‰çš„headerçš„keyã€è¯·æ±‚å‚æ•°åï¼›$svc_upstreamå³ä¸ºè‡ªå®šä¹‰å˜é‡åã€‚è¿™é‡Œçš„é…ç½®å«ä¹‰ä¸ºï¼šå½“è¯·æ±‚å¤´é‡Œçš„x-group-envçš„å€¼oldæ—¶ï¼Œ$svc_upstreamè¢«èµ‹å€¼ä¸ºzxl-test-splitflow-old-versionï¼›å½“è¯·æ±‚å¤´é‡Œçš„x-group-envçš„å€¼newæ—¶ï¼Œ$svc_upstreamè¢«èµ‹å€¼ä¸ºzxl-test-splitflow-new-versionï¼›é»˜è®¤èµ‹å€¼ä¸ºzxl-test-splitflow-old-versionï¼›\nï¼ˆå…¶ä¸­æ­£åˆ™è¡¨è¾¾å¼å¦‚æœä»¥ â€œâ€ å¼€å¤´ï¼Œè¡¨ç¤ºè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼å¯¹å¤§å°å†™æ•æ„Ÿã€‚ä»¥ â€œ*â€å¼€å¤´ï¼Œè¡¨ç¤ºè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼å¯¹å¤§å°å†™ä¸æ•æ„Ÿï¼‰ã€‚è€Œzxl-test-splitflow-new-versionå’Œzxl-test-splitflow-old-versionè¡¨ç¤ºä¸¤ä¸ªupstreamåç§°ã€‚\nå› æ­¤nginxå°†ä¼šæŠŠè¯·æ±‚è½¬å‘åˆ°http://$svc_upstreamï¼Œè¿™é‡Œçš„$svc_upstreamä¼šè¢«æ›¿æ¢ä¸ºupstreamçš„åç§°ï¼Œæœ€ç»ˆå°†å¾—åˆ°upstreamä¸­çš„åç«¯æœåŠ¡IPå’ŒPortã€‚\næ³¨æ„ï¼šå¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰headerä¸ºX-Real-IP,é€šè¿‡ç¬¬äºŒä¸ªnginxè·å–è¯¥headeræ—¶éœ€è¦è¿™æ ·ï¼š$http_x_real_ip; (ä¸€å¾‹é‡‡ç”¨å°å†™ï¼Œè€Œä¸”å‰é¢å¤šäº†ä¸ªhttp_ï¼Œä¸”ä¸­é—´ç”¨_æ›¿æ¢ï¼‰\næµ‹è¯• # å½“è¯·æ±‚å¤´é‡ŒåŠ x-group-envä¸ºnewæ—¶ï¼Œè®¿é—®åç«¯æ‰“å°å‡ºçš„æ˜¯I am new version\nå½“è¯·æ±‚å¤´é‡ŒåŠ x-group-envä¸ºoldæ—¶ï¼Œè®¿é—®åç«¯æ‰“å°å‡ºçš„æ˜¯I am old version\næœ€ç»ˆé€šè¿‡è¯·æ±‚å¤´ä¸åŒå®ç°äº†å°†æµé‡åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡ã€‚\nå°†è¯·æ±‚å¤´çš„keyå˜ä¸ºX-Group-Envï¼Œvalueå˜ä¸ºOLDæˆ–è€…NEWä¹Ÿæ²¡å…³ç³»ï¼š\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/nginxmap%E9%85%8D%E7%BD%AE%E6%A0%B9%E6%8D%AE%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%B8%8D%E5%90%8C%E5%88%86%E9%85%8D%E6%B5%81%E9%87%8F%E5%88%B0%E4%B8%8D%E5%90%8C%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eæœ€è¿‘åœ¨åšä¸€ä¸ªéœ€æ±‚å¼€å‘ï¼šæ ¹æ®è¯·æ±‚åçš„ä¸åŒï¼Œnginxå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡ï¼›éœ€è¦ä¿®æ”¹kubernetesçš„ingress-nginx-controllerçš„æºç ï¼Œè°ƒè¯•çš„æ—¶å€™é‡åˆ°äº†æŒºå¤šé—®é¢˜ï¼Œå†™å‡ºæ¥ï¼Œæœ‰éœ€è¦çš„è€é“å¯ä»¥å‚è€ƒã€‚å…·ä½“æ–¹æ¡ˆå°±ä¸è¯´äº†ï¼Œåªè¯´ä¸€ä¸‹nginxé…ç½®è¿™ä¸€å—ã€‚\u003c/p\u003e","title":"nginx mapé…ç½®æ ¹æ®è¯·æ±‚å¤´ä¸åŒåˆ†é…æµé‡åˆ°ä¸åŒåç«¯æœåŠ¡","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/email/","section":"Tags","summary":"","title":"Email","type":"tags"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/java/","section":"Tags","summary":"","title":"Java","type":"tags"},{"content":" æ­£æ–‡ # è¿™å‡ ç¯‡æ–‡ç« å†™çš„å°±æŒºå¥½äº†ï¼Œä¼ é€è¿‡å»çœ‹çœ‹å§ï¼š\n1ã€ ä½¿ç”¨JavaMailåˆ›å»ºé‚®ä»¶å’Œå‘é€é‚®ä»¶\nå¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š\n1ã€å› ä¸ºç«¯å£å·é—®é¢˜å¯¼è‡´çš„é”™è¯¯ï¼š\njavax.mail.MessagingException: Exception reading response; nested exception is: java.net.SocketTimeoutException: Read timed out javax.mail.MessagingException: Exception reading response; nested exception is: java.net.SocketTimeoutException: Read timed out at com.sun.mail.smtp.SMTPTransport.readServerResponse(SMTPTransport.java:2210) at com.sun.mail.smtp.SMTPTransport.openServer(SMTPTransport.java:1950) at com.sun.mail.smtp.SMTPTransport.protocolConnect(SMTPTransport.java:642) at javax.mail.Service.connect(Service.java:317) at javax.mail.Service.connect(Service.java:176) at javax.mail.Service.connect(Service.java:125) at javax.mail.Transport.send0(Transport.java:194) at javax.mail.Transport.send(Transport.java:124) é—®é¢˜å’Œè§£å†³è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼ŒæŠŠport configuration from 465 to 587(æŠŠç«¯å£ä»465æ”¹æˆ587)\nhttps://stackoverflow.com/questions/31535863/error-when-sending-email-via-java-mail-api\n2ã€ ä½¿ç”¨javamailå‘é€å†…åµŒå›¾ç‰‡çš„htmlæ ¼å¼é‚®ä»¶\nè¦åœ¨é‚®ä»¶ä¸­åŒ…å«å›¾ç‰‡ç®€å•åŠæ³•æ˜¯ä½¿ç”¨imageæ ‡ç­¾ï¼ŒsrcæŒ‡å‘æœåŠ¡å™¨ä¸Šå›¾ç‰‡çš„ä½ç½®ã€‚\npackage com.example.emaildemo; import javax.mail.Message; import javax.mail.Session; import javax.mail.Transport; import javax.mail.internet.InternetAddress; import javax.mail.internet.MimeMessage; import java.util.Properties; /** * @program: email-demo * @description: * @author: smallsoup * @create: 2019-01-27 16:44 **/ public class SendEmailUtil { public static void main(String[] args) throws Exception { Properties props = new Properties(); props.setProperty(\u0026#34;mail.transport.protocol\u0026#34;, \u0026#34;smtp\u0026#34;); props.setProperty(\u0026#34;mail.host\u0026#34;, \u0026#34;smtp.exmail.qq.com\u0026#34;); props.setProperty(\u0026#34;mail.smtp.auth\u0026#34;, \u0026#34;true\u0026#34;); //ä½¿ç”¨JavaMailå‘é€é‚®ä»¶çš„5ä¸ªæ­¥éª¤ //1ã€åˆ›å»ºsession Session mailSession = Session.getInstance(props); //å¼€å¯Sessionçš„debugæ¨¡å¼ï¼Œè¿™æ ·å°±å¯ä»¥æŸ¥çœ‹åˆ°ç¨‹åºå‘é€Emailçš„è¿è¡ŒçŠ¶æ€ mailSession.setDebug(true); //2ã€é€šè¿‡sessionå¾—åˆ°transportå¯¹è±¡ Transport transport = mailSession.getTransport(); //3ã€ä½¿ç”¨é‚®ç®±çš„ç”¨æˆ·åå’Œå¯†ç è¿ä¸Šé‚®ä»¶æœåŠ¡å™¨,è¿™é‡Œæœ‰å¤šä¸ªæ„é€ å™¨,å¯ä¼ å…¥hostã€ç«¯å£ã€userã€password transport.connect( \u0026#34;ä½ çš„é‚®ç®±åœ°å€\u0026#34;, \u0026#34;ä½ çš„é‚®ç®±AUTHå¯†ç ,ä¸æ˜¯ç™»é™†å¯†ç å“¦,åœ¨é‚®ç®±çš„è®¾ç½®é‡Œå•ç‹¬å¼€å¯å’Œè®¾ç½®\u0026#34;); MimeMessage message = new MimeMessage(mailSession); message.setSubject(\u0026#34;HTML mail Hello\u0026#34;); message.setFrom(new InternetAddress(\u0026#34;ä½ çš„é‚®ç®±åœ°å€\u0026#34;)); //4ã€åˆ›å»ºé‚®ä»¶ message.setContent(\u0026#34;\u0026lt;h1\u0026gt;This is a test\u0026lt;/h1\u0026gt;\u0026#34; + \u0026#34;\u0026lt;img src=\\\u0026#34;http://www.rgagnon.com/images/jht.gif\\\u0026#34;\u0026gt;\u0026#34;, \u0026#34;text/html\u0026#34;); message.addRecipient(Message.RecipientType.TO, new InternetAddress(\u0026#34;æ¥æ”¶äººé‚®ç®±åœ°å€\u0026#34;)); //5ã€å‘é€é‚®ä»¶ // transport.sendMessage(message, message.getRecipients(Message.RecipientType.TO)); transport.sendMessage(message, message.getAllRecipients()); transport.close(); } } ä¸Šé¢å‘é€å¸¦å›¾ç‰‡é‚®ä»¶çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä½†æ˜¯æœ‰äº›é‚®ä»¶å®¢æˆ·ç«¯ä¼šæŠŠæ˜¯å¦åŒ…å«æœ‰æœåŠ¡å™¨ç«¯å›¾ç‰‡ä½œä¸ºåƒåœ¾é‚®ä»¶çš„åˆ¤æ–­æœºåˆ¶ã€‚æˆ‘ä»¬å¯ä»¥å°†å›¾ç‰‡å†…åµŒåˆ°é‚®ä»¶ä¸­ï¼Œç„¶åç”¨cidåŠ content-idå¼•ç”¨å†…åµŒçš„å›¾ç‰‡ã€‚\npackage com.example.emaildemo; import javax.activation.DataHandler; import javax.activation.DataSource; import javax.activation.FileDataSource; import javax.mail.BodyPart; import javax.mail.Message; import javax.mail.Session; import javax.mail.Transport; import javax.mail.internet.InternetAddress; import javax.mail.internet.MimeBodyPart; import javax.mail.internet.MimeMessage; import javax.mail.internet.MimeMultipart; import java.util.Properties; /** * @program: email-demo * @description: * @author: smallsoup * @create: 2019-01-27 16:44 **/ public class SendEmailUtil { public static void main(String[] args) throws Exception { Properties props = new Properties(); props.setProperty(\u0026#34;mail.transport.protocol\u0026#34;, \u0026#34;smtp\u0026#34;); props.setProperty(\u0026#34;mail.host\u0026#34;, \u0026#34;smtp.exmail.qq.com\u0026#34;); props.setProperty(\u0026#34;mail.smtp.auth\u0026#34;, \u0026#34;true\u0026#34;); //ä½¿ç”¨JavaMailå‘é€é‚®ä»¶çš„5ä¸ªæ­¥éª¤ //1ã€åˆ›å»ºsession Session mailSession = Session.getInstance(props); //å¼€å¯Sessionçš„debugæ¨¡å¼ï¼Œè¿™æ ·å°±å¯ä»¥æŸ¥çœ‹åˆ°ç¨‹åºå‘é€Emailçš„è¿è¡ŒçŠ¶æ€ mailSession.setDebug(true); //2ã€é€šè¿‡sessionå¾—åˆ°transportå¯¹è±¡ Transport transport = mailSession.getTransport(); //3ã€ä½¿ç”¨é‚®ç®±çš„ç”¨æˆ·åå’Œå¯†ç è¿ä¸Šé‚®ä»¶æœåŠ¡å™¨,è¿™é‡Œæœ‰å¤šä¸ªæ„é€ å™¨,å¯ä¼ å…¥hostã€ç«¯å£ã€userã€password transport.connect( \u0026#34;ä½ çš„é‚®ç®±åœ°å€\u0026#34;, \u0026#34;ä½ çš„é‚®ç®±AUTHå¯†ç ,ä¸æ˜¯ç™»é™†å¯†ç å“¦,åœ¨é‚®ç®±çš„è®¾ç½®é‡Œå•ç‹¬å¼€å¯å’Œè®¾ç½®\u0026#34;); MimeMessage message = new MimeMessage(mailSession); message.setSubject(\u0026#34;HTML mail Hello\u0026#34;); message.setFrom(new InternetAddress(\u0026#34;ä½ çš„é‚®ç®±åœ°å€\u0026#34;)); message.addRecipient(Message.RecipientType.TO, new InternetAddress(\u0026#34;æ¥æ”¶äººé‚®ç®±åœ°å€\u0026#34;)); //4ã€åˆ›å»ºé‚®ä»¶ //This HTML mail have to 2 part, the BODY and the embedded image MimeMultipart multipart = new MimeMultipart(\u0026#34;related\u0026#34;); // first part (the html) BodyPart messageBodyPart = new MimeBodyPart(); String htmlText = \u0026#34;\u0026lt;H1\u0026gt;Hello\u0026lt;/H1\u0026gt;\u0026lt;img src=\\\u0026#34;cid:image\\\u0026#34;\u0026gt;\u0026#34;; messageBodyPart.setContent(htmlText, \u0026#34;text/html\u0026#34;); // add it multipart.addBodyPart(messageBodyPart); // second part (the image) messageBodyPart = new MimeBodyPart(); DataSource fds = new FileDataSource(\u0026#34;C:\\\\images\\\\jht.gif\u0026#34;); messageBodyPart.setDataHandler(new DataHandler(fds)); messageBodyPart.setHeader(\u0026#34;Content-ID\u0026#34;,\u0026#34;image\u0026#34;); // add it multipart.addBodyPart(messageBodyPart); // put everything together message.setContent(multipart); //5ã€å‘é€é‚®ä»¶ transport.sendMessage(message, message.getAllRecipients()); transport.close(); } } SpringBootå‘é€é‚®ä»¶éœ€è¦åŠ ä¾èµ–ï¼š\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-mail\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; å…·ä½“å¯å‚è€ƒï¼š\njavaå‘é€htmlæ¨¡æ¿çš„é«˜é€¼æ ¼é‚®ä»¶\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/javamail%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eè¿™å‡ ç¯‡æ–‡ç« å†™çš„å°±æŒºå¥½äº†ï¼Œä¼ é€è¿‡å»çœ‹çœ‹å§ï¼š\u003c/p\u003e","title":"Javamailå‘é€é‚®ä»¶","type":"posts"},{"content":" æ­£æ–‡ # æœ€è¿‘åšäº†ä¸€ä¸ªç›‘æµ‹k8sæœåŠ¡podæ°´å¹³ä¼¸ç¼©å‘é€é‚®ä»¶çš„åŠŸèƒ½ï¼ˆå½“podçš„cpu/å†…å­˜è¾¾åˆ°æŒ‡å®šé˜ˆå€¼åä¼šæ°´å¹³æ‰©å±•å‡ºå¤šä¸ªpodã€æˆ–è€…æŒ‡å®šæ—¶é—´å†…podæ•°åº”æ‰©å±•åˆ°æŒ‡å®šæ•°é‡ï¼‰ï¼Œä¸€å¼€å§‹å†™äº†ä¸ªæ ¼å¼å¾ˆlowçš„é‚®ä»¶ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š\nä¸»æµç¨‹æ‰“é€šï¼Œç®—ä¸ªv1ç‰ˆæœ¬å§ï¼Œç¨‹åºå‘˜æ˜¯ä¸ªè¿½æ±‚å®Œç¾çš„äººï¼Œå†è¯´è¿™ä¹ˆä½é€¼æ ¼çš„é‚®ä»¶ï¼Œç»™å®¢æˆ·çœ‹ï¼Œå®¢æˆ·ä¹Ÿä¼šä¸æ»¡æ„ã€‚é‚£æ€ä¹ˆæé«˜é‚®ä»¶çš„é€¼æ ¼å‘¢ï¼Ÿä¸‹é¢å†™äº†ä¸ªç®€å•çš„demoï¼Œv2ç‰ˆæœ¬å¦‚ä¸‹ï¼š\næ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å‚è€ƒï¼Œæ¨¡æ¿å¯ä»¥æ‰¾ä½ å…¬å¸å‰ç«¯å’Œç¾å·¥å°å§å§è®¾è®¡ã€‚\nå› ä¸ºç›‘æµ‹k8sæœåŠ¡podæ°´å¹³ä¼¸ç¼©æ˜¯ç”¨goå¼€å‘çš„ï¼Œå‘é€é€šçŸ¥é‚®ä»¶æä¾›äº†ä¸ªæ¥å£ï¼Œç”¨springbootå†™çš„ï¼Œä»¥ä¸‹ä¹Ÿç”¨springbootåšdemo\nSpringbootçš„pom.xmlæ–‡ä»¶ï¼š\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.1.2.RELEASE\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;!-- lookup parent from repository --\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;email-demo\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;email-demo\u0026lt;/name\u0026gt; \u0026lt;description\u0026gt;Demo project for Spring Boot\u0026lt;/description\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;java.version\u0026gt;1.8\u0026lt;/java.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.commons\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-lang3\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.8.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.47\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!--å‘é€é‚®ä»¶çš„å¿…è¦ä¾èµ–--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-mail\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt; pod-scale-alarm.htmlæ¨¡æ¿æ–‡ä»¶ï¼š\næ¨¡æ¿ä¸­çš„{0}ã€{1}è¿™æ ·çš„å ä½ç¬¦åé¢javaä»£ç ä¼šæ›¿æ¢æ‰\n\u0026lt;body style=\u0026#34;color: #666; font-size: 14px; font-family: \u0026#39;Open Sans\u0026#39;,Helvetica,Arial,sans-serif;\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;box-content\u0026#34; style=\u0026#34;width: 80%; margin: 20px auto; max-width: 800px; min-width: 600px;\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;header-tip\u0026#34; style=\u0026#34;font-size: 12px; color: #aaa; text-align: right; padding-right: 25px; padding-bottom: 10px;\u0026#34;\u0026gt; Confidential - Scale Alarm Use Only \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;info-top\u0026#34; style=\u0026#34;padding: 15px 25px; border-top-left-radius: 10px; border-top-right-radius: 10px; background: {0}; color: #fff; overflow: hidden; line-height: 32px;\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;cid:icon-alarm\u0026#34; style=\u0026#34;float: left; margin: 0 10px 0 0; width: 32px;\u0026#34; /\u0026gt;\u0026lt;div style=\u0026#34;color:#010e07\u0026#34;\u0026gt;\u0026lt;strong\u0026gt;æœåŠ¡å®ä¾‹æ°´å¹³ä¼¸ç¼©é€šçŸ¥\u0026lt;/strong\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;info-wrap\u0026#34; style=\u0026#34;border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; border:1px solid #ddd; overflow: hidden; padding: 15px 15px 20px;\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;tips\u0026#34; style=\u0026#34;padding:15px;\u0026#34;\u0026gt; \u0026lt;p style=\u0026#34; list-style: 160%; margin: 10px 0;\u0026#34;\u0026gt;Hi,\u0026lt;/p\u0026gt; \u0026lt;p style=\u0026#34; list-style: 160%; margin: 10px 0;\u0026#34;\u0026gt;{1}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;time\u0026#34; style=\u0026#34;text-align: right; color: #999; padding: 0 15px 15px;\u0026#34;\u0026gt;{2}\u0026lt;/div\u0026gt; \u0026lt;br\u0026gt; \u0026lt;table class=\u0026#34;list\u0026#34; style=\u0026#34;width: 100%; border-collapse: collapse; border-top:1px solid #eee; font-size:12px;\u0026#34;\u0026gt; \u0026lt;thead\u0026gt; \u0026lt;tr style=\u0026#34; background: #fafafa; color: #333; border-bottom: 1px solid #eee;\u0026#34;\u0026gt; {3} \u0026lt;/tr\u0026gt; \u0026lt;/thead\u0026gt; \u0026lt;tbody\u0026gt; {4} \u0026lt;/tbody\u0026gt; \u0026lt;/table\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; success-alarm.pngå›¾æ ‡ï¼š\njavaä»£ç å¦‚ä¸‹ï¼Œç®€å•çš„demoï¼Œä¼˜åŒ–å¯ä»¥è‡ªå·±åœ¨é¡¹ç›®ä¸­å»åšã€‚\npackage com.example.emaildemo; import org.apache.commons.lang3.time.DateFormatUtils; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.core.io.ClassPathResource; import org.springframework.mail.javamail.JavaMailSenderImpl; import org.springframework.mail.javamail.MimeMessageHelper; import javax.mail.MessagingException; import javax.mail.internet.MimeMessage; import java.io.BufferedReader; import java.io.IOException; import java.io.InputStream; import java.io.InputStreamReader; import java.text.MessageFormat; import java.util.Date; import java.util.Objects; import java.util.Properties; /** * @program: email-demo * @description: * @author: smallsoup * @create: 2019-01-27 16:44 **/ public class SendEmailUtil { private static final Logger LOGGER = LoggerFactory.getLogger(SendEmailUtil.class); public static void main(String[] args) throws MessagingException, IOException { JavaMailSenderImpl javaMailSender = new JavaMailSenderImpl(); javaMailSender.setUsername(\u0026#34;ä½ çš„é‚®ç®±åœ°å€\u0026#34;); javaMailSender.setPassword(\u0026#34;ä½ çš„é‚®ç®±AUTHå¯†ç ,ä¸æ˜¯ç™»é™†å¯†ç å“¦,åœ¨é‚®ç®±çš„è®¾ç½®é‡Œå•ç‹¬å¼€å¯å’Œè®¾ç½®\u0026#34;); javaMailSender.setHost(\u0026#34;smtp.exmail.qq.com\u0026#34;); javaMailSender.setPort(587); javaMailSender.setDefaultEncoding(\u0026#34;UTF-8\u0026#34;); Properties props = new Properties(); props.setProperty(\u0026#34;mail.smtp.host\u0026#34;, \u0026#34;smtp.exmail.qq.com\u0026#34;); props.setProperty(\u0026#34;mail.transport.protocol\u0026#34;, \u0026#34;smtp\u0026#34;); props.setProperty(\u0026#34;mail.smtp.auth\u0026#34;, \u0026#34;true\u0026#34;); props.setProperty(\u0026#34;mail.smtp.connectiontimeout\u0026#34;, \u0026#34;20000\u0026#34;); props.setProperty(\u0026#34;mail.smtp.timeout\u0026#34;, \u0026#34;20000\u0026#34;); javaMailSender.setJavaMailProperties(props); MimeMessage message = javaMailSender.createMimeMessage(); MimeMessageHelper helper = new MimeMessageHelper(message, true, \u0026#34;UTF-8\u0026#34;); helper.setTo(new String[]{\u0026#34;æ”¶ä»¶äººé‚®ç®±\u0026#34;}); helper.setCc(\u0026#34;æŠ„é€äººé‚®ç®±\u0026#34;); helper.setFrom(\u0026#34;ä½ çš„é‚®ç®±åœ°å€\u0026#34;); helper.setSubject(\u0026#34;liang subject\u0026#34;); helper.setText(buildContent(), true); String alarmIconName = \u0026#34;success-alarm.png\u0026#34;; ClassPathResource img = new ClassPathResource(alarmIconName); if (Objects.nonNull(img)) { helper.addInline(\u0026#34;icon-alarm\u0026#34;, img); } javaMailSender.send(message); } private static String buildContent() throws IOException { //åŠ è½½é‚®ä»¶htmlæ¨¡æ¿ String fileName = \u0026#34;pod-scale-alarm.html\u0026#34;; InputStream inputStream = ClassLoader.getSystemResourceAsStream(fileName); BufferedReader fileReader = new BufferedReader(new InputStreamReader(inputStream)); StringBuffer buffer = new StringBuffer(); String line = \u0026#34;\u0026#34;; try { while ((line = fileReader.readLine()) != null) { buffer.append(line); } } catch (Exception e) { LOGGER.error(\u0026#34;è¯»å–æ–‡ä»¶å¤±è´¥ï¼ŒfileName:{}\u0026#34;, fileName, e); } finally { inputStream.close(); fileReader.close(); } String contentText = \u0026#34;ä»¥ä¸‹æ˜¯æœåŠ¡å®ä¾‹ä¼¸ç¼©ä¿¡æ¯, æ•¬è¯·æŸ¥çœ‹.\u0026lt;br\u0026gt;below is the information of service instance scale, please check. \u0026#34;; //é‚®ä»¶è¡¨æ ¼header String header = \u0026#34;\u0026lt;td\u0026gt;åˆ†åŒº(Namespace)\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;æœåŠ¡(Service)\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;ä¼¸ç¼©ç»“æœ(Scale Result)\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;ä¼¸ç¼©åŸå› (Scale Reason)\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;å½“å‰å®ä¾‹æ•°(Pod instance number)\u0026lt;/td\u0026gt;\u0026#34;; StringBuilder linesBuffer = new StringBuilder(); linesBuffer.append(\u0026#34;\u0026lt;tr\u0026gt;\u0026lt;td\u0026gt;\u0026#34; + \u0026#34;myNamespace\u0026#34; + \u0026#34;\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;\u0026#34; + \u0026#34;myServiceName\u0026#34; + \u0026#34;\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;\u0026#34; + \u0026#34;myscaleResult\u0026#34; + \u0026#34;\u0026lt;/td\u0026gt;\u0026#34; + \u0026#34;\u0026lt;td\u0026gt;\u0026#34; + \u0026#34;mReason\u0026#34; + \u0026#34;\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;\u0026#34; + \u0026#34;my4\u0026#34; + \u0026#34;\u0026lt;/td\u0026gt;\u0026lt;/tr\u0026gt;\u0026#34;); //ç»¿è‰² String emailHeadColor = \u0026#34;#10fa81\u0026#34;; String date = DateFormatUtils.format(new Date(), \u0026#34;yyyy/MM/dd HH:mm:ss\u0026#34;); //å¡«å……htmlæ¨¡æ¿ä¸­çš„äº”ä¸ªå‚æ•° String htmlText = MessageFormat.format(buffer.toString(), emailHeadColor, contentText, date, header, linesBuffer.toString()); //æ”¹å˜è¡¨æ ¼æ ·å¼ htmlText = htmlText.replaceAll(\u0026#34;\u0026lt;td\u0026gt;\u0026#34;, \u0026#34;\u0026lt;td style=\\\u0026#34;padding:6px 10px; line-height: 150%;\\\u0026#34;\u0026gt;\u0026#34;); htmlText = htmlText.replaceAll(\u0026#34;\u0026lt;tr\u0026gt;\u0026#34;, \u0026#34;\u0026lt;tr style=\\\u0026#34;border-bottom: 1px solid #eee; color:#666;\\\u0026#34;\u0026gt;\u0026#34;); return htmlText; } } ","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/java%E5%8F%91%E9%80%81html%E6%A8%A1%E6%9D%BF%E7%9A%84%E9%AB%98%E9%80%BC%E6%A0%BC%E9%82%AE%E4%BB%B6/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eæœ€è¿‘åšäº†ä¸€ä¸ªç›‘æµ‹k8sæœåŠ¡podæ°´å¹³ä¼¸ç¼©å‘é€é‚®ä»¶çš„åŠŸèƒ½ï¼ˆå½“podçš„cpu/å†…å­˜è¾¾åˆ°æŒ‡å®šé˜ˆå€¼åä¼šæ°´å¹³æ‰©å±•å‡ºå¤šä¸ªpodã€æˆ–è€…æŒ‡å®šæ—¶é—´å†…podæ•°åº”æ‰©å±•åˆ°æŒ‡å®šæ•°é‡ï¼‰ï¼Œä¸€å¼€å§‹å†™äº†ä¸ªæ ¼å¼å¾ˆlowçš„é‚®ä»¶ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š\u003cbr /\u003e\n\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://cdn.jsdelivr.net/gh/smallersoup/jsDelivr-cdn@main/blog/article/imgconvert-csdnimg/252af43f82840ba8d96777c49de9af32.png\" alt=\"ç®€å•é‚®ä»¶\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e","title":"javaå‘é€htmlæ¨¡æ¿çš„é«˜é€¼æ ¼é‚®ä»¶","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/linux/","section":"Tags","summary":"","title":"Linux","type":"tags"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/yum/","section":"Tags","summary":"","title":"Yum","type":"tags"},{"content":"åœ¨é…ç½®yumå‰é¦–å…ˆå¾—è¯´è¯´rpmï¼Œåœ¨redhatå’Œcentos linuxç³»ç»Ÿä¸Šï¼Œrpmä½œä¸ºè½¯ä»¶åŒ…ç®¡ç†å·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿çš„å®‰è£…ã€æŸ¥è¯¢ã€å¸è½½è½¯ä»¶åŒ…ã€‚å¸¸è§å‘½ä»¤å¦‚ä¸‹ï¼š\n#å®‰è£…ï¼š rpm -ivh jdk-7u25-linux-x64.rpm #å¸è½½ï¼š rpm -e jdk-7u25-linux-x64.rpm #å‡çº§ï¼š rpm -Uvh jdk-7u25-linux-x64.rpm #æŸ¥è¯¢è½¯ä»¶çš„å®‰è£…è·¯å¾„ï¼š rpm -ql yum-3.4.3-118.el7.noarch #æŸ¥è¯¢æ‰€æœ‰å®‰è£…çš„åŒ…ï¼š rpm -qa #æŸ¥è¯¢æŸä¸ªæ–‡ä»¶æ˜¯å“ªä¸ªrpmåŒ…äº§ç”Ÿï¼š rpm -qf /var/lib/yum/yumdb ä½†æ˜¯åœ¨å¤šä¸ªåŒ…ç»„æˆçš„rpmåŒ…ç”¨rpmå‘½ä»¤å®‰è£…æ—¶ï¼Œå…¶ä¾èµ–åŒ…é—®é¢˜æ˜¯è¶…çº§ç¹ççš„ã€‚\nyumæ˜¯redhatå’Œcentosçš„è½¯ä»¶åŒ…ç®¡ç†å·¥å…·ï¼Œå®‰è£…è½¯ä»¶åŒ…æ—¶å¯ä»¥åœ¨ç½‘ä¸Šè¿œç¨‹ä»“åº“æˆ–è€…æœ¬åœ°è‡ªåŠ¨ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…ï¼Œè§£å†³äº†rpmçš„ç—›ç‚¹ã€‚ä»Šå¤©ä¸»è¦å­¦ä¹ ä¸‹è¿œç¨‹yumæºé…ç½®ã€‚ç”±äºredhat è‡ªå¸¦çš„ yum æºæ˜¯éœ€è¦æ³¨å†Œæ”¶è´¹æ‰èƒ½æ›´æ–°ä¸‹è½½è½¯ä»¶çš„ï¼Œå¦‚æœæ²¡æœ‰æ³¨å†Œå°±ä½¿ç”¨ï¼Œåˆ™ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š\nThis system is not registered to Red Hat Subscription Management. You can use subscription-manager to register. æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠyumæºä¿®æ”¹ä¸ºcentosçš„æºã€‚\næŸ¥çœ‹è‡ªå¸¦yumï¼š\nrpm -qa | grep yum å¸è½½è‡ªå¸¦yumï¼š\nrpm -qa | grep yum | xargs rpm -e --nodeps æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬ï¼š\ncat /etc/redhat-release ä¸‹è½½å®‰è£…è½¯ä»¶åŒ…ï¼š\n#ä¸‹è½½é“¾æ¥ http://mirrors.163.com/centos/7/os/x86_64/Packages/ #éœ€è¦ä¸‹è½½ä»¥ä¸‹ä¸‰ä¸ªrpmåŒ…ï¼š yum-metadata-parser-1.1.4-10.el7.x86_64.rpm yum-3.4.3-158.el7.centos.noarch.rpm yum-plugin-fastestmirror-1.1.31-45.el7.noarch.rpm æ‰§è¡Œä»¥ä¸‹å®‰è£…å‘½ä»¤æŠ¥é”™ï¼Œä¾èµ–åŒ…çš„ç‰ˆæœ¬ä¸ç¬¦ï¼š\n#æ‰§è¡Œyumå®‰è£… rpm -ivh yum* è¿™é‡Œå‡çº§python-urlgrabberå’ŒrpmåŒ…ç‰ˆæœ¬ï¼š\n#å‡çº§rpmåŒ…åˆ°ï¼š rpm-4.11.3-32.el7.x86_64.rpm python-urlgrabber-3.10-8.el7.noarch.rpm #ä¸‹è½½ wget http://mirrors.163.com/centos/7/os/x86_64/Packages/rpm-4.11.3-32.el7.x86_64.rpm wget http://mirrors.163.com/centos/7/os/x86_64/Packages/python-urlgrabber-3.10-8.el7.noarch.rpm #å‡çº§ rpm -Uvh rpm-4.11.3-32.el7.x86_64.rpm --nodeps rpm -Uvh python-urlgrabber-3.10-8.el7.noarch.rpm --nodeps ç„¶åå®‰è£…ï¼š\næ–°å»ºé…ç½®æ–‡ä»¶ï¼š\nvim /etc/yum.repos.d/CentOS-Base.repo åŠ å…¥ä»¥ä¸‹é…ç½®ï¼š\n#CentOS-Base.repo # # The mirror system uses the connecting IP address of the client and the # update status of each mirror to pick mirrors that are updated to and # geographically close to the client. You should use this for CentOS updates # unless you are manually picking other mirrors. # # If the mirrorlist= does not work for you, as a fall back you can try the # remarked out baseurl= line instead. # # [base] name=CentOS-$7 - Base - 163.com #mirrorlist=http://mirrorlist.centos.org/?release=$7\u0026amp;arch=$basearch\u0026amp;repo=os baseurl=http://mirrors.163.com/centos/7/os/$basearch/ gpgcheck=1 gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7 #released updates [updates] name=CentOS-$7 - Updates - 163.com #mirrorlist=http://mirrorlist.centos.org/?release=$7\u0026amp;arch=$basearch\u0026amp;repo=updates baseurl=http://mirrors.163.com/centos/7/updates/$basearch/ gpgcheck=1 gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7 #additional packages that may be useful [extras] name=CentOS-$7 - Extras - 163.com #mirrorlist=http://mirrorlist.centos.org/?release=$7\u0026amp;arch=$basearch\u0026amp;repo=extras baseurl=http://mirrors.163.com/centos/7/extras/$basearch/ gpgcheck=1 gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7 #additional packages that extend functionality of existing packages [centosplus] name=CentOS-$7 - Plus - 163.com baseurl=http://mirrors.163.com/centos/7/centosplus/$basearch/ gpgcheck=1 enabled=0 gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7 ç„¶åæ¸…ç†ç¼“å­˜ï¼š\nyum clean all ç”Ÿæˆç¼“å­˜ï¼š\nyum makecache æµ‹è¯•æºï¼š\nyum update -y --skip-broken å¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥é€šè¿‡yumå®‰è£…ç›¸å…³è½¯ä»¶åŒ…æ›´æ–°ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/yum%E6%BA%90%E9%85%8D%E7%BD%AE/","section":"Posts","summary":"\u003cp\u003eåœ¨é…ç½®yumå‰é¦–å…ˆå¾—è¯´è¯´rpmï¼Œåœ¨redhatå’Œcentos linuxç³»ç»Ÿä¸Šï¼Œrpmä½œä¸ºè½¯ä»¶åŒ…ç®¡ç†å·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿çš„å®‰è£…ã€æŸ¥è¯¢ã€å¸è½½è½¯ä»¶åŒ…ã€‚å¸¸è§å‘½ä»¤å¦‚ä¸‹ï¼š\u003c/p\u003e","title":"yumæºé…ç½®","type":"posts"},{"content":"ä¸Šä¸€èŠ‚æˆ‘ä»¬åœ¨è™šæ‹Ÿæœºä¸Šæ­å»ºäº†linuxç³»ç»Ÿï¼Œå¹¶åˆ©ç”¨æ¡¥æ¥æ¨¡å¼è®¿é—®äº’è”ç½‘ï¼Œè¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥é…ç½®ä¸€ä¸‹é€šè¿‡NATæ¨¡å¼è®¿é—®äº’è”ç½‘ã€‚è¯´åˆ°è¿™é‡Œæœ‰äº›å°ä¼™ä¼´å¯èƒ½è¦é—®äº†ï¼ŒNATæ¨¡å¼å’Œæ¡¥æ¥æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ\næ¡¥æ¥æ¨¡å¼ï¼š\nè™šæ‹Ÿæœºè™šæ‹Ÿå‡ºæ¥çš„ç³»ç»Ÿå’Œå±€åŸŸç½‘å†…çš„ç‹¬ç«‹ä¸»æœºå±äºåŒç­‰åœ°ä½ï¼Œå®ƒå¯ä»¥è®¿é—®å±€åŸŸç½‘å†…ä»»ä½•ä¸€å°æœºå™¨ï¼Œè¯¥æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å¾—ä¸ºè™šæ‹Ÿä¸»æœºâ€”â€”linuxé…ç½®IPåœ°å€ï¼Œå­ç½‘æ©ç ï¼Œè€Œä¸”è¯¥IPè¦å’Œå®¿ä¸»æœºçš„IPæ˜¯åŒä¸€ç½‘æ®µã€‚å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨å±€åŸŸç½‘å†…å»ºç«‹ä¸€ä¸ªè™šæ‹ŸæœåŠ¡å™¨ï¼Œå¹¶ä¸ºå±€åŸŸç½‘ç”¨æˆ·æä¾›æœåŠ¡ï¼Œé‚£å°±å¾—é€‰æ‹©è¯¥æ¨¡å¼ã€‚\nNATæ¨¡å¼ï¼š\nNatæ¨¡å¼ï¼Œè™šæ‹Ÿæœºé€šè¿‡å®¿ä¸»æœºæ‰€åœ¨çš„ç½‘ç»œæ¥è®¿é—®internetï¼Œå³è™šæ‹ŸæœºæŠŠå®¿ä¸»æœºä½œä¸ºè·¯ç”±å™¨æ¥è®¿é—®äº’è”ç½‘ã€‚\nå¼€å§‹é…ç½®\n1ã€VM8 ä½¿ç”¨å›ºå®šIPï¼š\n2ã€ è¿™é‡Œä½¿ç”¨NATæ¨¡å¼ï¼š\n3ã€VMä¸­ä¾æ¬¡ï¼šç¼–è¾‘â€”â€”\u0026gt;è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨ï¼Œç‚¹VMnet8 æŠŠä½¿ç”¨æœ¬\nåœ°DHCPçš„å‹¾å»æ‰ï¼Œå­ç½‘IPå’Œä¸»æœºVM8çš„IPåŒç½‘æ®µï¼Œç„¶åç‚¹NATè®¾ç½®ã€‚\nç½‘å…³IPå’Œåˆšæ‰çš„IPä¹Ÿæ˜¯åŒä¸€ä¸ªç½‘æ®µã€‚ # 4.â€ƒä¿®æ”¹ç½‘ç»œé…ç½®\nvim /etc/sysconfig/network-scripts/ifcfg-eno16777736 å¢åŠ è¿™äº›ï¼š\nTYPE=Ethernet BOOTPROTO=static DEFROUTE=yes IPV4_FAILURE_FATAL=no IPV6INIT=yes IPV6_AUTOCONF=yes IPV6_DEFROUTE=yes IPV6_FAILURE_FATAL=no NAME=eno16777736 UUID=0e2e0e3d-eaaf-4810-9c6a-dda5ebe0ac9c ONBOOT=yes IPADDR0=192.168.2.5 GATEWAY0=192.168.2.2 PREFIX0=24 DNS1=192.168.2.2 HWADDR=00:0C:29:1D:3A:DF PEERDNS=yes PEERROUTES=yes IPV6_PEERDNS=yes IPV6_PEERROUTES=yes 5.â€ƒä¿®æ”¹å®Œä»¥åé‡å¯network\nsystemctl restart network æˆ–è€…ç”¨:\nservice network restart æ³¨æ„ï¼š # æƒ³è¦ä¸Šç½‘ï¼Œå³ping www.baidu.comä¸é€šæ—¶ï¼Œè¦å°†/etc/sysconfig/network-scripts/ifcfg-eno16777736ä¸­çš„DNS1å’ŒGATEWAY1è®¾ç½®ä¸ºä¸€æ ·çš„åœ°å€ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/nat%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%85%B1%E4%BA%AB%E4%B8%BB%E6%9C%BA%E7%BD%91%E7%BB%9C/","section":"Posts","summary":"\u003cp\u003eä¸Šä¸€èŠ‚æˆ‘ä»¬åœ¨è™šæ‹Ÿæœºä¸Šæ­å»ºäº†linuxç³»ç»Ÿï¼Œå¹¶åˆ©ç”¨æ¡¥æ¥æ¨¡å¼è®¿é—®äº’è”ç½‘ï¼Œè¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥é…ç½®ä¸€ä¸‹é€šè¿‡NATæ¨¡å¼è®¿é—®äº’è”ç½‘ã€‚è¯´åˆ°è¿™é‡Œæœ‰äº›å°ä¼™ä¼´å¯èƒ½è¦é—®äº†ï¼ŒNATæ¨¡å¼å’Œæ¡¥æ¥æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ\u003c/p\u003e","title":"NATæ¨¡å¼å®ç°è™šæ‹Ÿæœºå…±äº«ä¸»æœºç½‘ç»œ","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/vmware/","section":"Tags","summary":"","title":"Vmware","type":"tags"},{"content":" æ­£æ–‡ # ä»¥å‰çš„ç”µè„‘ä¸Šå®‰è£…è¿‡vmware+redhatï¼Œä½†æ˜¯å¥ˆä½•ç”µè„‘å¤ªè€ï¼Œé…ç½®å¤ªä½ï¼Œæ‰“å¼€çš„æ—¶å€™è¶…çº§å¡ï¼Œæ²¡æ³•ç”¨ã€‚æ¢äº†ç”µè„‘åï¼Œå†è£…ä¸Šç©ç©ï¼Œæ•…æ­¤è®°å½•ä¸€ä¸‹å®‰è£…è¿‡ç¨‹ã€‚éœ€è¦å®‰è£…çš„å°ä¼™ä¼´å¯ä»¥åœ¨æ­¤è·å–åŒ…ç„¶åæŒ‰æ­¤æ­¥éª¤å®‰è£…ã€‚\n1ã€åˆ›å»ºæ–°çš„è™šæ‹Ÿæœº -\u0026gt; è‡ªå®šä¹‰å®‰è£…\n2ã€é€‰æ‹©è™šæ‹Ÿæœºå…¼å®¹ç‰ˆæœ¬ï¼Œé€‰æ‹©æœ€é«˜çš„å°±å¥½\n3ã€é€‰æ‹©å®‰è£…ç³»ç»Ÿçš„æ–¹å¼ï¼Œæˆ‘ä»¬é€‰æ‹©ç¨åå®‰è£…\n4ã€é€‰æ‹©å®‰è£…çš„ç³»ç»Ÿç±»å‹ï¼Œç³»ç»Ÿä¸º32ä½çš„å°±é€‰32ä½çš„ï¼ˆredhat enterprise linux 7ï¼‰ï¼Œç³»ç»Ÿä¸º64ä½çš„å°±å®‰è£…64ä½çš„\n5ã€è®¾ç½®å®‰è£…çš„è™šæ‹Ÿæœºç³»ç»Ÿåç§°ä»¥åŠå®‰è£…çš„è™šæ‹Ÿæœºå­˜æ”¾è·¯å¾„ï¼Œè·¯å¾„è‡ªå·±å®šä¹‰ï¼ˆå»ºè®®ä¸è¦æ”¾åˆ°Cç›˜ï¼‰\n6ã€ä¸ºè™šæ‹Ÿæœºåˆ†é…å¤„ç†å™¨ï¼ˆcpuï¼‰ä¸ªæ•°å’Œæ¯ä¸ªcpuæ ¸æ•°\n7ã€ä¸ºè™šæ‹Ÿæœºåˆ†é…å†…å­˜å¤§å°\n8ã€é€‰æ‹©ç½‘ç»œç±»å‹ï¼Œè¿™é‡Œä½¿ç”¨æ¡¥æ¥æ¨¡å¼ï¼Œå®‰è£…å¥½åä¼šåˆ©ç”¨è¯¥æ–¹å¼ä¸Šç½‘\n9ã€é€‰æ‹©ä½¿ç”¨ç½‘ç»œç±»å‹é€‰æ‹©I/Oè®¾å¤‡æ¥å£çš„æ§åˆ¶å™¨ç±»å‹ï¼Œæˆ‘ä»¬é€‰æ‹©é»˜è®¤\n10ã€é€‰æ‹©è™šæ‹Ÿç£ç›˜ç±»å‹ï¼Œæˆ‘ä»¬é€‰æ‹©scsiç£ç›˜ï¼ˆæœåŠ¡å™¨å¸¸ç”¨ç£ç›˜ç±»å‹SCSIå’ŒSASï¼‰\n11ã€é€‰æ‹©æ–°å»ºä¸€å—æ–°çš„è™šæ‹Ÿç£ç›˜\n12ã€å®šä¹‰è™šæ‹Ÿç£ç›˜å¤§å°ï¼Œç£ç›˜åˆ†é…25Gï¼Œå¹¶ä¸æ˜¯è¯´ä¸€å®šå ç”¨25Gçš„ç£ç›˜ç©ºé—´ï¼Œæ˜¯éšç€ä½¿ç”¨æ—¶é—´å¢åŠ ï¼Œä¼šæ…¢æ…¢å¢åŠ ï¼Œè¿™é‡Œé€‰æ‹©å­˜å‚¨ä¸ºå•æ–‡ä»¶\n13ã€ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œç„¶åç‚¹å‡»å®Œæˆã€‚\n14ã€è®¾ç½®åˆšæ‰æ–°å»ºçš„è™šæ‹Ÿæœºï¼Œç¼–è¾‘è™šæ‹Ÿæœºè®¾ç½®ï¼Œcd/dvdé€‰é¡¹ï¼Œä½¿ç”¨å…‰ç›˜é•œåƒå®‰è£…ï¼Œé€‰æ‹©å…‰ç›˜è·¯å¾„ç‚¹å‡»ç¡®å®šï¼š\n15ã€ç„¶åå¼€å¯è™šæ‹Ÿæœº\nå¦‚æœæç¤ºä»¥ä¸‹æŠ¥é”™ï¼š\nå·²å°†è¯¥è™šæ‹Ÿæœºé…ç½®ä¸ºä½¿ç”¨ 64 ä½å®¢æˆ·æœºæ“ä½œç³»ç»Ÿã€‚ä½†æ˜¯ï¼Œæ— æ³•æ‰§è¡Œ 64 ä½æ“ä½œã€‚\næ­¤ä¸»æœºæ”¯æŒ Intel VT-xï¼Œä½† Intel VT-x å¤„äºç¦ç”¨çŠ¶æ€ã€‚\nå¦‚æœå·²åœ¨ BIOS/å›ºä»¶è®¾ç½®ä¸­ç¦ç”¨ Intel VT-xï¼Œæˆ–ä¸»æœºè‡ªæ›´æ”¹æ­¤è®¾ç½®åä»æœªé‡æ–°å¯åŠ¨ï¼Œåˆ™ Intel VT-x å¯èƒ½è¢«ç¦ç”¨ã€‚\næŠ¥ä»¥ä¸Šçš„é”™ï¼Œè¯´æ˜BIOSä¸­çš„Intel Virtual Technologyä¸æ˜¯EnableçŠ¶æ€ï¼Œéœ€è¦é‡å¯ç”µè„‘ï¼Œç„¶åæŒ‰F2è¿›å…¥BIOSè®¾ç½®Intel Virtual Technologyä¸ºEnableï¼Œå¦‚å›¾ï¼š\nç”µè„‘é‡å¯åé‡æ–°æ‰“å¼€è™šæ‹Ÿæœºã€‚\n16ã€æ‰“å¼€è™šæ‹Ÿæœºåï¼Œå¦‚æœæç¤ºå¦‚ä¸‹å›¾ï¼Œé€‰æ‹©ä¸å†æç¤ºï¼Œç¡®å®šã€‚\n17ã€åŠ ç”µè¿›å…¥å®‰è£…é€‰é¡¹ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹\nå¼€å§‹å®‰è£…ï¼Œä¸‹ä¸€æ­¥\né€‰æ‹©è¯­è¨€ï¼Œè¿™é‡Œæ˜¯å®‰è£…æ—¶å€™çš„è¯­è¨€ï¼Œä¸æ˜¯å®‰è£…å®Œæˆåçš„ç³»ç»Ÿè¯­è¨€\nè½¯ä»¶é€‰æ‹©\nè¿™é‡Œå¦‚æœå®‰è£…åæ˜¯å¸¦å›¾å½¢åŒ–çš„ï¼Œå¯ä»¥é€‰æ‹©â€œå¸¦GUIçš„æœåŠ¡å™¨â€ -\u0026gt; KDEï¼Œè¿™ç§æ–¹å¼æ¯”è¾ƒè€—å†…å­˜å’Œå ç¡¬ç›˜ï¼›\nå¦‚æœéœ€è¦å®‰è£…åä¸å¸¦å›¾å½¢åŒ–çš„ï¼ˆå³å®‰è£…å®Œåªæœ‰é»‘æ¡†æ¡†ï¼Œçœ‹ç€é€¼æ ¼å¾ˆé«˜ï¼‰ï¼Œå¯ä»¥é€‰æ‹©â€œæœ€å°å®‰è£…â€ã€‚\nè¿™é‡Œé€‰æ‹©å¸¦å›¾å½¢åŒ–çš„ã€‚\né€‰æ‹©å®‰è£…ä½ç½®ï¼Œé€‰æ‹©â€œæˆ‘è¦é…ç½®åˆ†åŒºâ€ï¼Œç‚¹å‡»å®Œæˆ\nLVMæ”¹æˆæ ‡å‡†åˆ†åŒºï¼Œç‚¹å‡»åŠ å·ï¼ŒæŒ‚è½½ç‚¹ / å®¹é‡20Gï¼›ç‚¹å‡»æ·»åŠ æŒ‚è½½ç‚¹ã€‚åŒç†åŠ swapä¸º4Gï¼Œ/bootä¸º2G\nç‚¹å‡»å®Œæˆï¼Œæ¥å—æ›´æ”¹\nç‚¹å‡»å¼€å§‹å®‰è£…ï¼š\nç„¶åä¿®æ”¹ROOTç”¨æˆ·çš„å¯†ç ï¼Œå¤§æ¦‚è¿‡10å‡ åˆ†é’Ÿåï¼Œå®‰è£…å®Œæˆï¼Œç‚¹å‡»é‡å¯ã€‚\nåŒæ„åè®®\nä¸è¿›è¡Œkdumpå¤‡ä»½\nç‚¹å‡»å®Œæˆåï¼Œé€‰æ‹©ç¡®å®šé‡å¯ã€‚\né‡å¯åé€‰æ‹©ç³»ç»Ÿè¯­è¨€ï¼Œè¾“å…¥æ³•ï¼Œåˆ›å»ºæœ¬åœ°è´¦å·ï¼Œä½ç½®é€‰æ‹©ä¸Šæµ·\nå®‰è£…å¥½äº†ï¼Œçœ‹çœ‹æ•ˆæœï¼š\n18ã€æ¥ä¸‹æ¥é…ç½®æ¡¥æ¥æ¨¡å¼ä¸Šç½‘\nç‚¹å‡»ä»…ä¸»æœº -\u0026gt; æ›´æ”¹è®¾ç½®\nç‚¹æ¡¥æ¥æ¨¡å¼ï¼Œé€‰æ‹©ç½‘å¡\né…ç½®Redhat7çš„è™šæ‹Ÿæœºè®¾ç½® -\u0026gt; ç½‘ç»œé€‚é…å™¨ -\u0026gt; ç½‘ç»œè¿æ¥è®¾ç½®ä¸ºæ¡¥æ¥æ¨¡å¼ã€‚\nï¼ˆè¿™ä¸ªåœ¨å®‰è£…æ—¶å€™æˆ‘ä»¬å°±é€‰æ‹©äº†æ­¤æ¨¡å¼ï¼‰\næŸ¥çœ‹æœ¬åœ°ä¸»æœºIPï¼š\næ‰“å¼€ç»ˆç«¯ï¼Œipconfigï¼š\nç„¶åç¼–è¾‘ç½‘ç»œé…ç½®ï¼š\nvim /etc/sysconfig/network-scripts/ifcfg-eno16777736 BOOTPROTO=static #staticï¼Œé™æ€ipï¼Œè€Œä¸æ˜¯dhcpï¼Œè‡ªåŠ¨è·å–ipåœ°å€ã€‚ IPADDR=192.168.43.5 #è®¾ç½®æˆ‘æƒ³ç”¨çš„é™æ€ipåœ°å€ï¼Œè¦å’Œç‰©ç†ä¸»æœºåœ¨åŒä¸€ç½‘æ®µï¼Œä½†åˆä¸èƒ½ç›¸åŒã€‚ NETMASK=255.255.255.0 #å­ç½‘æ©ç ï¼Œå’Œç‰©ç†ä¸»æœºä¸€æ ·å°±å¯ä»¥äº†ã€‚ GATEWAY=192.168.43.1 #å’Œç‰©ç†ä¸»æœºä¸€æ · DNS1=114.114.114.114 #DNSæœåŠ¡åœ°å€ï¼Œå†™114.114.114.114 ONBOOT=yes #å¼€æœºå¯ç”¨ç½‘ç»œé…ç½®ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä¿®æ”¹å®Œåï¼Œä¿å­˜é€€å‡ºã€‚æ‰§è¡Œï¼š\nsystemctl restart networké‡å¯ç½‘ç»œã€‚\nç„¶åç”¨ifconfigå‘½ä»¤æŸ¥çœ‹é…ç½®ï¼š\nç„¶åæµ‹è¯•ç½‘ç»œï¼Œ åœ¨æœ¬åœ°ping linuxçš„IPï¼Œè¿™é‡Œå³ï¼šping 192.168.43.5ï¼Œç„¶ååœ¨linuxä¸Špingæœ¬åœ°ï¼šè¿™é‡Œå³ping 192.168.43.16ï¼Œå¦‚æœæœ¬åœ°å¯ä»¥pingé€šlinuxï¼Œä½†linuxä¸èƒ½pingé€šæœ¬åœ°ï¼Œè¯´æ˜windowså¼€äº†é˜²ç«å¢™ï¼Œè¯·å…³é—­é˜²ç«å¢™åé‡è¯•ã€‚\nåœ¨linuxä¸Špingæ·˜å®ç½‘å€ï¼š\nåˆ©ç”¨Firefoxæµè§ˆå™¨æˆåŠŸè®¿é—®æ·˜å®ã€‚\nä»¥ä¸Šä½¿ç”¨åˆ°çš„è½¯ä»¶ï¼šVMware12ã€RedHat7ã€Xshellç­‰è½¯ä»¶ï¼Œå¯ä»¥å…³æ³¨æ–‡æœ«å…¬ä¼—å·ï¼Œå›å¤ï¼šã€1ã€‘è·å–ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/vmware%E4%B8%8A%E5%AE%89%E8%A3%85linux%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä»¥å‰çš„ç”µè„‘ä¸Šå®‰è£…è¿‡vmware+redhatï¼Œä½†æ˜¯å¥ˆä½•ç”µè„‘å¤ªè€ï¼Œé…ç½®å¤ªä½ï¼Œæ‰“å¼€çš„æ—¶å€™è¶…çº§å¡ï¼Œæ²¡æ³•ç”¨ã€‚æ¢äº†ç”µè„‘åï¼Œå†è£…ä¸Šç©ç©ï¼Œæ•…æ­¤è®°å½•ä¸€ä¸‹å®‰è£…è¿‡ç¨‹ã€‚éœ€è¦å®‰è£…çš„å°ä¼™ä¼´å¯ä»¥åœ¨æ­¤è·å–åŒ…ç„¶åæŒ‰æ­¤æ­¥éª¤å®‰è£…ã€‚\u003c/p\u003e","title":"vmwareä¸Šå®‰è£…linuxè¿‡ç¨‹è®°å½•","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/cmder/","section":"Tags","summary":"","title":"Cmder","type":"tags"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/%E5%B7%A5%E5%85%B7/","section":"Tags","summary":"","title":"å·¥å…·","type":"tags"},{"content":"ä»Šå¤©æ¥æ¨èä¸€ä¸ªè¶…çº§å¥½ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼šcmder\nä¸€æ¬¾Windowsç¯å¢ƒä¸‹éå¸¸ç®€æ´ç¾è§‚æ˜“ç”¨çš„cmdæ›¿ä»£è€…ï¼Œå®ƒæ”¯æŒäº†å¤§éƒ¨åˆ†çš„Linuxå‘½ä»¤ã€‚æ”¯æŒsshè¿æ¥linuxï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æ¯”èµ·cmdã€powershellã€conEmuï¼Œå…¶ç•Œé¢ç¾è§‚ç®€æ´ï¼ŒåŠŸèƒ½å¼ºå¤§ã€‚ä¸‹é¢æ¥çœ‹çœ‹æ•ˆæœï¼š\nä¸Šé¢æ¼”ç¤ºäº†linuxä¸‹çš„ls -lã€viï¼Œä»¥åŠviç¼–è¾‘ä¸­çš„åˆ é™¤è¡Œï¼Œå¤åˆ¶ã€ç²˜è´´ï¼Œè·³åˆ°è¡Œé¦–ã€è¡Œå°¾ã€‚ç­‰åŸºæœ¬å‘½ä»¤ï¼Œé€šè¿‡è®¾ç½®åˆ«åå¯ä»¥è®©æ“ä½œèµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚\n1ã€ æŠŠè§£å‹åçš„ç›®å½•åŠ åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œç„¶åwin Rï¼Œè¾“å…¥cmderå³å¯å¿«æ·æ‰“å¼€ï¼š\nå¦‚ä¸‹ï¼š\n2ã€ é€šè¿‡ctrl é¼ æ ‡æ»šè½®è°ƒæ•´å­—ä½“å¤§å°ï¼›\n3ã€ æ·»åŠ cmderåˆ°å³é”®èœå•\næ‰“å¼€cmderå‘½ä»¤çª—å£ï¼Œè¾“å…¥ï¼š\n$ cmder.exe /REGISTER ALL æ•ˆæœå¦‚ä¸‹ï¼š\n4ã€ è§£å†³ä¸­æ–‡ä¹±ç ï¼š\nåœ¨Settings -\u0026gt;Startup -\u0026gt; Environmentä¸­æ·»åŠ ä¸€è¡Œï¼š\nset LC_ALL=zh_CN.UTF-8 å¦‚ä¸‹ï¼šè®°å¾—åŠ åé¢çš„åˆ†å·å“¦ï¼\n5ã€ ä¿®æ”¹å‘½ä»¤æç¤ºç¬¦å·ï¼š\ncmderé»˜è®¤çš„å‘½ä»¤æç¤ºç¬¦æ˜¯Î»ï¼Œå¦‚æœæƒ³æ”¹æˆå¸¸è§çš„$ ,å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š\næ‰“å¼€cmderå®‰è£…ç›®å½•ä¸‹çš„\\vendor\\clink.luaæ–‡ä»¶ï¼Œ\næ‰¾åˆ°42è¡Œçš„\u0026quot;{lamb}\u0026rsquo;\u0026rsquo; æ”¹ä¸ºæƒ³è¦çš„ç¬¦å·ï¼Œç„¶åé‡å¯cmderå³å¯ã€‚\n6ã€ è®¾ç½®åˆ«åï¼š\ncmderåŸç”Ÿæ²¡æœ‰** ll **å‘½ä»¤ï¼Œä½†å¯ä»¥é€šè¿‡è®¾ç½®åˆ«åæ¥å®ç°ï¼š\næ‰“å¼€cmderå®‰è£…ç›®å½•ä¸‹çš„\\config\\user-aliases.cmdæ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹åˆ«åè®¾ç½®ï¼š\nl=ls --show-control-chars -F --color $* la=ls -aF --show-control-chars -F --color $* ll=ls -alF --show-control-chars -F --color $* å¦‚ä¸‹ï¼š\n7ã€ å¿«æ·é”®ï¼š\nå¦å¤–è¿˜å¯ä»¥åˆ©ç”¨å¿«æ·é”®\nctrl uï¼šåˆ é™¤å½“å‰å‘½ä»¤è¡Œå†…å®¹ï¼›\nctrl lï¼šæ¸…å±ï¼›\né¼ æ ‡é€‰ä¸­å¤åˆ¶ï¼Œå³é”®ç²˜è´´~~~\nå…¶ä»–åŠŸèƒ½è¯·ç§»æ­¥googleæŸ¥çœ‹ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E6%8E%A8%E8%8D%90%E4%B8%80%E6%AC%BE%E8%B6%85%E5%A5%BD%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7cmder/","section":"Posts","summary":"\u003cp\u003eä»Šå¤©æ¥æ¨èä¸€ä¸ªè¶…çº§å¥½ç”¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼šcmder\u003c/p\u003e\n\u003cp\u003eä¸€æ¬¾Windowsç¯å¢ƒä¸‹éå¸¸ç®€æ´ç¾è§‚æ˜“ç”¨çš„cmdæ›¿ä»£è€…ï¼Œå®ƒæ”¯æŒäº†å¤§éƒ¨åˆ†çš„Linuxå‘½ä»¤ã€‚æ”¯æŒsshè¿æ¥linuxï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æ¯”èµ·cmdã€powershellã€conEmuï¼Œå…¶ç•Œé¢ç¾è§‚ç®€æ´ï¼ŒåŠŸèƒ½å¼ºå¤§ã€‚ä¸‹é¢æ¥çœ‹çœ‹æ•ˆæœï¼š\u003c/p\u003e","title":"æ¨èä¸€æ¬¾è¶…å¥½ç”¨çš„å·¥å…·cmder","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/lamp/","section":"Tags","summary":"","title":"Lamp","type":"tags"},{"content":"ä»Šå¤©æ¥åœ¨LAMPç¯å¢ƒä¸‹æ­å»ºä¸€ä¸ªPHPé¡¹ç›®ï¼Œå¼€å§‹ä¹‹å‰ï¼Œå…ˆæ¥æ™®åŠä¸‹ç‰©è”ç½‘å¸¸è¯†ï¼š\nç‰©è”ç½‘ï¼Œå³Internet of Thingsï¼Œç®€å†™IOTã€‚è®©æ‰€æœ‰èƒ½è¡Œä½¿ç‹¬ç«‹åŠŸèƒ½çš„æ™®é€šç‰©ä½“å®ç°äº’è”äº’é€šçš„ç½‘ç»œï¼Œé€šè¿‡ç‰©è”ç½‘å¯ä»¥ç”¨ä¸­å¿ƒè®¡ç®—æœºå¯¹æœºå™¨ã€è®¾å¤‡ã€äººå‘˜è¿›è¡Œé›†ä¸­ç®¡ç†ã€æ§åˆ¶ï¼Œå®ç°ç‰©ç‰©ç›¸è¿ã€‚è¿‘å‡ å¹´ç‰©è”ç½‘åœ¨è¿è¾“ã€ç‰©æµã€å¥åº·åŒ»ç–—ã€æ™ºèƒ½ç¯å¢ƒï¼ˆå®¶åº­ã€åŠå…¬ã€å·¥å‚ï¼‰ç­‰é¢†åŸŸéƒ½åœ¨è¿…é€Ÿå‘å±•ï¼Œå‰æ™¯æ‰“å¥½ã€‚\nBå“¥æœ€è¿‘ç ”ç©¶ä¸€ä¸ªç‰©è”ç½‘é¡¹ç›®ï¼šåŸºæœ¬åŠŸèƒ½å°±æ˜¯è¦åœ¨webç½‘ç«™å’Œæ‰‹æœºappç«¯å®æ—¶ç›‘æ§ç¡¬ä»¶ä¸Šå‘æ¥çš„æ•°æ®ï¼Œç”¨äºåˆ†æã€é›†ä¸­ç®¡ç†ä¸æ§åˆ¶ï¼Œç¡¬ä»¶æ˜¯åŸºäºARMçš„ï¼Œwebç«¯æ˜¯ç”¨phpå¼€å‘çš„ï¼ŒåŸºæœ¬åŠŸèƒ½å¯ä»¥è·‘èµ·æ¥ï¼Œç°åœ¨ä¸»è¦åœ¨è¿™åŸºç¡€ä¸Šå®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚ä¸Šä¸€èŠ‚Bå“¥å·²ç»åœ¨äº‘æœåŠ¡å™¨ä¸Šæ­å»ºå¥½LAMPç¯å¢ƒï¼ˆ linuxä¸Šå®‰è£…LAMPç¬”è®°ï¼‰ï¼Œæ¥ä¸‹æ¥å°±è¦æŠŠwebé¡¹ç›®éƒ¨ç½²å¥½æœåŠ¡å™¨ä¸Šã€‚é‡åˆ°äº†å¾ˆå¤šé—®é¢˜ï¼Œåœ¨æ­¤ä¸€ä¸€è®°å½•ã€‚\nå…¶ä¸­é¡¹ç›®ä»£ç ç»“æ„å¦‚ä¸‹ï¼š\nå…ˆæŠŠé¡¹ç›®ä¼ åˆ°æœåŠ¡å™¨ä¸Šï¼Œç„¶åè§£å‹ï¼š\ncd /var/www/html unzip AdminIOT #å…ˆæŠŠç›®å½•ä¸‹æ–‡ä»¶æƒé™æ”¹ä¸º777 chmod -R 777 AdminIOT ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹httpdã€phpã€mariadbçš„ç‰ˆæœ¬ï¼š\nrpm -qa|grep -P \u0026#34;httpd|php|maria\u0026#34; åˆ†åˆ«ä¸º2.4.6ã€5.4.16ã€5.5.56\né…ç½®apacheæœåŠ¡å™¨çš„æ—¶å€™httpd-vhosts.confæ–‡ä»¶åœ¨/usr/share/doc/httpd-2.4.6ç›®å½•ä¸‹\n(windowsä¸Šå¥½åƒç›´æ¥åœ¨conf/extra/ä¸‹)ï¼Œ\näºæ˜¯åœ¨/etc/httpd/conf/httpd.confä¸­åŠ å…¥ï¼š\ninclude /usr/share/doc/httpd-2.4.6/httpd-vhosts.confï¼Œ\nç»“æœå¯åŠ¨æ—¶æŠ¥é”™äº†ã€‚äºæ˜¯å°±æŠŠ\n/usr/share/doc/httpd-2.4.6/httpd-vhosts.confæ–‡ä»¶å¤åˆ¶åˆ°/etc/httpd/conf/extraç›®å½•ä¸‹ï¼š\n#åˆ›å»ºç›®å½• mkdir -p /etc/httpd/conf/extra #å¤åˆ¶ cp /usr/share/doc/httpd-2.4.6/httpd-vhosts.conf /etc/httpd/conf/extra ç„¶ååœ¨extraä¸‹çš„httpd-vhosts.confä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š\nDocumentRoot ä¸ºé¡¹ç›®ä»£ç è·¯å¾„ï¼›\nServerName æœåŠ¡åˆ«åï¼Œè¿™é‡Œè®¾ç½®ä¸ºåŸŸåï¼Œä½†æ˜¯å¾—åœ¨hostæ–‡ä»¶é‡Œé…ç½®å¯¹åº”çš„IPï¼ŒIPå³ä¸ºå½“å‰èŠ‚ç‚¹IPï¼›\n\u0026lt;VirtualHost *:80\u0026gt; ServerName www.mysmallsoup.com DocumentRoot \u0026#34;/var/www/html/AdminIOT/public\u0026#34; DirectoryIndex index.php \u0026lt;Directory \u0026#34;/var/www/html/AdminIOT/public\u0026#34;\u0026gt; AllowOverride All Require all granted Options all \u0026lt;/Directory\u0026gt; ErrorLog \u0026#34;/var/log/httpd/dummy-host2.example.com-error_log\u0026#34; CustomLog \u0026#34;/var/log/httpd/dummy-host2.example.com-access_log\u0026#34; common \u0026lt;/VirtualHost\u0026gt; ç„¶ååœ¨http.confé…ç½®æ–‡ä»¶ä¸­åŒ…å«httpd-vhosts.confæ–‡ä»¶ï¼š\ncd /etc/httpd/conf vim httpd.conf #æ‰“å¼€æ–‡ä»¶ååœ¨æ–‡ä»¶æœ«å°¾åŠ å…¥ä»¥ä¸‹é…ç½®ï¼š Include conf/extra/httpd-vhosts.conf ç„¶åå°†åŸŸåç»‘å®šIPï¼š\nvim /etc/hosts åŠ å…¥IP åŸŸåï¼Œå¦‚ä¸‹ï¼š\n120.79.147.88 www.mysmallsoup.com ç„¶åé‡æ–°å¯åŠ¨httpdæœåŠ¡å™¨ï¼š\nsystemctl restart httpd **æ³¨ï¼š**å¦‚æœç›´æ¥åœ¨windowsä¸Šç”¨åŸŸåè®¿é—®ï¼Œå¾—åœ¨windowsçš„hosté‡ŒåŠ IP åŸŸåå¯¹åº”å…³ç³»ï¼Œä½†æ˜¯åŠ äº†ä»¥åè®¿é—®ä¼šæŠ¥å¦‚ä¸‹é”™ï¼Œå› ä¸ºåŸŸåå¾—å…ˆå¤‡æ¡ˆæ‰èƒ½ç”¨ã€‚æ‰€ä»¥ä¸‹é¢éƒ½ç”¨IPè®¿é—®ã€‚\nç„¶ååœ¨æœ¬åœ°windowsæµè§ˆå™¨é‡Œè®¿é—®http://120.79.147.88:80åœ°å€ï¼ŒæŠ¥é”™ï¼š\ndate(): It is not safe to rely on the system\u0026#39;s timezone settingsï¼š ç„¶ååœ¨æŸ¥åˆ°ï¼š\nå®é™…ä¸Šï¼Œä» PHP 5.1.0 ï¼Œå½“å¯¹ä½¿ç”¨date()ç­‰å‡½æ•°æ—¶ï¼Œå¦‚æœtimezoneè®¾ç½®ä¸æ­£ç¡®ï¼Œåœ¨æ¯ä¸€æ¬¡è°ƒç”¨æ—¶é—´å‡½æ•°æ—¶,éƒ½ä¼šäº§ç”ŸE_NOTICE æˆ–è€… E_WARNING ä¿¡æ¯ã€‚è€Œåˆåœ¨php5.1.0ä¸­ï¼Œdate.timezoneè¿™ä¸ªé€‰é¡¹ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯å…³é—­çš„ï¼Œæ— è®ºç”¨ä»€ä¹ˆphpå‘½ä»¤éƒ½æ˜¯æ ¼æ—å¨æ²»æ ‡å‡†æ—¶é—´ï¼Œä½†æ˜¯PHP5.3ä¸­å¥½åƒå¦‚æœæ²¡æœ‰è®¾ç½®ä¹Ÿä¼šå¼ºè¡ŒæŠ›å‡ºäº†è¿™ä¸ªé”™è¯¯çš„,è§£å†³æ­¤é—®é¢˜ï¼Œåªè¦æœ¬åœ°åŒ–ä¸€ä¸‹ï¼Œå°±è¡Œäº†ã€‚\nè€Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯PHP5.4ç‰ˆæœ¬ï¼Œç„¶ååœ¨php.iniæ–‡ä»¶ä¸­åŠ å…¥æ—¶åŒºçš„é…ç½®ï¼š\nvim /etc/php.ini#åŠ å…¥å¦‚ä¸‹é…ç½®ï¼šdate.timezone = \u0026#34;Asia/Shanghai\u0026#34; åŠ å…¥ä»¥åï¼Œä¿å­˜é€€å‡ºï¼Œé‡æ–°å¯åŠ¨apacheæœåŠ¡ï¼Œåˆ·æ–°é¡µé¢ï¼Œé”™è¯¯å°±è§£å†³äº†ã€‚\nåˆ°è¿™ä¸€æ­¥ï¼Œè¯´æ˜é¡¹ç›®éƒ¨ç½²æµç¨‹å·²ç»æ‰“é€šï¼Œä½†æ˜¯ç°åœ¨éœ€è¦ç™»å½•ï¼Œé‚£ä¹ˆè‚¯å®šè¦åœ¨æ•°æ®åº“é‡Œé¢å…ˆå­˜å…¥ç”¨æˆ·åå¯†ç ç­‰ä¸€äº›æ•°æ®ã€‚æ¥ä¸‹æ¥ï¼Œå…ˆç»™æ•°æ®åº“é‡Œå¯¼å…¥äº›åˆå§‹åŒ–æ•°æ®ã€‚\næ•°æ®åº“å¯¼å…¥æ•°æ®ï¼š\nå…ˆé‡æ–°å¯åŠ¨æ•°æ®åº“ï¼š\nsystemctl restart mariadb ç„¶åè¯•ç€åœ¨æœ¬åœ°windowsä¸Šç”¨Navicatæ•°æ®åº“ç®¡ç†å·¥å…·å¯¼å…¥sqlè„šæœ¬ï¼Œç”¨äºæ•°æ®åº“çš„åˆå§‹åŒ–ï¼ˆå»ºåº“ã€æ•°æ®æ’å…¥ç­‰ï¼‰ï¼Œæˆ‘ä¹ æƒ¯æ€§çš„æŠŠç«¯å£å†™ä¸º3306ï¼ˆæ•°æ®åº“é»˜è®¤ç«¯å£ï¼‰ï¼Œç„¶åå»è¿æ¥ï¼Œå‘ç°æŠ¥é”™äº†ï¼š\nç„¶åå»æŸ¥çœ‹3306ç«¯å£æ˜¯å¦ç›‘å¬ï¼š\nnetstat -anp | grep 3306 æŸ¥ä¸åˆ°ä¸œè¥¿ï¼Œè¯´æ˜3306ç«¯å£æ²¡æœ‰ç›‘å¬ï¼Œè¿™å°±å¥‡æ€ªäº†ã€‚ç„¶åç™»é™†æ•°æ®åº“ï¼š\nmysql -uroot -pæ•°æ®åº“å¯†ç  ç™»é™†è¿›å»æŸ¥çœ‹æ•°æ®åº“ç«¯å£ï¼š\nshow variables like \u0026#39;port\u0026#39;; å‘ç°æŸ¥åˆ°çš„ç«¯å£ç«Ÿç„¶æ˜¯0ï¼Œç„¶ååˆæŸ¥äº†èµ„æ–™ï¼Œå‘ç°æ˜¯å¯åŠ¨æ•°æ®åº“çš„æ—¶å€™åŠ äº†skip-networkingå¯¼è‡´çš„ï¼Œå¯åŠ¨æ—¶ç”¨äº†å¦‚ä¸‹å‘½ä»¤ï¼š\nmysqld_safe --user=mysql --skip-grant-tables --skip-networking \u0026amp; \u0026ndash;skip-networking=0è¡¨ç¤ºç›‘å¬é…ç½®ç«¯å£ï¼Œé»˜è®¤ç›‘å¬3306ï¼Œç­‰äº1æˆ–è€…\u0026ndash;skip-networkingä¸èµ‹å€¼è¡¨ç¤ºè·³è¿‡ç«¯å£ç›‘å¬ï¼Œæ­¤æ—¶ç›‘å¬0ï¼Œç½‘ç»œä¸å¯è®¿é—®æ•°æ®åº“ï¼Œåªèƒ½æ•°æ®åº“èŠ‚ç‚¹è®¿é—®ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š\nshow variables like \u0026#39;skip_networking\u0026#39;; å‘ç°æ˜¯ONï¼Œè¯´æ˜å¼€å¯äº†skip_networkingï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å…³æ‰å®ƒã€‚\næŸ¥çœ‹mysqlè¿›ç¨‹ï¼š\nps -ef | grep mysql [å›¾ç‰‡ä¸Šä¼ ä¸­\u0026hellip;(image-3ac06c-1571321042895-17)]\nç„¶åæ€æ‰è¿›ç¨‹ï¼Œé‡æ–°å¯åŠ¨æ•°æ®åº“ï¼š\nkill 12080 mysqld_safe --user=mysql --skip-grant-tables --skip-networking=0 \u0026amp; ç„¶åå†æ¥æŸ¥çœ‹3306ç«¯å£æ˜¯å¦ç›‘å¬ï¼š\nnetstat -anp | grep 3306 å‘ç°ç«¯å£æ­£å¸¸ç›‘å¬ï¼Œç„¶åç™»é™†æ•°æ®åº“ï¼ŒæŸ¥çœ‹ï¼š\nå‘ç°portä¸º3306ï¼Œskip_networkingä¸ºOFFï¼Œæ­¤æ—¶å†åœ¨windowsä¸Šè¿æ¥æ•°æ®åº“ï¼Œå°±okäº†ã€‚\nè¿æ¥ä¸Šæ•°æ®åº“åï¼Œå°±å¯ä»¥å¯¼å…¥sqlæ–‡ä»¶äº†ï¼š\nå¯¼å…¥ä»¥åï¼Œæ‰“å¼€åˆšæ‰çš„webç™»é™†é¡µé¢ï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œå‘ç°éªŒè¯ç å›¾ç‰‡çœ‹ä¸è§ï¼š\nç„¶åå»çœ‹è¿è¡Œæ—¥å¿—ï¼š\ncd /var/www/html/AdminIOT/runtime/log/201806 tailf 10.log ç„¶ååˆ·æ–°éªŒè¯ç ï¼ŒæŠ¥é”™Call to undefined function Think\\imagecreate()\nç„¶åæŸ¥çœ‹å¦‚ä¸‹çš„è¯´æ³•ï¼š\nåœ¨phpä¸­imagecreateå‡½æ•°æ˜¯ä¸€ä¸ªå›¾å½¢å¤„ç†å‡½æ•°ï¼Œä¸»è¦ç”¨äºæ–°å»ºä¸€ä¸ªåŸºäºè°ƒè‰²æ¿çš„å›¾åƒäº†ï¼Œç„¶ååœ¨è¿™ä¸ªåŸºç¡€ä¸Šæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€äº›å›¾å½¢æ•°å­—å­—ç¬¦ä¹‹ç±»çš„ï¼Œä½†è¿™ä¸ªå‡½æ•°éœ€è¦GDåº“æ”¯æŒï¼Œå¦‚æœæ²¡æœ‰å¼€å¯GDåº“ä½¿ç”¨æ—¶ä¼šæç¤ºCall to undefined function imagecreate()é”™è¯¯ã€‚\né‚£å°±è¯•ç€å®‰è£…ä¸€ä¸‹GDåº“å§ï¼Œæ‰§è¡Œyumå®‰è£…gdå‘½ä»¤ï¼Œç„¶åé‡æ–°å¯åŠ¨apachceæœåŠ¡ä»¥ä½¿å®‰è£…åçš„GDåº“ç”Ÿæ•ˆã€‚\nyum -y install php-gd systemctl restart httpd ç„¶ååˆ·æ–°é¡µé¢ï¼ŒéªŒè¯ç å°±å¯ä»¥æ­£å¸¸æ˜¾ç¤ºäº†ã€‚ç™»é™†è¿›å»ä»¥åï¼ŒåˆæŠ¥é”™äº†ï¼šCall to undefined function think\\mb_strlen()ã€‚\nç½‘ä¸Šæœ‰äººè¯´ï¼Œé‡åˆ°ä¸Šè¿°é”™è¯¯ï¼Œæ˜¯æœªå¼€å¯php_mbstringæ‹“å±•ï¼Œå³æ‰¾åˆ°php.inié‡Œçš„\n;extension=php_mbstring.dllæŠŠå‰é¢çš„ï¼›å»æ‰ï¼Œä½†æ˜¯æ‰¾äº†å‘ç°æ²¡æœ‰è¿™ä¸ªæ‰©å±•é…ç½®ï¼Œå¯èƒ½æ˜¯å› ä¸ºç‰ˆæœ¬è¾ƒé«˜çš„åŸå› ã€‚åœ¨/etc/php.dç›®å½•ä¸‹ä¹Ÿæ²¡æ‰¾åˆ°æ­¤æ‰©å±•ï¼Œç„¶åå°±ç”¨yumå®‰è£…ä¸€ä¸ªå§ï¼Œç„¶åé‡å¯apacheæœåŠ¡ï¼š\nyum install -y php-mbstring systemctl restart httpd é‡å¯ä»¥åç™»å½•é¡µé¢åè¿™ä¸ªé”™è¯¯å°±æ²¡äº†ï¼Œä½†æ˜¯åˆæŠ¥å¦ä¸€ä¸ªé”™è¯¯ï¼š\ncould not find driver\nç„¶åå®‰è£…php-mysqlï¼Œå®‰è£…å¥½åï¼Œé‡å¯apacheæœåŠ¡ï¼š\nyum install php-mysql.x86_64 systemctl restart httpd é‡æ–°ç™»å½•é¡µé¢ï¼Œè¿™ä¸ªé”™è¯¯ä¹Ÿè¿‡å»äº†ã€‚åˆæŠ¥å¦ä¸€ä¸ªé”™è¯¯ï¼š\nSQLSTATE[28000] [1045] Access denied for user \u0026lsquo;iotadmin\u0026rsquo;@\u0026rsquo;localhost\u0026rsquo; (using password: YES)ã€‚\nç„¶åç™»é™†æ•°æ®åº“ï¼Œæˆæƒiotadminç”¨æˆ·è®¿é—®æƒé™ï¼š\ngrant all privileges on adminiot.* to \u0026#39;iotadmin\u0026#39;@\u0026#39;localhost\u0026#39; identified by \u0026#39;iotadmin\u0026#39;; flush privileges; æ‰§è¡Œå®Œä»¥åï¼Œå†æ¬¡åˆ·æ–°é¡µé¢ï¼ŒæŠ¥é”™å°±è¿‡å»äº†ã€‚æ¥ä¸‹æ¥çš„åˆæ˜¯å¦ä¸€ä¸ªé”™ï¼Œé”™è¯¯å¦‚ä¸‹å›¾ï¼š\nè¿›åå°å»çœ‹è¿è¡Œæ—¥å¿—10.logï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š\ncd /var/www/html/AdminIOT/runtime/log/201806/ tailf 10.log æ‰¾åˆ°ä»£ç Base.phpçš„198è¡Œï¼Œå¦‚ä¸‹ï¼š\nä»£ç æŠ¥é”™ï¼šArbitrary expressions in empty are allowed in PHP 5.5 only lessï¼Œ\nå¤§æ¦‚æ„æ€å°±æ˜¯è¯´â€œä¸åŒç±»å‹çš„è¡¨è¾¾å¼ç”¨emptyåˆ¤ç©ºåªæœ‰PHP5.5æ‰â€ï¼Œè€ŒæœåŠ¡å™¨ä¸Šå®‰è£…çš„æ˜¯PHP5.4ç‰ˆæœ¬ï¼Œæ‰€ä»¥å°±æŠ¥è¿™ä¸ªé”™ã€‚è¿™é‡Œä¸å¦¨æ¢ä¸€ç§æ–¹å¼å†™ï¼Œåªè¦é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚é‚£å°±æ”¹æˆäº†è¿™æ ·ï¼ŒåŸæ¥çš„å†™æ³•å…ˆæ³¨é‡Šæ‰ã€‚\nç„¶åæŠŠæ–‡ä»¶æ›¿æ¢åˆ°æœåŠ¡å™¨å¯¹åº”è·¯å¾„ä¸‹ï¼Œé‡å¯apacheæœåŠ¡ï¼Œåˆ·æ–°é¡µé¢ï¼Œä¸€åˆ‡OKã€‚\nåˆ°è¿™é‡Œwebé¡¹ç›®å°±æ­£å¸¸è·‘èµ·æ¥äº†ã€‚ä¸€è·¯èµ°ä¸‹æ¥ï¼Œæ­¥æ­¥æ˜¯å‘å•Šï¼Œåšä¸€ä¸‹ç¬”è®°ï¼Œè®°å½•ä¸€ä¸‹å‘ï¼Œä»¥åè‚¯å®šä¼šç”¨åˆ°çš„ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/lamp%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E7%89%A9%E8%81%94%E7%BD%91%E9%A1%B9%E7%9B%AE/","section":"Posts","summary":"\u003cp\u003eä»Šå¤©æ¥åœ¨LAMPç¯å¢ƒä¸‹æ­å»ºä¸€ä¸ªPHPé¡¹ç›®ï¼Œå¼€å§‹ä¹‹å‰ï¼Œå…ˆæ¥æ™®åŠä¸‹ç‰©è”ç½‘å¸¸è¯†ï¼š\u003c/p\u003e","title":"LAMPç¯å¢ƒéƒ¨ç½²ç‰©è”ç½‘é¡¹ç›®","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/%E7%89%A9%E8%81%94%E7%BD%91/","section":"Tags","summary":"","title":"ç‰©è”ç½‘","type":"tags"},{"content":"Bå“¥æœ€è¿‘åœ¨å‚åŠ æ¯”èµ›ï¼Œéœ€è¦æŠŠä¸€ä¸ªphpé¡¹ç›®éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šï¼Œæ•…æ­¤åœ¨linuxä¸Šå®‰è£…LAMPç¯å¢ƒï¼Œç”¨äºéƒ¨ç½²é¡¹ç›®ï¼Œç¬¬ä¸€æ¬¡å®‰è£…ï¼Œåšç‚¹å„¿ç¬”è®°è®°å½•ä¸€ä¸‹ã€‚\nå®‰è£…æ¡ä»¶ï¼š\nRedhatæˆ–è€…CentOS linuxç¯å¢ƒå·²è£…å¥½ï¼Œå¹¶é…ç½®äº†yumæºã€‚\nç”¨yumå®‰è£…httpdã€mariadbã€php\nå®‰è£…httpdï¼š\nyum -y install httpd å®‰è£…mariadbï¼š\nyum -y install mariadb-server å®‰è£…phpï¼š\nyum -y install php php-mysql æ£€æŸ¥å®‰è£…åŒ…\nrpm -qa|grep -P \u0026#34;httpd|php|maria\u0026#34; æ­£å¸¸æƒ…å†µè¾“å‡ºå¦‚ä¸‹ï¼š\nå¯åŠ¨httpdï¼š\nsystemctl start httpd éªŒè¯httpdå¯åŠ¨æ˜¯å¦æ­£å¸¸ï¼š\nåœ¨index.htmlæ–‡ä»¶é‡ŒåŠ å…¥http runningå­—ç¬¦ä¸²ï¼š\necho â€œ-----------------httpd running.-------------â€ \u0026gt; /var/www/html/index.html ç„¶åç”¨curlå‘½ä»¤è°ƒæ¥å£ï¼š\ncurl -k http://localhost:80 -v æ­£å¸¸è¿”å›å¦‚ä¸‹ï¼š\né—®é¢˜è§£å†³ï¼š\nå¯åŠ¨åç”¨curlè°ƒè¿”å›403 Forbiddenï¼š\ngoogleæŸ¥äº†èµ„æ–™ä¹Ÿæ²¡æœ‰æŸ¥åˆ°è§£å†³æ–¹æ³•ï¼Œç„¶åæ— æ„é—´é‡å¯äº†ä¸€æŠŠç«Ÿç„¶å¥½äº†ï¼š\nsystemctl restart httpd å…·ä½“åŸå› å°±ä¸å¾—è€ŒçŸ¥äº†ã€‚é‡å¯ä»¥ååœ¨ç”¨curlå‘½ä»¤è°ƒç”¨å°±è¿”å›200OKäº†ã€‚\nå¯åŠ¨mariadbï¼š\nsystemctl start mariadb ç„¶åç™»é™†æ•°æ®åº“ï¼Œæ‰§è¡Œmysqlå‘½ä»¤ï¼Œç»“æœæŠ¥é”™å¦‚ä¸‹ï¼š\nERROR 1045 (28000): Access denied for user \u0026#39;root\u0026#39;@\u0026#39;localhost\u0026#39; (using password: NO) è¿™ä¸ªè°·å“¥ä¸Šå€’æ˜¯æœ‰è§£å†³åŠæ³•ï¼š\n1ã€é¦–å…ˆstopæ•°æ®åº“æœåŠ¡mariadb.service\nsystemctl stop mariadb.service 2ã€ä½¿ç”¨mysqld_safeå¯åŠ¨mysqldï¼š\nmysqld_safe --user=mysql --skip-grant-tables --skip-networking \u0026amp; 3ã€ç„¶åç™»é™†æ•°æ®åº“ï¼š\nmysql -u root mysql åˆ‡æ¢åˆ°mysqlæ•°æ®åº“ï¼š\nuse mysql; ç»™rootç”¨æˆ·è®¾ç½®æ–°çš„å¯†ç ï¼Œè¿™é‡Œnewpasswordå°±æ˜¯æ–°å¯†ç ï¼š\nUPDATE user SET PASSWORD=PASSWORD(\u0026#39;newpassword\u0026#39;) where USER=\u0026#39;root\u0026#39;; æ›´æ–°æƒé™ï¼š\nFLUSH PRIVILEGES; ç„¶åé€€å‡ºæ•°æ®åº“ï¼š\nquit ç„¶åç™»é™†æ•°æ®åº“ï¼š\nmysql -uroot -p è¾“å…¥å¯†ç ï¼Œç™»é™†è¿›å»å¦‚ä¸‹ï¼š\næµ‹è¯•phpï¼š\nåœ¨index.phpæ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹å­—ç¬¦ï¼š\necho \u0026#34; The PHP is running. ?php phpinfo(); ?\u0026gt; \u0026#34;\u0026gt;/var/www/html/index.php ç„¶åcurlè°ƒæ¥å£ï¼š\ncurl -k http://localhost:80/index.php -v æ­£å¸¸æƒ…å†µè¿”å›200OKï¼Œä»¥åŠåˆšæ‰æ’å…¥Index.phpä¸­çš„å­—ç¬¦ä¸²ï¼š\nè‡³æ­¤LAMPå·²æ­å»ºå®Œæ¯•ï¼Œå°Bå“¥å‡†å¤‡éƒ¨ç½²é¡¹ç›®å–½ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/linux%E4%B8%8A%E5%AE%89%E8%A3%85lamp%E7%AC%94%E8%AE%B0/","section":"Posts","summary":"\u003cp\u003eBå“¥æœ€è¿‘åœ¨å‚åŠ æ¯”èµ›ï¼Œéœ€è¦æŠŠä¸€ä¸ªphpé¡¹ç›®éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šï¼Œæ•…æ­¤åœ¨linuxä¸Šå®‰è£…LAMPç¯å¢ƒï¼Œç”¨äºéƒ¨ç½²é¡¹ç›®ï¼Œç¬¬ä¸€æ¬¡å®‰è£…ï¼Œåšç‚¹å„¿ç¬”è®°è®°å½•ä¸€ä¸‹ã€‚\u003c/p\u003e","title":"linuxä¸Šå®‰è£…LAMPç¬”è®°","type":"posts"},{"content":"ä¹‹å‰ä¹Ÿæœ‰å†™è¿‡æœ‰å…³äºçˆ¬è™«çš„å®æˆ˜ç»ƒä¹ ï¼š goè¯­è¨€çˆ¬å–ççˆ±ç½‘\nå½“æ—¶çˆ¬å–æ—¶å½“å¹¶å‘è¿‡å¤§çš„æ—¶å€™ï¼Œè¯·æ±‚å°±ä¼šå‡ºç°å¡æ­»çš„æƒ…å†µã€‚å…¶å®è¿™å¯èƒ½å°±æ˜¯ççˆ±ç½‘å¯¹è¯·æ±‚å’Œè¿æ¥è¿›è¡Œäº†é™åˆ¶ã€‚\nçˆ¬è™«å’Œåçˆ¬æ˜¯ä¸ªâ€œä¸€è¾¹æ”»ï¼Œä¸€è¾¹å®ˆâ€çš„æŠ€æœ¯ï¼Œä½†æˆ‘ä»¬äº²çˆ±çš„çˆ¬è™«å·¥ç¨‹å¸ˆä»¬ä¹Ÿä¸€ç›´éµå®ˆç€â€œåªæ”»ä¸ç ´â€çš„åŸåˆ™ã€‚ç½‘ç«™æœåŠ¡å™¨å¯¹çˆ¬è™«ä¸€ç›´åœ¨åšé™åˆ¶ï¼Œé¿å…æœåŠ¡å™¨æµé‡å¼‚å¸¸ï¼Œè´Ÿè½½è¿‡å¤§ï¼Œé˜²æ­¢æ¶æ„çš„æ”»å‡»å¸¦æ¥å¸¦å®½å’Œèµ„æºçš„æµªè´¹ï¼Œç”šè‡³å½±å“ä¸šåŠ¡æ­£å¸¸è¿è¡Œã€‚å¾€å¾€åŠæ³•æ˜¯é™åˆ¶å¯¹åŒä¸€ä¸ªIPçš„è¿æ¥æ•°å’Œå¹¶å‘æ•°è¿›è¡Œé™åˆ¶ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹nginxçš„è¿æ¥é¢‘ç‡limit_conn_moduleå’Œè¯·æ±‚é¢‘ç‡limit_req_module é™åˆ¶æ¨¡å—ã€‚\nHTTPè¯·æ±‚å»ºç«‹åœ¨ä¸€æ¬¡TCPè¿æ¥åŸºç¡€ä¸Šï¼Œä¸€æ¬¡TCPè¯·æ±‚è‡³å°‘äº§ç”Ÿä¸€æ¬¡HTTPè¯·æ±‚ã€‚\nè¿æ¥é™åˆ¶ï¼š\nè¯­æ³•å¦‚ä¸‹ï¼š\nSyntax:limit_conn_zone key zone=name:size; Default: - Context:http limit_conn_zoneï¼šä¸€å—ç©ºé—´ï¼Œç”¨äºå­˜æ”¾è¢«é™åˆ¶è¿æ¥çš„çŠ¶æ€ï¼›\nkeyï¼šé”®ï¼Œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªè§„åˆ™ï¼Œå°±æ˜¯å¯¹å®¢æœç«¯è¿æ¥çš„ä¸€ä¸ªæ ‡è¯†ï¼Œæ¯”å¦‚å¯ä»¥ç”¨å†…ç½®å˜é‡ â€” å®¢æˆ·ç«¯çš„ipï¼›\nzoneï¼šå°±æ˜¯è¿™å—ç©ºé—´çš„åå­—ï¼Œè¿™ä¸ªéœ€è¦å’Œlocationçš„é…ç½®ç›¸å¯¹åº”ï¼›\nsizeï¼šå°±æ˜¯ç”³è¯·ç©ºé—´çš„å¤§å°ã€‚\nlimit_connæŒ‡ä»¤ï¼š # Syntax: limit_conn zone number; Default: - Context: http, server, location è¿™é‡Œæœ‰ä¸ªå‰æå¿…é¡»åœ¨httpä¸‹å…ˆå®šä¹‰å¥½limit_conn_zoneæ‰å¯ä»¥åœ¨è¿™é‡Œå¼•ç”¨ã€‚ # è¿™é‡Œçš„zoneå°±æ˜¯ä¸Šé¢zoneçš„åå­—ï¼Œnumberå°±æ˜¯åŒä¸€æ—¶é—´è¿æ¥çš„é™åˆ¶æ•°ã€‚\nè¯·æ±‚é¢‘ç‡é™åˆ¶ï¼š\nSyntax: limit_req_zone key zone=name:size rate=rate; Default: - Context: http è¯­æ³•å’Œä¸Šé¢ç±»ä¼¼ï¼Œrateä¸ºé€Ÿç‡é™åˆ¶,ä»¥ç§’ä¸ºå•ä½å¤šå°‘ä¸ªã€‚\nlimit_reqæŒ‡ä»¤ï¼š\nSyntax: limit_req zone=name [burst=number] [nodelay] Default: - Context: http,server,location burst=numberï¼Œé‡ç‚¹è¯´æ˜ä¸€ä¸‹è¿™ä¸ªé…ç½®ï¼Œburstçˆ†å‘çš„æ„æ€ï¼Œè¿™ä¸ªé…ç½®çš„æ„æ€æ˜¯è®¾ç½®ä¸€ä¸ªå¤§å°ä¸ºnumberçš„ç¼“å†²åŒºå½“æœ‰å¤§é‡è¯·æ±‚ï¼ˆçˆ†å‘ï¼‰è¿‡æ¥æ—¶ï¼Œè¶…è¿‡äº†è®¿é—®é¢‘æ¬¡é™åˆ¶çš„è¯·æ±‚å¯ä»¥å…ˆæ”¾åˆ°è¿™ä¸ªç¼“å†²åŒºå†…ï¼Œèµ·åˆ°è®¿é—®é™é€Ÿçš„ä½œç”¨\nnodelayï¼Œå¦‚æœè®¾ç½®ï¼Œè¶…è¿‡è®¿é—®é¢‘æ¬¡è€Œä¸”ç¼“å†²åŒºä¹Ÿæ»¡äº†çš„æ—¶å€™å°±ä¼šç›´æ¥è¿”å›503ï¼ˆService Temporarily Unavailableï¼‰æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™æ‰€æœ‰è¯·æ±‚ä¼šç­‰å¾…æ’é˜Ÿã€‚\nè¿™ä¸¤ä¸ªé»˜è®¤æ˜¯ä¸éœ€è¦é…ç½®çš„ã€‚\né…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š\n$binary_remote_addrè¡¨ç¤ºäºŒè¿›åˆ¶çš„IPåœ°å€ï¼Œä¸€ä¸ªäºŒè¿›åˆ¶çš„ipåœ°å€åœ¨32ä½æœºå™¨ä¸Šå ç”¨32ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆ1Må¯ä»¥å­˜æ”¾å¤šå°‘å‘¢ï¼Œè®¡ç®—ä¸€ä¸‹ï¼Œ1x1024x1024/32 = 32768ï¼Œæ„æ€å°±æ˜¯å¯ä»¥å­˜æ”¾32678ä¸ªipåœ°å€ï¼Œåœ¨ä¸€ä¸ªä¼šè¯ä¸­ï¼Œæ¯”$remote_addrè¦èŠ‚çº¦10ç©ºé—´ï¼›\nrate=1r/sè¡¨ç¤ºæ¯ç§’åªèƒ½æœ‰ä¸€ä¸ªè¯·æ±‚ï¼›\n1ã€\næŠŠlocationä¸‹çš„limité…ç½®éƒ½æ³¨é‡Šæ‰ï¼Œç”¨abå·¥å…·ï¼ˆå‹åŠ›æµ‹è¯•å·¥å…·ï¼‰æµ‹è¯•ï¼š\nab -n10000 -c1000 http://192.168.1.6/index.html è¿™é‡Œ-nè¡¨ç¤ºè¯·æ±‚æ€»æ•°ï¼Œ-cè¡¨ç¤ºåŒä¸€æ—¶é—´çš„è¯·æ±‚æ•°ã€‚\nè¯·æ±‚ä¹‹åæ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸï¼š\n2ã€\nå½“åªæ”¾å¼€limit_req zone=req_zone;æ³¨é‡Šåï¼Œç”¨å‹æµ‹å·¥å…·abå‘èµ·åŒæ ·çš„å‘½ä»¤åï¼š\nå¯ä»¥çœ‹åˆ°åªæˆåŠŸè¯·æ±‚3ä¸ªï¼Œå› ä¸ºreq_zoneé…ç½®çš„rateä¸ºæ¯ç§’ä¸€ä¸ªè¯·æ±‚ã€‚\n3ã€\nå½“åªæ”¾å¼€locationä¸‹limit_req zone=req_zone burst=3 nodelay;æ³¨é‡Šæ—¶ï¼Œç»§ç»­å‘èµ·è¯·æ±‚ï¼š\nå¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸäº†6ä¸ªï¼Œæ¯”ä¸Šä¸€æ¬¡å¤šäº†3ä¸ªã€‚burst=3å°†3ä¸ªè¯·æ±‚æ”¾åˆ°ç¼“å†²åŒºç­‰ä¸‹ä¸€ç§’æ‰§è¡Œã€‚\n4ã€\nå½“åªæ”¾å¼€limit_conn conn_zone 1;æ³¨é‡Šæ—¶ï¼Œä½¿ç”¨abè¿›è¡Œæµ‹è¯•ã€‚æ­¤æ—¶ä¸€ä¸ªipåªèƒ½åŒä¸€æ—¶åˆ»åªèƒ½å»ºç«‹ä¸€ä¸ªè¿æ¥ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/nginx%E8%AF%B7%E6%B1%82%E8%BF%9E%E6%8E%A5%E9%99%90%E5%88%B6%E7%AC%94%E8%AE%B0/","section":"Posts","summary":"\u003cp\u003eä¹‹å‰ä¹Ÿæœ‰å†™è¿‡æœ‰å…³äºçˆ¬è™«çš„å®æˆ˜ç»ƒä¹ ï¼š\n\u003ca href=\"https://kubeinfo.cn/go/?target=aHR0cDovL21wLndlaXhpbi5xcS5jb20vcz9fX2Jpej1Nak01TXpVNU5EWXdOQT09Jm1pZD0yMjQ3NDg0MTU4JmlkeD0xJnNuPTIwZDM3YjYyOWE5YWUyYWU0N2ZhMDhhZThjOWI4YzdkJmNoa3NtPWE2OTVlZjdkOTFlMjY2NmI2NTQ3ZmE0Y2VjYmM5MDMyY2I1MjBhNTQ2NmViMTA3YjI0YWI0M2Y0OGUxMmQ4OWRiZDFkNmVhMDE0NDEmc2NlbmU9MjEjd2VjaGF0X3JlZGlyZWN0\" target=\"_blank\" \u003egoè¯­è¨€çˆ¬å–ççˆ±ç½‘\u003c/a\u003e\u003c/p\u003e","title":"nginxè¯·æ±‚è¿æ¥é™åˆ¶ç¬”è®°","type":"posts"},{"content":"1ã€\nstub_statusæ¨¡å—ï¼š\nç”¨äºå±•ç¤ºnginxå¤„ç†è¿æ¥æ—¶çš„çŠ¶æ€ã€‚\né…ç½®è¯­æ³•å¦‚ä¸‹ï¼š\nSyntaxï¼šstub_status; Defaultï¼šé»˜è®¤æ²¡æœ‰é…ç½® Contextï¼šserverã€location å¯ä»¥ç¼–è¾‘default.confï¼ŒåŠ ä¸Šå¦‚ä¸‹é…ç½®ï¼š\nvim /etc/nginx/conf.d/default.conf ç„¶åæ£€æŸ¥é…ç½®çš„æ­£ç¡®æ€§ï¼š\n#-t è¡¨ç¤ºæ£€æŸ¥é…ç½®æ–‡ä»¶ï¼›-cè¡¨ç¤ºæ£€æŸ¥æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸º/etc/nginx/nginx.conf nginx -t -c /etc/nginx/nginx.conf è¿™é‡Œæ³¨æ„äº†ï¼Œè™½ç„¶ä¿®æ”¹çš„æ˜¯default.confï¼Œä½†æ˜¯æ£€æŸ¥çš„æ—¶å€™å§‹ç»ˆè¿˜æ˜¯åŠ è½½nginx.confï¼Œå¦åˆ™æŠ¥é”™ï¼š\nå› ä¸ºnginx.confä¸­includeäº†conf.dç›®å½•ä¸‹çš„æ‰€æœ‰.confæ–‡ä»¶ã€‚\nç„¶åé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼š\n#-sè¡¨ç¤ºç»™masterè¿›ç¨‹å‘é€ä¿¡å·ï¼šstopã€quitã€reopenã€reloadï¼›-cæŒ‡å®šé…ç½®æ–‡ä»¶ç›®å½• nginx -s reload -c /etc/nginx/nginx.conf Active connections: å¯¹åç«¯å‘èµ·çš„æ´»åŠ¨è¿æ¥æ•°ï¼›\nServer accepts handled requests: Nginxæ€»å…±å¤„ç†äº†13ä¸ªè¿æ¥,æˆåŠŸåˆ›å»º13æ¬¡æ¡æ‰‹ï¼ˆè¯æ˜ä¸­é—´æ²¡æœ‰å¤±è´¥çš„ï¼‰ï¼Œæ€»å…±å¤„ç†äº†7ä¸ªè¯·æ±‚ï¼›\nReading: Nginx è¯»å–åˆ°å®¢æˆ·ç«¯çš„Headerä¿¡æ¯æ•°ï¼›\nWriting: Nginx è¿”å›ç»™å®¢æˆ·ç«¯çš„Headerä¿¡æ¯æ•°ï¼›\nWaiting: å¼€å¯keep-aliveçš„æƒ…å†µä¸‹,è¿™ä¸ªå€¼ç­‰äº active â€“ (reading + writing),æ„æ€å°±æ˜¯Nginxå·²ç»å¤„ç†å®Œæˆ,æ­£åœ¨ç­‰å€™ä¸‹ä¸€æ¬¡è¯·æ±‚æŒ‡ä»¤çš„é©»ç•™è¿æ¥ã€‚\næ‰€ä»¥ï¼Œåœ¨è®¿é—®æ•ˆç‡é«˜,è¯·æ±‚å¾ˆå¿«è¢«å¤„ç†å®Œæ¯•çš„æƒ…å†µä¸‹ï¼ŒWaitingæ•°æ¯”è¾ƒå¤šæ˜¯æ­£å¸¸çš„ã€‚å¦‚æœreading +writingæ•°è¾ƒå¤šï¼Œåˆ™è¯´æ˜å¹¶å‘è®¿é—®é‡éå¸¸å¤§ï¼Œæ­£åœ¨å¤„ç†è¿‡ç¨‹ä¸­ã€‚\n2ã€\nrandom_indexæ¨¡å—ï¼š\næŒ‡å®šç›®å½•ä¸­é€‰æ‹©ä¸€ä¸ªéšæœºä¸»é¡µã€‚\né…ç½®è¯­æ³•ï¼š\nSyntaxï¼šrandom_index on | off; Defaultï¼šrandom_index off;é»˜è®¤æ˜¯å…³é—­çš„ Contextï¼šlocation åœ¨locationä¸‹é…ç½® åœ¨é…ç½®æ–‡ä»¶default.confä¸­åŠ random_index on;å¹¶ä¿®æ”¹å¾ˆç›®å½•ä¸ºè‡ªå®šä¹‰çš„æŒ‡å®šç›®å½•ã€‚\nåœ¨æŒ‡å®šç›®å½•é‡Œæ”¾æ˜¾ç¤ºä¸‰ç§é¢œè‰²çš„htmlé¡µé¢ï¼š\nblack.html green.html red.html \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;/\u0026gt; \u0026lt;--- title\u0026gt;nginx-test\u0026lt;/--- title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body style=\u0026#34;background-color:red;\u0026#34;\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ç„¶åreload nginxæœåŠ¡ï¼š\nsystemctl reload nginx.service ç”¨æµè§ˆå™¨è®¿é—®éšç€åˆ·æ–°ä¼šæ˜¾ç¤ºä¸åŒé¢œè‰²çš„é¡µé¢ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œnginxæ˜¯ä¸ä¼šåŠ è½½æŒ‡å®šç›®å½•ä¸‹éšè—æ–‡ä»¶çš„.\n3ã€\nsub_moduleæ¨¡å—ï¼š\nä¸»è¦ç”¨äºHTTPå†…å®¹æ›¿æ¢ã€‚\nè¯­æ³•å¦‚ä¸‹ï¼š\n1ã€ Syntaxï¼šsub_filter old_string new_string; æŠŠold_stringæ›¿æ¢ä¸ºnew_string Defaultï¼šæ²¡æœ‰é…ç½® Contextï¼šhttpã€serverã€locationä¸‹é…ç½® æŠŠold_stringæ›¿æ¢ä¸ºnew_string 2ã€ Syntaxï¼šsub_filter_last_modified on|off; Defaultï¼šsub_filter_last_modified off; Contextï¼šhttpã€serverã€locationä¸‹é…ç½® è¡¨ç¤ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äº¤äº’æ—¶ï¼Œnginxæ ¡éªŒæœåŠ¡ç«¯å†…å®¹æ˜¯å¦æœ‰å˜æ›´ï¼Œä¸»è¦ç”¨äºç¼“å­˜åœºæ™¯ã€‚ 3ã€ Syntaxï¼šsub_filter_once on|off; Defaultï¼šsub_filter_once on; Contextï¼šhttpã€serverã€locationä¸‹é…ç½® è¡¨ç¤ºé»˜è®¤åŒ¹é…å­—ç¬¦ä¸²ä¸ªæ•°ï¼›é»˜è®¤çŠ¶æ€ä¸‹æ˜¯åŒ¹é…ç¬¬ä¸€ä¸ªã€‚ åœ¨æŒ‡å®šç›®å½•ä¸‹å»ºä¸€ä¸ªsubmodule.htmlæ–‡ä»¶ï¼š\n\u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;/\u0026gt; \u0026lt;--- title\u0026gt;nginx-test\u0026lt;/--- title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;smallsoup test tomcat test tomcat \u0026lt;/h2\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ç„¶ååœ¨default.confä¸­é…ç½®è¿™ä¸ªç›®å½•ä¸ºæ ¹ç›®å½•ï¼Œå¹¶é…ç½®sub_filterï¼š\nç”¨äºæŠŠhtmlä¸­çš„tomcatä¿®æ”¹ä¸ºnginxï¼Œreload nginxåå¯ä»¥çœ‹åˆ°é¡µé¢ï¼š\nä½†æ˜¯åªä¿®æ”¹äº†ç¬¬ä¸€ä¸ªtomcatï¼Œç¬¬äºŒä¸ªæ²¡æœ‰ä¿®æ”¹ï¼›å¦‚æœè¦å…¨éƒ¨æ›¿æ¢ï¼Œéœ€è¦é…ç½®ï¼š\nå¦‚æœé‡åˆ°é¡µé¢ä¸Šæ²¡æœ‰æ›¿æ¢çš„æƒ…å†µï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨ç¼“å­˜å¯¼è‡´ï¼Œéœ€è¦å¼ºåˆ¶åˆ·æ–°æˆ–è€…æ¸…ç†ç¼“å­˜ååˆ·æ–°ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/nginx%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%A8%A1%E5%9D%97/","section":"Posts","summary":"\u003cp\u003e\u003cem\u003e\u003cstrong\u003e1ã€\u003c/strong\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003estub_statusæ¨¡å—ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç”¨äºå±•ç¤ºnginxå¤„ç†è¿æ¥æ—¶çš„çŠ¶æ€ã€‚\u003c/p\u003e","title":"nginxå­¦ä¹ ä¹‹æ¨¡å—","type":"posts"},{"content":" ä¸­é—´ä»¶ä½äºå®¢æˆ·æœº/ æœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œç®¡ç†è®¡ç®—æœºèµ„æºå’Œç½‘ç»œé€šè®¯ã€‚ æ˜¯è¿æ¥ä¸¤ä¸ªç‹¬ç«‹åº”ç”¨ç¨‹åºæˆ–ç‹¬ç«‹ç³»ç»Ÿçš„è½¯ä»¶ã€‚\nwebè¯·æ±‚é€šè¿‡ä¸­é—´ä»¶å¯ä»¥ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥ç»è¿‡ä¸­é—´ä»¶æŠŠè¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªåº”ç”¨ä¸Šè¿›è¡Œé€»è¾‘å¤„ç†ã€‚\nå› ä¸ºæœ‰äº†ä¸­é—´ä»¶ï¼Œä½¿å¾—å¤§å‹ç½‘ç«™åœ¨è§„åˆ’æœ‰äº†æ›´å¥½çš„å±‚æ¬¡æ€§ï¼Œç»´æŠ¤ä¸Šæ›´åŠ æ–¹ä¾¿ã€‚ä¹Ÿå¯ä»¥å®ç°è´Ÿè½½å‡è¡¡ã€å®‰å…¨é˜²æŠ¤ç­‰ã€‚\nNginxæ˜¯ä¸€ä¸ªå¼€æºé«˜æ€§èƒ½ã€å¯é çš„HTTPä¸­é—´ä»¶ã€ä»£ç†æœåŠ¡ï¼Œåœ¨ç›®å‰ä¼ä¸šä¸­å¾—åˆ°äº†å¾ˆå¤§çš„åˆ©ç”¨ã€‚\nä»Šå¤©ä¸»è¦å­¦ä¹ ä¸‹nginxçš„å®‰è£…é…ç½®ï¼Œä»¥ä¾¿äºåç»­å­¦ä¹ ã€‚\nä»¥ä¸‹åœ¨æœ¬åœ°è™šæ‹Ÿæœºä¸Šæ­å»ºå­¦ä¹ ã€‚\nlinuxç¯å¢ƒæ­å»ºå¯ä»¥å‚è€ƒï¼š\nvmwareä¸Šå®‰è£…linuxè¿‡ç¨‹è®°å½•\n1ã€\næ£€æŸ¥ç³»ç»Ÿç½‘ç»œæ˜¯å¦èƒ½è¿é€šå…¬ç½‘ï¼š\nping www.taobao.com 2ã€\nç¡®è®¤yumæºæ˜¯å¦é…ç½®å¥½ï¼Œç”¨äºä¸‹è½½å®‰è£…ç¯å¢ƒåŸºç¡€åŒ…ï¼š\nyumæºé…ç½®å¯ä»¥å‚è€ƒï¼š\nyumæºé…ç½®\nç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯•ï¼š\n3ã€\nç¡®å®šiptablesæ˜¯å¦å…³é—­ï¼Œé¿å…å¯¹åç»­å­¦ä¹ éªŒè¯é€ æˆå½±å“ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è®¾ç½®å¥½å¯¹åº”è§„åˆ™ï¼š\næ‰§è¡Œå‘½ä»¤ï¼š\niptables -F iptables -t nat -F 4ã€\nç¡®è®¤å…³é—­selinuxï¼Œé¿å…å¯¹æœåŠ¡å’Œè¯·æ±‚é€ æˆå½±å“ï¼Œå»ºè®®å…³é—­ã€‚\næŸ¥çœ‹SELinuxçŠ¶æ€ï¼š\n/usr/sbin/sestatus -v ##å¦‚æœSELinux statuså‚æ•°ä¸ºenabledå³ä¸ºå¼€å¯çŠ¶æ€ SELinux status: enabled getenforce ##ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤æ£€æŸ¥ å…³é—­SELinuxï¼š\nä¸´æ—¶å…³é—­ï¼ˆä¸ç”¨é‡å¯æœºå™¨ï¼‰ï¼š\nsetenforce 0 ##è®¾ç½®SELinux æˆä¸ºpermissiveæ¨¡å¼ ##setenforce 1 è®¾ç½®SELinux æˆä¸ºenforcingæ¨¡å¼ ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆéœ€è¦é‡å¯æœºå™¨ï¼‰ï¼š\nä¿®æ”¹/etc/selinux/config æ–‡ä»¶ï¼Œå°†SELINUX=enforcingæ”¹ä¸ºSELINUX=disabled\n5ã€\né…ç½®nginxçš„yumæºï¼š\nvim /etc/yum.repos.d/nginx.repo [nginx] name=nginx repo baseurl=http://nginx.org/packages/centos/7/$basearch/ gpgcheck=0 enabled=1 6ã€\nç„¶åæ‰§è¡Œå‘½ä»¤æµ‹è¯•ï¼š\nyum list | grep nginx 7ã€\nåˆ©ç”¨yumå®‰è£…nginxï¼š\nyum install nginx å®‰è£…å®Œæ¯•éªŒè¯ï¼š\næˆ‘è¿™é‡Œè£…çš„æ˜¯1.14.0ç‰ˆã€‚\nå¯ä»¥ç”¨å‘½ä»¤æŸ¥çœ‹nginxå®‰è£…ç›®å½•ï¼š\nrpm -ql nginx 8ã€\nä¸‹é¢å¯¹ä¸»è¦ç›®å½•åšè¯´æ˜ï¼š\n/etc/logrotate.d/nginx Nginxæ—¥å¿—è½®è½¬ï¼Œç”¨äºlogrotateæœåŠ¡çš„æ—¥å¿—åˆ‡å‰²ï¼Œç›¸å½“äºjavaä¸­çš„log4jå’Œlogbackï¼›\n/etc/nginx /etc/nginx/conf.d /etc/nginx/conf.d/default.conf /etc/nginx/nginx.conf ä¸ºNginxä¸»é…ç½®æ–‡ä»¶ï¼›\n/etc/nginx/koi-utf /etc/nginx/koi-win /etc/nginx/win-utf ç”¨äºnginxç¼–ç è½¬æ¢çš„é…ç½®æ–‡ä»¶ï¼›\n/var/log/nginx ä¸ºnginxçš„è®¿é—®å’Œé”™è¯¯æ—¥å¿—ç›®å½•ï¼›\n/var/cache/nginx/ ä¸ºnginxçš„ç¼“å­˜ç›®å½•ï¼›\n/usr/share/nginx/html å…¶ä¸‹æ”¾äº†é¦–é¡µindex.htmlï¼Œä¸ºnginxçš„é»˜è®¤é¦–é¡µã€‚\n9ã€\nåˆ©ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨nginxï¼š\nsystemctl start nginx ç„¶åè®¿é—®é¡µé¢ï¼š\né»˜è®¤åˆ©ç”¨çš„æ˜¯/usr/share/nginx/htmlç›®å½•ä¸‹çš„index.html\nä¹‹åå°†å¯¹nginxåšè¿›ä¸€æ­¥æ·±å…¥å­¦ä¹ ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/nginx%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","section":"Posts","summary":"\u003cblockquote\u003e\n\u003cp\u003eä¸­é—´ä»¶ä½äºå®¢æˆ·æœº/ æœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œç®¡ç†è®¡ç®—æœºèµ„æºå’Œç½‘ç»œé€šè®¯ã€‚ æ˜¯è¿æ¥ä¸¤ä¸ªç‹¬ç«‹åº”ç”¨ç¨‹åºæˆ–ç‹¬ç«‹ç³»ç»Ÿçš„è½¯ä»¶ã€‚\u003c/p\u003e","title":"nginxå­¦ä¹ ç¬”è®°","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/elasticsearch/","section":"Tags","summary":"","title":"Elasticsearch","type":"tags"},{"content":"ä»¥ä¸‹æµ‹è¯•åœ¨elasticsearch5.6.10ç‰ˆæœ¬ã€‚\né¦–å…ˆè¦è¯´æ˜çš„æ˜¯ElasticSearchä»2.xå¼€å§‹å°±å·²ç»ä¸æ”¯æŒåˆ é™¤ä¸€ä¸ªtypeäº†ï¼Œæ‰€ä»¥ä½¿ç”¨deleteå‘½ä»¤æƒ³è¦å°è¯•åˆ é™¤ä¸€ä¸ªtypeçš„æ—¶å€™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š\nNo handler found for uri [/dating_profile/zhenai/] and method [DELETE] æµ‹è¯• # å‡å¦‚å­˜åœ¨ä¸€ä¸ªåä¸ºdating_profileçš„indexå’Œzhenaiçš„typeï¼š\ncurl -XDELETE http://192.168.1.102:9200/dating_profile/zhenai æ‰§è¡ŒåæŠ¥é”™å¦‚ä¸‹ï¼š\næ‰€ä»¥ç°åœ¨å¦‚æœæƒ³è¦åˆ é™¤typeæœ‰ä¸¤ç§é€‰æ‹©ï¼š\n***1ã€***é‡æ–°è®¾ç½®indexã€‚\n***2ã€***åˆ é™¤typeä¸‹çš„æ‰€æœ‰æ•°æ®ã€‚\nå¦‚æœé‡æ–°è®¾ç½®indexï¼Œå®˜æ–¹å»ºè®®ï¼š\nhttps://www.elastic.co/guide/en/elasticsearch/reference/5.4/indices-delete-mapping.html\nDelete Mapping\nIt is no longer possible to delete the mapping for a type. Instead you should delete the index and recreate it with the new mappings.\nåˆ é™¤index # å¦‚ä¸‹ï¼Œåˆ é™¤åä¸ºdating_profileçš„indexï¼š\ncurl -XDELETE http://192.168.1.102:9200/dating_profile/ åˆ é™¤æˆåŠŸï¼Œè¿”å›å€¼ä¸ºï¼š\n{ \u0026#34;acknowledged\u0026#34;: true } åˆ é™¤typeä¸‹çš„æ‰€æœ‰æ•°æ® # æƒ³è¦ä¸€æ¬¡æ€§åˆ é™¤typeä¸ºzhenaiæ‰€æœ‰æ•°æ®å†…å®¹çš„è¯ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š\nhttps://www.elastic.co/guide/en/elasticsearch/reference/5.4/docs-delete-by-query.html\nå…¶ä¸­æœ‰è®²åˆ°ï¼Œå¯ä»¥é€šè¿‡_delete_by_queryé™åˆ¶åˆ°ä¸€ä¸ªå•ç‹¬çš„typeï¼Œå¦‚ä¸‹ï¼Œå®ƒä»…ä»…ä¼šåˆ é™¤indexä¸ºdating_profileä¸‹typeä¸ºzhenaiä¸‹çš„æ‰€æœ‰æ•°æ®ï¼š\ncurl -X POST \u0026#34;http://192.168.1.102:9200/dating_profile/zhenai/_delete_by_query?conflicts=proceed\u0026#34; -H \u0026#39;Content-Type: application/json\u0026#39; -d\u0026#39; { \u0026#34;query\u0026#34;: { \u0026#34;match_all\u0026#34;: {} } }\u0026#39; åˆ é™¤æˆåŠŸï¼Œè¿”å›å€¼å¦‚ä¸‹ï¼š\n{ \u0026#34;took\u0026#34;: 78, \u0026#34;timed_out\u0026#34;: false, \u0026#34;total\u0026#34;: 107, \u0026#34;deleted\u0026#34;: 107, \u0026#34;batches\u0026#34;: 1, \u0026#34;version_conflicts\u0026#34;: 0, \u0026#34;noops\u0026#34;: 0, \u0026#34;retries\u0026#34;: { \u0026#34;bulk\u0026#34;: 0, \u0026#34;search\u0026#34;: 0 }, \u0026#34;throttled_millis\u0026#34;: 0, \u0026#34;requests_per_second\u0026#34;: -1.0, \u0026#34;throttled_until_millis\u0026#34;: 0, \u0026#34;failures\u0026#34;: [] } ä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§åˆ é™¤å¤šä¸ªindexå’Œå¤šä¸ªtypeä¸‹çš„æ–‡æ¡£ï¼Œå¦‚ä¸‹ï¼šåˆ é™¤indexä¸ºdating_profileä¸‹çš„typeä¸ºzhenaiçš„æ•°æ®ï¼›åŒæ—¶åˆ é™¤indexä¸ºmoviesä¸‹çš„typeä¸ºmovieçš„æ•°æ®ã€‚\ncurl -X POST \u0026#34;http://192.168.1.102:9200/dating_profile,movies/zhenai,movie/_delete_by_query\u0026#34; -H \u0026#39;Content-Type: application/json\u0026#39; -d\u0026#39; { \u0026#34;query\u0026#34;: { \u0026#34;match_all\u0026#34;: {} } } \u0026#39; è¿”å›å€¼å¦‚ä¸‹ï¼š\n{ \u0026#34;took\u0026#34;: 93, \u0026#34;timed_out\u0026#34;: false, \u0026#34;total\u0026#34;: 61, \u0026#34;deleted\u0026#34;: 61, \u0026#34;batches\u0026#34;: 1, \u0026#34;version_conflicts\u0026#34;: 0, \u0026#34;noops\u0026#34;: 0, \u0026#34;retries\u0026#34;: { \u0026#34;bulk\u0026#34;: 0, \u0026#34;search\u0026#34;: 0 }, \u0026#34;throttled_millis\u0026#34;: 0, \u0026#34;requests_per_second\u0026#34;: -1.0, \u0026#34;throttled_until_millis\u0026#34;: 0, \u0026#34;failures\u0026#34;: [] } é¢˜å¤–è¯ # 5.xESæä¾›çš„Reindexå¯ä»¥ç›´æ¥åœ¨æœç´¢é›†ç¾¤ä¸­å¯¹æ•°æ®è¿›è¡Œé‡å»ºã€‚å¦‚ä¸‹å¯ä»¥ç›´æ¥ä¿®æ”¹mappingã€‚\nå¦‚ä¸‹å°†indexä¸ºdating_profileæ”¹ä¸ºnew_dating_profile\ncurl -XPOST \u0026#34;http://192.168.1.102:9200/_reindex?pretty\u0026#34; -H \u0026#39;Content-Type: application/json\u0026#39; -d\u0026#39; { \u0026#34;source\u0026#34;: { \u0026#34;index\u0026#34;: \u0026#34;dating_profile\u0026#34; }, \u0026#34;dest\u0026#34;: { \u0026#34;index\u0026#34;: \u0026#34;new_dating_profile\u0026#34; } } \u0026#39; è¿™æ ·æ‰§è¡Œåï¼Œæ—§çš„indexè¿˜æ˜¯å­˜åœ¨çš„ï¼Œdating_profileå’Œnew_dating_profileéƒ½å¯ä»¥æŸ¥åˆ°æ—§æ•°æ®ã€‚\nElasticSearchï¼‹ELKæ—¥å¿—å¹³å°å…¨å¥—è§†é¢‘æ•™ç¨‹ç­‰ç›¸å…³å­¦ä¹ èµ„æºå¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤ã€1ã€‘åŠ å°åŠ©æ‰‹ç´¢å–ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/elasticsearch5.x%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE/","section":"Posts","summary":"\u003cp\u003eä»¥ä¸‹æµ‹è¯•åœ¨elasticsearch5.6.10ç‰ˆæœ¬ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆè¦è¯´æ˜çš„æ˜¯ElasticSearchä»2.xå¼€å§‹å°±å·²ç»ä¸æ”¯æŒåˆ é™¤ä¸€ä¸ªtypeäº†ï¼Œæ‰€ä»¥ä½¿ç”¨deleteå‘½ä»¤æƒ³è¦å°è¯•åˆ é™¤ä¸€ä¸ªtypeçš„æ—¶å€™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š\u003c/p\u003e","title":"ElasticSearch5.x åˆ é™¤æ•°æ®","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/golang/","section":"Tags","summary":"","title":"Golang","type":"tags"},{"content":"å‰æ®µæ—¶é—´æœ‰ç¾¤å‹åœ¨ç¾¤é‡Œé—®ä¸€ä¸ªgoè¯­è¨€çš„é—®é¢˜ï¼š\nå°±æ˜¯æœ‰ä¸€ä¸ªmain.goçš„mainå‡½æ•°é‡Œè°ƒç”¨äº†å¦ä¸€ä¸ªdemo.goé‡Œçš„hello()å‡½æ•°ã€‚å…¶ä¸­main.goå’Œhello.goåŒå±äºmainåŒ…ã€‚ä½†æ˜¯åœ¨main.goçš„ç›®å½•ä¸‹æ‰§è¡Œgo run main.goå´æŠ¥helloå‡½æ•°æ²¡æœ‰å®šä¹‰çš„é”™ï¼š\nä»£ç ç»“æ„å¦‚ä¸‹ï¼š\n**gopath ---- src** **----gohello** **----hello.go** ** ----main.go** main.goå¦‚ä¸‹ï¼š\npackage main import \u0026#34;fmt\u0026#34; func main() { fmt.Println(\u0026#34;my name is main\u0026#34;) hello() } hello.goå¦‚ä¸‹ï¼š\npackage main import \u0026#34;fmt\u0026#34; func hello() { fmt.Println(\u0026#34;my name is hello\u0026#34;) } å½“æ—¶æˆ‘çœ‹äº†ä»¥ä¸ºæ˜¯ä»–GOPATHé…ç½®çš„æœ‰é—®é¢˜ï¼Œç„¶åè‡ªå·±ä¹ŸæŒ‰ç…§è¿™æ ·è¯•äº†ä¸€ä¸‹ï¼ŒæŠ¥åŒæ ·çš„é”™ï¼Œåœ¨ç½‘ä¸ŠæŸ¥äº†ï¼Œä¹Ÿæœ‰ä¸¤ç¯‡æ–‡ç« æ˜¯å…³äºè¿™ä¸ªé”™çš„ï¼Œä¹Ÿæä¾›äº†è§£å†³æ–¹æ³•ï¼Œå³ç”¨go run main.go hello.goï¼Œè¯•äº†ç¡®å®æ˜¯å¯ä»¥çš„ã€‚\nè™½ç„¶æ˜¯ä¸ªå¾ˆç®€å•çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿæ¶‰åŠåˆ°äº†goè¯­è¨€åº•å±‚å¯¹äºå‘½ä»¤è¡Œå‚æ•°çš„è§£æã€‚é‚£å°±æ¥åˆ†æä¸€ä¸‹è¯­è¨€åº•å±‚çš„å®ç°å§ï¼Œçœ‹ä¸€ä¸‹åº•å±‚åšäº†ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆæŠ¥è¿™ä¸ªé”™ï¼Ÿ\nåˆ†æï¼š\nä»¥ä¸‹ä½¿ç”¨åˆ°çš„Go SDKç‰ˆæœ¬ä¸º1.8.3\nè¯¥ç‰ˆæœ¬ä¸­goæ”¯æŒçš„åŸºæœ¬å‘½ä»¤æœ‰ä»¥ä¸‹16ä¸ªï¼š\nbuild compile packages and dependencies clean remove object files doc show documentation for package or symbol env print Go environment information bug start a bug report fix run go tool fix on packages fmt run gofmt on package sources generate generate Go files by processing source get download and install packages and dependencies install compile and install packages and dependencies list list packages run compile and run Go program test test packages tool run specified go tool version print Go version vet run go tool vet on packages åœ¨Go SDKçš„src/cmd/goåŒ…ä¸‹æœ‰main.goæ–‡ä»¶ä¸­ï¼ŒCommandç±»å‹çš„commandsæ•°ç»„å¯¹è¯¥16ä¸ªå‘½ä»¤æä¾›äº†æ”¯æŒï¼š\næˆ‘ä»¬é¦–å…ˆçŸ¥é“goè¯­è¨€çš„åˆå§‹åŒ–æµç¨‹å¦‚ä¸‹ï¼š\nåœ¨æ‰§è¡Œmain.goä¸­çš„ä¸»å‡½æ•°mainä¹‹å‰ï¼Œå¯¹importè¿›æ¥çš„åŒ…æŒ‰é¡ºåºåˆå§‹åŒ–ï¼Œæœ€ååˆå§‹åŒ–main.goä¸­çš„ç±»å‹å’Œå˜é‡ï¼Œå½“åˆå§‹åŒ–åˆ°commandsæ•°ç»„æ—¶ï¼Œç”±äºcmdRunå®šä¹‰åœ¨äºmain.goåŒåŒ…ä¸‹çš„run.goä¸­ï¼Œé‚£ä¹ˆå°±å…ˆå»åˆå§‹åŒ–run.goä¸­çš„å˜é‡å’Œinitæ–¹æ³•ï¼Œå¦‚ä¸‹ä»£ç ï¼Œå…ˆæŠŠcmdRunåˆå§‹åŒ–ä¸ºCommandç±»å‹ï¼Œç„¶åæ‰§è¡Œinit()å‡½æ•°ã€‚\nvar cmdRun = \u0026amp;Command{ UsageLine: \u0026#34;run [build flags] [-exec xprog] gofiles... [arguments...]\u0026#34;, Short: \u0026#34;compile and run Go program\u0026#34;, Long: ` Run compiles and runs the main package comprising the named Go source files. A Go source file is defined to be a file ending in a literal \u0026#34;.go\u0026#34; suffix. By default, \u0026#39;go run\u0026#39; runs the compiled binary directly: \u0026#39;a.out arguments...\u0026#39;. If the -exec flag is given, \u0026#39;go run\u0026#39; invokes the binary using xprog: \u0026#39;xprog a.out arguments...\u0026#39;. If the -exec flag is not given, GOOS or GOARCH is different from the system default, and a program named go_$GOOS_$GOARCH_exec can be found on the current search path, \u0026#39;go run\u0026#39; invokes the binary using that program, for example \u0026#39;go_nacl_386_exec a.out arguments...\u0026#39;. This allows execution of cross-compiled programs when a simulator or other execution method is available. For more about build flags, see \u0026#39;go help build\u0026#39;. See also: go build. `, } func init() { cmdRun.Run = runRun // break init loop addBuildFlags(cmdRun) cmdRun.Flag.Var((*stringsFlag)(\u0026amp;execCmd), \u0026#34;exec\u0026#34;, \u0026#34;\u0026#34;) } init()ä¸­ï¼Œå°†runRunï¼ˆå…¶å®ç±»å‹æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå¤„ç†runåçš„å‚æ•°ï¼‰èµ‹å€¼ç»™cmdRu.runï¼ŒaddBuildFlags(cmdRun)ä¸»è¦æ˜¯ç»™runåé¢å¢åŠ å‘½ä»¤è¡Œå‚æ•°ï¼ˆå¦‚ï¼š-xæ˜¯æ‰“å°å…¶æ‰§è¡Œè¿‡ç¨‹ä¸­ç”¨åˆ°çš„æ‰€æœ‰å‘½ä»¤ï¼ŒåŒæ—¶æ‰§è¡Œå®ƒä»¬ï¼‰ã€‚å…¶ä»–15ä¸ªå‘½ä»¤å’ŒcmdRunç±»ä¼¼ï¼Œå„æœ‰å„çš„runå®ç°ã€‚\nä¸‹æ¥ä¸»è¦çœ‹main.goä¸­mainçš„è¿™å—ä»£ç ï¼š\nfor _, cmd := range commands { if cmd.Name() == args[0] \u0026amp;\u0026amp; cmd.Runnable() { cmd.Flag.Usage = func() { cmd.Usage() } if cmd.CustomFlags { args = args[1:] } else { cmd.Flag.Parse(args[1:]) args = cmd.Flag.Args() } cmd.Run(cmd, args) exit() return } } è¿™å—ä»£ç éå†commandsæ•°ç»„ï¼Œå½“éå†åˆ°cmdRunæ—¶ï¼Œcmd.Name()å…¶å®å°±æ˜¯æ‹¿åˆ°cmdRun.UsageLineçš„ç¬¬ä¸€ä¸ªå•è¯run\nå°±ä¼šè¿›å…¥ifåˆ†æ”¯ï¼Œç”±äºcmd.CustomFlagsæ²¡æœ‰åˆå§‹åŒ–æ•…ä¸ºfalseï¼Œèµ°elseåˆ†æ”¯ï¼Œç„¶åå¼€å§‹è§£æargså‘½ä»¤è¡Œå‚æ•°ï¼Œargs[1:]å³å–runåçš„æ‰€æœ‰å‚æ•°ã€‚ç„¶åå»æ‰§è¡Œcmd.Run(cmd, args)ï¼Œå¯¹äºcmdRunæ¥è¯´ï¼Œè¿™é‡Œæ‰§è¡Œçš„å°±æ˜¯run.goä¸­init()çš„ç¬¬ä¸€è¡Œèµ‹å€¼cmdRun.runï¼ˆä¸Šé¢è¯´äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¸åŒå‘½ä»¤å®ç°æ–¹å¼ä¸åŒ)ï¼Œå³å»æ‰§è¡Œrun.goä¸­çš„runRunå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯å°†å‘½ä»¤è¡Œå‚æ•°å½“æ–‡ä»¶å»å¤„ç†ï¼Œå¦‚æœæ˜¯_testä¸ºåç¼€çš„ï¼Œå³æµ‹è¯•æ–‡ä»¶ï¼Œç›´æ¥æŠ¥é”™ã€‚å¦‚æœæ˜¯ç›®å½•ä¹Ÿç›´æ¥æŠ¥é”™ï¼ˆè€Œä¸”go runåé¢åªèƒ½åŒ…å«ä¸€ä¸ªå«mainå‡½æ•°çš„goæ–‡ä»¶ï¼‰ã€‚æ³¨æ„åˆ°æœ‰è¿™ä¹ˆä¸€è¡Œï¼š\np := goFilesPackage(files) goFilesPackage(files)é™¤äº†æ ¡éªŒæ–‡ä»¶ç±»å‹å’Œåç¼€ï¼Œè¿˜ä¼šå…¥æ ˆï¼ŒåŠ è½½ï¼Œå‡ºæ ˆç­‰æ“ä½œï¼Œç”±äºå¯åŠ¨çš„æ—¶å€™æ²¡æœ‰ä¼ é€’hello.goï¼Œæ‰€ä»¥ç³»ç»ŸåŠ è½½main.goæ—¶æ‰¾ä¸åˆ°helloå‡½æ•°ï¼Œå¯¼è‡´æŠ¥é”™ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/golang%E5%88%9D%E6%8E%A2%E4%B8%8E%E5%91%BD%E4%BB%A4%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","section":"Posts","summary":"\u003cp\u003eå‰æ®µæ—¶é—´æœ‰ç¾¤å‹åœ¨ç¾¤é‡Œé—®ä¸€ä¸ªgoè¯­è¨€çš„é—®é¢˜ï¼š\u003c/p\u003e\n\u003cp\u003eå°±æ˜¯æœ‰ä¸€ä¸ªmain.goçš„mainå‡½æ•°é‡Œè°ƒç”¨äº†å¦ä¸€ä¸ªdemo.goé‡Œçš„hello()å‡½æ•°ã€‚å…¶ä¸­main.goå’Œhello.goåŒå±äºmainåŒ…ã€‚ä½†æ˜¯åœ¨main.goçš„ç›®å½•ä¸‹æ‰§è¡Œgo run main.goå´æŠ¥helloå‡½æ•°æ²¡æœ‰å®šä¹‰çš„é”™ï¼š\u003c/p\u003e","title":"golangåˆæ¢ä¸å‘½ä»¤æºç åˆ†æ","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/docker/","section":"Tags","summary":"","title":"Docker","type":"tags"},{"content":"å…¬æœ‰ä»“åº“å’Œç§æœ‰ä»“åº“ï¼š\n**é€Ÿåº¦ï¼š**å…¬æœ‰ä»“åº“èµ°çš„å…¬ç½‘ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼›ç§æœ‰ä»“åº“èµ°çš„æ˜¯å†…ç½‘ï¼Œå³å±€åŸŸç½‘ï¼›\n**å®‰å…¨æ€§ï¼š**å…¬æœ‰ä»“åº“å­˜æ”¾åœ¨å…¬å…±ç¡¬ç›˜ä¸Šï¼›ç§æœ‰ä»“åº“å­˜åœ¨è‡ªå·±æœåŠ¡å™¨ç¡¬ç›˜ä¸Šã€‚\nå…¬æœ‰ä»“ï¼š\næœ€æƒå¨çš„ï¼Œä½†é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼š\nhttps://hub.docker.com/\né¦–å…ˆç™»é™†ï¼š\n$ docker login -usmallsoup Password: WARNING! Your password will be stored unencrypted in /root/.docker/config.json. Configure a credential helper to remove this warning. See https://docs.docker.com/engine/reference/commandline/login/#credentials-store Login Succeeded æ‰“æ ‡ç­¾ï¼Œpushé•œåƒåˆ°hubä»“åº“ï¼š\ndocker tag zookeeper:3.5 smallsoup/zookeeper:3.5 docker push smallsoup/zookeeper:3.5 å·²pushæˆåŠŸï¼Œå¯ä»¥åœ¨hubä¸Šçœ‹åˆ°ï¼š\nç§æœ‰ä»“ï¼š\nç”¨dockeræä¾›çš„registryåœ¨æœ¬åœ°æ­å»ºç§æœ‰ä»“ï¼š\ndocker pull registry:2.5.2 docker run -d -p 5000:5000 registry:2.5.2 docker tag zookeeper:3.5 localhost:5000/zookeeper:3.5 docker push zookeeper:3.5 localhost:5000/zookeeper:3.5 å› æ²¡æœ‰è®¾ç½®å®‰å…¨æ€§ï¼Œæ‰€ä»¥ç›´æ¥å¯ä»¥pushä¸Šå»ã€‚\nç”±äºæ˜¯æœ¬åœ°ä»“åº“ï¼Œæ‰€ä»¥pullçš„é€Ÿåº¦å¾ˆå¿«ã€‚\n[root@localhost micro-service]# docker pull localhost:5000/zookeeper:3.5 3.5: Pulling from zookeeper Digest: sha256:3474ec46da9db9dc27a431f9645a2df9c91d5b969f591fe0ccd4c40f2bfd1579 Status: Image is up to date for localhost:5000/zookeeper:3.5 ä½†æ˜¯è¿™ä¸ªç§æœ‰ä»“ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œç”Ÿäº§çº¿ä¸Šä¸‡ä¸€è¯¥ç§æœ‰ä»“æœåŠ¡å™¨æ•…éšœï¼Œå…¶ä»–æœåŠ¡å™¨ä¹Ÿæ— æ³•æ¥ç®¡ã€‚å†è€…ï¼Œä¹Ÿæ²¡æœ‰é¡µé¢å¯ä»¥ä¾¿äºç®¡ç†ã€‚\nä¸šå†…å‡ºç°çš„harborï¼Œä¸»è¦æä¾› Dcoker Registry ç®¡ç†UIï¼Œå¯åŸºäºè§’è‰²è®¿é—®æ§åˆ¶, AD/LDAP é›†æˆï¼Œæ—¥å¿—å®¡æ ¸ç­‰åŠŸèƒ½ï¼Œå®Œå…¨çš„æ”¯æŒä¸­æ–‡ï¼Œéå¸¸é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚\nharborç§æœ‰ä»“åº“æ­å»º\ngithubåœ°å€ï¼š\nhttps://github.com/goharbor/harbor/releases\nä¸‹è½½åœ°å€ï¼š\nhttps://storage.googleapis.com/harbor-releases/harbor-offline-installer-v1.5.3.tgz\nè¿™ä¸ªé“¾æ¥é€Ÿåº¦å¤ªæ…¢ï¼Œå¯ä»¥åœ¨è¿™é‡Œä¸‹è½½ï¼š\nhttp://harbor.orientsoft.cn/\nä»¥ä¸‹ä½¿ç”¨çš„harborç‰ˆæœ¬æ˜¯harbor-offline-installer-v1.5.0.tgz\né¦–å…ˆè§£å‹ï¼š\ntar -zxf harbor-offline-installer-v1.5.0.tgz ç„¶åè¿è¡Œ./installè„šæœ¬è¿›è¡Œå®‰è£…ï¼Œå¦‚æœéœ€è¦ç‰¹æ®Šè®¾ç½®ï¼Œå¯ä»¥å…ˆä¿®æ”¹harbor.cfgå’Œdocker-compose.ymlååœ¨è¿›è¡Œ./installå®‰è£…æ“ä½œ\n[Step 4]: starting Harbor ... Creating network \u0026#34;harbor_harbor\u0026#34; with the default driver Creating harbor-log ... done Creating harbor-adminserver ... Creating redis ... error Creating harbor-db ... Creating registry ... Creating harbor-adminserver ... done ERROR: for redis Cannot create container for service redis: b\u0026#39;Conflict. The container name \u0026#34;/redis\u0026#34; is already in use Creating harbor-db ... done Creating registry ... done Creating harbor-ui ... done Creating nginx ... done ERROR: for redis Cannot create container for service redis: b\u0026#39;Conflict. The container name \u0026#34;/redis\u0026#34; is already in use by container \u0026#34;c3813d66ccad284d3529227fabf3d5c19cb991237de8d3e72fc470ffd2cbfa99\u0026#34;. You have to remove (or rename) that container to be able to reuse that name.\u0026#39; ERROR: Encountered errors while bringing up the project. å®‰è£…è¿‡ç¨‹ä¸­æŠ¥ä»¥ä¸Šé”™è¯¯ï¼Œæ˜¯å› ä¸ºæœåŠ¡å™¨ä¸Šå·²ç»æœ‰äº†åä¸ºredisçš„å®¹å™¨åï¼Œå’Œharborå°†è¦å®‰è£…çš„rediså®¹å™¨åé‡åï¼Œéœ€è¦renameæœåŠ¡å™¨ä¸Šå·²æœ‰çš„rediså®¹å™¨åä¸ºmicro-service-redisï¼š\n$ docker ps -a --filter name=redis CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES c3813d66ccad hub.c.163.com/public/redis:2.8.4 \u0026#34;/run.sh\u0026#34; 2 days ago Up 42 hours 0.0.0.0:6379-\u0026gt;6379/tcp redis $ docker rename redis micro-service-redis $ docker ps -aq --filter name=redis c3813d66ccad $ docker ps -a --filter name=redis CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES c3813d66ccad hub.c.163.com/public/redis:2.8.4 \u0026#34;/run.sh\u0026#34; 2 days ago Up 42 hours 0.0.0.0:6379-\u0026gt;6379/tcp micro-service-redis ç„¶åé‡æ–°æ‰§è¡Œ./install\n[Step 4]: starting Harbor ... Creating network \u0026#34;harbor_harbor\u0026#34; with the default driver Creating harbor-log ... done Creating redis ... done Creating harbor-db ... done Creating harbor-adminserver ... done Creating registry ... done Creating harbor-ui ... done Creating harbor-jobservice ... Creating nginx ... ERROR: for harbor-jobservice UnixHTTPConnectionPool(host=\u0026#39;localhost\u0026#39;, port=None): Read timed out. (read timeout=60) ERROR: for nginx UnixHTTPConnectionPool(host=\u0026#39;localhost\u0026#39;, port=None): Read timed out. (read timeout=60) ERROR: for jobservice UnixHTTPConnectionPool(host=\u0026#39;localhost\u0026#39;, port=None): Read timed out. (read timeout=60) ERROR: for proxy UnixHTTPConnectionPool(host=\u0026#39;localhost\u0026#39;, port=None): Read timed out. (read timeout=60) ERROR: An HTTP request took too long to complete. Retry with --verbose to obtain debug information. If you encounter this issue regularly because of slow network conditions, consider setting COMPOSE_HTTP_TIMEOUT to a hig åˆæŠ¥ä»¥ä¸Šçš„é”™ï¼Œå¯èƒ½æ˜¯ç”±äºç½‘ç»œé—®é¢˜ï¼Œå¯¼è‡´å¤±è´¥ï¼Œé‡æ–°./installè¯•è¯•ï¼š\n[Step 4]: starting Harbor ... Creating network \u0026#34;harbor_harbor\u0026#34; with the default driver Creating harbor-log ... done Creating redis ... done Creating harbor-db ... done Creating harbor-adminserver ... done Creating registry ... done Creating harbor-ui ... done Creating nginx ... done Creating harbor-jobservice ... done âœ” ----Harbor has been installed and started successfully.---- Now you should be able to visit the admin portal at http://hub.smallsoup.com. For more details, please visit https://github.com/vmware/harbor . æˆåŠŸäº†ã€‚\nå¯ä»¥è®¿é—®harboréƒ¨ç½²æœåŠ¡å™¨IP:docker-compose.ymlä¸­80æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šçš„ç«¯å£ï¼›\nç”¨æˆ·åæ˜¯adminï¼Œå¯†ç æ˜¯harbor.cfgä¸­harbor_admin_passwordçš„å€¼è®¿é—®ç®¡ç†é¡µé¢ï¼š\nå¯ä»¥åˆ›å»ºä¸€ä¸ªç§æœ‰ä»“åº“micro-serviceï¼š\nåœ¨ç³»ç»Ÿç®¡ç†-\u0026gt;ç”¨æˆ·ç®¡ç†ä¸­æ·»åŠ ç”¨æˆ·ï¼Œç„¶åç‚¹å¼€ä¸Šä¸€æ­¥åˆ›å»ºçš„é¡¹ç›®\u0026ndash;\u0026raquo;æˆå‘˜\u0026ndash;\u0026raquo;æ–°å»ºæˆå‘˜ï¼Œå¹¶è®¾ç½®æƒé™ã€‚\né¡¹ç›®ç®¡ç†å‘˜ï¼šæœ‰pullå’Œpushä»¥åŠé¡¹ç›®å…¶ä»–ç®¡ç†æƒé™ï¼›\nå¼€å‘äººå‘˜ï¼šæœ‰pullå’Œpushæƒé™ï¼›\nè®¿å®¢ï¼šåªæœ‰pullæƒé™ã€‚\nè®¿å®¢ï¼šåªæœ‰pul\nå°†è¯¥é¡¹ç›®çš„å„ä¸ªå¾®æœåŠ¡image pushåˆ°harborçš„micro-serviceé¡¹ç›®é‡Œï¼š\n$ docker images |grep -v \u0026#34;vmware\u0026#34; REPOSITORY TAG IMAGE ID CREATED SIZE api-gateway-zuul latest 8a814cf9bb65 23 hours ago 476MB course-service latest 673d4501353e 23 hours ago 462MB course-edge-service latest 854d5d8bddaa 23 hours ago 484MB message-thrift-python-service latest 4317a76b387e 24 hours ago 926MB user-edge-service latest ff07d54a02ba 25 hours ago 469MB user-thrift-service latest 02dd6fd0f239 26 hours ago 456MB python-base latest 81ad8926a9d9 26 hours ago 926MB zookeeper 3.5 c41e1dcd86e4 2 weeks ago 128MB smallsoup/zookeeper 3.5 c41e1dcd86e4 2 weeks ago 128MB localhost:5000/zookeeper 3.5 c41e1dcd86e4 2 weeks ago 128MB elasticsearch latest 5acf0e8da90b 2 weeks ago 486MB registry 2.5.2 96ca477b7e56 3 weeks ago 37.8MB registry 2 2e2f252f3c88 3 weeks ago 33.3MB python 3.6 4f13b7f2138e 4 weeks ago 918MB openjdk 8-jre 66bf39162ea7 4 weeks ago 443MB mysql latest 6a834f03bd02 4 weeks ago 484MB hub.c.163.com/public/redis 2.8.4 4888527e1254 2 years ago 190MB æ‰“æ ‡ç­¾ï¼š\ndocker tag openjdk:8-jre 192.168.1.103:80/micro-service/openjdk:8-jre æŸ¥çœ‹é•œåƒï¼š\n$ docker images |grep -v \u0026#34;vmware\u0026#34; | grep open openjdk 7-jre e4c851ec3393 4 weeks ago 329MB 192.168.1.103:80/micro-service/openjdk 8-jre 66bf39162ea7 4 weeks ago 443MB openjdk pushé•œåƒï¼š\n$ docker push 192.168.1.103:80/micro-service/openjdk:8-jre The push refers to repository [192.168.1.103:80/micro-service/openjdk] Get https://192.168.1.103:80/v2/: http: server gave HTTP response to HTTPS client pushæŠ¥é”™ã€‚ç”±äºé»˜è®¤é‡‡ç”¨çš„æ˜¯httpåè®®ï¼Œå³harbor.cfgä¸­çš„ui_url_protocolå€¼ã€‚httpsçš„æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦ç”Ÿæˆè¯ä¹¦ç­‰æ­¥éª¤ï¼Œå¯ä»¥å‚è€ƒï¼š\nä¸ºHarborè®¾ç½®Https\nhttp://gapme.cn/2017/10/25/harbor-ui-https/\nè¿™é‡Œæš‚ä¸”ç”¨httpçš„æ–¹å¼ã€‚\nä»¥ä¸ŠæŠ¥é”™è§£å†³åŠæ³•ï¼š\nåœ¨â€/etc/docker/â€œç›®å½•ä¸‹ï¼Œåˆ›å»ºâ€daemon.jsonâ€œæ–‡ä»¶ã€‚åœ¨æ–‡ä»¶ä¸­å†™å…¥ï¼š\n{ \u0026#34;insecure-registries\u0026#34;: [ \u0026#34;hub.smallsoup.com:80\u0026#34;, \u0026#34;192.168.1.103:80\u0026#34; ] } é‡å¯dockerï¼š\nsystemctl restart docker dockeré‡å¯åï¼Œ./installæˆ–è€…docker-compose down;docker-compose up -dé‡å¯harborå³å¯ã€‚\nå°†åŸºç¡€é•œåƒå’Œå„ä¸ªæœåŠ¡é•œåƒpushåˆ°åº“ä¸Šï¼š\né¢˜å¤–è¯ï¼š\nåœ¨å®‰è£…è¿‡ç¨‹ä¸­ï¼Œå°†80ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„8081ç«¯å£ï¼Œpushçš„æ—¶å€™é‡åˆ°å¾ˆå¤šé—®é¢˜ï¼ˆæŠ¥é”™80ç«¯å£è¿æ¥æ‹’ç»ï¼Œå¤§æ¦‚å°±æ˜¯è¿™ä¸ªissue\nhttps://github.com/goharbor/harbor/issues/192ï¼‰ï¼ŒæŸ¥æ‰¾äº†å¾ˆå¤šèµ„æ–™ï¼Œè¿˜æ˜¯æ”¾å¼ƒäº†ï¼Œæœ€åæ˜ å°„åˆ°å®¿ä¸»æœº80ç«¯å£ï¼Œpushä¸€åˆ‡okã€‚\nç”±äºç”¨åŸŸåçš„æ–¹å¼pushå¾—è®¾ç½®hostsä»¥åŠç«¯å£è½¬å‘ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œä»¥ä¸Šé‡‡ç”¨äº†IP:PORTæ–¹å¼ï¼š\nåˆ é™¤ç”¨åŸŸåæ‰“çš„æ ‡ç­¾ï¼š\ndocker rmi -f hub.smallsoup.com:80/micro-service/openjdk:8-jre harborä¹Ÿå¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤ã€2ã€‘åŠ å°ç¼–å¾®ä¿¡ç´¢å–ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E6%90%AD%E5%BB%BA%E4%B8%AA%E7%A7%81%E6%9C%89docker%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93/","section":"Posts","summary":"\u003cp\u003e\u003cstrong\u003eå…¬æœ‰ä»“åº“å’Œç§æœ‰ä»“åº“ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e**é€Ÿåº¦ï¼š**å…¬æœ‰ä»“åº“èµ°çš„å…¬ç½‘ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼›ç§æœ‰ä»“åº“èµ°çš„æ˜¯å†…ç½‘ï¼Œå³å±€åŸŸç½‘ï¼›\u003c/p\u003e","title":"æ­å»ºä¸ªç§æœ‰dockeré•œåƒä»“åº“","type":"posts"},{"content":"Kubernetes å®¡è®¡åŠŸèƒ½æä¾›äº†ä¸å®‰å…¨ç›¸å…³çš„æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„è®°å½•é›†ï¼Œè®°å½•å•ä¸ªç”¨æˆ·ã€ç®¡ç†å‘˜æˆ–ç³»ç»Ÿå…¶ä»–ç»„ä»¶å½±å“ç³»ç»Ÿçš„æ´»åŠ¨é¡ºåºã€‚å®ƒèƒ½å¸®åŠ©é›†ç¾¤ç®¡ç†å‘˜å¤„ç†ä»¥ä¸‹é—®é¢˜ï¼š\nå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ\nä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„ï¼Ÿ\nè°è§¦å‘çš„ï¼Ÿ\nä¸ºä»€ä¹ˆå‘ç”Ÿï¼Ÿ\nåœ¨å“ªè§‚å¯Ÿåˆ°çš„ï¼Ÿ\nå®ƒä»å“ªè§¦å‘çš„ï¼Ÿ\nå®ƒå°†äº§ç”Ÿä»€ä¹ˆåæœï¼Ÿ\nKube-apiserver æ‰§è¡Œå®¡è®¡ã€‚æ¯ä¸ªæ‰§è¡Œé˜¶æ®µçš„æ¯ä¸ªè¯·æ±‚éƒ½ä¼šç”Ÿæˆä¸€ä¸ªäº‹ä»¶ï¼Œç„¶åæ ¹æ®ç‰¹å®šç­–ç•¥å¯¹äº‹ä»¶è¿›è¡Œé¢„å¤„ç†å¹¶å†™å…¥åç«¯ã€‚\næ¯ä¸ªè¯·æ±‚éƒ½å¯ä»¥ç”¨ç›¸å…³çš„ â€œstageâ€ è®°å½•ã€‚å·²çŸ¥çš„ stage æœ‰ï¼š\n**RequestReceived -**äº‹ä»¶çš„ stage å°†åœ¨å®¡è®¡å¤„ç†å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå¹¶ä¸”åœ¨å§”æ‰˜ç»™å…¶ä½™å¤„ç†å™¨ä¹‹å‰ç”Ÿæˆã€‚\nResponseStarted - åœ¨å“åº”æ¶ˆæ¯çš„å¤´éƒ¨å‘é€åï¼Œä½†æ˜¯å“åº”æ¶ˆæ¯ä½“å‘é€å‰ã€‚è¿™ä¸ª stage ä»…ä¸ºé•¿æ—¶é—´è¿è¡Œçš„è¯·æ±‚ç”Ÿæˆï¼ˆä¾‹å¦‚ watchï¼‰ã€‚\nResponseComplete - å½“å“åº”æ¶ˆæ¯ä½“å®Œæˆå¹¶ä¸”æ²¡æœ‰æ›´å¤šæ•°æ®éœ€è¦ä¼ è¾“çš„æ—¶å€™ã€‚\nPanic - å½“ panic å‘ç”Ÿæ—¶ç”Ÿæˆã€‚\nNote:\nå®¡è®¡æ—¥å¿—è®°å½•åŠŸèƒ½ä¼šå¢åŠ  API serverçš„å†…å­˜æ¶ˆè€—ï¼Œå› ä¸ºéœ€è¦ä¸ºæ¯ä¸ªè¯·æ±‚å­˜å‚¨å®¡è®¡æ‰€éœ€çš„æŸäº›ä¸Šä¸‹æ–‡ã€‚æ­¤å¤–ï¼Œå†…å­˜æ¶ˆè€—å–å†³äºå®¡è®¡æ—¥å¿—è®°å½•çš„é…ç½®ã€‚\nå®¡è®¡ç­–ç•¥ # å®¡è®¡æ”¿ç­–å®šä¹‰äº†å…³äºåº”è®°å½•å“ªäº›äº‹ä»¶ä»¥åŠåº”åŒ…å«å“ªäº›æ•°æ®çš„è§„åˆ™ã€‚å¤„ç†äº‹ä»¶æ—¶ï¼Œå°†æŒ‰é¡ºåºä¸è§„åˆ™åˆ—è¡¨è¿›è¡Œæ¯”è¾ƒã€‚ç¬¬ä¸€ä¸ªåŒ¹é…è§„åˆ™è®¾ç½®äº‹ä»¶çš„ [å®¡è®¡çº§åˆ«][auditing-level]ã€‚å·²çŸ¥çš„å®¡è®¡çº§åˆ«æœ‰ï¼š\n**None -**ç¬¦åˆè¿™æ¡è§„åˆ™çš„æ—¥å¿—å°†ä¸ä¼šè®°å½•ã€‚\n**Metadata -**è®°å½•è¯·æ±‚çš„ metadataï¼ˆè¯·æ±‚çš„ç”¨æˆ·ã€timestampã€resourceã€verb ç­‰ç­‰ï¼‰ï¼Œä½†æ˜¯ä¸è®°å½•è¯·æ±‚æˆ–è€…å“åº”çš„æ¶ˆæ¯ä½“ã€‚\n**Request -**è®°å½•äº‹ä»¶çš„ metadata å’Œè¯·æ±‚çš„æ¶ˆæ¯ä½“ï¼Œä½†æ˜¯ä¸è®°å½•å“åº”çš„æ¶ˆæ¯ä½“ã€‚è¿™ä¸é€‚ç”¨äºéèµ„æºç±»å‹çš„è¯·æ±‚ã€‚\n**RequestResponse -**è®°å½•äº‹ä»¶çš„ metadataï¼Œè¯·æ±‚å’Œå“åº”çš„æ¶ˆæ¯ä½“ã€‚è¿™ä¸é€‚ç”¨äºéèµ„æºç±»å‹çš„è¯·æ±‚ã€‚\næ‚¨å¯ä»¥ä½¿ç”¨ \u0026ndash;audit-policy-file æ ‡å¿—å°†åŒ…å«ç­–ç•¥çš„æ–‡ä»¶ä¼ é€’ç»™ kube-apiserverã€‚å¦‚æœä¸è®¾ç½®è¯¥æ ‡å¿—ï¼Œåˆ™ä¸è®°å½•äº‹ä»¶ã€‚æ³¨æ„ rules å­—æ®µå¿…é¡»åœ¨å®¡è®¡ç­–ç•¥æ–‡ä»¶ä¸­æä¾›ã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªå®¡è®¡ç­–ç•¥æ–‡ä»¶çš„ç¤ºä¾‹ï¼š\naudit/audit-policy.yaml apiVersion: audit.k8s.io/v1beta1 # This is required. kind: Policy # Don\u0026#39;t generate audit events for all requests in RequestReceived stage. omitStages: - \u0026#34;RequestReceived\u0026#34; rules: # Log pod changes at RequestResponse level - level: RequestResponse resources: - group: \u0026#34;\u0026#34; # Resource \u0026#34;pods\u0026#34; doesn\u0026#39;t match requests to any subresource of pods, # which is consistent with the RBAC policy. resources: [\u0026#34;pods\u0026#34;] # Log \u0026#34;pods/log\u0026#34;, \u0026#34;pods/status\u0026#34; at Metadata level - level: Metadata resources: - group: \u0026#34;\u0026#34; resources: [\u0026#34;pods/log\u0026#34;, \u0026#34;pods/status\u0026#34;] # Don\u0026#39;t log requests to a configmap called \u0026#34;controller-leader\u0026#34; - level: None resources: - group: \u0026#34;\u0026#34; resources: [\u0026#34;configmaps\u0026#34;] resourceNames: [\u0026#34;controller-leader\u0026#34;] # Don\u0026#39;t log watch requests by the \u0026#34;system:kube-proxy\u0026#34; on endpoints or services - level: None users: [\u0026#34;system:kube-proxy\u0026#34;] verbs: [\u0026#34;watch\u0026#34;] resources: - group: \u0026#34;\u0026#34; # core API group resources: [\u0026#34;endpoints\u0026#34;, \u0026#34;services\u0026#34;] # Don\u0026#39;t log authenticated requests to certain non-resource URL paths. - level: None userGroups: [\u0026#34;system:authenticated\u0026#34;] nonResourceURLs: - \u0026#34;/api*\u0026#34; # Wildcard matching. - \u0026#34;/version\u0026#34; # Log the request body of configmap changes in kube-system. - level: Request resources: - group: \u0026#34;\u0026#34; # core API group resources: [\u0026#34;configmaps\u0026#34;] # This rule only applies to resources in the \u0026#34;kube-system\u0026#34; namespace. # The empty string \u0026#34;\u0026#34; can be used to select non-namespaced resources. namespaces: [\u0026#34;kube-system\u0026#34;] # Log configmap and secret changes in all other namespaces at the Metadata level. - level: Metadata resources: - group: \u0026#34;\u0026#34; # core API group resources: [\u0026#34;secrets\u0026#34;, \u0026#34;configmaps\u0026#34;] # Log all other resources in core and extensions at the Request level. - level: Request resources: - group: \u0026#34;\u0026#34; # core API group - group: \u0026#34;extensions\u0026#34; # Version of group should NOT be included. # A catch-all rule to log all other requests at the Metadata level. - level: Metadata # Long-running requests like watches that fall under this rule will not # generate an audit event in RequestReceived. omitStages: - \u0026#34;RequestReceived\u0026#34; ä¹Ÿå¯ä»¥ä½¿ç”¨æœ€ä½é™åº¦çš„å®¡è®¡ç­–ç•¥æ–‡ä»¶åœ¨ Metadata çº§åˆ«è®°å½•æ‰€æœ‰è¯·æ±‚ï¼š\n# Log all requests at the Metadata level. apiVersion: audit.k8s.io/v1beta1 kind: Policy rules: - level: Metadata å®¡è®¡æ—¥å¿—åç«¯ # k8sç›®å‰æä¾›ä¸¤ç§æ—¥å¿—åç«¯ï¼ŒLogåç«¯å’Œwebhookåç«¯ï¼ŒLogåç«¯å¯ä»¥å°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œwebhookåç«¯å°†æ—¥å¿—å‘é€åˆ°è¿œç«¯æ—¥å¿—æœåŠ¡å™¨ï¼Œæ¥ä¸‹æ¥æš‚ä¸”åªå¯¹Logåç«¯æ—¥å¿—çš„è®°å½•é…ç½®å’Œé‡‡é›†åšä¸€ä¸‹å®è·µã€‚\nä»¥ä¸‹å®è·µç»„ä»¶ç‰ˆæœ¬docker ce17ï¼Œk8s 1.9.2\nå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ kube-apiserver æ ‡å¿—é…ç½® Log å®¡è®¡åç«¯ï¼š\n\u0026ndash;audit-log-pathæŒ‡å®šç”¨æ¥å†™å…¥å®¡è®¡äº‹ä»¶çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ã€‚ä¸æŒ‡å®šæ­¤æ ‡å¿—ä¼šç¦ç”¨æ—¥å¿—åç«¯ã€‚- æ„å‘³ç€æ ‡å‡†åŒ–\n\u0026ndash;audit-log-maxageå®šä¹‰äº†ä¿ç•™æ—§å®¡è®¡æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤©æ•°\n\u0026ndash;audit-log-maxbackupå®šä¹‰äº†è¦ä¿ç•™çš„å®¡è®¡æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§æ•°é‡\n\u0026ndash;audit-log-maxsizeå®šä¹‰å®¡è®¡æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼ˆå…†å­—èŠ‚ï¼‰\næˆ‘å¸ç›®å‰é›†ç¾¤ä¸­kube-apiserverç»„ä»¶ä½œä¸ºstatic podæ–¹å¼è¿è¡Œï¼Œç”Ÿå‘½å‘¨æœŸç”±kubeletç›´æ¥ç®¡ç†ï¼Œstatic podç”±kebeletæ ¹æ®yamlæ–‡ä»¶åˆ›å»ºï¼Œyamlå­˜æ”¾è·¯å¾„ä¸º/etc/kubernetes/manifests/ç›®å½•ï¼Œå…¶ä¸­apiserverç”±kubeletæ ¹æ®kube-apiserver.yamlåˆ›å»ºï¼ŒLogåç«¯éœ€è¦åœ¨kube-apiserver.yamlçš„å¯åŠ¨å‚æ•°é‡ŒåŠ ä»¥ä¸‹å‚æ•°ï¼š\n--feature-gates=AdvancedAuditing=true --audit-policy-file=/etc/kubernetes/pki/audit-policy.yaml --audit-log-format=json --audit-log-path=/var/log/kubernetes/kubernetes-audit --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 è¯´æ˜ï¼š\nAdvancedAuditingæŒ‡æ˜å¯ç”¨é«˜çº§å®¡è®¡åŠŸèƒ½ï¼Œå³ï¼šå¯ä»¥ä½¿\u0026ndash;audit-policy-fileå‚æ•°æŒ‡å®šå®¡è®¡ç­–ç•¥ï¼Œè¯¥å‚æ•°ä»k8s 1.8ç‰ˆæœ¬ä»¥åé»˜è®¤ä¸ºtrueï¼›\naudit-policy-fileæŒ‡å®šç­–ç•¥æ–‡ä»¶çš„ä½ç½®ï¼Œè¯¥è·¯å¾„ä¸ºkube-apiserverå®¹å™¨å†…çš„è·¯å¾„ï¼Œæ‰€ä»¥å¾—ä»å®¿ä¸»æœºæŒ‚è½½ç­–ç•¥æ–‡ä»¶åˆ°å®¹å™¨å†…ï¼Œæ•…æš‚ä¸”æ”¾åœ¨/etc/kubernetes/pki/ç›®å½•ä¸‹ï¼›\naudit-log-formatæŒ‡å®šæœ€ç»ˆå®¡è®¡æ—¥å¿—çš„æ ¼å¼ä¸ºjsonï¼Œè¯¥å‚æ•°é»˜è®¤ä¸ºjsonï¼›\naudit-log-pathæŒ‡å®šæœ€ç»ˆå®¡è®¡æ—¥å¿—å­˜æ”¾åœ¨å®¹å™¨å†…çš„ä½ç½®ï¼Œè¯¥ä½ç½®ä¼šè‡ªåŠ¨åˆ›å»ºã€‚ä¸Šè¿°è¡¨ç¤ºæœ€ç»ˆçš„å®¡è®¡æ—¥å¿—æ–‡ä»¶ä¸ºkubernetes-audit\næœ€ç»ˆé…ç½®å¦‚ä¸‹ï¼š\nä¿®æ”¹å®Œæˆåï¼Œkubeletä¼šè‡ªåŠ¨åˆ é™¤é‡å»ºkube-apiserverçš„podï¼ˆå¦‚æœpodè¢«åˆ é™¤åï¼Œè¿‡å‡ åˆ†é’Ÿè¿˜ä¸è¢«åˆ›å»ºï¼Œå¯ä»¥ä¿®æ”¹\u0026ndash;audit-log-maxbackupçš„å€¼ä¿å­˜é€€å‡ºï¼Œç­‰å¾…podè¢«åˆ›å»º\u0026mdash;è¿™å¯èƒ½æ˜¯ä¸€ä¸ªbugï¼‰ï¼Œé‡å¯çŠ¶æ€å˜ä¸ºrunningåå¯ä»¥è¿›å…¥å®¹å™¨æŸ¥çœ‹ç”Ÿæˆçš„å®¡è®¡æ—¥å¿—æ–‡ä»¶ï¼š\næŸ¥çœ‹è¯¥æ—¥å¿—ï¼š\nè¾¾åˆ°100Måï¼š\nå› ä¸ºåé¢è¦ç”¨fluentdä½œä¸ºagentå»é‡‡é›†è¯¥æ—¥å¿—ï¼Œæ‰€ä»¥éœ€è¦æŠŠå®¹å™¨å†…çš„æ—¥å¿—æŒ‚è½½åˆ°å®¿ä¸»æœºç›®å½•ä¸‹ï¼Œä¿®æ”¹kube-apiserver.yamlå¦‚ä¸‹ï¼Œå³å°†å®¹å™¨å†…/var/log/kubernetesç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºçš„/var/log/kubernetesç›®å½•ã€‚\næ—¥å¿—é‡‡é›† # ç›®å‰é›†ç¾¤ä¸­å·²éƒ¨ç½²äº†fluentd elasticsearchæ—¥å¿—æ–¹æ¡ˆï¼Œæ‰€ä»¥é€‰ç”¨fluentdä½œä¸º Logging-agent ï¼ŒElasticsearchä½œä¸º Logging Backend ã€‚é›†ç¾¤ä¸­çš„fluentd-esä½œä¸ºDaemonSet æ–¹å¼è¿è¡Œï¼Œæ ¹æ®DaemonSetçš„ç‰¹æ€§ï¼Œåº”è¯¥åœ¨æ¯ä¸ªNodeä¸Šéƒ½ä¼šè¿è¡Œfluentd-esçš„podï¼Œä½†å®é™…æƒ…å†µæ˜¯19ç¯å¢ƒä¸Š3ä¸ªmasterèŠ‚ç‚¹éƒ½æ²¡æœ‰è¯¥podã€‚æŸ¥çœ‹åä¸ºfluentd-es-v1.22çš„DaemonSet yamlå¯ä»¥å‘ç°ï¼Œpodåªä¼šè¿è¡Œåœ¨æœ‰alpha.kubernetes.io/fluentd-ds-ready: â€œtrueâ€æ ‡ç­¾çš„nodeä¸Šï¼š\næŸ¥çœ‹masterèŠ‚ç‚¹çš„node yamlï¼Œå‘ç°ç¡®å®æ²¡æœ‰è¯¥æ ‡ç­¾ã€‚æ•…éœ€è¦åœ¨masterèŠ‚ç‚¹nodeä¸Šæ·»åŠ è¯¥æ ‡ç­¾ï¼š\næ·»åŠ å®Œlabelåï¼Œå¯ä»¥çœ‹åˆ°åœ¨docker-vm-6èŠ‚ç‚¹ä¸Špodä¼šè¢«è‡ªåŠ¨åˆ›å»ºã€‚\nFluentdçš„é…ç½®æ–‡ä»¶åœ¨å®¹å™¨å†…çš„/etc/td-agent/td-agent.confä¸­é…ç½®ï¼Œéƒ¨åˆ†é…ç½®æˆªå›¾å¦‚ä¸‹ï¼š\nè¯¥é…ç½®ç”±åä¸ºfluentdçš„ConfigMapæŒ‡å®šï¼š\nå¯ä»¥çœ‹åˆ°é…ç½®é‡Œå¹¶ä¸ä¼šå»é‡‡é›†ã€è½¬å‘å®¡è®¡æ—¥å¿—/var/log/kubernetes/kubernetes-auditï¼Œæ‰€ä»¥éœ€è¦åœ¨è¯¥ConfigMapä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š\næ·»åŠ åçš„æˆªå›¾å¦‚ä¸‹ï¼š\nä¹‹åéœ€è¦é‡å¯ä¸€ä¸‹kube-apiserverèŠ‚ç‚¹çš„fluentd podï¼Œfluentdé‡‡é›†æ—¶ï¼Œä¹Ÿä¼šè¾“å‡ºæ—¥å¿—åˆ°å®¿ä¸»æœºçš„/var/log/fluentd.logé‡Œï¼Œå¯ä»¥çœ‹åˆ°é”™è¯¯æ—¥å¿—ç­‰ä¿¡æ¯ï¼Œç”¨äºå®šä½é—®é¢˜ã€‚å¦‚æœè¯¥æ–‡ä»¶æ²¡æœ‰å®¡è®¡æ—¥å¿—ç›¸å…³é”™è¯¯ï¼Œæ—¥å¿—åº”è¯¥å°±ä¼šè¢«å‘é€åˆ°logging-backendï¼šelasticsearchï¼Œå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š\nå…ˆæŸ¥çœ‹elasticsearchçš„service IPå’ŒPortï¼Œç„¶åç”¨curlå‘½ä»¤è°ƒç”¨restæ¥å£æŸ¥è¯¢å½“å‰é›†ç¾¤ä¸­æ‰€æœ‰indexä¿¡æ¯ï¼š æŸ¥è¯¢åˆ°å®¡è®¡æ—¥å¿—ä¿¡æ¯å¦‚ä¸‹ï¼Œå¤§æ¦‚æœ‰220ä¸‡æ¡è®°å½•ï¼š è¯¦ç»†ä¿¡æ¯å¦‚ä¸‹ï¼Œå’Œå®¡è®¡æ—¥å¿—æ–‡ä»¶ä¸­è®°å½•çš„ä¸€æ ·ï¼š\nåç»­å¯ä»¥ç”¨Kibanaè¿›è¡Œæ—¥å¿—å±•ç¤ºï¼ŒElasticsearchã€Fluentdã€Kibanaå³ä¸ºå¤§åé¼é¼çš„EFKæ—¥å¿—æ”¶é›†æ–¹æ¡ˆï¼Œè¿˜æœ‰ELKç­‰ï¼Œå¯ä»¥æ ¹æ®é¡¹ç›®çš„éœ€æ±‚é€‰æ‹©é€‚å½“çš„ç»„ä»¶ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/kubeapiserver%E5%AE%A1%E8%AE%A1%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%92%8C%E9%87%87%E9%9B%86/","section":"Posts","summary":"\u003cp\u003eKubernetes å®¡è®¡åŠŸèƒ½æä¾›äº†ä¸å®‰å…¨ç›¸å…³çš„æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„è®°å½•é›†ï¼Œè®°å½•å•ä¸ªç”¨æˆ·ã€ç®¡ç†å‘˜æˆ–ç³»ç»Ÿå…¶ä»–ç»„ä»¶å½±å“ç³»ç»Ÿçš„æ´»åŠ¨é¡ºåºã€‚å®ƒèƒ½å¸®åŠ©é›†ç¾¤ç®¡ç†å‘˜å¤„ç†ä»¥ä¸‹é—®é¢˜ï¼š\u003c/p\u003e","title":"kube-apiserverå®¡è®¡æ—¥å¿—è®°å½•å’Œé‡‡é›†","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/jwt/","section":"Tags","summary":"","title":"Jwt","type":"tags"},{"content":" Json Web Token (JWT)ï¼Œæ˜¯ä¸€ä¸ªéå¸¸è½»å·§çš„è§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒå…è®¸åœ¨ç½‘ç»œåº”ç”¨ç¯å¢ƒé—´å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´è¾ƒå®‰å…¨çš„ä¼ é€’ä¿¡æ¯ã€‚è¯¥tokenè¢«è®¾è®¡ä¸ºç´§å‡‘ä¸”å®‰å…¨çš„ï¼Œç‰¹åˆ«é€‚ç”¨äºåˆ†å¸ƒå¼ç«™ç‚¹çš„å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰åœºæ™¯ã€‚JWTä¸€èˆ¬è¢«ç”¨æ¥åœ¨èº«ä»½æä¾›è€…å’ŒæœåŠ¡æä¾›è€…é—´ä¼ é€’è¢«è®¤è¯çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œä»¥ä¾¿äºä»èµ„æºæœåŠ¡å™¨è·å–èµ„æºã€‚\nåœ¨webåº”ç”¨ä¸­ï¼Œæˆ‘ä»¬æä¾›çš„APIæ¥å£ï¼Œé€šè¿‡GETæˆ–è€…POSTæ–¹å¼è°ƒç”¨ï¼Œåœ¨è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œå°±å­˜åœ¨ç€æ¥å£è®¤è¯åŠæ•°æ®çš„å®‰å…¨æ€§é—®é¢˜ã€‚ä¾‹å¦‚å¦‚ä¸‹é—®é¢˜ï¼š\n1ã€è¯·æ±‚æ¥è‡ªå“ªé‡Œï¼Œèº«ä»½æ˜¯å¦åˆæ³•ï¼Ÿ\n2ã€è¯·æ±‚å‚æ•°æ˜¯å¦è¢«ç¯¡æ”¹ï¼Ÿ\n3ã€å®¢æˆ·ç«¯è¯·æ±‚çš„å”¯ä¸€æ€§ï¼Œæ˜¯å¦ä¸ºé‡å¤è¯·æ±‚æ”»å‡»ï¼ˆRepeatAttackï¼‰ï¼Ÿ\nä¼ ç»Ÿçš„Sessionè®¤è¯æ–¹å¼ # åœ¨ä¼ ç»Ÿçš„webåº”ç”¨ä¸­ï¼ŒæœåŠ¡ç«¯æˆåŠŸç›¸åº”è¯·æ±‚è€…ï¼Œè¿”å›æ­£å¸¸çš„responseä¾èµ–äºæœåŠ¡ç«¯é€šè¿‡ä¸€ç§å­˜å‚¨æœºåˆ¶æŠŠæ¯ä¸ªç”¨æˆ·ç»è¿‡è®¤è¯ä¹‹åçš„ä¼šè¯ä¿¡æ¯ï¼ˆsessionï¼‰è®°å½•æœåŠ¡å™¨ç«¯ï¼Œä¸€èˆ¬è®°å½•åˆ°å†…å­˜ã€ç£ç›˜ã€æ•°æ®åº“ä¸­ï¼Œè¿™ç§æ–¹å¼åœ¨è¯·æ±‚é‡å’Œç”¨æˆ·é‡å¢å¤šçš„æ—¶å€™æ— ç–‘ä¼šå¢å¤§æœåŠ¡ç«¯çš„å¼€é”€ï¼›å¦‚æœæ˜¯è®°å½•åœ¨å†…å­˜ä¸­ï¼Œé‚£æ¯æ¬¡è¯·æ±‚éƒ½åˆ†å‘ç™»åˆ°è¯¥æœºå™¨ä¸Šæ‰èƒ½æˆæƒè·å–èµ„æºï¼Œé‚£åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å°±å­˜åœ¨ç€é—®é¢˜ï¼›å› ä¸ºæ˜¯åŸºäºCookieçš„ï¼Œå¦‚æœCookieè¢«æˆªè·ï¼Œæ”»å‡»è€…ä¼šç›—ç”¨èº«ä»½ä¿¡æ¯è¿›è¡Œå‘é€æ¶æ„è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯â€œè·¨ç«™è¯·æ±‚ä¼ªé€ â€ï¼ˆCSRFï¼‰ã€‚\nåŸºäºtokençš„è®¤è¯æ–¹å¼ # å®¢æˆ·ç«¯ç”¨ç”¨æˆ·åå’Œå¯†ç ç»è¿‡æœåŠ¡å™¨è®¤è¯ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šç­¾å‘ä¸€ä¸ªtokenè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å­˜å‚¨tokenï¼ˆä¸€èˆ¬å­˜åœ¨è¯·æ±‚å¤´é‡Œï¼‰ï¼Œå¹¶ä¸”åœ¨ä¹‹åçš„è¯·æ±‚é‡Œé™„å¸¦æ­¤tokenï¼ŒæœåŠ¡å™¨æ¯æ¬¡ä¼šè§£ç­¾åtokenï¼ŒéªŒè¯é€šè¿‡åˆ™è¿”å›èµ„æºã€‚å¦å¤–æœåŠ¡ç«¯è¦æ”¯æŒCORSè·¨æ¥æºèµ„æºå…±äº«ï¼‰ç­–ç•¥ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œè¯·æ±‚ä¹‹åï¼Œä¼šå†è¿”å›ç»“æœä¸­åŠ ä¸ŠAccess-Control-Allow-Originã€‚\njwtçš„ç”Ÿæˆ # tokenæ˜¯æ¥å£çš„ä»¤ç‰Œï¼Œå¥½æ¯”å»è¡™é—¨åŠäº‹ï¼Œâ€œè¡™é—¨å£æœå—å¼€ï¼Œæœ‰ç†æ— é’±è«è¿›æ¥â€ã€‚æ²¡æœ‰ä»¤ç‰Œå°±åˆ«æƒ³åŠäº‹ã€‚tokençš„éªŒè¯æ–¹æ³•å¾ˆå¤šï¼Œä¹Ÿç”Ÿæˆäº†å¾ˆå¤šæ ‡å‡†ï¼Œjwtå°±æ˜¯ä¸€ç§åŸºäºjsonçš„RFC 7519ã€‚è¯¥æ ‡å‡†ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š\nheader\npayload\nsignature\nheaderå’Œpayloadç»è¿‡base64ç¼–ç åç”¨ç‚¹æ‹¼æ¥èµ·æ¥ã€‚signatureæ˜¯æŠŠheaderå’Œpayloadç¼–ç å’Œæ‹¼æ¥åç»è¿‡åŠ å¯†ç®—æ³•åŠ å¯†ï¼ŒåŠ å¯†æ—¶è¿˜è¦ä¸€ä¸ªå¯†ç ï¼Œè¿™ä¸ªå¯†ç ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚å¤§è‡´ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\nHeaderï¼š\nheadç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªæ˜¯tokenç±»å‹ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨çš„ç®—æ³•ï¼Œå¦‚ä¸‹ç±»å‹ä¸ºjwtï¼Œä½¿ç”¨çš„ç®—æ³•æ˜¯HS256ã€‚å½“ç„¶ï¼Œè¿˜æœ‰HS384ã€HS512ç®—æ³•ã€‚\n{ \u0026#34;typ\u0026#34;: \u0026#34;JWT\u0026#34;, \u0026#34;alg\u0026#34;: \u0026#34;HS256\u0026#34; } å°†ä»¥ä¸Šjsonè¿›è¡Œbase64ç¼–ç ï¼Œå½“ç„¶ç¼–ç å‰å°†jsonå»æ ¼å¼åŒ–ï¼Œå¦‚å›¾ï¼š\nç”Ÿæˆçš„ç¼–ç ä¸ºï¼š\neyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9 ç”¨goè¯­è¨€å®ç°ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;encoding/base64\u0026#34; ) func main() { head1 := `{\u0026#34;typ\u0026#34;:\u0026#34;JWT\u0026#34;,\u0026#34;alg\u0026#34;:\u0026#34;HS256\u0026#34;}` fmt.Println(base64.StdEncoding.EncodeToString([]byte(head1))) } Payloadï¼š\npayload é‡Œé¢æ˜¯ token çš„å…·ä½“å†…å®¹ï¼Œè¿™äº›å†…å®¹é‡Œé¢æœ‰ä¸€äº›æ˜¯æ ‡å‡†å­—æ®µï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ·»åŠ è‡ªå®šä¹‰å†…å®¹ã€‚å¦‚ä¸‹ï¼š\n{ \u0026#34;iss\u0026#34;: \u0026#34;smallsoup\u0026#34;, \u0026#34;iat\u0026#34;: 1528902195, \u0026#34;exp\u0026#34;: 1528988638, \u0026#34;aud\u0026#34;: \u0026#34;www.smallsoup.com\u0026#34;, \u0026#34;sub\u0026#34;: \u0026#34;smallsoup@qq.com\u0026#34;, \u0026#34;userId\u0026#34;: \u0026#34;0418\u0026#34; } è¿™é‡Œé¢çš„å‰äº”ä¸ªå­—æ®µéƒ½æ˜¯ç”±JWTçš„æ ‡å‡†æ‰€å®šä¹‰çš„ï¼Œåœ¨jwtæ ‡å‡†ä¸­éƒ½å¯ä»¥æ‰¾åˆ°ã€‚\niss: è¯¥JWTçš„ç­¾å‘è€…\nsub: è¯¥JWTæ‰€é¢å‘çš„ç”¨æˆ·\naud: æ¥æ”¶è¯¥JWTçš„ä¸€æ–¹\nexp(expires): ä»€ä¹ˆæ—¶å€™è¿‡æœŸï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªUnixæ—¶é—´æˆ³\niat(issued at): åœ¨ä»€ä¹ˆæ—¶å€™ç­¾å‘çš„\næœ€åä¸€ä¸ªuserIdè¡¨ç¤ºäº†ç”¨æˆ·ä¿¡æ¯ï¼Œä¸ºè‡ªå®šä¹‰å­—æ®µï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰è§’è‰²ç­‰å…¶ä»–å­—æ®µã€‚ä»¥ä¸Šçš„jsonå»æ ¼å¼åŒ–åçš„base64ç¼–ç å¦‚ä¸‹ï¼š\neyJpc3MiOiJzbWFsbHNvdXAiLCJpYXQiOjE1Mjg5MDIxOTUsImV4cCI6MTUyODk4ODYzOCwiYXVkIjoid3d3LnNtYWxsc291cC5jb20iLCJzdWIiOiJzbWFsbHNvdXBAcXEuY29tIiwidXNlcklkIjoiMDQxOCJ9 Signatureï¼š\nJWT çš„æœ€åä¸€éƒ¨åˆ†æ˜¯ Signature ï¼Œè¿™éƒ¨åˆ†å†…å®¹æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå…ˆæ˜¯ç”¨ Base64 ç¼–ç çš„ header.payload ï¼Œå†ç”¨åŠ å¯†ç®—æ³•åŠ å¯†ä¸€ä¸‹ï¼ŒåŠ å¯†çš„æ—¶å€™è¦æ”¾è¿›å»ä¸€ä¸ª Secret ï¼Œè¿™ä¸ªç›¸å½“äºæ˜¯ä¸€ä¸ªå¯†ç ï¼Œè¿™ä¸ªå¯†ç ç§˜å¯†åœ°å­˜å‚¨åœ¨æœåŠ¡ç«¯ã€‚\nheader\npayload\nsecret\nå‡è®¾è¿™é‡Œsecretä¸ºmysecretï¼Œåˆ™ç”¨goè¯­è¨€å®ç°ä»£ç å¦‚ä¸‹ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;encoding/base64\u0026#34; \u0026#34;crypto/hmac\u0026#34; \u0026#34;crypto/sha256\u0026#34; \u0026#34;strings\u0026#34; ) func main() { head1 := `{\u0026#34;typ\u0026#34;:\u0026#34;JWT\u0026#34;,\u0026#34;alg\u0026#34;:\u0026#34;HS256\u0026#34;}` head1Base64 := base64.StdEncoding.EncodeToString([]byte(head1)) payload1 := `{\u0026#34;iss\u0026#34;:\u0026#34;smallsoup\u0026#34;,\u0026#34;iat\u0026#34;:1528902195,\u0026#34;exp\u0026#34;:1528988638,\u0026#34;aud\u0026#34;:\u0026#34;www.smallsoup.com\u0026#34;,\u0026#34;sub\u0026#34;:\u0026#34;smallsoup@qq.com\u0026#34;,\u0026#34;userId\u0026#34;:\u0026#34;0418\u0026#34;}` payload1Base64 := base64.StdEncoding.EncodeToString([]byte(payload1)) encodedstring := head1Base64 \u0026#34;.\u0026#34; payload1Base64 hash := hmac.New(sha256.New, []byte(\u0026#34;mysecret\u0026#34;)) hash.Write([]byte(encodedstring)) signature := strings.TrimRight(base64.URLEncoding.EncodeToString(hash.Sum(nil)), \u0026#34;=\u0026#34;) fmt.Printf(signature) } è¿è¡Œç»“æœä¸ºï¼š\nfjjbA93FTcE71hz_cyIzCUFYdTdyl9hA0w7Pa0ltduc æœ€åè¿™ä¸ªåœ¨æœåŠ¡ç«¯ç”Ÿæˆå¹¶ä¸”è¦å‘é€ç»™å®¢æˆ·ç«¯çš„ Token çœ‹èµ·æ¥åƒè¿™æ ·ï¼š\neyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzbWFsbHNvdXAiLCJpYXQiOjE1Mjg5MDIxOTUsImV4cCI6MTUyODk4ODYzOCwiYXVkIjoid3d3LnNtYWxsc291cC5jb20iLCJzdWIiOiJzbWFsbHNvdXBAcXEuY29tIiwidXNlcklkIjoiMDQxOCJ9.fjjbA93FTcE71hz_cyIzCUFYdTdyl9hA0w7Pa0ltduc å®é™…ä¸Šhttps://jwt.io/è¿™ä¸ªç½‘ç«™æä¾›äº†è¿™ä¸ªèƒ½åŠ›ï¼Œä»¥åŠå„ç§è¯­è¨€çš„ç”Ÿæˆtokenå’Œè§£å¯†tokençš„åº“ã€‚\ngoè¯­è¨€ç”Ÿæˆtokenå’Œè§£ætokenï¼š\nä¸‹é¢æ˜¯goè¯­è¨€ç‰ˆçš„ç”Ÿæˆtokenå’Œè§£ætokençš„æ¡ˆä¾‹ï¼š\npackage main import ( \u0026#34;github.com/dgrijalva/jwt-go\u0026#34; \u0026#34;fmt\u0026#34; ) func main() { hmacSampleSecret := []byte(\u0026#34;mysecret\u0026#34;) // Create a new token object, specifying signing method and the claims // you would like it to contain. token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{ \u0026#34;iss\u0026#34;: \u0026#34;smallsoup\u0026#34;, \u0026#34;iat\u0026#34;: 1528902195, \u0026#34;exp\u0026#34;: 1528988638, \u0026#34;aud\u0026#34;: \u0026#34;www.smallsoup.com\u0026#34;, \u0026#34;sub\u0026#34;: \u0026#34;smallsoup@qq.com\u0026#34;, \u0026#34;userId\u0026#34;: \u0026#34;0418\u0026#34;, }) // Sign and get the complete encoded token as a string using the secret tokenString, err := token.SignedString(hmacSampleSecret) fmt.Println(tokenString, err) token, err = jwt.Parse(tokenString, func(token *jwt.Token) (interface{}, error) { // Don\u0026#39;t forget to validate the alg is what you expect: if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok { return nil, fmt.Errorf(\u0026#34;Unexpected signing method: %v\u0026#34;, token.Header[\u0026#34;alg\u0026#34;]) } // hmacSampleSecret is a []byte containing your secret, e.g. []byte(\u0026#34;my_secret_key\u0026#34;) return hmacSampleSecret, nil }) if claims, ok := token.Claims.(jwt.MapClaims); ok \u0026amp;\u0026amp; token.Valid { fmt.Println(claims) } else { fmt.Println(err) } } å…·ä½“å¯ä»¥äº†è§£githubä¸Šä»¥ä¸‹ä»£ç çš„å®ç°ã€‚\ngo get github.com/dgrijalva/jwt-go ","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E6%B5%85%E8%B0%88jsonwebtoken%E5%8F%8A%E5%BA%94%E7%94%A8/","section":"Posts","summary":"\u003cblockquote\u003e\n\u003cp\u003eJson Web Token (JWT)ï¼Œæ˜¯ä¸€ä¸ªéå¸¸è½»å·§çš„è§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒå…è®¸åœ¨ç½‘ç»œåº”ç”¨ç¯å¢ƒé—´å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´è¾ƒå®‰å…¨çš„ä¼ é€’ä¿¡æ¯ã€‚è¯¥tokenè¢«è®¾è®¡ä¸ºç´§å‡‘ä¸”å®‰å…¨çš„ï¼Œç‰¹åˆ«é€‚ç”¨äºåˆ†å¸ƒå¼ç«™ç‚¹çš„å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰åœºæ™¯ã€‚JWTä¸€èˆ¬è¢«ç”¨æ¥åœ¨èº«ä»½æä¾›è€…å’ŒæœåŠ¡æä¾›è€…é—´ä¼ é€’è¢«è®¤è¯çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œä»¥ä¾¿äºä»èµ„æºæœåŠ¡å™¨è·å–èµ„æºã€‚\u003c/p\u003e","title":"æµ…è°ˆjson web tokenåŠåº”ç”¨","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/beego/","section":"Tags","summary":"","title":"Beego","type":"tags"},{"content":"åœ¨å¼€å§‹ç¯å¢ƒæ­å»ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·æ¥çœ‹çœ‹ï¼š\nGoæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼š\nä¸ç”¨è™šæ‹Ÿæœºï¼Œå®ƒå¯ç›´æ¥ç¼–è¯‘æˆæœºå™¨ç ï¼Œé™¤äº†glibcå¤–æ²¡æœ‰å…¶ä»–å¤–éƒ¨ä¾èµ–ï¼Œéƒ¨ç½²ååˆ†æ–¹ä¾¿ï¼Œå°±æ˜¯æ‰”ä¸€ä¸ªæ–‡ä»¶å°±å®Œæˆäº†ã€‚\nå¤©ç”Ÿæ”¯æŒå¹¶å‘ï¼Œå¯ä»¥å……åˆ†çš„åˆ©ç”¨å¤šæ ¸ï¼Œå¾ˆå®¹æ˜“å®ç°å¹¶å‘ã€‚\n25ä¸ªå…³é”®å­—ï¼Œä½†æ˜¯è¡¨è¾¾èƒ½åŠ›å¾ˆå¼ºå¤§ï¼Œå‡ ä¹æ”¯æŒå¤§å¤šæ•°ä½ åœ¨å…¶ä»–è¯­è¨€è§è¿‡çš„ç‰¹æ€§ï¼šç»§æ‰¿ã€é‡è½½ã€å¯¹è±¡ç­‰ã€‚\nå†…ç½®å¼ºå¤§çš„å·¥å…·ï¼ŒGoè¯­è¨€é‡Œé¢å†…ç½®äº†å¾ˆå¤šå·¥å…·é“¾ï¼Œæœ€å¥½çš„åº”è¯¥æ˜¯gofmtå·¥å…·ï¼Œè‡ªåŠ¨åŒ–æ ¼å¼åŒ–ä»£ç ï¼Œèƒ½å¤Ÿè®©å›¢é˜Ÿreviewå˜å¾—æ›´åŠ ç®€å•ã€‚\nè·¨å¹³å°ç¼–è¯‘ï¼Œå¦‚æœä½ åœ¨windowsä¸Šæƒ³ç”Ÿæˆlinuxä¸Šçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåªéœ€è¦ä¸€æ¡å‘½ä»¤(set GOOS=linux)ï¼Œå³å¯ä»¥åšåˆ°windowsç³»ç»Ÿç¼–è¯‘linuxçš„åº”ç”¨ã€‚\nGoé€‚åˆåšä»€ä¹ˆ\næœåŠ¡å™¨ç¼–ç¨‹ï¼Œç”¨Goæ¥åšå¾ˆåˆé€‚ï¼Œä¾‹å¦‚å¤„ç†æ—¥å¿—ã€æ•°æ®æ‰“åŒ…ã€è™šæ‹Ÿæœºå¤„ç†ã€æ–‡ä»¶ç³»ç»Ÿç­‰\nåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ•°æ®åº“ä»£ç†å™¨ç­‰\nç½‘ç»œç¼–ç¨‹ï¼Œè¿™ä¸€å—ç›®å‰åº”ç”¨æœ€å¹¿ï¼ŒåŒ…æ‹¬Webåº”ç”¨ã€APIåº”ç”¨ã€ä¸‹è½½åº”ç”¨\nGoæˆåŠŸçš„é¡¹ç›®\nnsqï¼šbitlyå¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œæ€§èƒ½éå¸¸é«˜ï¼Œç›®å‰ä»–ä»¬æ¯å¤©å¤„ç†æ•°åäº¿æ¡çš„æ¶ˆæ¯\ndocker:åŸºäºlxcçš„ä¸€ä¸ªè™šæ‹Ÿæ‰“åŒ…å·¥å…·ï¼Œèƒ½å¤Ÿå®ç°PAASå¹³å°çš„ç»„å»º\npacker:ç”¨æ¥ç”Ÿæˆä¸åŒå¹³å°çš„é•œåƒæ–‡ä»¶ï¼Œä¾‹å¦‚VMã€vboxã€AWSç­‰ï¼Œä½œè€…æ˜¯vagrantçš„ä½œè€…\nskynetï¼šåˆ†å¸ƒå¼è°ƒåº¦æ¡†æ¶\ndoozerï¼šåˆ†å¸ƒå¼åŒæ­¥å·¥å…·ï¼Œç±»ä¼¼ZooKeeper\nhekaï¼šmazilaå¼€æºçš„æ—¥å¿—å¤„ç†ç³»ç»Ÿ\ncbfsï¼šcouchbaseå¼€æºçš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ\ntsuruï¼šå¼€æºçš„PAASå¹³å°ï¼Œå’ŒSAEå®ç°çš„åŠŸèƒ½ä¸€æ¨¡ä¸€æ ·\ngroupcacheï¼šmemcaheä½œè€…å†™çš„ç”¨äºGoogleä¸‹è½½ç³»ç»Ÿçš„ç¼“å­˜ç³»ç»Ÿ\ngodï¼šç±»ä¼¼redisçš„ç¼“å­˜ç³»ç»Ÿï¼Œä½†æ˜¯æ”¯æŒåˆ†å¸ƒå¼å’Œæ‰©å±•æ€§\nå¦‚æœä½ è§‰å¾—Goè¯­è¨€å¾ˆå¼ºå¤§ï¼Œä¹Ÿæƒ³å»å­¦ä¹ å®ƒï¼Œé‚£ä¹ˆç°åœ¨å¯ä»¥è·Ÿæˆ‘ä¸€èµ·æ¥å­¦ä¹ ç¯å¢ƒæ­å»ºè¿‡ç¨‹ã€‚\n1ã€ ç›¸å…³è½¯ä»¶å‡†å¤‡ï¼š\nGitï¼šä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œå¯ä»¥æœ‰æ•ˆã€é«˜é€Ÿçš„å¤„ç†ä»å¾ˆå°åˆ°éå¸¸å¤§çš„é¡¹ç›®ç‰ˆæœ¬ç®¡ç†ï¼Œåˆ†ä¸º32å’Œ64ä½å®‰è£…åŒ…ã€‚\nGoï¼šgoè¯­è¨€å®‰è£…åŒ…ï¼Œåˆ†ä¸º32å’Œ64ä½ã€‚\nliteIdeï¼šå›½äººå¼€å‘çš„ä¸€æ¬¾ç®€å•ã€å¼€æºã€è·¨å¹³å°çš„ Go è¯­è¨€IDEã€‚\n2ã€ å®‰è£…goå®‰è£…åŒ…ï¼š\n1ã€æ ¹æ®æ“ä½œç³»ç»Ÿæ˜¯32ä½æˆ–64ä½é€‰æ‹©å¯¹åº”çš„go1.8.3.windows-XXX.msiæ–‡ä»¶ï¼ŒåŒå‡»å¼€å§‹å®‰è£…ï¼Œä¸€è·¯ä¸‹ä¸€æ­¥ï¼Œå³å¯å®Œæˆå®‰è£…ã€‚å®‰è£…åˆ°é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹æ—¶ï¼Œå¯ä»¥é€‰Dç›˜ã€‚\n2ã€é…ç½®ç¯å¢ƒå˜é‡ã€‚é€‰æ‹©è®¡ç®—æœº -\u0026gt; å±æ€§ -\u0026gt; é«˜çº§ç³»ç»Ÿè®¾ç½® -\u0026gt; ç¯å¢ƒå˜é‡ï¼Œçœ‹ç³»ç»Ÿç¯å¢ƒå˜é‡é‡Œæ˜¯å¦æœ‰GOROOTï¼ˆé»˜è®¤åˆšæ‰å®‰è£…å¥½åGOROOTæ˜¯è®¾ç½®å¥½äº†çš„ï¼Œå³åˆšæ‰çš„å®‰è£…ç›®å½•ï¼‰ã€‚ä¸ºäº†åç»­å·¥ä½œçš„æ–¹ä¾¿ï¼Œè¿™é‡Œé…ç½®ä¸€ä¸‹GOPATHï¼Œåœ¨ç¯å¢ƒå˜é‡é‡Œæ–°å¢ä¸€ä¸ªGOPATHç³»ç»Ÿå˜é‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næœ€ååœ¨Pathä¸­åœ¨æ·»åŠ ä¸Šâ€ %GOPATH%binâ€(é»˜è®¤goå®‰è£…åŒ…å®‰å¥½ï¼Œè¿™ä¸ªä¹Ÿæ˜¯è®¾ç½®å¥½çš„)å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nç„¶åç¡®å®šå°±è¡Œã€‚\n3ã€åœ¨æ§åˆ¶å°ä¸­æŸ¥çœ‹Goè¯­è¨€ç¯å¢ƒæ˜¯å¦å®‰è£…å®Œæˆï¼Œwindowsä¸­ï¼Œç”¨å¿«æ·é”®\nwin Rï¼Œè¾“å…¥cmdï¼Œæ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼Œè¾“å…¥â€œgoâ€ï¼Œå‡ºç°ä¸‹å›¾å³å¯ï¼š\né¡ºå¸¦è¯´ä¸€å¥ï¼ŒGoç¨‹åºçš„ç›®å½•ç»“æ„æ˜¯åœ¨GOPATHæ–‡ä»¶å¤¹ä¸‹çš„ï¼Œåˆ†ä¸ºbin, pkg, å’Œsrcä¸‰ä¸ªå­æ–‡ä»¶å¤¹ ã€‚\nbinæ–‡ä»¶å¤¹ï¼šGoçš„æ¯ä¸ªé¡¹ç›®ç”Ÿæˆçš„äºŒè¿›åˆ¶å¯æ‰§è¡Œç¨‹åºã€‚windowsä¸‹ä¼šç”Ÿæˆ.exeæ–‡ä»¶ï¼Œlinuxä¸‹ä¼šç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚Goçš„æœ€å¤§ç‰¹è‰²ä¹‹ä¸€å°±æ˜¯å¯ç§»æ¤æ€§ï¼Œå°±æ˜¯è¯´ï¼Œå½“ç”Ÿæˆä¸€ä¸ªdemo.exeä¹‹åï¼Œå°†è¿™ä¸ªexeæ–‡ä»¶æ”¾åœ¨ä»»æ„ä¸€å°windowsç³»ç»Ÿä¸Šï¼ˆå³ä½¿æ²¡æœ‰å®‰è£…goå®‰è£…åŒ…ï¼‰ï¼Œä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œçš„ã€‚è¿™æ˜¯è®©PHPï¼ŒPythonç­‰è„šæœ¬è¯­è¨€æœ›æˆè«åŠçš„ã€‚\npkgæ–‡ä»¶å¤¹ï¼šç¬¬ä¸‰æ–¹åº“ã€‚é‡Œé¢å­˜æ”¾ä½ çš„é¡¹ç›®ä¸­å¼•ç”¨çš„ç¬¬ä¸‰æ–¹åº“ï¼ˆéå®˜æ–¹å·²ç»æä¾›çš„åº“ï¼‰\nsrcæ–‡ä»¶å¤¹ï¼šæ¯ä¸ªæ¬¡çº§æ–‡ä»¶å¤¹å°±æ˜¯ä»£è¡¨ä¸€ä¸ªgoé¡¹ç›®ï¼Œé‡Œé¢å­˜æ”¾æºç¨‹åºã€‚\n3ã€ Goè¯­è¨€å¼€å‘IDEå·¥å…·LiteIDEçš„ä½¿ç”¨ï¼š\nè§£å‹æˆ‘ä»¬ä¸‹è½½å¥½çš„ liteidex32.1.windows-qt5 ï¼ŒæŠŠliteideæ–‡ä»¶å¤¹æ”¾åœ¨ä½ å–œæ¬¢çš„ä½ç½®ï¼Œæ‰¾åˆ°\\LiteIDE\\binè·¯å¾„ä¸‹çš„liteide.exeï¼Œéå¸¸å¸…æ°”çš„ä¸€ä¸ªå¤ªæå›¾æ ‡ï¼ŒåŒå‡»è¿è¡Œå³å¯ã€‚\nå¯¹äºLiteIDEï¼Œæœ‰ä¸€äº›ç®€å•çš„è®¾ç½®ï¼šï¼ˆä»¥windows10çš„64ä½ç‰ˆæœ¬ä¸ºä¾‹ï¼‰\n1ã€å¦‚ä¸‹ï¼Œé€‰æ‹©win64ï¼Œè¿™ä¸ªé€‰é¡¹å†³å®šç¼–è¯‘åç”Ÿæˆå“ªä¸ªå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™é‡Œé€‰æ‹©win64ï¼Œç¼–è¯‘åå°†ç”Ÿæˆexeæ–‡ä»¶ã€‚\n2ã€ç‚¹å‡»å¦‚ä¸‹å›¾æ ‡ï¼ŒæŸ¥çœ‹GOROOTçš„è·¯å¾„æ˜¯å¦ä¸ºGoçš„å®‰è£…è·¯å¾„ã€‚\n3ã€ç‚¹å‡»å¦‚ä¸‹å›¾æ ‡æŸ¥çœ‹GOPATHï¼Œç¡®å®šç³»ç»ŸGOPATHæ˜¯å¦ä¸ºåˆšæ‰ç¯å¢ƒå˜é‡é‡Œè®¾ç½®çš„GOPATHï¼Œç‚¹å‡»ç¡®å®šã€‚\nç„¶åé‡å¯liteIDEå³å¯ã€‚\nå›½äººå¤§ç‰›Visualfcåˆ¶ä½œçš„è¿™ä¸ªIDEçœŸçš„å¾ˆå¸…æ°”ï¼Œæ™ºèƒ½æç¤ºã€å„ç§è°ƒè¯•éƒ½æœ‰ï¼Œé€Ÿåº¦ä¹Ÿå¾ˆå¿«ã€‚\n4ã€ Gitå·¥å…·å®‰è£…ï¼š\nåŒå‡»å®‰è£…æˆ‘ä»¬ä¸‹è½½çš„Git-2.15.1.2-XX-bit.exeï¼Œä¸€è·¯ä¸‹ä¸€æ­¥å®‰è£…ã€‚å®‰è£…å®Œæˆåï¼Œé¼ æ ‡å³é”®å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ ‡å³å¯ï¼š\n5ã€ Beegoæ¡†æ¶ç¯å¢ƒæ­å»ºï¼š\nBeegoè¿™ä¸ªæ¡†æ¶æ˜¯å›½äººå¤§ç‰›è°¢å­Ÿå†›å†™çš„è½»é‡çº§åº”ç”¨æ¡†æ¶ï¼Œåœ¨ä»–çš„ä¹¦ã€ŠGo Webç¼–ç¨‹ã€‹ä¸­å°±æœ‰å¯¹è¿™ä¸ªæ¡†æ¶çš„è¯´æ˜ï¼Œå„ç§å†™çš„å¥½ã€‚\né¡¹ç›®åœ°å€å¦‚ä¸‹:\nhttps://github.com/astaxie/beego\nåœ¨å‰é¢æˆ‘ä»¬å®‰è£…å¥½äº†Gitï¼Œè¿™ä¸‹è¦å‘æŒ¥ä½œç”¨äº†ã€‚\n1ã€å®‰è£…beego\nå³é”®ç‚¹å‡»â€œGit Bashâ€ï¼Œè¾“å…¥go get -u -v github.com/astaxie/beego å¦‚ä¸‹å›¾ï¼š\nç­‰ä¸€ä¼šå„¿å³å¯ã€‚å®‰è£…å®Œæˆåï¼Œåœ¨GOPATHè·¯å¾„ä¸‹ï¼ˆæˆ‘è¿™é‡ŒGOPATHçš„è·¯å¾„æ˜¯\nD:\\SoftwareAndProgram\\program\\Go\\Developmentï¼‰åœ¨D:\\SoftwareAndProgram\\program\\Go\\Development\\pkg\\windows_amd64\\github.com\\å’ŒD:\\SoftwareAndProgram\\program\\Go\\Development\\src\\github.com\\è·¯å¾„ä¸‹èƒ½çœ‹åˆ°astaxieæ–‡ä»¶å¤¹ï¼Œè¿˜æœ‰ä¸‹çº§beegoæ–‡ä»¶å¤¹ã€‚\n2ã€å®‰è£…beeå·¥å…·ï¼ˆæ¡†æ¶ç”Ÿæˆå·¥å…·ï¼‰\nä¸ºäº†æ–¹ä¾¿çš„ç”Ÿæˆæ¡†æ¶ï¼Œå³é”®ç‚¹å‡»â€œGit Bashâ€ï¼Œè¾“å…¥go get -u -v github.com/beego/beeï¼Œå¦‚ä¸‹å›¾ï¼š\nåŒæ ·ä¹Ÿæ˜¯ç­‰ä¸€ä¼šå„¿å³å¯ã€‚å®Œæˆåï¼Œåœ¨D:\\SoftwareAndProgram\\program\\Go\\Development\\src\\github.com\\beegoè·¯å¾„ä¸‹èƒ½çœ‹åˆ°beeæ–‡ä»¶å¤¹ã€‚\nåŒæ—¶ï¼Œåœ¨GOPATHè·¯å¾„ä¸‹çš„srcåŒçº§çš„binä¸­ï¼Œæœ‰â€œbee.exeâ€æ–‡ä»¶ã€‚\n3ã€ä½¿ç”¨beeå·¥å…·ç”Ÿæˆæ¡†æ¶å·¥ç¨‹ä»£ç \nåœ¨â€œå¼€å§‹â€ä¸­æ‰¾åˆ°â€œå‘½ä»¤æç¤ºç¬¦â€ï¼Œå³é”®â€œä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œâ€ï¼Œå…ˆè¿›å…¥åˆ°GOPATHçš„binè·¯å¾„ä¸‹ï¼Œå†è¾“å…¥â€œbee new å·¥ç¨‹åâ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:\nåœ¨GOPATHçš„srcç›®å½•ä¸‹ä¼šç”Ÿæˆä»¥åˆšæ‰çš„å·¥ç¨‹åå‘½åçš„æ–‡ä»¶å¤¹ã€‚è¿™æ ·ä¸€ä¸ªBeegoæ¡†æ¶çš„å·¥ç¨‹å°±ç”ŸæˆæˆåŠŸäº†ã€‚\n4ã€ä½¿ç”¨LiteIDEæ‰“å¼€è¿è¡Œã€‚\nLiteIDEçš„â€œæ–‡ä»¶â€ä¸­æ‰¾åˆ°â€œæ‰“å¼€ç›®å½•â€ï¼Œæ‰¾åˆ°åˆšæ‰ç”Ÿæˆçš„å·¥ç¨‹æ–‡ä»¶å¤¹ï¼Œå¦‚ä¸‹å›¾ï¼š\nç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶å¤¹â€ï¼ŒåŠ è½½æ•´ä¸ªå·¥ç¨‹ã€‚\næ¸…æ™°çš„MVCä¸€ç›®äº†ç„¶ã€‚Ctrl Rç¼–è¯‘å¹¶æ‰§è¡Œã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å„ç§è®¾ç½®æ–­ç‚¹å„ç§è°ƒè¯•ã€‚\næ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥â€œhttp://127.0.0.1:8080â€å°±çœ‹åˆ°äº†è¿è¡Œçš„ç»“æœã€‚\nè¦ç»“æŸè¿è¡Œï¼Œç‚¹å‡»LiteIDEä¸Šçš„â€œç¼–è¯‘è¾“å‡ºâ€åé¢çš„çº¢è‰²å°æŒ‰é’®å³å¯ã€‚\næœ¬æ–‡ç”¨åˆ°çš„è½¯ä»¶ï¼Œå¯ä»¥å…³æ³¨å…¬ä¼—å·åï¼Œåå°å›å¤ï¼šgoç¯å¢ƒæ­å»º ï¼Œè·å¾—ã€‚\nå‚è€ƒè‡ªï¼šhttp://www.cnblogs.com/iflytek/p/3366282.html\nå¹¶åŠ ä»¥ä¿®æ­£ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/go%E8%AF%AD%E8%A8%80%E5%8F%8Abeego%E6%A1%86%E6%9E%B6%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/","section":"Posts","summary":"\u003cp\u003eåœ¨å¼€å§‹ç¯å¢ƒæ­å»ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·æ¥çœ‹çœ‹ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eGoæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼š\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eä¸ç”¨è™šæ‹Ÿæœºï¼Œå®ƒå¯ç›´æ¥ç¼–è¯‘æˆæœºå™¨ç ï¼Œé™¤äº†glibcå¤–æ²¡æœ‰å…¶ä»–å¤–éƒ¨ä¾èµ–ï¼Œéƒ¨ç½²ååˆ†æ–¹ä¾¿ï¼Œå°±æ˜¯æ‰”ä¸€ä¸ªæ–‡ä»¶å°±å®Œæˆäº†ã€‚\u003c/p\u003e","title":"Goè¯­è¨€åŠBeegoæ¡†æ¶ç¯å¢ƒæ­å»º","type":"posts"},{"content":"å¹³æ—¶ç¼–å†™ä»£ç è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°å¯¹äºå…¨å±€è§’åº¦åªéœ€è¿è¡Œä¸€æ¬¡çš„ä»£ç ï¼Œæ¯”å¦‚å…¨å±€åˆå§‹åŒ–æ“ä½œï¼Œè®¾è®¡æ¨¡å¼ä¸­çš„å•ä¾‹æ¨¡å¼ã€‚é’ˆå¯¹å•ä¾‹æ¨¡å¼ï¼Œjavaä¸­åˆå‡ºç°äº†é¥¿æ±‰æ¨¡å¼ã€æ‡’æ±‰æ¨¡å¼ï¼Œå†é…åˆsynchronizedåŒæ­¥å…³é”®å­—æ¥å®ç°ã€‚å…¶ç›®çš„æ— éå°±æ˜¯å°†å¯¹è±¡åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œè€Œä¸”æœ€å¥½ä¿è¯åœ¨ç”¨åˆ°çš„æ—¶å€™å†è¿›è¡Œåˆå§‹åŒ–ï¼Œä»¥é¿å…åˆå§‹åŒ–å¤ªæ—©æµªè´¹èµ„æºï¼Œæˆ–è€…ä¸¤æ¬¡åˆå§‹åŒ–ç ´åå•ä¾‹æ¨¡å¼çš„å®ä¾‹å”¯ä¸€æ€§ã€‚\nGoè¯­è¨€çš„syncåŒ…ä¸­æä¾›äº†ä¸€ä¸ªOnceç±»å‹æ¥ä¿è¯å…¨å±€çš„å”¯ä¸€æ€§æ“ä½œï¼Œå…¶é€šè¿‡Do(f func())æ–¹æ³•æ¥å®ç°ï¼Œå³ä½¿ f å‡½æ•°å‘ç”Ÿå˜åŒ–ï¼Œå…¶ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå°ä¾‹å­ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) var once sync.Once func main() { //onceå¾ªç¯è°ƒç”¨firstMethodå‡½æ•°10æ¬¡,å…¶å®åªæ‰§è¡Œä¸€æ¬¡ for i := 0; i \u0026lt; 10; i { once.Do(firstMethod) fmt.Println(\u0026#34;count:---\u0026#34;, i) } //èµ·10ä¸ªåç¨‹,è™½ç„¶ç”¨onceå»è°ƒsecondMethodå‡½æ•°,ä½†è¯¥å‡½æ•°ä¸ä¼šè¢«æ‰§è¡Œ //åªæ‰“å°------i for i := 0; i \u0026lt; 10; i { go func(i int) { once.Do(secondMethod) fmt.Println(\u0026#34;-----\u0026#34;, i) }(i) } //ä¸»åç¨‹ç­‰1min,ç­‰ä¸Šé¢çš„10ä¸ªåç¨‹æ‰§è¡Œå®Œ time.Sleep(1 * time.Second) } func firstMethod() { fmt.Println(\u0026#34;firstMethod\u0026#34;) } func secondMethod() { fmt.Println(\u0026#34;secondMethod\u0026#34;) } è¿è¡Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ç»“æœï¼š\nfirstMethod count:--- 0 count:--- 1 count:--- 2 count:--- 3 count:--- 4 count:--- 5 count:--- 6 count:--- 7 count:--- 8 count:--- 9 ----- 0 ----- 2 ----- 4 ----- 5 ----- 8 ----- 6 ----- 9 ----- 3 ----- 7 ----- 1 Process finished with exit code 0 ç„¶åæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š\nç¨‹åºä¸­é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªåä¸ºonceçš„sync.Onceç±»å‹ï¼Œç„¶åmainå‡½æ•°ä¸­ç¬¬ä¸€ä¸ªforå¾ªç¯10æ¬¡ï¼Œä½†æ˜¯ç”±äºonce.Do(f func)ä¸­çš„få‡½æ•°å…¨å±€åªæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥firstMethod()å‡½æ•°åªè¢«æ‰§è¡Œä¸€æ¬¡ï¼›ä¹‹åè¿›å…¥ç¬¬äºŒä¸ªforå¾ªç¯ï¼Œè¿™é‡Œonce.Do(f func)æ–¹æ³•çš„å‚æ•°å˜ä¸ºsecondMethodå‡½æ•°ã€‚èµ·10ä¸ªåç¨‹å»è°ƒï¼Œä½†ç”±äºonce.Do(secondMethod)å’Œonce.Do(firstMethod)ç”¨çš„æ˜¯Onceç±»å‹çš„åŒä¸€ä¸ªå®ä¾‹ï¼Œæ‰€ä»¥secondMethodå‡½æ•°å®é™…ä¸Šä¸ä¼šè¢«æ‰§è¡Œã€‚è¿™è§£é‡Šäº†ä¸Šé¢è¿è¡Œç»“æœè¾“å‡ºã€‚\næŸ¥çœ‹æºä»£ç once.goï¼Œé‡Œé¢æœ‰è¿™æ ·çš„è§£é‡Šï¼š\nif once.Do(f) is called multiple times, only the first call will invoke f,\neven if f has a different value in each invocation. A new instance of\nOnce is required for each function to execute.\nå¤§æ¦‚æ„æ€æ˜¯ï¼šå¦‚æœonce.Do(f)è¢«è°ƒç”¨å¤šæ¬¡ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨æ‰ä¼šæ‰§è¡Œfå‡½æ•°ï¼Œå³ä½¿fæ˜¯ä¸åŒçš„å‡½æ•°ã€‚ä¸ºäº†æ¯ä¸€ä¸ªå‡½æ•°éƒ½è¢«æ‰§è¡Œï¼Œå°±éœ€è¦ä¸åŒçš„Onceå®ä¾‹ã€‚\næˆ‘ä»¬æŸ¥çœ‹Onceç±»å‹çš„å®šä¹‰ï¼š\ntype Once struct { m Mutex done uint32 } æºç ä¸­å…¶å®ç”¨åˆ°äº†äº’æ–¥é”må’Œæ ‡å¿—ä½doneã€‚ç„¶åå†çœ‹Doæ–¹æ³•çš„å®ç°ï¼š\nfunc (o *Once) Do(f func()) { if atomic.LoadUint32(\u0026amp;o.done) == 1 { return } // Slow-path. o.m.Lock() defer o.m.Unlock() if o.done == 0 { defer atomic.StoreUint32(\u0026amp;o.done, 1) f() } } æ¯æ¬¡è°ƒç”¨Doæ–¹æ³•ä¹‹å‰ï¼Œç”¨atomicåŒ…çš„LoadUint32å‡½æ•°è·å–æ ‡å¿—ä½doneçš„å€¼ï¼Œç­‰äº1åˆ™è¯´æ˜Doæ–¹æ³•å·²ç»è¢«è°ƒç”¨è¿‡ï¼Œç›´æ¥returnï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚å¦åˆ™åˆ©ç”¨äº’æ–¥é”ï¼Œä¿è¯åç¨‹å®‰å…¨çš„å»è°ƒç”¨få‡½æ•°ï¼Œä¹‹åæŠŠæ ‡å¿—ä½doneç½®ä¸º1ã€‚\nä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæ¥å®ç°å•å®ä¾‹ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) var once sync.Once var mmp map[int]string func main() { for i := 0; i \u0026lt; 10; i { go func(i int) { once.Do(func (){ mmp = make(map[int]string, 10) }) fmt.Printf(\u0026#34;-----%d------%p\\n\u0026#34;, i, \u0026amp;mmp) }(i) } //ä¸»åç¨‹ç­‰1min,ç­‰ä¸Šé¢çš„10ä¸ªåç¨‹æ‰§è¡Œå®Œ time.Sleep(1 * time.Second) } æˆ‘ä»¬èµ·10ä¸ªåç¨‹å»ç«äº‰åˆå§‹åŒ–ç±»å‹ä¸ºå­—å…¸ç±»å‹çš„mmpï¼Œç„¶åæ‰“å°æ¯æ¬¡mmpçš„åœ°å€ï¼Œè¿è¡Œè¾“å‡ºå¦‚ä¸‹ï¼š\n-----1------0x50cca0 -----3------0x50cca0 -----2------0x50cca0 -----4------0x50cca0 -----7------0x50cca0 -----6------0x50cca0 -----8------0x50cca0 -----9------0x50cca0 -----5------0x50cca0 -----0------0x50cca0 Process finished with exit code 0 æˆ‘ä»¬å¯ä»¥çœ‹åˆ°mmpæ¯æ¬¡åœ°å€éƒ½ä¸€æ ·ã€‚å¦‚æ­¤å°±è½»æ¾ä¼˜é›…å°±å®ç°äº†å’Œjavaå•ä¾‹æ¨¡å¼ç›¸ä¼¼çš„æ•ˆæœã€‚\næ¨èæ–‡ç« ï¼š\njavaå•ä¾‹æ¨¡å¼\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E5%88%A9%E7%94%A8golang%E4%BC%98%E9%9B%85%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8D%95%E5%AE%9E%E4%BE%8B/","section":"Posts","summary":"\u003cp\u003eå¹³æ—¶ç¼–å†™ä»£ç è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°å¯¹äºå…¨å±€è§’åº¦åªéœ€è¿è¡Œä¸€æ¬¡çš„ä»£ç ï¼Œæ¯”å¦‚å…¨å±€åˆå§‹åŒ–æ“ä½œï¼Œè®¾è®¡æ¨¡å¼ä¸­çš„å•ä¾‹æ¨¡å¼ã€‚é’ˆå¯¹å•ä¾‹æ¨¡å¼ï¼Œ\u003cstrong\u003ejava\u003c/strong\u003eä¸­åˆå‡ºç°äº†é¥¿æ±‰æ¨¡å¼ã€æ‡’æ±‰æ¨¡å¼ï¼Œå†é…åˆ\u003cstrong\u003esynchronized\u003c/strong\u003eåŒæ­¥å…³é”®å­—æ¥å®ç°ã€‚å…¶ç›®çš„æ— éå°±æ˜¯å°†å¯¹è±¡åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œè€Œä¸”æœ€å¥½ä¿è¯åœ¨ç”¨åˆ°çš„æ—¶å€™å†è¿›è¡Œåˆå§‹åŒ–ï¼Œä»¥é¿å…åˆå§‹åŒ–å¤ªæ—©æµªè´¹èµ„æºï¼Œæˆ–è€…ä¸¤æ¬¡åˆå§‹åŒ–ç ´åå•ä¾‹æ¨¡å¼çš„å®ä¾‹å”¯ä¸€æ€§ã€‚\u003c/p\u003e","title":"åˆ©ç”¨golangä¼˜é›…çš„å®ç°å•å®ä¾‹","type":"posts"},{"content":"å°å¼ºæœ€è¿‘åœ¨é¡¹ç›®ä¸­é‡åˆ°äº†ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼šåœ¨æ•´æ”¹æ—¥å¿—è§„èŒƒæ—¶ï¼Œä¸ºäº†é¿å…å½±å“ç°æœ‰çš„ä»£ç ç»“æ„ä»¥åŠæ”¹åŠ¨å°½å¯èƒ½å°çš„å‰æä¸‹ï¼Œåœ¨è°ƒç”¨è®°æ—¥å¿—çš„SDKå¤„å°†æŸä¸€ä¸ªå­—æ®µå€¼é¦–å­—æ¯æ”¹ä¸ºå¤§å†™ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š\nfmt.Println(\u0026#34;--------SayHello begin------------\u0026#34;) //é¡¹ç›®ä¸­è¿™é‡Œçš„aå®é™…æ˜¯ä½œä¸ºå‚æ•°ä¼ å…¥,åªæ˜¯å¯èƒ½ä¸ºç©ºä¸²,ä¸ä¸ºç©ºä¸²,è¿™æ ·å†™è‚¯å®šæ²¡é—®é¢˜ a := \u0026#34;\u0026#34; b := strings.ToUpper(a[:1]) a[1:] fmt.Println(\u0026#34;b is \u0026#34;, b) fmt.Println(\u0026#34;--------SayHello end------------\u0026#34;) this.Ctx.Output.Body(this.Ctx.Input.RequestBody) é¡¹ç›®ä¸­è¿™é‡Œçš„aå˜é‡å…¶å®æ˜¯ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œåªæ˜¯å¯èƒ½ä¸ºç©ºä¸²ã€‚aå˜é‡ä¸ä¸ºç©ºä¸²æ—¶ï¼Œè¿™æ ·å†™è‚¯å®šæ²¡é—®é¢˜ã€‚ä½†æ˜¯å½“ä¸ºç©ºä¸²æ—¶ï¼Œå³\u0026quot;\u0026ldquo;æ—¶ï¼Œå°±ä¼šå‡ºé—®é¢˜ï¼Œåœ¨javaä¸­ï¼Œè¿è¡Œçš„æ—¶å€™è‚¯å®šä¼šæŠ¥ä¸€ä¸ªâ€œæ•°ç»„ä¸‹è¡¨è¶Šç•Œâ€çš„å¼‚å¸¸ã€‚å°å¼ºå°†å·¥ç¨‹ç¼–è¯‘åç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¾åˆ°æœåŠ¡å™¨ä¸Šè·‘ï¼Œæµ‹è¯•ä¿®æ”¹åçš„æ—¥å¿—æ˜¯å¦ç¬¦åˆè§„èŒƒï¼ŒéªŒäº†ä¸€éï¼Œæ²¡æœ‰é—®é¢˜ï¼Œç„¶åå°±å°†ä»£ç æäº¤äº†ã€‚\nä¹‹åç‰ˆæœ¬å‡ºæ¥æµ‹è¯•æ—¶å‘ç°ï¼Œæœ‰ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼šæ¥å£ä¸è¿”å›ä»»ä½•ä¸œè¥¿ï¼ŒçŠ¶æ€ç ä¾ç„¶æ˜¯ 200 OKã€‚è¿™è®©å°å¼ºå¾ˆçº³é—·å„¿ï¼Œè¿˜å¥½ï¼Œæˆ‘ä»¬çš„å°å¼ºç»éªŒä¸°å¯Œï¼Œè¿˜æ˜¯è§£å†³è¿‡å¤§bugçš„äººï¼Œç„¶åå°±æ ¹æ®æ¥å£èµ°äº†ä¸€éä»£ç æµç¨‹ï¼Œçœ‰å¤´ä¸€çš±ï¼Œå°±çŸ¥é“é—®é¢˜æ‰€åœ¨äº†ã€‚åŸæ¥å°±æ˜¯aå˜é‡æœ‰æ—¶å€™ä¼ è¿›æ¥æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œå¯¼è‡´å‡ºç°äº†sliceä¸‹æ ‡è¶Šç•Œçš„panicï¼Œè¯´å¹²å°±å¹²ï¼Œå°å¼ºèµ¶ç´§åšäº†ç©ºä¸²çš„åˆ¤æ–­é€»è¾‘ï¼Œé‡æ–°éªŒäº†ä¸€æŠŠï¼Œé—®é¢˜å°±è§£å†³äº†ã€‚\nå°å¼ºæ˜¯çˆ±æ€è€ƒçš„å­©å­ï¼Œä¸æ­¢è¦è§£å†³é—®é¢˜ï¼Œä¹Ÿè¦çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚å°å¼ºåœ¨æƒ³ï¼Œå‡ºç°äº†panicå’‹æ—¥å¿—é‡Œé¢å•¥éƒ½ä¸æ‰“å‘¢ï¼Œè€Œä¸”è¿˜è¿”å›200ï¼Œç”šæ˜¯ç–‘æƒ‘ã€‚ç„¶åå°±åœ¨ç½‘ä¸ŠæŸ¥èµ„æ–™ï¼Œç„¶åè‡ªå·±åˆçœ‹äº†beegoçš„æºç ï¼Œå°±æ˜ç™½äº†ã€‚ä¸å¾—ä¸è¯´ï¼Œå¼€æºå°±æ˜¯å¥½å•Šã€‚\nåŸæ¥é—®é¢˜æ˜¯è¿™æ ·ï¼Œå°å¼ºé¡¹ç›®ä¸­ä½¿ç”¨çš„beegoç‰ˆæœ¬æ˜¯1.6.1ç‰ˆã€‚\nå°å¼ºæŸ¥åˆ°äº†beegoçš„é”™è¯¯å¤„ç†æµç¨‹ï¼šbeegoé€šè¿‡beego.App.Server.Handlerå¤„ç†æ‰€æœ‰çš„HTTPè¯·æ±‚ï¼Œåœ¨beego.Run()å‡½æ•°ä¸­ï¼Œè¿™ä¸ªHandlerå°±è¢«è®¾ç½®ä¸ºapp.Handlersï¼Œå¯ä»¥å‚è§beego1.6.1ç‰ˆæœ¬app.goçš„ç¬¬95è¡Œï¼š\napp.Server.Handler = app.Handlers è€Œappåœ¨ä¸€å¼€å§‹å°±è¢«åˆå§‹åŒ–ï¼Œå¯ä»¥çœ‹app.goä¸­çš„init()å‡½æ•°ï¼Œå…¶ä¸­è°ƒç”¨äº†NewApp()å‡½æ•°ï¼š\n// NewApp returns a new beego application. func NewApp() *App { cr := NewControllerRegister() app := \u0026amp;App{Handlers: cr, Server: \u0026amp;http.Server{}} return app } å¯ä»¥çœ‹å‡ºï¼ŒæŠŠcrèµ‹å€¼ç»™Handlerï¼Œå…¶å®cræ˜¯ControllerRegisterç±»å‹ï¼ŒControllerRegisterç±»å‹å®ç°äº†http.Handleræ¥å£ï¼Œå…·ä½“å®ç°å¯ä»¥çœ‹router.goçš„ç¬¬600è¡ŒServeHTTPæ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸­ï¼ˆç¬¬612è¡Œï¼‰æœ‰å¦‚ä¸‹è¯­å¥ï¼š\ndefer p.recoverPanic(context) golangè¯­è¨€çš„é”™è¯¯å¤„ç†æœºåˆ¶æ˜¯ï¼Œå½“åœ¨æŸå¤„è°ƒç”¨panic(string)åï¼Œpanicä¹‹åçš„è¯­å¥å°†ä¸å†æ‰§è¡Œï¼Œè€Œæ˜¯é€šè¿‡è°ƒç”¨å…³ç³»é€çº§é€€å‡ºï¼Œåœ¨æ¯ä¸€çº§è°ƒç”¨å¤„éƒ½é€šè¿‡deferå¤„ç†å‡½æ•°æ£€æŸ¥æ˜¯å¦panicè¢«recover()å‡½æ•°æ•è·å¤„ç†ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç»§ç»­å¾€ä¸Šæ‰”panicä¿¡æ¯ï¼Œå¦‚æœå·²ç»è¢«æ•è·åˆ™ç»“æŸæ­¤æ¬¡panicè¿‡ç¨‹ï¼Œç”±æ•è·panicçš„å‡½æ•°å¤„ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚\nå‡ºç°å¼‚å¸¸ä¼šæ‰§è¡ŒrecoverPanicæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­ï¼ˆç¬¬864è¡Œï¼‰æœ‰è¿™æ ·çš„ä»£ç æ®µï¼š\nif BConfig.RunMode == DEV { showErr(err, context, stack) } showErrå‡½æ•°ä¸­ä¼šå¯¹é”™è¯¯è¿›è¡Œæ¨¡æ¿æ¸²æŸ“ï¼Œè€Œå°å¼ºé¡¹ç›®æ—©åœ¨ç°ç½‘ä¸­æŠ•å…¥ä½¿ç”¨ï¼ŒRunModeä¸ºprodï¼Œè€Œédevï¼Œæ‰€ä»¥recover()åä¸ä¼šæœ‰é”™è¯¯æç¤ºã€‚\nå½“RunModeä¸ºprodæ—¶ï¼š\nå½“RunModeä¸ºprodæ—¶ï¼š\ndevæ¨¡å¼å¥½æ­¹ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼šslice bounds out of range\nprodæ¨¡å¼æ²¡æœ‰ä»»ä½•æç¤ºã€‚ä¸‹æ ‡è¶Šç•Œè¿™ç§é—®é¢˜çœ‹ä¼¼ç®€å•ï¼Œä½†æ˜¯çœŸæ­£é‡åˆ°äº†æœ‰æ—¶å€™ä¹Ÿä¼šæ‘¸ä¸ç€å¤´è„‘ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E4%B8%80%E4%B8%AA%E7%A5%9E%E7%A7%98%E7%8E%B0%E8%B1%A1%E5%BC%95%E5%8F%91%E5%AF%B9beego%E6%A1%86%E6%9E%B6%E7%9A%84%E6%80%9D%E8%80%83/","section":"Posts","summary":"\u003cp\u003eå°å¼ºæœ€è¿‘åœ¨é¡¹ç›®ä¸­é‡åˆ°äº†ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼šåœ¨æ•´æ”¹æ—¥å¿—è§„èŒƒæ—¶ï¼Œä¸ºäº†é¿å…å½±å“ç°æœ‰çš„ä»£ç ç»“æ„ä»¥åŠæ”¹åŠ¨å°½å¯èƒ½å°çš„å‰æä¸‹ï¼Œåœ¨è°ƒç”¨è®°æ—¥å¿—çš„SDKå¤„å°†æŸä¸€ä¸ªå­—æ®µå€¼é¦–å­—æ¯æ”¹ä¸ºå¤§å†™ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š\u003c/p\u003e","title":"ä¸€ä¸ªç¥ç§˜ç°è±¡å¼•å‘å¯¹beegoæ¡†æ¶çš„æ€è€ƒ","type":"posts"},{"content":"æˆ‘ä»¬å‰ä¸¤èŠ‚è¯¾çˆ¬å–ççˆ±ç½‘çš„æ—¶å€™ï¼Œç”¨åˆ°äº†å¾ˆå¤šæ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…åŸå¸‚åˆ—è¡¨ã€åŸå¸‚ã€ç”¨æˆ·ä¿¡æ¯ï¼Œå…¶å®é™¤äº†æ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…ï¼Œè¿˜å¯ä»¥åˆ©ç”¨goqueryå’Œxpathç¬¬ä¸‰æ–¹åº“åŒ¹é…æœ‰ç”¨ä¿¡æ¯ã€‚è€Œæˆ‘åˆ©ç”¨äº†æ›´ä¼˜é›…çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚ä¸‹æ¥å¤§æ¦‚ä»‹ç»ä¸‹æ­£åˆ™è¡¨è¾¾å¼ã€‚\næ¯”å¦‚æˆ‘ä»¬åŒ¹é…åŸå¸‚åˆ—è¡¨çš„æ—¶å€™ï¼Œä¼šå–åŒ¹é…æ‰€æœ‰åŸå¸‚çš„urlï¼Œå¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹åˆ°å›¾ç‰‡åæ˜¯å°å†™å­—æ¯åŠ æ•°å­—ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼æå–ï¼š\n\u0026lt;a href=\u0026#34;(http://www.zhenai.com/zhenghun/[0-9a-z] )\u0026#34;[^\u0026gt;]*\u0026gt;([^\u0026lt;] )\u0026lt;/a\u0026gt; [0-9a-z] è¡¨ç¤ºåŒ¹é…å°å†™å­—æ¯æˆ–è€…æ•°å­—è‡³å°‘ä¸€æ¬¡ï¼Œ[^\u0026gt;]*è¡¨ç¤ºåŒ¹é…é\u0026gt;çš„å­—ç¬¦ä»»æ„æ¬¡ï¼Œç„¶å[^\u0026lt;] è¡¨ç¤ºåŒ¹é…é\u0026lt;å­—ç¬¦è‡³å°‘ä¸€æ¬¡ã€‚æˆ‘ä»¬è¦å–åˆ°åŸå¸‚çš„urlå’ŒåŸå¸‚åï¼Œæ‰€ä»¥å¯¹è¿›è¡Œäº†åˆ†ç»„ã€‚\né€šè¿‡ä»¥ä¸‹æ–¹å¼å°±å¯ä»¥æ‹¿åˆ°urlå’Œcity\nconst ( cityListReg = `\u0026lt;a href=\u0026#34;(http://www.zhenai.com/zhenghun/[0-9a-z] )\u0026#34;[^\u0026gt;]*\u0026gt;([^\u0026lt;] )\u0026lt;/a\u0026gt;` ) compile := regexp.MustCompile(cityListReg) submatch := compile.FindAllSubmatch(contents, -1) for _, m := range submatch { fmt.Println(\u0026#34;url:\u0026#34; , string(m[1]), \u0026#34;city:\u0026#34;, string(m[2])) } åŒ¹é…åŒ…å«g g,ä¸”ggä¸­é—´è‡³å°‘ä¸€ä¸ªå°å†™å­—æ¯ï¼š\n//åŒ¹é…åŒ…å«g g,ä¸”ggä¸­é—´è‡³å°‘ä¸€ä¸ªå°å†™å­—æ¯ match, _ := regexp.MatchString(\u0026#34;g([a-z] )g\u0026#34;, \u0026#34;11golang11\u0026#34;) //true fmt.Println(match) ä¸Šé¢æˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº†å­—ç¬¦ä¸²åŒ¹é…çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½†æ˜¯å¯¹äºå…¶ä»–çš„æ­£åˆ™åŒ¹é…ä»»åŠ¡ï¼Œéœ€è¦ä½¿ç”¨ä¸€ä¸ªä¼˜åŒ–è¿‡çš„æ­£åˆ™å¯¹è±¡ï¼š\ncompile, err := regexp.Compile(\u0026#34;smallsoup@gmail.com\u0026#34;) if err != nil { //....æ­£åˆ™è¯­æ³•é”™è¯¯ï¼Œéœ€è¦å¤„ç†é”™è¯¯ fmt.Println(err) } //smallsoup@gmail.com fmt.Println(compile.FindString(text)) compile, err :=regexp.Compile(\u0026ldquo; smallsoup@gmail.com\u0026rdquo;)\nå‡½æ•°è¿”å›ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å™¨å’Œé”™è¯¯ï¼Œå½“å‚æ•°æ­£åˆ™è¡¨è¾¾å¼ä¸ç¬¦åˆæ­£åˆ™è¯­æ³•æ—¶è¿”å›errorï¼Œæ¯”å¦‚è¯´regexp.Compile(\u0026quot;[smallsoup@gmail.com\u0026quot;)å°±ä¼šæŠ¥é”™missing closing ]\nä¸€èˆ¬æ­£åˆ™è¡¨è¾¾å¼æ˜¯ç”¨æˆ·è¾“å…¥çš„æ‰éœ€è¦å¤„ç†é”™è¯¯ï¼Œè€Œè‡ªå·±å†™çš„ä¸€èˆ¬æ˜¯ä¸ä¼šæœ‰é”™çš„ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨compile:= regexp.MustCompile(\u0026ldquo; smallsoup@gmail.com\u0026rdquo;)ï¼Œå¦‚æœè¯­æ³•é”™è¯¯ï¼Œå°±ä¼šå‘ç”Ÿpanicã€‚\ntext1 := `my email is aa@qq.com aa email is aa@gmail.com bb email is bb@qq.com cc email is cc@qq.com.cn ` //å¦‚æœè¦æå–A@B.Cä¸­çš„Aã€Bã€Cï¼Œéœ€è¦ç”¨åˆ°æ­£åˆ™è¡¨è¾¾å¼çš„æå–åŠŸèƒ½ã€‚ comp := regexp.MustCompile(`([a-zA-Z0-9] )@([a-zA-Z0-9.] )\\.([a-zA-Z0-9] )`) //åˆ©ç”¨è‡ªåŒ¹é…è·å–æ­£åˆ™è¡¨è¾¾å¼é‡Œæ‹¬å·ä¸­çš„åŒ¹é…å†…å®¹ submatchs := comp.FindAllStringSubmatch(text1, -1) //submatchså…¶å®æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ fmt.Println(submatchs) //å»é™¤æ¯ä¸ªåŒ¹é…,submatchå…¶å®è¿˜æ˜¯ä¸ªslice for _, submatch := range submatchs { fmt.Println(submatch) } ç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š\n[[aa@qq.com aa qq com] [aa@gmail.com aa gmail com] [bb@qq.com bb qq com] [cc@qq.com.cn cc qq.com cn]] [aa@qq.com aa qq com] [aa@gmail.com aa gmail com] [bb@qq.com bb qq com] [cc@qq.com.cn cc qq.com cn] r := regexp.MustCompile(\u0026#34;p([a-z] )ch\u0026#34;) fmt.Println(r) //-----\u0026gt;p([a-z] )ch //regexp åŒ…ä¹Ÿå¯ä»¥ç”¨æ¥æ›¿æ¢éƒ¨åˆ†å­—ç¬¦ä¸²ä¸ºå…¶ä»–å€¼ã€‚ fmt.Println(r.ReplaceAllString(\u0026#34;a peach\u0026#34;, \u0026#34;\u0026lt;smallsoup\u0026gt;\u0026#34;)) //-----\u0026gt;a \u0026lt;smallsoup\u0026gt; //Func å˜é‡å…è®¸ä¼ é€’åŒ¹é…å†…å®¹åˆ°ä¸€ä¸ªç»™å®šçš„å‡½æ•°ä¸­ï¼Œ in := []byte(\u0026#34;a smallsoup\u0026#34;) out := r.ReplaceAllFunc(in, bytes.ToUpper) fmt.Println(string(out)) //-----\u0026gt;a PEACH /*#######################å¸¸è§è¡¨è¾¾å¼###########################*/ // æŸ¥æ‰¾æ±‰å­— testText := \u0026#34;Hello ä½ å¥½å—, I like golang!\u0026#34; reg := regexp.MustCompile(`[\\p{Han}] `) fmt.Println(reg.FindAllString(testText, -1)) // -----\u0026gt;[ä½ å¥½] reg = regexp.MustCompile(`[\\P{Han}] `) fmt.Println(reg.FindAllString(testText, -1)) // -----\u0026gt;[\u0026#34;Hello \u0026#34; \u0026#34;, I li golang!\u0026#34;] fmt.Printf(\u0026#34;%q\\n\u0026#34;, reg.FindAllString(testText, -1)) // -----\u0026gt;[\u0026#34;Hello \u0026#34; \u0026#34;, I lm golang!\u0026#34;] //Email reg = regexp.MustCompile(`\\w ([- .]\\w )*@\\w ([-.]\\w )*\\.\\w ([-.]\\w )*`) fmt.Println(reg.MatchString(\u0026#34;smallsoup@qq.com\u0026#34;)) //ç”¨æˆ·åå¯†ç ï¼š reg = regexp.MustCompile(`[a-zA-Z]|\\w{6,18}`) fmt.Println(reg.MatchString(\u0026#34;w_dy_246\u0026#34;)) è¿è¡Œç»“æœå¦‚ä¸‹ï¼š\np([a-z] )ch a \u0026lt;smallsoup\u0026gt; a smallsoup [ä½ å¥½å—] [Hello , I like golang!] [\u0026#34;Hello \u0026#34; \u0026#34;, I like golang!\u0026#34;] true true Process finished with exit code 0 ","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/go%E8%AF%AD%E8%A8%80%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/","section":"Posts","summary":"\u003cp\u003eæˆ‘ä»¬å‰ä¸¤èŠ‚è¯¾çˆ¬å–ççˆ±ç½‘çš„æ—¶å€™ï¼Œç”¨åˆ°äº†å¾ˆå¤šæ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…åŸå¸‚åˆ—è¡¨ã€åŸå¸‚ã€ç”¨æˆ·ä¿¡æ¯ï¼Œå…¶å®é™¤äº†æ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…ï¼Œè¿˜å¯ä»¥åˆ©ç”¨goqueryå’Œxpathç¬¬ä¸‰æ–¹åº“åŒ¹é…æœ‰ç”¨ä¿¡æ¯ã€‚è€Œæˆ‘åˆ©ç”¨äº†æ›´ä¼˜é›…çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚ä¸‹æ¥å¤§æ¦‚ä»‹ç»ä¸‹æ­£åˆ™è¡¨è¾¾å¼ã€‚\u003c/p\u003e","title":"goè¯­è¨€æ­£åˆ™è¡¨è¾¾å¼","type":"posts"},{"content":"","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/tags/%E7%88%AC%E8%99%AB/","section":"Tags","summary":"","title":"çˆ¬è™«","type":"tags"},{"content":" æˆ‘ä»¬æ¥ç”¨goè¯­è¨€çˆ¬å–â€œççˆ±ç½‘â€ç”¨æˆ·ä¿¡æ¯ã€‚\né¦–å…ˆåˆ†æåˆ°è¯·æ±‚urlä¸ºï¼š\nhttp://www.zhenai.com/zhenghun\næ¥ä¸‹æ¥ç”¨goè¯·æ±‚è¯¥urlï¼Œä»£ç å¦‚ä¸‹ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { //è¿”é€è¯·æ±‚è·å–è¿”å›ç»“æœ resp, err := http.Get(\u0026#34;http://www.zhenai.com/zhenghun\u0026#34;) if err != nil { panic(fmt.Errorf(\u0026#34;Error: http Get, err is %v\\n\u0026#34;, err)) } //å…³é—­response body defer resp.Body.Close() if resp.StatusCode != http.StatusOK { fmt.Println(\u0026#34;Error: statuscode is \u0026#34;, resp.StatusCode) return } body, err := ioutil.ReadAll(resp.Body) if err != nil { fmt.Println(\u0026#34;Error read body, error is \u0026#34;, err) } //æ‰“å°è¿”å›å€¼ fmt.Println(\u0026#34;body is \u0026#34;, string(body)) } è¿è¡Œåä¼šå‘ç°è¿”å›ä½“é‡Œæœ‰å¾ˆå¤šä¹±ç ï¼š\nåœ¨è¿”å›ä½“é‡Œå¯ä»¥æ‰¾åˆ° å³ç¼–ç ä¸ºgbkï¼Œè€Œgoé»˜è®¤ç¼–ç ä¸ºutf-8ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç°ä¹±ç ã€‚æ¥ä¸‹æ¥ç”¨ç¬¬ä¸‰æ–¹åº“å°†å…¶ç¼–ç æ ¼å¼è½¬ä¸ºutf-8ã€‚\nç”±äºè®¿é—®golang.org/x/textéœ€è¦æ¢¯å­ï¼Œä¸ç„¶æŠ¥é”™ï¼š\næ‰€ä»¥åœ¨githubä¸Šä¸‹è½½ï¼š\nmkdir -p $GOPATH/src/golang.org/x cd $GOPATH/src/golang.org/x git clone https://github.com/golang/text.git ç„¶åå°†gbkç¼–ç è½¬æ¢ä¸ºutf-8ï¼Œéœ€è¦ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š\nutf8Reader := transform.NewReader(resp.Body, simplifiedchinese.GBK.NewDecoder()) body, err := ioutil.ReadAll(utf8Reader) è€ƒè™‘åˆ°é€šç”¨æ€§ï¼Œè¿”å›çš„ç¼–ç æ ¼å¼ä¸ä¸€å®šæ˜¯gbkï¼Œæ‰€ä»¥éœ€è¦å¯¹å®é™…ç¼–ç åšåˆ¤æ–­ï¼Œç„¶åå°†åˆ¤æ–­ç»“æœè½¬ä¸ºutf-8ï¼Œéœ€è¦ç”¨åˆ°ç¬¬ä¸‰æ–¹åº“golang.org/x/net/htmlï¼ŒåŒæ ·çš„åœ¨githubä¸Šä¸‹è½½ï¼š\nmkdir -p $GOPATH/src/golang.org/x cd $GOPATH/src/golang.org/x git clone https://github.com/golang/net é‚£ä¹ˆä»£ç å°±å˜æˆè¿™æ ·ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;golang.org/x/text/transform\u0026#34; //\u0026#34;golang.org/x/text/encoding/simplifiedchinese\u0026#34; \u0026#34;io\u0026#34; \u0026#34;golang.org/x/text/encoding\u0026#34; \u0026#34;bufio\u0026#34; \u0026#34;golang.org/x/net/html/charset\u0026#34; ) func main() { //è¿”é€è¯·æ±‚è·å–è¿”å›ç»“æœ resp, err := http.Get(\u0026#34;http://www.zhenai.com/zhenghun\u0026#34;) if err != nil { panic(fmt.Errorf(\u0026#34;Error: http Get, err is %v\\n\u0026#34;, err)) } //å…³é—­response body defer resp.Body.Close() if resp.StatusCode != http.StatusOK { fmt.Println(\u0026#34;Error: statuscode is \u0026#34;, resp.StatusCode) return } //utf8Reader := transform.NewReader(resp.Body, simplifiedchinese.GBK.NewDecoder()) utf8Reader := transform.NewReader(resp.Body, determinEncoding(resp.Body).NewDecoder()) body, err := ioutil.ReadAll(utf8Reader) if err != nil { fmt.Println(\u0026#34;Error read body, error is \u0026#34;, err) } //æ‰“å°è¿”å›å€¼ fmt.Println(\u0026#34;body is \u0026#34;, string(body)) } func determinEncoding(r io.Reader) encoding.Encoding { //è¿™é‡Œçš„rè¯»å–å®Œå¾—ä¿è¯resp.Bodyè¿˜å¯è¯» body, err := bufio.NewReader(r).Peek(1024) if err != nil { fmt.Println(\u0026#34;Error: peek 1024 byte of body err is \u0026#34;, err) } //è¿™é‡Œç®€åŒ–,ä¸å–æ˜¯å¦ç¡®è®¤ e, _, _ := charset.DetermineEncoding(body, \u0026#34;\u0026#34;) return e } è¿è¡Œåå°±çœ‹ä¸åˆ°ä¹±ç äº†ï¼š\nä»Šå¤©å…ˆçˆ¬åˆ°è¿™é‡Œï¼Œæ˜å¤©å°†æå–è¿”å›ä½“ä¸­çš„åœ°å€URLå’ŒåŸå¸‚ï¼Œä¸‹ä¸€èŠ‚è§ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E7%94%A8go%E8%AF%AD%E8%A8%80%E7%88%AC%E5%8F%96%E7%8F%8D%E7%88%B1%E7%BD%91%E7%AC%AC%E4%B8%80%E5%9B%9E/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://cdn.jsdelivr.net/gh/smallersoup/jsDelivr-cdn@main/blog/article/csdnimg/20191018002129589.jpeg\" alt=\"image\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬æ¥ç”¨goè¯­è¨€çˆ¬å–â€œççˆ±ç½‘â€ç”¨æˆ·ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆåˆ†æåˆ°è¯·æ±‚urlä¸ºï¼š\u003c/p\u003e","title":"ç”¨goè¯­è¨€çˆ¬å–ççˆ±ç½‘ | ç¬¬ä¸€å›","type":"posts"},{"content":" æ˜¨å¤©æˆ‘ä»¬ä¸€èµ·çˆ¬å–ççˆ±ç½‘é¦–é¡µï¼Œæ‹¿åˆ°äº†åŸå¸‚åˆ—è¡¨é¡µé¢ï¼Œæ¥ä¸‹æ¥åœ¨è¿”å›ä½“åŸå¸‚åˆ—è¡¨ä¸­æå–åŸå¸‚å’Œurlï¼Œå³ä¸‹å›¾ä¸­çš„aæ ‡ç­¾é‡Œçš„hrefçš„å€¼å’ŒinnerTextå€¼ã€‚\næå–aæ ‡ç­¾ï¼Œå¯ä»¥é€šè¿‡CSSé€‰æ‹©å™¨æ¥é€‰æ‹©ï¼Œå¦‚ä¸‹ï¼š\n$(\u0026rsquo;#cityList\u0026gt;dd\u0026gt;a\u0026rsquo;);å°±å¯ä»¥è·å–åˆ°470ä¸ªaæ ‡ç­¾ï¼š\nè¿™é‡Œåªæä¾›ä¸€ä¸ªæ€è·¯ï¼Œgoè¯­è¨€æ ‡å‡†åº“é‡Œæ²¡æœ‰CSSè§£æåº“ï¼Œé€šè¿‡ç¬¬ä¸‰æ–¹åº“å¯ä»¥å®ç°ã€‚å…·ä½“å¯ä»¥å‚è€ƒæ–‡ç« ï¼š\nhttps://my.oschina.net/2xixi/blog/488811\nhttp://liyangliang.me/posts/2016/03/zhihu-go-insight-parsing-html-with-goquery/\nè¿™ä¸¤ç¯‡æ–‡ç« éƒ½æ˜¯ç”¨goqueryè§£æ HTMLï¼Œç”¨åˆ°äº†åº“ï¼š\nhttps://github.com/PuerkitoBio/goquery\nä¹Ÿå¯ä»¥ç”¨xpathå»è§£æhtmlï¼Œå¯ä»¥å‚è€ƒï¼š\nhttps://github.com/antchfx/xquery\nxpathå’Œgoqueryç›¸æ¯”è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œé€šè¿‡ä»¥ä¸‹è¿™å¼ å›¾å¯ä»¥çœ‹å‡ºæ¥goqueryè¦æ´»è·ƒçš„å¤šï¼š\næˆ‘ä»¬è¿™é‡Œä¸ç”¨xpathï¼Œä¹Ÿä¸ç”¨goqueryæå–ï¼Œç”¨æ›´åŠ é€šç”¨çš„æ­£åˆ™è¡¨è¾¾å¼æ¥æå–ã€‚\nä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œè¿”å›ä½“ä¸­çš„aæ ‡ç­¾é‡Œéƒ½æ˜¯è¿™ç§å½¢å¼ï¼ŒXXXè¡¨ç¤ºåŸå¸‚æ‹¼éŸ³ï¼ŒXXè¡¨ç¤ºåŸå¸‚ä¸­æ–‡ï¼Œå…¶ä»–çš„éƒ½ä¸€æ ·ã€‚\n\u0026lt;a href=\u0026#34;http://www.zhenai.com/zhenghun/XXX\u0026#34; class=\u0026#34;\u0026#34;\u0026gt;XX\u0026lt;/a\u0026gt; æ‰€ä»¥å¯ä»¥å†™å‡ºä»¥ä¸‹çš„æ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é…ï¼š\ncompile := regexp.MustCompile(`\u0026lt;a href=\u0026#34;http://www.zhenai.com/zhenghun/[0-9a-z] \u0026#34;[^\u0026gt;]*\u0026gt;[^\u0026lt;] \u0026lt;/a\u0026gt;`) æ­£åˆ™è¡¨è¾¾å¼è¯´æ˜ï¼š\n1ã€hrefçš„å€¼éƒ½ç±»ä¼¼http://www.zhenai.com/zhenghun/XX 2ã€XXå¯ä»¥æ˜¯æ•°å­—å’Œå°å†™å­—æ¯,æ‰€ä»¥[0-9a-z], è¡¨ç¤ºè‡³å°‘æœ‰ä¸€ä¸ª 3ã€[^\u0026gt;]*è¡¨ç¤ºåŒ¹é…ä¸æ˜¯\u0026gt;çš„å…¶ä»–å­—ç¬¦ä»»æ„æ¬¡ 4ã€[^\u0026lt;] è¡¨ç¤ºåŒ¹é…ä¸æ˜¯\u0026lt;çš„å…¶ä»–å­—ç¬¦è‡³å°‘ä¸€æ¬¡ ç„¶ååˆ©ç”¨åˆ†ç»„è·å–urlå’ŒåŸå¸‚ï¼Œä»£ç å¦‚ä¸‹ï¼š\nfunc printAllCityInfo(body []byte){ //hrefçš„å€¼éƒ½ç±»ä¼¼http://www.zhenai.com/zhenghun/XX //XXå¯ä»¥æ˜¯æ•°å­—å’Œå°å†™å­—æ¯,æ‰€ä»¥[0-9a-z], è¡¨ç¤ºè‡³å°‘æœ‰ä¸€ä¸ª //[^\u0026gt;]*è¡¨ç¤ºåŒ¹é…ä¸æ˜¯\u0026gt;çš„å…¶ä»–å­—ç¬¦ä»»æ„æ¬¡ //[^\u0026lt;] è¡¨ç¤ºåŒ¹é…ä¸æ˜¯\u0026lt;çš„å…¶ä»–å­—ç¬¦è‡³å°‘ä¸€æ¬¡ compile := regexp.MustCompile(`\u0026lt;a href=\u0026#34;(http://www.zhenai.com/zhenghun/[0-9a-z] )\u0026#34;[^\u0026gt;]*\u0026gt;([^\u0026lt;] )\u0026lt;/a\u0026gt;`) submatch := compile.FindAllSubmatch(body, -1) for _, matches := range submatch { //æ‰“å° fmt.Printf(\u0026#34;City:%s URL:%s\\n\u0026#34;, matches[2], matches[1]) } //å¯ä»¥çœ‹åˆ°åŒ¹é…ä¸ªæ•°ä¸º470ä¸ª fmt.Printf(\u0026#34;Matches count: %d\\n\u0026#34;, len(submatch)) } é‚£ä¹ˆæå–URLå’ŒCityçš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;golang.org/x/text/transform\u0026#34; //\u0026#34;golang.org/x/text/encoding/simplifiedchinese\u0026#34; \u0026#34;io\u0026#34; \u0026#34;golang.org/x/text/encoding\u0026#34; \u0026#34;bufio\u0026#34; \u0026#34;golang.org/x/net/html/charset\u0026#34; \u0026#34;regexp\u0026#34; ) func main() { //è¿”é€è¯·æ±‚è·å–è¿”å›ç»“æœ resp, err := http.Get(\u0026#34;http://www.zhenai.com/zhenghun\u0026#34;) if err != nil { panic(fmt.Errorf(\u0026#34;Error: http Get, err is %v\\n\u0026#34;, err)) } //å…³é—­response body defer resp.Body.Close() if resp.StatusCode != http.StatusOK { fmt.Println(\u0026#34;Error: statuscode is \u0026#34;, resp.StatusCode) return } //utf8Reader := transform.NewReader(resp.Body, simplifiedchinese.GBK.NewDecoder()) utf8Reader := transform.NewReader(resp.Body, determinEncoding(resp.Body).NewDecoder()) body, err := ioutil.ReadAll(utf8Reader) if err != nil { fmt.Println(\u0026#34;Error read body, error is \u0026#34;, err) } printAllCityInfo(body) //æ‰“å°è¿”å›å€¼ //fmt.Println(\u0026#34;body is \u0026#34;, string(body)) } func determinEncoding(r io.Reader) encoding.Encoding { //è¿™é‡Œçš„rè¯»å–å®Œå¾—ä¿è¯resp.Bodyè¿˜å¯è¯» body, err := bufio.NewReader(r).Peek(1024) if err != nil { fmt.Println(\u0026#34;Error: peek 1024 byte of body err is \u0026#34;, err) } //è¿™é‡Œç®€åŒ–,ä¸å–æ˜¯å¦ç¡®è®¤ e, _, _ := charset.DetermineEncoding(body, \u0026#34;\u0026#34;) return e } func printAllCityInfo(body []byte){ //hrefçš„å€¼éƒ½ç±»ä¼¼http://www.zhenai.com/zhenghun/XX //XXå¯ä»¥æ˜¯æ•°å­—å’Œå°å†™å­—æ¯,æ‰€ä»¥[0-9a-z], è¡¨ç¤ºè‡³å°‘æœ‰ä¸€ä¸ª //[^\u0026gt;]*è¡¨ç¤ºåŒ¹é…ä¸æ˜¯\u0026gt;çš„å…¶ä»–å­—ç¬¦ä»»æ„æ¬¡ //[^\u0026lt;] è¡¨ç¤ºåŒ¹é…ä¸æ˜¯\u0026lt;çš„å…¶ä»–å­—ç¬¦è‡³å°‘ä¸€æ¬¡ compile := regexp.MustCompile(`\u0026lt;a href=\u0026#34;(http://www.zhenai.com/zhenghun/[0-9a-z] )\u0026#34;[^\u0026gt;]*\u0026gt;([^\u0026lt;] )\u0026lt;/a\u0026gt;`) /*matches := compile.FindAll(body, -1) //matchesæ˜¯äºŒç»´æ•°ç»„[][]byte for _, m := range matches { fmt.Printf(\u0026#34;%s\\n\u0026#34;, m) } */ submatch := compile.FindAllSubmatch(body, -1) //submatchæ˜¯ä¸‰ç»´æ•°ç»„[][][]byte /* for _, matches := range submatch { //[][]byte for _, m := range matches { fmt.Printf(\u0026#34;%s \u0026#34;, m) } fmt.Println() }*/ for _, matches := range submatch { //æ‰“å° fmt.Printf(\u0026#34;City:%s URL:%s\\n\u0026#34;, matches[2], matches[1]) } //å¯ä»¥çœ‹åˆ°åŒ¹é…ä¸ªæ•°ä¸º470ä¸ª fmt.Printf(\u0026#34;Matches count: %d\\n\u0026#34;, len(submatch)) //æ‰“å°abc //fmt.Printf(\u0026#34;%s\\n\u0026#34;, []byte{97,98,99}) } è¿è¡Œåï¼Œå¯ä»¥çœ‹åˆ°è¾“å‡ºäº†URLå’ŒCityï¼š\nä»Šå¤©æˆ‘ä»¬å®Œæˆäº†URLå’ŒåŸå¸‚çš„æå–ï¼Œæ˜å¤©æˆ‘ä»¬å°†åˆ©ç”¨URLï¼Œæ¥è¿›ä¸€æ­¥åˆ†æåŸå¸‚çš„ç”·å¥³æ€§ä¸ªäººä¿¡æ¯ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E7%94%A8go%E8%AF%AD%E8%A8%80%E7%88%AC%E5%8F%96%E7%8F%8D%E7%88%B1%E7%BD%91%E7%AC%AC%E4%BA%8C%E5%9B%9E/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://cdn.jsdelivr.net/gh/smallersoup/jsDelivr-cdn@main/blog/article/csdnimg/20191018002356226.jpeg\" alt=\"image\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://cdn.jsdelivr.net/gh/smallersoup/jsDelivr-cdn@main/blog/article/csdnimg/20191018002355495.gif\" alt=\"image\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cp\u003eæ˜¨å¤©æˆ‘ä»¬ä¸€èµ·çˆ¬å–ççˆ±ç½‘é¦–é¡µï¼Œæ‹¿åˆ°äº†åŸå¸‚åˆ—è¡¨é¡µé¢ï¼Œæ¥ä¸‹æ¥åœ¨è¿”å›ä½“åŸå¸‚åˆ—è¡¨ä¸­æå–åŸå¸‚å’Œurlï¼Œå³ä¸‹å›¾ä¸­çš„aæ ‡ç­¾é‡Œçš„hrefçš„å€¼å’ŒinnerTextå€¼ã€‚\u003c/p\u003e","title":"ç”¨goè¯­è¨€çˆ¬å–ççˆ±ç½‘ | ç¬¬äºŒå›","type":"posts"},{"content":"å‰ä¸¤èŠ‚æˆ‘ä»¬è·å–åˆ°äº†åŸå¸‚çš„URLå’ŒåŸå¸‚åï¼Œä»Šå¤©æˆ‘ä»¬æ¥è§£æç”¨æˆ·ä¿¡æ¯ã€‚\nç”¨goè¯­è¨€çˆ¬å–ççˆ±ç½‘ | ç¬¬ä¸€å›\nç”¨goè¯­è¨€çˆ¬å–ççˆ±ç½‘ | ç¬¬äºŒå›\nçˆ¬è™«çš„ç®—æ³•ï¼š\næˆ‘ä»¬è¦æå–è¿”å›ä½“ä¸­çš„åŸå¸‚åˆ—è¡¨ï¼Œéœ€è¦ç”¨åˆ°åŸå¸‚åˆ—è¡¨è§£æå™¨ï¼›\néœ€è¦æŠŠæ¯ä¸ªåŸå¸‚é‡Œçš„æ‰€æœ‰ç”¨æˆ·è§£æå‡ºæ¥ï¼Œéœ€è¦ç”¨åˆ°åŸå¸‚è§£æå™¨ï¼›\nè¿˜éœ€è¦æŠŠæ¯ä¸ªç”¨æˆ·çš„ä¸ªäººä¿¡æ¯è§£æå‡ºæ¥ï¼Œéœ€è¦ç”¨åˆ°ç”¨æˆ·è§£æå™¨ã€‚\nçˆ¬è™«æ•´ä½“æ¶æ„ï¼š\nSeedæŠŠéœ€è¦çˆ¬çš„requesté€åˆ°engineï¼Œengineè´Ÿè´£å°†requesté‡Œçš„urlé€åˆ°fetcherå»çˆ¬å–æ•°æ®ï¼Œè¿”å›utf-8çš„ä¿¡æ¯ï¼Œç„¶åengineå°†è¿”å›ä¿¡æ¯é€åˆ°è§£æå™¨Parseré‡Œè§£ææœ‰ç”¨ä¿¡æ¯ï¼Œè¿”å›æ›´å¤šå¾…è¯·æ±‚requestså’Œæœ‰ç”¨ä¿¡æ¯itemsï¼Œä»»åŠ¡é˜Ÿåˆ—ç”¨äºå­˜å‚¨å¾…è¯·æ±‚çš„requestï¼Œengineé©±åŠ¨å„æ¨¡å—å¤„ç†æ•°æ®ï¼Œç›´åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºã€‚\nä»£ç å®ç°ï¼š\næŒ‰ç…§ä¸Šé¢çš„æ€è·¯ï¼Œè®¾è®¡å‡ºåŸå¸‚åˆ—è¡¨è§£æå™¨citylist.goä»£ç å¦‚ä¸‹ï¼š\npackage parser import ( \u0026#34;crawler/engine\u0026#34; \u0026#34;regexp\u0026#34; \u0026#34;log\u0026#34; ) const ( //\u0026lt;a href=\u0026#34;http://album.zhenai.com/u/1361133512\u0026#34; target=\u0026#34;_blank\u0026#34;\u0026gt;æ€ä¹ˆä¼šè¿·ä¸Šä½ \u0026lt;/a\u0026gt; cityReg = `\u0026lt;a href=\u0026#34;(http://album.zhenai.com/u/[0-9] )\u0026#34;[^\u0026gt;]*\u0026gt;([^\u0026lt;] )\u0026lt;/a\u0026gt;` ) func ParseCity(contents []byte) engine.ParserResult { compile := regexp.MustCompile(cityReg) submatch := compile.FindAllSubmatch(contents, -1) //è¿™é‡Œè¦æŠŠè§£æåˆ°çš„æ¯ä¸ªURLéƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„request result := engine.ParserResult{} for _, m := range submatch { name := string(m[2]) log.Printf(\u0026#34;UserName:%s URL:%s\\n\u0026#34;, string(m[2]), string(m[1])) //æŠŠç”¨æˆ·ä¿¡æ¯äººååŠ åˆ°itemé‡Œ result.Items = append(result.Items, name) result.Requests = append(result.Requests, engine.Request{ //ç”¨æˆ·ä¿¡æ¯å¯¹åº”çš„URL,ç”¨äºä¹‹åçš„ç”¨æˆ·ä¿¡æ¯çˆ¬å– Url : string(m[1]), //è¿™ä¸ªparseræ˜¯å¯¹åŸå¸‚ä¸‹é¢çš„ç”¨æˆ·çš„parse ParserFunc : func(bytes []byte) engine.ParserResult { //è¿™é‡Œä½¿ç”¨é—­åŒ…çš„æ–¹å¼;è¿™é‡Œä¸èƒ½ç”¨m[2],å¦åˆ™æ‰€æœ‰forå¾ªç¯é‡Œçš„ç”¨æˆ·éƒ½ä¼šå…±ç”¨ä¸€ä¸ªåå­— //éœ€è¦æ‹·è´m[2] ---- name := string(m[2]) return ParseProfile(bytes, name) }, }) } return result } åŸå¸‚è§£æå™¨city.goå¦‚ä¸‹ï¼š\npackage parser import ( \u0026#34;crawler/engine\u0026#34; \u0026#34;regexp\u0026#34; \u0026#34;log\u0026#34; ) const ( //\u0026lt;a href=\u0026#34;http://album.zhenai.com/u/1361133512\u0026#34; target=\u0026#34;_blank\u0026#34;\u0026gt;æ€ä¹ˆä¼šè¿·ä¸Šä½ \u0026lt;/a\u0026gt; cityReg = `\u0026lt;a href=\u0026#34;(http://album.zhenai.com/u/[0-9] )\u0026#34;[^\u0026gt;]*\u0026gt;([^\u0026lt;] )\u0026lt;/a\u0026gt;` ) func ParseCity(contents []byte) engine.ParserResult { compile := regexp.MustCompile(cityReg) submatch := compile.FindAllSubmatch(contents, -1) //è¿™é‡Œè¦æŠŠè§£æåˆ°çš„æ¯ä¸ªURLéƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„request result := engine.ParserResult{} for _, m := range submatch { name := string(m[2]) log.Printf(\u0026#34;UserName:%s URL:%s\\n\u0026#34;, string(m[2]), string(m[1])) //æŠŠç”¨æˆ·ä¿¡æ¯äººååŠ åˆ°itemé‡Œ result.Items = append(result.Items, name) result.Requests = append(result.Requests, engine.Request{ //ç”¨æˆ·ä¿¡æ¯å¯¹åº”çš„URL,ç”¨äºä¹‹åçš„ç”¨æˆ·ä¿¡æ¯çˆ¬å– Url : string(m[1]), //è¿™ä¸ªparseræ˜¯å¯¹åŸå¸‚ä¸‹é¢çš„ç”¨æˆ·çš„parse ParserFunc : func(bytes []byte) engine.ParserResult { //è¿™é‡Œä½¿ç”¨é—­åŒ…çš„æ–¹å¼;è¿™é‡Œä¸èƒ½ç”¨m[2],å¦åˆ™æ‰€æœ‰forå¾ªç¯é‡Œçš„ç”¨æˆ·éƒ½ä¼šå…±ç”¨ä¸€ä¸ªåå­— //éœ€è¦æ‹·è´m[2] ---- name := string(m[2]) return ParseProfile(bytes, name) }, }) } return result } ç”¨æˆ·è§£æå™¨profile.goå¦‚ä¸‹ï¼š\npackage parser import ( \u0026#34;crawler/engine\u0026#34; \u0026#34;crawler/model\u0026#34; \u0026#34;regexp\u0026#34; \u0026#34;strconv\u0026#34; ) var ( // \u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;å¹´é¾„ï¼š\u0026lt;/span\u0026gt;25å²\u0026lt;/td\u0026gt; ageReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;å¹´é¾„ï¼š\u0026lt;/span\u0026gt;([\\d] )å²\u0026lt;/td\u0026gt;`) // \u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;èº«é«˜ï¼š\u0026lt;/span\u0026gt;182CM\u0026lt;/td\u0026gt; heightReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;èº«é«˜ï¼š\u0026lt;/span\u0026gt;(. )CM\u0026lt;/td\u0026gt;`) // \u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;æœˆæ”¶å…¥ï¼š\u0026lt;/span\u0026gt;5001-8000å…ƒ\u0026lt;/td\u0026gt; incomeReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;æœˆæ”¶å…¥ï¼š\u0026lt;/span\u0026gt;([0-9-] )å…ƒ\u0026lt;/td\u0026gt;`) //\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;å©šå†µï¼š\u0026lt;/span\u0026gt;æœªå©š\u0026lt;/td\u0026gt; marriageReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;å©šå†µï¼š\u0026lt;/span\u0026gt;(. )\u0026lt;/td\u0026gt;`) //\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;å­¦å†ï¼š\u0026lt;/span\u0026gt;å¤§å­¦æœ¬ç§‘\u0026lt;/td\u0026gt; educationReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;å­¦å†ï¼š\u0026lt;/span\u0026gt;(. )\u0026lt;/td\u0026gt;`) //\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;å·¥ä½œåœ°ï¼š\u0026lt;/span\u0026gt;å®‰å¾½èšŒåŸ \u0026lt;/td\u0026gt; workLocationReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;å·¥ä½œåœ°ï¼š\u0026lt;/span\u0026gt;(. )\u0026lt;/td\u0026gt;`) // \u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;èŒä¸šï¼š \u0026lt;/span\u0026gt;--\u0026lt;/td\u0026gt; occupationReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;èŒä¸šï¼š \u0026lt;/span\u0026gt;\u0026lt;span field=\u0026#34;\u0026#34;\u0026gt;(. )\u0026lt;/span\u0026gt;\u0026lt;/td\u0026gt;`) // \u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;æ˜Ÿåº§ï¼š\u0026lt;/span\u0026gt;å°„æ‰‹åº§\u0026lt;/td\u0026gt; xinzuoReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;æ˜Ÿåº§ï¼š\u0026lt;/span\u0026gt;\u0026lt;span field=\u0026#34;\u0026#34;\u0026gt;(. )\u0026lt;/span\u0026gt;\u0026lt;/td\u0026gt;`) //\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;ç±è´¯ï¼š\u0026lt;/span\u0026gt;å®‰å¾½èšŒåŸ \u0026lt;/td\u0026gt; hokouReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;æ°‘æ—ï¼š\u0026lt;/span\u0026gt;\u0026lt;span field=\u0026#34;\u0026#34;\u0026gt;(. )\u0026lt;/span\u0026gt;\u0026lt;/td\u0026gt;`) // \u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;ä½æˆ¿æ¡ä»¶ï¼š\u0026lt;/span\u0026gt;\u0026lt;span field=\u0026#34;\u0026#34;\u0026gt;--\u0026lt;/span\u0026gt;\u0026lt;/td\u0026gt; houseReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;ä½æˆ¿æ¡ä»¶ï¼š\u0026lt;/span\u0026gt;\u0026lt;span field=\u0026#34;\u0026#34;\u0026gt;(. )\u0026lt;/span\u0026gt;\u0026lt;/td\u0026gt;`) // \u0026lt;td width=\u0026#34;150\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;grayL\u0026#34;\u0026gt;æ€§åˆ«ï¼š\u0026lt;/span\u0026gt;ç”·\u0026lt;/td\u0026gt; genderReg = regexp.MustCompile(`\u0026lt;td width=\u0026#34;150\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;grayL\u0026#34;\u0026gt;æ€§åˆ«ï¼š\u0026lt;/span\u0026gt;(. )\u0026lt;/td\u0026gt;`) // \u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;ä½“é‡ï¼š\u0026lt;/span\u0026gt;\u0026lt;span field=\u0026#34;\u0026#34;\u0026gt;67KG\u0026lt;/span\u0026gt;\u0026lt;/td\u0026gt; weightReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;ä½“é‡ï¼š\u0026lt;/span\u0026gt;\u0026lt;span field=\u0026#34;\u0026#34;\u0026gt;(. )KG\u0026lt;/span\u0026gt;\u0026lt;/td\u0026gt;`) //\u0026lt;h1 class=\u0026#34;ceiling-name ib fl fs24 lh32 blue\u0026#34;\u0026gt;æ€ä¹ˆä¼šè¿·ä¸Šä½ \u0026lt;/h1\u0026gt; //nameReg = regexp.MustCompile(`\u0026lt;h1 class=\u0026#34;ceiling-name ib fl fs24 lh32 blue\u0026#34;\u0026gt;([^\\d] )\u0026lt;/h1\u0026gt; `) //\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;æ˜¯å¦è´­è½¦ï¼š\u0026lt;/span\u0026gt;\u0026lt;span field=\u0026#34;\u0026#34;\u0026gt;æœªè´­è½¦\u0026lt;/span\u0026gt;\u0026lt;/td\u0026gt; carReg = regexp.MustCompile(`\u0026lt;td\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;æ˜¯å¦è´­è½¦ï¼š\u0026lt;/span\u0026gt;\u0026lt;span field=\u0026#34;\u0026#34;\u0026gt;(. )\u0026lt;/span\u0026gt;\u0026lt;/td\u0026gt;`) ) func ParseProfile(contents []byte, name string) engine.ParserResult { profile := model.Profile{} age, err := strconv.Atoi(extractString(contents, ageReg)) if err != nil { profile.Age = 0 }else { profile.Age = age } height, err := strconv.Atoi(extractString(contents, heightReg)) if err != nil { profile.Height = 0 }else { profile.Height = height } weight, err := strconv.Atoi(extractString(contents, weightReg)) if err != nil { profile.Weight = 0 }else { profile.Weight = weight } profile.Income = extractString(contents, incomeReg) profile.Car = extractString(contents, carReg) profile.Education = extractString(contents, educationReg) profile.Gender = extractString(contents, genderReg) profile.Hokou = extractString(contents, hokouReg) profile.Income = extractString(contents, incomeReg) profile.Marriage = extractString(contents, marriageReg) profile.Name = name profile.Occupation = extractString(contents, occupationReg) profile.WorkLocation = extractString(contents, workLocationReg) profile.Xinzuo = extractString(contents, xinzuoReg) result := engine.ParserResult{ Items: []interface{}{profile}, } return result } //get value by reg from contents func extractString(contents []byte, re *regexp.Regexp) string { m := re.FindSubmatch(contents) if len(m) \u0026gt; 0 { return string(m[1]) } else { return \u0026#34;\u0026#34; } } engineä»£ç å¦‚ä¸‹ï¼š\npackage engine import ( \u0026#34;crawler/fetcher\u0026#34; \u0026#34;log\u0026#34; ) func Run(seeds ...Request){ //è¿™é‡Œç»´æŒä¸€ä¸ªé˜Ÿåˆ— var requestsQueue []Request requestsQueue = append(requestsQueue, seeds...) for len(requestsQueue) \u0026gt; 0 { //å–ç¬¬ä¸€ä¸ª r := requestsQueue[0] //åªä¿ç•™æ²¡å¤„ç†çš„request requestsQueue = requestsQueue[1:] log.Printf(\u0026#34;fetching url:%s\\n\u0026#34;, r.Url) //çˆ¬å–æ•°æ® body, err := fetcher.Fetch(r.Url) if err != nil { log.Printf(\u0026#34;fetch url: %s; err: %v\\n\u0026#34;, r.Url, err) //å‘ç”Ÿé”™è¯¯ç»§ç»­çˆ¬å–ä¸‹ä¸€ä¸ªurl continue } //è§£æçˆ¬å–åˆ°çš„ç»“æœ result := r.ParserFunc(body) //æŠŠçˆ¬å–ç»“æœé‡Œçš„requestç»§ç»­åŠ åˆ°requesté˜Ÿåˆ— requestsQueue = append(requestsQueue, result.Requests...) //æ‰“å°æ¯ä¸ªç»“æœé‡Œçš„item,å³æ‰“å°åŸå¸‚åã€åŸå¸‚ä¸‹çš„äººå... for _, item := range result.Items { log.Printf(\u0026#34;get item is %v\\n\u0026#34;, item) } } } Fetcherç”¨äºå‘èµ·http getè¯·æ±‚ï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹æ³¨æ„çš„æ˜¯ï¼šççˆ±ç½‘å¯èƒ½åšäº†åçˆ¬è™«é™åˆ¶æ‰‹æ®µï¼Œæ‰€ä»¥ç›´æ¥ç”¨http.Get(url)æ–¹å¼å‘è¯·æ±‚ï¼Œä¼šæŠ¥403æ‹’ç»è®¿é—®ï¼›æ•…éœ€è¦æ¨¡æ‹Ÿæµè§ˆå™¨æ–¹å¼ï¼š\nclient := \u0026amp;http.Client{} req, err := http.NewRequest(\u0026#34;GET\u0026#34;, url, nil) if err != nil { log.Fatalln(\u0026#34;NewRequest is err \u0026#34;, err) return nil, fmt.Errorf(\u0026#34;NewRequest is err %v\\n\u0026#34;, err) } req.Header.Set(\u0026#34;User-Agent\u0026#34;, \u0026#34;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\u0026#34;) //è¿”é€è¯·æ±‚è·å–è¿”å›ç»“æœ resp, err := client.Do(req) æœ€ç»ˆfetcherä»£ç å¦‚ä¸‹ï¼š\npackage fetcher import ( \u0026#34;bufio\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;golang.org/x/net/html/charset\u0026#34; \u0026#34;golang.org/x/text/encoding\u0026#34; \u0026#34;golang.org/x/text/encoding/unicode\u0026#34; \u0026#34;golang.org/x/text/transform\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; ) /** çˆ¬å–ç½‘ç»œèµ„æºå‡½æ•° */ func Fetch(url string) ([]byte, error) { client := \u0026amp;http.Client{} req, err := http.NewRequest(\u0026#34;GET\u0026#34;, url, nil) if err != nil { log.Fatalln(\u0026#34;NewRequest is err \u0026#34;, err) return nil, fmt.Errorf(\u0026#34;NewRequest is err %v\\n\u0026#34;, err) } req.Header.Set(\u0026#34;User-Agent\u0026#34;, \u0026#34;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\u0026#34;) //è¿”é€è¯·æ±‚è·å–è¿”å›ç»“æœ resp, err := client.Do(req) //ç›´æ¥ç”¨http.Get(url)è¿›è¡Œè·å–ä¿¡æ¯ï¼Œçˆ¬å–æ—¶å¯èƒ½è¿”å›403ï¼Œç¦æ­¢è®¿é—® //resp, err := http.Get(url) if err != nil { return nil, fmt.Errorf(\u0026#34;Error: http Get, err is %v\\n\u0026#34;, err) } //å…³é—­response body defer resp.Body.Close() if resp.StatusCode != http.StatusOK { return nil, fmt.Errorf(\u0026#34;Error: StatusCode is %d\\n\u0026#34;, resp.StatusCode) } //utf8Reader := transform.NewReader(resp.Body, simplifiedchinese.GBK.NewDecoder()) bodyReader := bufio.NewReader(resp.Body) utf8Reader := transform.NewReader(bodyReader, determineEncoding(bodyReader).NewDecoder()) return ioutil.ReadAll(utf8Reader) } /** ç¡®è®¤ç¼–ç æ ¼å¼ */ func determineEncoding(r *bufio.Reader) encoding.Encoding { //è¿™é‡Œçš„rè¯»å–å®Œå¾—ä¿è¯resp.Bodyè¿˜å¯è¯» body, err := r.Peek(1024) //å¦‚æœè§£æç¼–ç ç±»å‹æ—¶é‡åˆ°é”™è¯¯,è¿”å›UTF-8 if err != nil { log.Printf(\u0026#34;determineEncoding error is %v\u0026#34;, err) return unicode.UTF8 } //è¿™é‡Œç®€åŒ–,ä¸å–æ˜¯å¦ç¡®è®¤ e, _, _ := charset.DetermineEncoding(body, \u0026#34;\u0026#34;) return e } mainæ–¹æ³•å¦‚ä¸‹ï¼š\npackage main import ( \u0026#34;crawler/engine\u0026#34; \u0026#34;crawler/zhenai/parser\u0026#34; ) func main() { request := engine.Request{ Url: \u0026#34;http://www.zhenai.com/zhenghun\u0026#34;, ParserFunc: parser.ParseCityList, } engine.Run(request) } æœ€ç»ˆçˆ¬å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯å¦‚ä¸‹ï¼ŒåŒ…æ‹¬æ˜µç§°ã€å¹´é¾„ã€èº«é«˜ã€ä½“é‡ã€å·¥èµ„ã€å©šå§»çŠ¶å†µç­‰ã€‚\nå¦‚æœä½ æƒ³è¦å“ªä¸ªå¦¹å­çš„ç…§ç‰‡ï¼Œå¯ä»¥ç‚¹å¼€urlæŸ¥çœ‹ï¼Œç„¶åæ‰“æ‹›å‘¼è¿›ä¸€æ­¥å‘å±•ã€‚\nè‡³æ­¤å•ä»»åŠ¡ç‰ˆçš„çˆ¬è™«å°±åšå®Œäº†ï¼Œåé¢æˆ‘ä»¬å°†å¯¹å•ä»»åŠ¡ç‰ˆçˆ¬è™«åšæ€§èƒ½åˆ†æï¼Œç„¶åå‡çº§ä¸ºå¤šä»»åŠ¡å¹¶å‘ç‰ˆï¼ŒæŠŠçˆ¬å–åˆ°çš„ä¿¡æ¯å­˜åˆ°ElasticSearchä¸­ï¼Œåœ¨é¡µé¢ä¸ŠæŸ¥è¯¢\næœ¬å…¬ä¼—å·å…è´¹**æä¾›csdnä¸‹è½½æœåŠ¡ï¼Œæµ·é‡ITå­¦ä¹ èµ„æºï¼Œ**å¦‚æœä½ å‡†å¤‡å…¥ITå‘ï¼ŒåŠ±å¿—æˆä¸ºä¼˜ç§€çš„ç¨‹åºçŒ¿ï¼Œé‚£ä¹ˆè¿™äº›èµ„æºå¾ˆé€‚åˆä½ ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºjavaã€goã€pythonã€springcloudã€elkã€åµŒå…¥å¼ ã€å¤§æ•°æ®ã€é¢è¯•èµ„æ–™ã€å‰ç«¯ ç­‰èµ„æºã€‚åŒæ—¶æˆ‘ä»¬ç»„å»ºäº†ä¸€ä¸ªæŠ€æœ¯äº¤æµç¾¤ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¤§ä½¬ï¼Œä¼šä¸å®šæ—¶åˆ†äº«æŠ€æœ¯æ–‡ç« ï¼Œå¦‚æœä½ æƒ³æ¥ä¸€èµ·å­¦ä¹ æé«˜ï¼Œå¯ä»¥å…¬ä¼—å·åå°å›å¤ã€2ã€‘ï¼Œå…è´¹é‚€è¯·åŠ æŠ€æœ¯äº¤æµç¾¤äº’ç›¸å­¦ä¹ æé«˜ï¼Œä¼šä¸å®šæœŸåˆ†äº«ç¼–ç¨‹ITç›¸å…³èµ„æºã€‚\næ‰«ç å…³æ³¨ï¼Œç²¾å½©å†…å®¹ç¬¬ä¸€æ—¶é—´æ¨ç»™ä½ \n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E7%94%A8go%E8%AF%AD%E8%A8%80%E7%88%AC%E5%8F%96%E7%8F%8D%E7%88%B1%E7%BD%91%E7%AC%AC%E4%B8%89%E5%9B%9E/","section":"Posts","summary":"\u003cp\u003eå‰ä¸¤èŠ‚æˆ‘ä»¬è·å–åˆ°äº†åŸå¸‚çš„URLå’ŒåŸå¸‚åï¼Œä»Šå¤©æˆ‘ä»¬æ¥è§£æç”¨æˆ·ä¿¡æ¯ã€‚\u003c/p\u003e","title":"ç”¨goè¯­è¨€çˆ¬å–ççˆ±ç½‘ | ç¬¬ä¸‰å›","type":"posts"},{"content":"å‰ä¸¤å¤©æˆ‘ä»¬å†™äº†å•ä»»åŠ¡ç‰ˆçˆ¬è™«çˆ¬å–äº†ççˆ±ç½‘ç”¨æˆ·ä¿¡æ¯ï¼Œé‚£ä¹ˆå®ƒçš„æ€§èƒ½å¦‚ä½•å‘¢ï¼Ÿ\næˆ‘ä»¬å¯ä»¥é€šè¿‡ç½‘ç»œåˆ©ç”¨ç‡çœ‹ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç”¨ä»»åŠ¡ç®¡ç†å™¨ä¸­çš„æ€§èƒ½åˆ†æçª—å£å¯ä»¥çœ‹åˆ°ä¸‹è½½é€Ÿç‡å¤§æ¦‚æ˜¯ä¿æŒåœ¨äº†200kbpså·¦å³ï¼Œè¿™å¯ä»¥è¯´æ˜¯ç›¸å½“æ…¢äº†ã€‚\næˆ‘ä»¬é’ˆå¯¹æ¥é€šè¿‡åˆ†æå•ä»»åŠ¡ç‰ˆçˆ¬è™«çš„è®¾è®¡æ¥çœ‹ä¸‹ï¼š\nä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œengineå°†requestä»ä»»åŠ¡é˜Ÿåˆ—å–å‡ºæ¥ï¼Œé€åˆ°Fetcherå–è·å–èµ„æºï¼Œç­‰å¾…æ•°æ®è¿”å›ï¼Œç„¶åå°†è¿”å›çš„æ•°æ®é€åˆ°Parserå»è§£æï¼Œç­‰å¾…å…¶è¿”å›ï¼ŒæŠŠè¿”å›çš„requestå†åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼ŒåŒæ—¶æŠŠitemæ‰“å°å‡ºæ¥ã€‚\næ…¢å°±æ…¢åœ¨äº†æ²¡æœ‰å……åˆ†åˆ©ç”¨ç½‘ç»œèµ„æºï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥åŒæ—¶å‘é€å¤šä¸ªFetcherå’ŒPareserï¼Œç­‰å¾…å…¶è¿”å›çš„åŒæ—¶ï¼Œå¯ä»¥å»åšå…¶ä»–çš„å¤„ç†ã€‚è¿™ä¸€ç‚¹åˆ©ç”¨goçš„å¹¶å‘è¯­æ³•ç³–å¾ˆå®¹æ˜“å®ç°ã€‚\nä¸Šå›¾ä¸­ï¼ŒWorkeræ˜¯Fetcherå’ŒParserçš„åˆå¹¶ï¼ŒSchedulerå°†å¾ˆå¤šRequeståˆ†å‘åˆ°ä¸åŒçš„Workerï¼ŒWorkerå°†Requestå’ŒItemsè¿”å›åˆ°Engineï¼ŒItemsæ‰“å°å‡ºæ¥ï¼Œå†æŠŠRequestæ”¾åˆ°è°ƒåº¦å™¨é‡Œã€‚\nåŸºäºæ­¤ç”¨ä»£ç å®ç°ï¼š\nEngineï¼š\npackage engine import ( \u0026#34;log\u0026#34; ) type ConcurrentEngine struct { Scheduler Scheduler WokerCount int } type Scheduler interface { Submit(Request) ConfigureMasterWorkerChan(chan Request) } func (e *ConcurrentEngine) Run(seeds ...Request) { in := make(chan Request) out := make(chan ParserResult) e.Scheduler.ConfigureMasterWorkerChan(in) //åˆ›å»ºWorker for i := 0; i \u0026lt; e.WokerCount; i { createWorker(in, out) } //ä»»åŠ¡åˆ†å‘ç»™Worker for _, r := range seeds { e.Scheduler.Submit(r) } for { //æ‰“å°outçš„items result := \u0026lt;- out for _, item := range result.Items { log.Printf(\u0026#34;Get Items: %v\\n\u0026#34;, item) } //å°†outé‡Œçš„Requesté€ç»™Scheduler for _, r := range result.Requests { e.Scheduler.Submit(r) } } } //workerConut goroutine to exec worker for Loop func createWorker(in chan Request, out chan ParserResult) { go func() { for { request := \u0026lt;-in parserResult, err := worker(request) //å‘ç”Ÿäº†é”™è¯¯ç»§ç»­ä¸‹ä¸€ä¸ª if err != nil { continue } //å°†parserResulté€å‡º out \u0026lt;- parserResult } }() } Schedulerï¼š\npackage scheduler import \u0026#34;crawler/engine\u0026#34; //SimpleScheduler one workChan to multi worker type SimpleScheduler struct { workChan chan engine.Request } func (s *SimpleScheduler) ConfigureMasterWorkerChan(r chan engine.Request) { s.workChan = r } func (s *SimpleScheduler) Submit(r engine.Request) { go func() { s.workChan \u0026lt;- r }() } Workerï¼š\nfunc worker(r Request) (ParserResult, error) { log.Printf(\u0026#34;fetching url:%s\\n\u0026#34;, r.Url) //çˆ¬å–æ•°æ® body, err := fetcher.Fetch(r.Url) if err != nil { log.Printf(\u0026#34;fetch url: %s; err: %v\\n\u0026#34;, r.Url, err) //å‘ç”Ÿé”™è¯¯ç»§ç»­çˆ¬å–ä¸‹ä¸€ä¸ªurl return ParserResult{}, err } //è§£æçˆ¬å–åˆ°çš„ç»“æœ return r.ParserFunc(body), nil } mainå‡½æ•°ï¼š\npackage main import ( \u0026#34;crawler/engine\u0026#34; \u0026#34;crawler/zhenai/parser\u0026#34; \u0026#34;crawler/scheduler\u0026#34; ) func main() { e := \u0026amp;engine.ConcurrentEngine{ Scheduler: \u0026amp;scheduler.SimpleScheduler{}, WokerCount :100, } e.Run( engine.Request{ Url: \u0026#34;http://www.zhenai.com/zhenghun\u0026#34;, ParserFunc: parser.ParseCityList, }) } è¿™é‡Œå¼€å¯100ä¸ªWorkerï¼Œè¿è¡Œåå†æ¬¡æŸ¥çœ‹ç½‘ç»œåˆ©ç”¨ç‡ï¼Œå˜ä¸º3Mä»¥ä¸Šã€‚\nç”±äºä»£ç ç¯‡å¹…è¾ƒé•¿ï¼Œéœ€è¦çš„åŒå­¦å¯ä»¥å…³æ³¨å…¬ä¼—å·å›å¤ï¼šgoçˆ¬è™« è·å–ã€‚\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E7%88%AC%E8%99%AB%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%8F%8A%E4%BC%98%E5%8C%96/","section":"Posts","summary":"\u003cp\u003eå‰ä¸¤å¤©æˆ‘ä»¬å†™äº†å•ä»»åŠ¡ç‰ˆçˆ¬è™«çˆ¬å–äº†ççˆ±ç½‘ç”¨æˆ·ä¿¡æ¯ï¼Œé‚£ä¹ˆå®ƒçš„æ€§èƒ½å¦‚ä½•å‘¢ï¼Ÿ\u003c/p\u003e","title":"çˆ¬è™«æ€§èƒ½åˆ†æåŠä¼˜åŒ–","type":"posts"},{"content":" æ­£æ–‡ # golangçˆ¬ççˆ±ç½‘ä»£ç ä¼˜åŒ–åï¼Œè¿è¡ŒæŠ¥äº†å¦‚ä¸‹çš„é”™ï¼Œæ‰¾äº†åŠå°æ—¶æ‰æ‰¾åˆ°åŸå› ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹ã€‚\nä»£ç æ˜¯è¿™æ ·çš„ï¼š\næœ‰ä¸€ä¸ªinterfaceç±»å‹çš„Parserï¼š\ntype Parser interface { Parser(contents []byte, url string) ParserResult Serialize() (funcName string, args interface{}) } æœ‰ä¸€ä¸ªstructç±»å‹çš„FuncParserï¼š\ntype FuncParser struct { parser ParserFunc funcName string } FuncParser å®ç°äº†Parser æ¥å£ï¼š\nfunc (f *FuncParser) Parser(contents []byte, url string) ParserResult { return f.Parser(contents, url) } func (f *FuncParser) Serialize() (funcName string, args interface{}) { return f.funcName, nil } æŠ›å¼€çˆ¬è™«ä»£ç æ•´ä½“çš„å¤æ‚åº¦ï¼Œå°†ä»£ç ç®€åŒ–åˆ°å¦‚ä¸‹è¿™æ ·ï¼š\ntype ParserFunc func(url string) string type FuncParser struct { parser ParserFunc } func (f *FuncParser) Parser(url string) string { return f.Parser(url) } func main() { funcParse := FuncParser{ func(url string) string { return url }, } funcParse.Parser(\u0026#34;http://www.zhenai.com/zhenghun\u0026#34;) } åŒæ ·è¿è¡Œä»£ç ååŒæ ·ä¼šæŠ¥é”™ï¼š\nruntime: goroutine stack exceeds 1000000000-byte limit fatal error: stack overflow runtime stack: runtime.throw(0x467297, 0xe) D:/Program Files/Go/go103/src/runtime/panic.go:616 +0x88 runtime.newstack() D:/Program Files/Go/go103/src/runtime/stack.go:1054 +0x72d runtime.morestack() D:/Program Files/Go/go103/src/runtime/asm_amd64.s:480 +0x91 è¿™ä¸ªç¤ºä¾‹å°±å¾ˆæ˜æ˜¾äº†ï¼ŒFuncParserçš„Parseré‡Œå½¢æˆäº†é€’å½’è°ƒç”¨ï¼ˆè‡ªå·±è°ƒè‡ªå·±ï¼‰ï¼Œ\né€’å½’è°ƒç”¨è‡ªèº«å¯¼è‡´æ ˆæº¢å‡ºï¼Œå¯¼è‡´æŠ¥é”™ã€‚åº”è¯¥æ”¹æˆè¿™æ ·ï¼šï¼ˆå°å†™çš„parserï¼‰\nå®é™…ä¸Šgolandé‡Œå·²ç»æç¤ºäº†Recursive Call\nä¸€ä¸å°å¿ƒå°±ä¼šå†™å‡ºè¿™ç§ä»£ç ï¼Œå†çœ‹å¦‚ä¸‹ä»£ç ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; ) type Str string func (s Str) String() string { return fmt.Sprintf(\u0026#34;Str: %s\u0026#34;, s) } func main() { var s Str = \u0026#34;hi\u0026#34; fmt.Println(s) } åŒæ ·æŠ¥é”™ï¼š\nYou are implementing Str.String in terms of itself. return fmt.Sprintf(\u0026ldquo;Str: %s\u0026rdquo;, s) will call s.String(), resulting in infinite recursion. Convert s to string first.\nThis is working as intended, you are using the %s verb to call Str\u0026rsquo;s String method, which uses fmt.Sprint to call Str\u0026rsquo;s String method, and so on.\næ­£å¸¸ä»£ç åº”è¯¥å¦‚ä¸‹ï¼š\nå®é™…ä¸Šï¼Œgolandé‡Œä¹Ÿä¼šè­¦å‘Šè¯¥é—®é¢˜çš„ï¼š\nçœ‹æ¥å¹³æ—¶ç¼–å†™ä»£ç ï¼Œè­¦å‘Šè¿˜æ˜¯å¾—æ³¨æ„çš„ã€‚\né¡¹ç›®ä»£ç è§ï¼š https://github.com/smallersoup/crawler\n","date":"2019å¹´10æœˆ18æ—¥","externalUrl":null,"permalink":"/posts/%E7%88%AC%E8%99%AB%E9%81%87%E5%88%B0%E4%BA%86%E7%82%B9%E9%97%AE%E9%A2%98/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003egolangçˆ¬ççˆ±ç½‘ä»£ç ä¼˜åŒ–åï¼Œè¿è¡ŒæŠ¥äº†å¦‚ä¸‹çš„é”™ï¼Œæ‰¾äº†åŠå°æ—¶æ‰æ‰¾åˆ°åŸå› ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹ã€‚\u003c/p\u003e","title":"çˆ¬è™«é‡åˆ°äº†ç‚¹é—®é¢˜","type":"posts"},{"content":" æ­£æ–‡ # golangçˆ¬å–ççˆ±ç½‘ï¼Œçˆ¬åˆ°äº†3ä¸‡å¤šç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶å­˜åˆ°äº†elasticsearchä¸­ï¼Œå¦‚ä¸‹å›¾ï¼ŒæŸ¥è¯¢åˆ°äº†3ä¸‡å¤šç”¨æˆ·ä¿¡æ¯ã€‚\nå…ˆæ¥çœ‹çœ‹æœ€ç»ˆæ•ˆæœï¼š\nåˆ©ç”¨åˆ°äº†goè¯­è¨€çš„htmlæ¨¡æ¿åº“ï¼š\næ‰§è¡Œæ¨¡æ¿æ¸²æŸ“ï¼š\nfunc (s SearchResultView) Render (w io.Writer, data model.SearchResult) error { return s.template.Execute(w, data) } model.SearchResultæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š\ntype SearchResult struct { Hits int64 Start int Query string PrevFrom int NextFrom int CurrentPage int TotalPage int64 Items []interface{} //Items []engine.Item } ```html \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html xmlns:javascript=\u0026#34;http://www.w3.org/1999/xhtml\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;--- title\u0026gt;Love Search\u0026lt;/--- title\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; \u0026lt;link href=\u0026#34;./css/style.css\u0026#34; rel=\u0026#34;stylesheet\u0026#34;\u0026gt; \u0026lt;link href=\u0026#34;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css\u0026#34; rel=\u0026#34;stylesheet\u0026#34; id=\u0026#34;bootstrap-css\u0026#34;\u0026gt; \u0026lt;script src=\u0026#34;https://code.jquery.com/jquery-1.11.1.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;./js/page.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div id=\u0026#34;demo\u0026#34;\u0026gt; \u0026lt;div id=\u0026#34;searchblank\u0026#34;\u0026gt; \u0026lt;form method=\u0026#34;get\u0026#34; class=\u0026#34;form-inline\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;form-group\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; class=\u0026#34;form-control\u0026#34; style=\u0026#34;width: 500px\u0026#34; value=\u0026#34;{{.Query}}\u0026#34; name=\u0026#34;q\u0026#34;\u0026gt; \u0026lt;button class=\u0026#34;btn btn-default\u0026#34; type=\u0026#34;submit\u0026#34; maxlength=\u0026#34;100\u0026#34;\u0026gt;æœç´¢\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;h4 style=\u0026#34;text-align: center\u0026#34;\u0026gt;å…±ä¸ºä½ æ‰¾åˆ°ç›¸å…³ç»“æœä¸º{{.Hits}}ä¸ªã€‚æ˜¾ç¤ºä»{{.Start}}èµ·å…±{{len .Items}}ä¸ª\u0026lt;/h4\u0026gt; \u0026lt;div id=\u0026#34;customers\u0026#34; class=\u0026#34;table-responsive-vertical shadow-z-1\u0026#34;\u0026gt; \u0026lt;table id=\u0026#34;table\u0026#34; class=\u0026#34;table table-striped table-hover table-mc-indigo\u0026#34;\u0026gt; \u0026lt;thead\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;th\u0026gt;æ˜µç§°\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;æ€§åˆ«\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;å¹´é¾„\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;èº«é«˜\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;ä½“é‡\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;æ”¶å…¥\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;å­¦å†\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;èŒä½\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;æ‰€åœ¨åœ°\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;æ˜Ÿåº§\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;è´­æˆ¿æƒ…å†µ\u0026lt;/th\u0026gt; \u0026lt;th\u0026gt;è´­è½¦æƒ…å†µ\u0026lt;/th\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;/thead\u0026gt; \u0026lt;tbody\u0026gt; {{range .Items}} \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;\u0026lt;a href=\u0026#34;{{.Url}}\u0026#34; target=\u0026#34;_blank\u0026#34;\u0026gt;{{.Payload.Name}}\u0026lt;/a\u0026gt;\u0026lt;/td\u0026gt; {{with .Payload}} \u0026lt;td\u0026gt;{{.Gender}}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.Age}}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.Height}}CM\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.Weight}}KG\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.Income}}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.Education}}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.Occupation}}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.Hukou}}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.Xinzuo}}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.House}}\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;{{.Car}}\u0026lt;/td\u0026gt; {{end}} \u0026lt;/tr\u0026gt; {{else}} \u0026lt;tr\u0026gt; \u0026lt;td colspan=\u0026#34;12\u0026#34;\u0026gt;æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç”¨æˆ·\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; {{end}} \u0026lt;/tbody\u0026gt; \u0026lt;/table\u0026gt; \u0026lt;div align=\u0026#34;middle\u0026#34;\u0026gt; {{if gt .CurrentPage 1}} \u0026lt;a href=\u0026#34;search?q={{.Query}}\u0026amp;current={{Sub .CurrentPage 1}}\u0026#34;\u0026gt;ä¸Šä¸€é¡µ\u0026lt;/a\u0026gt; {{end}} {{if lt .CurrentPage .TotalPage}} \u0026lt;a href=\u0026#34;search?q={{.Query}}\u0026amp;current={{Add .CurrentPage 1}}\u0026#34;\u0026gt;ä¸‹ä¸€é¡µ\u0026lt;/a\u0026gt; {{end}} \u0026lt;span\u0026gt;å…±{{.TotalPage}}é¡µ,å½“å‰ç¬¬{{.CurrentPage}}é¡µ\u0026lt;/span\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; å…¶ä¸­ç”¨åˆ°äº†æ¨¡æ¿è¯­æ³•ä¸­çš„å˜é‡ã€å‡½æ•°ã€åˆ¤æ–­ã€å¾ªç¯ï¼›\næ¨¡æ¿å‡½æ•°çš„å®šä¹‰ï¼š\nä¸Šé¢æ¨¡æ¿ä»£ç ä¸­çš„ä¸Šä¸€é¡µã€ä¸‹ä¸€é¡µçš„aæ ‡ç­¾hrefé‡Œç”¨åˆ°äº†è‡ªå®šä¹‰æ¨¡æ¿å‡½æ•°Addå’ŒSubåˆ†åˆ«ç”¨äºè·å–ä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µçš„é¡µç ï¼Œä¼ åˆ°åå°ï¼ˆè¿™é‡Œå¹¶æ²¡æœ‰ç”¨JavaScriptå»å®ç°ï¼‰ã€‚\nhtml/templateåŒ…ä¸­æä¾›çš„åŠŸèƒ½æœ‰é™ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™éœ€è¦ä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„å‡½æ•°æ¥è¾…åŠ©æ¸²æŸ“é¡µé¢ã€‚ä¸‹é¢è®²è®²æ¨¡æ¿å‡½æ•°å¦‚ä½•ä½¿ç”¨ã€‚templateåŒ…åˆ›å»ºæ–°çš„æ¨¡æ¿çš„æ—¶å€™ï¼Œæ”¯æŒ.Funcsæ–¹æ³•æ¥å°†è‡ªå®šä¹‰çš„å‡½æ•°é›†åˆå¯¼å…¥åˆ°è¯¥æ¨¡æ¿ä¸­ï¼Œåç»­é€šè¿‡è¯¥æ¨¡æ¿æ¸²æŸ“çš„æ–‡ä»¶å‡æ”¯æŒç›´æ¥è°ƒç”¨è¿™äº›å‡½æ•°ã€‚\nå‡½æ•°å£°æ˜\n// Funcs adds the elements of the argument map to the template\u0026#39;s function map. // It panics if a value in the map is not a function with appropriate return // type. However, it is legal to overwrite elements of the map. The return // value is the template, so calls can be chained. func (t *Template) Funcs(funcMap FuncMap) *Template { t.text.Funcs(template.FuncMap(funcMap)) return t } Funcsæ–¹æ³•å°±æ˜¯ç”¨æ¥åˆ›å»ºæˆ‘ä»¬æ¨¡æ¿å‡½æ•°äº†ï¼Œå®ƒéœ€è¦ä¸€ä¸ªFuncMapç±»å‹çš„å‚æ•°ï¼š\n// FuncMap is the type of the map defining the mapping from names to // functions. Each function must have either a single return value, or two // return values of which the second has type error. In that case, if the // second (error) argument evaluates to non-nil during execution, execution // terminates and Execute returns that error. FuncMap has the same base type // as FuncMap in \u0026#34;text/template\u0026#34;, copied here so clients need not import // \u0026#34;text/template\u0026#34;. type FuncMap map[string]interface{} ä½¿ç”¨æ–¹æ³•ï¼š\nåœ¨goä»£ç ä¸­å®šä¹‰ä¸¤ä¸ªå‡½æ•°Addå’ŒSubï¼š\n//å‡æ³•ï¼Œä¸ºäº†åœ¨æ¨¡æ¿é‡Œç”¨å‡1 func Sub(a, b int) int { return a - b } //åŠ æ³•ï¼Œä¸ºäº†åœ¨æ¨¡æ¿é‡Œç”¨åŠ 1 func Add(a, b int) int { return a + b } æ¨¡æ¿ç»‘å®šæ¨¡æ¿å‡½æ•°ï¼š\nåˆ›å»ºä¸€ä¸ªFuncMapç±»å‹çš„mapï¼Œkeyæ˜¯æ¨¡æ¿å‡½æ•°çš„åå­—ï¼Œvalueæ˜¯åˆšæ‰å®šä¹‰å‡½æ•°åã€‚\nå°† FuncMapæ³¨å…¥åˆ°æ¨¡æ¿ä¸­ã€‚\nfilename := \u0026#34;../view/template_test.html\u0026#34; template, err := template.New(path.Base(filename)).Funcs(template.FuncMap{\u0026#34;Add\u0026#34;: Add, \u0026#34;Sub\u0026#34;: Sub}).ParseFiles(filename) if err != nil { t.Fatal(err) } æ¨¡æ¿ä¸­å¦‚ä½•ä½¿ç”¨ï¼š\nå¦‚ä¸Šé¢htmlæ¨¡æ¿ä¸­ä¸Šä¸€é¡µå¤„çš„ï¼š\n{{Sub .CurrentPage 1}} æŠŠæ¸²æŸ“åçš„CurrentPageå€¼åŠ 1\næ³¨æ„ï¼š\n1ã€å‡½æ•°çš„æ³¨å…¥ï¼Œå¿…é¡»è¦åœ¨parseFilesä¹‹å‰ï¼Œå› ä¸ºè§£ææ¨¡æ¿çš„æ—¶å€™ï¼Œéœ€è¦å…ˆæŠŠå‡½æ•°ç¼–è¯‘æ³¨å…¥ã€‚\n2ã€Template object can have multiple templates in it and each one has a name. If you look at the implementation of ParseFiles, you see that it uses the filename as the template name inside of the template object. So, name your file the same as the template object, (probably not generally practical) or else use ExecuteTemplate instead of just Execute.\n3ã€The name of the template is the bare filename of the template, not the complete pathã€‚å¦‚æœæ¨¡æ¿åå­—å†™é”™äº†ï¼Œæ‰§è¡Œçš„æ—¶å€™ä¼šå‡ºç°ï¼š\nerror: template: â€œâ€¦â€ is an incomplete or empty template å°¤å…¶æ˜¯ç¬¬ä¸‰ç‚¹ï¼Œæˆ‘ä»Šå¤©å°±é‡åˆ°äº†ï¼Œæ¨¡æ¿åè¦ç”¨æ–‡ä»¶åï¼Œä¸èƒ½æ˜¯å¸¦è·¯å¾„çš„åå­—ï¼Œçœ‹ä»¥ä¸‹ä»£ç ï¼š\nfunc TestTemplate3(t *testing.T) { //filename := \u0026#34;crawler/frontend/view/template.html\u0026#34; filename := \u0026#34;../view/template_test.html\u0026#34; //file, _ := os.Open(filename) t.Logf(\u0026#34;baseName:%s\\n\u0026#34;, path.Base(filename)) tpl, err := template.New(filename).Funcs(template.FuncMap{\u0026#34;Add\u0026#34;: Add, \u0026#34;Sub\u0026#34;: Sub}).ParseFiles(filename) if err != nil { t.Fatal(err) } page := common.SearchResult{} page.Hits = 123 page.Start = 0 item := engine.Item { Url: \u0026#34;http://album.zhenai.com/u/107194488\u0026#34;, Type: \u0026#34;zhenai\u0026#34;, Id: \u0026#34;107194488\u0026#34;, Payload: model.Profile{ Name: \u0026#34;éœ“è£³\u0026#34;, Age: 28, Height: 157, Marriage: \u0026#34;æœªå©š\u0026#34;, Income: \u0026#34;5001-8000å…ƒ\u0026#34;, Education: \u0026#34;ä¸­ä¸“\u0026#34;, Occupation: \u0026#34;ç¨‹åºåª›\u0026#34;, Gender: \u0026#34;å¥³\u0026#34;, House: \u0026#34;å·²è´­æˆ¿\u0026#34;, Car: \u0026#34;å·²è´­è½¦\u0026#34;, Hukou: \u0026#34;ä¸Šæµ·å¾æ±‡åŒº\u0026#34;, Xinzuo: \u0026#34;æ°´ç“¶åº§\u0026#34;, }, } page.CurrentPage = 1 page.TotalPage = 10 page.Items = append(page.Items, item) afterHtml, err := os.Create(\u0026#34;template_test1.html\u0026#34;) if err != nil { t.Fatal(err) } tpl.Execute(afterHtml, page) } è¿™é‡Œåœ¨template.New(filename)ä¼ å…¥çš„æ˜¯æ–‡ä»¶åï¼ˆä¸Šé¢å®šä¹‰æ—¶æ˜¯å¸¦è·¯å¾„çš„æ–‡ä»¶åï¼‰ï¼Œå¯¼è‡´æ‰§è¡Œå®Œä»£ç åtemplate_test1.htmlæ–‡ä»¶æ˜¯ç©ºçš„ï¼Œå½“ç„¶æµ‹è¯•ç±»çš„é€šè¿‡çš„ï¼Œä½†æ˜¯å°†æ­¤æ¸²æŸ“åˆ°æµè§ˆå™¨çš„æ—¶å€™ï¼Œå°±ä¼šæŠ¥ï¼š\ntemplate: â€œâ€¦â€ is an incomplete or empty template æ‰€ä»¥ï¼Œè¦ä½¿ç”¨æ–‡ä»¶çš„baseNameï¼Œå³ï¼š\ntpl, err := template.New(path.Base(filename)).Funcs(template.FuncMap{\u0026#34;Add\u0026#34;: Add, \u0026#34;Sub\u0026#34;: Sub}).ParseFiles(filename) è¿™æ ·è¿è¡Œä»£ç åtemplate_test1.htmlå°±æ˜¯è¢«æ¸²æŸ“æœ‰å†…å®¹çš„ã€‚\nå…¶ä»–è¯­æ³•ï¼šå˜é‡ã€åˆ¤æ–­ã€å¾ªç¯ç”¨æ³•æ¯”è¾ƒç®€å•ï¼Œæˆ‘æ²¡é‡åˆ°é—®é¢˜ï¼›å…¶ä»–è¯­æ³•ï¼Œå¦‚ï¼šæ¨¡æ¿çš„åµŒå¥—ï¼Œæˆ‘ç›®å‰æ²¡ç”¨åˆ°ï¼Œåœ¨æ­¤ä¹Ÿä¸åšèµ˜è¿°ã€‚\næŸ¥è¯¢é‡åˆ°çš„é—®é¢˜ï¼š\nå› ä¸ºæŸ¥è¯¢æ¯é¡µæ˜¾ç¤º10æ¡è®°å½•ï¼ŒæŸ¥è¯¢ç¬¬1000é¡µæ˜¯æ­£å¸¸çš„ï¼Œå½“æŸ¥è¯¢å¤§äºç­‰äº1001é¡µçš„æ—¶å€™ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š\nç”¨restclientå·¥å…·è°ƒï¼Œé”™è¯¯æ›´æ˜æ˜¾äº†ï¼š\n{ \u0026#34;error\u0026#34; : { \u0026#34;root_cause\u0026#34; : [ { \u0026#34;type\u0026#34; : \u0026#34;query_phase_execution_exception\u0026#34;, \u0026#34;reason\u0026#34; : \u0026#34;Result window is too large, from + size must be less than or equal to: [10000] but was [10010]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.\u0026#34; } ], \u0026#34;type\u0026#34; : \u0026#34;search_phase_execution_exception\u0026#34;, \u0026#34;reason\u0026#34; : \u0026#34;all shards failed\u0026#34;, \u0026#34;phase\u0026#34; : \u0026#34;query\u0026#34;, \u0026#34;grouped\u0026#34; : true, \u0026#34;failed_shards\u0026#34; : [ { \u0026#34;shard\u0026#34; : 0, \u0026#34;index\u0026#34; : \u0026#34;dating_profile\u0026#34;, \u0026#34;node\u0026#34; : \u0026#34;bJhldvT6QeaRTvHmBKHT4Q\u0026#34;, \u0026#34;reason\u0026#34; : { \u0026#34;type\u0026#34; : \u0026#34;query_phase_execution_exception\u0026#34;, \u0026#34;reason\u0026#34; : \u0026#34;Result window is too large, from + size must be less than or equal to: [10000] but was [10010]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.\u0026#34; } } ] }, \u0026#34;status\u0026#34; : 500 } é—®äº†è°·å“¥åå‘ç°ï¼Œæ˜¯ç”±äºElasticSearchçš„é»˜è®¤ æ·±åº¦ç¿»é¡µ æœºåˆ¶çš„é™åˆ¶é€ æˆçš„ã€‚ESé»˜è®¤çš„åˆ†é¡µæœºåˆ¶ä¸€ä¸ªä¸è¶³çš„åœ°æ–¹æ˜¯ï¼Œæ¯”å¦‚æœ‰5010æ¡æ•°æ®ï¼Œå½“ä½ ä»…æƒ³å–ç¬¬5000åˆ°5010æ¡æ•°æ®çš„æ—¶å€™ï¼ŒESä¹Ÿä¼šå°†å‰5000æ¡æ•°æ®åŠ è½½åˆ°å†…å­˜å½“ä¸­ï¼Œæ‰€ä»¥ESä¸ºäº†é¿å…ç”¨æˆ·çš„è¿‡å¤§åˆ†é¡µè¯·æ±‚é€ æˆESæœåŠ¡æ‰€åœ¨æœºå™¨å†…å­˜æº¢å‡ºï¼Œé»˜è®¤å¯¹æ·±åº¦åˆ†é¡µçš„æ¡æ•°è¿›è¡Œäº†é™åˆ¶ï¼Œé»˜è®¤çš„æœ€å¤§æ¡æ•°æ˜¯10000æ¡ï¼Œè¿™æ˜¯æ­£æ˜¯é—®é¢˜æè¿°ä¸­å½“è·å–ç¬¬10000æ¡æ•°æ®çš„æ—¶å€™æŠ¥Result window is too largeå¼‚å¸¸çš„åŸå› ã€‚ï¼ˆå› ä¸ºé¡µé¢ä¸º1001é¡µçš„æ—¶å€™åå°1001-1ç„¶åä¹˜ä»¥10ä½œä¸ºfromçš„å€¼å–æŸ¥è¯¢ESï¼Œè€ŒESé»˜è®¤éœ€è¦from+sizeè¦å°äºindex.max_result_windowï¼š æœ€å¤§çª—å£å€¼ï¼‰ã€‚\nè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼æ¥æ”¹å˜ESé»˜è®¤æ·±åº¦åˆ†é¡µçš„index.max_result_window æœ€å¤§çª—å£å€¼\ncurl -XPUT http://127.0.0.1:9200/dating_profile/_settings -d \u0026#39;{ \u0026#34;index\u0026#34; : { \u0026#34;max_result_window\u0026#34; : 50000}}\u0026#39; è¿™é‡Œçš„dating_profileä¸ºindexã€‚\nå…¶ä¸­my_indexä¸ºè¦ä¿®æ”¹çš„indexåï¼Œ50000ä¸ºè¦è°ƒæ•´çš„æ–°çš„çª—å£æ•°ã€‚å°†è¯¥çª—å£è°ƒæ•´åï¼Œä¾¿å¯ä»¥è§£å†³æ— æ³•è·å–åˆ°10000æ¡åæ•°æ®çš„é—®é¢˜ã€‚\næ³¨æ„äº‹é¡¹ # é€šè¿‡ä¸Šè¿°çš„æ–¹å¼è§£å†³äº†æˆ‘ä»¬çš„é—®é¢˜ï¼Œä½†ä¹Ÿå¼•å…¥äº†å¦ä¸€ä¸ªéœ€è¦æˆ‘ä»¬æ³¨æ„çš„é—®é¢˜ï¼Œçª—å£å€¼è°ƒå¤§äº†åï¼Œè™½ç„¶è¯·æ±‚åˆ°åˆ†é¡µçš„æ•°æ®æ¡æ•°æ›´å¤šäº†ï¼Œä½†å®ƒæ˜¯ç”¨ç‰ºç‰²æ›´å¤šçš„æœåŠ¡å™¨çš„å†…å­˜ã€CPUèµ„æºæ¥æ¢å–çš„ã€‚è¦è€ƒè™‘ä¸šåŠ¡åœºæ™¯ä¸­è¿‡å¤§çš„åˆ†é¡µè¯·æ±‚ï¼Œæ˜¯å¦ä¼šé€ æˆé›†ç¾¤æœåŠ¡çš„OutOfMemoryé—®é¢˜ã€‚åœ¨ESçš„å®˜æ–¹æ–‡æ¡£ä¸­å¯¹æ·±åº¦åˆ†é¡µä¹Ÿåšäº†è®¨è®º\nhttps://www.elastic.co/guide/en/elasticsearch/guide/current/pagination.html\nhttps://www.elastic.co/guide/en/elasticsearch/guide/current/pagination.html\næ ¸å¿ƒçš„è§‚ç‚¹å¦‚ä¸‹ï¼š\nDepending on the size of your documents, the number of shards, and the hardware you are using, paging 10,000 to 50,000 results (1,000 to 5,000 pages) deep should be perfectly doable. But with big-enough from values, the sorting process can become very heavy indeed, using vast amounts of CPU, memory, and bandwidth. For this reason, we strongly advise against deep paging.\nè¿™æ®µè§‚ç‚¹è¡¨è¿°çš„æ„æ€æ˜¯ï¼šæ ¹æ®æ–‡æ¡£çš„å¤§å°ï¼Œåˆ†ç‰‡çš„æ•°é‡ä»¥åŠä½¿ç”¨çš„ç¡¬ä»¶ï¼Œåˆ†é¡µ10,000åˆ°50,000ä¸ªç»“æœï¼ˆ1,000åˆ°5,000é¡µï¼‰åº”è¯¥æ˜¯å®Œå…¨å¯è¡Œçš„ã€‚ ä½†æ˜¯ï¼Œä»ä»·å€¼è§‚ä¸Šæ¥çœ‹ï¼Œä½¿ç”¨å¤§é‡çš„CPUï¼Œå†…å­˜å’Œå¸¦å®½ï¼Œåˆ†ç±»è¿‡ç¨‹ç¡®å®ä¼šå˜å¾—éå¸¸é‡è¦ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®ä¸è¦è¿›è¡Œæ·±åº¦åˆ†é¡µã€‚\nESä½œä¸ºä¸€ä¸ªæœç´¢å¼•æ“ï¼Œæ›´é€‚åˆçš„åœºæ™¯æ˜¯ä½¿ç”¨å®ƒè¿›è¡Œæœç´¢ï¼Œè€Œä¸æ˜¯å¤§è§„æ¨¡çš„ç»“æœéå†ã€‚ å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ï¼Œæ²¡æœ‰å¿…è¦å¾—åˆ°è¶…è¿‡10000ä¸ªç»“æœé¡¹ç›®ï¼Œ ä¾‹å¦‚ï¼Œåªè¿”å›å‰1000ä¸ªç»“æœã€‚å¦‚æœçš„ç¡®éœ€è¦å¤§é‡æ•°æ®çš„éå†å±•ç¤ºï¼Œè€ƒè™‘æ˜¯å¦å¯ä»¥ç”¨å…¶ä»–æ›´åˆé€‚çš„å­˜å‚¨ã€‚æˆ–è€…æ ¹æ®ä¸šåŠ¡åœºæ™¯çœ‹èƒ½å¦ç”¨ElasticSearchçš„ æ»šåŠ¨API (ç±»ä¼¼äºè¿­ä»£å™¨ï¼Œä½†æœ‰æ—¶é—´çª—å£æ¦‚å¿µ)æ¥æ›¿ä»£ã€‚\nåˆ°æ­¤å±•ç¤ºçš„é—®é¢˜å°±è§£å†³äº†ï¼š\né¡¹ç›®ä»£ç è§ï¼šhttps://github.com/smallersoup/crawler\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E7%88%AC%E5%8F%96%E7%8F%8D%E7%88%B1%E7%BD%91%E5%90%8E%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%B1%95%E7%A4%BA/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003egolangçˆ¬å–ççˆ±ç½‘ï¼Œçˆ¬åˆ°äº†3ä¸‡å¤šç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶å­˜åˆ°äº†elasticsearchä¸­ï¼Œå¦‚ä¸‹å›¾ï¼ŒæŸ¥è¯¢åˆ°äº†3ä¸‡å¤šç”¨æˆ·ä¿¡æ¯ã€‚\u003c/p\u003e","title":"çˆ¬å–ççˆ±ç½‘åç”¨æˆ·ä¿¡æ¯å±•ç¤º","type":"posts"},{"content":" æ­£æ–‡ # MySQLåœ¨5.7.8å¼€å§‹å¯¹jsonåŸç”Ÿæ”¯æŒï¼Œæœ¬æ–‡å°†å¯¹MySQLä¸­jsonç±»å‹çš„ç”¨æ³•ç®€å•è¯´æ˜ï¼Œå¸Œæœ›å¯¹ä½ æœ‰ç”¨ã€‚\nCREATE TABLE testproject ( `id` int(10) unsigned NOT NULL AUTO_INCREMENT, `skill` JSON NOT NULL, `student` JSON NOT NULL, PRIMARY KEY (`id`) ); æŸ¥çœ‹è¡¨ç»“æ„ï¼š\nè¿™æ ·JSONçš„å­—æ®µå°±è¢«åˆ›å»ºå¥½äº†\n**æ³¨ï¼š**JSONç±»å‹ä¸èƒ½æœ‰é»˜è®¤å€¼ã€‚\næ’å…¥JSON # æ’å…¥ json æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥æ˜¯å¯¹è±¡çš„å½¢å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°ç»„çš„å½¢å¼ï¼Œ\nINSERT INTO `testproject` (student, skill) VALUES (\u0026#39;{\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;}\u0026#39;, \u0026#39;[\u0026#34;java\u0026#34;, \u0026#34;go\u0026#34;, \u0026#34;vue\u0026#34;]\u0026#39;); INSERT INTO `testproject` (student, skill) VALUES (\u0026#39;{\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;}\u0026#39;, \u0026#39;[]\u0026#39;); æ’å…¥jsonæ—¶ï¼Œæ•°æ®åº“ä¼šå¯¹jsonåšæ ¡éªŒï¼Œä¸ç¬¦åˆjsonè§„èŒƒå°±ä¼šæŠ¥é”™ã€‚\næŸ¥è¯¢JSONï¼š # æŸ¥è¯¢ json ä¸­çš„æ•°æ®ç”¨ column-\u0026gt;path çš„å½¢å¼ï¼Œå…¶ä¸­å¯¹è±¡ç±»å‹ path è¿™æ ·è¡¨ç¤º $.path, è€Œæ•°ç»„ç±»å‹åˆ™æ˜¯ $[index]\næŸ¥è¯¢testprojectè¡¨studentå­—æ®µä¸­jsonå¯¹è±¡idä¸º1çš„è®°å½•ï¼š\nSELECT * FROM testproject WHERE student-\u0026gt;\u0026#39;$.id\u0026#39;= 1; æŸ¥è¯¢testprojectè¡¨studentå­—æ®µä¸­jsonå¯¹è±¡idä¸º1æˆ–è€…5çš„è®°å½•ï¼š\nSELECT * FROM testproject WHERE student-\u0026gt;\u0026#39;$.id\u0026#39; in (1,5); SELECT * FROM testproject WHERE student-\u0026gt;\u0026#39;$.id\u0026#39; = 1 or student-\u0026gt;\u0026#39;$.id\u0026#39; = 5; [å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-ShdsDUDU-1571306793566)(http://upload-images.jianshu.io/upload_images/9134763-cda653c6a30e3965?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)]\nä¹Ÿå¯ä»¥ç”¨å‡½æ•°json_extractï¼š\ncolumn-\u0026gt;pathæ–¹æ³•æœ‰é™åˆ¶ï¼Œæ•°æ®æºå¿…é¡»æ˜¯è¡¨å­—æ®µï¼Œå¦åˆ™å°±æŠ¥é”™ï¼š\nä»¥ä¸‹è¿™æ ·æŸ¥è¯¢ï¼ŒæŸ¥å‡ºæ¥student-\u0026gt;\u0026rsquo;$.name\u0026rsquo;åŒ…å«åŒå¼•å·ï¼š\nSELECT id, student-\u0026gt;\u0026#39;$.id\u0026#39;, student-\u0026gt;\u0026#39;$.name\u0026#39;, skill-\u0026gt;\u0026#39;$[0]\u0026#39;, skill-\u0026gt;\u0026#39;$[2]\u0026#39; FROM testproject; è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå¯ä»¥ç”¨ JSON_UNQUOTE å‡½æ•°å°†åŒå¼•å·å»æ‰ï¼Œä» MySQL 5.7.13 èµ·ä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªæ“ä½œç¬¦ -\u0026raquo; è¿™ä¸ªå’Œ JSON_UNQUOTE æ˜¯ç­‰ä»·çš„ã€‚\nå› ä¸º JSON ä¸åŒäºå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å¦‚æœç”¨å­—ç¬¦ä¸²å’Œ JSON å­—æ®µæ¯”è¾ƒï¼Œæ˜¯ä¸ä¼šç›¸ç­‰çš„ï¼š\nmysql\u0026gt; SELECT * FROM testproject WHERE student = \u0026#39;{\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;}\u0026#39;; Empty set (0.00 sec) æ­¤æ—¶å¯ä»¥é€šè¿‡ CAST å°†å­—ç¬¦ä¸²è½¬æˆ JSON çš„å½¢å¼ï¼š\nmysql\u0026gt; SELECT * FROM testproject WHERE student = CAST(\u0026#39;{\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;}\u0026#39; as JSON); +----+-----------------------+---------------------------+ | id | skill | student | +----+-----------------------+---------------------------+ | 10 | [\u0026#34;java\u0026#34;, \u0026#34;go\u0026#34;, \u0026#34;vue\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;} | +----+-----------------------+---------------------------+ 1 row in set (0.01 sec) è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼ŒJSON ä¸­çš„å…ƒç´ æœç´¢æ˜¯ä¸¥æ ¼åŒºåˆ†å˜é‡ç±»å‹çš„ï¼Œæ¯”å¦‚è¯´æ•´å‹å’Œå­—ç¬¦ä¸²æ˜¯ä¸¥æ ¼åŒºåˆ†çš„ï¼š\nmysql\u0026gt; SELECT * FROM testproject WHERE student-\u0026gt;\u0026#39;$.id\u0026#39; = \u0026#39;1\u0026#39;; Empty set (0.00 sec) mysql\u0026gt; mysql\u0026gt; SELECT * FROM testproject WHERE student-\u0026gt;\u0026#39;$.id\u0026#39; = 1; +----+-----------------------+---------------------------+ | id | skill | student | +----+-----------------------+---------------------------+ | 10 | [\u0026#34;java\u0026#34;, \u0026#34;go\u0026#34;, \u0026#34;vue\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;} | +----+-----------------------+---------------------------+ 1 row in set (0.00 sec) å¯ä»¥çœ‹åˆ°æœç´¢å­—ç¬¦ä¸² 1 å’Œæ•´å‹ 1 çš„ç»“æœæ˜¯ä¸ä¸€æ ·çš„ã€‚\né™¤äº†ç”¨ä»¥ä¸Š column-\u0026gt;path çš„å½¢å¼æœç´¢ï¼Œè¿˜å¯ä»¥ç”¨JSON_CONTAINS å‡½æ•°ï¼Œä½†å’Œ column-\u0026gt;path çš„å½¢å¼æœ‰ç‚¹ç›¸åçš„æ˜¯ï¼ŒJSON_CONTAINS ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸æ¥å—æ•´æ•°çš„ï¼Œæ— è®º json å…ƒç´ æ˜¯æ•´å‹è¿˜æ˜¯å­—ç¬¦ä¸²ï¼Œå¦åˆ™ä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ï¼š\nmysql\u0026gt; SELECT * FROM testproject WHERE JSON_CONTAINS(student, 1, \u0026#39;$.id\u0026#39;); ERROR 3146 (22032): Invalid data type for JSON data in argument 2 to function json_contains; a JSON string or JSON type is required. mysql\u0026gt; è¿™é‡Œå¿…é¡»è¦ä½¿ç”¨å­—ç¬¦ä¸²ï¼š\nmysql\u0026gt; SELECT * FROM testproject WHERE JSON_CONTAINS(student, \u0026#39;1\u0026#39;, \u0026#39;$.id\u0026#39;); +----+-----------------------+---------------------------+ | id | skill | student | +----+-----------------------+---------------------------+ | 10 | [\u0026#34;java\u0026#34;, \u0026#34;go\u0026#34;, \u0026#34;vue\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;} | +----+-----------------------+---------------------------+ 1 row in set (0.00 sec) å¯¹äºæ•°ç»„ç±»å‹çš„ JSON çš„æŸ¥è¯¢ï¼Œæ¯”å¦‚è¯´ skill ä¸­åŒ…å«æœ‰ 3 çš„æ•°æ®ï¼ŒåŒæ ·è¦ç”¨ JSON_CONTAINS å‡½æ•°ï¼ŒåŒæ ·ç¬¬äºŒä¸ªå‚æ•°ä¹Ÿéœ€è¦æ˜¯å­—ç¬¦ä¸²ï¼š\nmysql\u0026gt; SELECT * FROM testproject WHERE JSON_CONTAINS(skill, \u0026#39;\u0026#34;go\u0026#34;\u0026#39;); +----+-----------------------+---------------------------+ | id | skill | student | +----+-----------------------+---------------------------+ | 10 | [\u0026#34;java\u0026#34;, \u0026#34;go\u0026#34;, \u0026#34;vue\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;} | +----+-----------------------+---------------------------+ 1 row in set (0.00 sec) mysql\u0026gt; SELECT * FROM testproject WHERE JSON_CONTAINS(skill, \u0026#39;1\u0026#39;); +----+-----------+------------------------------+ | id | skill | student | +----+-----------+------------------------------+ | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+-----------+------------------------------+ 1 row in set (0.00 sec) æ›´æ–°æ•°æ® # MySQL å¹¶ä¸æ”¯æŒ column-\u0026gt;path çš„å½¢å¼è¿›è¡Œæ›´æ–°æ“ä½œã€‚\nå¦‚æœæ˜¯æ•´ä¸ª json æ›´æ–°çš„è¯ï¼Œå’Œæ’å…¥æ—¶ç±»ä¼¼çš„ï¼š\nmysql\u0026gt; select * from testproject where id = 10; +----+-----------------------+---------------------------+ | id | skill | student | +----+-----------------------+---------------------------+ | 10 | [\u0026#34;java\u0026#34;, \u0026#34;go\u0026#34;, \u0026#34;vue\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;} | +----+-----------------------+---------------------------+ 1 row in set (0.00 sec) mysql\u0026gt; UPDATE testproject SET skill = \u0026#39;[\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;]\u0026#39; WHERE id = 10; Query OK, 1 row affected (0.01 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u0026gt; select * from testproject where id = 10; +----+----------------+---------------------------+ | id | skill | student | +----+----------------+---------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;} | +----+----------------+---------------------------+ 1 row in set (0.00 sec) json_array_appendå’Œjson_array_insertå‡½æ•°ä½¿ç”¨ï¼š\njson_array_appendæ˜¯åœ¨jsonåé¢è¿½åŠ ï¼›\njson_array_insertæ˜¯åœ¨æŒ‡å®šä¸‹æ ‡æ’å…¥ã€‚\nmysql\u0026gt; select * from testproject; +----+----------------+------------------------------+ | id | skill | student | +----+----------------+------------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;ggjg\u0026#34;} | | 11 | [] | {\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+----------------+------------------------------+ 3 rows in set (0.00 sec) mysql\u0026gt; SELECT json_array_append(skill, \u0026#39;$\u0026#39;, \u0026#39;c\u0026#39;) from testproject; +------------------------------------+ | json_array_append(skill, \u0026#39;$\u0026#39;, \u0026#39;c\u0026#39;) | +------------------------------------+ | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;, \u0026#34;c\u0026#34;] | | [\u0026#34;c\u0026#34;] | | [1, 2, 3, \u0026#34;c\u0026#34;] | +------------------------------------+ 3 rows in set (0.00 sec) mysql\u0026gt; SELECT json_array_insert(skill, \u0026#39;$[1]\u0026#39;, \u0026#39;php\u0026#39;) from testproject; +-----------------------------------------+ | json_array_insert(skill, \u0026#39;$[1]\u0026#39;, \u0026#39;php\u0026#39;) | +-----------------------------------------+ | [\u0026#34;js\u0026#34;, \u0026#34;php\u0026#34;, \u0026#34;java\u0026#34;] | | [\u0026#34;php\u0026#34;] | | [1, \u0026#34;php\u0026#34;, 2, 3] | +-----------------------------------------+ 3 rows in set (0.00 sec) mysql\u0026gt; json_replaceã€json_setã€json_insertå’Œjson_removeå‡½æ•°ç”¨æ³•ï¼š\njson_replaceï¼šåªæ›¿æ¢å·²ç»å­˜åœ¨çš„æ—§å€¼ï¼Œä¸å­˜åœ¨åˆ™å¿½ç•¥ï¼›\njson_setï¼šæ›¿æ¢æ—§å€¼ï¼Œå¹¶æ’å…¥ä¸å­˜åœ¨çš„æ–°å€¼ï¼›\njson_insertï¼šæ’å…¥æ–°å€¼ï¼Œä½†ä¸æ›¿æ¢å·²ç»å­˜åœ¨çš„æ—§å€¼ï¼›\njson_remove() åˆ é™¤å…ƒç´ ã€‚\njson_replaceï¼š\nmysql\u0026gt; select * from testproject; +----+----------------+--------------------------------+ | id | skill | student | +----+----------------+--------------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;smallsoup\u0026#34;} | | 11 | [] | {\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+----------------+--------------------------------+ 3 rows in set (0.00 sec) mysql\u0026gt; mysql\u0026gt; UPDATE testproject SET student-\u0026gt;\u0026#39;$.name\u0026#39; = \u0026#39;smallsoup\u0026#39; where student-\u0026gt;\u0026#39;$.id\u0026#39; = 1; ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server versio n for the right syntax to use near \u0026#39;-\u0026gt;\u0026#39;$.name\u0026#39; = \u0026#39;smallsoup\u0026#39; where student-\u0026gt;\u0026#39;$.id\u0026#39; = 1\u0026#39; at line 1 mysql\u0026gt; mysql\u0026gt; UPDATE testproject SET student = json_replace(student, \u0026#39;$.name\u0026#39;, \u0026#39;soup\u0026#39;) WHERE student-\u0026gt;\u0026#39;$.id\u0026#39; = 1; Query OK, 1 row affected (0.01 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u0026gt; select * from testproject; +----+----------------+------------------------------+ | id | skill | student | +----+----------------+------------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;soup\u0026#34;} | | 11 | [] | {\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+----------------+------------------------------+ 3 rows in set (0.00 sec) json_setï¼š\nmysql\u0026gt; select * from testproject; +----+----------------+------------------------------+ | id | skill | student | +----+----------------+------------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;soup\u0026#34;} | | 11 | [] | {\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+----------------+------------------------------+ 3 rows in set (0.00 sec) mysql\u0026gt; UPDATE testproject SET student = json_set(student, \u0026#39;$.name\u0026#39;, \u0026#39;small\u0026#39;, \u0026#39;$.age\u0026#39;, 22) WHERE student-\u0026gt;\u0026#39;$.id\u0026#39;= 1; Query OK, 1 row affected (0.01 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u0026gt; select * from testproject; +----+----------------+---------------------------------------+ | id | skill | student | +----+----------------+---------------------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;age\u0026#34;: 22, \u0026#34;name\u0026#34;: \u0026#34;small\u0026#34;} | | 11 | [] | {\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+----------------+---------------------------------------+ 3 rows in set (0.00 sec) json_insertï¼š\nmysql\u0026gt; select * from testproject; +----+----------------+---------------------------------------+ | id | skill | student | +----+----------------+---------------------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;age\u0026#34;: 22, \u0026#34;name\u0026#34;: \u0026#34;small\u0026#34;} | | 11 | [] | {\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+----------------+---------------------------------------+ 3 rows in set (0.00 sec) mysql\u0026gt; UPDATE testproject SET student = json_insert(student, \u0026#39;$.name\u0026#39;, \u0026#39;soup\u0026#39;, \u0026#39;$.addr\u0026#39;, \u0026#39;è‹å·\u0026#39;) WHERE student-\u0026gt;\u0026#39;$.id\u0026#39;= 1; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u0026gt; select * from testproject; +----+----------------+---------------------------------------------------------+ | id | skill | student | +----+----------------+---------------------------------------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;age\u0026#34;: 22, \u0026#34;addr\u0026#34;: \u0026#34;è‹å·\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;small\u0026#34;} | | 11 | [] | {\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+----------------+---------------------------------------------------------+ 3 rows in set (0.00 sec) json_remove() :\nmysql\u0026gt; select * from testproject; +----+----------------+---------------------------------------------------------+ | id | skill | student | +----+----------------+---------------------------------------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;age\u0026#34;: 22, \u0026#34;addr\u0026#34;: \u0026#34;è‹å·\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;small\u0026#34;} | | 11 | [] | {\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+----------------+---------------------------------------------------------+ 3 rows in set (0.00 sec) mysql\u0026gt; UPDATE testproject SET student = json_remove(student, \u0026#39;$.name\u0026#39;, \u0026#39;$.age\u0026#39;) WHERE student-\u0026gt;\u0026#39;$.id\u0026#39; = 1; Query OK, 1 row affected (0.01 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u0026gt; select * from testproject; +----+----------------+------------------------------+ | id | skill | student | +----+----------------+------------------------------+ | 10 | [\u0026#34;js\u0026#34;, \u0026#34;java\u0026#34;] | {\u0026#34;id\u0026#34;: 1, \u0026#34;addr\u0026#34;: \u0026#34;è‹å·\u0026#34;} | | 11 | [] | {\u0026#34;id\u0026#34;: 5, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | | 12 | [1, 2, 3] | {\u0026#34;id\u0026#34;: 4, \u0026#34;name\u0026#34;: \u0026#34;guogege\u0026#34;} | +----+----------------+------------------------------+ 3 rows in set (0.00 sec) å¯ä»¥çœ‹åˆ°nameå’Œageå°±è¢«ç§»é™¤äº†ã€‚\nä»¥ä¸Šåªåˆ—å‡ºäº†éƒ¨åˆ†å‡½æ•°çš„è¯´æ˜ï¼Œmysqlå®˜æ–¹æä¾›çš„å‡½æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š\næ›´å¤šç”¨æ³•è¯·æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š\nhttps://dev.mysql.com/doc/refman/5.7/en/json-function-reference.html\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/mysql%E6%94%AF%E6%8C%81%E5%8E%9F%E7%94%9Fjson%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eMySQLåœ¨5.7.8å¼€å§‹å¯¹jsonåŸç”Ÿæ”¯æŒï¼Œæœ¬æ–‡å°†å¯¹MySQLä¸­jsonç±»å‹çš„ç”¨æ³•ç®€å•è¯´æ˜ï¼Œå¸Œæœ›å¯¹ä½ æœ‰ç”¨ã€‚\u003c/p\u003e","title":"mysqlæ”¯æŒåŸç”Ÿjsonä½¿ç”¨è¯´æ˜","type":"posts"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/springmvc/","section":"Tags","summary":"","title":"Springmvc","type":"tags"},{"content":" æ­£æ–‡ # ä»Šå¤©æ¥è¯•ç€ç”¨SpringMVCå‘é€é‚®ä»¶ï¼Œä¸»è¦éœ€è¦ä¾èµ–ä»¥ä¸‹ä¸¤ä¸ªåŒ…ï¼›\n\u0026lt;!--springå‘é€é‚®ä»¶ä¾èµ–spring.version=4.3.8.RELEASE--\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-context-support\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Javamail API --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;javax.mail\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mail\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.4.5\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; spring-mail.xmlé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;beans xmlns=\u0026#34;http://www.springframework.org/schema/beans\u0026#34; xmlns:context=\u0026#34;http://www.springframework.org/schema/context\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd\u0026#34;\u0026gt; \u0026lt;!-- å¼•å…¥å±æ€§æ–‡ä»¶ --\u0026gt; \u0026lt;context:property-placeholder location=\u0026#34;classpath:config/email.properties\u0026#34; ignore-unresolvable=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;!-- \u0026lt;bean id=\u0026#34;local\u0026#34; class=\u0026#34;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;location\u0026#34; value=\u0026#34;classpath:config/email.properties\u0026#34; /\u0026gt; \u0026lt;property name=\u0026#34;ignoreUnresolvablePlaceholders\u0026#34; value=\u0026#34;true\u0026#34; /\u0026gt; \u0026lt;/bean\u0026gt;--\u0026gt; \u0026lt;!-- ä¸‹é¢åˆ—å‡ºç½‘æ˜“çš„SMTPæœåŠ¡å™¨åå’Œç«¯å£å·: ç½‘æ˜“é‚®ç®± SMTPæœåŠ¡å™¨ SMTPç«¯å£ POP3æœåŠ¡å™¨ POP3ç«¯å£ @126.com smtp.126.com 25 pop3.126.com 110 @163.com smtp.163.com 25 pop3.163.com 110 @yeah.net smtp.yeah.net 25 pop3.yeah.net 110 --\u0026gt; \u0026lt;bean id=\u0026#34;javaMailSender\u0026#34; class=\u0026#34;org.springframework.mail.javamail.JavaMailSenderImpl\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;protocol\u0026#34; value=\u0026#34;${email.protocol}\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;host\u0026#34; value=\u0026#34;${email.host}\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;port\u0026#34; value=\u0026#34;${email.port}\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;username\u0026#34; value=\u0026#34;${email.username}\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;password\u0026#34; value=\u0026#34;${email.password}\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;defaultEncoding\u0026#34; value=\u0026#34;UTF-8\u0026#34;\u0026gt;\u0026lt;/property\u0026gt; \u0026lt;property name=\u0026#34;javaMailProperties\u0026#34;\u0026gt; \u0026lt;props\u0026gt; \u0026lt;prop key=\u0026#34;mail.auth\u0026#34;\u0026gt;${email.auth}\u0026lt;/prop\u0026gt; \u0026lt;prop key=\u0026#34;mail.smtp.timeout\u0026#34;\u0026gt;${email.timout}\u0026lt;/prop\u0026gt; \u0026lt;/props\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;bean id=\u0026#34;simpleMailMessage\u0026#34; class=\u0026#34;org.springframework.mail.SimpleMailMessage\u0026#34;\u0026gt; \u0026lt;!-- å‘ä»¶äººemail --\u0026gt; \u0026lt;property name=\u0026#34;from\u0026#34; value=\u0026#34;${email.username}\u0026#34; /\u0026gt; \u0026lt;!--æ”¶ä»¶äººemail--\u0026gt; \u0026lt;property name=\u0026#34;to\u0026#34; value=\u0026#34;${email.default.to}\u0026#34; /\u0026gt; \u0026lt;!--emailä¸»é¢˜(æ ‡é¢˜)--\u0026gt; \u0026lt;property name=\u0026#34;subject\u0026#34; value=\u0026#34;${email.default.subject}\u0026#34; /\u0026gt; \u0026lt;!--emailä¸»é¢˜å†…å®¹--\u0026gt; \u0026lt;property name=\u0026#34;text\u0026#34;\u0026gt; \u0026lt;value\u0026gt;${email.default.text}\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;bean id=\u0026#34;emailService\u0026#34; class=\u0026#34;com.website.service.impl.EmailServiceImpl\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;javaMailSender\u0026#34; ref=\u0026#34;javaMailSender\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;simpleMailMessage\u0026#34; ref=\u0026#34;simpleMailMessage\u0026#34;/\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;/beans\u0026gt; è¿™é‡ŒåŠ è½½äº†å‘é€é‚®ä»¶ç›¸å…³çš„é…ç½®æ–‡ä»¶email.propertiesï¼š\nemail.protocol=smtp email.host=smtp.163.com email.port=25 email.username=132312312@163.com email.password=yourpassword email.default.to=123121@126.com email.default.subject=Hello email.default.text=how are you email.auth=true email.timout=25000 å‘é€ç®€å•é‚®ä»¶ä»£ç ï¼š\npublic class EmailServiceImpl implements EmailService { private static final Logger LOGGER = LoggerFactory.getLogger(EmailServiceImpl.class); private JavaMailSender javaMailSender; private SimpleMailMessage simpleMailMessage; /** * @æ–¹æ³•å: sendMailSimple * @å‚æ•°åï¼š@param subject é‚®ä»¶ä¸»é¢˜ * @å‚æ•°åï¼š@param content é‚®ä»¶å†…å®¹ * @å‚æ•°åï¼š@param to æ”¶ä»¶äººEmailåœ°å€ * @æè¿°è¯­: å‘é€é‚®ä»¶ */ @Override public void sendMailSimple(String to, String subject, String content) throws Exception { try { //ç”¨äºæ¥æ”¶é‚®ä»¶çš„é‚®ç®± simpleMailMessage.setTo(to); //é‚®ä»¶çš„ä¸»é¢˜ simpleMailMessage.setSubject(subject); //é‚®ä»¶çš„æ­£æ–‡ï¼Œç¬¬äºŒä¸ªbooleanç±»å‹çš„å‚æ•°ä»£è¡¨htmlæ ¼å¼ simpleMailMessage.setText(content); LOGGER.info(\u0026#34;---------------------------{}\u0026#34;, simpleMailMessage); //å‘é€ javaMailSender.send(simpleMailMessage); } catch (Exception e) { throw new MessagingException(\u0026#34;failed to send mail!\u0026#34;, e); } } public void setJavaMailSender(JavaMailSender javaMailSender) { this.javaMailSender = javaMailSender; } public void setSimpleMailMessage(SimpleMailMessage simpleMailMessage) { this.simpleMailMessage = simpleMailMessage; } } è·‘å•å…ƒæµ‹è¯•çš„æ—¶å€™æŠ¥ï¼šCould not resolve placeholderå¼‚å¸¸ï¼Œä¸å¯ä»¥è§£æemail.protocol\nCaused by: org.springframework.beans.factory.BeanDefinitionStoreException: Invalid bean definition with name \u0026#39;javaMailSender\u0026#39; defined in class path resource [config/spring-mail.xml]: Could not resolve placeholder \u0026#39;email.protocol\u0026#39; in value \u0026#34;${email.protocol}\u0026#34;; nested exception is java.lang.IllegalArgumentException: Could not resolve placeholder \u0026#39;email.protocol\u0026#39; in value \u0026#34;${email.protocol}\u0026#34; å¯èƒ½çš„åŸå› ï¼š\n1ã€locationä¸­çš„å±æ€§æ–‡ä»¶é…ç½®é”™è¯¯ï¼›\n2ã€locationä¸­å®šä¹‰çš„é…ç½®æ–‡ä»¶é‡Œé¢æ²¡æœ‰å¯¹åº”çš„placeholderå€¼ï¼›\n3ã€Springå®¹å™¨çš„é…ç½®é—®é¢˜ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯ä½¿ç”¨äº†å¤šä¸ªPropertyPlaceholderConfigureræˆ–è€…å¤šä¸ª context:property-placeholderçš„åŸå› ã€‚\næ’æŸ¥ä»¥åå‘ç°ï¼Œ\napplicationContext.xmlå’Œspring-mail.xmlä¸¤ä¸ªæ–‡ä»¶éƒ½ä½¿ç”¨äº† context:property-placeholderï¼Œå‰è€…åŠ è½½æ•°æ®åº“è¿æ¥é…ç½®ï¼Œåè€…åŠ è½½å‘é€é‚®ä»¶ç›¸å…³é…ç½®ã€‚\n\u0026lt;context:property-placeholder location=\u0026#34;classpath:config/db.properties\u0026#34;/\u0026gt; \u0026lt;context:property-placeholder location=\u0026#34;classpath:config/email.properties\u0026#34;/\u0026gt; è¿™ä¸ªæ˜¯Springå®¹å™¨é‡‡ç”¨åå°„æ‰«æçš„å‘ç°æœºåˆ¶å†³å®šçš„ï¼Œåœ¨Spring 3.0ä¸­ï¼Œå¯ä»¥åŠ ignore-unresolvable=\u0026ldquo;true\u0026quot;è§£å†³ã€‚\n\u0026lt;context:property-placeholder location=\u0026#34;classpath:config/db.properties\u0026#34; ignore-unresolvable=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;context:property-placeholder location=\u0026#34;classpath:config/email.properties\u0026#34; ignore-unresolvable=\u0026#34;true\u0026#34;/\u0026gt; æ³¨æ„ï¼šå¿…é¡»ä¸¤ä¸ªéƒ½è¦åŠ ï¼ŒåŠ ä¸€ä¸ªä¹Ÿä¸è¡Œã€‚\nåœ¨Spring 2.5ä¸­ï¼Œ context:property-placeholderæ²¡æœ‰ignore-unresolvableå±æ€§ï¼Œæ­¤æ—¶å¯ä»¥æ”¹ç”¨PropertyPlaceholderConfigurerã€‚å…¶å®\u0026lt;context:property-placeholder location=\u0026ldquo;xxx.properties\u0026rdquo; ignore-unresolvable=\u0026ldquo;true\u0026rdquo; /\u0026gt;ä¸ä¸‹é¢çš„é…ç½®æ˜¯ç­‰ä»·çš„ã€‚\n\u0026lt;bean id=\u0026#34;local\u0026#34; class=\u0026#34;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;location\u0026#34; value=\u0026#34;classpath:config/email.properties\u0026#34; /\u0026gt; \u0026lt;property name=\u0026#34;ignoreUnresolvablePlaceholders\u0026#34; value=\u0026#34;true\u0026#34; /\u0026gt; \u0026lt;/bean\u0026gt; ä¿®æ”¹ä»¥åï¼Œæµ‹è¯•ç”¨ç±»è¿è¡ŒæˆåŠŸï¼š\nå‘é€é‚®ä»¶æˆåŠŸï¼š\nå…¶å®å‘é€é‚®ä»¶è¿˜å¯ä»¥ç”¨JavaMailå®ç°ï¼Œéœ€è¦ä¾èµ–ä¸¤ä¸ªåŒ…ï¼š\nactivation-1.1.jar\nmail-1.4.2.jar\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/springmvc%E5%AE%9E%E7%8E%B0%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä»Šå¤©æ¥è¯•ç€ç”¨SpringMVCå‘é€é‚®ä»¶ï¼Œä¸»è¦éœ€è¦ä¾èµ–ä»¥ä¸‹ä¸¤ä¸ªåŒ…ï¼›\u003c/p\u003e","title":"SpringMVCå®ç°å‘é€é‚®ä»¶","type":"posts"},{"content":" æ­£æ–‡ # 1ã€ è®¾ç½®WriteHeaderçš„é¡ºåºé—®é¢˜\nä¹‹å‰é‡åˆ°ä¸ªé—®é¢˜ï¼Œåœ¨ä¸€æ®µä»£ç ä¸­è¿™æ ·è®¾ç½®WriteHeader,æœ€ååœ¨headerä¸­å–Nameæ—¶æ€ä¹ˆä¹Ÿå–ä¸åˆ°ã€‚\nw.WriteHeader(201) w.Header().Set(\u0026#34;Name\u0026#34;, \u0026#34;my name is smallsoup\u0026#34;) ç”¨ golang å†™ http server æ—¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿å¯é€šè¿‡ w.Header.Set(k, v) æ¥è®¾ç½® http response ä¸­ header çš„å†…å®¹ã€‚ä½†æ˜¯éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼šæŸäº›æ—¶å€™ä¸ä»…è¦ä¿®æ”¹ responseçš„header ï¼Œè¿˜è¦ä¿®æ”¹ responseçš„StatusCodeã€‚ä¿®æ”¹responseçš„StatusCode å¯ä»¥é€šè¿‡ï¼šw.WriteHeader(code) æ¥å®ç°ï¼Œä¾‹å¦‚ï¼š\nw.WriteHeader(404) å¦‚æœè¿™ä¸¤ç§ä¿®æ”¹ä¸€èµ·åšï¼Œå°±å¿…é¡»è®© w.WriteHeader åœ¨æ‰€æœ‰çš„ w.Header.Set ä¹‹åï¼Œå› ä¸º w.WriteHeader å Set Header æ˜¯æ— æ•ˆçš„ã€‚\nè€Œä¸”å¿…é¡»æ˜¯åœ¨ w.Write([]byte(\u0026ldquo;HelloWorld\u0026rdquo;)) ä¹‹å‰ï¼Œå¦åˆ™ä¼šæŠ¥ http: multiple response.WriteHeader calls å› ä¸ºå…¶å®è°ƒç”¨w.Writeçš„æ—¶å€™ä¹Ÿä¼šè°ƒç”¨WriteHeader()æ–¹æ³•ï¼Œç„¶åå°†w.wroteHeaderç½®ä¸ºtrueï¼Œå†æ¬¡è°ƒWriteHeader()åˆ™ä¼šåˆ¤æ–­wroteHeaderï¼Œå¦‚æœæ˜¯trueåˆ™ä¼šæŠ¥é”™ï¼Œè€Œä¸”æœ¬æ¬¡è°ƒç”¨ä¸ç”Ÿæ•ˆã€‚\nå¯ä»¥çœ‹ä»¥ä¸‹æºç è¯´æ˜WriteHeaderå¿…é¡»åœ¨Writeä¹‹å‰è°ƒç”¨ã€‚\nfunc (w *response) WriteHeader(code int) { if w.conn.hijacked() { w.conn.server.logf(\u0026#34;http: response.WriteHeader on hijacked connection\u0026#34;) return } //ç¬¬äºŒæ¬¡WriteHeader()è¿›æ¥æ»¡è¶³ifæ¡ä»¶å°±æŠ¥é”™ç›´æ¥return if w.wroteHeader { w.conn.server.logf(\u0026#34;http: multiple response.WriteHeader calls\u0026#34;) return } //ç¬¬ä¸€æ¬¡write()è¿›æ¥è¿™é‡Œä¼šå°†w.wroteHeaderç½®ä¸ºtrue w.wroteHeader = true w.status = code if w.calledHeader \u0026amp;\u0026amp; w.cw.header == nil { w.cw.header = w.handlerHeader.clone() } if cl := w.handlerHeader.get(\u0026#34;Content-Length\u0026#34;); cl != \u0026#34;\u0026#34; { v, err := strconv.ParseInt(cl, 10, 64) if err == nil \u0026amp;\u0026amp; v \u0026gt;= 0 { w.contentLength = v } else { w.conn.server.logf(\u0026#34;http: invalid Content-Length of %q\u0026#34;, cl) w.handlerHeader.Del(\u0026#34;Content-Length\u0026#34;) } } } 2ã€ goä¼šå¯¹Headerä¸­çš„keyè¿›è¡Œè§„èŒƒåŒ–å¤„ç†\ngoä¼šå¯¹Headerä¸­çš„keyè¿›è¡Œè§„èŒƒåŒ–å¤„ç†ï¼Œæ‰€ä»¥åœ¨è·å–responseçš„Headerä¸­çš„K,Vå€¼æ—¶ä¸€å®šè¦å°å¿ƒã€‚\nreader.goä¸­éå¯¼å‡ºæ–¹æ³•canonicalMIMEHeaderKeyä¸­æœ‰è¿™æ ·ä¸€æ®µï¼Œä¼šå°†headerçš„keyè¿›è¡Œè§„èŒƒåŒ–å¤„ç†ã€‚\n1ï¼‰reader.goä¸­å®šä¹‰äº†isTokenTableæ•°ç»„ï¼Œå¦‚æœkeyçš„é•¿åº¦å¤§äº127æˆ–è€…åŒ…å«ä¸åœ¨isTokenTableä¸­çš„å­—ç¬¦ï¼Œåˆ™è¯¥keyä¸ä¼šè¢«å¤„ç†ã€‚\n2ï¼‰å°†keyçš„é¦–å­—æ¯å¤§å†™ï¼Œå­—ç¬¦ - åçš„å•è¯çš„é¦–å­—æ¯ä¹Ÿå¤§å†™ã€‚\nåˆ†æå¦‚ä¸‹æºç ï¼Œå¯ä»¥è§£é‡Šå¯¹keyçš„å¤§å†™å¤„ç†ï¼š\nfor i, c := range a { // è§„èŒƒåŒ–:é¦–å­—æ¯å¤§å†™ // - ä¹‹åå•å­çš„é¦–å­—æ¯å¤§å†™ // å¦‚:(Host, User-Agent, If-Modified-Since). if upper \u0026amp;\u0026amp; \u0026#39;a\u0026#39; \u0026lt;= c \u0026amp;\u0026amp; c \u0026lt;= \u0026#39;z\u0026#39; { //å¤§å†™è½¬å°å†™ c -= toLower } else if !upper \u0026amp;\u0026amp; \u0026#39;A\u0026#39; \u0026lt;= c \u0026amp;\u0026amp; c \u0026lt;= \u0026#39;Z\u0026#39; { //å°å†™è½¬å¤§å†™ c += toLower } //é‡æ–°ç»™keyæ•°ç»„èµ‹å€¼ a[i] = c //è®¾ç½®å¤§å°å†™æ ‡å¿—ä½ upper = c == \u0026#39;-\u0026#39; // for next time } æ­£ç¡®çš„è°ƒç”¨æ–¹å¼ï¼š\næœåŠ¡å™¨ï¼šmyServer.go\npackage main import ( \u0026#34;net/http\u0026#34; ) func main() { http.HandleFunc(\u0026#34;/\u0026#34;, func (w http.ResponseWriter, r *http.Request){ w.Header().Set(\u0026#34;name\u0026#34;, \u0026#34;my name is smallsoup\u0026#34;) w.WriteHeader(500) w.Write([]byte(\u0026#34;hello world\\n\u0026#34;)) }) http.ListenAndServe(\u0026#34;:8080\u0026#34;, nil) } å®¢æˆ·ç«¯ï¼š\nmyHttp.goï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { myHttpGet() } func myHttpGet() { rsp, err := http.Get(\u0026#34;http://localhost:8080\u0026#34;) if err != nil { fmt.Println(\u0026#34;myHttpGet error is \u0026#34;, err) return } defer rsp.Body.Close() body, err := ioutil.ReadAll(rsp.Body) if err != nil { fmt.Println(\u0026#34;myHttpGet error is \u0026#34;, err) return } fmt.Println(\u0026#34;response statuscode is \u0026#34;, rsp.StatusCode, \u0026#34;\\nhead[name]=\u0026#34;, rsp.Header[\u0026#34;Name\u0026#34;], \u0026#34;\\nbody is \u0026#34;, string(body)) } 1.è¿è¡ŒæœåŠ¡å™¨\ngo run myServer.go\n2.è¿è¡Œå®¢æˆ·ç«¯\ngo run myHttp.go\nè¾“å‡ºå¦‚ä¸‹ï¼šstatuscodeæ˜¯æˆ‘ä»¬è®¾ç½®çš„500ï¼ŒNameä¹Ÿå–åˆ°äº†å€¼ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/golang%E8%AE%BE%E7%BD%AEhttpresponse%E5%93%8D%E5%BA%94%E5%A4%B4%E4%B8%8E%E5%9D%91/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e1ã€ è®¾ç½®WriteHeaderçš„é¡ºåºé—®é¢˜\u003c/strong\u003e\u003c/p\u003e","title":"golang è®¾ç½® http response å“åº”å¤´ä¸å‘","type":"posts"},{"content":" æ­£æ–‡ # ä»Šå¤©æ¥ç”¨javaå®ç°æ‰‹æœºéªŒè¯ç çš„å‘é€ã€‚\nçŸ­ä¿¡å¹³å°æœ‰å¾ˆå¤šï¼Œä¸­å›½ç½‘å»ºæä¾›çš„SMSçŸ­ä¿¡é€šï¼Œæ³¨å†Œå…è´¹5æ¡çŸ­ä¿¡ï¼Œ3æ¡å½©ä¿¡ï¼Œ\nhttp://sms.webchinese.cn/\nä½†æ˜¯åˆšæ‰è¯•äº†ï¼Œç¬¬ä¸€æ¬¡ç”¨å®˜æ–¹æä¾›çš„demoå‘é€æˆåŠŸï¼Œç„¶åæ•´åˆåˆ°è‡ªå·±é¡¹ç›®ä¸­ï¼Œè°ƒè¯•æ—¶ç”±äºå‚æ•°é…ç½®é”™è¯¯å¯¼è‡´å‘é€äº†å‡ æ¬¡å¤±è´¥åï¼Œ5æ¬¡å°±ç”¨å®Œäº†ã€‚æŒ‰ç†è¯´æˆåŠŸæ‰èƒ½ç®—ä¸€æ¬¡ï¼Œæœæ–­æ”¾å¼ƒã€‚\nç„¶åè¯•äº†ä¸€ä¸‹è…¾è®¯äº‘SMSå¹³å°ï¼Œæ¯æœˆå¯ä»¥å…è´¹å‘é€100æ¡å›½å†…çŸ­ä¿¡\nhttps://cloud.tencent.com/product/sms\né¦–å…ˆéœ€è¦æ³¨å†Œè…¾è®¯äº‘è´¦å·ï¼Œæ³¨å†Œæ—¶å¯ä»¥å¾®ä¿¡è®¤è¯ï¼Œè®¤è¯æ—¶æ”¯ä»˜1åˆ†é’±éªŒè¯æ˜¯äººä¸ºæ“ä½œï¼Œè¿™ä¸€åˆ†é’±æ³¨å†ŒæˆåŠŸåä¼šæ”¾åˆ°è´¦æˆ·ä¸­ã€‚\næ³¨å†Œåï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªåº”ç”¨ï¼Œè¿™ä¸ªéšä¾¿å†™ï¼Œåˆ›å»ºå¥½åç‚¹å‡» -\u0026gt; åº”ç”¨åç§°ï¼Œç„¶çœ‹AppIDå’ŒAppKeyï¼Œè¿™ä¸ªæ¯”è¾ƒé‡è¦ï¼Œè°ƒç”¨çŸ­ä¿¡APIæ¥å£æ—¶éœ€è¦æä¾›ã€‚\nç„¶åéœ€è¦åœ¨ -\u0026gt; å›½å†…çŸ­ä¿¡ -\u0026gt; çŸ­ä¿¡å†…å®¹é…ç½® -\u0026gt; çŸ­ä¿¡ç­¾åä¸­åˆ›å»ºç­¾åå’ŒçŸ­ä¿¡æ­£æ–‡ä¸­åˆ›å»ºæ­£æ–‡æ¨¡æ¿ã€‚\nä¸€ä¸ªå®Œæ•´çš„çŸ­ä¿¡ç”±çŸ­ä¿¡ç­¾åå’ŒçŸ­ä¿¡æ­£æ–‡å†…å®¹ä¸¤éƒ¨åˆ†ç»„æˆï¼Œæ‚¨å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚åˆ†åˆ«è®¾ç½®ä¸åŒçš„çŸ­ä¿¡æ­£æ–‡å†…å®¹æ¨¡æ¿ï¼Œç„¶åè¿›è¡Œç»„åˆå½¢æˆæœ€ç»ˆå±•ç¤ºã€‚çŸ­ä¿¡ç­¾å+çŸ­ä¿¡æ­£æ–‡å†…å®¹=æœ€ç»ˆæ˜¾ç¤ºå†…å®¹\nå®¡æ ¸å¯èƒ½å¾—éœ€è¦èŠ±ä¸€æ®µæ—¶é—´ï¼Œæˆ‘åˆ›å»ºåï¼Œå®¡æ ¸åªèŠ±äº†2å°æ—¶ä¸åˆ°ã€‚è¿™äº›æ­¥éª¤åšå®Œä¹‹åï¼Œå°±å¯ä»¥æ ¹æ®å®˜æ–¹æä¾›çš„APIæ¥å£å‘é€çŸ­ä¿¡äº†ã€‚\nhttps://cloud.tencent.com/document/product/382/5808\nå®˜æ–¹æä¾›äº†javaã€pythonã€c#ã€node.jsçš„SDKï¼Œè¿™é‡Œç”¨javaçš„SDKè°ƒç”¨ï¼Œè¿™é‡Œæœ‰è¯¦ç»†è¯´æ˜ï¼š\nhttps://github.com/qcloudsms/qcloudsms_java\né¦–å…ˆåŠ å…¥mavenä¾èµ–ï¼š\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.github.qcloudsms\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;qcloudsms\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.0.4\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ç¼–å†™è°ƒç”¨SDKçš„ä»£ç ï¼š\n/** * è…¾è®¯äº‘çŸ­ä¿¡,100æ¡ä¸€ä¸ªæœˆ * æ–¹æ³•è¯´æ˜ * * @param phone * @return void * @Discription:æ‰©å±•è¯´æ˜ * @throws HTTPException http status exception * @throws IOException network problem */ public static void sendMsgByTxPlatform(String phone) throws Exception { // çŸ­ä¿¡åº”ç”¨SDK AppID // 1400å¼€å¤´ int appId = 1402126548; // çŸ­ä¿¡åº”ç”¨SDK AppKey String appKey = \u0026#34;b67d0bf7876c1d42121ca561953532\u0026#34;; // éœ€è¦å‘é€çŸ­ä¿¡çš„æ‰‹æœºå·ç  // String[] phoneNumbers = {\u0026#34;15212111830\u0026#34;}; // çŸ­ä¿¡æ¨¡æ¿IDï¼Œéœ€è¦åœ¨çŸ­ä¿¡åº”ç”¨ä¸­ç”³è¯· //NOTE: è¿™é‡Œçš„æ¨¡æ¿ID`7839`åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼ŒçœŸå®çš„æ¨¡æ¿IDéœ€è¦åœ¨çŸ­ä¿¡æ§åˆ¶å°ä¸­ç”³è¯· int templateId = 148464; // ç­¾å // NOTE: è¿™é‡Œçš„ç­¾å\u0026#34;è…¾è®¯äº‘\u0026#34;åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼ŒçœŸå®çš„ç­¾åéœ€è¦åœ¨çŸ­ä¿¡æ§åˆ¶å°ä¸­ç”³è¯·ï¼Œå¦å¤–ç­¾åå‚æ•°ä½¿ç”¨çš„æ˜¯`ç­¾åå†…å®¹`ï¼Œè€Œä¸æ˜¯`ç­¾åID` String smsSign = \u0026#34;è¿›å‡»äº‘åŸç”Ÿ\u0026#34;; SmsSingleSender sSender = new SmsSingleSender(appId, appKey); //ç¬¬ä¸€ä¸ªå‚æ•°0è¡¨ç¤ºæ™®é€šçŸ­ä¿¡,1è¡¨ç¤ºè¥é”€çŸ­ä¿¡ SmsSingleSenderResult result = sSender.send(0, \u0026#34;86\u0026#34;, phone, RandomCodeUtils.getSixValidationCode() + \u0026#34;ä¸ºæ‚¨çš„ç™»å½•éªŒè¯ç ï¼Œè¯·äº\u0026#34; + 10 + \u0026#34;åˆ†é’Ÿå†…å¡«å†™ã€‚å¦‚éæœ¬äººæ“ä½œï¼Œè¯·å¿½ç•¥æœ¬çŸ­ä¿¡ã€‚\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;); if (result.result != 0) { throw new Exception(\u0026#34;send phone validateCode is error\u0026#34; + result.errMsg); } } å‚æ•°è¯´æ˜ï¼š\n@param type çŸ­ä¿¡ç±»å‹ï¼Œ0 ä¸ºæ™®é€šçŸ­ä¿¡ï¼Œ1 è¥é”€çŸ­ä¿¡,éœ€è¦å’Œåˆšæ‰é¡µé¢ä¸Šæäº¤çš„çŸ­ä¿¡æ­£æ–‡ä¸‹çš„ç±»å‹ä¸€è‡´ @param nationCode å›½å®¶ç ï¼Œå¦‚ 86 ä¸ºä¸­å›½ @param phoneNumber ä¸å¸¦å›½å®¶ç çš„æ‰‹æœºå· @param msg ä¿¡æ¯å†…å®¹ï¼Œå¿…é¡»ä¸ç”³è¯·çš„æ¨¡æ¿æ ¼å¼ä¸€è‡´ï¼Œå¦åˆ™å°†è¿”å›é”™è¯¯ï¼Œ{1}å ä½ç¬¦å¯åœ¨ä»£ç ä¸­ç”¨å®é™…éœ€è¦å‘é€çš„å€¼æ›¿æ¢ @param extend æ‰©å±•ç ï¼Œå¯å¡«ç©º @param ext æœåŠ¡ç«¯åŸæ ·è¿”å›çš„å‚æ•°ï¼Œå¯å¡«ç©º ç¼–å†™å¥½ä»¥åç”¨æµ‹è¯•ç±»æµ‹è¯•æ—¶ï¼Œè¿”å›é”™è¯¯ç 1014ï¼Œå¯ä»¥ç‚¹å‡»é”™è¯¯æè¿°ä¸­çš„é“¾æ¥å»æŸ¥çœ‹å¯èƒ½çš„åŸå› ã€‚æˆ‘æ˜¯ç”±äºæ­£æ–‡å†…å®¹å’Œåˆšæ‰é¡µé¢ä¸Šæäº¤çš„æ­£æ–‡ä¸ä¸€æ ·å¯¼è‡´çš„ã€‚\nhttps://cloud.tencent.com/document/product/382/3771\nä»¥ä¸‹æœ‰å¾ˆå¤šé”™è¯¯ç ï¼Œå¯ä»¥ä¾›æ’æŸ¥é—®é¢˜å‚è€ƒï¼š\næ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿”å›çš„resultä¸º0æ—¶è¡¨ç¤ºå‘é€æˆåŠŸï¼Œè¿™ä¹Ÿæ˜¯100æ¡æ¬¡æ•°å‡1çš„å‚è€ƒã€‚æŒ‰ç…§æ¥å£è¦æ±‚ä¿®æ”¹å‚æ•°åï¼Œå‘é€çŸ­ä¿¡æˆåŠŸã€‚\nä¹Ÿæœ‰å¾ˆå¤šå…¶ä»–å¹³å°æä¾›çš„çŸ­ä¿¡æœåŠ¡ï¼Œæ¯”å¦‚é˜¿é‡Œäº‘å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼š\nhttps://blog.csdn.net/u014520797/article/details/54411392\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/java%E5%8F%91%E9%80%81%E6%89%8B%E6%9C%BA%E9%AA%8C%E8%AF%81%E7%A0%81%E5%AE%9E%E7%8E%B0/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180526.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä»Šå¤©æ¥ç”¨javaå®ç°æ‰‹æœºéªŒè¯ç çš„å‘é€ã€‚\u003c/p\u003e","title":"javaå‘é€æ‰‹æœºéªŒè¯ç å®ç°","type":"posts"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/%E7%9F%AD%E4%BF%A1/","section":"Tags","summary":"","title":"çŸ­ä¿¡","type":"tags"},{"content":" æ­£æ–‡ # ä»Šå¤©æ¥å­¦ä¹ ä¸‹å›¾å½¢éªŒè¯ç çš„ç”Ÿæˆï¼Œé¦–å…ˆä¾èµ–å¼€æºç»„ä»¶ï¼š\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.github.penggle\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;kaptcha\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.3.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; åœ¨web.xmlä¸­é…ç½®åä¸ºKaptchaçš„servletï¼š\n\u0026lt;servlet\u0026gt; \u0026lt;!-- ç”Ÿæˆå›¾ç‰‡çš„Servlet --\u0026gt; \u0026lt;servlet-name\u0026gt;Kaptcha\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;com.google.code.kaptcha.servlet.KaptchaServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;!-- æ˜¯å¦æœ‰è¾¹æ¡† --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;kaptcha.border\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;no\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;!-- å­—ä½“é¢œè‰² --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;kaptcha.textproducer.font.color\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;red\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;!-- å›¾ç‰‡å®½åº¦ --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;kaptcha.image.width\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;135\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;!-- ä½¿ç”¨å“ªäº›å­—ç¬¦ç”ŸæˆéªŒè¯ç  --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;kaptcha.textproducer.char.string\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;ACDEFHKPRSTWX345679\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;!-- å›¾ç‰‡é«˜åº¦ --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;kaptcha.image.height\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;50\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;!-- å­—ä½“å¤§å° --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;kaptcha.textproducer.font.size\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;43\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;!-- å¹²æ‰°çº¿çš„é¢œè‰² --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;kaptcha.noise.color\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;black\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;!-- å­—ç¬¦ä¸ªæ•° --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;kaptcha.textproducer.char.length\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;4\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;!-- ä½¿ç”¨å“ªäº›å­—ä½“ --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;kaptcha.textproducer.font.names\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;Arial\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;!-- æ˜ å°„çš„url --\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;Kaptcha\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/Kaptcha\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; htmlä¸­æ·»åŠ éªŒè¯ç æ ‡ç­¾ï¼Œå¹¶ç»‘å®šjavascriptäº‹ä»¶ï¼š\n\u0026lt;!--éªŒè¯ç --\u0026gt; \u0026lt;li class=\u0026#34;align-top\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;item-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;item-inner\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;item---- title label\u0026#34;\u0026gt;éªŒè¯ç \u0026lt;/div\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; id=\u0026#34;j_captcha\u0026#34; placeholder=\u0026#34;éªŒè¯ç \u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;item-input\u0026#34;\u0026gt; \u0026lt;img id=\u0026#34;captcha_img\u0026#34; alt=\u0026#34;ç‚¹å‡»æ›´æ¢\u0026#34; --- title=\u0026#34;ç‚¹å‡»æ›´æ¢\u0026#34; src=\u0026#34;../Kaptcha\u0026#34; onclick=\u0026#34;changeVerifyCode(this)\u0026#34;/\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt; function changeVerifyCode(img) { // alert(\u0026#34;asssssssssss\u0026#34;); img.src = \u0026#34;../Kaptcha?\u0026#34; + Math.floor(Math.random() * 100); }; \u0026lt;/script\u0026gt; æ•ˆæœå›¾ï¼š\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/java%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81%E5%AE%9E%E7%8E%B0/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190705.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä»Šå¤©æ¥å­¦ä¹ ä¸‹å›¾å½¢éªŒè¯ç çš„ç”Ÿæˆï¼Œé¦–å…ˆä¾èµ–å¼€æºç»„ä»¶ï¼š\u003c/p\u003e","title":"javaå›¾å½¢éªŒè¯ç å®ç°","type":"posts"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/%E9%AA%8C%E8%AF%81%E7%A0%81/","section":"Tags","summary":"","title":"éªŒè¯ç ","type":"tags"},{"content":" æ­£æ–‡ # ä»Šå¤©åœ¨tomcaté‡Œéƒ¨ç½²è¿è¡Œäº†ä¸€ä¸ªå°å·¥ç¨‹ï¼Œå·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š\nè¿è¡ŒtomcatæœåŠ¡å™¨åï¼Œè®¿é—®index.htmlï¼Œå‘ç°æŠ¥404ï¼š\nä½†æ˜¯åå°æ¥å£æ˜¯æ­£å¸¸è¿”å›çš„ï¼š\nå»çœ‹webappsé‡Œå·¥ç¨‹ç›®å½•ä¸‹ï¼Œindex.htmlæ–‡ä»¶æ˜¯æœ‰çš„ï¼Œè§é¬¼äº†ï¼Œæ˜¯å“ªå„¿å‡ºäº†é—®é¢˜ï¼Ÿ\nç„¶åçœ‹åˆ°æ§åˆ¶å°æ—¥å¿—ï¼ˆæˆ–è€…tomcat_home/logs/catalina.logï¼‰æŠ¥é”™å¦‚ä¸‹ï¼š\norg.springframework.web.servlet.PageNotFound.noHandlerFound No mapping fo und for HTTP request with URI [/artmuseum/index.html] in DispatcherServlet with name \u0026#39;springmvc\u0026#39; å¤§è‡´æ„æ€æ˜¯springmvcè¿™ä¸ªservletå¤„ç†ä¸äº†index.htmlã€‚åŸæ¥æ˜¯é…ç½®æœ‰é—®é¢˜ã€‚\nçœ‹çœ‹web.xmlé…ç½®ï¼Œæ˜¯è¿™æ ·å†™çš„ï¼š\n\u0026lt;!-- æ³¨å†Œå‰ç«¯æ§åˆ¶å™¨ --\u0026gt; \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;springmvc\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;org.springframework.web.servlet.DispatcherServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;contextConfigLocation\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;classpath*:config/spring-*.xml\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;springmvc\u0026lt;/servlet-name\u0026gt; \u0026lt;!--é»˜è®¤åŒ¹é…æ‰€æœ‰çš„è¯·æ±‚--\u0026gt; \u0026lt;url-pattern\u0026gt;/\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; è¿™é‡Œurl-patternåŒ¹é…æ‰€æœ‰è¯·æ±‚ï¼Œå¯ä»¥å®ç°ç°åœ¨å¾ˆæµè¡Œçš„RESTé£æ ¼ï¼Œä½†æ˜¯ä¼šå¯¼è‡´jsã€htmlã€cssç­‰é™æ€èµ„æºè¢«æ‹¦æˆªï¼Œæ‹¦æˆªåæ‰¾ä¸åˆ°å¯¹åº”çš„Handlerå»å¤„ç†ï¼Œå°±ä¼šæŠ¥404\nå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å»è§£å†³ï¼š\n1ã€\nåœ¨web.xmlä¸­é…ç½®é»˜è®¤servletï¼Œå»å¤„ç†é™æ€èµ„æºï¼Œé…ç½®å¦‚ä¸‹ï¼š\n\u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;default\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.html\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;default\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.css\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;default\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.xml\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;default\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.swf\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; è¿™æ ·é…ç½®åï¼ŒåŒ¹é…åˆ°çš„é™æ€èµ„æºä¼šè¢«Servletåç§°æ˜¯\u0026quot;default\u0026quot;çš„DefaultServletHttpRequestHandlerå»å¤„ç†ï¼Œè¿™æ ·å°±å¯ä»¥æ‰¾åˆ°äº†ã€‚ä½†æ˜¯è¯¥æ–¹å¼æ¯ç§é™æ€èµ„æºæ–‡ä»¶éƒ½å¾—é…ç½®ä¸€ä¸ªã€‚\n2ã€\nåœ¨spring3.0.4ä»¥åç‰ˆæœ¬æä¾›äº†mvc:resources,ä½¿ç”¨æ–¹æ³•ï¼š\n\u0026lt;!-- å¯¹é™æ€èµ„æºæ–‡ä»¶çš„è®¿é—® --\u0026gt; \u0026lt;mvc:resources mapping=\u0026#34;/css/**\u0026#34; location=\u0026#34;/css/\u0026#34; /\u0026gt; \u0026lt;mvc:resources mapping=\u0026#34;/js/**\u0026#34; location=\u0026#34;/js/\u0026#34; /\u0026gt; ä½¿ç”¨ mvc:resources/å…ƒç´ ,æŠŠmappingçš„URIæ³¨å†Œåˆ°SimpleUrlHandlerMappingçš„urlMapä¸­,\nkeyä¸ºmappingçš„URI patternå€¼,è€Œvalueä¸ºResourceHttpRequestHandler,\nè¿™æ ·å°±å·§å¦™çš„æŠŠå¯¹é™æ€èµ„æºçš„è®¿é—®ç”±HandlerMappingè½¬åˆ°ResourceHttpRequestHandlerå¤„ç†å¹¶è¿”å›,æ‰€ä»¥å°±æ”¯æŒclasspathç›®å½•,jaråŒ…å†…é™æ€èµ„æºçš„è®¿é—®ã€‚\n3ã€\nä½¿ç”¨ mvc:default-servlet-handler/\n\u0026lt;mvc:default-servlet-handler/\u0026gt; è¯¥æ ‡ç­¾ä¼šæŠŠ\u0026quot;/**\u0026quot; url,æ³¨å†Œåˆ°SimpleUrlHandlerMappingçš„urlMapä¸­,æŠŠå¯¹é™æ€èµ„æºçš„è®¿é—®ç”±HandlerMappingè½¬åˆ°DefaultServletHttpRequestHandler å¤„ç†å¹¶è¿”å›ï¼Œ\nDefaultServletHttpRequestHandlerä½¿ç”¨å°±æ˜¯å„ä¸ªServletå®¹å™¨è‡ªå·±çš„é»˜è®¤Servlet\næŒ‰ç…§æœ€ç®€å•çš„ç¬¬ä¸‰ç§æ–¹å¼ï¼Œä¿®æ”¹ä»¥åï¼Œindex.htmlé¡µé¢è®¿é—®æ­£å¸¸ï¼š\næ€»ç»“ä¸€ä¸‹ï¼Œå½’æ ¹ç»“åº•è¿˜æ˜¯è‡ªå·±å¯¹SpringMVCä¸ç†Ÿæ‚‰ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/java%E8%BF%99%E4%B8%AA404%E4%BD%A0%E8%83%BD%E8%A7%A3%E5%86%B3%E5%90%97/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä»Šå¤©åœ¨tomcaté‡Œéƒ¨ç½²è¿è¡Œäº†ä¸€ä¸ªå°å·¥ç¨‹ï¼Œå·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š\u003c/p\u003e","title":"javaè¿™ä¸ª404ä½ èƒ½è§£å†³å—ï¼Ÿ","type":"posts"},{"content":" æ­£æ–‡ # ä»Šå¤©åˆ©ç”¨javaå‘é‚®ä»¶ï¼Œæœ¬åœ°windowsä¸Šæµ‹è¯•æ—¶å‘é€okçš„ï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šå´æŠ¥å¼‚å¸¸ï¼Œè®©æˆ‘ä»¬èµ°è¿›å¼‚å¸¸ï¼Œæ¢ç´¢åˆ°åº•å‘åœ¨å“ªé‡Œï¼Œå¹¶å¡«ä¹‹ã€‚\nåˆ©ç”¨outlookå‘é‚®ä»¶ä»£ç å¦‚ä¸‹ï¼š\npackage com.website.service.impl; import com.alibaba.fastjson.JSON; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.Qualifier; import org.springframework.mail.javamail.JavaMailSenderImpl; import org.springframework.mail.javamail.MimeMessageHelper; import javax.mail.internet.MimeMessage; import java.util.Properties; /** * @program: WebSite * @description: SpringMvcå®ç°çš„å‘é€email * @author: smallsoup * @create: 2018-06-30 20:29 **/ public class EmailServiceImpl { private static final Logger LOGGER = LoggerFactory.getLogger(Test.class); @Autowired @Qualifier(\u0026#34;javaMailSender\u0026#34;) private JavaMailSenderImpl sender; /** * @æ–¹æ³•å: sendMail * @å‚æ•°åï¼š@param subject é‚®ä»¶ä¸»é¢˜ * @å‚æ•°åï¼š@param content é‚®ä»¶å†…å®¹ * @å‚æ•°åï¼š@param to æ”¶ä»¶äººEmailåœ°å€ * @æè¿°è¯­: å‘é€é‚®ä»¶ */ public void sendMailHtml(String to, String subject, String content) throws Exception { sender.setUsername(\u0026#34;yourusername@outlook.com\u0026#34;); sender.setPassword(\u0026#34;your_password\u0026#34;); sender.setPort(587); Properties props = new Properties(); props.setProperty(\u0026#34;mail.transport.protocol\u0026#34;, \u0026#34;smtp\u0026#34;); props.setProperty(\u0026#34;mail.smtp.host\u0026#34;, \u0026#34;smtp-mail.outlook.com\u0026#34;); props.setProperty(\u0026#34;mail.smtp.starttls.enable\u0026#34;, \u0026#34;true\u0026#34;); props.setProperty(\u0026#34;mail.smtp.auth\u0026#34;, \u0026#34;true\u0026#34;); props.setProperty(\u0026#34;mail.smtp.socketFactory.class\u0026#34;, \u0026#34;javax.net.ssl.SSLSocketFactory\u0026#34;); props.setProperty(\u0026#34;mail.smtp.socketFactory.port\u0026#34;, \u0026#34;587\u0026#34;); props.setProperty(\u0026#34;mail.smtp.socketFactory.fallback\u0026#34;, \u0026#34;true\u0026#34;); props.setProperty(\u0026#34;mail.smtp.auth.ntlm.domain\u0026#34;, \u0026#34;THING\u0026#34;); sender.setJavaMailProperties(props); //å»ºç«‹é‚®ä»¶æ¶ˆæ¯,å‘é€ç®€å•é‚®ä»¶å’Œhtmlé‚®ä»¶çš„åŒºåˆ« MimeMessage mailMessage = sender.createMimeMessage(); MimeMessageHelper messageHelper = new MimeMessageHelper(mailMessage); messageHelper.setFrom(\u0026#34;smallsoup@outlook.com\u0026#34;); //ç”¨äºæ¥æ”¶é‚®ä»¶çš„é‚®ç®± messageHelper.setTo(to); //é‚®ä»¶çš„ä¸»é¢˜ messageHelper.setSubject(subject); //é‚®ä»¶çš„æ­£æ–‡ï¼Œç¬¬äºŒä¸ªbooleanç±»å‹çš„å‚æ•°ä»£è¡¨htmlæ ¼å¼ messageHelper.setText(content, true); LOGGER.info(\u0026#34;----------sendMailHtml-----------------\u0026#34;); LOGGER.info(\u0026#34;----------mailMessage is------------FROM:{}, Subject:{}, content:{}, AllRecipients:{}\u0026#34;, mailMessage.getFrom(), mailMessage.getSubject(), mailMessage.getContent(), JSON.toJSONString(mailMessage.getAllRecipients())); //å‘é€ sender.send(mailMessage); } } ä¸Šé¢çš„ä»£ç æ‰“åŒ…åœ¨æœ¬åœ°tomcatä¸Šè¿è¡Œï¼Œå¯ä»¥å‘é€é‚®ä»¶æˆåŠŸã€‚ä½†æ˜¯å°†waråŒ…éƒ¨ç½²åˆ°äºšé©¬é€Šäº‘æœåŠ¡å™¨ä¸Šå‘é€é‚®ä»¶æŠ¥é”™ï¼š\nç½‘ä¸Šè¯´æ˜¯ç”±äºç”¨æˆ·åå’Œå¯†ç ä¸æ­£ç¡®å¯¼è‡´éªŒè¯å¤±è´¥ã€‚ä½†æ˜¯è¿™ä¸èƒ½è§£é‡Šæœ¬åœ°èƒ½å‘å‡ºå»é‚®ä»¶çš„äº‹å®ã€‚ç»§ç»­æ’æŸ¥ã€googleï¼Œå®åœ¨æ‰¾ä¸åˆ°è§£å†³åŠæ³•ã€‚é‚£å°±è¯•ç€ç™»é™†ä¸‹outlooké‚®ä»¶çœ‹èƒ½ä¸èƒ½ç™»è¿›å»ï¼Œç™»é™†æ­£å¸¸ï¼Œæœ‰ä¸€å°æœ€è¿‘çš„ä¸€æ¬¡ç™»å½•å­˜åœ¨æŸäº›å¼‚å¸¸çš„é‚®ä»¶ã€‚\nç„¶åç‚¹å‡»æŸ¥çœ‹æœ€æ–°æ´»åŠ¨çŠ¶æ€ã€‚å¼‚å¸¸æ˜¾ç¤ºæœ€è¿‘ä¸€æ¬¡ç™»é™†åœ¨ç¾å›½ã€‚\nè¿™ä¹ˆä¸€æ¥å°±çŸ¥é“é—®é¢˜äº†ï¼Œç”±äºäºšé©¬é€Šäº‘å®é™…ä½ç½®åœ¨ç¾å›½ï¼Œæ‰€ä»¥å‘é‚®ä»¶æ—¶ç›¸å½“äºåœ¨å¼‚åœ°ç™»é™†è¢«æ‹’ç»ã€‚å½“ç‚¹å‡»äº†â€œæ˜¯æˆ‘æœ¬äººâ€ä¹‹åï¼Œé‡æ–°å‘é‚®ä»¶ï¼Œå°±å‘å‡ºå»äº†ã€‚\nä¹‹æ‰€ä»¥ä¸ç”¨163å‘é‚®ä»¶ï¼Œæ˜¯å› ä¸ºæœ¬åœ°éƒ¨ç½²ä¹Ÿå¯ä»¥å‘å‡ºå»ï¼Œæ”¾åˆ°æœåŠ¡å™¨ä¸Šä¹Ÿå‘ä¸å‡ºï¼ŒæŠ¥554 DT:SPM 163 smtp3ï¼Œç½‘ä¸Šè¯´æ˜¯å› ä¸ºé‚®ä»¶ä¸»é¢˜å’Œæ­£æ–‡ä¸­åˆéæ³•å­—ç¬¦å¯¼è‡´ï¼Œç›®å‰è¿˜æ²¡è§£å†³ï¼Œä¹‹åå†å¡«æ­¤å‘ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/java%E5%8F%91%E9%82%AE%E4%BB%B6%E8%BF%99%E4%B8%AA%E5%9D%91%E4%BD%A0%E8%83%BD%E5%A1%AB%E5%90%97/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190601.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä»Šå¤©åˆ©ç”¨javaå‘é‚®ä»¶ï¼Œæœ¬åœ°windowsä¸Šæµ‹è¯•æ—¶å‘é€okçš„ï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šå´æŠ¥å¼‚å¸¸ï¼Œè®©æˆ‘ä»¬èµ°è¿›å¼‚å¸¸ï¼Œæ¢ç´¢åˆ°åº•å‘åœ¨å“ªé‡Œï¼Œå¹¶å¡«ä¹‹ã€‚\u003c/p\u003e","title":"javaå‘é‚®ä»¶ï¼Œè¿™ä¸ªå‘ä½ èƒ½å¡«å—ï¼Ÿ","type":"posts"},{"content":" æ­£æ–‡ # æˆ‘ä»¬æ¥ç”¨javaä»£ç çˆ¬å–csdnåšå®¢ç½‘ç«™ï¼Œç„¶åè‡ªåŠ¨è¯„è®ºï¼Œè¿™ä¸€æ³¢æ“ä½œå¯ä»¥è¯´æ˜¯ç›¸å½“é£éªšäº†ï¼Œè¯ä¸å¤šè¯´ï¼Œå’±ä¸Šä»£ç ã€‚\nç¬¬ä¸€æ­¥æ˜¯ç™»å½•ä»£ç ï¼Œè¿™ä¸ªç½‘ä¸Šä¸€å¤§æŠŠï¼Œä»£ç ä¸­ç”¨åˆ°äº†jsoupä¾èµ–åŒ…ï¼Œç”¨äºè§£æhtmlè·å–ç›¸åº”å…ƒç´ ï¼Œç›¸å½“äºcssé€‰æ‹©å™¨ï¼Œå¾ˆå¼ºå¤§çš„ä¸‰æ–¹ä»¶ã€‚\n/** * ç™»å½•csdné¡µé¢,è¯„è®ºå½“ç„¶éœ€è¦ç™»å½•äº† * * @throws Exception */ public static void loginCsdnPager() throws Exception { String html = HttpUtils.sendGet(\u0026#34;https://passport.csdn.net/account/login?ref=toolbar\u0026#34;); try { Thread.currentThread().sleep(3000); } catch (InterruptedException e) { // TODO Auto-generated catch block e.printStackTrace(); } Document doc = Jsoup.parse(html); Element form = doc.select(\u0026#34;.user-pass\u0026#34;).get(0); String lt = form.select(\u0026#34;input[name=lt]\u0026#34;).get(0).val(); String execution = form.select(\u0026#34;input[name=execution]\u0026#34;).get(0).val(); String _eventId = form.select(\u0026#34;input[name=_eventId]\u0026#34;).get(0).val(); List\u0026lt;NameValuePair\u0026gt; nvps = new ArrayList\u0026lt;NameValuePair\u0026gt;(); nvps.add(new BasicNameValuePair(\u0026#34;username\u0026#34;, CSDNACCOUNT)); nvps.add(new BasicNameValuePair(\u0026#34;password\u0026#34;, CSDNPASSWORD)); nvps.add(new BasicNameValuePair(\u0026#34;lt\u0026#34;, lt)); nvps.add(new BasicNameValuePair(\u0026#34;execution\u0026#34;, execution)); nvps.add(new BasicNameValuePair(\u0026#34;_eventId\u0026#34;, _eventId)); System.out.println(nvps); // å¼€å§‹è¯·æ±‚CSDNæœåŠ¡å™¨è¿›è¡Œç™»å½•æ“ä½œã€‚ä¸€ä¸ªç®€å•å°è£…ï¼Œç›´æ¥è·å–è¿”å›ç»“æœ String ret = HttpUtils.sendPost(\u0026#34;https://passport.csdn.net/account/login\u0026#34;, nvps); System.out.println(\u0026#34;ret is \u0026#34; + ret); // retä¸­ä¼šåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼Œè¿›è¡Œåˆ¤æ–­å³å¯ã€‚ if (ret.indexOf(\u0026#34;redirect_back\u0026#34;) \u0026gt; -1) { System.out.println(\u0026#34;ç™»é™†æˆåŠŸã€‚ã€‚ã€‚ã€‚ã€‚\u0026#34;); } else if (ret.indexOf(\u0026#34;ç™»å½•å¤ªé¢‘ç¹\u0026#34;) \u0026gt; -1) { throw new Exception(\u0026#34;ç™»å½•å¤ªé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ã€‚ã€‚ã€‚ã€‚ã€‚\u0026#34;); } else { throw new Exception(\u0026#34;ç™»å½•å¤ªé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ã€‚ã€‚ã€‚ã€‚ã€‚\u0026#34;); } } æœ‰äº†ç™»å½•ä»£ç æˆ‘ä»¬è¿˜å¾—è·å–åšå®¢æ–‡ç« åˆ—è¡¨ï¼Œè¿™æ˜¯æˆ‘ä»¬çˆ¬å–çš„æºå¤´ã€‚ä¸‹é¢ä»¥åšå®¢é¦–é¡µä¸ºèµ·ç‚¹å¾€å…¶ä»–ç½‘ç»œèŠ‚ç‚¹çˆ¬ï¼š\nhttps://blog.csdn.net\næˆ‘ä»¬å¯ä»¥æŠŠè‡ªå·±å½“åšä¸€ä¸ªè™«å­ï¼Œæ¥ä¸‹æ¥å°†åœ¨èœ˜è››ç½‘ä¸Šä»AèŠ‚ç‚¹åˆ°BèŠ‚ç‚¹ï¼Œä¸€ç›´çˆ¬åˆ°ç›®çš„åœ°ã€‚\né¦–å…ˆè¿›å…¥é¦–é¡µï¼Œç„¶åè·å–åˆ°é¦–é¡µå·¦ä¾§æ çš„åˆ†ç±»åˆ—è¡¨çš„urlï¼Œç‚¹å¼€è¿™äº›urlï¼Œå°±æ˜¯åˆ†ç±»ä¸‹çš„æ‰€æœ‰æ–‡ç« äº†ã€‚è¿™é‡Œæˆ‘ä»¬åªå–æ¯ä¸ªåˆ†ç±»ä¸‹åˆå§‹é¡µçš„æ–‡ç« åˆ—è¡¨urlï¼ˆå½“ç„¶è¿˜å¯ä»¥è‡ªè¡Œå®ç°é¼ æ ‡ä¸‹æ‹‰æ—¶çš„åˆ†é¡µï¼Œä»¥è·å–åˆ°æ›´å¤šçš„æ–‡ç« åˆ—è¡¨ï¼‰ï¼Œè¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªåä¸ºFETCHPAGESçš„æ•°ç»„å¸¸é‡ï¼Œç®¡ç†æ‰€éœ€çˆ¬å–çš„åˆ†ç±»åˆ—è¡¨ã€‚\nString html = HttpUtils.sendGet(\u0026#34;https://blog.csdn.net/\u0026#34;); Document doc = Jsoup.parse(html); Elements as = doc.select(\u0026#34;.nav_com\u0026#34;).select(\u0026#34;li\u0026#34;).select(\u0026#34;a\u0026#34;); // æ”¶é›†æ–‡ç« aæ ‡ç­¾ List\u0026lt;Elements\u0026gt; blogList = Lists.newArrayListWithCapacity(as.size()); for (Element a : as) { if (!FETCHPAGES.contains(a.text())) { continue; } String fetcheUrl = \u0026#34;https://blog.csdn.net\u0026#34; + a.attr(\u0026#34;href\u0026#34;); System.out.println(fetcheUrl); String blogHtml = HttpUtils.sendGet(fetcheUrl); Document blogDoc = Jsoup.parse(blogHtml); Elements blogAs = blogDoc.select(\u0026#34;.--- title\u0026#34;).select(\u0026#34;h2\u0026#34;).select(\u0026#34;a\u0026#34;); System.out.println(blogAs); blogList.add(blogAs); } æ”¶é›†å¥½æ–‡ç« åˆ—è¡¨ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦ç™»å½•äº†ï¼ˆç™»å½•åæ”¶é›†åˆ—è¡¨ä¼šå‡ºé—®é¢˜ï¼Œå…·ä½“åŸå› ä¸æ˜ï¼‰ï¼Œè¿™é‡Œç™»å½•åªæ˜¯æ¥ä¸‹æ¥è¯„è®ºæ—¶å¿…é¡»ã€‚\n// æ”¶é›†å®Œaæ ‡ç­¾åå†ç™»é™†,å¦åˆ™ä¼šä¸¢æ‰å¾ˆå¤šaæ ‡ç­¾,å…·ä½“åŸå› ä¸å loginCsdnPager(); BufferedOutputStream bos = null; // è¯„è®ºæˆåŠŸè®¡æ•°å™¨ int count = 0; try { // å°†è¯„è®ºæˆåŠŸçš„urlæ‰“å°åˆ°æ–‡ä»¶é‡Œ File file = new File(\u0026#34;D:/tmp/successLog/success.log\u0026#34;); bos = new BufferedOutputStream(new FileOutputStream(file)); // çˆ¬å–æ‰€æœ‰aæ ‡ç­¾ for (Elements blogs : blogList) { for (Element blog : blogs) { // æ‹¿åˆ°æ–‡ç« url String href = blog.attr(\u0026#34;href\u0026#34;); // è·å–æ–‡ç« urlåçš„ID,åœ¨è¯„è®ºæ—¶éœ€è¦ç”¨åˆ° String commitSuffixUrl = href.substring(href.lastIndexOf(\u0026#34;/\u0026#34;) + 1); // æ‰“å¼€æ–‡ç«  String blogHtml = HttpUtils.sendGet(href); System.out.println(blog.text() + \u0026#34;------------\u0026#34; + blog.attr(\u0026#34;href\u0026#34;)); Document blogDoc = Jsoup.parse(blogHtml); Elements --- titleAs = blogDoc.select(\u0026#34;.--- title-box\u0026#34;).select(\u0026#34;a\u0026#34;); System.out.println(--- titleAs); if (--- titleAs != null \u0026amp;\u0026amp; !--- titleAs.isEmpty()) { // è¯„è®ºè¯·æ±‚urlå‰ç¼€ String commitPrefixUrl = --- titleAs.get(0).attr(\u0026#34;href\u0026#34;); // System.out.println(--- titleAs.text() + \u0026#34;-----------\u0026#34; + commitPrefixUrl); // æ‹¼æ¥è¯„è®ºè¯·æ±‚url String commitUrl = commitPrefixUrl + \u0026#34;/phoenix/comment/submit?id=\u0026#34; + commitSuffixUrl; System.out.println(\u0026#34;commitUrl ==\u0026#34; + commitUrl); // æ„é€ è¯„è®ºè¯·æ±‚æ‰€éœ€bodyä½“ List\u0026lt;NameValuePair\u0026gt; nvps = new ArrayList\u0026lt;NameValuePair\u0026gt;(); nvps.add(new BasicNameValuePair(\u0026#34;replyId\u0026#34;, \u0026#34;\u0026#34;)); nvps.add(new BasicNameValuePair(\u0026#34;content\u0026#34;, \u0026#34;åŠ Weiä¿¡ammlysouw å…è´¹é¢†å–javaã€pythonã€å‰ç«¯ã€å®‰å“ã€æ•°æ®åº“ã€å¤§æ•°æ®ã€IOSç­‰å­¦ä¹ èµ„æ–™\u0026#34;)); // å‘èµ·è¯„è®º String postRequest = HttpUtils.sendPost(commitUrl, nvps); JSONObject jsonObj = JSONObject.parseObject(postRequest); System.out.println(postRequest); // è¯„è®ºç»“æœ,æˆåŠŸä¸º1 if (jsonObj.getInteger(\u0026#34;result\u0026#34;) == 1) { String articalUrl = commitPrefixUrl + \u0026#34;/article/details/\u0026#34; + commitSuffixUrl + \u0026#34;\\n\u0026#34;; System.out.println(\u0026#34;success articalUrl is \u0026#34; + articalUrl); // å°†è¯„è®ºæˆåŠŸçš„urlè®°å½•åˆ°æ–‡ä»¶ bos.write(articalUrl.getBytes()); bos.flush(); count++; } else { // ä¸æˆåŠŸè¯´æ˜è¯·æ±‚å¤ªå¿«,çº¿ç¨‹ä¼‘çœ 2ç§’,è¿™é‡Œä¼šä¸¢æ‰è¯„è®ºå¤±è´¥çš„æ–‡ç«  try { Thread.currentThread().sleep(2 * 60 * 1000); } catch (InterruptedException e) { // TODO Auto-generated catch block e.printStackTrace(); } } } else { continue; } } } } catch (IOException e) { System.out.println(\u0026#34;error is \u0026#34; + e); } finally { if (bos != null) { try { // æŠŠæˆåŠŸçš„é€ä¹¦è®°å½•åˆ°æ–‡ä»¶ bos.write((count + \u0026#34;\\n\u0026#34;).getBytes()); bos.flush(); System.out.println(\u0026#34;bos will colse\u0026#34;); bos.close(); } catch (IOException e) { // TODO Auto-generated catch block System.out.println(\u0026#34;error is \u0026#34; + e); } } } ç™»å½•åå°±æ˜¯è§£ææ”¶é›†åˆ°çš„æ–‡ç« urlï¼Œç„¶åæ‰“å¼€urlï¼Œæ‹¼æ¥è¯„è®ºè¯·æ±‚urlï¼Œä»¥åŠè¯·æ±‚å‚æ•°ï¼Œå‘èµ·postè¯·æ±‚ï¼Œè¯„è®ºä¸Šä¸‰æ¬¡ä»¥åå°±ä¼šè¢«ç½‘ç«™æœåŠ¡å™¨é™åˆ¶ï¼Œæç¤ºè¯„è®ºå¤ªå¿«ï¼Œéœ€è¦ç¡çœ 2ç§’é’Ÿå†ç»§ç»­ï¼Œæœ€åä¼šæŠŠè¯„è®ºæˆåŠŸçš„urlå’Œæ•°é‡è®°å½•åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œä¾¿äºæŸ¥çœ‹ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E8%87%AA%E5%8A%A8%E8%AF%84%E8%AE%BAcsdn%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E5%AE%9E%E7%8E%B0/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20181123.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eæˆ‘ä»¬æ¥ç”¨javaä»£ç çˆ¬å–csdnåšå®¢ç½‘ç«™ï¼Œç„¶åè‡ªåŠ¨è¯„è®ºï¼Œè¿™ä¸€æ³¢æ“ä½œå¯ä»¥è¯´æ˜¯ç›¸å½“é£éªšäº†ï¼Œè¯ä¸å¤šè¯´ï¼Œå’±ä¸Šä»£ç ã€‚\u003c/p\u003e","title":"è‡ªåŠ¨è¯„è®ºcsdnåšå®¢æ–‡ç« å®ç°","type":"posts"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/ditto/","section":"Tags","summary":"","title":"Ditto","type":"tags"},{"content":" æ­£æ–‡ # Ditto æ˜¯ä¸€æ¬¾å¼€æºã€å…è´¹ã€å¼ºå¤§çš„å‰ªè´´æ¿å¢å¼ºå·¥å…·ã€‚å¯ä»¥æŠŠå¤åˆ¶è¿‡çš„æ‰€æœ‰å†…å®¹ä¿å­˜èµ·æ¥ï¼ˆå¯ä»¥è®¾å®šä¿å­˜æ—¥æœŸæˆ–æ¡ç›®æ€»æ•°ï¼‰ï¼Œå¿«æ·åœ°ä¾›åç»­è°ƒç”¨ã€‚è¿˜å¯ä»¥åˆå¹¶ç²˜è´´ï¼Œçº¯æ–‡æœ¬ç²˜è´´ï¼Œæ”¯æŒåˆ†ç»„ã€ç½®é¡¶ã€å¿«é€Ÿæœç´¢ã€çƒ­é”®ç²˜è´´åŠŸèƒ½ã€‚å¹¶ä¸”ï¼Œè¿˜å¯ä»¥é€šè¿‡ç½‘ç»œå…±äº«å‰ªè´´æ¿å†…å®¹ã€‚\nå¹³å¸¸æƒ…å†µä¸‹ï¼ŒDittoåªæ˜¯ç³»ç»Ÿæ‰˜ç›˜ä¸­çš„å›¾æ ‡ã€‚æŒ‰ä¸‹çƒ­é”®ï¼ˆé»˜è®¤ ctrl+`ï¼‰åï¼Œä¼šå‡ºç°çš„ç²˜è´´ä¸»ç•Œé¢ï¼›å†ç‚¹å‡»å³é”®ä¼šå¼¹å‡ºåŠŸèƒ½ä¸°å¯Œçš„èœå•\nDittoä¸­å¯ä»¥ä¿ç•™å¤§é‡ï¼ˆå–å†³äºæ•°æ®åº“å®¹é‡ï¼‰çš„å†å²è®°å½•ã€‚å¦‚æœæƒ³æœç´¢æŸæ¡è®°å½•ï¼Œåªé¡»åœ¨ä¸»ç•Œé¢çš„æœç´¢æ¡†ä¸­è¾“å…¥æ–‡å­—ï¼Œè¿‡æ»¤åçš„ç»“æœä¼šå®æ—¶å±•ç°å‡ºæ¥ã€‚\nDittoå…è®¸åˆå¹¶ç²˜è´´ï¼Œå°±æ˜¯æŠŠå¤šæ¡è®°å½•ï¼Œä¸€æ¬¡æ€§ç²˜è´´åˆ°ç›®æ ‡çª—å£ã€‚åœ¨æ”¶é›†èµ„æ–™æ—¶ï¼Œè¿™ç‚¹å°¤å…¶æœ‰ç”¨ã€‚\nå¦‚æœå¤åˆ¶äº†å¸¦æ ¼å¼æ–‡æœ¬ï¼ˆæ¯”å¦‚ï¼Œæ¥è‡ªç½‘é¡µã€officeæ–‡ä»¶ï¼‰ï¼Œé»˜è®¤æ˜¯å¸¦æ ¼å¼ç²˜è´´ï¼Œä½† Shift+Enter è¡¨ç¤ºçº¯æ–‡æœ¬ç²˜è´´ã€‚ä»¥å‰å¾ˆå¤šäººè¿˜è¦é€šè¿‡è®°äº‹æœ¬ä¸­è½¬æ¥æ¶ˆé™¤æ ¼å¼ï¼Œæœ‰äº†Dittoåï¼Œä¸€åˆ‡ç®€å•äº†ã€‚\nDittoæ¯”é€šå¸¸å·¥å…·æ›´ä¸ºå¼ºå¤§çš„æ˜¯ï¼Œå®ƒèƒ½è¾“å…¥çš„ä¸ä»…æ˜¯ä¸€ä¸ªâ€œè¯æ¡â€ï¼Œè€Œå¯ä»¥æ˜¯â€œå¤šè¡Œæ–‡æœ¬ã€å¸¦æ ¼å¼çš„æ–‡æœ¬ã€å›¾ç‰‡å’Œæ–‡ä»¶â€ã€‚\nå½“ç„¶ï¼ŒDittoä¹Ÿæ”¯æŒç½‘ç»œåˆ†äº«å³ä¸€ä¸ªç»„å†…ï¼Œå¤šäººå…±äº«å‰ªè´´æ¿ã€‚è¿˜å¯ä»¥åˆ‡æ¢ä¸»é¢˜ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œå„ä½è¯·è‡ªè¡Œå å‘å°é²œã€‚\nè¯¥å·¥å…·å¯ä»¥å…³æ³¨æ–‡æœ«å…¬ä¼—å·ï¼Œåœ¨åå°å›å¤ã€1ã€‘è·å–ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E4%B8%80%E6%AC%BE%E6%95%88%E7%8E%87%E7%A5%9E%E5%99%A8ditto/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20181202.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eDitto æ˜¯ä¸€æ¬¾å¼€æºã€å…è´¹ã€å¼ºå¤§çš„å‰ªè´´æ¿å¢å¼ºå·¥å…·ã€‚å¯ä»¥æŠŠå¤åˆ¶è¿‡çš„æ‰€æœ‰å†…å®¹ä¿å­˜èµ·æ¥ï¼ˆå¯ä»¥è®¾å®šä¿å­˜æ—¥æœŸæˆ–æ¡ç›®æ€»æ•°ï¼‰ï¼Œå¿«æ·åœ°ä¾›åç»­è°ƒç”¨ã€‚è¿˜å¯ä»¥åˆå¹¶ç²˜è´´ï¼Œçº¯æ–‡æœ¬ç²˜è´´ï¼Œæ”¯æŒåˆ†ç»„ã€ç½®é¡¶ã€å¿«é€Ÿæœç´¢ã€çƒ­é”®ç²˜è´´åŠŸèƒ½ã€‚å¹¶ä¸”ï¼Œè¿˜å¯ä»¥é€šè¿‡ç½‘ç»œå…±äº«å‰ªè´´æ¿å†…å®¹ã€‚\u003c/p\u003e","title":"ä¸€æ¬¾æ•ˆç‡ç¥å™¨Ditto","type":"posts"},{"content":" æ­£æ–‡ # 1ã€\né€šè¿‡utilåŒ…ä¸­çš„ResourceBundleåŠ è½½ï¼š\né¦–å…ˆå›½é™…åŒ–èµ„æºæ–‡ä»¶æ”¾åœ¨äº†classpathä¸‹çš„i18nç›®å½•ä¸‹ï¼š\nmymessage_en_US.propertiesï¼š\ncom.website.operation=\\u67e5\\u8be2\\u64cd\\u4f5c\\u65e5\\u5fd7 com.website.write=\\u5199\\u65e5\\u5fd7 com.website.writeLog=\\u5199 {0} \\u65e5\\u5fd7 mymessage_en_US.propertiesï¼š\ncom.website.operation=queryOperationLog com.website.write=recordLog com.website.writeLog=record {0} Log åˆ©ç”¨ResourceBundleåŠ è½½å›½é™…åŒ–æ–‡ä»¶ï¼Œè¿™é‡Œåˆ—å‡ºå››ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯åˆ©ç”¨é»˜è®¤Localeã€zh_CNã€en_USä»¥åŠå¸¦å ä½ç¬¦çš„å¤„ç†æ–¹å¼ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯BaseNameä¸ºclasspathä¸‹çš„ç›®å½•+/+å›½é™…åŒ–æ–‡ä»¶åå‰ç¼€ï¼Œå³i18n/mymessage\npackage com.website.controller.utils; import java.text.MessageFormat; import java.util.Locale; import java.util.ResourceBundle; /** * @program: website * @description: è·å–å›½é™…åŒ–é…ç½®æ–‡ä»¶ * @author: smallsoup * @create: 2018-07-27 22:32 **/ public class ResourceUtils { public static String getEnglishValueByKey(String key){ Locale locale = new Locale(\u0026#34;en\u0026#34;, \u0026#34;US\u0026#34;); //ä½¿ç”¨æŒ‡å®šçš„è‹±æ–‡Locale ResourceBundle mySource = ResourceBundle.getBundle(\u0026#34;i18n/mymessage\u0026#34;, locale); return mySource.getString(key); } public static String getChineseValueByKey(String key){ Locale locale = new Locale(\u0026#34;zh\u0026#34;, \u0026#34;CN\u0026#34;); //ä½¿ç”¨æŒ‡å®šçš„ä¸­æ–‡Locale ResourceBundle mySource = ResourceBundle.getBundle(\u0026#34;i18n/mymessage\u0026#34;, locale); return mySource.getString(key); } public static String getDeafultValueByKey(String key){ //ä½¿ç”¨é»˜è®¤çš„Locale ResourceBundle mySource = ResourceBundle.getBundle(\u0026#34;i18n/mymessage\u0026#34;); return mySource.getString(key); } public static String getValueAndPlaceholder(String key){ //ä½¿ç”¨é»˜è®¤çš„Locale ResourceBundle mySource = ResourceBundle.getBundle(\u0026#34;i18n/mymessage\u0026#34;); String beforeValue = mySource.getString(key); //å¡«å……å›½å®¶åŒ–æ–‡ä»¶ä¸­çš„å ä½ç¬¦ String afterValue = MessageFormat.format(beforeValue, \u0026#34;å®‰å…¨\u0026#34;); return afterValue; } } åœ¨controlleré‡Œé¢è°ƒç”¨ResourceUtilsé‡Œçš„æ–¹æ³•ï¼š\n@RequestMapping(value = \u0026#34;/projectadd\u0026#34;) public String projectAdd(){ LOGGER.warn(\u0026#34;projectAdd getChineseValueByKey is {}\u0026#34;, ResourceUtils.getChineseValueByKey(\u0026#34;com.website.operation\u0026#34;)); LOGGER.warn(\u0026#34;projectAdd getDeafultValueByKey is {}\u0026#34;, ResourceUtils.getDeafultValueByKey(\u0026#34;com.website.operation\u0026#34;)); LOGGER.warn(\u0026#34;projectAdd getEnglishValueByKey is {}\u0026#34;, ResourceUtils.getEnglishValueByKey(\u0026#34;com.website.operation\u0026#34;)); LOGGER.warn(\u0026#34;projectAdd getValueAndPlaceholder is {}\u0026#34;, ResourceUtils.getValueAndPlaceholder(\u0026#34;com.website.writeLog\u0026#34;)); return \u0026#34;project/projectadd\u0026#34;; } å¯åŠ¨tomcatæ‰“å°æ—¥å¿—ï¼š\n2ã€\nåˆ©ç”¨springçš„ResourceBundleMessageSource\nResourceBundleMessageSourceæ˜¯åŸºäºJDK ResourceBundleçš„MessageSourceæ¥å£å®ç°ç±»ã€‚å®ƒä¼šå°†è®¿é—®è¿‡çš„ResourceBundleç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿äºä¸‹æ¬¡ç›´æ¥ä»ç¼“å­˜ä¸­è·å–è¿›è¡Œä½¿ç”¨ã€‚\nå’Œä¸Šé¢ä¸åŒçš„æ˜¯ResourceUtilsçš„å®ç°ï¼Œå®ç°å¦‚ä¸‹ï¼š\npackage com.website.controller.utils; import org.springframework.context.support.ResourceBundleMessageSource; import java.util.Locale; /** * @program: website * @description: è·å–å›½é™…åŒ–é…ç½®æ–‡ä»¶ * @author: smallsoup * @create: 2018-07-27 22:32 **/ public class ResourceUtils { private static ResourceBundleMessageSource messageSource = new ResourceBundleMessageSource(); static { //æŒ‡å®šå›½å®¶åŒ–èµ„æºæ–‡ä»¶è·¯å¾„ messageSource.setBasename(\u0026#34;i18n/mymessage\u0026#34;); //æŒ‡å®šå°†ç”¨æ¥åŠ è½½å¯¹åº”èµ„æºæ–‡ä»¶æ—¶ä½¿ç”¨çš„ç¼–ç ï¼Œé»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºå°†ä½¿ç”¨é»˜è®¤çš„ç¼–ç è¿›è¡Œè·å–ã€‚ messageSource.setDefaultEncoding(\u0026#34;UTF-8\u0026#34;); } public static String getChineseValueByKey(String key){ return messageSource.getMessage(key, null, Locale.CHINA); } public static String getDeafultValueByKey(String key){ return messageSource.getMessage(key, null, null); } public static String getEnglishValueByKey(String key){ return messageSource.getMessage(key, null, Locale.US); } public static String getValueAndPlaceholder(String key){ return messageSource.getMessage(key, new Object[]{\u0026#34;å®‰å…¨\u0026#34;}, null); } } 3ã€\nåˆ©ç”¨springçš„ReloadableResourceBundleMessageSource\nReloadableResourceBundleMessageSourceä¹Ÿæ˜¯MessageSourceçš„ä¸€ç§å®ç°ï¼Œå…¶ç”¨æ³•é…ç½®ç­‰å’ŒResourceBundleMessageSourceåŸºæœ¬ä¸€è‡´ã€‚æ‰€ä¸åŒçš„æ˜¯ReloadableResourceBundleMessageSourceå†…éƒ¨æ˜¯ä½¿ç”¨PropertiesPersisteræ¥åŠ è½½å¯¹åº”çš„æ–‡ä»¶ï¼Œè¿™åŒ…æ‹¬propertiesæ–‡ä»¶å’Œxmlæ–‡ä»¶ï¼Œç„¶åä½¿ç”¨java.util.Propertiesæ¥ä¿å­˜å¯¹åº”çš„æ•°æ®ã€‚\npackage com.website.controller.utils; import org.springframework.context.support.ReloadableResourceBundleMessageSource; import java.util.Locale; /** * @program: website * @description: è·å–å›½é™…åŒ–é…ç½®æ–‡ä»¶ * @author: smallsoup * @create: 2018-07-27 22:32 **/ public class ResourceUtils { private static ReloadableResourceBundleMessageSource messageSource = new ReloadableResourceBundleMessageSource(); static { //æŒ‡å®šå›½å®¶åŒ–èµ„æºæ–‡ä»¶è·¯å¾„ messageSource.setBasename(\u0026#34;i18n/mymessage\u0026#34;); //æŒ‡å®šå°†ç”¨æ¥åŠ è½½å¯¹åº”èµ„æºæ–‡ä»¶æ—¶ä½¿ç”¨çš„ç¼–ç ï¼Œé»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºå°†ä½¿ç”¨é»˜è®¤çš„ç¼–ç è¿›è¡Œè·å–ã€‚ messageSource.setDefaultEncoding(\u0026#34;UTF-8\u0026#34;); //æ˜¯å¦å…è®¸å¹¶å‘åˆ·æ–° messageSource.setConcurrentRefresh(true); //ReloadableResourceBundleMessageSourceä¹Ÿæ˜¯æ”¯æŒç¼“å­˜å¯¹åº”çš„èµ„æºæ–‡ä»¶çš„ï¼Œé»˜è®¤çš„ç¼“å­˜æ—¶é—´ä¸ºæ°¸ä¹…ï¼Œå³è·å–äº†ä¸€æ¬¡èµ„æºæ–‡ä»¶åå°±å°†å…¶ç¼“å­˜èµ·æ¥ï¼Œä»¥åå†ä¹Ÿä¸é‡æ–°å»è·å–è¯¥æ–‡ä»¶ã€‚è¿™ä¸ªå¯ä»¥é€šè¿‡setCacheSeconds()æ–¹æ³•æ¥æŒ‡å®šå¯¹åº”çš„ç¼“å­˜æ—¶é—´ï¼Œå•ä½ä¸ºç§’ messageSource.setCacheSeconds(1200); } public static String getChineseValueByKey(String key){ return messageSource.getMessage(key, null, Locale.CHINA); } public static String getDeafultValueByKey(String key){ return messageSource.getMessage(key, null, null); } public static String getEnglishValueByKey(String key){ return messageSource.getMessage(key, null, Locale.US); } public static String getValueAndPlaceholder(String key){ return messageSource.getMessage(key, new Object[]{\u0026#34;å®‰å…¨\u0026#34;}, null); } } è¿™ä¸‰ç§æ–¹å¼æœ€åç»“æœæ˜¯ä¸€æ ·çš„ã€‚\nå‚è€ƒï¼š\nå›½é™…åŒ–MessageSource\nhttp://elim.iteye.com/blog/2392583\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/java%E5%8A%A0%E8%BD%BD%E5%9B%BD%E9%99%85%E5%8C%96%E6%96%87%E4%BB%B6%E7%9A%84%E5%87%A0%E7%A7%8D%E5%A7%BF%E5%8A%BF/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190316.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003e\u003cstrong\u003e1ã€\u003c/strong\u003e\u003c/em\u003e\u003c/p\u003e","title":"javaåŠ è½½å›½é™…åŒ–æ–‡ä»¶çš„å‡ ç§å§¿åŠ¿","type":"posts"},{"content":" æ­£æ–‡ # ä»Šå¤©é¦–å…ˆæ¥çœ‹ä¸ªé—®é¢˜ï¼Œç”¨åŸç”Ÿservletå®ç°çš„æ¥å£ï¼Œå¤§å®¶çœ‹ä¸‹æ§åˆ¶å°è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ\nweb.xmlå¦‚ä¸‹ï¼š\n\u0026lt;!DOCTYPE web-app PUBLIC \u0026#34;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN\u0026#34; \u0026#34;http://java.sun.com/dtd/web-app_2_3.dtd\u0026#34; \u0026gt; \u0026lt;web-app\u0026gt; \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;myServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;com.smallsoup.servlet.SonServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;myServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/rest/v3/access/*\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;/web-app\u0026gt; SonServlet.javaå¦‚ä¸‹ï¼š\npackage com.smallsoup.servlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; /** * @program: myServlet * @description: SonServlet * @author: smallsoup * @create: 2018-08-01 20:46 **/ public class SonServlet extends ParentServlet{ @Override public void handleGet(HttpServletRequest req, HttpServletResponse resp) { System.out.println(\u0026#34;I am SonServlet handleGet\u0026#34;); } } ParentServlet.javaå¦‚ä¸‹ï¼š\npackage com.smallsoup.servlet; import javax.servlet.ServletException; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; /** * @program: myServlet * @description: ParentServlet * @author: smallsoup * @create: 2018-08-01 20:47 **/ public class ParentServlet extends HttpServlet { @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { System.out.println(\u0026#34;I am ParentServlet doGet\u0026#34;); this.handleGet(req, resp); } public void handleGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { System.out.println(\u0026#34;I am ParentServlet handleGet\u0026#34;); super.doGet(req, resp); } } å¯åŠ¨tomcatï¼Œç”¨postmanå‘è¯·æ±‚ï¼š\nGETï¼šhttp://localhost:8080/rest/v3/access/1212 æ§åˆ¶å°ä¼šè¾“å‡ºä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼š\nI am ParentServlet doGet I am SonServlet handleGet æˆ‘ç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´åº”è¯¥ä¼šç­”é”™ï¼Œä»¥ä¸ºä¼šè¾“å‡ºï¼š\nI am ParentServlet doGet I am ParentServlet handleGet æˆ–è€…åˆ«çš„ç­”æ¡ˆã€‚å°ç¼–ä»Šå¤©é‡åˆ°è¿™ä¸ªé—®é¢˜ä¹Ÿæ‡µé€¼äº†ï¼ŒåŸºç¡€æŒæ¡ä¸æ‰å®ï¼Œè¿˜å¾—å›è¿‡å¤´æ¥è¡¥è¡¥ã€‚\né¦–å…ˆæ ¹æ®urlåŒ¹é…åˆ°web.xmlä¸­å®šä¹‰çš„nameä¸ºmyServletçš„servletï¼Œæ‰€ä»¥ä¼šåˆ°SonServletä¸­å»å¤„ç†ï¼Œä½†æ˜¯SonServletæ²¡æœ‰é‡å†™HttpServletçš„doGet()æ–¹æ³•ï¼Œå®ƒçš„çˆ¶ç±»ParentServleté‡å†™äº†ï¼Œæ‰€ä»¥è¯·æ±‚ä¼šåˆ°ParentServletçš„doGet()æ–¹æ³•ï¼Œä½†æ˜¯è¿™é‡Œçš„doGetæ–¹æ³•ä¸­çš„this.handleGetä¸­çš„thisæŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡debugçœ‹åˆ°thiså…¶å®æ˜¯SonServletçš„å®ä¾‹ã€‚\nç”±æ­¤çœ‹æ¥ï¼Œthis.handleGetä¼šå»è°ƒç”¨SonServletçš„æ–¹æ³•ï¼Œè¿™å°±è§£é‡Šäº†æ§åˆ¶å°çš„è¾“å‡ºã€‚\nè¿™ä¸ªé—®é¢˜ï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š\n1ã€servletå¤„ç†è¯·æ±‚çš„æµç¨‹ï¼›\n2ã€thiså…³é”®å­—æŒ‡ä»€ä¹ˆï¼Ÿ\nä¸‹é¢è¿™ç¯‡å¯¹thiså…³é”®å­—è®²çš„éå¸¸å¥½ï¼Œå‡ºè‡ªï¼š\nhttps://www.cnblogs.com/zheting/p/7751752.html\nJavaä¸­thiså…³é”®å­—ä½¿ç”¨å°ç»“ï¼š # å½“ä¸€ä¸ªå¯¹è±¡åˆ›å»ºåï¼ŒJavaè™šæ‹Ÿæœºï¼ˆJVMï¼‰å°±ä¼šç»™è¿™ä¸ªå¯¹è±¡åˆ†é…ä¸€ä¸ªå¼•ç”¨è‡ªèº«çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆçš„åå­—å°±æ˜¯ thisã€‚\nå› æ­¤ï¼Œthisåªèƒ½åœ¨ç±»ä¸­çš„éé™æ€æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œé™æ€æ–¹æ³•å’Œé™æ€çš„ä»£ç å—ä¸­ç»å¯¹ä¸èƒ½å‡ºç°thisï¼Œå¹¶ä¸”thisåªå’Œç‰¹å®šçš„å¯¹è±¡å…³è”ï¼Œè€Œä¸å’Œç±»å…³è”ï¼ŒåŒä¸€ä¸ªç±»çš„ä¸åŒå¯¹è±¡æœ‰ä¸åŒçš„thisã€‚\n1ã€ä½¿ç”¨thisæ¥åŒºåˆ†å½“å‰å¯¹è±¡\nJavaä¸­ä¸ºè§£å†³å˜é‡çš„å‘½åå†²çªå’Œä¸ç¡®å®šæ€§é—®é¢˜ï¼Œå¼•å…¥å…³é”®å­—thisä»£è¡¨å…¶æ‰€åœ¨æ–¹æ³•çš„å½“å‰å¯¹è±¡çš„å¼•ç”¨ï¼š\næ„é€ æ–¹æ³•ä¸­æŒ‡è¯¥æ„é€ å™¨æ‰€åˆ›å»ºçš„æ–°å¯¹è±¡ï¼›\næ–¹æ³•ä¸­æŒ‡è°ƒç”¨è¯¥æ–¹æ³•çš„å¯¹è±¡ï¼›\nåœ¨ç±»æœ¬èº«çš„æ–¹æ³•æˆ–æ„é€ å™¨ä¸­å¼•ç”¨è¯¥ç±»çš„å®ä¾‹å˜é‡ï¼ˆå…¨å±€å˜é‡ï¼‰å’Œæ–¹æ³•ã€‚\nthisåªèƒ½ç”¨åœ¨æ„é€ å™¨æˆ–è€…æ–¹æ³•ä¸­ï¼Œç”¨äºè·å¾—è°ƒç”¨å½“å‰çš„æ„é€ å™¨æ–¹æ³•çš„å¯¹è±¡å¼•ç”¨ã€‚å¯ä»¥å’Œä»»ä½•çš„å¯¹è±¡å¼•ç”¨ä¸€æ ·æ¥å¤„ç†è¿™ä¸ªthiså¯¹è±¡ã€‚\nè¯´æ˜ï¼š\nå½“å®ä¾‹å˜é‡å’Œå±€éƒ¨å˜é‡é‡åï¼ŒJAVAå¹³å°ä¼šæŒ‰ç…§å…ˆå±€éƒ¨å˜é‡ã€åå®ä¾‹å˜é‡çš„é¡ºåºå¯»æ‰¾ã€‚å³ï¼Œæ–¹æ³•ä¸­ä½¿ç”¨åˆ°çš„å˜é‡çš„å¯»æ‰¾è§„å¾‹æ˜¯å…ˆæ‰¾å±€éƒ¨å˜é‡ï¼Œå†æ‰¾å®ä¾‹å˜é‡ã€‚å¦‚æœæ²¡ç”¨æ‰¾åˆ°ï¼Œå°†ä¼šæœ‰ä¸€ä¸ªç¼–è¯‘é”™è¯¯è€Œæ— æ³•é€šè¿‡ç¼–è¯‘ã€‚\nå¦‚æœä½¿ç”¨this.aï¼Œåˆ™ä¸ä¼šåœ¨æ–¹æ³•ï¼ˆå±€éƒ¨å˜é‡ï¼‰ä¸­å¯»æ‰¾å˜é‡a,è€Œæ˜¯ç›´æ¥å»å®ä¾‹å˜é‡ä¸­å»å¯»æ‰¾ï¼Œå¦‚æœå¯»æ‰¾ä¸åˆ°ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚\nåœ¨ä¸€ä¸ªæ–¹æ³•å†…ï¼Œå¦‚æœæ²¡æœ‰å‡ºç°å±€éƒ¨å˜é‡å’Œå®ä¾‹å˜é‡é‡åçš„æƒ…å†µä¸‹ï¼Œæ˜¯å¦ä½¿ç”¨thiså…³é”®å­—æ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚\nåœ¨åŒä¸€ä¸ªç±»ä¸­ï¼ŒJavaæ™®é€šæ–¹æ³•çš„äº’ç›¸è°ƒç”¨å¯ä»¥çœç•¥this+ç‚¹å·ï¼Œè€Œç›´æ¥ä½¿ç”¨æ–¹æ³•å+å‚æ•°ã€‚å› ä¸ºJavaç¼–è¯‘å™¨ä¼šå¸®æˆ‘ä»¬åŠ ä¸Šã€‚\n2ã€ åœ¨æ„é€ å™¨ä¸­ä½¿ç”¨thisæ¥è°ƒç”¨å¯¹è±¡æœ¬èº«çš„å…¶ä»–æ„é€ å™¨\nåœ¨æ„é€ å™¨ä¸­ä½¿ç”¨thisï¼ˆ[args_list]ï¼‰ï¼›å¯ä»¥è°ƒç”¨å¯¹è±¡æœ¬èº«çš„å…¶ä»–çš„æ„é€ å™¨ã€‚ç›´æ¥ä½¿ç”¨this()åŠ ä¸Šç±»æ„é€ å™¨æ‰€éœ€è¦çš„å‚æ•°ã€‚å°±å¯ä»¥è°ƒç”¨ç±»æœ¬èº«çš„å…¶ä»–æ„é€ å™¨äº†ã€‚å¦‚æœç±»ä¸­æœ‰å¤šä¸ªå…¶ä»–æ„é€ å™¨å®šä¹‰ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ ¹æ®this()ä¸­çš„å‚æ•°ä¸ªæ•°å’Œç±»å‹æ¥æ‰¾å‡ºç±»ä¸­ç›¸åŒ¹é…çš„æ„é€ å™¨ã€‚\næ³¨æ„ï¼š åœ¨æ„é€ å™¨ä¸­å¯ä»¥é€šè¿‡this()æ–¹å¼æ¥è°ƒç”¨å…¶ä»–çš„æ„é€ å™¨ã€‚ä½†åœ¨ä¸€ä¸ªæ„é€ å™¨ä¸­æœ€å¤šåªèƒ½è°ƒç”¨ä¸€ä¸ªå…¶ä»–çš„æ„é€ å™¨ã€‚å¹¶ä¸”ï¼Œå¯¹å…¶ä»–æ„é€ å™¨çš„è°ƒç”¨åŠ¨ä½œå¿…é¡»æ”¾åœ¨æ„é€ å™¨çš„èµ·å§‹å¤„ï¼ˆä¹Ÿå°±æ˜¯æ„é€ å™¨çš„é¦–è¡Œï¼‰ï¼Œå¦åˆ™ç¼–è¯‘çš„æ—¶å€™å°†ä¼šå‡ºç°é”™è¯¯ï¼Œå¦å¤–ä¸èƒ½åœ¨æ„é€ å™¨ä»¥å¤–çš„åœ°æ–¹ä»¥è¿™ç§æ–¹å¼è°ƒç”¨æ„é€ å™¨ã€‚\n3ã€ thiså…³é”®å­—è¿˜æœ‰ä¸€ä¸ªé‡å¤§çš„ä½œç”¨å°±æ˜¯è¿”å›ç±»çš„å¼•ç”¨ã€‚å¦‚åœ¨ä»£ç ä¸­ï¼Œå¯ä»¥ä½¿ç”¨return thisæ¥è¿”å›æŸä¸ªç±»çš„å¼•ç”¨ã€‚æ­¤æ—¶ï¼Œè¿™ä¸ªthiså…³é”®å­—å°±ä»£è¡¨ç±»çš„åç§°ã€‚\nä¾‹1ã€æŠŠthisä½œä¸ºå‚æ•°ä¼ é€’\nå½“ä½ è¦æŠŠè‡ªå·±ä½œä¸ºå‚æ•°ä¼ é€’ç»™åˆ«çš„å¯¹è±¡æ—¶ï¼Œä¹Ÿå¯ä»¥ç”¨thisã€‚å¦‚ï¼š\npackage com.smallsoup.servlet; /** * @program: myServlet * @description: A * @author: smallsoup * @create: 2018-08-01 22:58 **/ public class A { public A(){ new B(this).print(); } public void print(){ System.out.println(\u0026#34;From A!\u0026#34;); } public static void main(String[] args) { new A(); } } class B{ A a; public B(A a){ this.a = a; } public void print(){ a.print(); System.out.println(\u0026#34;From B!\u0026#34;); } } è¿è¡Œç»“æœï¼š\nFrom A! From B! åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯¹è±¡Açš„æ„é€ å‡½æ•°ä¸­ï¼Œç”¨new B(this)æŠŠå¯¹è±¡Aè‡ªå·±ä½œä¸ºå‚æ•°ä¼ é€’ç»™äº†å¯¹è±¡Bçš„æ„é€ å‡½æ•°ã€‚\nä¾‹2ã€æ³¨æ„åŒ¿åç±»å’Œå†…éƒ¨ç±»ä¸­çš„ä¸­çš„this\næœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°ä¸€äº›å†…éƒ¨ç±»å’ŒåŒ¿åç±»ï¼Œå¦‚äº‹ä»¶å¤„ç†ã€‚å½“åœ¨åŒ¿åç±»ä¸­å‡ºç°thisæ—¶ï¼Œè¿™ä¸ªthisåˆ™æŒ‡çš„æ˜¯åŒ¿åç±»æˆ–å†…éƒ¨ç±»æœ¬èº«ã€‚è¿™æ—¶å¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨å¤–éƒ¨ç±»çš„æ–¹æ³•å’Œå˜é‡çš„è¯ï¼Œåˆ™åº”è¯¥åŠ ä¸Šå¤–éƒ¨ç±»çš„ç±»åã€‚å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\npackage com.smallsoup.servlet; /** * @program: myServlet * @description: C * @author: smallsoup * @create: 2018-08-01 23:00 **/ public class C { int i = 1; public C(){ Thread thread = new Thread(){ @Override public void run(){ for(;;){//è¡¨ç¤ºæ˜¯æ­»å¾ªç¯ C.this.run();//è°ƒç”¨å¤–éƒ¨æ–¹æ³•run() try { sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } } } };//æ³¨æ„è¿™é‡Œæœ‰åˆ†å·; thread.start(); } public void run(){ System.out.println(\u0026#34;i = \u0026#34; + i); i++; } public static void main(String[] args) throws Exception { new C(); } } è¿è¡Œç»“æœï¼šæ¯ä¸€ç§’äº§ç”Ÿä¸€ä¸ªæ•°ï¼š1,2,3 â€¦â€¦\nåœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­, thread æ˜¯ä¸€ä¸ªåŒ¿åç±»å¯¹è±¡ï¼Œåœ¨å®ƒçš„å®šä¹‰ä¸­ï¼Œå®ƒçš„ run å‡½æ•°é‡Œç”¨åˆ°äº†å¤–éƒ¨ç±»çš„ run å‡½æ•°ã€‚è¿™æ—¶ç”±äºå‡½æ•°åŒåï¼Œç›´æ¥è°ƒç”¨å°±ä¸è¡Œäº†ã€‚è¿™æ—¶æœ‰ä¸¤ç§åŠæ³•ï¼Œä¸€ç§å°±æ˜¯æŠŠå¤–éƒ¨çš„ run å‡½æ•°æ¢ä¸€ä¸ªåå­—ï¼Œä½†è¿™ç§åŠæ³•å¯¹äºä¸€ä¸ªå¼€å‘åˆ°ä¸­é€”çš„åº”ç”¨æ¥è¯´æ˜¯ä¸å¯å–çš„ã€‚é‚£ä¹ˆå°±å¯ä»¥ç”¨è¿™ä¸ªä¾‹å­ä¸­çš„åŠæ³•ç”¨å¤–éƒ¨ç±»çš„ç±»ååŠ ä¸Š this å¼•ç”¨æ¥è¯´æ˜è¦è°ƒç”¨çš„æ˜¯å¤–éƒ¨ç±»çš„æ–¹æ³• runã€‚\nä¾‹3 ã€thiså…³é”®å­—æœ€å¤§çš„ä½œç”¨æ˜¯ï¼Œè®©ç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè®¿é—®è¯¥ç±»çš„å¦ä¸€ä¸ªæ–¹æ³•æˆ–è€…å±æ€§ã€‚\nå…ˆçœ‹ä¸€ä¸ªä¸å¥½çš„ä¾‹å­:\npackage com.smallsoup.servlet; /** * @program: myServlet * @description: Baby * @author: smallsoup * @create: 2018-08-01 23:03 **/ public class Baby { public void wakeUp(){ System.out.println(\u0026#34;å®å®é†’å•¦\u0026#34;); } public void eat(){ Baby baby = new Baby(); baby.wakeUp(); System.out.println(\u0026#34;åƒä¸œè¥¿\u0026#34;); } } è¿™æ ·ä¸ç¬¦åˆé€»è¾‘ã€‚è¿™å°±ç›¸å½“äºæœ¬å¯¹è±¡çš„eatæ–¹æ³•ï¼Œéœ€è¦è°ƒç”¨å¦ä¸€ä¸ªå¯¹è±¡çš„wakeUpæ–¹æ³•ã€‚\næˆ‘ä»¬çœ‹è¿™ä¸ªä¾‹å­:\npublic class Baby { public void wakeUp() { System.out.println(\u0026#34;å®å®é†’å•¦\u0026#34;); } public void eat() { this.wakeUp(); System.out.println(\u0026#34;åƒä¸œè¥¿\u0026#34;); } } è¿™æ ·å°±ç¬¦åˆé€»è¾‘äº†ã€‚è‡ªå·±çš„eatæ–¹æ³•ï¼Œè¿˜éœ€è¦è‡ªå·±çš„ä¸€ä¸ªwakeUpæ–¹æ³•ã€‚\njavaå…è®¸åŒä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•ç›´æ¥è°ƒç”¨è¯¥å¯¹è±¡çš„å±æ€§æˆ–è€…æ–¹æ³•ï¼Œæ‰€ä»¥thiså¯ä»¥çœç•¥ã€‚\næ³¨æ„ï¼šjavaä¸­ä¸ºä»€ä¹ˆåœ¨staticä¸­ä¸èƒ½ä½¿ç”¨thiså…³é”®å­—ï¼Ÿ\nStaticæ–¹æ³•æ˜¯ç±»æ–¹æ³•ï¼Œå…ˆäºä»»ä½•çš„å®ä¾‹ï¼ˆå¯¹è±¡ï¼‰å­˜åœ¨ã€‚å³Staticæ–¹æ³•åœ¨ç±»åŠ è½½æ—¶å°±å·²ç»å­˜åœ¨äº†ï¼Œä½†æ˜¯å¯¹è±¡æ˜¯åœ¨åˆ›å»ºæ—¶æ‰åœ¨å†…å­˜ä¸­ç”Ÿæˆã€‚è€ŒthisæŒ‡ä»£çš„æ˜¯å½“å‰çš„å¯¹è±¡åœ¨æ–¹æ³•ä¸­å®šä¹‰ä½¿ç”¨çš„thiså…³é”®å­—,å®ƒçš„å€¼æ˜¯å½“å‰å¯¹è±¡çš„å¼•ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ åªèƒ½ç”¨å®ƒæ¥è°ƒç”¨å±äºå½“å‰å¯¹è±¡çš„æ–¹æ³•æˆ–è€…ä½¿ç”¨thiså¤„ç†æ–¹æ³•ä¸­æˆå‘˜å˜é‡å’Œå±€éƒ¨å˜é‡é‡åçš„æƒ…å†µï¼Œè€Œä¸”ï¼Œæ›´ä¸ºé‡è¦çš„æ˜¯thiså’Œsuperéƒ½æ— æ³•å‡ºç°åœ¨static ä¿®é¥°çš„æ–¹æ³•ä¸­ï¼Œstatic ä¿®é¥°çš„æ–¹æ³•æ˜¯å±äºç±»çš„ï¼Œè¯¥æ–¹æ³•çš„è°ƒç”¨è€…å¯èƒ½æ˜¯ä¸€ä¸ªç±»,è€Œä¸æ˜¯å¯¹è±¡ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯ç±»æ¥è°ƒç”¨è€Œä¸æ˜¯å¯¹è±¡ï¼Œåˆ™ thiså°±æ— æ³•æŒ‡å‘åˆé€‚çš„å¯¹è±¡.æ‰€ä»¥static ä¿®é¥°çš„æ–¹æ³•ä¸­ä¸èƒ½ä½¿ç”¨this\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/java%E4%B8%ADthis%E5%85%B3%E9%94%AE%E5%AD%97%E6%98%93%E9%94%99%E7%82%B9%E5%92%8C%E8%AF%B4%E6%98%8E/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180324.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä»Šå¤©é¦–å…ˆæ¥çœ‹ä¸ªé—®é¢˜ï¼Œç”¨åŸç”Ÿservletå®ç°çš„æ¥å£ï¼Œå¤§å®¶çœ‹ä¸‹æ§åˆ¶å°è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ\u003c/p\u003e","title":"javaä¸­thiså…³é”®å­—æ˜“é”™ç‚¹å’Œè¯´æ˜","type":"posts"},{"content":" æ­£æ–‡ # å¤§å®¶åœ¨ä½¿ç”¨mysqlè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°ç±»ä¼¼ä»¥ä¸‹çš„é—®é¢˜ï¼š\næ¨¡ç³ŠåŒ¹é… jg%ï¼Œç»“æœä»¥JGå¼€å¤´çš„å­—ç¬¦ä¸²ä¹Ÿå‡ºç°åœ¨ç»“æœé›†ä¸­ï¼Œå¤§å®¶å¾ˆè‡ªç„¶çš„è®¤ä¸ºæ˜¯å¤§å°å†™æ•æ„Ÿçš„é—®é¢˜ã€‚é‚£ä¹ˆmysqlä¸­å¤§å°å†™æ•æ„Ÿæ˜¯å¦‚ä½•æ§åˆ¶çš„ï¼›æ•°æ®åº“åï¼Œè¡¨åï¼Œå­—æ®µåè¿™äº›å­—å…¸å¯¹è±¡ä»¥åŠå­—æ®µå€¼çš„å¤§å°æ•æ„Ÿæ˜¯å¦‚ä½•æ§åˆ¶çš„ï¼›ä»¥åŠæ ¡éªŒè§„åˆ™ä¸ç´¢å¼•çš„å…³ç³»ï¼Œè¿™æ˜¯æœ¬æ–‡è¦è®¨è®ºçš„å†…å®¹ã€‚\næ•°æ®åº“åã€è¡¨åï¼š\nwindowså»ºåº“ï¼š\nwindowså»ºè¡¨ï¼š\nlinuxå»ºåº“ï¼š\nlinuxå»ºè¡¨ï¼š\nä»¥ä¸Šå¯ä»¥çœ‹å‡ºwindowsä¸‹å¤§å°å†™ä¸æ•æ„Ÿï¼Œlinuxä¸‹æ˜¯æ•æ„Ÿçš„ï¼Œæ•…å‰è€…ä¸å¯ä»¥åŒæ—¶å»ºtestå’ŒTESTï¼Œè€Œåè€…å¯ä»¥ã€‚\nå¤§å°å†™åŒºåˆ†è§„åˆ™ï¼š # Linuxä¸‹ï¼š\næ•°æ®åº“åä¸è¡¨åæ˜¯ä¸¥æ ¼åŒºåˆ†å¤§å°å†™çš„ï¼›\nè¡¨çš„åˆ«åæ˜¯ä¸¥æ ¼åŒºåˆ†å¤§å°å†™çš„ï¼›\nåˆ—åä¸åˆ—çš„åˆ«ååœ¨æ‰€æœ‰çš„æƒ…å†µä¸‹å‡æ˜¯å¿½ç•¥å¤§å°å†™çš„ï¼›\nå˜é‡åä¹Ÿæ˜¯ä¸¥æ ¼åŒºåˆ†å¤§å°å†™çš„ï¼›\nWindowsä¸‹ï¼š\néƒ½ä¸åŒºåˆ†å¤§å°å†™ã€‚ Mac OSä¸‹ï¼Œæ–‡ä»¶ç³»ç»Ÿç±»å‹HFS+ï¼ŒéUFSå·ï¼š\néƒ½ä¸åŒºåˆ†å¤§å°å†™ã€‚ mysqlä¸­æ§åˆ¶æ•°æ®åº“åå’Œè¡¨åçš„å¤§å°å†™æ•æ„Ÿç”±å‚æ•°lower_case_table_namesæ§åˆ¶ï¼Œä¸º0æ—¶è¡¨ç¤ºåŒºåˆ†å¤§å°å†™ï¼Œä¸º1æ—¶ï¼Œè¡¨ç¤ºå°†åå­—è½¬åŒ–ä¸ºå°å†™åå­˜å‚¨ï¼Œä¸åŒºåˆ†å¤§å°å†™ã€‚\nåœ¨mysqlä¸­ï¼Œæ•°æ®åº“å¯¹åº”æ•°æ®ç›®å½•ä¸­çš„ç›®å½•ã€‚æ•°æ®åº“ä¸­çš„æ¯ä¸ªè¡¨è‡³å°‘å¯¹åº”æ•°æ®åº“ç›®å½•ä¸­çš„ä¸€ä¸ªæ–‡ä»¶(ä¹Ÿå¯èƒ½æ˜¯å¤šä¸ªï¼Œå–å†³äºå­˜å‚¨å¼•æ“)ã€‚å› æ­¤ï¼Œæ‰€ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å¤§å°å†™æ•æ„Ÿæ€§å†³å®šäº†æ•°æ®åº“åå’Œè¡¨åçš„å¤§å°å†™æ•æ„Ÿæ€§ã€‚\nlower_case_file_systemï¼š\nå˜é‡è¯´æ˜æ˜¯å¦æ•°æ®ç›®å½•æ‰€åœ¨çš„æ–‡ä»¶ç³»ç»Ÿå¯¹æ–‡ä»¶åçš„å¤§å°å†™æ•æ„Ÿã€‚ONè¯´æ˜å¯¹æ–‡ä»¶åçš„å¤§å°å†™ä¸æ•æ„Ÿï¼ŒOFFè¡¨ç¤ºæ•æ„Ÿã€‚\nlower_case_table_namesï¼š\nunixä¸‹é»˜è®¤å€¼ä¸º 0 ï¼›Windowsä¸‹é»˜è®¤å€¼æ˜¯ 1 ï¼›Mac OS Xä¸‹é»˜è®¤å€¼æ˜¯ 2\n***0ï¼š***ä½¿ç”¨CREATE TABLEæˆ–CREATE DATABASEè¯­å¥æŒ‡å®šçš„å¤§å°å†™å­—æ¯åœ¨ç¡¬ç›˜ä¸Šä¿å­˜è¡¨åå’Œæ•°æ®åº“åã€‚åç§°æ¯”è¾ƒå¯¹å¤§å°å†™æ•æ„Ÿã€‚åœ¨å¤§å°å†™ä¸æ•æ„Ÿçš„æ“ä½œç³»ç»Ÿå¦‚windowsæˆ–Mac OS xä¸Šæˆ‘ä»¬ä¸èƒ½å°†è¯¥å‚æ•°è®¾ä¸º0ï¼Œå¦‚æœåœ¨å¤§å°å†™ä¸æ•æ„Ÿçš„æ–‡ä»¶ç³»ç»Ÿä¸Šå°†æ­¤å‚æ•°å¼ºåˆ¶è®¾ä¸º0ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸åŒçš„å¤§å°å†™è®¿é—®MyISAMè¡¨åï¼Œå¯èƒ½ä¼šå¯¼è‡´ç´¢å¼•ç ´åã€‚\n***1ï¼š***è¡¨ååœ¨ç¡¬ç›˜ä¸Šä»¥å°å†™ä¿å­˜ï¼Œåç§°æ¯”è¾ƒå¯¹å¤§å°å†™ä¸æ•æ„Ÿã€‚MySQLå°†æ‰€æœ‰è¡¨åè½¬æ¢ä¸ºå°å†™åœ¨å­˜å‚¨å’ŒæŸ¥æ‰¾è¡¨ä¸Šã€‚è¯¥è¡Œä¸ºä¹Ÿé€‚åˆæ•°æ®åº“åå’Œè¡¨çš„åˆ«åã€‚è¯¥å€¼ä¸ºWindowsçš„é»˜è®¤å€¼ã€‚\n***2ï¼š***è¡¨åå’Œæ•°æ®åº“ååœ¨ç¡¬ç›˜ä¸Šä½¿ç”¨CREATE TABLEæˆ–CREATE DATABASEè¯­å¥æŒ‡å®šçš„å¤§å°å†™å­—æ¯è¿›è¡Œä¿å­˜ï¼Œä½†MySQLå°†å®ƒä»¬è½¬æ¢ä¸ºå°å†™åœ¨æŸ¥æ‰¾è¡¨ä¸Šã€‚åç§°æ¯”è¾ƒå¯¹å¤§å°å†™ä¸æ•æ„Ÿï¼Œå³æŒ‰ç…§å¤§å°å†™æ¥ä¿å­˜ï¼ŒæŒ‰ç…§å°å†™æ¥æ¯”è¾ƒã€‚æ³¨é‡Šï¼šåªåœ¨å¯¹å¤§å°å†™ä¸æ•æ„Ÿçš„æ–‡ä»¶ç³»ç»Ÿä¸Šé€‚ç”¨innodbè¡¨åç”¨å°å†™ä¿å­˜ã€‚\nwindowsä¸Šï¼š\nlinuxä¸Šï¼š\nä¸ºäº†é¿å…å¤§å°å†™å¼•å‘çš„é—®é¢˜ï¼Œä¸€ç§æ¨èçš„å‘½åè§„åˆ™æ˜¯ï¼šåœ¨å®šä¹‰æ•°æ®åº“ã€è¡¨ã€åˆ—çš„æ—¶å€™å…¨éƒ¨é‡‡ç”¨å°å†™å­—æ¯åŠ ä¸‹åˆ’çº¿çš„æ–¹å¼ï¼Œä¸ä½¿ç”¨ä»»ä½•å¤§å†™å­—æ¯ã€‚\nå­—æ®µåå’Œå­—æ®µå€¼ï¼š\nå­—æ®µåé€šå¸¸éƒ½æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ã€‚\nå­—æ®µå€¼çš„å¤§å°å†™ç”±mysqlçš„æ ¡å¯¹è§„åˆ™æ¥æ§åˆ¶ã€‚æåˆ°æ ¡å¯¹è§„åˆ™ï¼Œå°±ä¸å¾—ä¸è¯´å­—ç¬¦é›†ã€‚å­—ç¬¦é›†æ˜¯ä¸€å¥—ç¬¦å·å’Œç¼–ç ï¼Œæ ¡å¯¹è§„åˆ™æ˜¯åœ¨å­—ç¬¦é›†å†…ç”¨äºæ¯”è¾ƒå­—ç¬¦çš„ä¸€å¥—è§„åˆ™ï¼Œæ¯”å¦‚å®šä¹‰\u0026rsquo;A\u0026rsquo;\u0026lt;\u0026lsquo;B\u0026rsquo;è¿™æ ·çš„å…³ç³»çš„è§„åˆ™ã€‚ä¸åŒçš„å­—ç¬¦é›†æœ‰å¤šç§æ ¡å¯¹è§„åˆ™ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œæ ¡å¯¹è§„åˆ™ä»¥å…¶ç›¸å…³çš„å­—ç¬¦é›†åå¼€å§‹ï¼Œé€šå¸¸åŒ…æ‹¬ä¸€ä¸ªè¯­è¨€åï¼Œå¹¶ä¸”ä»¥_ciï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰ã€_csï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰æˆ–_binï¼ˆäºŒå…ƒï¼‰ç»“æŸ ã€‚æ¯”å¦‚ utf8å­—ç¬¦é›†ï¼Œutf8_general_ci,è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™ï¼Œè¿™ä¸ªæ˜¯utf8å­—ç¬¦é›†é»˜è®¤çš„æ ¡å¯¹è§„åˆ™ï¼›utf8_general_csè¡¨ç¤ºåŒºåˆ†å¤§å°å†™ï¼Œutf8_binè¡¨ç¤ºäºŒè¿›åˆ¶æ¯”è¾ƒï¼ŒåŒæ ·ä¹ŸåŒºåˆ†å¤§å°å†™ã€‚\næ ¡å¯¹è§„åˆ™é€šè¿‡å…³é”®å­—collateæŒ‡å®šï¼Œæ¯”å¦‚åˆ›å»ºæ•°æ®åº“test2ï¼ŒæŒ‡å®šå­—ç¬¦é›†ä¸ºutf8ï¼Œæ ¡å¯¹è§„åˆ™ä¸ºutf8_bin\ncreate database test2 default character set utf8 collate utf8_bin; é€šè¿‡ä¸Šè¿°è¯­å¥è¯´æ˜æ•°æ®åº“test2ä¸­çš„æ•°æ®æŒ‰utf8ç¼–ç ï¼Œå¹¶ä¸”æ˜¯å¯¹å¤§å°å†™æ•æ„Ÿçš„ã€‚\næœ‰æ—¶å€™æˆ‘ä»¬å»ºåº“æ—¶ï¼Œæ²¡æœ‰æŒ‡å®šæ ¡å¯¹è§„åˆ™æ ¡å¯¹æ—¶å­—ç¬¦å¤§å°å†™æ•æ„Ÿï¼Œä½†æ˜¯æˆ‘ä»¬æŸ¥è¯¢æ—¶ï¼Œåˆéœ€è¦å¯¹å­—ç¬¦æ¯”è¾ƒå¤§å°å†™æ•æ„Ÿï¼Œå°±æ¯”å¦‚å¼€ç¯‡ä¸­çš„ä¾‹å­ï¼Œåªæƒ³è¦jgå¼€å¤´çš„å­—ç¬¦ä¸²ã€‚æ²¡å…³ç³»ï¼Œmysqlæä¾›äº†collateè¯­æ³•ï¼Œé€šè¿‡æŒ‡å®šutf8_binæ ¡å¯¹è§„åˆ™å³å¯ã€‚\nè¿˜æœ‰å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œé€šè¿‡binaryå…³é”®å­—ï¼Œå°†ä¸²è½¬ä¸ºäºŒè¿›åˆ¶è¿›è¡Œæ¯”è¾ƒï¼Œç”±äºå¤§å°å†™å­—ç¬¦çš„äºŒè¿›åˆ¶è‚¯å®šä¸åŒï¼Œå› æ­¤å¯ä»¥è®¤ä¸ºæ˜¯åŒºåˆ†å¤§å°çš„ä¸€ç§æ–¹å¼ã€‚\næ ¡å¯¹è§„åˆ™ä¸ç´¢å¼•å­˜å‚¨çš„å…³ç³»ã€‚å› ä¸ºæ ¡å¯¹è§„åˆ™ä¼šç”¨äºå­—ç¬¦ä¸²ä¹‹é—´æ¯”è¾ƒï¼Œè€Œç´¢å¼•æ˜¯åŸºäºæ¯”è¾ƒæœ‰åºæ’åˆ—çš„ï¼Œå› æ­¤æ ¡å¯¹è§„åˆ™ä¼šå½±å“è®°å½•çš„ç´¢å¼•é¡ºåºã€‚ä¸‹é¢ä¸¾ä¸€ä¸ªå°ä¾‹å­è¯´æ˜ï¼š\nå»ºè¡¨ï¼š create table test3(name varchar(100), primary key(name)); create table test4(name varchar(100), primary key(name)) collate utf8_bin; ç»™è¡¨test3æ’å…¥æ•°æ®ï¼š insert into test3(name) values(\u0026#39;abc\u0026#39;); insert into test3(name) values(\u0026#39;ABD\u0026#39;); insert into test3(name) values(\u0026#39;ZBC\u0026#39;); ç»™è¡¨test4æ’å…¥æ•°æ®ï¼š insert into test4(name) values(\u0026#39;abc\u0026#39;); insert into test4(name) values(\u0026#39;ABD\u0026#39;); insert into test4(name) values(\u0026#39;ZBC\u0026#39;); æŸ¥è¡¨ï¼š select * from test3; select * from test4; ä»ç»“æœå¯ä»¥çœ‹åˆ°test3å’Œtest4è¿”å›çš„ç»“æœé›†ä¸­ï¼Œè®°å½•çš„ç›¸å¯¹é¡ºåºæ˜¯ä¸åŒçš„ï¼Œå› ä¸ºæ˜¯å…¨è¡¨æ‰«æï¼Œè¿”å›çš„è®°å½•ä½“ç°äº†ä¸»é”®é¡ºåºã€‚ç”±äºtest3è¡¨æ ¡éªŒè§„åˆ™é‡‡ç”¨é»˜è®¤çš„utf8_general_ciï¼Œå¤§å°å†™ä¸æ•æ„Ÿï¼Œå› æ­¤abc\u0026lt;ABC\u0026lt;ZBCï¼›åŒç†ï¼Œtest4é‡‡ç”¨utf8_binï¼Œå¤§å°å†™æ•æ„Ÿï¼Œå› æ­¤ABD\u0026lt;ZBC\u0026lt;abcã€‚\nå…³äºmysqlç›¸å…³æµ·é‡æ•™ç¨‹å¯ä»¥å…³æ³¨æ–‡æœ«å…¬ä¼—å·å›å¤ã€1ã€‘åŠ åŠ©æ‰‹å¾®ä¿¡ç´¢å–ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/mysql%E5%A4%A7%E5%B0%8F%E5%86%99%E6%95%8F%E6%84%9F%E4%B8%8E%E6%A0%A1%E5%AF%B9%E8%A7%84%E5%88%99/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190521.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eå¤§å®¶åœ¨ä½¿ç”¨mysqlè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°ç±»ä¼¼ä»¥ä¸‹çš„é—®é¢˜ï¼š\u003c/p\u003e","title":"mysqlå¤§å°å†™æ•æ„Ÿä¸æ ¡å¯¹è§„åˆ™","type":"posts"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/xyplorer/","section":"Tags","summary":"","title":"XYplorer","type":"tags"},{"content":" æ­£æ–‡ # åœ¨æ—¥å¸¸ç”Ÿæ´»æˆ–å·¥ä½œä¸­ï¼Œé™¤äº†ä¸€äº›æ–‡æœ¬ç¼–è¾‘å·¥å…·ä»¥åŠç½‘é¡µæµè§ˆå™¨ä»¥å¤–ï¼Œæˆ‘ä»¬æ¥è§¦çš„æœ€å¤šçš„å¯èƒ½å°±æ˜¯èµ„æºç®¡ç†å™¨äº†ã€‚èµ„æºç®¡ç†å™¨è½¯ä»¶æœ‰å¾ˆå¤šã€‚å¦‚ï¼š\nClover ã€QTTabBarã€FreeCommanderã€WindowsTabsã€Q-Dirã€Total Commanderç­‰\nä¹‹å‰ä¸€ç›´ç”¨Cloverï¼Œå®ƒ æ˜¯ Windows Explorer èµ„æºç®¡ç†å™¨çš„ä¸€ä¸ªæ‰©å±•ï¼Œä¸ºå…¶å¢åŠ ç±»ä¼¼è°·æ­Œ Chrome æµè§ˆå™¨çš„å¤šæ ‡ç­¾é¡µåŠŸèƒ½ã€‚ä½†è¿™æ¬¾è½¯ä»¶ä¹…æ— æ›´æ–°ï¼Œä¸”å­˜åœ¨çš„é—®é¢˜è®©äººç”¨ç€å¾ˆä¸çˆ½ï¼šåœ¨win10ä¸‹æ‰“å¼€çª—å£ä¼šç»å¸¸å´©æºƒæˆ–åæ˜ è¿Ÿé’æˆ–å¡æœºå¤±å»å“åº”ï¼Œè€Œä¸”åœ¨åº•éƒ¨å¢åŠ äº†å¹¿å‘Šæ¡ï¼Œç¾åå…¶æ›°â€œçŠ¶æ€æ â€ï¼Œæ›´æ˜¯åœ¨ä¹¦ç­¾é‡Œéƒ½æ”¾ä¸Šäº†æ·˜å®äº¬ä¸œçš„æ¨å¹¿é“¾æ¥ã€‚æœ¬æ¥åšçš„æŒºå¥½çš„ä¸€æ¬¾è½¯ä»¶è¢«ç³Ÿè¹‹æˆè¿™æ ·ï¼Œæœæ–­å¯»æ‰¾äº†æ›¿ä»£å“XYplorer ã€‚\nXYplorer æ˜¯ä¸€æ¬¾èµ„æºç®¡ç†å™¨å¢å¼ºå·¥å…·ï¼Œæä¾›å¤šé¢æ¿æ“ä½œã€å°†ç¨‹åºå›ºå®šè‡³ä»»åŠ¡æ ã€å¿«æ·æ–‡ä»¶æ–°å»ºç­‰ä¸å¸¸è§çš„é«˜æ•ˆåŠŸèƒ½ã€‚XYplorer å‡­å€Ÿå…¶å¼ºå¤§æ€§èƒ½ä»¥åŠå¯¹ä¸­æ–‡çš„å‹å¥½æ”¯æŒï¼Œåœ¨ä¸­å›½ç”¨æˆ·ä¹‹é—´æœ‰ç€éå¸¸é«˜çš„ä¼ æ’­åº¦ï¼Œå…¶ä¸»è¦åŠŸèƒ½ï¼š\n1ã€å¤šæ ‡ç­¾æ”¯æŒ\n2ã€å¼ºåˆ¶åªèƒ½è¿è¡Œä¸€ä¸ªå®ä¾‹\n3ã€æ”¯æŒå¿«æ·é”®æ“ä½œï¼ˆctrl+Tï¼‰\nå¦‚æœä½ æœ‰å¤§é‡æ–‡ä»¶ç®¡ç†éœ€æ±‚ï¼Œå»ºè®®ä½ å¯ä»¥å¯¹æ¯”å®˜ç½‘è¿›è¡Œæ·±åº¦æ¢ç´¢ï¼›å¦‚æœä½ åªæ˜¯æ‰¾ä¸€æ¬¾cloverçš„æ›¿ä»£è€…ï¼Œå®ƒä¼šè®©ä½ ç”¨å¾—å¾ˆèˆ’çˆ½ï¼Œæµç•…æ€§æ²¡å¾—è¯´ã€‚\nä¸‹é¢ä»‹ç»å‡ ä¸ªå¸å¼•æˆ‘çš„ç‚¹\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\u0026hellip;\nåŒå±å¤šæ ‡ç­¾ï¼š\nä¸€èˆ¬çš„æ–‡ä»¶ç®¡ç†å™¨è¦ä¹ˆæ˜¯åªæœ‰åŒé¢æ¿ï¼Œè¦ä¹ˆæ˜¯åªæœ‰å¤šæ ‡ç­¾ï¼Œè€ŒXYploreråšåˆ°äº†çœŸæ­£çš„åŒé¢æ¿å¤šæ ‡ç­¾ï¼Œåœ¨æ•´ç†å¤§é‡æ–‡ä»¶æ—¶å®åœ¨æ˜¯åˆ©å™¨ï¼Œå³ä½¿ä¸æ…å…³é—­ä¸å¿…æ‹…å¿ƒï¼ŒXYplorer å°†ä¸ºæ‚¨è®°å¿†ä¸Šæ¬¡æ‰“å¼€çš„æ‰€æœ‰æ ‡ç­¾ä»¥åŠåŒé¢æ¿çŠ¶æ€ã€‚\nè‡ªåŠ¨è®¡ç®—æ–‡ä»¶å¤¹å¤§å°ï¼š\nä»¥å¾€è¦ç”¨ä¸“é—¨çš„è½¯ä»¶æˆ–æ’ä»¶æ‰èƒ½åšåˆ°ï¼Œè€ŒXYploreråŸç”Ÿå³å¯è®¡ç®—ï¼Œç›¸å½“æ–¹ä¾¿ï¼Œè€Œä¸”é€Ÿåº¦éå¸¸å¿«ï¼ï¼ˆæœ€ç‰›Xçš„æ˜¯è¿˜èƒ½è‡ªå®šä¹‰æ–‡ä»¶å¤¹å¤§å°çš„å•ä½ï¼ï¼‰\næ–‡ä»¶ç­›é€‰ï¼š\nXYplorer è¿˜åŒæ—¶æä¾›äº†å¼ºå¤§çš„æ–‡ä»¶ç­›é€‰å·¥å…·å¹¶æ”¯æŒç”¨æˆ·è‡ªè¡Œè®¾å®šçš„æ–‡ä»¶ç±»å‹ (å•ç§æˆ–å¤šç§æ‹“å±•å)ï¼Œå…¶å°†ä¸ºæ‚¨ç­›é€‰å¹¶æ˜¾ç¤ºæŸä¸€æˆ–æ•°ä¸ªç±»å‹çš„æ‰€æœ‰æ–‡ä»¶ä»¥æ–¹ä¾¿æ‚¨è¿›è¡Œæ‰¹é‡æ“ä½œã€‚\nè‡ªå®šä¹‰å‘½ä»¤ï¼š\nåœ¨å¹³æ—¥æ•´ç†æ–‡ä»¶æ—¶å¯èƒ½ç»å¸¸éœ€è¦å°†æŸäº›ç±»å‹çš„æ–‡ä»¶ç§»åŠ¨è‡³æŸä¸ªæ–‡ä»¶å¤¹ï¼Œé€šè¿‡å®šä¹‰ XYplorer ç”¨æˆ·å‘½ä»¤ï¼Œæ‚¨å¯ä»¥å…ˆä½¿ç”¨ç­›é€‰å·¥å…·é€‰æ‹©æ‚¨æ‰€éœ€è¦å¤„ç†çš„æ–‡ä»¶ç„¶åæŒ‰ä¸‹æ‰€å®šä¹‰çš„å¿«æ·é”®å³å¯å°†æ–‡ä»¶å¤‡ä»½ã€ç§»åŠ¨è‡³æŒ‡å®šæ–‡ä»¶å¤¹ï¼Œäº¦å¯å¯¹å…¶è·¯å¾„è¿›è¡Œè‡ªå®šä¹‰ï¼Œä¾‹å¦‚æŒ‰æ—¶é—´ã€æŒ‰é•¿åº¦ã€æŒ‰æ•°é‡ç­‰æ–¹å¼å»ºç«‹æ–‡ä»¶å¤¹ç­‰ç­‰ã€‚æ‚¨å¯ä»¥å•å‡»åŠ¨ä½œåçš„æŠ€å·§æ‰¾åˆ°æ‰€æœ‰çš„å¯ä»£æ›¿å€¼ï¼Œä¾‹å¦‚æ—¶é—´ã€è·¯å¾„ã€é•¿åº¦ç­‰ã€‚\næ–‡ä»¶æŸ¥æ‰¾ï¼š\nåŠ é€ŸæŸ¥æ‰¾æ–‡ä»¶çš„é€Ÿåº¦ï¼Œæ¯”windowsè‡ªå¸¦çš„æŸ¥æ‰¾åŠŸèƒ½æµç•…é€Ÿåº¦å¿«ï¼Œå¥½ç”¨ä¸å¡ã€‚\næ‰¹é‡é‡å‘½åï¼š\nä»¥ä¸Šä¾¿æ˜¯å¸å¼•æˆ‘çš„ç‚¹ï¼Œè€Œä¸”æˆ‘ç°åœ¨åªç”¨äº†ä¸åˆ°20%çš„åŠŸèƒ½ï¼ˆå¯¹æ¯”å®˜æ–¹çš„feature listï¼‰ï¼Œå¯æƒ³è€ŒçŸ¥è¿™ä¸ªè½¯ä»¶å¯å®šåˆ¶åº¦ç›¸å½“é«˜ï¼Œåœ¨æ—¥åå·¥ä½œä¸­æ…¢æ…¢ä½“ä¼šå®ƒçš„å¼ºå¤§ä¹‹å¤„ã€‚\næ–‡ç« ä¸­ XYplorer è½¯ä»¶å¯ä»¥å…³æ³¨æ–‡æœ«å…¬ä¼—å·ååœ¨åå°å›å¤ã€1ã€‘ è·å–ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E4%B8%80%E6%AC%BE%E6%9C%80%E5%A5%BD%E7%94%A8%E7%9A%84windows%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%99%A8/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180704.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eåœ¨æ—¥å¸¸ç”Ÿæ´»æˆ–å·¥ä½œä¸­ï¼Œé™¤äº†ä¸€äº›æ–‡æœ¬ç¼–è¾‘å·¥å…·ä»¥åŠç½‘é¡µæµè§ˆå™¨ä»¥å¤–ï¼Œæˆ‘ä»¬æ¥è§¦çš„æœ€å¤šçš„å¯èƒ½å°±æ˜¯èµ„æºç®¡ç†å™¨äº†ã€‚èµ„æºç®¡ç†å™¨è½¯ä»¶æœ‰å¾ˆå¤šã€‚å¦‚ï¼š\u003c/p\u003e","title":"ä¸€æ¬¾æœ€å¥½ç”¨çš„windowsæ–‡ä»¶ç®¡ç†å™¨","type":"posts"},{"content":" æ­£æ–‡ # æ—¥å¿—çš„è½¬å‚¨å’Œå‹ç¼©æ˜¯éå¸¸å…³é”®çš„ï¼Œå®ƒä¸ä»…å¯ä»¥å‡å°‘ç¡¬ç›˜ç©ºé—´å ç”¨ï¼Œä¸»è¦è¿˜å¯ä»¥åœ¨å‘ç”Ÿæ•…éšœæ—¶æ ¹æ®æ—¥å¿—å®šä½å‡ºæ•…éšœåŸå› ã€‚ä¸‹é¢æ¥çœ‹çœ‹golangå’Œjavaçš„æ–‡ä»¶è½¬å‚¨å®ç°ã€‚\ngoè¯­è¨€ï¼š # ç”¨åˆ°äº†filepathåŒ…ä¸‹çš„Walkæ–¹æ³•ï¼Œå…·ä½“è¯´æ˜å¯ä»¥å‚çœ‹å†å²æ–‡ç« ï¼š\ngoè¯­è¨€path/filepathåŒ…ä¹‹Walkæºç è§£æ\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;io\u0026#34; \u0026#34;archive/zip\u0026#34; \u0026#34;path/filepath\u0026#34; \u0026#34;time\u0026#34; \u0026#34;log\u0026#34; ) func main() { logFile := \u0026#34;D:/tmp/successLog/logs/root.log\u0026#34; backFile := \u0026#34;D:/tmp/successLog/logs/root_\u0026#34; + time.Now().Format(\u0026#34;20060102150405\u0026#34;) + \u0026#34;.zip\u0026#34; err := zipFile(logFile, backFile) if err != nil { log.Println(fmt.Sprintf(\u0026#34;zip file %s to %s error : %v\u0026#34;, logFile, backFile, err)) return } else { os.Remove(logFile) } //è½¬å‚¨ååˆ›å»ºæ–°æ–‡ä»¶ //createFile() //ä¿®æ”¹æ–‡ä»¶æƒé™ //os.Chmod(backfile, 0400) //åˆ é™¤å¤‡ä»½æ–‡ä»¶ //deleteOldBackfiles(dir) } func zipFile(source, target string) error { zipFile, err := os.OpenFile(target, os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0440) if err != nil { log.Println(err) return err } defer zipFile.Close() archive := zip.NewWriter(zipFile) defer archive.Close() return filepath.Walk(source, func(path string, info os.FileInfo, err error) error { if err != nil { return err } header, err := zip.FileInfoHeader(info) if err != nil { return err } if !info.IsDir() { header.Method = zip.Deflate } header.SetModTime(time.Now().UTC()) header.Name = path writer, err := archive.CreateHeader(header) if err != nil { return err } if info.IsDir() { return nil } file, err := os.Open(path) if err != nil { return err } defer file.Close() _, err = io.Copy(writer, file) return err }) } javaç‰ˆï¼š # è¯´æ˜è§æ³¨é‡Šã€‚\nimport org.slf4j.Logger; import org.slf4j.LoggerFactory; import java.io.*; import java.text.DateFormat; import java.text.SimpleDateFormat; import java.util.zip.CRC32; import java.util.zip.CheckedOutputStream; import java.util.zip.ZipEntry; import java.util.zip.ZipOutputStream; /** * @program: website * @description: è½¬å‚¨å‹ç¼©æ–‡ä»¶ * @author: smallsoup * @create: 2018-08-12 17:58 **/ public class ZipFile { private static final Logger LOGGER = LoggerFactory.getLogger(ZipFile.class); /** * æ ¼å¼åŒ–æ–‡ä»¶åæ ¼å¼ */ private static final String AUDIT_LOG_FORMAT = \u0026#34;yyyyMMddHHmmssSSS\u0026#34;; /** * å‹ç¼©åæ–‡ä»¶åç¼€ */ private static final String AUDIT_FILE_ZIP_SUFFIX = \u0026#34;.zip\u0026#34;; /** * å‹ç¼©å‰æ–‡ä»¶åç¼€ */ private static final String AUDIT_FILE_EXT = \u0026#34;.log\u0026#34;; private static final int ZIP_BUFFER = 4096; /** * æ§åˆ¶å‹ç¼©åçš„æ–‡ä»¶è§£å‹åæ˜¯å¦å¸¦baseè·¯å¾„ */ private static final String rootPath = \u0026#34;\u0026#34;; public static void main(String[] args) throws IOException { System.out.println(); new ZipFile().zipAuditLogFile(\u0026#34;D:/tmp/successLog/logs/root.log\u0026#34;); } /** * æ—¥å¿—å‹ç¼© * * @param waitZipFile è¦å‹ç¼©æ–‡ä»¶å * @throws IOException */ private void zipAuditLogFile(String waitZipFile) throws IOException { File oldFile = new File(waitZipFile); if (!oldFile.exists()) { LOGGER.error(\u0026#34;zipAuditLogFile name is {} not exist\u0026#34;, waitZipFile); return; } //ç”Ÿæˆzipæ–‡ä»¶å DateFormat dataFormat = new SimpleDateFormat(AUDIT_LOG_FORMAT); String formatTime = dataFormat.format(oldFile.lastModified()); int end = waitZipFile.length() - AUDIT_FILE_EXT.length(); String zipFileName = waitZipFile.subSequence(0, end) + \u0026#34;_\u0026#34; + formatTime + AUDIT_FILE_ZIP_SUFFIX; File zipFile = new File(zipFileName); FileOutputStream zipfos = null; ZipOutputStream zipOs = null; CheckedOutputStream cos = null; try { zipfos = new FileOutputStream(zipFile); cos = new CheckedOutputStream(zipfos, new CRC32()); zipOs = new ZipOutputStream(cos); compress(oldFile, zipOs, rootPath); if (zipFile.exists()) { // å†™å®Œçš„æ—¥å¿—æ–‡ä»¶æƒé™æ”¹ä¸º400 try { //linuxä¸Šæ‰å¯ä»¥è¿è¡Œ,windowsä¸Šéœ€è¦è£…cygwinå¹¶ä¸”æŠŠcygwinçš„binç›®å½•åŠ åˆ°ç¯å¢ƒå˜é‡çš„pathä¸­æ‰å¯ä»¥ Runtime.getRuntime().exec(\u0026#34;chmod 400 -R \u0026#34; + zipFile); //å‹ç¼©ååˆ é™¤æ—§æ–‡ä»¶ boolean isDelete = oldFile.delete(); //åˆ›å»ºæ–°æ–‡ä»¶ if (isDelete) { oldFile.createNewFile(); } // boolean isSuccess = PathUtil.setFilePermision(zipFile.toPath(), ARCHIVE_LOGFILE_PERMISION); // LOGGER.warn(\u0026#34;set archive file: {}, permision result is {}\u0026#34;, zipFile.getAbsolutePath(), isSuccess); } catch (IOException e) { LOGGER.error(\u0026#34;set archive file:{} permision catch an error: {}\u0026#34;, zipFile, e); } } } finally { if (null != zipOs) { zipOs.close(); } if (null != cos) { cos.close(); } if (null != zipfos) { zipfos.close(); } } } /** * å‹ç¼©æ–‡ä»¶æˆ–ç›®å½• * * @param oldFile è¦å‹ç¼©çš„æ–‡ä»¶ * @param zipOut å‹ç¼©æ–‡ä»¶æµ * @param baseDir baseDir * @throws IOException */ private void compress(File oldFile, ZipOutputStream zipOut, String baseDir) throws IOException { if (oldFile.isDirectory()) { compressDirectory(oldFile, zipOut, baseDir); } else { compressFile(oldFile, zipOut, baseDir); } } /** * å‹ç¼©ç›®å½• * * @param dir è¦å‹ç¼©çš„ç›®å½• * @param zipOut å‹ç¼©æ–‡ä»¶æµ * @param baseDir baseDir * @throws IOException */ private void compressDirectory(File dir, ZipOutputStream zipOut, String baseDir) throws IOException { File[] files = dir.listFiles(); for (File file : files) { compress(file, zipOut, baseDir + dir.getName() + File.separator); } } /** * å‹ç¼©æ–‡ä»¶ * * @param oldFile è¦å‹ç¼©çš„æ–‡ä»¶ * @param zipOut å‹ç¼©æ–‡ä»¶æµ * @param baseDir baseDir * @throws IOException */ private void compressFile(File oldFile, ZipOutputStream zipOut, String baseDir) throws IOException { if (!oldFile.exists()) { LOGGER.error(\u0026#34;zipAuditLogFile name is {} not exist\u0026#34;, oldFile); return; } BufferedInputStream bis = null; try { bis = new BufferedInputStream(new FileInputStream(oldFile)); ZipEntry zipEntry = new ZipEntry(baseDir + oldFile.getName()); zipOut.putNextEntry(zipEntry); int count; byte data[] = new byte[ZIP_BUFFER]; while ((count = bis.read(data, 0, ZIP_BUFFER)) != -1) { zipOut.write(data, 0, count); } } finally { if (null != bis) { bis.close(); } } } } ä¿®æ”¹æƒé™ä¹Ÿå¯ä»¥åˆ©ç”¨Java7ä¸­NIO.2å¯¹å…ƒæ•°æ®æ–‡ä»¶æ“ä½œçš„æ”¯æŒï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹NIOåŒ…çš„ä½¿ç”¨ï¼Œå…¶ç›¸å…³æ•™ç¨‹è§æ–‡æœ«è¯´æ˜ã€‚\nä»£ç å¦‚ä¸‹ï¼š\npackage com.website.common; import java.io.IOException; import java.nio.file.FileSystems; import java.nio.file.Files; import java.nio.file.Path; import java.nio.file.attribute.PosixFilePermission; import java.nio.file.attribute.PosixFilePermissions; import java.util.Set; /** * æä¾›æ–‡ä»¶è·¯å¾„å…¬å…±å‡½æ•° æ”¹å˜æƒé™ï¼Œåˆ¤æ–­æ˜¯å¦æ­£è§„æ–‡ä»¶ï¼Œåˆ¤æ–­æ˜¯å¦è·¯å¾„åœ¨å®‰å…¨è·¯å¾„ä¸‹ç­‰ * * @program: website * @description: è·¯å¾„å·¥å…·, ä¿®æ”¹æƒé™ * @author: smallsoup * @create: 2018-08-14 07:56 **/ public class PathUtil { /** * POSIXè¡¨ç¤ºå¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£,å¹¶ä¸å±€é™äºunixç±»ç³»ç»Ÿ */ private static final boolean ISPOSIX = FileSystems.getDefault().supportedFileAttributeViews().contains(\u0026#34;posix\u0026#34;); /** * æ•°å­—æƒé™æ ¼å¼,å¦‚600 */ private static final int PERM_LEN_THREE = 3; /** * å¦‚765 rwxrw_r_x */ private static final int PERM_LEN_NINE = 9; /** * è®¾ç½®æ–‡ä»¶çš„æƒé™ï¼Œå°½åœ¨posixä¸‹æœ‰æ•ˆ * * @param file æ–‡ä»¶ * @param perm æƒé™ ç±»ä¼¼ â€œrw-r-----â€, \u0026#34;640\u0026#34; * @return true ä¿®æ”¹æˆåŠŸ false ä¿®æ”¹å¤±è´¥ * @throws IOException */ public static boolean setFilePermision(Path file, String perm) throws IOException { if (!ISPOSIX) { return true; } // 750 -\u0026gt; \u0026#34;rwxr-x---\u0026#34; if (perm.length() == PERM_LEN_THREE) { perm = trans2StrPerm(perm); } if (perm.length() != PERM_LEN_NINE) { return false; } Set\u0026lt;PosixFilePermission\u0026gt; perms = PosixFilePermissions.fromString(perm); Files.setPosixFilePermissions(file, perms); return true; } /** * è½¬æ¢ * * @param digitPerm é•¿åº¦ä¸º3çš„æ•°å­—å­—ç¬¦ä¸² * @return */ private static String trans2StrPerm(String digitPerm) { StringBuilder builder = new StringBuilder(9); // owner builder.append(toStringPerm(digitPerm.charAt(0))); // group builder.append(toStringPerm(digitPerm.charAt(1))); // other builder.append(toStringPerm(digitPerm.charAt(2))); return builder.toString(); } private static String toStringPerm(char ch) { switch (ch - \u0026#39;0\u0026#39;) { case 7: return \u0026#34;rwx\u0026#34;; case 6: return \u0026#34;rw-\u0026#34;; case 5: return \u0026#34;r-x\u0026#34;; case 4: return \u0026#34;r--\u0026#34;; case 3: return \u0026#34;-wx\u0026#34;; case 2: return \u0026#34;-w-\u0026#34;; case 1: return \u0026#34;--x\u0026#34;; case 0: return \u0026#34;---\u0026#34;; default: return \u0026#34;\u0026#34;; } } } goè¯­è¨€ã€NIOç­‰å­¦ä¹ èµ„æ–™ å¯ä»¥å…³æ³¨æ–‡æœ«å…¬ä¼—å·ååœ¨åå°å›å¤ã€1ã€‘ è·å–ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/javagolang%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E8%BD%AC%E5%82%A8%E5%8E%8B%E7%BC%A9%E5%AE%9E%E7%8E%B0/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190324.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eæ—¥å¿—çš„è½¬å‚¨å’Œå‹ç¼©æ˜¯éå¸¸å…³é”®çš„ï¼Œå®ƒä¸ä»…å¯ä»¥å‡å°‘ç¡¬ç›˜ç©ºé—´å ç”¨ï¼Œä¸»è¦è¿˜å¯ä»¥åœ¨å‘ç”Ÿæ•…éšœæ—¶æ ¹æ®æ—¥å¿—å®šä½å‡ºæ•…éšœåŸå› ã€‚ä¸‹é¢æ¥çœ‹çœ‹golangå’Œjavaçš„æ–‡ä»¶è½¬å‚¨å®ç°ã€‚\u003c/p\u003e","title":"javaã€golangæ—¥å¿—æ–‡ä»¶è½¬å‚¨å‹ç¼©å®ç°","type":"posts"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/%E6%97%A5%E5%BF%97/","section":"Tags","summary":"","title":"æ—¥å¿—","type":"tags"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/typora/","section":"Tags","summary":"","title":"Typora","type":"tags"},{"content":" æ­£æ–‡ # Markdown å…¶å®å‘æ¥æ˜¯æ–‡å­—çˆ±å¥½è€…å’Œç å†œä»¬çš„å°ä¼—éœ€æ±‚ï¼Œå¸‚é¢ä¸Šä¹Ÿæ¶Œç°å‡ºäº†å½¢å½¢è‰²è‰²çš„ Markdown ç¼–è¾‘å™¨ï¼ŒMouã€Typedã€Ulysessã€Macdownã€ç®€ä¹¦ã€æœ‰é“äº‘ç­‰ï¼Œè¿™äº›æ¯”è¾ƒæµè¡Œçš„ Markdown ç¼–è¾‘å™¨ï¼Œéƒ½åŸºæœ¬é‡‡ç”¨äº†ã€Œå†™å­—ã€å’Œã€Œé¢„è§ˆã€ç›¸åˆ†ç¦»çš„ç­–ç•¥ã€‚\nTyporaçš„è®¾è®¡ç†å¿µå°±æ˜¯æè‡´ç®€æ´ï¼Œå®ƒå°†ã€Œå†™å­—ã€å’Œã€Œé¢„è§ˆã€è¿™ä¸¤ä»¶äº‹æƒ…åˆå¹¶äº†ï¼Œè¾“å…¥çš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯è¾“å‡ºçš„åœ°æ–¹ï¼Œå³æ‰€è§å³æ‰€å¾—ã€‚\nç¼–è¾‘é¢„è§ˆåˆä¸€ï¼š\næ‰€æœ‰çš„è¡Œå†…å…ƒç´ ï¼ˆå¦‚åŠ ç²—ã€æ–œä½“ï¼‰éƒ½ä¼šæ ¹æ®å½“å‰æ˜¯å¦åœ¨ç¼–è¾‘æ€è€Œæ™ºèƒ½åœ°åœ¨ç¼–è¾‘æ€å’Œé¢„è§ˆæ€åˆ‡æ¢ï¼Œè€ŒåŒºå—çº§å…ƒç´ ï¼ˆå¦‚æ ‡é¢˜ã€åˆ—è¡¨ï¼‰åˆ™ä¼šåœ¨æŒ‰ä¸‹ Enter åå³æ—¶æ¸²æŸ“ï¼Œä¸èƒ½å†æ¬¡ç¼–è¾‘ã€‚\nè¡¨æ ¼ã€ä»£ç ã€å…¬å¼ç¼–è¾‘ï¼š\nä¹‹æ‰€ä»¥æŠŠè¿™ä¸‰ä¸ªæ”¾ä¸€å—æ˜¯å› ä¸ºä»–ä»¬éƒ½æ˜¯åŒºå—å…ƒç´ ï¼Œè€Œä¸”å®ƒä»¬éƒ½å¯ä»¥ä½¿ç”¨å¿«æ·é”®æ’å…¥ã€‚\nè¡¨æ ¼ï¼š\næ’å…¥è¡¨æ ¼çš„å¿«æ·é”®åœ¨windowsä¸Šæ˜¯ctrl + T,æ•ˆæœå¦‚ä¸‹ï¼š\nä»£ç ï¼š\nè¾“å…¥```æŒ‰ä¸‹å›è½¦ï¼Œå¦‚å›¾ï¼š\nå³ä¸‹è§’å¯ä»¥è¾“å…¥ä»£ç çš„è¯­è¨€ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„è¯­è¨€è‡ªåŠ¨é«˜äº®æ˜¾ç¤ºï¼Œè¿ Swift ä¹Ÿä¸åœ¨ä¾‹å¤–ã€‚\næ•°å­¦è¡¨è¾¾å¼ï¼š\nè¦å¯ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œé¦–å…ˆåˆ°Preference -\u0026gt; Editorä¸­å¯ç”¨ã€‚\nç„¶åä½¿ç”¨$ç¬¦å·åŒ…è£¹Texå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š\n$lim_{x \\to \\infty} \\ exp(-x)=0$\nå°†äº§ç”Ÿå¦‚ä¸‹çš„æ•°å­¦è¡¨è¾¾å¼ï¼š\nlimxâ†’âˆ exp(âˆ’x)=0\nTyporaæ”¯æŒLatexçš„å…¬å¼ç¼–è¾‘ï¼Œå…¬å¼ç¼–è¾‘å‡ ä¹å’Œä»£ç ç¼–è¾‘çš„ä½¿ç”¨æ–¹æ³•ç›¸åŒï¼ŒåŒæ ·åˆ†è¡Œå†…å…¬å¼å’Œè¡Œé—´å…¬å¼ï¼Œè¡Œå†…å…¬å¼ç”¨ä¸¤ä¸ª$åŒ…è£¹èµ·æ¥ï¼Œè¡Œé—´å…¬å¼å¯ä»¥ä½¿ç”¨å¿«æ·é”®ctrl+shift+mæ’å…¥ï¼š\næ’å…¥å›¾ç‰‡ï¼š\nåœ¨ä¼ ç»Ÿçš„ Markdown ç¼–è¾‘å™¨ä¸­ï¼Œå¦‚æœæƒ³è¦æ’å…¥ä¸€å¼ å›¾ç‰‡ï¼Œé»˜è®¤çš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼š\nè€Œåœ¨ Typora ä¸­ï¼Œåªéœ€è¦åƒæŠŠå›¾ç‰‡æ‹–æ‹½è¿›å»ï¼Œå°±å¤§åŠŸå‘Šæˆäº†ã€‚å†ä¹Ÿä¸ç”¨è®°ä½è¯­æ³•æ ¼å¼ï¼Œå†ä¹Ÿä¸ç”¨è¾“æ–‡ä»¶åï¼Œå†ä¹Ÿä¸ç”¨è‡ªå·±å»æ‰¾æ–‡ä»¶çš„è·¯å¾„åœ°å€ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚\nè‡ªå®šä¹‰ä¸»é¢˜ï¼š\nä¸‹è½½å®Œæˆåé»˜è®¤ä¼šå¸¦æœ‰å‡ å¥—ä¸»é¢˜ï¼šGithubã€newprintã€Nightã€pixyllã€whitey\nå¯¼å‡ºï¼š\nTyporaçš„å¯¼å‡ºé€‰é¡¹æä¾›äº†å¾ˆå¤šé€‰é¡¹ï¼ŒPDFã€htmlç­‰ç­‰ï¼Œ\nå¦‚ä¸‹ä¸ºå¯¼å‡ºçš„PDFæ ¼å¼é¢„è§ˆï¼š\nè¯¥è½¯ä»¶çš„ windowså’Œmacç‰ˆçš„ å¯ä»¥å…³æ³¨æ–‡æœ«å…¬ä¼—å·ååœ¨åå°å›å¤ã€1ã€‘ï¼ŒåŠ å°åŠ©æ‰‹å¾®ä¿¡ç´¢å–ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E4%B8%80%E6%AC%BE%E5%BE%88%E5%A5%BD%E7%94%A8%E7%9A%84markdown%E7%BC%96%E8%BE%91%E5%99%A8/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190115.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eMarkdown å…¶å®å‘æ¥æ˜¯æ–‡å­—çˆ±å¥½è€…å’Œç å†œä»¬çš„å°ä¼—éœ€æ±‚ï¼Œå¸‚é¢ä¸Šä¹Ÿæ¶Œç°å‡ºäº†å½¢å½¢è‰²è‰²çš„ Markdown ç¼–è¾‘å™¨ï¼ŒMouã€Typedã€Ulysessã€Macdownã€ç®€ä¹¦ã€æœ‰é“äº‘ç­‰ï¼Œè¿™äº›æ¯”è¾ƒæµè¡Œçš„ Markdown ç¼–è¾‘å™¨ï¼Œéƒ½åŸºæœ¬é‡‡ç”¨äº†ã€Œå†™å­—ã€å’Œã€Œé¢„è§ˆã€ç›¸åˆ†ç¦»çš„ç­–ç•¥ã€‚\u003c/p\u003e","title":"ä¸€æ¬¾å¾ˆå¥½ç”¨çš„markdownç¼–è¾‘å™¨","type":"posts"},{"content":" æ­£æ–‡ # ä»Šå¤©æ¥çœ‹ä¸‰ä»¶äº‹ï¼š\n1ã€beegoçš„ä¸¤ä¸ªé‡è¦å‚æ•°ï¼š # beego.BConfig.CopyRequestBodyï¼š\næ˜¯å¦å…è®¸åœ¨HTTPè¯·æ±‚æ—¶ï¼Œè¿”å›åŸå§‹è¯·æ±‚ä½“æ•°æ®å­—èŠ‚ï¼Œé»˜è®¤ä¸ºfalseï¼ˆGET or HEAD or ä¸Šä¼ æ–‡ä»¶è¯·æ±‚é™¤å¤–ï¼‰ã€‚\nbeego.BConfig.CopyRequestBody = false\nåœ¨controllerä¸­this.Ctx.Input.RequestBodyå–bodyä½“æ—¶ï¼Œéœ€è¦æ³¨æ„å¿…é¡»æŠŠapp.confä¸­çš„CopyRequestBodyå±æ€§è®¾ç½®ä¸ºtrueï¼Œå¹¶ä¿è¯é…ç½®æ–‡ä»¶èƒ½è¢«è¯»å–åˆ°ã€‚åªæœ‰åœ¨éGETè¯·æ±‚ï¼Œthis.Ctx.Input.RequestBodyæ‰èƒ½å–åˆ°è¯·æ±‚ä¸­çš„bodyä½“ã€‚\nbeego.BConfig.RecoverPanicï¼š\næ˜¯å¦å¼‚å¸¸æ¢å¤ï¼Œé»˜è®¤å€¼ä¸º trueï¼Œå³å½“åº”ç”¨å‡ºç°å¼‚å¸¸çš„æƒ…å†µï¼Œé€šè¿‡ recover æ¢å¤å›æ¥ï¼Œè€Œä¸ä¼šå¯¼è‡´åº”ç”¨å¼‚å¸¸é€€å‡ºã€‚\nbeego.BConfig.RecoverPanic = true\nåœ¨è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦è¯´æ˜ï¼Œåˆ©ç”¨beegoæ­å»ºçš„webå·¥ç¨‹æœ€å¥½ç”¨beeå·¥å…·è¿è¡Œï¼Œå› ä¸ºåœ¨beego1.6.1ç‰ˆæœ¬ï¼Œç”¨go runè¿è¡Œï¼Œç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°äº†\n**slice bounds out of rangeï¼š**åˆ‡ç‰‡ä¸‹æ ‡è¶Šç•Œï¼›\næˆ–è€…\n**invalid memory address or nil pointer dereferenceï¼š**æ²¡æœ‰åˆå§‹åŒ–çš„åœ°å€ï¼Œå³ç©ºæŒ‡é’ˆã€‚\néƒ½ä¸ä¼šæ‰“å°æ—¥å¿—ï¼ŒåŠ å¤§é—®é¢˜å®šä½éš¾åº¦ã€‚\nå½“ä½¿ç”¨beego1.8.3ç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥æ­£å¸¸è¯»åˆ°app.confé…ç½®ï¼š\nCopyRequestBody = true HTTPPort = 8081 åŒæ ·çš„app.confé…ç½®ï¼Œç”¨beego1.6.1å¯åŠ¨åï¼š\nä½†ç”¨beeå·¥å…·å¯åŠ¨æ—¶åŠ è½½æ­£å¸¸ï¼š\nç»æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°è¿™æ˜¯beego1.6.1ç‰ˆæœ¬çš„bugï¼Œissueè§ï¼š\nhttps://github.com/astaxie/beego/issues/1831\næœ‰å…´è¶£å¯ä»¥çœ‹çœ‹å„ä½å¤§ä½¬æ¿€çƒˆçš„è®¨è®ºã€‚\n2ã€beegoå‚æ•°æ¥æ”¶ï¼š\nç¬¬ä¸€ç§ï¼šè·¯å¾„å‚æ•° (Path Parameters)ï¼š\nå°±æ˜¯ç”¨ URL è·¯å¾„çš„ä¸€éƒ¨åˆ†æ¥ä½œä¸ºæˆ‘ä»¬è·å–å‚æ•°å€¼çš„ä¸€ç§æ–¹å¼ã€‚\nå¦‚ï¼š\nbeego.Router(\u0026#34;/:ak/:sk\u0026#34;, \u0026amp;SayHelloController, \u0026#34;POST:SayHello\u0026#34;) æˆ–è€… beego.Router(\u0026#34;/?:ak/?:sk\u0026#34;, \u0026amp;SayHelloController, \u0026#34;GET:SayHello\u0026#34;) æ¥æ”¶æ–¹æ³•å¦‚ä¸‹ï¼š\næ–¹æ³•ä¸€ï¼š fmt.Println(\u0026#34;---ak is --- \u0026#34;, this.GetString(\u0026#34;:ak\u0026#34;)) fmt.Println(\u0026#34;---sk is --- \u0026#34;, this.GetString(\u0026#34;:sk\u0026#34;)) æ–¹æ³•äºŒï¼š sk1 := this.Ctx.Input.Param(\u0026#34;:sk\u0026#34;) ak1 := this.Ctx.Input.Param(\u0026#34;:ak\u0026#34;) ç¬¬äºŒç§ï¼šæŸ¥è¯¢å‚æ•° (Query string)\nåœ¨ beego ä¸­è·å–æŸ¥è¯¢å‚æ•°æ˜¯ååˆ†æ–¹ä¾¿çš„, ä½¿ç”¨ beego.Controller.GetString() ä¾¿å¯ä»¥æ–¹ä¾¿çš„è·å–æŸ¥è¯¢å‚æ•°ï¼ˆè¿™ä¸ªæ–¹æ³•åŒæ ·å¯ä»¥è·å– request body ä¸­çš„ä»¥ POST æ–¹å¼å‘é€çš„è¡¨å•å‚æ•°ï¼‰ã€‚\nåœ¨urlä¸­?ä¹‹åï¼Œä»¥\u0026amp;åˆ†éš”çš„é”®å€¼å¯¹ã€‚ä»æŸç§æ„ä¹‰ä¸Šå°†è¿™äº›é”®å€¼å¯¹ä¸è¡¨å•æ˜¯èµ·åˆ°ç›¸åŒä½œç”¨çš„ï¼Œåªæ˜¯ä¸€ä¸ªæ”¾åœ¨URLä¸­ï¼Œä¸€ä¸ªæ”¾åœ¨bodyä¸­ï¼ˆå½“ç„¶è¡¨å•getæ–¹å¼æäº¤ä¹Ÿæ˜¯æ”¾åˆ°urlä¸­ï¼‰å®ƒä»¬éƒ½å¯ä»¥ç”¨ä¸å¸¦ : çš„æ–¹å¼è·å–ã€‚\næ–¹æ³•ä¸€ï¼š //è·å–?åé¢\u0026amp;åˆ†éš”çš„å‚æ•° name2 := this.Input()[\u0026#34;name\u0026#34;] age2 := this.Input()[\u0026#34;age\u0026#34;] fmt.Printf(\u0026#34;Name2:%s Age2:%s\\n\u0026#34;, name2, age2) æ–¹æ³•äºŒï¼š //è·å–?åé¢çš„å‚æ•° keyä¸èƒ½åŠ : name3 := this.GetString(\u0026#34;name\u0026#34;) age3 := this.GetString(\u0026#34;age\u0026#34;) fmt.Printf(\u0026#34;Name3:%s Age3:%s\\n\u0026#34;, name3, age3) ç¬¬ä¸‰ç§ï¼šWeb è¡¨å• (Web form)ï¼š\nå¯ä»¥åˆ©ç”¨ beego.Controller.GetString() è·å–ï¼›å¦‚æœæ˜¯postçš„è¯·æ±‚æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å®šä¹‰å’Œè¡¨å•å¯¹åº”çš„structï¼Œç„¶åå°†this.Ctx.Input.RequestBodyè½¬æ¢ä¸ºç»“æ„ä½“å¯¹è±¡ï¼š\ntype MyStruct struct { Name string `json:\u0026#34;name\u0026#34;` Age int `json:\u0026#34;age\u0026#34;` } myStruct := MyStruct{} json.Unmarshal(this.Ctx.Input.RequestBody, \u0026amp;myStruct) 3ã€æ‰§è¡Œcurlå‘½ä»¤ï¼š\næ‰§è¡Œcurlå‘½ä»¤è°ƒæ¥å£æ—¶ï¼Œå‚æ•°ä¼ é€’éœ€è¦æ³¨æ„ï¼š\nå¦‚ï¼š\ncurl -X GET http://10.119.155.114:8081/jgjgjg/sqasdasda?name=jingge\u0026amp;age=21 -v å¦‚æœç›´æ¥å‘é€ï¼Œ\u0026amp; ä¼šè¢«ç³»ç»Ÿè§£æï¼ˆç©ºæ ¼ç­‰å­—ç¬¦ä¹Ÿä¼šè¢«ç³»ç»Ÿè§£æï¼‰\néœ€å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ã€‚ä¸Šé¢çš„å‘½ä»¤å¯ä»¥ä¿®æ”¹ä¸ºï¼š\ncurl -X GET http://10.119.155.114:8081/jgjgjg/sqasdasda?name=jingge\u0026amp;age=21 -v åœ¨ \u0026amp; å‰åŠ è½¬ä¹‰ç¬¦ \\ ï¼ˆ ç©ºæ ¼å¯ç”¨+æˆ–è€…%20å–ä»£ ï¼‰\næˆ–è€…ç»™ url åŠ åŒå¼•å·ï¼Œå¦‚ï¼š\ncurl -X GET \u0026#34;http://10.119.155.114:8081/jgjgjg/sqasdasda?name=jingge\u0026amp;age=21\u0026#34; -v æ³¨æ„ï¼š\næˆ‘æµ‹è¯•è¿‡ï¼Œåœ¨windowsä¸Šç”¨%26ä»£æ›¿\u0026amp;ï¼Œéƒ½ä¼šå¯¼è‡´nameå–åˆ°jingge\u0026amp;age=21æ•´ä½“ï¼Œè€Œageå–ä¸åˆ°å€¼ï¼Œç”¨ \\ è½¬ä¹‰ä¼šå¯¼è‡´nameå–åˆ°jingge\\ï¼Œè€Œageå–ä¸åˆ°å€¼ï¼Œå¦‚ä¸‹å›¾ï¼š\n%26ä»£æ›¿\u0026amp;ï¼š\n\\ è½¬ä¹‰\u0026amp;ï¼š\nå”¯ä¸€å¯è¡Œçš„æ˜¯åœ¨urlä¸ŠåŠ åŒå¼•å·ï¼›\nåœ¨linuxä¸Šç”¨%26ä¹Ÿä¼šå¯¼è‡´nameå–åˆ°jingge\u0026amp;age=21æ•´ä½“ï¼Œè€Œageå–ä¸åˆ°å€¼ï¼Œä½†æ˜¯ç”¨ \\ è½¬ä¹‰å’ŒåŠ åŒå¼•å·éƒ½å¯ä»¥ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/beego%E4%B8%8Ecurl%E4%B8%89%E4%BB%B6%E4%BA%8B/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190706.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä»Šå¤©æ¥çœ‹ä¸‰ä»¶äº‹ï¼š\u003c/p\u003e","title":"beegoä¸curlä¸‰ä»¶äº‹","type":"posts"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/curl/","section":"Tags","summary":"","title":"Curl","type":"tags"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/slf4j/","section":"Tags","summary":"","title":"Slf4j","type":"tags"},{"content":" æ­£æ–‡ # æ—¥å¿—ç›¸å…³åŒ… slf4jæ‰“å°æ—¥å¿—å¿…é¡»çš„ä¸‰ä¸ªä¾èµ–åŒ…\nslf4jå‡è®¾ä½¿ç”¨log4jåšä¸ºåº•å±‚æ—¥å¿—å·¥å…·ï¼Œè¿è¡Œä»¥ä¸Šç¨‹åºéœ€è¦ä¸‰ä¸ªåŒ…ï¼š\nlog4j-1.2.xx.jarã€ slf4j-api-x.x.x.jarã€ slf4j-log4j12-x.x.x.jar \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;log4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;log4j\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.17\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.slf4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;slf4j-log4j12\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.7.21\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.slf4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;slf4j-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.7.21\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; log4j.propertiesæ–‡ä»¶é…ç½®ï¼š\n### set log levels ### log4j.rootLogger = INFO,root,stdout log4j.appender.stdout=org.apache.log4j.ConsoleAppender log4j.appender.stdout.layout=org.apache.log4j.PatternLayout log4j.appender.stdout.layout.conversionPattern=%d{yyyy-MM-dd HH:mm:ss.SSSXXX} %-5p [%t] [%C %L] %m%n log4j.appender.root.Append=true log4j.appender.root.File=${scheduleProject}logs/root.log log4j.appender.root.layout.ConversionPattern=%d{yyyy-MM-dd HH:mm:ss.SSSXXX} %-5p [%t] [%C %L] %m%n log4j.appender.root.layout=org.apache.log4j.PatternLayout log4j.appender.root.MaxBackupIndex=50 log4j.appender.root.MaxFileSize=20MB log4j.appender.root=org.apache.log4j.RollingFileAppender log4j.appender.root.zipPermission=400 log4j.appender.root.logPermission=600 web.xmlé…ç½®ï¼š\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-app xmlns=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd\u0026#34; version=\u0026#34;3.1\u0026#34; metadata-complete=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;display-name\u0026gt;Archetype Created Web Application\u0026lt;/display-name\u0026gt; \u0026lt;!-- åŠ è½½log4jçš„é…ç½®æ–‡ä»¶log4j.properties --\u0026gt; \u0026lt;context-param\u0026gt; \u0026lt;param-name\u0026gt;log4jConfigLocation\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;classpath:config/log4j.properties\u0026lt;/param-value\u0026gt; \u0026lt;/context-param\u0026gt; \u0026lt;!-- è®¾å®šåˆ·æ–°æ—¥å¿—é…ç½®æ–‡ä»¶çš„æ—¶é—´é—´éš”ï¼Œè¿™é‡Œè®¾ç½®ä¸º10s --\u0026gt; \u0026lt;context-param\u0026gt; \u0026lt;param-name\u0026gt;log4jRefreshInterval\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;10000\u0026lt;/param-value\u0026gt; \u0026lt;/context-param\u0026gt; \u0026lt;!--åŠ è½½Springæ¡†æ¶ä¸­çš„log4jç›‘å¬å™¨Log4jConfigListener--\u0026gt; \u0026lt;listener\u0026gt; \u0026lt;listener-class\u0026gt;org.springframework.web.util.Log4jConfigListener\u0026lt;/listener-class\u0026gt; \u0026lt;/listener\u0026gt; \u0026lt;!-- ä¸ºé¿å…é¡¹ç›®é—´å†²çªï¼Œå®šä¹‰å”¯ä¸€çš„ webAppRootKey --\u0026gt; \u0026lt;context-param\u0026gt; \u0026lt;param-name\u0026gt;webAppRootKey\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;scheduleProject\u0026lt;/param-value\u0026gt; \u0026lt;/context-param\u0026gt; \u0026lt;!-- æ³¨å†Œå­—ç¬¦é›†è¿‡æ»¤å™¨ --\u0026gt; \u0026lt;filter\u0026gt; \u0026lt;filter-name\u0026gt;characterEncodingFilter\u0026lt;/filter-name\u0026gt; \u0026lt;filter-class\u0026gt;org.springframework.web.filter.CharacterEncodingFilter\u0026lt;/filter-class\u0026gt; \u0026lt;!-- æŒ‡å®šå­—ç¬¦é›†ç¼–ç  --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;encoding\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;utf-8\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;/filter\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;characterEncodingFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/*\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;!-- æ³¨å†Œå‰ç«¯æ§åˆ¶å™¨ --\u0026gt; \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;springmvc\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;org.springframework.web.servlet.DispatcherServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;contextConfigLocation\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;classpath*:config/spring-*.xml\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;springmvc\u0026lt;/servlet-name\u0026gt; \u0026lt;!--é»˜è®¤åŒ¹é…æ‰€æœ‰çš„è¯·æ±‚--\u0026gt; \u0026lt;url-pattern\u0026gt;/\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;/web-app\u0026gt; ","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/slf4j%E6%89%93%E5%8D%B0%E6%97%A5%E5%BF%97%E5%BF%85%E9%A1%BB%E7%9A%84%E4%B8%89%E4%B8%AA%E4%BE%9D%E8%B5%96%E5%8C%85/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180329.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eæ—¥å¿—ç›¸å…³åŒ… slf4jæ‰“å°æ—¥å¿—å¿…é¡»çš„ä¸‰ä¸ªä¾èµ–åŒ…\u003cbr /\u003e\nslf4jå‡è®¾ä½¿ç”¨log4jåšä¸ºåº•å±‚æ—¥å¿—å·¥å…·ï¼Œè¿è¡Œä»¥ä¸Šç¨‹åºéœ€è¦ä¸‰ä¸ªåŒ…ï¼š\u003c/p\u003e","title":"slf4jæ‰“å°æ—¥å¿—å¿…é¡»çš„ä¸‰ä¸ªä¾èµ–åŒ…","type":"posts"},{"content":" æ­£æ–‡ # å®‰è£…MySqlé•œåƒ # \u0026gt; docker search mysql #æŸ¥æ‰¾MySqlé•œåƒç‰ˆæœ¬ \u0026gt; docker pull mysql:tag #å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„mysqlé•œåƒï¼Œtagä¸ºç‰ˆæœ¬å· ä¾‹å¦‚ï¼š\n\u0026gt; docker pull mysql:5.6 #å®‰è£…MySql 5.6ç‰ˆæœ¬é•œåƒ å¯åŠ¨MySqlå®¹å™¨ # \u0026gt; docker run --name some-mysql -e MYSQL_ROOT_PASSWORD=my-secret-pw -d mysql:tag ä¾‹å¦‚ï¼š\n\u0026gt; docker run --name test-mysql -e MYSQL_ROOT_PASSWORD=123456 -d -p 3306:3306 mysql:5.6 #å¯åŠ¨mysql 5.6ç‰ˆæœ¬é•œåƒå®¹å™¨ï¼Œé€šè¿‡--nameå–åtest-mysqlï¼Œè®¾ç½®rootç”¨æˆ·å¯†ç ä¸º123456ï¼Œæ˜ å°„hostçš„3306ç«¯å£è®¿é—®mysql ä»hostè¿æ¥ä¸Šè¿°å¯åŠ¨çš„container # \u0026gt; ifconfig #æŸ¥çœ‹ä¸‹dockerè™šæ‹Ÿå‡ºçš„ipåœ°å€ \u0026gt; docker ps -a #æŸ¥çœ‹ä¸‹å®¹å™¨çš„è¿è¡ŒçŠ¶æ€ \u0026gt; mysql -h {ip} -P {port} -u root -p #ä»hostè¿æ¥dockerä¸­çš„MySql ä¾‹å¦‚ï¼š\n\u0026gt; mysql -h 192.168.0.1 -P 3306 -u root -p å¦‚æœå¯ä»¥è¿›å…¥mysqlå‘½ä»¤ç»ˆç«¯ï¼Œåˆ™è¡¨ç¤ºä¸€åˆ‡å®‰è£…é…ç½®æˆåŠŸã€‚\nå¦‚æœè¦ç”¨è¿œç¨‹ç”¨Navicatè¿æ¥mysqlï¼š\nåˆ›å»ºhoneyç”¨æˆ·ï¼Œå¯†ç ä¹Ÿä¸ºhoney\ncreate user\u0026#39;honey\u0026#39;@\u0026#39;%\u0026#39;identified by\u0026#39;honey\u0026#39;; æŸ¥çœ‹ç”¨æˆ·honeyçš„æƒé™\nshow grants for \u0026#39;honey\u0026#39;@\u0026#39;%\u0026#39;; åˆ›å»ºæ•°æ®åº“ï¼Œhoneyç”¨æˆ·åªæœ‰æ“ä½œmuseum_of_artæ•°æ®åº“çš„æƒé™ã€‚\ncreate database museum_of_art; å…è®¸ç”¨æˆ·honeyæ“ä½œmuseum_of_artè¡¨\ngrant all on museum_of_art.* to\u0026#39;honey\u0026#39;@\u0026#39;%\u0026#39;; å¼€æœ€å¤§æƒé™ï¼š\nGRANT ALL PRIVILEGES ON *.* TO \u0026#39;honey\u0026#39;@\u0026#39;localhost\u0026#39; IDENTIFIED BY \u0026#39;honey\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;honey\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;honey\u0026#39;; ä½†è¿™é‡Œæœ‰ä¸ªé—®é¢˜å¦‚æœè¦å…¬ç½‘è®¿é—®çš„è¯è¦æ³¨æ„å‡ ä¸ªç‚¹ã€‚é¦–å…ˆæ˜¯dockerç‰ˆæœ¬é—®é¢˜ï¼Œæˆ‘è¿™é‡Œå®‰è£…çš„æ˜¯1.13.1 docker ï¼Œé‚£ä¹ˆä¸éœ€è¦å†å»å¼€å¯httpè¿œç¨‹è®¿é—®ï¼Œé»˜è®¤æ˜¯å¯ä»¥è®¿é—®çš„ã€‚\nç°åœ¨å¦‚æœç”¨åœ¨å…¬ç½‘ä¸Šç”¨Navicat æ˜¯é“¾æ¥ä¸ä¸Šçš„ã€‚\nåŸå› å¦‚ä¸‹ï¼š\né¦–å…ˆéœ€è¦ç™»é™†é˜¿é‡Œäº‘åå°ï¼Œæ·»åŠ é˜¿é‡Œäº‘å®‰å…¨ç»„ç­–ç•¥ å…·ä½“ä½ç½®\u0026ndash;ç½‘ç»œå’Œå®‰å…¨\u0026ndash;å®‰å…¨ç»„\u0026ndash;é…ç½®è§„åˆ™\nå¯ä»¥é€‰æ‹©å¤šé…ç½®ä½ éœ€è¦çš„ç«¯å£ã€‚\nä¸‹é¢æˆ‘ä»¬éœ€è¦é…ç½®é˜¿é‡Œäº‘é˜²ç«å¢™\næŸ¥çœ‹ä¸‹é˜²ç«å¢™çš„çŠ¶æ€ï¼š systemctl status firewalld å…³é—­é˜²ç«å¢™ï¼š systemctl stop firewalld å…¶å®è¿™æ ·å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œä½†æ˜¯è¿™æ ·æ˜¯å¾ˆä¸å®‰å…¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†firewallæœåŠ¡ç¦ç”¨ï¼Œåº”ç”¨iptablesæœåŠ¡ï¼ˆç½‘ä¸Šå¤§éƒ¨åˆ†å¯ç”¨ç«¯å£çš„èµ„æ–™éƒ½æ˜¯åŸºäºiptablesæœåŠ¡ï¼‰ã€‚\nå®‰è£…iptables # ç”±äºæ²¡æœ‰é˜²ç«å¢™ä¼šé€ æˆä¸å®‰å…¨ï¼Œæ‰€ä»¥ç»™æœåŠ¡å™¨å®‰è£…ä¸€åº”ç”¨æ›´å¹¿çš„é˜²ç«å¢™iptablesï¼Œé¦–å…ˆè¦ç¦ç”¨firewallï¼Œé€šè¿‡yumå®‰è£…iptablesï¼š\nsystemctil disable firewalld yum install -y iptables-services å¯åŠ¨iptables # systemctl start iptables å¯åŠ¨åå¯ä»¥é€šè¿‡systemctl status iptablesæŸ¥çœ‹çŠ¶æ€ã€‚\næ›´æ”¹iptablesè§„åˆ™ # å°†iptablesæ–‡ä»¶å¤‡ä»½ä¸‹ï¼š cp -a /etc/sysconfig/iptables /etc/sysconfig/iptables.bak è®¾ç½® INPUT æ–¹å‘æ‰€æœ‰çš„è¯·æ±‚éƒ½æ‹’ç» iptables -P INPUT DROP æ”¾å¼€æ‰€éœ€ç«¯å£ iptables -I INPUT -p tcp --dport 3306 -m state --state NEW -j ACCEPT ä¿å­˜è§„åˆ™ iptables-save \u0026gt; /etc/sysconfig/iptables è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨å¹¶ä¸”é‡å¯ systemctl enable iptables.service systemctl reboot å¥½äº†ï¼Œç³»ç»Ÿåˆ°è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡æ–°å»å¯åŠ¨docker\nsystemctl start docker #è¿è¡ŒDockerå®ˆæŠ¤è¿›ç¨‹ è¿™é‡Œå¦‚æœç›´æ¥å¯åŠ¨é•œåƒçš„è¯ä¼šæŠ¥è¿™ä¸ªé”™è¯¯\né‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦é‡å¯ä¸‹docker ,å†å»å¼€å¯ä½ çš„å®¹å™¨å°±OKäº†\nsystemctl restart docker é‚£ä¹ˆåˆ°è¿™é‡Œæˆ‘ä»¬å¤–ç½‘å°±å¯ä»¥æ­£å¸¸çš„å»ä½¿ç”¨é˜¿é‡Œäº‘è¿™é‡Œçš„mysqlæœåŠ¡\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/mysql%E9%95%9C%E5%83%8F%E5%AE%89%E8%A3%85/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20181021.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003chr /\u003e\n\n\u003ch2 class=\"relative group\"\u003eå®‰è£…MySqlé•œåƒ \n    \u003cdiv id=\"å®‰è£…mysqlé•œåƒ\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e5%ae%89%e8%a3%85mysql%e9%95%9c%e5%83%8f\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e\u0026gt; docker search mysql #æŸ¥æ‰¾MySqlé•œåƒç‰ˆæœ¬\n\u0026gt; docker pull mysql:tag #å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„mysqlé•œåƒï¼Œtagä¸ºç‰ˆæœ¬å·\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eä¾‹å¦‚ï¼š\u003c/p\u003e","title":"MySqlé•œåƒå®‰è£…","type":"posts"},{"content":" æ­£æ–‡ # class FatherClass{ public FatherClass(){ System.out.println(\u0026#34;çˆ¶ç±» æ— å‚ æ„é€ å‡½æ•°\u0026#34;); } public FatherClass(int i){ System.out.println(\u0026#34;çˆ¶ç±» ä¸€ä¸ªå‚æ•°æ„é€ å‡½æ•°super = \u0026#34;+i); } public FatherClass(int i,String j){ System.out.println(\u0026#34;çˆ¶ç±» ä¸€ä¸ªå‚æ•°æ„é€ å‡½æ•°superi = \u0026#34;+i+\u0026#34;,superj = \u0026#34;+j); } } class SonClass extends FatherClass{ public SonClass(){ // super(22);//line 1 System.out.println(\u0026#34;å­ç±» æ— å‚ æ„é€ å‡½æ•°\u0026#34;); } public SonClass(int a){ super(33,\u0026#34;Hello\u0026#34;);//line 2 System.out.println(\u0026#34;å­ç±»ä¸€ä¸ªå‚æ•°æ„é€ å‡½æ•°sub = \u0026#34;+a); } public void fun(int a){//å­ç±»ä¸­å®šä¹‰ä¸€ä¸ªå®ä¾‹å‡½æ•° //super(33,\u0026#34;Hello\u0026#34;);//æ„é€ å‡½æ•°è°ƒç”¨å¿…é¡»å£°æ˜åœ¨æ„é€ å‡½æ•°ä¸­,è¿™è¡Œä»£ç ä¸æ³¨é‡Šçš„è¯ä¼šæŠ¥é”™ System.out.println(\u0026#34;å­ç±»ä¸€ä¸ªå‚æ•°æ„é€ å‡½æ•°sub = \u0026#34;+a); } } public class ConstructorExtend {//æµ‹è¯•å­ç±»ç»§æ‰¿çˆ¶ç±»çš„æ„é€ å‡½æ•° public static void main(String args[]){ // FatherClass fa = new FatherClass(); // FatherClass fa1 = new FatherClass(100); // SonClass son = new SonClass(); SonClass son1 = new SonClass(200); son1.fun(2); } } å­ç±» è°ƒç”¨ çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼šï¼ˆæ„é€ å‡½æ•°ä¸ä¼šè¢«ç»§æ‰¿ï¼Œåªæ˜¯è¢«å­ç±»è°ƒç”¨è€Œå·²ï¼‰\n1ã€å­ç±»æ‰€æœ‰çš„ æ„é€ å‡½æ•° é»˜è®¤è°ƒç”¨çˆ¶ç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼ˆå…¶å®æ˜¯é»˜è®¤çœç•¥æ‰äº†ä¸€è¡Œä»£ç ï¼šsuper();ï¼‰;çœç•¥æ‰çš„è¿™è¡Œsuper()ä»£ç å¯ä»¥è‡ªè¡Œæ·»åŠ åˆ°æ„é€ å‡½æ•°çš„ç¬¬ä¸€è¡Œï¼ˆå¿…é¡»æ˜¯ç¬¬ä¸€è¡Œï¼Œå¦åˆ™æŠ¥é”™ï¼‰\n2ã€å¦‚æœçˆ¶ç±»æ²¡æœ‰å®šä¹‰æ„é€ å‡½æ•°ï¼Œç³»ç»Ÿä¼šé»˜è®¤å®šä¹‰ä¸€ä¸ªæ— å‚æ— è¿”å›å€¼çš„æ„é€ å‡½æ•°ï¼Œå­ç±»ç»§æ‰¿æ—¶æ— éœ€ï¼ˆæ— éœ€çš„æ„æ€æ˜¯ï¼šå¯ä»¥å†™å¯ä»¥ä¸å†™ï¼‰åœ¨å­ç±»æ„é€ å‡½æ•°ä¸­æ˜¾å¼è°ƒç”¨super( )ï¼›å¦‚æœçˆ¶ç±»å®šä¹‰äº†æœ‰å‚æ„é€ å‡½æ•°ï¼Œæ­¤æ—¶å­ç±»çš„æ„é€ å‡½æ•°ä¸­ç¬¬ä¸€è¡Œå¿…é¡»æ˜¾å¼è°ƒç”¨çˆ¶ç±»å®šä¹‰çš„æŸä¸ªæœ‰å‚æ•°æ„é€ å‡½æ•°ã€‚å³ï¼Œæ˜¾å¼è°ƒç”¨å¯¹åº”çš„å‚æ•°ä¸ªæ•°ã€å¯¹åº”å‚æ•°ç±»å‹ä¸æ­¤super( [arg0][,arg1]â€¦. )çš„çˆ¶ç±»æ„é€ å‡½æ•°ã€‚\n3ã€å¦‚æœå­ç±»çš„æŸä¸ªæ„é€ å‡½æ•° æƒ³ è°ƒç”¨çˆ¶ç±»çš„å…¶ä»–çš„å¸¦å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œåœ¨æ„é€ å‡½æ•°çš„ç¬¬ä¸€è¡Œäººä¸ºæ·»åŠ  super(val1,val2[,val3â€¦]),super()æ‹¬å·ä¸­çš„å˜é‡æ•°é‡ç”±æƒ³è°ƒç”¨çš„çˆ¶ç±»çš„æ„é€ å‡½æ•°ä¸­çš„å˜é‡æ•°é‡å†³å®šã€‚å¦‚ä»£ç ä¸­çš„line 2ï¼Œè°ƒç”¨çš„æ˜¯çˆ¶ç±»æ„é€ å‡½æ•°ä¸­ä¸¤ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆSuper(20,â€Helloâ€)å°±ä¸¤ä¸ªå˜é‡ã€‚\n4ã€è‡ªè¡Œæ·»åŠ super(val1,val2,â€¦),å°±å¯ä»¥æŒ‡å®šè°ƒç”¨çˆ¶ç±»çš„é‚£ä¸ªå‚æ•°ç±»å‹å’Œæ•°é‡ä¸€è‡´çš„æ„é€ å‡½æ•°ã€‚ä¹‹ååœ¨æ­¤å­ç±»æ„é€ å‡½æ•°ä¸­ï¼Œç³»ç»Ÿä¸ä¼šå†é»˜è®¤è°ƒç”¨çˆ¶ç±»æ— å‚æ„é€ å‡½æ•°ï¼›\n5ã€å¦‚æœå­ç±»çš„æ¯ä¸ªæ„é€ å‡½æ•°éƒ½è‡ªè¡Œæ·»åŠ super([val1,]â€¦.),é™¤éäººä¸ºè°ƒç”¨çˆ¶ç±»æ— å‚æ„é€ å‡½æ•°ï¼Œå¦åˆ™çš„è¯çˆ¶ç±»çš„æ— å‚æ„é€ å‡½æ•°å¯ä»¥ä¸å†™ã€‚æœ‰superæŒ‡å®šè°ƒç”¨çš„çˆ¶ç±»æ„é€ å‡½æ•°å­˜åœ¨å³å¯\n6ã€superæŒ‡ä»£çˆ¶ç±»å¯¹è±¡ï¼Œå¯ä»¥åœ¨å­ç±»ä¸­ä½¿ç”¨ super.çˆ¶ç±»æ–¹æ³•å(); è°ƒç”¨çˆ¶ç±»ä¸­çš„æ–¹æ³•ï¼ˆæ— è®ºæ˜¯ç±»æ–¹æ³•è¿˜æ˜¯å®ä¾‹æ–¹æ³•éƒ½å¯ä»¥)ï¼Œæ­¤å¤–è°ƒç”¨å®ä¾‹æ–¹æ³•è¿˜å¯ä»¥åœ¨æ–¹æ³•å†…éƒ¨å®ä¾‹åŒ–å†è°ƒç”¨\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/java%E5%AD%90%E7%B1%BB%E8%B0%83%E7%94%A8%E7%88%B6%E7%B1%BB%E6%9E%84%E9%80%A0%E5%99%A8%E5%87%BD%E6%95%B0/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-java\" data-lang=\"java\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFatherClass\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eFatherClass\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;çˆ¶ç±» æ— å‚ æ„é€ å‡½æ•°\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eFatherClass\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;çˆ¶ç±» ä¸€ä¸ªå‚æ•°æ„é€ å‡½æ•°super = \u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eFatherClass\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;çˆ¶ç±» ä¸€ä¸ªå‚æ•°æ„é€ å‡½æ•°superi = \u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;,superj = \u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSonClass\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eextends\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eFatherClass\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eSonClass\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e//      super(22);//line 1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;å­ç±» æ— å‚ æ„é€ å‡½æ•°\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003eSonClass\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"kd\"\u003esuper\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e33\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//line 2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;å­ç±»ä¸€ä¸ªå‚æ•°æ„é€ å‡½æ•°sub = \u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003efun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\u003cspan class=\"c1\"\u003e//å­ç±»ä¸­å®šä¹‰ä¸€ä¸ªå®ä¾‹å‡½æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"c1\"\u003e//super(33,\u0026#34;Hello\u0026#34;);//æ„é€ å‡½æ•°è°ƒç”¨å¿…é¡»å£°æ˜åœ¨æ„é€ å‡½æ•°ä¸­,è¿™è¡Œä»£ç ä¸æ³¨é‡Šçš„è¯ä¼šæŠ¥é”™\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e        \u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;å­ç±»ä¸€ä¸ªå‚æ•°æ„é€ å‡½æ•°sub = \u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eConstructorExtend\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"c1\"\u003e//æµ‹è¯•å­ç±»ç»§æ‰¿çˆ¶ç±»çš„æ„é€ å‡½æ•°\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kd\"\u003estatic\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e//  FatherClass fa = new FatherClass();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e//  FatherClass fa1 = new FatherClass(100);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e//  SonClass son = new SonClass();\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eSonClass\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eson1\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eSonClass\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eson1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003efun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå­ç±» è°ƒç”¨ çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼šï¼ˆæ„é€ å‡½æ•°ä¸ä¼šè¢«ç»§æ‰¿ï¼Œåªæ˜¯è¢«å­ç±»è°ƒç”¨è€Œå·²ï¼‰\u003c/p\u003e","title":"javaå­ç±»è°ƒç”¨çˆ¶ç±»æ„é€ å™¨å‡½æ•°","type":"posts"},{"content":" æ­£æ–‡ # è¦æ±‚åœ¨é¡µé¢æŸ¥è¯¢åˆ°5000æ¡æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿æ’å…¥ï¼Œç”¨shellè„šæœ¬å†™curlå‘½ä»¤è°ƒç”¨è‡ªå·±å†™çš„ä»£ç æ¥å£ï¼›\nè„šæœ¬å¦‚ä¸‹ï¼š\n#!/bin/bash a=0 while [ $a -le 10 ]; do # length of ts is 13 required,Through the following way like this ts=`date +%s%N` ts=${ts:0:13} json=\u0026#39;{\u0026#34;name\u0026#34; : \u0026#34;\u0026#39;$1$a\u0026#39;\u0026#34;, \u0026#34;age\u0026#34; : \u0026#39;$2\u0026#39;, \u0026#34;ts\u0026#34; : \u0026#39;$ts\u0026#39;}\u0026#39; a=$((a+1)) curl -k -H \u0026#39;Content-Type:application/json;charset=utf-8\u0026#39; http://192.168.2.5:8080 -X POST -d \u0026#34;\u0026#39;$json\u0026#39;\u0026#34; done æ‰§è¡Œè„šæœ¬\nsh batch_curl.sh gege 21\næ‰§è¡Œç»“æœ\nè¯¥æ¥å£æ˜¯ç”¨goè¯­è¨€æä¾›çš„demoæ¥å£ï¼šå¦‚ä¸‹ï¼š\nç›®å½•ç»“æ„ï¼š\napp.conf copyrequestbody = true controller.go package controller import ( \u0026#34;github.com/astaxie/beego\u0026#34; \u0026#34;fmt\u0026#34; ) type SayHelloController struct { beego.Controller } func (this *SayHelloController) SayHello(){ fmt.Println(\u0026#34;RequestBody is \u0026#34;, string(this.Ctx.Input.RequestBody)) this.Ctx.Output.Header(\u0026#34;Content-type\u0026#34;, \u0026#34;application/json;charset=utf-8\u0026#34;) this.Ctx.Output.SetStatus(200) this.Ctx.Output.Body(this.Ctx.Input.RequestBody) } router.go package router import ( \u0026#34;github.com/astaxie/beego\u0026#34; \u0026#34;sayHello/controller\u0026#34; ) var hello = controller.SayHelloController{} func init() { beego.Router(\u0026#34;/\u0026#34;, \u0026amp;hello, \u0026#34;POST:SayHello\u0026#34;) } main.go package main import ( \u0026#34;github.com/astaxie/beego\u0026#34; _ \u0026#34;sayHello/router\u0026#34; \u0026#34;fmt\u0026#34; ) func main() { fmt.Println(beego.BConfig.CopyRequestBody) beego.Run() } ","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/shell%E8%84%9A%E6%9C%AC%E6%89%B9%E9%87%8F%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190405.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eâ€ƒâ€ƒè¦æ±‚åœ¨é¡µé¢æŸ¥è¯¢åˆ°5000æ¡æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿æ’å…¥ï¼Œç”¨shellè„šæœ¬å†™curlå‘½ä»¤è°ƒç”¨è‡ªå·±å†™çš„ä»£ç æ¥å£ï¼›\u003c/strong\u003e\u003c/p\u003e","title":"shellè„šæœ¬æ‰¹é‡è°ƒç”¨æ¥å£","type":"posts"},{"content":" æ­£æ–‡ # å®‰è£…goåï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šè®¾ç½®å¥½GOROOTå’ŒGOPATHç¯å¢ƒå˜é‡ï¼Œä½†æ˜¯æœ‰æ—¶å€™å› ä¸ºå®é™…å·¥ä½œä¸­é¡¹ç›®ç»“æ„å¤æ‚ï¼Œè®¾ç½®çš„GOPATHä¸èƒ½æ»¡è¶³éœ€è¦æ—¶ï¼Œå¯ä»¥åœ¨cmdè®¾ç½®ä¸´æ—¶çš„GOPATHï¼›å¾ˆå¤šIDEï¼Œæ¯”å¦‚IDEAä¹Ÿå¯ä»¥è®¾ç½®å…¨å±€çš„GOPATHå’Œä¸´æ—¶çš„GOPATHï¼Œä½†æ˜¯ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶å¯èƒ½æœ‰äº›å¤æ‚æˆ–è€…é€šè¿‡IDEç¼–è¯‘æˆ–è€…è¿è¡Œä¼šå‡ºç°app.confé…ç½®æ–‡ä»¶åŠ è½½ä¸åˆ°çš„æƒ…å†µï¼Œè¿™ä¸ªå‘æˆ‘é‡åˆ°è¿‡ã€‚è¯·çœ‹https://github.com/astaxie/beego/issues/1831\næ•…é€šè¿‡å‘½ä»¤çš„æ–¹å¼ç”Ÿæˆgoçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚\næ¯”å¦‚é¡¹ç›®ç»“æ„æ˜¯è¿™æ ·ï¼š\nç”±äºä¾èµ–äº†github.comé‡Œçš„beegoï¼Œæ‰€ä»¥è¦åŠ github.comçš„ä¸Šçº§ç›®å½•åˆ°GOPATHã€‚\n1. æ‰“å¼€cmdå‘½ä»¤çª—å£ï¼Œç”¨å‘½ä»¤è®¾ç½®è¦ç¼–è¯‘åŒ…ä»¥åŠä¾èµ–åŒ…æ‰€åœ¨è·¯å¾„çš„ç¯å¢ƒå˜é‡ï¼Œå³GOPATH(è¯¥è®¾ç½®åªå¯¹è¯¥çª—å£ç”Ÿæ•ˆ): # set GOPATH=E:\\ProgrammerRoute\\Go\\Development\\\n2.ç„¶åè®¾ç½®æ“ä½œç³»ç»Ÿï¼š # ç”Ÿæˆwindowsçš„å¯æ‰§è¡Œæ–‡ä»¶: set GOOS=windows\nç”Ÿæˆlinuxçš„å¯æ‰§è¡Œæ–‡ä»¶: set GOOS=linux\n3.ç„¶ååœ¨srcç›®å½•ä¸‹æ‰§è¡Œgo install # go install sayHello\næ²¡æœ‰æŠ¥é”™çš„è¯ï¼Œä¼šåœ¨GOPATHä¸‹ç”Ÿæˆbinå’Œpkgç›®å½•ï¼Œå¯æ‰§è¡Œæ–‡ä»¶åœ¨binç›®å½•ä¸‹ï¼Œå¦‚å›¾ï¼š\næ³¨ï¼š\nbeego1.7.0å‰çš„ç‰ˆæœ¬app.confé‡Œçš„é…ç½®åŠ è½½ä¸åˆ°ï¼Œä»¥ä¸‹çš„githubæœ‰issueå¯å¯»ï¼š\nhttps://github.com/astaxie/beego/issues/1831\nåˆ©ç”¨beego1.7.0ä¹‹åçš„ç‰ˆæœ¬ï¼Œç”¨IDEè¿è¡Œgoå·¥ç¨‹ä¹ŸåŠ è½½ä¸åˆ°app.confçš„é…ç½®ï¼Œåˆ©ç”¨go installä¹ŸåŠ è½½ä¸åˆ°ï¼›\nç”¨go run main.goå¯ä»¥åŠ è½½app.confï¼Œç”¨beeå·¥å…·ä¹Ÿå¯ä»¥åŠ è½½åˆ°ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/go%E8%AF%AD%E8%A8%80%E7%94%9F%E6%88%90%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6/","section":"Posts","summary":"\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eå®‰è£…goåï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šè®¾ç½®å¥½GOROOTå’ŒGOPATHç¯å¢ƒå˜é‡ï¼Œä½†æ˜¯æœ‰æ—¶å€™å› ä¸ºå®é™…å·¥ä½œä¸­é¡¹ç›®ç»“æ„å¤æ‚ï¼Œè®¾ç½®çš„GOPATHä¸èƒ½æ»¡è¶³éœ€è¦æ—¶ï¼Œå¯ä»¥åœ¨cmdè®¾ç½®ä¸´æ—¶çš„GOPATHï¼›å¾ˆå¤šIDEï¼Œæ¯”å¦‚IDEAä¹Ÿå¯ä»¥è®¾ç½®å…¨å±€çš„GOPATHå’Œä¸´æ—¶çš„GOPATHï¼Œä½†æ˜¯ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶å¯èƒ½æœ‰äº›å¤æ‚æˆ–è€…é€šè¿‡IDEç¼–è¯‘æˆ–è€…è¿è¡Œä¼šå‡ºç°app.confé…ç½®æ–‡ä»¶åŠ è½½ä¸åˆ°çš„æƒ…å†µï¼Œè¿™ä¸ªå‘æˆ‘é‡åˆ°è¿‡ã€‚è¯·çœ‹https://github.com/astaxie/beego/issues/1831\u003cbr /\u003e\næ•…é€šè¿‡å‘½ä»¤çš„æ–¹å¼ç”Ÿæˆgoçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚\u003c/p\u003e","title":"goè¯­è¨€ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶","type":"posts"},{"content":" æ­£æ–‡ # 1.â€ƒVM8 ä½¿ç”¨å›ºå®šIPï¼š\n2.â€ƒè¿™é‡Œä½¿ç”¨NATæ¨¡å¼ï¼š\n3.â€ƒVMä¸­ä¾æ¬¡ï¼šç¼–è¾‘â€”â€”\u0026gt;è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨ï¼Œç‚¹VMnet8 æŠŠä½¿ç”¨æœ¬\nåœ°DHCPçš„å‹¾å»æ‰ï¼Œå­ç½‘IPå’Œä¸»æœºVM8çš„IPåŒç½‘æ®µï¼Œç„¶åç‚¹NATè®¾ç½®ã€‚\nç½‘å…³IPå’Œåˆšæ‰çš„IPä¹Ÿæ˜¯åŒä¸€ä¸ªç½‘æ®µã€‚ # 4.â€ƒvim /etc/sysconfig/network-scripts/ifcfg-eno16777736\nå¢åŠ è¿™äº›ï¼š TYPE=Ethernet BOOTPROTO=static DEFROUTE=yes IPV4_FAILURE_FATAL=no IPV6INIT=yes IPV6_AUTOCONF=yes IPV6_DEFROUTE=yes IPV6_FAILURE_FATAL=no NAME=eno16777736 UUID=0e2e0e3d-eaaf-4810-9c6a-dda5ebe0ac9c ONBOOT=yes IPADDR0=192.168.2.5 GATEWAY0=192.168.2.2 PREFIX0=24 DNS1=192.168.2.2 HWADDR=00:0C:29:1D:3A:DF PEERDNS=yes PEERROUTES=yes IPV6_PEERDNS=yes IPV6_PEERROUTES=yes 5.â€ƒä¿®æ”¹å®Œä»¥åé‡å¯network\nsystemctl restart network\næˆ–è€…ç”¨:\nservice network restart\n###æ³¨æ„ï¼š\næƒ³è¦ä¸Šç½‘ï¼Œå³ping www.baidu.comä¸é€šæ—¶ï¼Œ\nè¦å°†/etc/sysconfig/network-scripts/ifcfg-eno16777736ä¸­çš„DNS1å’ŒGATEWAY1è®¾ç½®ä¸ºä¸€æ ·çš„ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/linux%E9%80%9A%E8%BF%87vmware%E5%92%8C%E4%B8%BB%E6%9C%BA%E7%9B%B8%E8%BF%9E%E8%BF%9E%E6%8E%A5%E4%BA%92%E8%81%94%E7%BD%91/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20181014.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e1.â€ƒVM8 ä½¿ç”¨å›ºå®šIPï¼š\u003c/strong\u003e\u003cbr /\u003e\n\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://cdn.jsdelivr.net/gh/smallersoup/jsDelivr-cdn@main/blog/article/imgconvert-csdnimg/0c5b7b8d8f09e1491ce01376a868beda.png\" alt=\"VMnet8 IPè®¾ç½®\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e","title":"linuxé€šè¿‡VMwareå’Œä¸»æœºç›¸è¿è¿æ¥äº’è”ç½‘","type":"posts"},{"content":" æ­£æ–‡ # è¦æ±‚åœ¨é¡µé¢æŸ¥è¯¢åˆ°5000æ¡æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿æ’å…¥ï¼Œå‡†å¤‡ç”¨shellè„šæœ¬å†™curlå‘½ä»¤è°ƒç”¨è‡ªå·±å†™çš„ä»£ç æ¥å£ï¼Œä½†æ˜¯é€Ÿåº¦æ…¢ï¼Œè€Œä¸”å†™çš„æ—¶å€™é‡åˆ°ç‚¹å„¿å°é—®é¢˜ï¼Œæ•…ç”¨sqlè¯­å¥å†™äº†è¿™ä¸ªåŠŸèƒ½\nç”±äºoperationlogè¡¨ä¸­çš„tså­—æ®µä¸º13ä½çš„æ—¶é—´æˆ³ï¼Œæ‰€ä»¥é‡‡ç”¨äº†æˆªå–çš„æ–¹å¼ã€‚\nDROP TABLE IF EXISTS `operationlog`; CREATE TABLE `operationlog` ( `sn` int(11) NOT NULL AUTO_INCREMENT, `opl` varchar(8) NOT NULL, `src` varchar(32) NOT NULL, `pid` varchar(32) DEFAULT NULL, `ts` varchar(13) NOT NULL, PRIMARY KEY (`sn`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8; drop procedure if exists batchAdd; /*count1 å¾ªç¯æ¬¡æ•° oplå’Œsrcä¸ºoperationlogçš„åˆ—*/ create procedure batchAdd(in count1 int,in opl varchar(32),in src varchar(32)) begin declare a int; set a=0; while a\u0026lt;count1 do begin /*å»¶æ—¶1s*/ select sleep(1); /*è·å–æ—¶é—´æˆ³1523285555.207000,åé¢3ä½æ˜¯0,ç°åœ¨çš„éœ€æ±‚æ˜¯tsä¸º13ä½,å³å¸¦msçš„*/ select @time1:=unix_timestamp(now(3)); /*å°†1523285555.207000çš„.å»æ‰*/ select @time1:=replace(@time1, \u0026#39;.\u0026#39;, \u0026#39;\u0026#39;); /*å–1523285555207000å·¦è¾¹13ä½*/ select @time1:=left(@time1, 13); /*ç”Ÿæˆsql,è¿›è¡Œinsert*/ insert into operationlog(opl, src, pid, ts) values(opl, src, \u0026#39;1111\u0026#39;, @time1); /*aåŠ 1*/ set a = a + 1; end; end while; end; --æŸ¥çœ‹procedure show procedure status; --è°ƒç”¨è¯¥procedure call batchAdd(10, \u0026#39;INFO\u0026#39;, \u0026#39;AJG\u0026#39;); --åˆ é™¤procedure drop procedure batchAdd; create procedure batchAddå¦‚å›¾æ‰€ç¤ºï¼š # åˆ›å»ºå¥½procedureå,å¯ä»¥é€šè¿‡call batchAdd(10, \u0026lsquo;INFO\u0026rsquo;, \u0026lsquo;AJG\u0026rsquo;);æ¥è°ƒç”¨,å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š # ","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E5%88%A9%E7%94%A8procedure%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180204.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eâ€ƒâ€ƒè¦æ±‚åœ¨é¡µé¢æŸ¥è¯¢åˆ°5000æ¡æ•°æ®ï¼Œä¸ºäº†æ–¹ä¾¿æ’å…¥ï¼Œå‡†å¤‡ç”¨shellè„šæœ¬å†™curlå‘½ä»¤è°ƒç”¨è‡ªå·±å†™çš„ä»£ç æ¥å£ï¼Œä½†æ˜¯é€Ÿåº¦æ…¢ï¼Œè€Œä¸”å†™çš„æ—¶å€™é‡åˆ°ç‚¹å„¿å°é—®é¢˜ï¼Œæ•…ç”¨sqlè¯­å¥å†™äº†è¿™ä¸ªåŠŸèƒ½\u003c/strong\u003e\u003cbr /\u003e\n\u003cstrong\u003eâ€ƒâ€ƒç”±äºoperationlogè¡¨ä¸­çš„tså­—æ®µä¸º13ä½çš„æ—¶é—´æˆ³ï¼Œæ‰€ä»¥é‡‡ç”¨äº†æˆªå–çš„æ–¹å¼ã€‚\u003c/strong\u003e\u003c/p\u003e","title":"åˆ©ç”¨procedureæ‰¹é‡æ’å…¥æ•°æ®","type":"posts"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/ingress-nginx/","section":"Tags","summary":"","title":"Ingress-Nginx","type":"tags"},{"content":" åœ¨Kubernetesä¸­ï¼ŒæœåŠ¡å’ŒPodçš„IPåœ°å€ä»…å¯ä»¥åœ¨é›†ç¾¤ç½‘ç»œå†…éƒ¨ä½¿ç”¨ï¼Œå¯¹äºé›†ç¾¤å¤–çš„åº”ç”¨æ˜¯ä¸å¯è§çš„ã€‚ä¸ºäº†ä½¿å¤–éƒ¨çš„åº”ç”¨èƒ½å¤Ÿè®¿é—®é›†ç¾¤å†…çš„æœåŠ¡ï¼Œåœ¨Kubernetes ç›®å‰ æä¾›äº†ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š\nNodePort\nLoadBalancer\nIngress\næœ¬èŠ‚ä¸»è¦å°±ingresså’Œingressæ§åˆ¶å™¨ingress-nginx-controllerçš„éƒ¨ç½²ä½œç®€å•ä»‹ç»å’Œè®°å½•ã€‚\nä»¥ä¸‹ç³»ç»Ÿç»„ä»¶ç‰ˆæœ¬ï¼š\näº‘æœåŠ¡å™¨ï¼šcentosç‰ˆæœ¬7.6.1810ã€k8sç‰ˆæœ¬1.15.0ã€dockerç‰ˆæœ¬18.06.1-ceã€ingress-nginx-controllerç‰ˆæœ¬0.25.0\nIngress\nIngress ç»„æˆï¼Ÿ # å°†Nginxçš„é…ç½®æŠ½è±¡æˆä¸€ä¸ªIngresså¯¹è±¡ï¼Œæ¯æ·»åŠ ä¸€ä¸ªæ–°çš„æœåŠ¡åªéœ€å†™ä¸€ä¸ªæ–°çš„Ingressçš„yamlæ–‡ä»¶å³å¯\nå°†æ–°åŠ å…¥çš„Ingressè½¬åŒ–æˆNginxçš„é…ç½®æ–‡ä»¶å¹¶ä½¿ä¹‹ç”Ÿæ•ˆ\ningress controller\ningressæœåŠ¡\nIngress å·¥ä½œåŸç†? # ingress controlleré€šè¿‡å’Œkubernetes apiäº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ingressè§„åˆ™å˜åŒ–ï¼Œ ç„¶åè¯»å–å®ƒï¼ŒæŒ‰ç…§è‡ªå®šä¹‰çš„è§„åˆ™ï¼Œè§„åˆ™å°±æ˜¯å†™æ˜äº†å“ªä¸ªåŸŸåå¯¹åº”å“ªä¸ªserviceï¼Œç”Ÿæˆä¸€æ®µnginxé…ç½®ï¼Œ å†å†™åˆ°nginx-ingress-controllerçš„podé‡Œï¼Œè¿™ä¸ªIngress\ncontrollerçš„podé‡Œè¿è¡Œç€ä¸€ä¸ªNginxæœåŠ¡ï¼Œæ§åˆ¶å™¨ä¼šæŠŠç”Ÿæˆçš„nginxé…ç½®å†™å…¥/etc/nginx.confæ–‡ä»¶ä¸­ï¼Œ ç„¶åreloadä¸€ä¸‹ä½¿é…ç½®ç”Ÿæ•ˆã€‚ä»¥æ­¤è¾¾åˆ°åŸŸååˆ†é…ç½®å’ŒåŠ¨æ€æ›´æ–°çš„é—®é¢˜ã€‚ Ingress å¯ä»¥è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ # åŠ¨æ€é…ç½®æœåŠ¡ # å¦‚æœæŒ‰ç…§ä¼ ç»Ÿæ–¹å¼, å½“æ–°å¢åŠ ä¸€ä¸ªæœåŠ¡æ—¶, æˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨æµé‡å…¥å£åŠ ä¸€ä¸ªåå‘ä»£ç†æŒ‡å‘æˆ‘ä»¬æ–°çš„æœåŠ¡. è€Œå¦‚æœç”¨äº†Ingress, åªéœ€è¦é…ç½®å¥½è¿™ä¸ªæœåŠ¡, å½“æœåŠ¡å¯åŠ¨æ—¶, ä¼šè‡ªåŠ¨æ³¨å†Œåˆ°Ingressçš„ä¸­, ä¸éœ€è¦è€Œå¤–çš„æ“ä½œ.\nå‡å°‘ä¸å¿…è¦çš„ç«¯å£æš´éœ² # é…ç½®è¿‡k8sçš„éƒ½æ¸…æ¥š, ç¬¬ä¸€æ­¥æ˜¯è¦å…³é—­é˜²ç«å¢™çš„, ä¸»è¦åŸå› æ˜¯k8sçš„å¾ˆå¤šæœåŠ¡ä¼šä»¥NodePortæ–¹å¼æ˜ å°„å‡ºå», è¿™æ ·å°±ç›¸å½“äºç»™å®¿ä¸»æœºæ‰“äº†å¾ˆå¤šå­”, æ—¢ä¸å®‰å…¨ä¹Ÿä¸ä¼˜é›…. è€ŒIngresså¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜, é™¤äº†Ingressè‡ªèº«æœåŠ¡å¯èƒ½éœ€è¦æ˜ å°„å‡ºå», å…¶ä»–æœåŠ¡éƒ½ä¸è¦ç”¨NodePortæ–¹å¼\nIngresså½“å‰çš„å®ç°æ–¹å¼ï¼Ÿ # ingress-nginx-controller # ç›®å‰æœ€æ–°ç‰ˆæœ¬çš„ingress-nginx-controllerï¼Œç”¨luaå®ç°äº†å½“upstreamå˜åŒ–æ—¶ä¸ç”¨reloadï¼Œå¤§å¤§å‡å°‘äº†ç”Ÿäº§ç¯å¢ƒä¸­ç”±äºæœåŠ¡çš„é‡å¯ã€å‡çº§å¼•èµ·çš„IPå˜åŒ–å¯¼è‡´çš„nginx reloadã€‚\nä»¥ä¸‹å°±ingress-nginx-controllerçš„éƒ¨ç½²åšç®€å•è®°å½•ï¼š\nyamlå¦‚ä¸‹ï¼š\nkubectl apply -f {å¦‚ä¸‹æ–‡ä»¶} apiVersion: v1 kind: Namespace metadata: name: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx --- kind: ConfigMap apiVersion: v1 metadata: name: nginx-configuration namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx --- kind: ConfigMap apiVersion: v1 metadata: name: tcp-services namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx --- kind: ConfigMap apiVersion: v1 metadata: name: udp-services namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx --- apiVersion: v1 kind: ServiceAccount metadata: name: nginx-ingress-serviceaccount namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRole metadata: name: nginx-ingress-clusterrole labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx rules: - apiGroups: - \u0026#34;\u0026#34; resources: - configmaps - endpoints - nodes - pods - secrets verbs: - list - watch - apiGroups: - \u0026#34;\u0026#34; resources: - nodes verbs: - get - apiGroups: - \u0026#34;\u0026#34; resources: - services verbs: - get - list - watch - apiGroups: - \u0026#34;\u0026#34; resources: - events verbs: - create - patch - apiGroups: - \u0026#34;extensions\u0026#34; - \u0026#34;networking.k8s.io\u0026#34; resources: - ingresses verbs: - get - list - watch - apiGroups: - \u0026#34;extensions\u0026#34; - \u0026#34;networking.k8s.io\u0026#34; resources: - ingresses/status verbs: - update --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: Role metadata: name: nginx-ingress-role namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx rules: - apiGroups: - \u0026#34;\u0026#34; resources: - configmaps - pods - secrets - namespaces verbs: - get - apiGroups: - \u0026#34;\u0026#34; resources: - configmaps resourceNames: # Defaults to \u0026#34;\u0026lt;election-id\u0026gt;-\u0026lt;ingress-class\u0026gt;\u0026#34; # Here: \u0026#34;\u0026lt;ingress-controller-leader\u0026gt;-\u0026lt;nginx\u0026gt;\u0026#34; # This has to be adapted if you change either parameter # when launching the nginx-ingress-controller. - \u0026#34;ingress-controller-leader-nginx\u0026#34; verbs: - get - update - apiGroups: - \u0026#34;\u0026#34; resources: - configmaps verbs: - create - apiGroups: - \u0026#34;\u0026#34; resources: - endpoints verbs: - get --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: RoleBinding metadata: name: nginx-ingress-role-nisa-binding namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: nginx-ingress-role subjects: - kind: ServiceAccount name: nginx-ingress-serviceaccount namespace: ingress-nginx --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata: name: nginx-ingress-clusterrole-nisa-binding labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: nginx-ingress-clusterrole subjects: - kind: ServiceAccount name: nginx-ingress-serviceaccount namespace: ingress-nginx --- apiVersion: apps/v1 kind: Deployment metadata: name: nginx-ingress-controller namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx spec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx template: metadata: labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx annotations: prometheus.io/port: \u0026#34;10254\u0026#34; prometheus.io/scrape: \u0026#34;true\u0026#34; spec: serviceAccountName: nginx-ingress-serviceaccount containers: - name: nginx-ingress-controller image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0 args: - /nginx-ingress-controller - --configmap=$(POD_NAMESPACE)/nginx-configuration - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services - --udp-services-configmap=$(POD_NAMESPACE)/udp-services - --publish-service=$(POD_NAMESPACE)/ingress-nginx - --annotations-prefix=nginx.ingress.kubernetes.io securityContext: allowPrivilegeEscalation: true capabilities: drop: - ALL add: - NET_BIND_SERVICE # www-data -\u0026gt; 33 runAsUser: 33 env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace ports: - name: http containerPort: 80 - name: https containerPort: 443 livenessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 readinessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP periodSeconds: 10 successThreshold: 1 timeoutSeconds: 10 --- åœ¨å¢™å†…ä¼šæ‹‰å–ä¸åˆ°ä»¥ä¸‹é•œåƒï¼š\nquay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.25.0 å¯ä»¥ä½¿ç”¨å›½å†…é˜¿é‡Œäº‘é•œåƒï¼š\ndocker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:0.25.0 å®‰è£…åï¼Œåœ¨ingress-nginxå‘½åç©ºé—´ä¸‹å¯ä»¥çœ‹åˆ°podä¸€ç›´pendingï¼Œdescribe podæŠ¥å¦‚ä¸‹è­¦å‘Šï¼š\næŸ¥çœ‹masterèŠ‚ç‚¹é»˜è®¤åŠ äº†æ±¡ç‚¹ï¼Œä¸€èˆ¬ä¸å…è®¸podè°ƒåº¦åˆ°masterèŠ‚ç‚¹ï¼š\nå¦‚æœk8sé›†ç¾¤åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨podçš„specä¸‹è®¾ç½®å®¹å¿è¯¥æ±¡ç‚¹ï¼š\nå³ï¼š\nspec: tolerations: - effect: NoSchedule key: node-role.kubernetes.io/master å¯ä»¥çœ‹åˆ°ingress-nginx podè¢«è°ƒåº¦åˆ°masterèŠ‚ç‚¹ï¼Œä¸”å˜ä¸ºRunning\nçœ‹æ—¥å¿—æŠ¥ä»¥ä¸‹è­¦å‘Šï¼š\nW0714 13:31:04.883127 6 queue.go:130] requeuing \u0026amp;ObjectMeta{Name:sync status,GenerateName:,Namespace:,SelfLink:,UID:,ResourceVersion:,Generation:0,CreationTimestamp:0001-01-01 00:00:00 +0000 UTC,DeletionTimestamp:\u0026lt;nil\u0026gt;,DeletionGracePeriodSeconds:nil,Labels:map[string]string{},Annotations:map[string]string{},OwnerReferences:[],Finalizers:[],ClusterName:,Initializers:nil,ManagedFields:[],}, err services \u0026#34;ingress-nginx\u0026#34; not found éœ€è¦åˆ›ä¸€ä¸ªåä¸ºingress-nginxçš„serviceï¼š\nkubectl apply -f {å¦‚ä¸‹æ–‡ä»¶} kind: Service apiVersion: v1 metadata: name: ingress-nginx namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx spec: externalTrafficPolicy: Local type: LoadBalancer selector: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx ports: - name: http port: 80 targetPort: http - name: https port: 443 targetPort: https å‚è€ƒï¼š # ingress deploy\nhttps://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md\nTaintå’ŒTolerationï¼ˆæ±¡ç‚¹å’Œå®¹å¿ï¼‰\nhttps://jimmysong.io/kubernetes-handbook/concepts/taint-and-toleration.html\nk8s 1.12éƒ¨ç½²ingress-nginx\nhttps://www.jianshu.com/p/e30b06906b77\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/k8s%E4%B8%AD%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8ingressnginx%E9%83%A8%E7%BD%B2/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190422.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cp\u003eåœ¨Kubernetesä¸­ï¼ŒæœåŠ¡å’ŒPodçš„IPåœ°å€ä»…å¯ä»¥åœ¨é›†ç¾¤ç½‘ç»œå†…éƒ¨ä½¿ç”¨ï¼Œå¯¹äºé›†ç¾¤å¤–çš„åº”ç”¨æ˜¯ä¸å¯è§çš„ã€‚ä¸ºäº†ä½¿å¤–éƒ¨çš„åº”ç”¨èƒ½å¤Ÿè®¿é—®é›†ç¾¤å†…çš„æœåŠ¡ï¼Œåœ¨Kubernetes ç›®å‰ æä¾›äº†ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š\u003c/p\u003e","title":"k8sä¸­è´Ÿè½½å‡è¡¡å™¨ã€ingress-nginxã€‘éƒ¨ç½²","type":"posts"},{"content":"å‰æï¼šäºšé©¬é€Šäº‘å·²ç»é…ç½®å¥½å¯åŠ¨ã€‚\nå®‰å…¨ç»„å…¥ç«™ç­–ç•¥å¦‚ä¸‹ï¼š\nå‡ºç«™ç­–ç•¥å¦‚ä¸‹ï¼š\nç™»é™†EC2åï¼Œé»˜è®¤åªèƒ½ç”¨ec2-userç”¨æˆ·ç™»é™†ï¼Œç„¶ååˆ‡æ¢åˆ°rootï¼š\nsudo su ç”¨yumæ‰§è¡Œå®‰è£…dockeræç¤ºNo package docker avaible\nyum install docker -y è§£å†³æ–¹æ³•ï¼š\nåœ¨/etc/yum.repos.d/ä¸‹åŠ CentOS7-Base-163.repoæ–‡ä»¶ï¼š\nvi CentOS7-Base-163.repo # CentOS-Base.repo # # The mirror system uses the connecting IP address of the client and the # update status of each mirror to pick mirrors that are updated to and # geographically close to the client. You should use this for CentOS updates # unless you are manually picking other mirrors. # # If the mirrorlist= does not work for you, as a fall back you can try the # remarked out baseurl= line instead. # # [base] name=CentOS-$releasever - Base - 163.com baseurl=http://mirrors.163.com/centos/7/os/x86_64 gpgcheck=1 gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7 #released updates [updates] name=CentOS-$releasever - Updates - 163.com baseurl=http://mirrors.163.com/centos/7/updates/x86_64 gpgcheck=1 gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7 #additional packages that may be useful [extras] name=CentOS-$releasever - Extras - 163.com baseurl=http://mirrors.163.com/centos/7/extras/x86_64 gpgcheck=1 gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7 #additional packages that extend functionality of existing packages [centosplus] name=CentOS-$releasever - Plus - 163.com baseurl=http://mirrors.163.com/centos/7/centosplus/x86_64 gpgcheck=1 enabled=0 gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7 ä¿å­˜é€€å‡ºåï¼Œæ‰§è¡Œå‘½ä»¤ï¼š\nyum makecache ç„¶åæ‰§è¡Œyumå®‰è£…dockerå‘½ä»¤ï¼š\nyum install docker -y å®‰è£…å®Œåå¦‚ä¸‹å›¾ï¼š\nå¯åŠ¨dockerï¼š\n## å¯åŠ¨ docker æœåŠ¡ systemctl start docker chkconfig docker on æŸ¥çœ‹dockerç‰ˆæœ¬ï¼š\ndocker version æ‹‰å– docker é•œåƒï¼š\nå¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬ç›´æ¥æ‹‰å–åˆ«äººåšå¥½çš„ docker é•œåƒã€‚è¿™é‡Œé€‰æ‹©çš„æ˜¯ githubä¸Šçš„ shadowsock vpn docker é•œåƒï¼Œç›´æ¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\ndocker pull oddrationale/docker-shadowsocks è¿è¡Œ docker é•œåƒï¼š\nè¿è¡Œå¦‚ä¸‹å‘½ä»¤å¯åŠ¨è¯¥ docker é•œåƒã€‚\ndocker run -d -p 8001:8001 oddrationale/docker-shadowsocks -s 0.0.0.0 -p 8001 -k yourpassword-m aes-256-cfb è¿è¡Œdocker ps -aæŸ¥çœ‹å®¹å™¨æ˜¯å¦å·²æˆåŠŸè¿è¡Œèµ·æ¥äº†ã€‚\ndocker ps -a linuxä¸Šcurlå‘½ä»¤è°ƒï¼š\ncurl -k localhost:8001 windowsä¸Šcurlå‘½ä»¤è°ƒï¼š\nå›æ˜¾å¦‚ä¸Šè¯´æ˜å·²ç»éƒ¨ç½²å¥½äº†ï¼Œæ¥ä¸‹æ¥ä½ è¦å¹²ä»€ä¹ˆå°±æ˜¯ä½ çš„äº‹äº†\u0026hellip;\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BA%E6%9C%8D%E5%8A%A1/","section":"Posts","summary":"\u003cp\u003e\u003cstrong\u003eå‰æï¼šäºšé©¬é€Šäº‘å·²ç»é…ç½®å¥½å¯åŠ¨ã€‚\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®‰å…¨ç»„å…¥ç«™ç­–ç•¥å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://cdn.jsdelivr.net/gh/smallersoup/jsDelivr-cdn@main/blog/article/csdnimg/20190715082029462.png\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" /\u003e\n    \n  \u003c/figure\u003e\n\u003cbr /\u003e\nå‡ºç«™ç­–ç•¥å¦‚ä¸‹ï¼š\u003cbr /\u003e\n\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://cdn.jsdelivr.net/gh/smallersoup/jsDelivr-cdn@main/blog/article/csdnimg/20190715082044270.png\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e","title":"äº‘æœåŠ¡å™¨ä½¿ç”¨dockeræ­å»ºæœåŠ¡","type":"posts"},{"content":" Kubernetes ä¸­ä½¿ç”¨ Job å’Œ CronJob ä¸¤ä¸ªèµ„æºåˆ†åˆ«æä¾›äº†ä¸€æ¬¡æ€§ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡çš„ç‰¹æ€§ï¼Œè¿™ä¸¤ç§å¯¹è±¡ä¹Ÿä½¿ç”¨æ§åˆ¶å™¨æ¨¡å‹æ¥å®ç°èµ„æºçš„ç®¡ç†ï¼Œæˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« æ¥ä»‹ç»Jobæ‰§è¡Œå¦‚æœå¤±è´¥äº†ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ\nä¿®æ”¹job-fail.yamlï¼Œæ•…æ„å¼•å…¥ä¸€ä¸ªé”™è¯¯ï¼š\nNever # å¦‚æœå°† restartPolicy è®¾ç½®ä¸º Never ä¼šæ€ä¹ˆæ ·ï¼Ÿä¸‹é¢æˆ‘ä»¬å®è·µä¸€ä¸‹ï¼Œä¿®æ”¹job-fail.yamlåé‡æ–°å¯åŠ¨ã€‚\nè¿è¡Œ Job å¹¶æŸ¥çœ‹çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°Neverç­–ç•¥çš„jobï¼Œpodå¤±è´¥åï¼Œé‡æ–°åˆ›å»ºï¼š\nç›´åˆ°é‡æ–°åˆ›å»º7ä¸ªï¼ˆspec.backoffLimité»˜è®¤ä¸º6ï¼Œå³é‡è¯•6æ¬¡ï¼Œå…±7ä¸ªpodï¼‰podéƒ½å¤±è´¥åï¼Œè®¤ä¸ºå¤±è´¥ï¼Œjobçš„statusé‡Œä¼šæ›´æ–°ä¸ºFailed\nå½“å‰ Completion çš„æ•°é‡ä¸º 0\næŸ¥çœ‹ Pod çš„çŠ¶æ€ï¼š\nå¯ä»¥çœ‹åˆ°æœ‰å¤šä¸ª Podï¼ŒçŠ¶æ€å‡ä¸æ­£å¸¸ã€‚kubectl describe pod æŸ¥çœ‹æŸä¸ª Pod çš„å¯åŠ¨æ—¥å¿—ï¼š\næ—¥å¿—æ˜¾ç¤ºæ²¡æœ‰å¯æ‰§è¡Œç¨‹åºï¼Œç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚\nä¸ºä»€ä¹ˆ kubectl get pod ä¼šçœ‹åˆ°è¿™ä¹ˆå¤šä¸ªå¤±è´¥çš„ Podï¼Ÿ\nåŸå› æ˜¯ï¼šå½“ç¬¬ä¸€ä¸ª Pod å¯åŠ¨æ—¶ï¼Œå®¹å™¨å¤±è´¥é€€å‡ºï¼Œæ ¹æ® restartPolicy: Neverï¼Œæ­¤å¤±è´¥å®¹å™¨ä¸ä¼šè¢«é‡å¯ï¼Œä½† Job DESIRED çš„ Pod æ˜¯ 1ï¼Œç›®å‰ SUCCESSFUL ä¸º 0ï¼Œä¸æ»¡è¶³ï¼Œæ‰€ä»¥ Job controller ä¼šå¯åŠ¨æ–°çš„ Podï¼Œç›´åˆ° SUCCESSFUL ä¸º 1ã€‚å¯¹äºæˆ‘ä»¬è¿™ä¸ªä¾‹å­ï¼ŒSUCCESSFUL æ°¸è¿œä¹Ÿåˆ°ä¸äº† 1ï¼Œæ‰€ä»¥ Job controller ä¼šä¸€ç›´åˆ›å»ºæ–°çš„ Podï¼Œç›´åˆ°è®¾ç½®çš„æ•°é‡ï¼Œå¤±è´¥åpodä¸ä¼šè‡ªåŠ¨è¢«åˆ é™¤ï¼Œä¸ºäº†ç»ˆæ­¢è¿™ä¸ªè¡Œä¸ºï¼Œåªèƒ½åˆ é™¤ Jobï¼Œpodä¹Ÿä¼šè¢«åŒæ—¶åˆ æ‰ã€‚\nOnFailure # å¦‚æœå°† restartPolicy è®¾ç½®ä¸º OnFailure ä¼šæ€ä¹ˆæ ·ï¼Ÿä¸‹é¢æˆ‘ä»¬å®è·µä¸€ä¸‹ï¼Œä¿®æ”¹job-fail.yamlåé‡æ–°å¯åŠ¨ã€‚ Job çš„ Completions Pod æ•°é‡è¿˜æ˜¯ä¸º 0ï¼Œçœ‹çœ‹ Pod çš„æƒ…å†µï¼š\nè¿™é‡Œåªæœ‰ä¸€ä¸ª Podï¼Œä¸è¿‡ RESTARTS åœ¨ä¸æ–­å¢åŠ ï¼Œè¯´æ˜ OnFailure ç”Ÿæ•ˆï¼Œå®¹å™¨å¤±è´¥åä¼šè‡ªåŠ¨é‡å¯ã€‚\n6æ¬¡å¤±è´¥åï¼Œpodè¢«åˆ é™¤ï¼š\nåŒæ—¶æ›´æ–°jobçš„statusä¸ºå¤±è´¥ï¼Œæ–¹ä¾¿æŸ¥çœ‹æœ€ç»ˆæ‰§è¡Œç»“æœï¼š\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/k8s%E4%BD%BF%E7%94%A8job%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E5%A4%B1%E8%B4%A5%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180724.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cp\u003eKubernetes ä¸­ä½¿ç”¨ Job å’Œ CronJob ä¸¤ä¸ªèµ„æºåˆ†åˆ«æä¾›äº†ä¸€æ¬¡æ€§ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡çš„ç‰¹æ€§ï¼Œè¿™ä¸¤ç§å¯¹è±¡ä¹Ÿä½¿ç”¨æ§åˆ¶å™¨æ¨¡å‹æ¥å®ç°èµ„æºçš„ç®¡ç†ï¼Œæˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« æ¥ä»‹ç»Jobæ‰§è¡Œå¦‚æœå¤±è´¥äº†ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ\u003c/p\u003e","title":"k8sä½¿ç”¨Jobæ‰§è¡Œä»»åŠ¡å¤±è´¥äº†æ€ä¹ˆåŠ","type":"posts"},{"content":" æ­£æ–‡ # å‰å‡ å¤©ï¼Œåœ¨ucloudä¸Šæ­å»ºçš„k8sé›†ç¾¤ï¼ˆæ­å»ºæ•™ç¨‹åç»­ä¼šå‘å‡ºï¼‰ã€‚ä»Šå¤©å‘ç°åŸŸåè§£æä¸äº†ã€‚\nç»„ä»¶ç‰ˆæœ¬ï¼šk8s 1.15.0ï¼Œcorednsï¼š1.3.1\nè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š # é¦–å…ˆç”¨ä»¥ä¸‹yamlæ–‡ä»¶åˆ›å»ºäº†ä¸€ä¸ªnginxæœåŠ¡\napiVersion: v1 kind: Service metadata: name: nginx-svc-old labels: app: nginx-svc spec: selector: app: nginx ports: - protocol: TCP port: 80 targetPort: 80 --- apiVersion: apps/v1beta1 kind: Deployment metadata: name: nginx-old spec: replicas: 1 template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 åˆ›å»ºå¥½ä¹‹åï¼š\nå› åªéƒ¨ç½²äº†ä¸€ä¸ªmasterèŠ‚ç‚¹ã€‚åœ¨masterå®¿ä¸»æœºä¸Šç›´æ¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nnslookup nginx-svc-old.default.svc å‘ç°ä¸èƒ½è§£æåŸŸåã€‚äº‹å…ˆä¹Ÿåœ¨å®¿ä¸»æœºä¸Š/etc/resolv.confé‡Œé…ç½®äº†nameserver {corednsçš„podIP}\nè¿™æ ·ä¸€æ¥ï¼Œå°±ä»¥ä¸ºå¯èƒ½æ˜¯corednsæœ‰é—®é¢˜ã€‚ã€‚\nç„¶åç”¨ä»¥ä¸‹yamlåˆ›å»ºäº†ä¸€ä¸ªbusyboxä½œä¸ºè°ƒè¯•å·¥å…·ï¼š\napiVersion: extensions/v1beta1 kind: Deployment metadata: name: busybox-deployment spec: replicas: 1 template: metadata: labels: app: busybox spec: restartPolicy: Always containers: - name: busybox command: - sleep - \u0026#34;3600\u0026#34; image: busybox è¿™é‡Œç”¨çš„æ˜¯æˆªæ­¢2019/07/20ï¼Œbusyboxçš„æœ€æ–°é•œåƒã€‚åˆ›å»ºå¥½ä¹‹åï¼Œexecè¿›å…¥å®¹å™¨ï¼Œæ‰§è¡Œæµ‹è¯•å‘½ä»¤\nå‘ç°è§£æä¸äº†:\n/ # nslookup nginx-svc-old.default.svc Server: 10.96.0.10 Address: 10.96.0.10:53 ** server can\u0026#39;t find nginx-svc-old.default.svc: NXDOMAIN *** Can\u0026#39;t find nginx-svc-old.default.svc: No answer æ ¹æ®corednsè§£æé›†ç¾¤å†…åŸŸååŸç†å¯çŸ¥ï¼š\næœåŠ¡ a è®¿é—®æœåŠ¡ bï¼Œå¯¹äºåŒä¸€ä¸ª Namespaceä¸‹ï¼Œå¯ä»¥ç›´æ¥åœ¨ pod ä¸­ï¼Œé€šè¿‡ curl b æ¥è®¿é—®ã€‚å¯¹äºè·¨ Namespace çš„æƒ…å†µï¼ŒæœåŠ¡ååè¾¹å¯¹åº” Namespaceå³å¯ï¼Œæ¯”å¦‚ curl b.defaultã€‚DNS å¦‚ä½•è§£æï¼Œä¾èµ–å®¹å™¨å†… resolv æ–‡ä»¶çš„é…ç½®ã€‚\næŸ¥çœ‹busyboxå®¹å™¨å†…çš„resolve.confæ–‡ä»¶ï¼š\n[root@liabio nginx]# kubectl exec -ti busybox-deployment-59755c8c6d-rmrfq sh / # nslookup nginx-svc-old.default.svc Server: 10.96.0.10 Address: 10.96.0.10:53 ** server can\u0026#39;t find nginx-svc-old.default.svc: NXDOMAIN *** Can\u0026#39;t find nginx-svc-old.default.svc: No answer / # cat /etc/resolv.conf nameserver 10.96.0.10 search default.svc.cluster.local svc.cluster.local cluster.local options ndots:5 / # è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œé…ç½®çš„ DNS Serverï¼Œä¸€èˆ¬å°±æ˜¯ K8S ä¸­ï¼Œkubedns çš„ Service çš„ ClusterIPï¼Œè¿™ä¸ªIPæ˜¯è™šæ‹ŸIPï¼Œæ— æ³•pingï¼Œä½†å¯ä»¥è®¿é—®ã€‚\nåœ¨å®¹å™¨å†…å‘è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ® /etc/resolv.conf è¿›è¡Œè§£ææµç¨‹ã€‚é€‰æ‹© nameserver 10.96.0.10 è¿›è¡Œè§£æï¼Œç„¶åç”¨nginx-svc-old ï¼Œä¾æ¬¡å¸¦å…¥ /etc/resolve.conf ä¸­çš„ search åŸŸï¼Œè¿›è¡ŒDNSæŸ¥æ‰¾ï¼Œåˆ†åˆ«æ˜¯ï¼š\nsearch å†…å®¹ç±»ä¼¼å¦‚ä¸‹ï¼ˆä¸åŒçš„podï¼Œç¬¬ä¸€ä¸ªåŸŸä¼šæœ‰æ‰€ä¸åŒï¼‰\nsearch default.svc.cluster.local svc.cluster.local cluster.local nginx-svc-old.default.svc.cluster.local -\u0026gt; nginx-svc-old.svc.cluster.local -\u0026gt; nginx-svc-old.cluster.local ç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ‰§è¡Œ ping nginx-svc-oldï¼Œæˆ–è€…æ‰§è¡Œ ping nginx-svc-old.defaultï¼Œéƒ½å¯ä»¥å®ŒæˆDNSè¯·æ±‚ï¼Œè¿™2ä¸ªä¸åŒçš„æ“ä½œï¼Œä¼šåˆ†åˆ«è¿›è¡Œä¸åŒçš„DNSæŸ¥æ‰¾æ­¥éª¤ã€‚\næ ¹æ®ä»¥ä¸ŠåŸç†ï¼ŒæŸ¥çœ‹åˆ°busyboxå†…çš„åŸŸå/etc/resolv.confæ²¡æœ‰é—®é¢˜ï¼ŒnameserveræŒ‡å‘æ­£ç¡®çš„kube-dnsçš„service clusterIPã€‚\nè¿™ä¸‹æ›´åŠ æ€€ç–‘core-dnsæœ‰é—®é¢˜äº†ã€‚\nä½†æŸ¥çœ‹corednsæ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰æŠ¥é”™ï¼š\né‚£å°±è¯´æ˜ä¸æ˜¯corednsé—®é¢˜äº†ã€‚ã€‚\næŠŠbusyboxé‡ŒæŠ¥çš„é”™è¯¯ï¼Œè¿›è¡Œæœç´¢google\n*** Can\u0026#39;t find nginx-svc-old.default.svc: No answer æŸ¥åˆ°äº†ä»¥ä¸‹ä¸¤ä¸ªissueï¼š\nissues1ï¼š # https://github.com/kubernetes/kubernetes/issues/66924\nissues2ï¼š # https://github.com/easzlab/kubeasz/issues/260\nå‘ç°éƒ½è¯´æ˜¯busyboxé•œåƒçš„é—®é¢˜ï¼Œä»1.28.4ä»¥åçš„é•œåƒéƒ½å­˜åœ¨è¿™é—®é¢˜ã€‚æŠŠé•œåƒæ¢æˆ1.28.4è¯•è¯•ï¼Ÿä¿®æ”¹yamlç‰ˆæœ¬å·ï¼š\napiVersion: extensions/v1beta1 kind: Deployment metadata: name: busybox-deployment spec: replicas: 1 template: metadata: labels: app: busybox spec: restartPolicy: Always containers: - name: busybox command: - sleep - \u0026#34;3600\u0026#34; image: busybox:1.28.4 é‡æ–°applyåï¼Œè¿›å…¥å®¹å™¨ï¼š\nç¡®å®å¯ä»¥æˆåŠŸè§£æåŸŸåäº†ã€‚\né‚£ä¸ºä»€ä¹ˆå®¿ä¸»æœºä¸Šç›´æ¥æ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼ŒåŸŸåä¸èƒ½è§£æå‘¢ï¼Ÿ\nç»§ç»­googleï¼ŒçŸ¥é“resolveråŸŸåè§£æå™¨ï¼š\nnameserverå…³é”®å­—ï¼Œå¦‚æœæ²¡æŒ‡å®šnameserverå°±æ‰¾ä¸åˆ°DNSæœåŠ¡å™¨ï¼Œå…¶å®ƒå…³é”®å­—æ˜¯å¯é€‰çš„ã€‚nameserverè¡¨ç¤ºè§£æåŸŸåæ—¶ä½¿ç”¨è¯¥åœ°å€æŒ‡å®šçš„ä¸»æœºä¸ºåŸŸåæœåŠ¡å™¨ã€‚å…¶ä¸­åŸŸåæœåŠ¡å™¨æ˜¯æŒ‰ç…§æ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ¥æŸ¥è¯¢çš„ï¼Œä¸”åªæœ‰å½“ç¬¬ä¸€ä¸ªnameserveræ²¡æœ‰ååº”æ—¶æ‰æŸ¥è¯¢ä¸‹é¢çš„nameserverï¼Œä¸€èˆ¬ä¸è¦æŒ‡å®šè¶…è¿‡3ä¸ªæœåŠ¡å™¨ã€‚\nè€Œæˆ‘åœ¨å®¿ä¸»ä¸Š/etc/resolv.confä¸­nameserverå¦‚ä¸‹ï¼š\nä¸”å‰ä¸‰ä¸ªåŸŸåè§£ææœåŠ¡å™¨åå¯ä»¥é€šã€‚\nç°åœ¨è¯•ç€æŠŠcorednsçš„å…¶ä¸­ä¸€ä¸ªpodIPï¼š192.168.155.73æ”¾åˆ°ç¬¬ä¸€ä¸ªnameserverï¼š\nå¯ä»¥çœ‹åˆ°ç°åœ¨å¯ä»¥è§£æäº†ã€‚\nå…¶å®æœ€å¥½æŠŠkube-dns serviceçš„clusterIPæ”¾åˆ°/etc/resolv.confä¸­ï¼Œè¿™æ ·podé‡å¯åä¹Ÿå¯ä»¥è§£æã€‚\nå‚è€ƒ # Linuxä¸­/etc/resolv.confæ–‡ä»¶ç®€æ\nhttps://blog.csdn.net/lcr_happy/article/details/54867510\nCoreDNSç³»åˆ—1ï¼šKuberneteså†…éƒ¨åŸŸåè§£æåŸç†ã€å¼Šç«¯åŠä¼˜åŒ–æ–¹å¼\nhttps://hansedong.github.io/2018/11/20/9/\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E9%87%87%E5%9D%91%E6%8C%87%E5%8D%97k8s%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90coredns%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%BF%87%E7%A8%8B/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180826.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eå‰å‡ å¤©ï¼Œåœ¨ucloudä¸Šæ­å»ºçš„k8sé›†ç¾¤ï¼ˆæ­å»ºæ•™ç¨‹åç»­ä¼šå‘å‡ºï¼‰ã€‚ä»Šå¤©å‘ç°åŸŸåè§£æä¸äº†ã€‚\u003c/p\u003e","title":"é‡‡å‘æŒ‡å—â€”â€”k8såŸŸåè§£æcorednsé—®é¢˜æ’æŸ¥è¿‡ç¨‹","type":"posts"},{"content":" åœ¨äº‘å¹³å°å¼€å‘ã€ä¸­é—´ä»¶å®¹å™¨åŒ–æ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°æ‰¹é‡åˆ é™¤k8sèµ„æºå¯¹è±¡çš„éœ€æ±‚ï¼Œä¸‹é¢è®°å½•ä¸€ä¸‹kubectlå’Œgolangå‘é€åˆ é™¤pvcã€pvã€podè¯·æ±‚çš„ä¾‹å­ï¼Œä¾¿äºåç»­å­¦ä¹ æŸ¥é˜…\nkubectlå‘é€åˆ é™¤è¯·æ±‚ # æ ¹æ®labelæ‰¹é‡åˆ é™¤podï¼š\nkubectl delete pod -n kube-system -l \u0026#34;harmonycloud.cn/statefulset=redis-ll-1010-a\u0026#34; æ ¹æ®labelæ‰¹é‡åˆ é™¤pvcï¼š\nkubectl delete pvc -n kube-system -l \u0026#34;harmonycloud.cn/statefulset=redis-ll-1010-a\u0026#34; æ ¹æ®labelæ‰¹é‡åˆ é™¤pvï¼š\nkubectl delete pv -l \u0026#34;harmonycloud.cn/statefulset=redis-ll-1010-a\u0026#34; golangå‘é€åˆ é™¤è¯·æ±‚ # æ ¹æ®labelæ‰¹é‡åˆ é™¤pvcã€podã€pv\næ³¨æ„ï¼šå¯åŠ¨å‚æ•°ä¸­åŠ å…¥ä»¥ä¸‹å‚æ•°ï¼š\n--kubeconfig=/root/.kube/config --v=5 package operator import ( \u0026#34;flag\u0026#34; extensionsclient \u0026#34;k8s.io/apiextensions-apiserver/pkg/client/clientset/clientset\u0026#34; \u0026#34;k8s.io/apimachinery/pkg/api/errors\u0026#34; metav1 \u0026#34;k8s.io/apimachinery/pkg/apis/meta/v1\u0026#34; \u0026#34;k8s.io/apimachinery/pkg/labels\u0026#34; \u0026#34;k8s.io/apiserver/pkg/util/logs\u0026#34; clientset \u0026#34;k8s.io/client-go/kubernetes\u0026#34; restclient \u0026#34;k8s.io/client-go/rest\u0026#34; \u0026#34;k8s.io/client-go/tools/clientcmd\u0026#34; \u0026#34;k8s.io/klog\u0026#34; \u0026#34;os\u0026#34; \u0026#34;testing\u0026#34; ) type OperatorManagerServer struct { Master string Kubeconfig string } func NewOMServer() *OperatorManagerServer { s := OperatorManagerServer{} return \u0026amp;s } var s *OperatorManagerServer func init() { s = NewOMServer() flag.StringVar(\u0026amp;s.Master, \u0026#34;master\u0026#34;, s.Master, \u0026#34;The address of the Kubernetes API server (overrides any value in kubeconfig)\u0026#34;) flag.StringVar(\u0026amp;s.Kubeconfig, \u0026#34;kubeconfig\u0026#34;, s.Kubeconfig, \u0026#34;Path to kubeconfig file with authorization and master location information.\u0026#34;) //åˆå§‹åŒ–klogç­‰flag logs.InitLogs() flag.Parse() } func Test_DeleteCollection(t *testing.T) { if err := Run(s); err != nil { t.Fatalf(\u0026#34;%v\\n\u0026#34;, err) os.Exit(1) } } func Run(s *OperatorManagerServer) error { var ( generalLabelKey = \u0026#34;harmonycloud.cn/statefulset\u0026#34; redisClusterName = \u0026#34;redis-ll-1010\u0026#34; redisClusterNamespace = \u0026#34;kube-system\u0026#34; ) kubeClient, _, _, err := createClients(s) if err != nil { return err } //æ ¹æ®labelæ‰¹é‡åˆ é™¤pod labelPod := labels.SelectorFromSet(labels.Set(map[string]string{generalLabelKey: redisClusterName})) listPodOptions := metav1.ListOptions{ LabelSelector: labelPod.String(), } err = kubeClient.CoreV1().Pods(redisClusterNamespace).DeleteCollection(\u0026amp;metav1.DeleteOptions{}, listPodOptions) if err != nil { if !errors.IsNotFound(err) { klog.Errorf(\u0026#34;Drop RedisCluster: %v/%v pod error: %v\u0026#34;, redisClusterNamespace, redisClusterName, err) return err } } //æ ¹æ®labelæ‰¹é‡åˆ é™¤pvc labelPvc := labels.SelectorFromSet(labels.Set(map[string]string{\u0026#34;app\u0026#34;: redisClusterName})) listPvcOptions := metav1.ListOptions{ LabelSelector: labelPvc.String(), } err = kubeClient.CoreV1().PersistentVolumeClaims(redisClusterNamespace).DeleteCollection(\u0026amp;metav1.DeleteOptions{}, listPvcOptions) if err != nil { if !errors.IsNotFound(err) { klog.Errorf(\u0026#34;Drop RedisCluster: %v/%v pvc error: %v\u0026#34;, redisClusterNamespace, redisClusterName, err) return err } } //å¦‚æœpvæ²¡æœ‰åˆ é™¤æ‰,åˆ™åˆ é™¤ labelPv := labels.SelectorFromSet(labels.Set(map[string]string{generalLabelKey: redisClusterName})) listPvOptions := metav1.ListOptions{ LabelSelector: labelPv.String(), } err = kubeClient.CoreV1().PersistentVolumes().DeleteCollection(\u0026amp;metav1.DeleteOptions{}, listPvOptions) if err != nil { if !errors.IsNotFound(err) { klog.Errorf(\u0026#34;Drop RedisCluster: %v/%v pv error: %v\u0026#34;, redisClusterNamespace, redisClusterName, err) return err } } return nil } //æ ¹æ®kubeconfigæ–‡ä»¶åˆ›å»ºå®¢æˆ·ç«¯ func createClients(s *OperatorManagerServer) (*clientset.Clientset, *extensionsclient.Clientset, *restclient.Config, error) { kubeconfig, err := clientcmd.BuildConfigFromFlags(s.Master, s.Kubeconfig) if err != nil { return nil, nil, nil, err } kubeconfig.QPS = 100 kubeconfig.Burst = 100 kubeClient, err := clientset.NewForConfig(restclient.AddUserAgent(kubeconfig, \u0026#34;operator-manager\u0026#34;)) if err != nil { klog.Fatalf(\u0026#34;Invalid API configuration: %v\u0026#34;, err) } extensionClient, err := extensionsclient.NewForConfig(restclient.AddUserAgent(kubeconfig, \u0026#34;operator-manager\u0026#34;)) if err != nil { klog.Fatalf(\u0026#34;Invalid API configuration: %v\u0026#34;, err) } return kubeClient, extensionClient, kubeconfig, nil } client-goä¸­æä¾›çš„\nDeleteæ–¹æ³•,åªèƒ½åˆ é™¤å•ä¸ªèµ„æºå¯¹è±¡,ç¬¬ä¸€ä¸ªå‚æ•°å¾€å¾€æ˜¯èµ„æºå¯¹è±¡åç§°,ç¬¬äºŒä¸ªå‚æ•°æ˜¯åˆ é™¤é€‰é¡¹ï¼Œå¦‚ï¼šä¼˜é›…ç»ˆæ­¢æ—¶é—´GracePeriodSecondsã€åˆ é™¤ä¼ æ’­ç­–ç•¥ï¼šForegroundå‰å°åˆ é™¤ã€åå°åˆ é™¤ï¼šBackgroundã€å­¤å„¿åˆ é™¤ï¼šOrphan\nDeleteCollectionæ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆ é™¤é€‰é¡¹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯åˆ é™¤æ¡ä»¶ï¼ŒåŒ…æ‹¬label Selectorã€field Selectorç­‰\nDelete(name string, options *metav1.DeleteOptions) error DeleteCollection(options *metav1.DeleteOptions, listOptions metav1.ListOptions) error å‚è€ƒ # k8så®˜æ–¹APIæ–‡æ¡£ï¼š\nhttps://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/#delete-collection-524\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4k8s%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180630.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåœ¨äº‘å¹³å°å¼€å‘ã€ä¸­é—´ä»¶å®¹å™¨åŒ–æ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°æ‰¹é‡åˆ é™¤k8sèµ„æºå¯¹è±¡çš„éœ€æ±‚ï¼Œä¸‹é¢è®°å½•ä¸€ä¸‹kubectlå’Œgolangå‘é€åˆ é™¤pvcã€pvã€podè¯·æ±‚çš„ä¾‹å­ï¼Œä¾¿äºåç»­å­¦ä¹ æŸ¥é˜…\u003c/strong\u003e\u003c/p\u003e","title":"å¦‚ä½•æ‰¹é‡åˆ é™¤k8sèµ„æºå¯¹è±¡","type":"posts"},{"content":" æœ‰äº›å°ä¼™ä¼´å¯èƒ½ä¸çŸ¥é“ï¼Œäºšé©¬é€ŠAWSå¯¹æ–°ç”¨æˆ·æœ‰ä¸ªå…è´¹ä½“éªŒä¸€å¹´çš„æ´»åŠ¨ã€‚å¦‚æœå¸Œæœ›ä½“éªŒå…è´¹äºšé©¬é€ŠAWSäº‘æœåŠ¡å™¨äº§å“ï¼Œæˆ–è€…çœ‹çœ‹ä»–ä»¬åå°é¢æ¿é•¿ä»€ä¹ˆæ ·ï¼Œä½“éªŒäº§å“çš„é€Ÿåº¦å’Œæ€§èƒ½ï¼Œåˆæˆ–è€…å‡†å¤‡æ­å»ºä¸€ä¸ªå…è´¹t zï¼Œå¯ä»¥\næ³¨å†Œç©ç©ã€‚\nå¾ˆç®€å•ï¼Œå…¨ç¨‹åŸºæœ¬éƒ½æ˜¯ä¸­æ–‡ï¼Œä¸ç”¨æ‹…å¿ƒçœ‹ä¸æ‡‚è‹±æ–‡ã€‚\næˆ‘æ˜¯2018å¹´6æœˆ30å·æ³¨å†Œçš„è´¦å·ï¼Œåœ¨EC2é¢æ¿åˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹ï¼Œå¹³æ—¶å°±ä¸Šä¸Šè°·æ­Œï¼›å›½å†…ç½‘é€Ÿæ…¢ï¼Œåœ¨ä¸Šé¢ä¸‹è½½ä¸€äº›kubernetesé•œåƒï¼Œç¼–è¯‘ä¸€äº›golangé¡¹ç›®ã€‚\næ‚²å‰§çš„æ˜¯æˆ‘æŠŠæ—¶é—´è®°é”™äº†ï¼Œä»¥ä¸ºæ˜¯2016å¹´8æœˆ10å·å¼€å§‹ä½¿ç”¨çš„ï¼Œèƒ½ç”¨åˆ°ä»Šå¹´8æœˆã€‚ç›´åˆ°8æœˆä»½ä¿¡ç”¨å¡æ”¶åˆ°æ‰£è´¹æç¤ºï¼Œæ‰å‘ç°æ—¶é—´è®°é”™äº†\u0026hellip;\näºæ˜¯ä¹ï¼Œèµ¶ç´§åˆ°EC2 DashBoardé¢æ¿æŠŠå®ä¾‹åœæ­¢ï¼Œåˆ é™¤æ‰ï¼Œä»¥ä¸ºè¿™æ ·å°±ä¸ä¼šå†æ‰£è´¹äº†ã€‚\nç»“æœåˆ°9æœˆä»½åˆæ”¶åˆ°ä¿¡ç”¨å¡æ‰£è´¹æé†’ï¼š\nè¿™æ¬¡æˆ‘ä»¥ä¸ºæ˜¯æ‰£é™¤8æœˆä»½çš„ï¼Œä¹Ÿå°±20å¤šå…ƒï¼Œæ²¡å½“å›äº‹ã€‚\nåˆ°10æœˆä»½åˆæ”¶åˆ°ä¿¡ç”¨å¡æ‰£è´¹æé†’ï¼š\nè¿™æ¬¡æˆ‘å°±è§£é‡Šä¸äº†äº†ã€‚\nç™»é™†äºšé©¬é€Šæ§åˆ¶å°ï¼Œç‚¹å‡»åˆ°ã€ç”¨æˆ·åã€‘\u0026raquo; æˆ‘çš„è´¦æˆ· \u0026raquo; è´¦å•ï¼Œé€‰æ‹©7æœˆä»½ï¼Œçœ‹åˆ°æ‰£è´¹è¯¦æƒ…ï¼š\næ¯ä¸ªäº‘æœåŠ¡å™¨å®ä¾‹æ¯å°æ—¶0.0716ç¾å…ƒï¼Œå…±ä½¿ç”¨160å°æ—¶ï¼Œæ‰£è´¹11.46ç¾å…ƒï¼›\næ¯æœˆæ¯GBé€šç”¨å›ºæ€SSDï¼ˆgp2ï¼‰é¢„ç½®å­˜å‚¨0.10ç¾å…ƒï¼Œä½¿ç”¨6.422 GBï¼Œæ‰£è´¹0.64ç¾å…ƒï¼›\næ¯å°æ—¶æœªé™„åŠ åˆ°æ­£åœ¨è¿è¡Œçš„å®ä¾‹çš„æ¯ä¸ªå¼¹æ€§IPåœ°å€0.005ç¾å…ƒï¼Œæ‰£è´¹2.92ç¾å…ƒï¼›\nåŒæ ·çš„æŸ¥çœ‹äº†8ï¼Œ9ï¼Œ10æœˆçš„æ‰£è´¹è¯¦æƒ…åã€‚æˆ‘æŠŠEC2 DashBoardé‡Œæ‰€æœ‰èµ„æºéƒ½åˆ é™¤æ‰ã€‚\næœ‰ä¸€ä¸ªé»˜è®¤å®‰å…¨ç»„ï¼Œæ˜¯ç›´æ¥åˆ ä¸æ‰çš„ï¼Œéœ€è¦å»åˆ é™¤vpcï¼Œå®‰å…¨ç»„å°±ä¼šè¢«åˆ é™¤ã€‚ å¦‚æœä¸æ˜¯å› ä¸ºå…è´¹ï¼Œ1æ ¸2Mï¼Œ40Gç¡¬ç›˜è¿™ä»·æ ¼ï¼Œå…¶å®è¿˜æ˜¯å¾ˆè´µçš„ã€‚\nèƒ½ä¸èƒ½æŠŠè¿™äº›è´¹ç”¨è®©é€€å›æ¥å‘¢ï¼Ÿäºæ˜¯æˆ‘ç‚¹å‡» æ”¯æŒä¸­å¿ƒ \u0026raquo; create caseï¼š\nI have released the cloud server since in August. Although the elastic IP service has not been released, but there is no traffic, Why does the elastic IP cost the billing in August, September and October? I think this is unreasonable, I need you to return the elastic IP fee deducted from August to October months. Pleas help and check and confim, contact me by my email 8374108792@qq.com or my phone +8615211111104. æäº¤åï¼Œè¿‡äº†å‡ å°æ—¶ï¼Œå®¢æœå›å¤æˆ‘äº†\nHello, Thank you for your reply. I\u0026#39;ve immediately refund the charges back it will take 5 days to complete. Now for any Elastic Ip left idle or not associated with an instance a small charge gets generated I know you\u0026#39;ve not been aware. So to avoid unexpected charges in the future, please make sure to monitor your usage periodically and let us know if you have any questions regarding the billing aspects of our services. å¤§æ¦‚æ„æ€æ˜¯ï¼Œä¼šç«‹å³é€€è¿˜è´¹ç”¨ï¼Œä½†åˆ°è´¦è¿˜éœ€è¦5å¤©æ‰èƒ½å®Œæˆã€‚\nç°åœ¨å¯¹äºä»»ä½•å¼¹æ€§Ipé—²ç½®æˆ–ä¸ä¸€ä¸ªå°å®ä¾‹è´Ÿè´£ç”Ÿæˆæˆ‘çŸ¥é“ä½ æ²¡æœ‰æ„è¯†åˆ°ã€‚\næ‰€ä»¥åœ¨æœªæ¥é¿å…æ„æƒ³ä¸åˆ°çš„è´¹ç”¨,è¯·ç¡®è®¤å®šæœŸç›‘æ§æ‚¨çš„ä½¿ç”¨,è®©æˆ‘ä»¬çŸ¥é“å¦‚æœä½ æœ‰ä»»ä½•å…³äºæˆ‘ä»¬çš„è®¡è´¹æ–¹é¢çš„é—®é¢˜ã€‚\nåœ¨è´¦å•é‡ŒæŸ¥çœ‹åˆ°å·²ç»å¤„ç†äº†é€€æ¬¾ï¼š æcaseæ—¶ä¹Ÿä¸ç”¨æ‹…å¿ƒè‹±è¯­ä¸å¥½ï¼Œæ€•å®¢æœçœ‹ä¸æ‡‚ï¼Œç›´æ¥åœ¨è°·æ­Œç¿»è¯‘ä¸Šç¿»è¯‘ä¸€ä¸‹å°±å¯ä»¥ï¼ŒåŸºæœ¬éƒ½å¯ä»¥ç†è§£ï¼\nå…¶å®AWSçš„æœåŠ¡çœŸçš„æŒºå¥½ã€åªè¦ä¸æ˜¯æ¶æ„ä½¿ç”¨è¿˜å»é€€æ¬¾çš„ã€åŸºæœ¬ä¸Šéƒ½å¯ä»¥ç”³è¯·é€€æ¬¾æˆåŠŸã€‚\nå¦‚æœä½ ä¹Ÿåœ¨ä½¿ç”¨äºšé©¬é€Šï¼Œä»¥ä¸‹è¿™äº›ç‚¹è¿˜æ˜¯å¾—æ³¨æ„ä¸€ä¸‹ï¼Œé¿å…å¸¦æ¥å›°æ‰°ï¼š\néœ€è¦ç”¨åˆ°æ‰‹æœºå·ç PINéªŒè¯ï¼Œä»¥åŠä¿¡ç”¨å¡ä¼šæ‰£1ç¾é‡‘ä½œä¸ºéªŒè¯å¡æ˜¯å¦èƒ½ç”¨çš„è´¹ç”¨ï¼›\nå…è´¹12ä¸ªæœˆAWSäº‘æœåŠ¡å™¨ï¼Œæœ‰æµé‡é™åˆ¶çš„ï¼Œå¦‚æœè¶…è¿‡æµé‡ä¼šé¢å¤–è®¡è´¹ï¼Œå¦‚æœä¸å¥½è¿‡åæ­£å°±å…è´¹ä½¿ç”¨ã€‚å…¶è§„å®šçš„æ˜¯ä¸€ä¸ªå‘¨æœŸ30å¤©å†…å…è´¹æµé‡æ˜¯15Gï¼ŒåŒ…æ‹¬å‡ºå’Œå…¥çš„æµé‡ï¼Œå¦‚æœè¶…äº†å°±è¦ä»ä¿¡ç”¨å¡æ‰£æ¬¾ã€‚è¿™ä¸€é¡¹ä¸€å®šè¦æ³¨æ„ï¼Œè€Œä¸”æ³¨æ„æ˜¯30å¤©ä¸€ä¸ªæœˆå¦‚æœæœ‰31å¤©çš„è¯å°±éœ€è¦åœä¸€å¤©æœåŠ¡ï¼Œæµé‡ç›‘æ§å¯ä»¥åœ¨æ§åˆ¶é¢æ¿é‡Œé¢å»æŸ¥çœ‹ï¼›\nä¸€å¹´åˆ°æœŸåï¼Œä¸€å®šè¦è®°å¾—é‡Šæ”¾æ‰€æœ‰èµ„æºï¼Œå¦åˆ™ä¼šå‡ºç°ç›´æ¥åœ¨ä¿¡ç”¨å¡é‡Œæ‰£è´¹çš„æƒ…å†µï¼Œè´¹ç”¨è¿˜æ˜¯å¾ˆé«˜çš„ã€‚\nç°åœ¨æˆ‘ç”¨çš„æ˜¯ucloudé¦™æ¸¯æœåŠ¡å™¨ï¼Œé€Ÿåº¦æŒºå¿«ï¼Œå¦‚æœä½ ä¹Ÿéœ€è¦ï¼Œå¯ä»¥ç‚¹å‡»ä»¥ä¸‹é“¾æ¥å»æ³¨å†Œ:\nhttps://passport.ucloud.cn/?invitation_code=C1xAF50DBB253EC\u0026ytag=re677q\nç„¶åè”ç³»æˆ‘çš„å¾®ä¿¡837448792,è·å–ä¼˜æƒ æ–¹å¼ï¼\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E4%BA%9A%E9%A9%AC%E9%80%8Aaws%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8D%E5%90%88%E7%90%86%E6%89%A3%E8%B4%B9%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180512.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cp\u003eæœ‰äº›å°ä¼™ä¼´å¯èƒ½ä¸çŸ¥é“ï¼Œäºšé©¬é€ŠAWSå¯¹æ–°ç”¨æˆ·æœ‰ä¸ªå…è´¹ä½“éªŒä¸€å¹´çš„æ´»åŠ¨ã€‚å¦‚æœå¸Œæœ›ä½“éªŒå…è´¹äºšé©¬é€ŠAWSäº‘æœåŠ¡å™¨äº§å“ï¼Œæˆ–è€…çœ‹çœ‹ä»–ä»¬åå°é¢æ¿é•¿ä»€ä¹ˆæ ·ï¼Œä½“éªŒäº§å“çš„é€Ÿåº¦å’Œæ€§èƒ½ï¼Œåˆæˆ–è€…å‡†å¤‡æ­å»ºä¸€ä¸ªå…è´¹t zï¼Œå¯ä»¥\u003cbr /\u003e\næ³¨å†Œç©ç©ã€‚\u003c/p\u003e","title":"äºšé©¬é€ŠAWSäº‘æœåŠ¡å™¨ä¸åˆç†æ‰£è´¹æ€ä¹ˆå¤„ç†","type":"posts"},{"content":"","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/","section":"Tags","summary":"","title":"æœåŠ¡å™¨","type":"tags"},{"content":" å‡ ä¸ªæœˆå‰æˆ‘ä¹Ÿå¼€å§‹åœ¨csdnä¸Šå¼€äº†åšå®¢ï¼Œä¸€æ¥ç»™è‡ªå·±åŠ å‡ ä¸ªå°‘çš„å¯æ€œçš„æµé‡ï¼Œå†è€…ï¼Œè®©å…¬ä¼—å·çš„åŸåˆ›æ–‡ç« è·å¾—æ›´å¤šçš„æ›å…‰ï¼Œè®©æœ‰éœ€è¦çš„åŒå­¦çœ‹åˆ°ã€‚\nå†™è¿‡csdnåšå®¢çš„åŒå­¦éƒ½çŸ¥é“ï¼Œé»˜è®¤åªæœ‰æ‰“èµcå¸åŠŸèƒ½ï¼›ä¹Ÿæ²¡æœ‰ä¸“é—¨å¹¿å‘Šä½ï¼›å¼•å¯¼æ ç›®ï¼Œåªæœ‰ä¾§æ csdnè‡ªå·±çš„å¼•å¯¼äºŒç»´ç ã€‚\nå¦‚ä½•åœ¨csdnè‡ªå®šä¹‰æ ç›®ï¼ŒåŠ èµèµåŠŸèƒ½ï¼Œæˆ–è€…å…¶ä»–ç­‰å¼•å¯¼ï¼Œè®©è¯»è€…èƒ½å¾ˆç›´è§‚çš„çœ‹åˆ°ï¼Œè€Œä¸æ˜¯åœ¨æ¯ç¯‡æ–‡ç« åŠ ï¼Œå¢åŠ è‡ªå·±å·¥ä½œé‡ã€‚è¿™ä¸ªåŠŸèƒ½ä»¥å‰å¯¹æ‰€æœ‰ç”¨æˆ·å¼€æ”¾ï¼Œä½†æ˜¯å¾ˆä¸å¹¸ï¼Œè¿™åŠŸèƒ½è¢«CSDNä¸‹æ¶äº†ï¼Œçœ‹ä¸‹å›¾ï¼š\næˆ‘ä¹Ÿæ˜¯ä¹‹å‰ä¸ºäº†ç»™è¯»è€…ä¸‹è½½CSDNèµ„æ–™å¼€äº†VIPï¼Œç›®å‰è¿˜æœ‰400æ¬¡ä¸‹è½½ï¼Œä¸ºäº†é™åˆ¶ï¼Œæ¯å¤©æœ‰8ä¸ªå…è´¹ä¸‹è½½åé¢ï¼Œéœ€è¦çš„å¯ä»¥æ‰«ç å…³æ³¨å…¬ä¼—å·ï¼Œåœ¨åå°å›å¤ã€2ã€‘åŠ æˆ‘ä»£ä¸‹è½½ã€‚\né¼ æ ‡æ”¾åˆ°å¤´åƒå¤„ï¼Œç‚¹å‡»ä¸‹æ‹‰æ¡†ä¸­çš„ã€ç®¡ç†åšå®¢ã€‘\u0026raquo; ç‚¹å‡»ä¾§æ çš„ã€åšå®¢æ¨¡å—ç®¡ç†ã€‘\nåªèƒ½æ·»åŠ ä¸€æ¡è‡ªå®šä¹‰æ ç›®ï¼Œæ ç›®å†…å®¹æ”¯æŒhtmlï¼Œå¯ä»¥è‡ªç”±å‘æŒ¥ï¼š\næ·»åŠ å…¬ä¼—å·å¼•å¯¼ # \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;å…¬ä¼—å·\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;img src=\u0026#34;http://www.liabio.cn/img/me/gongzhonghao-ercode.jpg\u0026#34; alt=\u0026#34;é•¿æŒ‰è¯†åˆ«äºŒç»´ç å…³æ³¨,ç²¾å½©ç¬¬ä¸€æ—¶é—´é€è¾¾\u0026#34; --- title=\u0026#34;é•¿æŒ‰è¯†åˆ«äºŒç»´ç å…³æ³¨,ç²¾å½©ç¬¬ä¸€æ—¶é—´é€è¾¾\u0026#34; height=\u0026#34;100%\u0026#34; width=\u0026#34;100%\u0026#34;\u0026gt; \u0026lt;marquee\u0026gt;\u0026lt;font color=\u0026#34; red\u0026#34;\u0026gt;æ¬¢è¿æ‰«ç å…³æ³¨ï¼ \u0026lt;/font\u0026gt;\u0026lt;/marquee\u0026gt; \u0026lt;/div\u0026gt; æ•ˆæœå›¾ # æ·»åŠ QQã€QQç¾¤ã€é‚®ç®±ã€å‹æƒ…é“¾æ¥ç­‰ï¼š # \u0026lt;div id=\u0026#34;custom_column_27694137\u0026#34; class=\u0026#34;panel\u0026#34;\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;è”ç³»æ–¹å¼\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;ul class=\u0026#34;panel_head\u0026#34;\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a target=\u0026#34;_blank\u0026#34; href=\u0026#34;http://sighttp.qq.com/msgrd?v=3\u0026amp;uin=1939137617\u0026amp;site=\u0026amp;menu=yes\u0026#34;\u0026gt;â˜ æœ¬äººQQ: 1939137617\u0026lt;/a\u0026gt; \u0026lt;/span\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;ul class=\u0026#34;panel_head\u0026#34;\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a target=\u0026#34;_blank\u0026#34; href=\u0026#34;//shang.qq.com/wpa/qunwpa?idkey=1a08adf5d7f9d49a2a83bb0d3b4acf0e94554895e12dc657ecfb88d706d82673\u0026#34;\u0026gt;\u0026lt;img border=\u0026#34;0\u0026#34; src=\u0026#34;//pub.idqqimg.com/wpa/images/group.png\u0026#34; alt=\u0026#34;ç¨‹åºå‘˜å®æˆ˜\u0026#34; --- title=\u0026#34;ç¨‹åºå‘˜å®æˆ˜\u0026#34;\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;ul class=\u0026#34;panel_head\u0026#34;\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a target=\u0026#34;_blank\u0026#34; href=\u0026#34;https://github.com/smallersoup\u0026#34;\u0026gt;â˜ github.com/smallersoup\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;ul class=\u0026#34;panel_head\u0026#34;\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a href=\u0026#34;mailto:coderaction@foxmail.com\u0026#34;\u0026gt;â˜ coderaction@foxmail.com\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a href=\u0026#34;https://liabio.blog.csdn.net/\u0026#34;\u0026gt;â˜ https://liabio.blog.csdn.net/\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;marquee\u0026gt;\u0026lt;font color=\u0026#34; red\u0026#34;\u0026gt;æ¬¢è¿å…‰ä¸´ï¼ \u0026lt;/font\u0026gt;\u0026lt;/marquee\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;å‹æƒ…é“¾æ¥\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;a target=\u0026#34;_blank\u0026#34; href=\u0026#34;http://www.liabio.cn/\u0026#34;\u0026gt;ã€å°ç¢—æ±¤ã€‘çš„åšå®¢\u0026lt;/a\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;marquee\u0026gt;\u0026lt;font color=\u0026#34; red\u0026#34;\u0026gt;æ¬¢è¿æ¥è¸©ï¼ \u0026lt;/font\u0026gt;\u0026lt;/marquee\u0026gt; \u0026lt;/div\u0026gt; æ•ˆæœå›¾ # å…¶ä¸­ç‚¹å‡»QQä¼šæ‰“å¼€ç™»é™†QQçš„å¯¹è¯æ¡†ï¼Œåªéœ€è¦æŠŠhrefé‡Œé“¾æ¥ä¸­QQå·æ¢ä¸ºè‡ªå·±çš„ï¼›\nç‚¹å‡»åŠ å…¥QQç¾¤åä¼šè·³è½¬åˆ°åŠ ç¾¤çª—å£ï¼Œéœ€è¦åœ¨https://qun.qq.com/join.html ç½‘ç«™ä¸­ç™»é™†éœ€è¦ç»‘å®šçš„QQå· \u0026raquo; é€‰æ‹©ç¾¤ \u0026raquo; å¤åˆ¶ç½‘é¡µä»£ç \nç‚¹å‡»é‚®ç®±ä¼šæ‰“å¼€é‚®ç®±ç™»é™†çª—å£ï¼Œåªéœ€ä¿®æ”¹hrefä¸­çš„é‚®ç®±å³å¯\næ·»åŠ æ‰“èµæé—® # \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;æ¬¢è¿æ‰“èµå’Œæé—®\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;img src=\u0026#34;http://www.liabio.cn/img/fee-say2.png\u0026#34; alt=\u0026#34;é•¿æŒ‰è¯†åˆ«æé—®ç  å‘æˆ‘æé—®\u0026#34; --- title=\u0026#34;é•¿æŒ‰è¯†åˆ«æé—®ç  å‘æˆ‘æé—®\u0026#34; height=\u0026#34;100%\u0026#34; width=\u0026#34;100%\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; æ•ˆæœå›¾ # æ‰“èµé—®ç­”å›¾ç‰‡ç”±ã€Chatå¿«é—®ã€‘å°ç¨‹åºç”Ÿæˆã€‚\nå¾®ä¿¡ã€æ”¯ä»˜å®æ‰“èµ # \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;æ‰«ç æ‰“èµ\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;br\u0026gt; \u0026lt;img src=\u0026#34;http://www.liabio.cn/img/wechat-zhifubao-QR.png\u0026#34; alt=\u0026#34;é•¿æŒ‰è¯†åˆ« å¾®ä¿¡|æ”¯ä»˜å®æ‰“èµé€šç”¨\u0026#34; --- title=\u0026#34;é•¿æŒ‰è¯†åˆ« å¾®ä¿¡|æ”¯ä»˜å®æ‰“èµé€šç”¨\u0026#34; height=\u0026#34;100%\u0026#34; width=\u0026#34;100%\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; åªç”¨ä¸€ä¸ªäºŒç»´ç å®ç°å¾®ä¿¡ã€æ”¯ä»˜å®æ‰“èµï¼Œç”±å°ç¨‹åºã€äºŒç»´ç åˆå¹¶ã€‘æ”¯æŒã€‚\næ•´ä½“ä»£ç  # \u0026lt;div id=\u0026#34;asideCustom41021941\u0026#34; class=\u0026#34;aside-box custom-box\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;aside-content clearfix\u0026#34;\u0026gt; \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;å…¬ä¼—å·\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;img src=\u0026#34;http://www.liabio.cn/img/me/gongzhonghao-ercode.jpg\u0026#34; alt=\u0026#34;é•¿æŒ‰è¯†åˆ«äºŒç»´ç å…³æ³¨,ç²¾å½©ç¬¬ä¸€æ—¶é—´é€è¾¾\u0026#34; --- title=\u0026#34;é•¿æŒ‰è¯†åˆ«äºŒç»´ç å…³æ³¨,ç²¾å½©ç¬¬ä¸€æ—¶é—´é€è¾¾\u0026#34; height=\u0026#34;100%\u0026#34; width=\u0026#34;100%\u0026#34;\u0026gt; \u0026lt;marquee\u0026gt;\u0026lt;font color=\u0026#34; red\u0026#34;\u0026gt;æ¬¢è¿æ‰«ç å…³æ³¨ï¼ \u0026lt;/font\u0026gt;\u0026lt;/marquee\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;br\u0026gt; \u0026lt;div id=\u0026#34;custom_column_27694137\u0026#34; class=\u0026#34;panel\u0026#34;\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;è”ç³»æ–¹å¼\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;ul class=\u0026#34;panel_head\u0026#34;\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a target=\u0026#34;_blank\u0026#34; href=\u0026#34;http://sighttp.qq.com/msgrd?v=3\u0026amp;uin=1939137617\u0026amp;site=\u0026amp;menu=yes\u0026#34;\u0026gt;â˜ æœ¬äººQQ: 1939137617\u0026lt;/a\u0026gt; \u0026lt;/span\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;ul class=\u0026#34;panel_head\u0026#34;\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a target=\u0026#34;_blank\u0026#34; href=\u0026#34;//shang.qq.com/wpa/qunwpa?idkey=1a08adf5d7f9d49a2a83bb0d3b4acf0e94554895e12dc657ecfb88d706d82673\u0026#34;\u0026gt;\u0026lt;img border=\u0026#34;0\u0026#34; src=\u0026#34;//pub.idqqimg.com/wpa/images/group.png\u0026#34; alt=\u0026#34;ç¨‹åºå‘˜å®æˆ˜\u0026#34; --- title=\u0026#34;ç¨‹åºå‘˜å®æˆ˜\u0026#34;\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;ul class=\u0026#34;panel_head\u0026#34;\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a target=\u0026#34;_blank\u0026#34; href=\u0026#34;https://github.com/smallersoup\u0026#34;\u0026gt;â˜ github.com/smallersoup\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;ul class=\u0026#34;panel_head\u0026#34;\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a href=\u0026#34;mailto:coderaction@foxmail.com\u0026#34;\u0026gt;â˜ coderaction@foxmail.com\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;span\u0026gt;\u0026lt;a href=\u0026#34;https://liabio.blog.csdn.net/\u0026#34;\u0026gt;â˜ https://liabio.blog.csdn.net/\u0026lt;/a\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;marquee\u0026gt;\u0026lt;font color=\u0026#34; red\u0026#34;\u0026gt;æ¬¢è¿å…‰ä¸´ï¼ \u0026lt;/font\u0026gt;\u0026lt;/marquee\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;br\u0026gt; \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;å‹æƒ…é“¾æ¥\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;a target=\u0026#34;_blank\u0026#34; href=\u0026#34;http://www.liabio.cn/\u0026#34;\u0026gt;ã€å°ç¢—æ±¤ã€‘çš„åšå®¢\u0026lt;/a\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;marquee\u0026gt;\u0026lt;font color=\u0026#34; red\u0026#34;\u0026gt;æ¬¢è¿æ¥è¸©ï¼ \u0026lt;/font\u0026gt;\u0026lt;/marquee\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;br\u0026gt; \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;æ¬¢è¿æ‰“èµå’Œæé—®\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;img src=\u0026#34;http://www.liabio.cn/img/fee-say2.png\u0026#34; alt=\u0026#34;é•¿æŒ‰è¯†åˆ«æé—®ç  å‘æˆ‘æé—®\u0026#34; --- title=\u0026#34;é•¿æŒ‰è¯†åˆ«æé—®ç  å‘æˆ‘æé—®\u0026#34; height=\u0026#34;100%\u0026#34; width=\u0026#34;100%\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;br\u0026gt; \u0026lt;div\u0026gt; \u0026lt;p\u0026gt;\u0026lt;strong\u0026gt;æ‰«ç æ‰“èµ\u0026lt;/strong\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;img src=\u0026#34;http://www.liabio.cn/img/wechat-zhifubao-QR.png\u0026#34; alt=\u0026#34;é•¿æŒ‰è¯†åˆ« å¾®ä¿¡|æ”¯ä»˜å®æ‰“èµé€šç”¨\u0026#34; --- title=\u0026#34;é•¿æŒ‰è¯†åˆ« å¾®ä¿¡|æ”¯ä»˜å®æ‰“èµé€šç”¨\u0026#34; height=\u0026#34;100%\u0026#34; width=\u0026#34;100%\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; æ•´ä½“æ•ˆæœ # ","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/csdnvip%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%8F%E7%9B%AE/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180806.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cp\u003eå‡ ä¸ªæœˆå‰æˆ‘ä¹Ÿå¼€å§‹åœ¨csdnä¸Šå¼€äº†åšå®¢ï¼Œä¸€æ¥ç»™è‡ªå·±åŠ å‡ ä¸ªå°‘çš„å¯æ€œçš„æµé‡ï¼Œå†è€…ï¼Œè®©å…¬ä¼—å·çš„åŸåˆ›æ–‡ç« è·å¾—æ›´å¤šçš„æ›å…‰ï¼Œè®©æœ‰éœ€è¦çš„åŒå­¦çœ‹åˆ°ã€‚\u003c/p\u003e","title":"CSDN VIPå¦‚ä½•æ·»åŠ è‡ªå®šä¹‰æ ç›®","type":"posts"},{"content":" readmoreæ¥æºäºï¼šhttps://openwrite.cn/openwrite/openwrite-readmore/\nåšå®¢å›­æ¥å…¥ readmore å¾ˆç®€å•ï¼Œä¸‰æ­¥èµ°ï¼Œ2 åˆ†é’Ÿæå®šï¼\nåœ¨ OpenWrite ç”Ÿæˆ readmore è„šæœ¬\nå¾®ä¿¡å…¬ä¼—å·è®¾ç½®å…³é”®è¯å›å¤\nåœ¨åšå®¢å›­è®¾ç½®ä¸­æ·»åŠ è„šæœ¬\nç¬¬ä¸€æ­¥ï¼Œ åœ¨ OpenWrite ç”Ÿæˆ readmore è„šæœ¬\nåœ¨ OpenWrite åå°ï¼Œå¢é•¿å·¥å…· / åšå®¢å¯¼æµå…¬ä¼—å· ç›®å½•ä¸‹ã€‚ç‚¹å‡»æ·»åŠ æŒ‰é’®ï¼Œå¡«å†™åšå®¢å’Œå…¬ä¼—å·ä¿¡æ¯ï¼Œç”Ÿæˆ readmore è„šæœ¬ã€‚\nç¬¬äºŒæ­¥ï¼Œ å¾®ä¿¡å…¬ä¼—å·è®¾ç½®å…³é”®è¯å›å¤\nä¿å­˜æˆåŠŸååœ¨åˆ—è¡¨é¡µä¸­ç‚¹å‡»ä½¿ç”¨ï¼Œæ ¹æ®ä½¿ç”¨æŒ‡å—è®¾ç½®å…¬ä¼—å·å…³é”®è¯å›å¤ï¼Œå¹¶å¤åˆ¶ readmore è„šæœ¬ã€‚\nç¬¬ä¸‰æ­¥ï¼Œåœ¨åšå®¢å›­è®¾ç½®ä¸­æ·»åŠ è„šæœ¬\næ‰“å¼€åšå®¢å›­ï¼Œç®¡ç† / è®¾ç½®é¡µé¢ï¼Œåœ¨æœ€ä¸‹æ–¹ é¡µè„šHtmlä»£ç  ä¸­æ·»åŠ ç¬¬äºŒæ­¥ä¸­å¤åˆ¶çš„ä»£ç ï¼Œä¿®æ”¹ä»£ç ä¸­çš„ id ä¸º cnblogs_post_body ç‚¹å‡»ä¿å­˜ã€‚\nOKï¼Œå†æ‰“å¼€æ–‡ç« é¡µé¢çœ‹çœ‹ï¼Œæ–‡ç« æ˜¯å¦éšè—äº†éƒ¨åˆ†å†…å®¹ï¼Œæœ€åå‡ºç°äº†â€œé˜…è¯»å…¨æ–‡â€æŒ‰é’®ï¼Ÿ\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/readmore%E4%B9%8Bcnblogs%E5%8D%9A%E5%AE%A2%E5%9B%AD%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180330.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cp\u003ereadmoreæ¥æºäºï¼šhttps://openwrite.cn/openwrite/openwrite-readmore/\u003c/p\u003e","title":"ReadMore ä¹‹ cnblogs åšå®¢å›­ä½¿ç”¨æŒ‡å—","type":"posts"},{"content":" æ­£æ–‡ # Dockerå¸¸ç”¨å‘½ä»¤\nrun\ndocker run [OPTIONS] IMAGE [COMMAND] [ARG...] -eè®¾ç½®ç¯å¢ƒå˜é‡ï¼›-e username=zhj\n\u0026ndash;nameä¸ºå®¹å™¨æŒ‡å®šä¸€ä¸ªåç§°ï¼›\u0026ndash;name=zhj\n-pæŒ‡å®šç«¯å£æ˜ å°„ï¼Œæ ¼å¼ä¸ºï¼šä¸»æœº(å®¿ä¸»)ç«¯å£:å®¹å™¨ç«¯å£ -p 80:8080\n-tä¸ºå®¹å™¨é‡æ–°åˆ†é…ä¸€ä¸ªä¼ªè¾“å…¥ç»ˆç«¯ï¼Œé€šå¸¸ä¸ -i åŒæ—¶ä½¿ç”¨ï¼›\n-iä»¥äº¤äº’æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œé€šå¸¸ä¸ -t åŒæ—¶ä½¿ç”¨ï¼›\n-dåå°è¿è¡Œå®¹å™¨ï¼Œå¹¶è¿”å›å®¹å™¨IDï¼›\n-vå®¿ä¸»æœºç›®å½•:å®¹å™¨ç›®å½•ã€‚å°†å®¿ä¸»æœºç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚\ndocker cp\nå¤åˆ¶å®¹å™¨å†…çš„æ–‡ä»¶åˆ°å®¿ä¸»æœº docker start\nå¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªå·²ç»è¢«åœæ­¢çš„å®¹å™¨\ndocker stop\nåœæ­¢ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨\ndocker restart\né‡å¯å®¹å™¨\ndocker rm\nåˆ é™¤å®¹å™¨\ndocker pause\næš‚åœå®¹å™¨ä¸­æ‰€æœ‰çš„è¿›ç¨‹;\ndocker unpause\næ¢å¤å®¹å™¨ä¸­æ‰€æœ‰çš„è¿›ç¨‹;\ndocker exec ï¼š\nåœ¨è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤\ndocker exec -it mynginx /bin/sh /root/runoob.sh docker logs\nè·å–å®¹å™¨çš„æ—¥å¿—;\ndocker ps\nåˆ—å‡ºUPçš„å®¹å™¨ï¼›docker ps -aåˆ—å‡ºæ‰€æœ‰å®¹å™¨ã€‚åŒ…æ‹¬Exitedç­‰çŠ¶æ€çš„å®¹å™¨ï¼›\ndocker top\næŸ¥çœ‹å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ä¿¡æ¯ï¼Œæ”¯æŒ ps å‘½ä»¤å‚æ•°;\ndocker inspect\nè·å–å®¹å™¨/é•œåƒçš„å…ƒæ•°æ®;\ndocker login\nç™»é™†åˆ°ä¸€ä¸ªDockeré•œåƒä»“åº“ï¼Œå¦‚æœæœªæŒ‡å®šé•œåƒä»“åº“åœ°å€ï¼Œé»˜è®¤ä¸ºå®˜æ–¹ä»“åº“ Docker Hub;\ndocker logout\nç™»å‡ºä¸€ä¸ªDockeré•œåƒä»“åº“ï¼Œå¦‚æœæœªæŒ‡å®šé•œåƒä»“åº“åœ°å€ï¼Œé»˜è®¤ä¸ºå®˜æ–¹ä»“åº“ Docker Hub;\ndocker tag\næ ‡è®°æœ¬åœ°é•œåƒï¼Œå°†å…¶å½’å…¥æŸä¸€ä»“åº“;\ndocker push\nå°†æœ¬åœ°çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“,è¦å…ˆç™»é™†åˆ°é•œåƒä»“åº“;\ndocker pull\nä»é•œåƒä»“åº“ä¸­æ‹‰å–æˆ–è€…æ›´æ–°æŒ‡å®šé•œåƒ;\ndocker search\nä»Docker HubæŸ¥æ‰¾é•œåƒ;\ndocker images\nåˆ—å‡ºæœ¬åœ°é•œåƒ;\ndocker rmi\nåˆ é™¤æœ¬åœ°ä¸€ä¸ªæˆ–å¤šå°‘é•œåƒ;\ndocker build\nå‘½ä»¤ç”¨äºä½¿ç”¨ Dockerfile åˆ›å»ºé•œåƒã€‚\ndocker build -t runoob/ubuntu:v1 . ä¼šé»˜è®¤ä½¿ç”¨å½“å‰ç›®å½•çš„Dockerfileè¿›è¡Œç¼–è¯‘é•œåƒï¼Œç¼–è¯‘åçš„é•œåƒåä¸ºrunoob/ubuntu:v1\ndocker history\næŸ¥çœ‹æŒ‡å®šé•œåƒçš„åˆ›å»ºå†å²\ndocker history runoob/ubuntu:v3 docker save\nå°†æŒ‡å®šé•œåƒä¿å­˜æˆ tar å½’æ¡£æ–‡ä»¶ã€‚\ndocker save -o my_ubuntu_v3.tar runoob/ubuntu:v3 docker load\nå¯¼å…¥ä½¿ç”¨ docker saveå‘½ä»¤å¯¼å‡ºçš„é•œåƒã€‚\ndocker load -i my_ubuntu_v3.tar -iå‚æ•°æŒ‡å®šè¾“å…¥çš„æ–‡ä»¶ã€‚\ndocker info\næ˜¾ç¤º Docker ç³»ç»Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬é•œåƒå’Œå®¹å™¨æ•°ã€‚\ndocker version\næ˜¾ç¤º Docker ç‰ˆæœ¬ä¿¡æ¯ã€‚\nDockerçš„å­˜å‚¨é©±åŠ¨\nDockeræ”¯æŒAUFSã€Btrfsã€Device mapperã€OverlayFSã€ZFSäº”ç§å­˜å‚¨é©±åŠ¨ï¼›\nå†™æ—¶å¤åˆ¶ï¼ˆCoWï¼‰\næ‰€æœ‰é©±åŠ¨éƒ½ç”¨åˆ°çš„æŠ€æœ¯â€”â€”å†™æ—¶å¤åˆ¶ï¼ˆCoWï¼‰ã€‚CoWå°±æ˜¯copy-on-writeï¼Œè¡¨ç¤ºåªåœ¨éœ€è¦å†™æ—¶æ‰å»å¤åˆ¶ï¼Œè¿™ä¸ªæ˜¯é’ˆå¯¹å·²æœ‰æ–‡ä»¶çš„ä¿®æ”¹åœºæ™¯ã€‚æ¯”å¦‚åŸºäºä¸€ä¸ªimageå¯åŠ¨å¤šä¸ªContainerï¼Œå¦‚æœä¸ºæ¯ä¸ªContaineréƒ½å»åˆ†é…ä¸€ä¸ªimageä¸€æ ·çš„æ–‡ä»¶ç³»ç»Ÿï¼Œé‚£ä¹ˆå°†ä¼šå ç”¨å¤§é‡çš„ç£ç›˜ç©ºé—´ã€‚è€ŒCoWæŠ€æœ¯å¯ä»¥è®©æ‰€æœ‰çš„å®¹å™¨å…±äº«imageçš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€æœ‰æ•°æ®éƒ½ä»imageä¸­è¯»å–ï¼Œåªæœ‰å½“è¦å¯¹æ–‡ä»¶è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œæ‰ä»imageé‡ŒæŠŠè¦å†™çš„æ–‡ä»¶å¤åˆ¶åˆ°è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œä¿®æ”¹ã€‚å†™æ“ä½œä¼šåœ¨æ¯ä¸ªå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿé‡Œç”Ÿæˆä¸€ä¸ªå¤æœ¬ï¼Œæ¯ä¸ªå®¹å™¨ä¿®æ”¹çš„éƒ½æ˜¯è‡ªå·±çš„å¤æœ¬ï¼Œç›¸äº’éš”ç¦»ï¼Œç›¸äº’ä¸å½±å“ã€‚ä½¿ç”¨CoWå¯ä»¥æœ‰æ•ˆçš„æé«˜ç£ç›˜çš„åˆ©ç”¨ç‡ã€‚\nç”¨æ—¶åˆ†é…ï¼ˆallocate-on-demandï¼‰\nè€Œå†™æ—¶åˆ†é…æ˜¯ç”¨åœ¨åŸæœ¬æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶çš„åœºæ™¯ï¼Œåªæœ‰åœ¨è¦æ–°å†™å…¥ä¸€ä¸ªæ–‡ä»¶æ—¶æ‰åˆ†é…ç©ºé—´ï¼Œè¿™æ ·å¯ä»¥æé«˜å­˜å‚¨èµ„æºçš„åˆ©ç”¨ç‡ã€‚æ¯”å¦‚å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶ä¸ä¼šä¸ºè¿™ä¸ªå®¹å™¨é¢„åˆ†é…ä¸€äº›ç£ç›˜ç©ºé—´ï¼Œè€Œæ˜¯å½“æœ‰æ–°æ–‡ä»¶å†™å…¥æ—¶ï¼Œæ‰æŒ‰éœ€åˆ†é…æ–°ç©ºé—´ã€‚\nOverlay VS Device mapper\ndevicemapperå°†æ‰€æœ‰çš„é•œåƒå’Œå®¹å™¨å­˜å‚¨åœ¨è‡ªå·±çš„è™šæ‹Ÿå—è®¾å¤‡ä¸Šï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯ç›´æ¥å¯¹å—è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯æ–‡ä»¶ã€‚å½“è¦å†™å…¥ä¸€ä¸ªæ–°æ–‡ä»¶æ—¶ï¼Œåœ¨å®¹å™¨çš„é•œåƒå†…ä¸ºå…¶åˆ†é…æ–°çš„å—å¹¶å†™å…¥æ•°æ®ï¼Œè¿™ä¸ªå«ç”¨æ—¶åˆ†é…ã€‚å½“è¦ä¿®æ”¹å·²æœ‰æ–‡ä»¶æ—¶ï¼Œå†ä½¿ç”¨CoWä¸ºå®¹å™¨å¿«ç…§åˆ†é…å—ç©ºé—´ï¼Œå°†è¦ä¿®æ”¹çš„æ•°æ®å¤åˆ¶åˆ°åœ¨å®¹å™¨å¿«ç…§ä¸­æ–°çš„å—é‡Œå†è¿›è¡Œä¿®æ”¹ã€‚\noverlayæ˜¯åŸºäºæ–‡ä»¶çº§çš„å­˜å‚¨ã€‚åªæœ‰ä¸¤å±‚ï¼šä¸€ä¸ªupperæ–‡ä»¶ç³»ç»Ÿå’Œä¸€ä¸ªloweræ–‡ä»¶ç³»ç»Ÿï¼Œåˆ†åˆ«ä»£è¡¨Dockerçš„é•œåƒå±‚å’Œå®¹å™¨å±‚ã€‚å½“éœ€è¦ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œä½¿ç”¨CoWå°†æ–‡ä»¶ä»åªè¯»çš„lowerå¤åˆ¶åˆ°å¯å†™çš„upperè¿›è¡Œä¿®æ”¹ï¼Œç»“æœä¹Ÿä¿å­˜åœ¨upperå±‚ã€‚\nOverlayæ˜¯æ–‡ä»¶çº§å­˜å‚¨ï¼ŒDevice mapperæ˜¯å—çº§å­˜å‚¨ï¼Œå½“æ–‡ä»¶ç‰¹åˆ«å¤§è€Œä¿®æ”¹çš„å†…å®¹å¾ˆå°ï¼ŒOverlayä¸ç®¡ä¿®æ”¹çš„å†…å®¹å¤§å°éƒ½ä¼šå¤åˆ¶æ•´ä¸ªæ–‡ä»¶ï¼Œå¯¹å¤§æ–‡ä»¶è¿›è¡Œä¿®æ”¹æ˜¾ç¤ºè¦æ¯”å°æ–‡ä»¶è¦æ¶ˆè€—æ›´å¤šçš„æ—¶é—´ï¼Œè€Œå—çº§æ— è®ºæ˜¯å¤§æ–‡ä»¶è¿˜æ˜¯å°æ–‡ä»¶éƒ½åªå¤åˆ¶éœ€è¦ä¿®æ”¹çš„å—ï¼Œå¹¶ä¸æ˜¯æ•´ä¸ªæ–‡ä»¶ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæ˜¾ç„¶device mapperè¦å¿«ä¸€äº›ã€‚å› ä¸ºå—çº§çš„æ˜¯ç›´æ¥è®¿é—®é€»è¾‘ç›˜ï¼Œé€‚åˆIOå¯†é›†çš„åœºæ™¯ã€‚è€Œå¯¹äºç¨‹åºå†…éƒ¨å¤æ‚ï¼Œå¤§å¹¶å‘ä½†å°‘IOçš„åœºæ™¯ï¼ŒOverlayçš„æ€§èƒ½ç›¸å¯¹è¦å¼ºä¸€äº›ã€‚\nOverlay VS Overlay2\noverlayé©±åŠ¨åªå·¥ä½œåœ¨ä¸€ä¸ªlower OverlayFSå±‚ä¹‹ä¸Šï¼Œå› æ­¤éœ€è¦ç¡¬é“¾æ¥æ¥å®ç°å¤šå±‚é•œåƒï¼Œä½†overlay2é©±åŠ¨åŸç”Ÿåœ°æ”¯æŒå¤šå±‚lowerOverlayFSé•œåƒï¼ˆæœ€å¤š128å±‚ï¼‰ã€‚å› æ­¤overlay2é©±åŠ¨åœ¨åˆå±‚ç›¸å…³çš„å‘½ä»¤ï¼ˆå¦‚buildå’Œcommitï¼‰ä¸­æä¾›äº†æ›´å¥½çš„æ€§èƒ½ï¼Œä¸overlayé©±åŠ¨å¯¹æ¯”ï¼Œæ¶ˆè€—äº†æ›´å°‘çš„inodeã€‚\nDockerçš„ç½‘ç»œæ¨¡å¼\nå¯ä»¥çœ‹ï¼š[dockerçš„äº”ç§ç½‘ç»œæ¨¡å¼æ€»ç»“]\nhttps://blog.csdn.net/u010900754/article/details/78526443\nå®‰è£… Docker æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»º 3 ä¸ªç½‘ç»œã€‚å¯ä»¥ä½¿ç”¨ docker network lså‘½ä»¤åˆ—å‡ºè¿™äº›ç½‘ç»œã€‚\nè¿™ 3 ä¸ªç½‘ç»œåŒ…å«åœ¨ Docker å®ç°ä¸­ã€‚è¿è¡Œä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ the \u0026ndash;netæ ‡å¿—æŒ‡å®šæ‚¨å¸Œæœ›åœ¨å“ªä¸ªç½‘ç»œä¸Šè¿è¡Œè¯¥å®¹å™¨ã€‚æ‚¨ä»ç„¶å¯ä»¥ä½¿ç”¨è¿™ 3 ä¸ªç½‘ç»œã€‚\nbridge ç½‘ç»œè¡¨ç¤ºæ‰€æœ‰ Docker å®‰è£…ä¸­éƒ½å­˜åœ¨çš„ docker0 ç½‘ç»œã€‚é™¤éä½¿ç”¨docker run \u0026ndash;net=é€‰é¡¹å¦è¡ŒæŒ‡å®šï¼Œå¦åˆ™ Docker å®ˆæŠ¤è¿›ç¨‹é»˜è®¤æƒ…å†µä¸‹ä¼šå°†å®¹å™¨è¿æ¥åˆ°æ­¤ç½‘ç»œã€‚åœ¨ä¸»æœºä¸Šä½¿ç”¨ ifconfigå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°æ­¤ç½‘æ¡¥æ˜¯ä¸»æœºçš„ç½‘ç»œå †æ ˆçš„ä¸€éƒ¨åˆ†ã€‚\nnone ç½‘ç»œåœ¨ä¸€ä¸ªç‰¹å®šäºå®¹å™¨çš„ç½‘ç»œå †æ ˆä¸Šæ·»åŠ äº†ä¸€ä¸ªå®¹å™¨ã€‚è¯¥å®¹å™¨ç¼ºå°‘ç½‘ç»œæ¥å£ã€‚\nhost ç½‘ç»œåœ¨ä¸»æœºç½‘ç»œå †æ ˆä¸Šæ·»åŠ ä¸€ä¸ªå®¹å™¨ã€‚å®¹å™¨ä¸­çš„ç½‘ç»œé…ç½®ä¸ä¸»æœºç›¸åŒã€‚å¯ä»¥é€šè¿‡ä¸»æœºIPè®¿é—®ï¼Œç«¯å£ä¹Ÿä¼šä½¿ç”¨ä¸»æœºç«¯å£ã€‚æ‰€ä»¥ä¸»æœºç«¯å£ä¸èƒ½è¢«å ç”¨ï¼Œå¦åˆ™å®¹å™¨å¯åŠ¨ä¼šæœ‰é—®é¢˜ã€‚\nDockerfileçŸ¥è¯†ç‚¹\nENV\nè®¾ç½®ç¯å¢ƒå˜é‡æŒ‡ä»¤ï¼Œç”¨æ³•\nENV WORKPATH /tmp ä¹Ÿå¯ä»¥è¿™æ ·:\nENV abc=bye def=$abc ç¬¬ä¸€ç§ç”¨æ³•ç”¨äºè®¾ç½®å•ä¸ªå˜é‡(ç¬¬ä¸€ä¸ªç©ºæ ¼å‰ä¸ºkeyï¼Œä¹‹åéƒ½æ˜¯value,åŒ…æ‹¬åé¢çš„ç©ºæ ¼)ï¼Œç¬¬äºŒç§ç”¨äºåŒæ—¶è®¾ç½®å¤šä¸ªå˜é‡(ç©ºæ ¼ä¸ºåˆ†éš”ç¬¦ï¼Œvalueä¸­åŒ…å«ç©ºæ ¼æ—¶å¯ä»¥ç”¨åŒå¼•å·æŠŠvalueæ‹¬èµ·æ¥ï¼Œæˆ–è€…åœ¨ç©ºæ ¼å‰åŠ \\åæ–œçº¿)ï¼Œå½“éœ€è¦åŒæ—¶è®¾ç½®å¤šä¸ªç¯å¢ƒå˜é‡æ—¶æ¨èä½¿ç”¨ç¬¬äºŒç§æ ¼å¼ã€‚è¿™äº›ç¯å¢ƒå˜é‡å¯ä»¥é€šè¿‡docker runå‘½ä»¤çš„\u0026ndash;envå‚æ•°æ¥è¿›è¡Œä¿®æ”¹ã€‚\nENVç”¨æ³•å¦‚ä¸‹ï¼š\nENV myName John Doe ENV myDog Rex The Dog ENV myCat fluffy FROM\nè®¾ç½®åŸºç¡€é•œåƒï¼Œä¸€ä¸ªæœ‰æ•ˆçš„Dockerfileå¿…é¡»æœ‰ä¸€ä¸ªFROMæŒ‡ä»¤æŒ‡å®šä¸€ä¸ªåŸºç¡€é•œåƒï¼Œè¿™ä¸ªé•œåƒå¯ä»¥æ˜¯ä»»ä½•ä½ å¯ä»¥ä»å…±ç”¨ä»“åº“è·å–åˆ°çš„é•œåƒã€‚æ‰§è¡Œå‘½ä»¤æ ¼å¼\nFROM \u0026lt;image\u0026gt; æˆ–è€…\nFROM \u0026lt;image\u0026gt;:\u0026lt;tag\u0026gt; æˆ–è€…\nFROM \u0026lt;image\u0026gt;@\u0026lt;digest\u0026gt; MAINTAINER\nè®¾ç½®åˆ›å»ºé•œåƒçš„ä½œè€…ä¿¡æ¯ã€‚\nMAINTAINER zhanghaojie@qq.com RUN\nè¿™ä¸ªæŒ‡ä»¤æœ‰ä¸¤ç§æ ¼å¼.\nç¬¬ä¸€ç§å½¢å¼ï¼š\nRUN chown user2:user2 /home/webapi (ä»¥shellå½¢å¼æ‰§è¡Œå‘½ä»¤ï¼Œç­‰åŒäº/bin/sh -c); ç¬¬äºŒç§å½¢å¼ï¼š\nRUN [\u0026#34;executable\u0026#34;,\u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;] (ç­‰åŒäºexecå‘½ä»¤å½¢å¼)ï¼Œæ³¨æ„æ­¤å¤„å¿…é¡»æ˜¯åŒå¼•å·(\u0026quot;)ï¼Œå› ä¸ºè¿™ç§æ ¼å¼è¢«è§£æä¸ºJSONæ•°ç»„ã€‚\nARG\nARG \u0026lt;name\u0026gt;[=\u0026lt;default value\u0026gt;] ARGæŒ‡ä»¤è®¾ç½®ä¸€äº›åˆ›å»ºé•œåƒæ—¶çš„å‚æ•°ï¼Œè¿™äº›å‚æ•°å¯ä»¥åœ¨æ‰§è¡Œdocker buildå‘½ä»¤æ—¶é€šè¿‡\u0026ndash;build-arg =è®¾ç½®ï¼Œå¦‚æœæŒ‡å®šçš„åˆ›å»ºå‚æ•°åœ¨Dockerfileä¸­æ²¡æœ‰æŒ‡å®šï¼Œåˆ›å»ºæ—¶ä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯: One or more build-args were not consumed, failing build.\nDockerfile ä½œè€…å¯ä»¥ä¸ºARGè®¾ç½®ä¸€ä¸ªé»˜è®¤å‚æ•°å€¼ï¼Œå½“åˆ›å»ºé•œåƒæ—¶å¦‚æœæ²¡æœ‰ä¼ å…¥å‚æ•°å°±ä¼šä½¿ç”¨é»˜è®¤å€¼ï¼š\nFROM busybox æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ARGæˆ–è€…ENVæŒ‡ä»¤æ¥æŒ‡å®šRUNæŒ‡ä»¤ä½¿ç”¨çš„å˜é‡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ENVå®šä¹‰ä¸ARGå®šä¹‰åç§°ç›¸åŒçš„å˜é‡æ¥è¦†ç›–ARGå®šä¹‰çš„å˜é‡å€¼ã€‚å¦‚ä¸‹ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ‰§è¡Œ\ndocker build --build-arg CONT_IMG_VER=v2.0.1 Dockerfile åå°†è·å–åˆ°çš„CONTIMGVERå˜é‡å€¼ä¸ºv1.0.0:\nFROM ubuntu WORKDIR\nWORKDIR /path/to/workdir WORKDIRæŒ‡ä»¤ç”¨æ¥è®¾ç½®Dockerfileä¸­ä»»ä½•ä½¿ç”¨ç›®å½•çš„å‘½ä»¤çš„å½“å‰å·¥ä½œç›®å½•ï¼Œæ­¤ç›®å½•å¦‚æœä¸å­˜åœ¨å°±ä¼šè¢«è‡ªåŠ¨åˆ›å»ºï¼Œå³ä½¿è¿™ä¸ªç›®å½•ä¸è¢«ä½¿ç”¨\nVOLUME\nVOLUME [\u0026#34;/data\u0026#34;] (execæ ¼å¼æŒ‡ä»¤) VOLUMEæŒ‡ä»¤åˆ›å»ºä¸€ä¸ªå¯ä»¥ä»æœ¬åœ°ä¸»æœºæˆ–å…¶ä»–å®¹å™¨æŒ‚è½½çš„æŒ‚è½½ç‚¹ã€‚ç»å¸¸ç”¨åˆ°çš„æ˜¯\ndocker run -ti -v /data:/data nginx:1.12 bash æ—¶æŒ‡å®šæœ¬åœ°è·¯å¾„å’Œå®¹å™¨å†…è·¯å¾„çš„æ˜ å°„ã€‚\nCOPY\nCOPYæŒ‡ä»¤èƒ½å¤Ÿå°†æ„å»ºå‘½ä»¤æ‰€åœ¨çš„ä¸»æœºæœ¬åœ°çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¤åˆ¶åˆ°é•œåƒæ–‡ä»¶ç³»ç»Ÿã€‚\nexecæ ¼å¼ç”¨æ³•ï¼ˆæ¨èï¼‰ï¼š\nCOPY [\u0026#34;\u0026lt;src\u0026gt;\u0026#34;,... \u0026#34;\u0026lt;dest\u0026gt;\u0026#34;] ç‰¹åˆ«é€‚åˆè·¯å¾„ä¸­å¸¦æœ‰ç©ºæ ¼çš„æƒ…å†µã€‚\nshellæ ¼å¼ç”¨æ³•ï¼š\nCOPY \u0026lt;src\u0026gt;... \u0026lt;dest\u0026gt; ADD\nADDæŒ‡ä»¤ä¸ä»…èƒ½å¤Ÿå°†æ„å»ºå‘½ä»¤æ‰€åœ¨çš„ä¸»æœºæœ¬åœ°çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œè€Œä¸”èƒ½å¤Ÿå°†è¿œç¨‹URLæ‰€å¯¹åº”çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œä½œä¸ºèµ„æºå¤åˆ¶åˆ°é•œåƒæ–‡ä»¶ç³»ç»Ÿã€‚\næ‰€ä»¥ï¼Œå¯ä»¥è®¤ä¸ºADDæ˜¯å¢å¼ºç‰ˆçš„COPYï¼Œæ”¯æŒå°†è¿œç¨‹URLçš„èµ„æºåŠ å…¥åˆ°é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿã€‚\nexecæ ¼å¼ç”¨æ³•ï¼ˆæ¨èï¼‰ï¼š\nADD [\u0026#34;\u0026lt;src\u0026gt;\u0026#34;,... \u0026#34;\u0026lt;dest\u0026gt;\u0026#34;] ç‰¹åˆ«é€‚åˆè·¯å¾„ä¸­å¸¦æœ‰ç©ºæ ¼çš„æƒ…å†µã€‚\nshellæ ¼å¼ç”¨æ³•ï¼š\nADD \u0026lt;src\u0026gt;... \u0026lt;dest\u0026gt; è¯´æ˜ï¼Œå¯¹äºä»è¿œç¨‹URLè·å–èµ„æºçš„æƒ…å†µï¼Œç”±äºADDæŒ‡ä»¤ä¸æ”¯æŒè®¤è¯ï¼Œå¦‚æœä»è¿œç¨‹è·å–èµ„æºéœ€è¦è®¤è¯ï¼Œåˆ™åªèƒ½ä½¿ç”¨RUN wgetæˆ–RUN curlæ›¿ä»£ã€‚\nå¦å¤–ï¼Œå¦‚æœæºè·¯å¾„çš„èµ„æºå‘ç”Ÿå˜åŒ–ï¼Œåˆ™è¯¥ADDæŒ‡ä»¤å°†ä½¿Docker Cacheå¤±æ•ˆï¼ŒDockerfileä¸­åç»­çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¸èƒ½ä½¿ç”¨ç¼“å­˜ã€‚å› æ­¤å°½é‡å°†ADDæŒ‡ä»¤æ”¾åœ¨Dockerfileçš„åé¢ã€‚\n**å‚è€ƒï¼š**Dockerfileä¸­çš„COPYå’ŒADDæŒ‡ä»¤è¯¦è§£ä¸æ¯”è¾ƒ\nhttps://blog.csdn.net/taiyangdao/article/details/73222601\nEXPOSEæŒ‡ä»¤\nEXPOSE \u0026lt;ç«¯å£\u0026gt; [\u0026lt;ç«¯å£\u0026gt;...] æŒ‡ä»¤ç”¨äºæ ‡æ˜ï¼Œè¿™ä¸ªé•œåƒä¸­çš„åº”ç”¨å°†ä¼šä¾¦å¬æŸä¸ªç«¯å£ï¼Œå¹¶ä¸”å¸Œæœ›èƒ½å°†è¿™ä¸ªç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ç½‘ç»œç•Œé¢ä¸Šã€‚ä½†æ˜¯ï¼Œä¸ºäº†å®‰å…¨ï¼Œdocker runå‘½ä»¤å¦‚æœæ²¡æœ‰å¸¦ä¸Šå“åº”çš„ç«¯å£æ˜ å°„å‚æ•°ï¼Œdockerå¹¶ä¸ä¼šå°†ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºã€‚\nCMD ä¸ ENTRYPOINT\näºŒè€…çš„åŒºåˆ«çœ‹ï¼š[docker CMD ENTRYPOINT åŒºåˆ« ç»ˆæè§£è¯»]\nhttps://blog.csdn.net/u010900754/article/details/78526443\nä»æ ¹æœ¬ä¸Šè¯´, ENTRYPOINTå’ŒCMDéƒ½æ˜¯è®©ç”¨æˆ·æŒ‡å®šä¸€ä¸ªå¯æ‰§è¡Œç¨‹åº, è¿™ä¸ªå¯æ‰§è¡Œç¨‹åºåœ¨containerå¯åŠ¨åè‡ªåŠ¨å¯åŠ¨. å®é™…ä¸Š, å¦‚æœä½ æƒ³è®©è‡ªå·±åˆ¶ä½œçš„é•œåƒè‡ªåŠ¨è¿è¡Œç¨‹åº(ä¸éœ€è¦åœ¨docker runåé¢æ·»åŠ å‘½ä»¤è¡ŒæŒ‡å®šè¿è¡Œçš„å‘½ä»¤), ä½ å¿…é¡»åœ¨Dockerfileé‡Œé¢ï¼Œä½¿ç”¨ENTRYPOINTæˆ–è€…CMDå‘½ä»¤ã€‚åœ¨å‘½ä»¤è¡Œå¯åŠ¨dockeré•œåƒæ—¶, æ‰§è¡Œå…¶ä»–å‘½ä»¤è¡Œå‚æ•°ï¼Œè¦†ç›–é»˜è®¤çš„CMDã€‚å’ŒCMDç±»ä¼¼, é»˜è®¤çš„ENTRYPOINTä¹Ÿåœ¨docker runæ—¶, ä¹Ÿå¯ä»¥è¢«è¦†ç›–. åœ¨è¿è¡Œæ—¶, ç”¨\u0026ndash;entrypointè¦†ç›–é»˜è®¤çš„ENTRYPOINTã€‚\ndockerfileä¸­çš„CMDå‘½ä»¤è¢«è¦†ç›–ï¼š\n***CMDï¼š***æä¾›äº†å®¹å™¨é»˜è®¤çš„æ‰§è¡Œå‘½ä»¤ã€‚Dockerfile åªå…è®¸ä½¿ç”¨ä¸€æ¬¡ CMD æŒ‡ä»¤ã€‚ä½¿ç”¨å¤šä¸ª CMD ä¼šæŠµæ¶ˆä¹‹å‰æ‰€æœ‰çš„æŒ‡ä»¤ï¼Œåªæœ‰æœ€åä¸€ä¸ªæŒ‡ä»¤ç”Ÿæ•ˆã€‚CMD æœ‰ä¸‰ç§å½¢å¼ï¼š\nCMD [\u0026#34;executable\u0026#34;,\u0026#34;param1\u0026#34;,\u0026#34;param2\u0026#34;] (exec form, thisis the preferred form) ***ENTRYPOINTï¼š***é…ç½®ç»™å®¹å™¨ä¸€ä¸ªå¯æ‰§è¡Œçš„å‘½ä»¤ï¼Œè¿™æ„å‘³ç€åœ¨æ¯æ¬¡ä½¿ç”¨é•œåƒåˆ›å»ºå®¹å™¨æ—¶ä¸€ä¸ªç‰¹å®šçš„åº”ç”¨ç¨‹åºå¯ä»¥è¢«è®¾ç½®ä¸ºé»˜è®¤ç¨‹åºã€‚åŒæ—¶ä¹Ÿæ„å‘³ç€è¯¥é•œåƒæ¯æ¬¡è¢«è°ƒç”¨æ—¶ä»…èƒ½è¿è¡ŒæŒ‡å®šçš„åº”ç”¨ã€‚ç±»ä¼¼äºCMDï¼ŒDockeråªå…è®¸ä¸€ä¸ªENTRYPOINTï¼Œå¤šä¸ªENTRYPOINTä¼šæŠµæ¶ˆä¹‹å‰æ‰€æœ‰çš„æŒ‡ä»¤ï¼Œåªæ‰§è¡Œæœ€åçš„ENTRYPOINTæŒ‡ä»¤ã€‚è¯­æ³•å¦‚ä¸‹ï¼š\nENTRYPOINT [\u0026#34;executable\u0026#34;, \u0026#34;param1\u0026#34;,\u0026#34;param2\u0026#34;] ","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20191002.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eDockerå¸¸ç”¨å‘½ä»¤\u003c/strong\u003e\u003c/p\u003e","title":"å²ä¸Šæœ€å…¨dockeråŸºç¡€çŸ¥è¯†æ±‡æ€»","type":"posts"},{"content":" æ­£æ–‡ # ä½¿ç”¨è¿‡dockerçš„éƒ½çŸ¥é“dockerfileï¼Œå…¶ç”¨äºå®šä¹‰åˆ¶ä½œé•œåƒçš„æµç¨‹ï¼Œç”±ä¸€ç³»åˆ—å‘½ä»¤å’Œå‚æ•°æ„æˆçš„è„šæœ¬ï¼Œè¿™äº›å‘½ä»¤åº”ç”¨äºåŸºç¡€é•œåƒå¹¶æœ€ç»ˆåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒã€‚å¯å‚è€ƒå¾€æœŸæ–‡ç« å­¦ä¹ ï¼š dockeråŸºç¡€çŸ¥è¯†æ•´ç†\næœ‰æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³åœ¨åŸæœ‰é•œåƒåŸºç¡€ä¸Šä¿®æ”¹ã€å¢åŠ æ–‡ä»¶ï¼Œç”±äºå›½å†…ç½‘ç»œåŸå› ï¼Œé‡æ–°åˆ¶ä½œé•œåƒä¼šå¾ˆæ…¢ï¼Œç”šè‡³å¤±è´¥ï¼›æˆ–è€…æ ¹æœ¬ä¸çŸ¥é“é•œåƒçš„dockerfileé•¿ä»€ä¹ˆæ ·ã€‚æ”¹åŠ¨å¾ˆå°æƒ…å†µä¸‹ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼åˆ¶ä½œé•œåƒã€‚\næ‹¿k8sè´Ÿè½½å‡è¡¡å™¨ç»„ä»¶ingress-nginx:0.24.1ç‰ˆæœ¬ä¸ºä¾‹ï¼š\nå¦‚æœæˆ‘ä»¬ä¿®æ”¹äº†å…¶æºç ï¼Œå¹¶ç¼–è¯‘ç”Ÿæˆnginx-ingress-controlleräºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼è¿›è¡Œåˆ¶ä½œæ–°é•œåƒã€‚\né¦–å…ˆç”¨å‘½ä»¤ï¼š\ndocker run -ti --rm k8s-deploy/nginx-ingress-controller:0.24.1 bash å°†é•œåƒè¿è¡Œèµ·æ¥ã€‚å…¶ä¸­-tiè¡¨ç¤ºæ‰“å¼€ä¸€ä¸ªäº¤äº’è¾“å…¥ç»ˆç«¯ï¼›\u0026ndash;rmè¡¨ç¤ºè¿è¡Œåœæ­¢åè‡ªåŠ¨æ¸…ç†ã€‚\nè¿è¡Œåå¯ä»¥çœ‹åˆ°é»˜è®¤ç”¨æˆ·ä¸ºwww-dataï¼Œa298fe62a4f9è¡¨ç¤ºå®¹å™¨id\næˆ‘ä»¬å¯ä»¥åœ¨å®¹å™¨é‡Œåˆ›å»ºç›®å½•ï¼š\né‡æ–°æ‰“å¼€ä¸€ä¸ªshellçª—å£ï¼Œç”¨äºç»™å®¹å™¨å†…å¤åˆ¶ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼š\ndocker cp ingressgroup-upstream.tmpl a298fe62a4f9:/etc/nginx/conf.d/include-server-map/ å¤åˆ¶è¿›å»åï¼Œå½“è¦å°†å…¶ç§»åŠ¨åˆ°å…¶ä»–ä½ç½®æ—¶ï¼ŒæŠ¥Permission deniedæƒé™ä¸è¶³ï¼Œå› ä¸ºé»˜è®¤ä¸ºwww-dataç”¨æˆ·ï¼Œå¤åˆ¶åˆ°å®¹å™¨å†…çš„ingressgroup-upstream.tmplå±ä¸»:å±ç»„ä¹Ÿæ˜¯rootï¼Œå¦‚æœä¸æŠŠrootä¿®æ”¹ä¸ºwww-dataï¼Œè‚¯å®šä¼šæŠ¥æ²¡æƒé™çš„é”™ã€‚\né€šè¿‡ä»¥ä¸‹å‘½ä»¤é‡æ–°è¿è¡Œé•œåƒï¼š\ndocker run -ti --rm -u 0 k8s-deploy/nginx-ingress-controller:0.24.1 bash -u 0ä»£è¡¨ç”¨rootç”¨æˆ·è¿è¡Œå®¹å™¨ï¼Œè€Œä¸æ˜¯dockerfileé‡ŒæŒ‡å®šçš„ç”¨æˆ·ï¼Œè¿™æ ·è¿è¡Œåå¯ä»¥çœ‹åˆ°ç”¨æˆ·ä¸ºrootï¼Œè®°å½•å®¹å™¨id:ffdc80f3cce7\né‡æ–°æ‰§è¡Œå¤åˆ¶æ“ä½œï¼š\næ­¤æ—¶å°±å¯ä»¥éšæ„ç§»åŠ¨å’Œä¿®æ”¹æ–‡ä»¶çš„æƒé™ã€å±ç»„ã€å±ä¸»äº†ã€‚\nä¿®æ”¹å®Œæ¯•åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†é•œåƒcommitåˆ°æœ¬åœ°ä»“åº“ï¼š\ndocker commit ffdc80f3cce7 k8s-deploy/nginx-ingress-controller:0.24.1-temp commitåè·Ÿçš„æ˜¯å®¹å™¨idï¼Œæœ€åè·Ÿçš„æ˜¯æ–°é•œåƒåç§°ã€‚pushå‘½ä»¤å°†æ–°é•œåƒæ¨åˆ°è¿œç¨‹harborä»“åº“ã€‚\nè¿è¡Œæ–°åˆ¶ä½œçš„é•œåƒï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¿®æ”¹çš„æ–‡ä»¶ã€‚\nè¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨äºæµ‹è¯•ï¼Œå¼Šç«¯æ˜¯å¯èƒ½ä¼šå¯¼è‡´é•œåƒè¶Šæ¥è¶Šå¤§ã€‚\n","date":"2019å¹´10æœˆ17æ—¥","externalUrl":null,"permalink":"/posts/docker%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C%E5%BF%85%E5%A4%87%E6%8A%80%E8%83%BD/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20180416.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\n\u003ch2 class=\"relative group\"\u003eæ­£æ–‡ \n    \u003cdiv id=\"æ­£æ–‡\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%ad%a3%e6%96%87\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eä½¿ç”¨è¿‡dockerçš„éƒ½çŸ¥é“dockerfileï¼Œå…¶ç”¨äºå®šä¹‰åˆ¶ä½œé•œåƒçš„æµç¨‹ï¼Œç”±ä¸€ç³»åˆ—å‘½ä»¤å’Œå‚æ•°æ„æˆçš„è„šæœ¬ï¼Œè¿™äº›å‘½ä»¤åº”ç”¨äºåŸºç¡€é•œåƒå¹¶æœ€ç»ˆåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒã€‚å¯å‚è€ƒå¾€æœŸæ–‡ç« å­¦ä¹ ï¼š\n\u003ca href=\"https://kubeinfo.cn/go/?target=aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvbHpGTDRlV1U4aDIzc1RiRmJIRVprZw%3d%3d\" target=\"_blank\" \u003edockeråŸºç¡€çŸ¥è¯†æ•´ç†\u003c/a\u003e\u003c/p\u003e","title":"dockeré•œåƒåˆ¶ä½œå¿…å¤‡æŠ€èƒ½","type":"posts"},{"content":" kubernetesç‰ˆæœ¬ï¼š1.13.2\næ¥ä¸Šä¸€èŠ‚ï¼š kubernetesåƒåœ¾å›æ”¶å™¨GarbageCollector Controlleræºç åˆ†æï¼ˆä¸€ï¼‰\nä¸»è¦æ­¥éª¤ # GarbageCollector Controlleræºç ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š\nmonitorsä½œä¸ºç”Ÿäº§è€…å°†å˜åŒ–çš„èµ„æºæ”¾å…¥graphChangesé˜Ÿåˆ—ï¼›åŒæ—¶restMapperå®šæœŸæ£€æµ‹é›†ç¾¤å†…èµ„æºç±»å‹ï¼Œåˆ·æ–°monitors runProcessGraphChangesä»graphChangesé˜Ÿåˆ—ä¸­å–å‡ºå˜åŒ–çš„itemï¼Œæ ¹æ®æƒ…å†µæ”¾å…¥attemptToDeleteé˜Ÿåˆ—ï¼› runProcessGraphChangesä»graphChangesé˜Ÿåˆ—ä¸­å–å‡ºå˜åŒ–çš„itemï¼Œæ ¹æ®æƒ…å†µæ”¾å…¥attemptToOrphané˜Ÿåˆ—ï¼› runAttemptToDeleteWorkerä»attemptToDeleteé˜Ÿåˆ—å–å‡ºï¼Œå°è¯•åˆ é™¤åƒåœ¾èµ„æºï¼› runAttemptToOrphanWorkerä»attemptToOrphané˜Ÿåˆ—å–å‡ºï¼Œå¤„ç†è¯¥å­¤ç«‹çš„èµ„æºï¼›\nä»£ç è¾ƒå¤æ‚ï¼Œä¾¿äºè®²çš„æ›´æ¸…æ¥šï¼Œè°ƒæ•´äº†ä¸‹è®²è§£é¡ºåºã€‚ä¸Šä¸€èŠ‚åˆ†æäº†ç¬¬1éƒ¨åˆ†ï¼Œæœ¬èŠ‚åˆ†æç¬¬2ã€3éƒ¨åˆ†ã€‚ runProcessGraphChangeså¤„ç†ä¸»æµç¨‹ # æ¥åˆ°æºç k8s.io\\kubernetes\\pkg\\controller\\garbagecollector\\graph_builder.goä¸­ï¼ŒrunProcessGraphChangesä¸­ä¸€ç›´æ­»å¾ªç¯å¤„ç†å˜åŒ–çš„èµ„æºå¯¹è±¡ï¼š\nfunc (gb *GraphBuilder) runProcessGraphChanges() { for gb.processGraphChanges() { } } ä¸€ä¸ªåç¨‹ä¸€ç›´å¾ªç¯ä»graphChangesé˜Ÿåˆ—ä¸­è·å–å˜åŒ–çš„èµ„æºå¯¹è±¡ï¼Œæ›´æ–°å›¾å½¢ï¼Œå¡«å……dirty_queueã€‚(graphChangesé˜Ÿåˆ—é‡Œæ•°æ®æ¥æºäºå„ä¸ªèµ„æºçš„monitorsç›‘å¬èµ„æºå˜åŒ–å›è°ƒaddFuncã€updateFuncã€deleteFunc)\n// Dequeueing an event from graphChanges, updating graph, populating dirty_queue. //ä»graphChangesä¸­è·å–äº‹ä»¶ï¼Œæ›´æ–°å›¾å½¢ï¼Œå¡«å……dirty_queueã€‚(graphChangesé˜Ÿåˆ—é‡Œæ•°æ®æ¥æºäºå„ä¸ªèµ„æºçš„monitorsç›‘å¬èµ„æºå˜åŒ–å›è°ƒaddFuncã€updateFuncã€deleteFunc) func (gb *GraphBuilder) processGraphChanges() bool { item, quit := gb.graphChanges.Get() if quit { return false } defer gb.graphChanges.Done(item) event, ok := item.(*event) if !ok { utilruntime.HandleError(fmt.Errorf(\u0026#34;expect a *event, got %v\u0026#34;, item)) return true } obj := event.obj //è·å–è¯¥å˜åŒ–èµ„æºobjçš„accessor accessor, err := meta.Accessor(obj) if err != nil { utilruntime.HandleError(fmt.Errorf(\u0026#34;cannot access obj: %v\u0026#34;, err)) return true } klog.V(5).Infof(\u0026#34;GraphBuilder process object: %s/%s, namespace %s, name %s, uid %s, event type %v\u0026#34;, event.gvk.GroupVersion().String(), event.gvk.Kind, accessor.GetNamespace(), accessor.GetName(), string(accessor.GetUID()), event.eventType) // Check if the node already exists // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨ //æ ¹æ®è¯¥å˜åŒ–èµ„æºobjçš„UID //uidToNodeç»´æŠ¤ç€èµ„æºå¯¹è±¡ä¾èµ–å…³ç³»å›¾è¡¨ç»“æ„ existingNode, found := gb.uidToNode.Read(accessor.GetUID()) if found { // this marks the node as having been observed via an informer event // 1. this depends on graphChanges only containing add/update events from the actual informer // 2. this allows things tracking virtual nodes\u0026#39; existence to stop polling and rely on informer events //è¿™æ ‡å¿—ç€èŠ‚ç‚¹å·²ç»é€šè¿‡informeräº‹ä»¶ // 1.è¿›è¡Œäº†è§‚å¯Ÿã€‚è¿™å–å†³äºä»…åŒ…å«æ¥è‡ªå®é™…informerçš„æ·»åŠ /æ›´æ–°äº‹ä»¶çš„graphChange // 2.è¿™å…è®¸è·Ÿè¸ªè™šæ‹ŸèŠ‚ç‚¹çš„å­˜åœ¨ä»¥åœæ­¢è½®è¯¢å’Œä¾èµ–informeräº‹ä»¶ existingNode.markObserved() } switch { //gcç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼ŒuidToNodeå°šä¸”æ²¡æœ‰åˆå§‹åŒ–èµ„æºå¯¹è±¡ä¾èµ–å…³ç³»å›¾è¡¨ç»“æ„ï¼Œæ‰€ä»¥foundä¸ºfalseï¼Œä¼šæ–°å¢èŠ‚ç‚¹ case (event.eventType == addEvent || event.eventType == updateEvent) \u0026amp;\u0026amp; !found: newNode := \u0026amp;node{ identity: objectReference{ OwnerReference: metav1.OwnerReference{ APIVersion: event.gvk.GroupVersion().String(), Kind: event.gvk.Kind, UID: accessor.GetUID(), Name: accessor.GetName(), }, Namespace: accessor.GetNamespace(), }, dependents: make(map[*node]struct{}), owners: accessor.GetOwnerReferences(), deletingDependents: beingDeleted(accessor) \u0026amp;\u0026amp; hasDeleteDependentsFinalizer(accessor), beingDeleted: beingDeleted(accessor), } gb.insertNode(newNode) // the underlying delta_fifo may combine a creation and a deletion into // one event, so we need to further process the event. //åº•å±‚delta_fifoå¯ä»¥å°†åˆ›å»ºå’Œåˆ é™¤ç»„åˆæˆä¸€ä¸ªäº‹ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥å¤„ç†äº‹ä»¶ã€‚ gb.processTransitions(event.oldObj, accessor, newNode) //uidToNodeå·²ç»åˆå§‹åŒ–èµ„æºå¯¹è±¡ä¾èµ–å…³ç³»å›¾è¡¨ç»“æ„ï¼Œæ‰€ä»¥foundä¸ºtrue case (event.eventType == addEvent || event.eventType == updateEvent) \u0026amp;\u0026amp; found: // handle changes in ownerReferences //å¤„ç†ownerReferencesä¸­çš„æ›´æ”¹ added, removed, changed := referencesDiffs(existingNode.owners, accessor.GetOwnerReferences()) if len(added) != 0 || len(removed) != 0 || len(changed) != 0 { // check if the changed dependency graph unblock owners that are // waiting for the deletion of their dependents. //æ£€æŸ¥æ›´æ”¹çš„ä¾èµ–å…³ç³»å›¾æ˜¯å¦å–æ¶ˆé˜»æ­¢ç­‰å¾…åˆ é™¤å…¶ä¾èµ–é¡¹çš„æ‰€æœ‰è€…ã€‚ gb.addUnblockedOwnersToDeleteQueue(removed, changed) // update the node itself //æ›´æ–°nodeçš„owner existingNode.owners = accessor.GetOwnerReferences() // Add the node to its new owners\u0026#39; dependent lists. //ç»™æ–°owneræ·»åŠ ä¾èµ–èµ„æºåˆ—è¡¨ gb.addDependentToOwners(existingNode, added) // remove the node from the dependent list of node that are no longer in // the node\u0026#39;s owners list. //ä»ä¸å†å±äºè¯¥èµ„æºowneråˆ—è¡¨ä¸­åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚ gb.removeDependentFromOwners(existingNode, removed) } // è¯¥å¯¹è±¡æ­£åœ¨è¢«åˆ é™¤ä¸­ if beingDeleted(accessor) { existingNode.markBeingDeleted() } gb.processTransitions(event.oldObj, accessor, existingNode) //å¤„ç†èµ„æºå¯¹è±¡è¢«åˆ é™¤çš„åœºæ™¯ï¼Œæ¶‰åŠåƒåœ¾ã€‚æ¯”å¦‚ï¼Œownerè¢«åˆ é™¤ï¼Œå…¶ä¾èµ–èµ„æºï¼ˆä»èµ„æºï¼‰ä¹Ÿéœ€è¦è¢«åˆ é™¤æ‰ï¼Œé™¤éè®¾ç½®äº†Orphan case event.eventType == deleteEvent: if !found { klog.V(5).Infof(\u0026#34;%v doesn\u0026#39;t exist in the graph, this shouldn\u0026#39;t happen\u0026#34;, accessor.GetUID()) return true } // ä»å›¾æ ‡ä¸­ç§»é™¤itemèµ„æºï¼ŒåŒæ—¶éå†ownersï¼Œç§»é™¤ownerä¸‹çš„itemèµ„æº gb.removeNode(existingNode) existingNode.dependentsLock.RLock() defer existingNode.dependentsLock.RUnlock() //å¦‚æœè¯¥èµ„æºçš„ä»èµ„æºæ•°å¤§äº0,åˆ™å°†è¯¥èµ„æºè¢«åˆ é™¤ä¿¡æ¯åŠ å…¥absentOwnerCacheç¼“å­˜ if len(existingNode.dependents) \u0026gt; 0 { gb.absentOwnerCache.Add(accessor.GetUID()) } //éå†è¯¥èµ„æºçš„ä»èµ„æºåŠ åˆ°åˆ é™¤é˜Ÿåˆ—é‡Œ for dep := range existingNode.dependents { gb.attemptToDelete.Add(dep) } for _, owner := range existingNode.owners { ownerNode, found := gb.uidToNode.Read(owner.UID) //owneræ²¡å‘ç° æˆ–è€… ownerçš„ä»èµ„æºä¸æ˜¯æ­£åœ¨è¢«åˆ é™¤(åªæœ‰è¯¥èµ„æºå¯¹è±¡çš„ç»ˆç»“å™¨ä¸ºforegroundDeletion Finalizeræ—¶deletingDependentsè¢«è®¾ä¸ºtrue,å› ä¸ºåå°åˆ é™¤ownerç›´æ¥è¢«åˆ é™¤,ä¸ä¼šè¢«å…¶ä»èµ„æºblock,æ•…è¿™é‡Œéƒ½ä¸éœ€è¦å»å°è¯•åˆ é™¤owneräº†) if !found || !ownerNode.isDeletingDependents() { continue } // è¿™æ˜¯è®©attempToDeleteItemæ£€æŸ¥æ˜¯å¦åˆ é™¤äº†ownerçš„ä¾èµ–é¡¹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åˆ é™¤æ‰€æœ‰è€…ã€‚ gb.attemptToDelete.Add(ownerNode) } } return true } è¯¥æ–¹æ³•åŠŸèƒ½ä¸»è¦å°†å¯¹è±¡ã€ownerã€ä»èµ„æºåŠ å…¥åˆ°attemptToDeleteæˆ–attemptToOrphanã€‚\n1ã€ å‡ºé˜Ÿ # ä»graphChangesé˜Ÿåˆ—å–å‡ºèµ„æºå¯¹è±¡ï¼Œä»GraphBuilder.uidToNodeä¸­è¯»å–è¯¥èµ„æºèŠ‚ç‚¹ï¼ˆuidToNodeç»´æŠ¤ç€èµ„æºå¯¹è±¡ä¾èµ–å…³ç³»å›¾è¡¨ç»“æ„ï¼‰ï¼Œfoundä¸ºtrueæ—¶è¡¨ç¤ºå›¾è¡¨å­˜åœ¨è¯¥èµ„æºèŠ‚ç‚¹ï¼›\n2ã€switchçš„ç¬¬ä¸€ä¸ªcase # å¦‚æœè¯¥èµ„æºæ˜¯æ–°å¢æˆ–è€…æ›´æ–°è§¦å‘ï¼Œä¸”è¯¥èµ„æºå¯¹è±¡ä¸å­˜åœ¨äºå›¾è¡¨ä¸­ï¼Œgb.uidToNode.Write(n)ä¼šå°†å…¶å†™å…¥å›¾æ ‡ï¼›\ngb.insertNode(newNode)ä¸­çš„gb.addDependentToOwners(n, n.owners)æ–¹æ³•åˆ™ä¼šéå†è¯¥èµ„æºçš„ownerï¼Œå¦‚æœå…¶ownerä¸å­˜åœ¨äºå›¾æ ‡ä¸­ï¼Œåˆ™æ–°å¢ownerçš„è™šæ‹ŸèŠ‚ç‚¹åˆ°å›¾æ ‡ä¸­ï¼Œå¹¶å°†è¯¥èµ„æºå’Œowneräº§ç”Ÿå…³è”ã€‚å¦‚æœownerä¸å­˜åœ¨æ—¶ï¼Œåˆ™å°è¯•å°†owneråŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ä¸­å»ï¼›\n// addDependentToOwnerså°†næ·»åŠ åˆ°æ‰€æœ‰è€…çš„ä»å±åˆ—è¡¨ä¸­ã€‚å¦‚æœæ‰€æœ‰è€…ä¸å­˜åœ¨äºgb.uidToNodeä¸­ï¼Œåˆ™å°†åˆ›å»º\u0026#34;è™šæ‹Ÿ\u0026#34;èŠ‚ç‚¹ä»¥è¡¨ç¤º // æ‰€æœ‰è€…ã€‚ \u0026#34;è™šæ‹Ÿ\u0026#34;èŠ‚ç‚¹å°†å…¥é˜Ÿåˆ°attemptToDeleteï¼Œå› æ­¤ // attemptToDeleteItem()å°†æ ¹æ®APIæœåŠ¡å™¨éªŒè¯æ‰€æœ‰è€…æ˜¯å¦å­˜åœ¨ã€‚ func (gb *GraphBuilder) addDependentToOwners(n *node, owners []metav1.OwnerReference) { //éå†owner for _, owner := range owners { //è·å–owner nodeå¦‚æœä¸å­˜åœ¨äºå›¾ä¸­,åˆ™åŠ è™šæ‹ŸownerèŠ‚ç‚¹ ownerNode, ok := gb.uidToNode.Read(owner.UID) if !ok { // Create a \u0026#34;virtual\u0026#34; node in the graph for the owner if it doesn\u0026#39;t // exist in the graph yet. //å¦‚æœå›¾å½¢ä¸­å°šæœªå­˜åœ¨ï¼Œåˆ™åœ¨å›¾è¡¨ä¸­ä¸ºæ‰€æœ‰è€…åˆ›å»ºâ€œè™šæ‹Ÿâ€èŠ‚ç‚¹ã€‚ ownerNode = \u0026amp;node{ identity: objectReference{ OwnerReference: owner, Namespace: n.identity.Namespace, }, dependents: make(map[*node]struct{}), virtual: true, } klog.V(5).Infof(\u0026#34;add virtual node.identity: %s\\n\\n\u0026#34;, ownerNode.identity) gb.uidToNode.Write(ownerNode) } //ç»™owneråŠ è¯¥èµ„æºä½œä¸ºä¾èµ– ownerNode.addDependent(n) //ownerä¸å­˜åœ¨äºå›¾ä¸­æ—¶ï¼Œæ‰å¾€åˆ é™¤é˜Ÿåˆ—æ·»åŠ  if !ok { // Enqueue the virtual node into attemptToDelete. // The garbage processor will enqueue a virtual delete // event to delete it from the graph if API server confirms this // owner doesn\u0026#39;t exist. //å°†è™šæ‹ŸèŠ‚ç‚¹æ’å…¥attemptToDeleteã€‚ // å¦‚æœAPIæœåŠ¡å™¨ç¡®è®¤ownerä¸å­˜åœ¨ï¼Œåƒåœ¾å¤„ç†å™¨å°†æ’é˜Ÿè™šæ‹Ÿåˆ é™¤äº‹ä»¶ä»¥å°†å…¶ä»å›¾ä¸­åˆ é™¤ã€‚ gb.attemptToDelete.Add(ownerNode) } } } gb.processTransitionsæ–¹æ³•ï¼š\næ–°itemæ­£åœ¨è¢«åˆ ,æ—§itemæ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºOrphan FinalizeråŠ å…¥åˆ°attemptToOrphané˜Ÿåˆ—ï¼›\næ–°itemæ­£åœ¨è¢«åˆ ,æ—§itemæ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºforegroundDeletion Finalizerï¼Œåˆ™åŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ã€‚\nfunc (gb *GraphBuilder) processTransitions(oldObj interface{}, newAccessor metav1.Object, n *node) { //æ–°çš„æ­£åœ¨è¢«åˆ ,æ—§çš„æ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºOrphan Finalizer if startsWaitingForDependentsOrphaned(oldObj, newAccessor) { klog.V(5).Infof(\u0026#34;add %s to the attemptToOrphan\u0026#34;, n.identity) //åŠ å…¥åˆ°Orphané˜Ÿåˆ— gb.attemptToOrphan.Add(n) return } //æ–°çš„æ­£åœ¨è¢«åˆ ,æ—§çš„æ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºforegroundDeletion Finalizer if startsWaitingForDependentsDeleted(oldObj, newAccessor) { klog.V(2).Infof(\u0026#34;add %s to the attemptToDelete, because it\u0026#39;s waiting for its dependents to be deleted\u0026#34;, n.identity) // if the n is added as a \u0026#34;virtual\u0026#34; node, its deletingDependents field is not properly set, so always set it here. n.markDeletingDependents() for dep := range n.dependents { gb.attemptToDelete.Add(dep) } gb.attemptToDelete.Add(n) } } 3ã€switchçš„ç¬¬äºŒä¸ªcase # å¦‚æœè¯¥èµ„æºæ˜¯æ–°å¢æˆ–è€…æ›´æ–°è§¦å‘ï¼Œä¸”è¯¥èµ„æºå¯¹è±¡å­˜åœ¨äºå›¾è¡¨ä¸­ã€‚å¯¹æ¯”owneReferencesæ˜¯å¦æœ‰å˜æ›´ï¼ŒreferencesDiffsæ–¹æ³•é‡Œä¼šæ ¹æ®uidå¯¹æ¯”ï¼Œaddedè¡¨ç¤ºæ–°owneré‡Œæœ‰,æ—§owneré‡Œæ²¡æœ‰çš„, removedè¡¨ç¤ºæ—§owneré‡Œæœ‰,æ–°owneré‡Œæ²¡æœ‰çš„, changedè¡¨ç¤ºç›¸åŒuidçš„ownerä¸deepEqualçš„ã€‚\nfunc referencesDiffs(old []metav1.OwnerReference, new []metav1.OwnerReference) (added []metav1.OwnerReference, removed []metav1.OwnerReference, changed []ownerRefPair) { //keyä¸ºuid, valueä¸ºOwnerReference oldUIDToRef := make(map[string]metav1.OwnerReference) for _, value := range old { oldUIDToRef[string(value.UID)] = value } oldUIDSet := sets.StringKeySet(oldUIDToRef) //keyä¸ºuid, valueä¸ºOwnerReference newUIDToRef := make(map[string]metav1.OwnerReference) for _, value := range new { newUIDToRef[string(value.UID)] = value } newUIDSet := sets.StringKeySet(newUIDToRef) //æ–°çš„é‡Œæœ‰,æ—§çš„é‡Œæ²¡æœ‰çš„ä¸ºæ–°å¢(æ ¹æ®uidåˆ¤æ–­) addedUID := newUIDSet.Difference(oldUIDSet) //æ—§çš„é‡Œæœ‰,æ–°çš„é‡Œæ²¡æœ‰çš„ä¸ºåˆ é™¤(æ ¹æ®uidåˆ¤æ–­) removedUID := oldUIDSet.Difference(newUIDSet) //å–äº¤é›†, æ—§çš„å’Œæ–°çš„é‡Œéƒ½æœ‰çš„owner(æ ¹æ®uidåˆ¤æ–­) intersection := oldUIDSet.Intersection(newUIDSet) for uid := range addedUID { added = append(added, newUIDToRef[uid]) } for uid := range removedUID { removed = append(removed, oldUIDToRef[uid]) } //æ ¹æ®uidåˆ¤æ–­,ä¸¤ä¸ªuidç›¸ç­‰çš„OwnerReferenceæ˜¯å¦deepEqual,ä¸ç­‰åˆ™åŠ åˆ°changed for uid := range intersection { if !reflect.DeepEqual(oldUIDToRef[uid], newUIDToRef[uid]) { changed = append(changed, ownerRefPair{oldRef: oldUIDToRef[uid], newRef: newUIDToRef[uid]}) } } return added, removed, changed } æ•´ä½“æ¥è¯´ï¼Œownerå‘ç”Ÿå˜åŒ–ï¼ŒaddUnblockedOwnersToDeleteQueueæ–¹æ³•ä¼šåˆ¤æ–­ï¼šå¦‚æœé˜»å¡ownerReferenceæŒ‡å‘æŸä¸ªå¯¹è±¡è¢«åˆ é™¤ï¼Œæˆ–è€…è®¾ç½®ä¸ºBlockOwnerDeletion=falseï¼Œåˆ™å°†è¯¥å¯¹è±¡æ·»åŠ åˆ°attemptToDeleteé˜Ÿåˆ—ï¼›\n// if an blocking ownerReference points to an object gets removed, or gets set to // \u0026#34;BlockOwnerDeletion=false\u0026#34;, add the object to the attemptToDelete queue. //å¦‚æœé˜»å¡ownerReferenceæŒ‡å‘æŸä¸ªå¯¹è±¡è¢«åˆ é™¤ï¼Œæˆ–è€…è®¾ç½®ä¸º // \u0026#34;BlockOwnerDeletion = false\u0026#34;ï¼Œåˆ™å°†è¯¥å¯¹è±¡æ·»åŠ åˆ°attemptToDeleteé˜Ÿåˆ—ã€‚ func (gb *GraphBuilder) addUnblockedOwnersToDeleteQueue(removed []metav1.OwnerReference, changed []ownerRefPair) { for _, ref := range removed { //è¢«ç§»é™¤çš„OwnersReferences,BlockOwnerDeletionä¸ºtrue if ref.BlockOwnerDeletion != nil \u0026amp;\u0026amp; *ref.BlockOwnerDeletion { //ä¾èµ–å›¾è¡¨ä¸­å‘ç°,åˆ™åŠ å…¥åˆ é™¤é˜Ÿåˆ— node, found := gb.uidToNode.Read(ref.UID) if !found { klog.V(5).Infof(\u0026#34;cannot find %s in uidToNode\u0026#34;, ref.UID) continue } //åŠ å…¥å°è¯•åˆ é™¤é˜Ÿåˆ—åˆ é™¤è¿™ä¸ªowner gb.attemptToDelete.Add(node) } } // Ownerså­˜åœ¨ä¸”å‘ç”Ÿå˜åŒ–,æ—§çš„BlockOwnerDeletionä¸ºtrue, æ–°çš„BlockOwnerDeletionä¸ºç©ºæˆ–è€…BlockOwnerDeletionä¸ºfalseåˆ™åˆ é™¤owner(çˆ¶èŠ‚ç‚¹) for _, c := range changed { wasBlocked := c.oldRef.BlockOwnerDeletion != nil \u0026amp;\u0026amp; *c.oldRef.BlockOwnerDeletion isUnblocked := c.newRef.BlockOwnerDeletion == nil || (c.newRef.BlockOwnerDeletion != nil \u0026amp;\u0026amp; !*c.newRef.BlockOwnerDeletion) if wasBlocked \u0026amp;\u0026amp; isUnblocked { node, found := gb.uidToNode.Read(c.newRef.UID) if !found { klog.V(5).Infof(\u0026#34;cannot find %s in uidToNode\u0026#34;, c.newRef.UID) continue } gb.attemptToDelete.Add(node) } } } æ›´æ–°nodeçš„ownerï¼›\nåœ¨ä¾èµ–å›¾è¡¨ä¸­ç»™æ–°owneræ·»åŠ è¯¥nodeï¼›\nåœ¨ä¾èµ–å›¾è¡¨ä¸­,è¢«åˆ é™¤çš„owneråˆ—è¡¨ä¸‹åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚\ngb.processTransitionsæ–¹æ³•ï¼š\næ–°itemæ­£åœ¨è¢«åˆ ,æ—§itemæ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºOrphan FinalizeråŠ å…¥åˆ°attemptToOrphané˜Ÿåˆ—ï¼›\næ–°itemæ­£åœ¨è¢«åˆ ,æ—§itemæ²¡å¼€å§‹è¢«åˆ é™¤,ä¸”ç»ˆç»“å™¨ä¸ºforegroundDeletion Finalizerï¼Œåˆ™åŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ã€‚\n4ã€switchçš„ç¬¬ä¸‰ä¸ªcase # å¦‚æœè¯¥èµ„æºæ˜¯åˆ é™¤æ—¶è§¦å‘ï¼Œä»å›¾è¡¨ä¸­ç§»é™¤itemèµ„æºï¼ŒåŒæ—¶éå†ownersï¼Œç§»é™¤ownerä¸‹çš„itemèµ„æºï¼›\nå¦‚æœè¯¥èµ„æºçš„ä»èµ„æºæ•°å¤§äº0,åˆ™å°†è¯¥èµ„æºè¢«åˆ é™¤ä¿¡æ¯ï¼ˆuidï¼‰åŠ å…¥absentOwnerCacheç¼“å­˜ï¼Œè¿™æ ·å¤„ç†è¯¥èµ„æºçš„ä»èµ„æºæ—¶ï¼Œå°±çŸ¥é“ownerä¸å­˜åœ¨äº†ã€‚\néå†è¯¥èµ„æºçš„ä»èµ„æºåŠ åˆ°åˆ é™¤é˜Ÿåˆ—é‡Œï¼›\nå¦‚æœä»å›¾è¡¨ä¸­å‘ç° owneræˆ–è€… ownerçš„ä»èµ„æºæ­£åœ¨è¢«åˆ é™¤ï¼Œåˆ™å°è¯•å°†owneråŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ä¸­ï¼Œå»å°è¯•åˆ é™¤ownerã€‚\næ•´ç†æµç¨‹ # å½“controllermanageré‡å¯æ—¶ï¼Œä¼šå…¨é‡listwatchä¸€éæ‰€æœ‰å¯¹è±¡ï¼Œgc collectorç»´æŠ¤çš„uidToNodeå›¾è¡¨é‡Œå„ä¸ªèµ„æºå¯¹è±¡nodeæ˜¯ä¸å­˜åœ¨çš„ï¼Œæ­¤æ—¶ä¼šèµ°ç¬¬ä¸€ä¸ªswitch caseï¼Œæ„å»ºå®Œæ•´å…³ç³»å›¾è¡¨ï¼Œå¦‚æœownerä¸å­˜åœ¨åˆ™å…ˆæ„å»ºè™šæ‹ŸownerèŠ‚ç‚¹ï¼ŒåŒæ—¶åŠ å…¥attemptToDeleteé˜Ÿåˆ—ï¼Œå°è¯•å»åˆ é™¤è¿™ä¸ªownerï¼Œå…¶å®å³ä½¿åŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ï¼Œä¹Ÿä¸ä¸€å®šä¼šè¢«åˆ é™¤ï¼Œè¿˜ä¼šè¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­ï¼Œè¿™ä¸ªä¸‹ä¸€èŠ‚å†åˆ†æï¼›å°†æ­£åœ¨åˆ é™¤çš„èµ„æºï¼ŒåŒæ—¶Finalizerä¸ºOrphançš„åŠ å…¥åˆ°attemptToOrphané˜Ÿåˆ—ï¼›ä¸ºforegroundçš„èµ„æºä»¥åŠå…¶ä»èµ„æºåŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ï¼Œå¹¶å°†deletingDependentsè®¾ç½®ä¸ºtrueï¼› æ·»åŠ æˆ–è€…æ›´æ–°äº‹ä»¶æ—¶ï¼Œä¸”å›¾è¡¨ä¸­å­˜åœ¨itemèµ„æºå¯¹è±¡æ—¶ï¼Œä¼šèµ°ç¬¬äºŒä¸ªswitch caseï¼Œå¯¹itemçš„ownerå˜åŒ–è¿›è¡Œåˆ¤æ–­ï¼Œå¹¶ç»´æŠ¤æ›´æ–°å›¾è¡¨ï¼›åŒç†å°†æ­£åœ¨åˆ é™¤çš„èµ„æºï¼ŒåŒæ—¶Finalizerä¸ºOrphançš„åŠ å…¥åˆ°attemptToOrphané˜Ÿåˆ—ï¼›Finalizerä¸ºforegroundçš„èµ„æºä»¥åŠå…¶ä»èµ„æºåŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ï¼Œå¹¶å°†deletingDependentsè®¾ç½®ä¸ºtrueï¼› å¦‚æœæ˜¯åˆ é™¤äº‹ä»¶ï¼Œåˆ™ä¼šæ›´æ–°å›¾è¡¨ï¼Œå¹¶å¤„ç†å’Œå…¶ç›¸å…³çš„ä»èµ„æºå’Œå…¶owneråŠ å…¥åˆ°attemptToDeleteé˜Ÿåˆ—ã€‚ å‚è€ƒï¼š # k8så®˜æ–¹æ–‡æ¡£garbage-collectionè‹±æ–‡ç‰ˆï¼š\nhttps://kubernetes.io/docs/concepts/workloads/controllers/garbage-collection/\nä¾èµ–å›¾æ ‡ç”Ÿæˆåº“gonum Apiæ–‡æ¡£ï¼š\nhttps://godoc.org/gonum.org/v1/gonum/graph\ngraphvizä¸‹è½½ï¼š\nhttps://graphviz.gitlab.io/_pages/Download/Download_windows.html\n","date":"2019å¹´10æœˆ16æ—¥","externalUrl":null,"permalink":"/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%8E%A7%E5%88%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%BA%8C/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190103.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003ekubernetesç‰ˆæœ¬ï¼š1.13.2\u003c/strong\u003e\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eæ¥ä¸Šä¸€èŠ‚ï¼š\n\u003ca href=\"https://kubeinfo.cn/go/?target=aHR0cHM6Ly9saWFiaW8uYmxvZy5jc2RuLm5ldC9hcnRpY2xlL2RldGFpbHMvMTAwMDgxOTQx\" target=\"_blank\" \u003ekubernetesåƒåœ¾å›æ”¶å™¨GarbageCollector Controlleræºç åˆ†æï¼ˆä¸€ï¼‰\u003c/a\u003e\u003c/p\u003e","title":"kubernetesåƒåœ¾å›æ”¶å™¨GarbageCollectoræ§åˆ¶å™¨æºç åˆ†æï¼ˆäºŒï¼‰","type":"posts"},{"content":" kubernetesç‰ˆæœ¬ï¼š1.13.2\nèƒŒæ™¯ # ç”±äºoperatoråˆ›å»ºçš„redisé›†ç¾¤ï¼Œåœ¨kubernetes apiserveré‡å¯åï¼Œredisé›†ç¾¤è¢«å¼‚å¸¸åˆ é™¤ï¼ˆåŒ…æ‹¬redis exporter statefulsetã€redis statefulsetï¼‰ã€‚åˆ é™¤åoperatorå°†å…¶é‡å»ºï¼Œé‡æ–°ç»„å»ºé›†ç¾¤ï¼Œå®ä¾‹IPå‘ç”Ÿå˜æ›´ï¼ˆä¸­é—´ä»¶å®¹å™¨åŒ–ï¼Œæˆ‘ä»¬å¼€å‘äº†å›ºå®šIPï¼Œå½“statefulsetåˆ é™¤åï¼ŒIPä¼šè¢«å›æ”¶ï¼‰ï¼Œå¯¼è‡´åˆ›å»ºé›†ç¾¤å¤±è´¥ï¼Œæœ€ç»ˆé›†ç¾¤ä¸å¯ç”¨ã€‚\nç»å¤šæ¬¡å¤ç°ï¼Œapiserveré‡å¯åï¼Œé€šè¿‡æŸ¥è¯¢redis operatoræ—¥å¿—ï¼Œå¹¶æ²¡æœ‰å‘ç°ä¸»åŠ¨å»åˆ é™¤redisé›†ç¾¤ï¼ˆredis statefulsetï¼‰ã€ç›‘æ§å®ä¾‹ï¼ˆredis exporterï¼‰ã€‚è¿›ä¸€æ­¥å»æŸ¥çœ‹kube-controller-managerçš„æ—¥å¿—ï¼Œå°†å…¶æ—¥å¿—çº§åˆ«è®¾ç½®\u0026ndash;v=5ï¼Œç»§ç»­å¤ç°ï¼Œæœ€ç»ˆåœ¨kube-controller-manageræ—¥å¿—ä¸­å‘ç°å¦‚ä¸‹æ—¥å¿—ï¼š\nå¯ä»¥çœ‹åˆ°æ˜¯garbage collectorè§¦å‘åˆ é™¤æ“ä½œçš„ã€‚è¿™ä¸ªé—®é¢˜åœ¨apiserveræ­£å¸¸çš„æ—¶å€™æ˜¯ä¸å­˜åœ¨ï¼Œè¦æƒ³å¼„å…¶ç©¶ç«Ÿï¼Œå°±å¾—çœ‹çœ‹kube-controller-managerå†…ç½®ç»„ä»¶garbage collectorè¿™ä¸ªæ§åˆ¶å™¨çš„é€»è¾‘ã€‚\nç”±äºå†…å®¹åé•¿ï¼Œåˆ†ä¸ºå¤šèŠ‚æ¥è®²ï¼š\nmonitorsä½œä¸ºç”Ÿäº§è€…å°†å˜åŒ–çš„èµ„æºæ”¾å…¥graphChangesé˜Ÿåˆ—ï¼›åŒæ—¶restMapperå®šæœŸæ£€æµ‹é›†ç¾¤å†…èµ„æºç±»å‹ï¼Œåˆ·æ–°monitors runProcessGraphChangesä»graphChangesé˜Ÿåˆ—ä¸­å–å‡ºå˜åŒ–çš„itemï¼Œæ ¹æ®æƒ…å†µæ”¾å…¥attemptToDeleteé˜Ÿåˆ—ï¼› runProcessGraphChangesä»graphChangesé˜Ÿåˆ—ä¸­å–å‡ºå˜åŒ–çš„itemï¼Œæ ¹æ®æƒ…å†µæ”¾å…¥attemptToOrphané˜Ÿåˆ—ï¼› runAttemptToDeleteWorkerä»attemptToDeleteé˜Ÿåˆ—å–å‡ºï¼Œå°è¯•åˆ é™¤åƒåœ¾èµ„æºï¼› runAttemptToOrphanWorkerä»attemptToOrphané˜Ÿåˆ—å–å‡ºï¼Œå¤„ç†è¯¥å­¤ç«‹çš„èµ„æºï¼›\næ­£æ–‡ # æƒ³è¦å¯ç”¨GCï¼Œéœ€è¦åœ¨kube-apiserverå’Œkube-controller-managerçš„å¯åŠ¨å‚æ•°ä¸­éƒ½è®¾ç½®--enable-garbage-collectorä¸ºtrue,1.13.2ç‰ˆæœ¬ä¸­é»˜è®¤å¼€å¯GCã€‚\néœ€è¦æ³¨æ„ï¼šä¸¤ç»„ä»¶è¯¥å‚æ•°å¿…é¡»ä¿æŒåŒæ­¥ã€‚\nkube-controller-managerå¯åŠ¨å…¥å£ï¼Œapp.NewControllerManagerCommand()ä¸­åŠ è½½controller manageré»˜è®¤å¯åŠ¨å‚æ•°ï¼Œåˆ›å»º* cobra.Commandå¯¹è±¡ï¼š\nfunc main() { rand.Seed(time.Now().UnixNano()) //åŠ è½½controller manageré»˜è®¤å¯åŠ¨å‚æ•°ï¼Œåˆ›å»º* cobra.Commandå¯¹è±¡ command := app.NewControllerManagerCommand() //......çœç•¥....... //æ‰§è¡Œcobra.commandï¼Œå¹¶å¯åŠ¨controller-manager if err := command.Execute(); err != nil { fmt.Fprintf(os.Stderr, \u0026#34;%v\\n\u0026#34;, err) os.Exit(1) } } ä»¥ä¸‹ä»£ç å¤„å»å¯åŠ¨kube-controller-managerï¼š\nNewDefaultComponentConfig(ports.InsecureKubeControllerManagerPort)åŠ è½½å„ä¸ªæ§åˆ¶å™¨çš„é…ç½®ï¼š\n//NewKubeControllerManagerOptionsä½¿ç”¨é»˜è®¤é…ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„KubeControllerManagerOptions func NewKubeControllerManagerOptions() (*KubeControllerManagerOptions, error) { //åŠ è½½å„ä¸ªæ§åˆ¶å™¨çš„é»˜è®¤é…ç½® componentConfig, err := NewDefaultComponentConfig(ports.InsecureKubeControllerManagerPort) if err != nil { return nil, err } s := KubeControllerManagerOptions{ Generic: cmoptions.NewGenericControllerManagerConfigurationOptions(componentConfig.Generic), //.....çœç•¥ GarbageCollectorController: \u0026amp;GarbageCollectorControllerOptions{ ConcurrentGCSyncs: componentConfig.GarbageCollectorController.ConcurrentGCSyncs, EnableGarbageCollector: componentConfig.GarbageCollectorController.EnableGarbageCollector, }, //.....çœç•¥ } //gcå¿½ç•¥çš„èµ„æºå¯¹è±¡åˆ—è¡¨ gcIgnoredResources := make([]kubectrlmgrconfig.GroupResource, 0, len(garbagecollector.DefaultIgnoredResources())) for r := range garbagecollector.DefaultIgnoredResources() { gcIgnoredResources = append(gcIgnoredResources, kubectrlmgrconfig.GroupResource{Group: r.Group, Resource: r.Resource}) } s.GarbageCollectorController.GCIgnoredResources = gcIgnoredResources return \u0026amp;s, nil } // NewDefaultComponentConfigè¿”å›kube-controllerç®¡ç†å™¨é…ç½®å¯¹è±¡ func NewDefaultComponentConfig(insecurePort int32) (kubectrlmgrconfig.KubeControllerManagerConfiguration, error) { scheme := runtime.NewScheme() if err := kubectrlmgrschemev1alpha1.AddToScheme(scheme); err != nil { return kubectrlmgrconfig.KubeControllerManagerConfiguration{}, err } if err := kubectrlmgrconfig.AddToScheme(scheme); err != nil { return kubectrlmgrconfig.KubeControllerManagerConfiguration{}, err } versioned := kubectrlmgrconfigv1alpha1.KubeControllerManagerConfiguration{} //åŠ è½½é»˜è®¤å‚æ•° scheme.Default(\u0026amp;versioned) internal := kubectrlmgrconfig.KubeControllerManagerConfiguration{} if err := scheme.Convert(\u0026amp;versioned, \u0026amp;internal, nil); err != nil { return internal, err } internal.Generic.Port = insecurePort return internal, nil } // æ ¹æ®Objectï¼Œè·å–æä¾›çš„é»˜è®¤å‚æ•° func (s *Scheme) Default(src Object) { if fn, ok := s.defaulterFuncs[reflect.TypeOf(src)]; ok { fn(src) } } s.defaulterFuncsç±»å‹ä¸ºmap[reflect.Type]func(interface{})ï¼Œç”¨äºæ ¹æ®æŒ‡é’ˆç±»å‹è·å–é»˜è®¤å€¼å‡½æ•°ã€‚è¯¥mapä¸­çš„æ•°æ®ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ\nä»£ç ä½äºsrc\\k8s.io\\kubernetes\\pkg\\controller\\apis\\config\\v1alpha1\\zz_generated.defaults.go\nå¯ä»¥çœ‹åˆ°é»˜è®¤å‚æ•°ä¸­garbage collectorä¸­é»˜è®¤å¼€å¯gcï¼ˆEnableGarbageCollectorï¼‰ï¼Œå¹¶å‘æ•°ä¸º20ï¼ˆConcurrentGCSyncsï¼‰\nfunc SetDefaults_GarbageCollectorControllerConfiguration(obj *kubectrlmgrconfigv1alpha1.GarbageCollectorControllerConfiguration) { if obj.EnableGarbageCollector == nil { obj.EnableGarbageCollector = utilpointer.BoolPtr(true) } if obj.ConcurrentGCSyncs == 0 { obj.ConcurrentGCSyncs = 20 } } å›åˆ°Runå‡½æ•°ï¼Œé‡Œé¢è°ƒç”¨äº†NewControllerInitializerså¯åŠ¨æ‰€æœ‰æ§åˆ¶å™¨ï¼š\né‡ç‚¹æ¥åˆ°å¯åŠ¨garbage collectorçš„startGarbageCollectorControllerå‡½æ•°ï¼š\nfunc startGarbageCollectorController(ctx ControllerContext) (http.Handler, bool, error) { //k8s 1.13.2ä¸­é»˜è®¤ä¸ºtrue,å¯åœ¨kube-apiserverå’Œkube-controller-managerçš„å¯åŠ¨å‚æ•°ä¸­åŠ --enable-garbage-conllector=falseè®¾ç½® //éœ€ä¿è¯è¿™ä¸¤ä¸ªç»„ä»¶ä¸­å‚æ•°å€¼ä¸€è‡´ if !ctx.ComponentConfig.GarbageCollectorController.EnableGarbageCollector { return nil, false, nil } //k8så„ç§åŸç”Ÿèµ„æºå¯¹è±¡å®¢æˆ·ç«¯é›†åˆ(é»˜è®¤å¯åŠ¨å‚æ•°ä¸­ç”¨SimpleControllerClientBuilderæ„å»º) gcClientset := ctx.ClientBuilder.ClientOrDie(\u0026#34;generic-garbage-collector\u0026#34;) discoveryClient := cacheddiscovery.NewMemCacheClient(gcClientset.Discovery()) //ç”Ÿæˆrest config config := ctx.ClientBuilder.ConfigOrDie(\u0026#34;generic-garbage-collector\u0026#34;) dynamicClient, err := dynamic.NewForConfig(config) if err != nil { return nil, true, err } // Get an initial set of deletable resources to prime the garbage collector. //è·å–ä¸€ç»„åˆå§‹å¯åˆ é™¤èµ„æºä»¥å¡«å……åƒåœ¾æ”¶é›†å™¨ã€‚ deletableResources := garbagecollector.GetDeletableResources(discoveryClient) ignoredResources := make(map[schema.GroupResource]struct{}) //å¿½ç•¥gcçš„èµ„æºç±»å‹ for _, r := range ctx.ComponentConfig.GarbageCollectorController.GCIgnoredResources { ignoredResources[schema.GroupResource{Group: r.Group, Resource: r.Resource}] = struct{}{} } garbageCollector, err := garbagecollector.NewGarbageCollector( dynamicClient, ctx.RESTMapper, deletableResources, ignoredResources, ctx.InformerFactory, ctx.InformersStarted, ) if err != nil { return nil, true, fmt.Errorf(\u0026#34;Failed to start the generic garbage collector: %v\u0026#34;, err) } // Start the garbage collector. //å¯åŠ¨å‚æ•°ä¸­é»˜è®¤æ˜¯20ä¸ªåç¨‹ workers := int(ctx.ComponentConfig.GarbageCollectorController.ConcurrentGCSyncs) //å¯åŠ¨monitorså’ŒdeleteWorkersã€orphanWorkers go garbageCollector.Run(workers, ctx.Stop) // Periodically refresh the RESTMapper with new discovery information and sync // the garbage collector. //ä½¿ç”¨æ–°çš„å‘ç°ä¿¡æ¯å®šæœŸåˆ·æ–°RESTMapperå¹¶åŒæ­¥åƒåœ¾æ”¶é›†å™¨ã€‚ go garbageCollector.Sync(gcClientset.Discovery(), 30*time.Second, ctx.Stop) //gcæä¾›debug dot grapä¾èµ–å…³ç³»å›¾æ¥å£ return garbagecollector.NewDebugHandler(garbageCollector), true, nil } è¯¥å‡½æ•°ä¸»è¦ä½œç”¨æœ‰ï¼š\n1ã€deletableResources := garbagecollector.GetDeletableResources(discoveryClient)è·å–é›†ç¾¤å†…æ‰€æœ‰å¯åˆ é™¤çš„èµ„æºå¯¹è±¡ï¼›æ’é™¤æ‰å¿½ç•¥çš„èµ„æºå¯¹è±¡ã€‚\n2ã€æ„å»ºgarbageCollectorç»“æ„ä½“å¯¹è±¡ï¼›\n3ã€garbageCollector.Run(workers, ctx.Stop)å¯åŠ¨ä¸€ä¸ªmonitorsç”¨æ¥ç›‘å¬èµ„æºå¯¹è±¡çš„å˜åŒ–ï¼ˆå¯¹åº”çš„ç”±runProcessGraphChangesæ­»å¾ªç¯å¤„ç†ï¼‰ï¼Œå’Œé»˜è®¤20ä¸ªdeleteWorkersåç¨‹å¤„ç†å¯åˆ é™¤çš„èµ„æºå¯¹è±¡ã€20ä¸ªorphanWorkersåç¨‹å¤„ç†å­¤å„¿å¯¹è±¡ã€‚\n4ã€garbageCollector.Sync(gcClientset.Discovery(), 30*time.Second, ctx.Stop) å®šæ—¶å»è·å–ä¸€ä¸ªé›†ç¾¤å†…æ˜¯å¦æœ‰æ–°ç±»å‹çš„èµ„æºå¯¹è±¡çš„åŠ å…¥ï¼Œå¹¶é‡æ–°åˆ·æ–°monitorsï¼Œä»¥ç›‘å¬æ–°ç±»å‹çš„èµ„æºå¯¹è±¡ã€‚\n5ã€garbagecollector.NewDebugHandler(garbageCollector)æ³¨å†Œdebugæ¥å£ï¼Œç”¨æ¥æä¾›è·å–dotæµç¨‹å›¾æ¥å£ï¼š\ncurl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph?uid=11211212edsaddkqedmk12 ä½¿ç”¨graphvizæä¾›çš„dot.exeå¯ä»¥ç”Ÿæˆsvgæ ¼å¼çš„å›¾ï¼Œå¯ç”¨googleæµè§ˆå™¨æŸ¥çœ‹å¦‚ä¸‹ï¼š\n// curl http://127.0.0.1:10252/debug/controllers/garbagecollector/graph?uid=11211212edsaddkqedmk12 func (h *debugHTTPHandler) ServeHTTP(w http.ResponseWriter, req *http.Request) { if req.URL.Path != \u0026#34;/graph\u0026#34; { http.Error(w, \u0026#34;\u0026#34;, http.StatusNotFound) return } var graph graph.Directed if uidStrings := req.URL.Query()[\u0026#34;uid\u0026#34;]; len(uidStrings) \u0026gt; 0 { uids := []types.UID{} for _, uidString := range uidStrings { uids = append(uids, types.UID(uidString)) } graph = h.controller.dependencyGraphBuilder.uidToNode.ToGonumGraphForObj(uids...) } else { graph = h.controller.dependencyGraphBuilder.uidToNode.ToGonumGraph() } //ç”Ÿæˆdotæµç¨‹å›¾æ•°æ®,ç”¨graphvizå·¥å…·ä¸­çš„dot.exeå·¥å…·è½¬æ¢ä¸ºsvgå›¾(ç”¨googleæµè§ˆå™¨æ‰“å¼€)æˆ–è€…pngå›¾ //APIå‚è€ƒ:https://godoc.org/gonum.org/v1/gonum/graph //graphvizä¸‹è½½åœ°å€:https://graphviz.gitlab.io/_pages/Download/Download_windows.html //dot.exe test.dot -T svg -o test.svg data, err := dot.Marshal(graph, \u0026#34;full\u0026#34;, \u0026#34;\u0026#34;, \u0026#34; \u0026#34;, false) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } w.Write(data) w.WriteHeader(http.StatusOK) } GarbageCollectoré€šè¿‡restMapperå®šæœŸé‡ç½®å¯åˆ é™¤çš„èµ„æºç±»å‹ï¼Œæ›´æ–°GraphBuilderä¸­çš„monitorsï¼Œmonitorså°†åˆ›å»ºæ‰€æœ‰èµ„æºç±»å‹çš„å˜æ›´é€šçŸ¥å›è°ƒå‡½æ•°ï¼Œå°†å˜åŒ–çš„èµ„æºå¯¹è±¡åŠ å…¥åˆ°GraphBuilderçš„graphChangesé˜Ÿåˆ—ï¼ŒGraphBuilderçš„runProcessGraphChanges()ä¼šä¸€ç›´ä»é˜Ÿåˆ—ä¸­è·å–å˜åŒ–ï¼Œæ„å»ºä¸€ä¸ªç¼“å­˜å¯¹è±¡ä¹‹é—´ä¾èµ–å…³ç³»çš„å›¾å½¢ï¼Œä»¥åŠè§¦å‘dependencyGraphBuilderå°†å¯èƒ½è¢«åƒåœ¾æ”¶é›†çš„å¯¹è±¡æ’é˜Ÿåˆ°attemptToDeleteé˜Ÿåˆ—ï¼Œå¹¶å°†å…¶ä¾èµ–é¡¹éœ€è¦å­¤ç«‹çš„å¯¹è±¡æ’é˜Ÿåˆ°attemptToOrphané˜Ÿåˆ—ã€‚GarbageCollectorå…·æœ‰ä½¿ç”¨è¿™ä¸¤ä¸ªé˜Ÿåˆ—çš„å·¥ä½œäººå‘˜runAttemptToDeleteWorkerå’ŒrunAttemptToOrphanWorkeræ­»å¾ªç¯ï¼Œåˆ†åˆ«ä»attemptToDeleteé˜Ÿåˆ—å’ŒattemptToOrphané˜Ÿåˆ—å–å‡ºï¼Œå‘APIæœåŠ¡å™¨å‘é€è¯·æ±‚ä»¥ç›¸åº”åœ°åˆ é™¤æ›´æ–°å¯¹è±¡ã€‚\n// GarbageCollectorè¿è¡Œåå°„å™¨æ¥ç›‘è§†æ‰˜ç®¡APIå¯¹è±¡çš„æ›´æ”¹ï¼Œå°†ç»“æœæ±‡æ€»åˆ°å•çº¿ç¨‹dependencyGraphBuilderï¼Œ // æ„å»ºä¸€ä¸ªç¼“å­˜å¯¹è±¡ä¹‹é—´ä¾èµ–å…³ç³»çš„å›¾å½¢ã€‚ç”±å›¾å˜åŒ–è§¦å‘ï¼ŒdependencyGraphBuilderå°†å¯èƒ½è¢«åƒåœ¾æ”¶é›†çš„å¯¹è±¡ // æ’é˜Ÿåˆ°`attemptToDelete`é˜Ÿåˆ—ï¼Œå¹¶å°†å…¶ä¾èµ–é¡¹éœ€è¦å­¤ç«‹çš„å¯¹è±¡æ’é˜Ÿåˆ°`attemptToOrphan`é˜Ÿåˆ—ã€‚ // GarbageCollectorå…·æœ‰ä½¿ç”¨è¿™ä¸¤ä¸ªé˜Ÿåˆ—çš„å·¥ä½œäººå‘˜ï¼Œå‘APIæœåŠ¡å™¨å‘é€è¯·æ±‚ä»¥ç›¸åº”åœ°åˆ é™¤æ›´æ–°å¯¹è±¡ã€‚ // è¯·æ³¨æ„ï¼Œè®©dependencyGraphBuilderé€šçŸ¥åƒåœ¾æ”¶é›†å™¨ç¡®ä¿åƒåœ¾æ”¶é›†å™¨ä½¿ç”¨è‡³å°‘ä¸å‘é€é€šçŸ¥ä¸€æ ·æœ€æ–°çš„å›¾å½¢è¿›è¡Œæ“ä½œã€‚ type GarbageCollector struct { // resettableRESTMapperæ˜¯ä¸€ä¸ªRESTMapperï¼Œå®ƒèƒ½å¤Ÿåœ¨discoveryèµ„æºç±»å‹æ—¶é‡ç½®è‡ªå·± restMapper resettableRESTMapper // dynamicClientæä¾›æ“ä½œé›†ç¾¤å†…æ‰€æœ‰èµ„æºå¯¹è±¡çš„æ¥å£æ–¹æ³•,åŒ…æ‹¬k8så†…ç½®ã€CRDç”Ÿæˆçš„è‡ªå®šä¹‰èµ„æº dynamicClient dynamic.Interface //åƒåœ¾æ”¶é›†å™¨å°è¯•åœ¨æ—¶é—´æˆç†Ÿæ—¶åˆ é™¤attemptToDeleteé˜Ÿåˆ—ä¸­çš„item attemptToDelete workqueue.RateLimitingInterface //åƒåœ¾æ”¶é›†å™¨å°è¯•å­¤ç«‹attemptToOrphané˜Ÿåˆ—ä¸­itemçš„ä¾èµ–é¡¹ï¼Œç„¶ååˆ é™¤item attemptToOrphan workqueue.RateLimitingInterface dependencyGraphBuilder *GraphBuilder // æœ‰ownerçš„èµ„æºå¯¹è±¡,æ‰ä¼šç»™absentOwnerCacheå¡«å……ä¸å­˜åœ¨çš„Ownerä¿¡æ¯ absentOwnerCache *UIDCache sharedInformers informers.SharedInformerFactory workerLock sync.RWMutex } // GraphBuilderï¼šåŸºäºinformersæä¾›çš„äº‹ä»¶ï¼ŒGraphBuilderæ›´æ–° // uidToNodeï¼Œä¸€ä¸ªç¼“å­˜æˆ‘ä»¬æ‰€çŸ¥çš„ä¾èµ–å…³ç³»çš„å›¾ï¼Œå¹¶å°† // é¡¹æ”¾å…¥attemptToDeleteå’ŒattemptToOrphané˜Ÿåˆ— type GraphBuilder struct { restMapper meta.RESTMapper //æ¯ä¸ªç›‘è§†å™¨åˆ—è¡¨/ç›‘è§†èµ„æºï¼Œç»“æœæ±‡é›†åˆ°dependencyGraphBuilder monitors monitors monitorLock sync.RWMutex // informersStarted is closed after after all of the controllers have been initialized and are running. // After that it is safe to start them here, before that it is not. // informersStartedåœ¨æ‰€æœ‰æ§åˆ¶å™¨åˆå§‹åŒ–å¹¶è¿è¡Œåå…³é—­ã€‚ä¹‹ååœ¨è¿™é‡Œå¯åŠ¨å®ƒä»¬æ˜¯å®‰å…¨çš„ï¼Œåœ¨æ­¤ä¹‹å‰å®ƒä¸æ˜¯ã€‚ informersStarted \u0026lt;-chan struct{} // stopCh drives shutdown. When a receive from it unblocks, monitors will shut down. // This channel is also protected by monitorLock. // stopChé©±åŠ¨å™¨å…³é—­å½“æ¥è‡ªå®ƒçš„æ¥æ”¶è§£é™¤é˜»å¡æ—¶ï¼Œç›‘è§†å™¨å°†å…³é—­ã€‚ æ­¤channelä¹Ÿå—monitorLockä¿æŠ¤ã€‚ stopCh \u0026lt;-chan struct{} // running tracks whether Run() has been called. // it is protected by monitorLock. //è¿è¡Œè½¨é“æ˜¯å¦å·²è°ƒç”¨Run()å®ƒå—monitorLockä¿æŠ¤ã€‚ running bool dynamicClient dynamic.Interface // monitors are the producer of the graphChanges queue, graphBuilder alters // the in-memory graph according to the changes. // monitoræ˜¯graphChangesé˜Ÿåˆ—çš„ç”Ÿæˆè€…ï¼ŒgraphBuilderæ ¹æ®æ›´æ”¹æ”¹å˜äº†å†…å­˜ä¸­çš„å›¾å½¢ã€‚ graphChanges workqueue.RateLimitingInterface // uidToNode doesn\u0026#39;t require a lock to protect, because only the // single-threaded GraphBuilder.processGraphChanges() reads/writes it. //uidToNodeä¸éœ€è¦é”ä¿æŠ¤ï¼Œå› ä¸ºåªæœ‰å•çº¿ç¨‹GraphBuilder.processGraphChanges()è¯»å†™å®ƒã€‚ uidToNode *concurrentUIDToNode // GraphBuilder is the producer of attemptToDelete and attemptToOrphan, GC is the consumer. // GraphBuilderæ˜¯attemptToDeleteå’ŒattemptToOrphançš„ç”Ÿäº§è€…ï¼ŒGCæ˜¯æ¶ˆè´¹è€…ã€‚ attemptToDelete workqueue.RateLimitingInterface attemptToOrphan workqueue.RateLimitingInterface // GraphBuilder and GC share the absentOwnerCache. Objects that are known to // be non-existent are added to the cached. // GraphBuilderå’ŒGCå…±äº«absentOwnerCacheã€‚å·²çŸ¥ä¸å­˜åœ¨çš„å¯¹è±¡å°†æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚ absentOwnerCache *UIDCache //æ‰€æœ‰k8sèµ„æºå¯¹è±¡é›†çš„informer sharedInformers informers.SharedInformerFactory //ç›‘è§†å™¨å¿½ç•¥çš„èµ„æºå¯¹è±¡é›† ignoredResources map[schema.GroupResource]struct{} } åˆ›å»ºNewGarbageCollectorç»“æ„ä½“ï¼š\nfunc NewGarbageCollector( dynamicClient dynamic.Interface, mapper resettableRESTMapper, deletableResources map[schema.GroupVersionResource]struct{}, ignoredResources map[schema.GroupResource]struct{}, sharedInformers informers.SharedInformerFactory, informersStarted \u0026lt;-chan struct{}, ) (*GarbageCollector, error) { attemptToDelete := workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \u0026#34;garbage_collector_attempt_to_delete\u0026#34;) attemptToOrphan := workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \u0026#34;garbage_collector_attempt_to_orphan\u0026#34;) absentOwnerCache := NewUIDCache(500) gc := \u0026amp;GarbageCollector{ dynamicClient: dynamicClient, restMapper: mapper, attemptToDelete: attemptToDelete, attemptToOrphan: attemptToOrphan, absentOwnerCache: absentOwnerCache, } gb := \u0026amp;GraphBuilder{ dynamicClient: dynamicClient, informersStarted: informersStarted, restMapper: mapper, graphChanges: workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \u0026#34;garbage_collector_graph_changes\u0026#34;), uidToNode: \u0026amp;concurrentUIDToNode{ uidToNode: make(map[types.UID]*node), }, attemptToDelete: attemptToDelete, attemptToOrphan: attemptToOrphan, absentOwnerCache: absentOwnerCache, sharedInformers: sharedInformers, ignoredResources: ignoredResources, } //åˆå§‹åŒ–å„ä¸ªèµ„æºå¯¹è±¡çš„monitorsï¼Œå¯åŠ¨å„èµ„æºå¯¹è±¡çš„ç›‘å¬å™¨ï¼Œå˜åŒ–æ—¶è§¦å‘å›è°ƒï¼Œå°†å…¶åŠ å…¥graphChanges é˜Ÿåˆ— if err := gb.syncMonitors(deletableResources); err != nil { utilruntime.HandleError(fmt.Errorf(\u0026#34;failed to sync all monitors: %v\u0026#34;, err)) } gc.dependencyGraphBuilder = gb return gc, nil } ä¸»è¦åŠŸèƒ½ï¼š\n1ã€æ„å»ºGarbageCollectorç»“æ„ä½“ï¼›\n2ã€æ„å»ºä¾èµ–ç»“æ„å›¾ç»´æŠ¤ç»“æ„ä½“GraphBuilderï¼Œå’ŒGarbageCollectorå…±ç”¨attemptToDeleteå’ŒattemptToOrphané˜Ÿåˆ—ï¼ŒGraphBuilderä½œä¸ºç”Ÿäº§ç€å°†é€‚å½“èµ„æºæ”¾åˆ°attemptToDeleteæˆ–è€…attemptToOrphané˜Ÿåˆ—ï¼Œä¾›GarbageCollectorä¸­çš„workerè¿›è¡Œæ¶ˆè´¹ï¼›\n3ã€åˆå§‹åŒ–å„ä¸ªèµ„æºå¯¹è±¡çš„monitorsï¼Œå¯åŠ¨å„èµ„æºå¯¹è±¡çš„ç›‘å¬å™¨ï¼Œå˜åŒ–æ—¶è§¦å‘å›è°ƒï¼Œå°†å…¶åŠ å…¥graphChanges é˜Ÿåˆ—ã€‚\ngb.syncMonitors(deletableResources)æ–¹æ³•ä¸­æœ€ä¸»è¦çš„æ˜¯c, s, err := gb.controllerFor(resource, kind)\nfunc (gb *GraphBuilder) controllerFor(resource schema.GroupVersionResource, kind schema.GroupVersionKind) (cache.Controller, cache.Store, error) { handlers := cache.ResourceEventHandlerFuncs{ // add the event to the dependencyGraphBuilder\u0026#39;s graphChanges. // å°†äº‹ä»¶æ·»åŠ åˆ°dependencyGraphBuilderçš„graphChangesä¸­ã€‚ AddFunc: func(obj interface{}) { event := \u0026amp;event{ eventType: addEvent, obj: obj, gvk: kind, } gb.graphChanges.Add(event) }, UpdateFunc: func(oldObj, newObj interface{}) { // TODO: check if there are differences in the ownerRefs, // finalizers, and DeletionTimestamp; if not, ignore the update. //TODOï¼šæ£€æŸ¥ownerRefsï¼Œ finalizerså’ŒDeletionTimestampæ˜¯å¦å­˜åœ¨å·®å¼‚;å¦‚æœæ²¡æœ‰ï¼Œè¯·å¿½ç•¥æ›´æ–°ã€‚ event := \u0026amp;event{ eventType: updateEvent, obj: newObj, oldObj: oldObj, gvk: kind, } gb.graphChanges.Add(event) }, DeleteFunc: func(obj interface{}) { // delta fifo may wrap the object in a cache.DeletedFinalStateUnknown, unwrap it // delta fifoå¯ä»¥å°†å¯¹è±¡åŒ…è£…åœ¨cache.DeletedFinalStateUnknownä¸­ï¼Œè§£åŒ…å®ƒ if deletedFinalStateUnknown, ok := obj.(cache.DeletedFinalStateUnknown); ok { obj = deletedFinalStateUnknown.Obj } event := \u0026amp;event{ eventType: deleteEvent, obj: obj, gvk: kind, } gb.graphChanges.Add(event) }, } shared, err := gb.sharedInformers.ForResource(resource) if err == nil { klog.V(4).Infof(\u0026#34;using a shared informer for resource %q, kind %q\u0026#34;, resource.String(), kind.String()) // need to clone because it\u0026#39;s from a shared cache shared.Informer().AddEventHandlerWithResyncPeriod(handlers, ResourceResyncTime) return shared.Informer().GetController(), shared.Informer().GetStore(), nil } else { //è·å–èµ„æºå¯¹è±¡æ—¶å‡ºé”™ä¼šåˆ°è¿™é‡Œ,æ¯”å¦‚ék8så†…ç½®RedisClusterã€clusterbasesã€clustersã€esclustersã€volumeprovidersã€stsmastersã€appappsã€mysqlclustersã€brokerclustersã€clustertemplates; //å†…ç½®çš„networkPoliciesã€apiservicesã€customresourcedefinitions klog.V(4).Infof(\u0026#34;unable to use a shared informer for resource %q, kind %q: %v\u0026#34;, resource.String(), kind.String(), err) } // TODO: consider store in one storage. // TODO: è€ƒè™‘å­˜å‚¨åœ¨ä¸€ä¸ªå­˜å‚¨ä¸­ã€‚ klog.V(5).Infof(\u0026#34;create storage for resource %s\u0026#34;, resource) //ä¸Šé¢å¤±è´¥çš„èµ„æºå¯¹è±¡çš„storeå’Œcontroller store, monitor := cache.NewInformer( listWatcher(gb.dynamicClient, resource), nil, ResourceResyncTime, // don\u0026#39;t need to clone because it\u0026#39;s not from shared cache //ä¸éœ€è¦å…‹éš†ï¼Œå› ä¸ºå®ƒä¸æ˜¯æ¥è‡ªå…±äº«ç¼“å­˜ handlers, ) return monitor, store, nil } è¯¥æ–¹æ³•ä¸»è¦åŠŸèƒ½æ˜¯ï¼š\n1ã€å°†æ–°å¢ã€æ›´æ”¹ã€åˆ é™¤çš„èµ„æºå¯¹è±¡æ„å»ºä¸ºeventç»“æ„ä½“ï¼Œæ”¾å…¥GraphBuilderçš„graphChangesé˜Ÿåˆ—é‡Œï¼Œæœ€ç»ˆè¢«runProcessGraphChangesè¿™ä¸ªworkeræ¶ˆè´¹ï¼›\n2ã€æ„å»ºå¤§å¤šæ•°å†…ç½®èµ„æºçš„SharedInformerFactoryï¼Œæ„å»ºå¤±è´¥çš„ç”¨cache.NewInformeræ„å»ºï¼ˆé€šè¿‡CRDå®šä¹‰çš„å¯¹è±¡ä»¥åŠéƒ¨åˆ†k8så†…ç½®å¯¹è±¡ï¼‰\nä»£ç ç»§ç»­å›åˆ°k8s.io\\kubernetes\\cmd\\kube-controller-manager\\app\\core.goä¸­çš„startGarbageCollectorControllerä¸­ï¼Œçœ‹ garbageCollector.Run(workers, ctx.Stop)æ–¹æ³•ï¼š\nfunc (gc *GarbageCollector) Run(workers int, stopCh \u0026lt;-chan struct{}) { defer utilruntime.HandleCrash() defer gc.attemptToDelete.ShutDown() defer gc.attemptToOrphan.ShutDown() defer gc.dependencyGraphBuilder.graphChanges.ShutDown() klog.Infof(\u0026#34;Starting garbage collector controller\u0026#34;) defer klog.Infof(\u0026#34;Shutting down garbage collector controller\u0026#34;) //åç¨‹è¿è¡Œç”Ÿäº§è€…monitors go gc.dependencyGraphBuilder.Run(stopCh) //ç­‰å¾…dependencyGraphBuilderç¼“å­˜å¼€å§‹åŒæ­¥ if !controller.WaitForCacheSync(\u0026#34;garbage collector\u0026#34;, stopCh, gc.dependencyGraphBuilder.IsSynced) { return } //åƒåœ¾æ”¶é›†å™¨ï¼šæ‰€æœ‰èµ„æºç›‘è§†å™¨éƒ½å·²åŒæ­¥ã€‚ç»§ç»­æ”¶é›†åƒåœ¾ klog.Infof(\u0026#34;Garbage collector: all resource monitors have synced. Proceeding to collect garbage\u0026#34;) // gc workers //åç¨‹è¿è¡Œæ¶ˆè´¹è€…DeleteWorkerså’ŒOrphanWorkers for i := 0; i \u0026lt; workers; i++ { //é»˜è®¤å‚æ•°ä¸º20ä¸ªå¹¶å‘åç¨‹å°è¯•delete worker go wait.Until(gc.runAttemptToDeleteWorker, 1*time.Second, stopCh) //é»˜è®¤å‚æ•°ä¸º20ä¸ªå¹¶å‘åç¨‹å°è¯•orphan worker go wait.Until(gc.runAttemptToOrphanWorker, 1*time.Second, stopCh) } \u0026lt;-stopCh } gc.dependencyGraphBuilder.Run(stopCh)ä¸»è¦åŠŸèƒ½ï¼š\n1ã€gb.startMonitors()å¯åŠ¨ç›‘å¬èµ„æºå˜åŒ–çš„informerï¼›\n2ã€wait.Until(gb.runProcessGraphChanges, 1*time.Second, stopCh)å¼€å¯ä»é˜Ÿåˆ—GraphBuilder.graphChangesä¸­æ¶ˆè´¹çš„worker\nå¯åŠ¨20ä¸ªrunAttemptToDeleteWorkerå’Œ20ä¸ªrunAttemptToOrphanWorker\nå‚è€ƒ # k8så®˜æ–¹æ–‡æ¡£garbage-collectionè‹±æ–‡ç‰ˆï¼š\nhttps://kubernetes.io/docs/concepts/workloads/controllers/garbage-collection/\nä¾èµ–å›¾æ ‡ç”Ÿæˆåº“gonum Apiæ–‡æ¡£ï¼š\nhttps://godoc.org/gonum.org/v1/gonum/graph\ngraphvizä¸‹è½½ï¼š\nhttps://graphviz.gitlab.io/_pages/Download/Download_windows.html\n","date":"2019å¹´10æœˆ16æ—¥","externalUrl":null,"permalink":"/posts/kubernetes%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8garbagecollector%E6%8E%A7%E5%88%B6%E5%99%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80/","section":"Posts","summary":"\u003cp\u003e\n\n\n\n\n\n  \u003cfigure\u003e\n    \u003cimg class=\"my-0 rounded-md\" loading=\"lazy\" src=\"https://img.hacpai.com/bing/20190604.jpg?imageView2/1/w/960/h/540/interlace/1/q/100\" alt=\"å›¾ç‰‡æè¿°: 100\" /\u003e\n    \n  \u003c/figure\u003e\n\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003ekubernetesç‰ˆæœ¬ï¼š1.13.2\u003c/strong\u003e\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003ch2 class=\"relative group\"\u003eèƒŒæ™¯ \n    \u003cdiv id=\"èƒŒæ™¯\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e8%83%8c%e6%99%af\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h2\u003e\n\u003cp\u003eç”±äºoperatoråˆ›å»ºçš„redisé›†ç¾¤ï¼Œåœ¨kubernetes apiserveré‡å¯åï¼Œredisé›†ç¾¤è¢«å¼‚å¸¸åˆ é™¤ï¼ˆåŒ…æ‹¬redis exporter statefulsetã€redis statefulsetï¼‰ã€‚åˆ é™¤åoperatorå°†å…¶é‡å»ºï¼Œé‡æ–°ç»„å»ºé›†ç¾¤ï¼Œå®ä¾‹IPå‘ç”Ÿå˜æ›´ï¼ˆä¸­é—´ä»¶å®¹å™¨åŒ–ï¼Œæˆ‘ä»¬å¼€å‘äº†å›ºå®šIPï¼Œå½“statefulsetåˆ é™¤åï¼ŒIPä¼šè¢«å›æ”¶ï¼‰ï¼Œå¯¼è‡´åˆ›å»ºé›†ç¾¤å¤±è´¥ï¼Œæœ€ç»ˆé›†ç¾¤ä¸å¯ç”¨ã€‚\u003c/p\u003e","title":"kubernetesåƒåœ¾å›æ”¶å™¨GarbageCollectoræ§åˆ¶å™¨æºç åˆ†æï¼ˆä¸€ï¼‰","type":"posts"},{"content":"","externalUrl":null,"permalink":"/en/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":" The Open Source Project I\u0026rsquo;m Involved In ","externalUrl":null,"permalink":"/en/examples/","section":"Open Source","summary":"\u003cdiv class=\"lead text-neutral-500 dark:text-neutral-400 !mb-9 text-xl\"\u003e\n  The Open Source Project I\u0026rsquo;m Involved In\n\u003c/div\u003e\n\n\u003chr /\u003e","title":"Open Source","type":"examples"},{"content":"","externalUrl":null,"permalink":"/en/go/","section":"Advance into Cloud Native","summary":"","title":"Redirect","type":"go"},{"content":"","externalUrl":null,"permalink":"/en/series/","section":"Series","summary":"","title":"Series","type":"series"}]